<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×˜×™×¤×•×œ×™× ×•×œ×§×•×—×•×ª</title>
	
	<script src="https://apis.google.com/js/api.js"></script>
	<script src="https://accounts.google.com/gsi/client"></script>
	
    <style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			direction: rtl;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}

		/* Header ××¢×•×¦×‘ */
		.header {
			background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
			border-radius: 15px;
			padding: 30px;
			margin-bottom: 20px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.3);
			color: white;
		}

		.header h1 {
			font-size: 2.5em;
			margin-bottom: 10px;
			text-align: center;
			text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
			background: linear-gradient(45deg, #3498db, #2ecc71);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}

		/* Connection Status ××¢×•×¦×‘ */
		.connection-status {
			text-align: center;
			margin: 20px 0;
			padding: 20px;
			background: rgba(255,255,255,0.1);
			border-radius: 15px;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255,255,255,0.2);
		}

		.connect-btn {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 12px 24px;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			margin: 5px;
			transition: all 0.3s ease;
			box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
		}

		.connect-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
		}

		.connect-btn:disabled {
			background: #95a5a6;
			cursor: not-allowed;
			transform: none;
		}

		/* Navigation ××¢×•×¦×‘ */
		.nav-buttons {
			display: flex;
			gap: 15px;
			justify-content: center;
			flex-wrap: wrap;
			margin-top: 20px;
		}

		.nav-btn {
			padding: 15px 25px;
			border: none;
			background: rgba(255,255,255,0.1);
			color: white;
			border-radius: 10px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255,255,255,0.2);
		}

		.nav-btn:hover {
			background: rgba(255,255,255,0.2);
			transform: translateY(-2px);
		}

		.nav-btn.active {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
			transform: translateY(-2px);
		}

		/* Main Content ××¢×•×¦×‘ */
		.main-content {
			background: rgba(255,255,255,0.95);
			border-radius: 15px;
			padding: 30px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.2);
			backdrop-filter: blur(10px);
		}

		.section {
			display: none;
		}

		.section.active {
			display: block;
		}

		.section h2 {
			color: #2c3e50;
			margin-bottom: 30px;
			padding-bottom: 15px;
			border-bottom: 3px solid #3498db;
			font-size: 1.8em;
			position: relative;
		}

		.section h2::before {
			content: '';
			position: absolute;
			bottom: -3px;
			left: 0;
			width: 60px;
			height: 3px;
			background: linear-gradient(45deg, #e74c3c, #f39c12);
			border-radius: 2px;
		}

		/* Forms ××¢×•×¦×‘×™× */
		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			margin-bottom: 8px;
			color: #2c3e50;
			font-weight: bold;
			font-size: 14px;
		}

		.form-group input, .form-group select, .form-group textarea {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #e9ecef;
			border-radius: 8px;
			font-size: 14px;
			transition: all 0.3s ease;
			background: white;
		}

		.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
			transform: translateY(-1px);
		}

		/* Buttons ××¢×•×¦×‘×™× */
		.add-btn {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
			border: none;
			padding: 15px 30px;
			border-radius: 10px;
			cursor: pointer;
			margin-bottom: 20px;
			font-size: 16px;
			font-weight: bold;
			transition: all 0.3s ease;
			box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
		}

		.add-btn:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
		}

		.action-btn {
			padding: 8px 16px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 12px;
			margin: 0 3px;
			transition: all 0.3s ease;
			font-weight: bold;
		}

		.edit-btn {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
		}

		.edit-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
		}

		.delete-btn {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			color: white;
		}

		.delete-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
		}

		/* Tables ××¢×•×¦×‘×•×ª */
		.table-container {
			background: white;
			border-radius: 12px;
			overflow: hidden;
			box-shadow: 0 8px 25px rgba(0,0,0,0.15);
			margin-top: 20px;
		}

		.data-table {
			width: 100%;
			border-collapse: collapse;
			background: white;
		}

		.data-table thead {
			background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
			color: white;
		}

		.data-table th {
			padding: 15px 12px;
			text-align: right;
			font-weight: bold;
			border-bottom: 2px solid #3498db;
		}

		.data-table td {
			padding: 12px;
			border-bottom: 1px solid #ecf0f1;
			transition: background 0.3s ease;
		}

		.data-table tbody tr:hover {
			background: #f8f9fa;
			transform: scale(1.01);
		}

		.data-table tbody tr:nth-child(even) {
			background: #fbfcfd;
		}

		/* Filter Panels ××¢×•×¦×‘×™× */
		.filter-panel, .info-panel {
			background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%);
			border: 2px solid #95a5a6;
			border-radius: 12px;
			margin-bottom: 20px;
			overflow: hidden;
			box-shadow: 0 5px 15px rgba(0,0,0,0.1);
		}

		.filter-header, .info-header {
			background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
			padding: 15px 20px;
			cursor: pointer;
			color: white;
			transition: all 0.3s ease;
			border-bottom: 2px solid #3498db;
		}

		.filter-header:hover, .info-header:hover {
			background: linear-gradient(135deg, #4a6741 0%, #2c3e50 100%);
		}

		.filter-content, .info-content {
			padding: 25px;
			display: block;
			background: white;
		}

		.filter-content.collapsed, .info-content.collapsed {
			display: none;
		}

		/* Submit Button ××¢×•×¦×‘ */
		button[type="submit"] {
			width: 100%;
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 18px;
			border-radius: 10px;
			cursor: pointer;
			font-size: 18px;
			font-weight: bold;
			margin-top: 20px;
			transition: all 0.3s ease;
			box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
		}

		button[type="submit"]:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
		}

		/* Mobile Responsive */
		@media (max-width: 768px) {
			.container {
				padding: 10px;
			}
			
			.header {
				padding: 20px 15px;
			}
			
			.header h1 {
				font-size: 1.8em;
			}
			
			.nav-buttons {
				gap: 8px;
			}
			
			.nav-btn {
				padding: 12px 16px;
				font-size: 12px;
			}
			
			.main-content {
				padding: 20px 15px;
			}
		}

		/* Toast Notifications */
		.toast-container {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 1000;
			max-width: 300px;
		}

		.toast {
			background: linear-gradient(45deg, #2c3e50, #3498db);
			color: white;
			padding: 15px 20px;
			border-radius: 8px;
			margin-bottom: 10px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
			transform: translateX(400px);
			opacity: 0;
			transition: all 0.3s ease;
			border-right: 4px solid #27ae60;
			font-weight: bold;
		}

		.toast.success {
			border-right-color: #27ae60;
			background: linear-gradient(45deg, #27ae60, #2ecc71);
		}

		.toast.error {
			border-right-color: #e74c3c;
			background: linear-gradient(45deg, #e74c3c, #c0392b);
		}

		.toast.warning {
			border-right-color: #f39c12;
			background: linear-gradient(45deg, #f39c12, #e67e22);
		}

		.toast.info {
			border-right-color: #3498db;
			background: linear-gradient(45deg, #3498db, #2980b9);
		}

		.toast.show {
			transform: translateX(0);
			opacity: 1;
		}

		@media (max-width: 768px) {
			.toast-container {
				left: 10px;
				right: 10px;
				top: 10px;
				max-width: none;
			}
			
			.toast {
				transform: translateY(-100px);
			}
			
			.toast.show {
				transform: translateY(0);
			}
		}
		

		/* ×›×¤×ª×•×¨×™× ×›×œ×œ×™×™× */
		.btn {
			padding: 12px 20px;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			box-shadow: 0 3px 10px rgba(0,0,0,0.2);
			min-width: 120px;
		}

		.btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(0,0,0,0.3);
		}

		.btn-primary {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
		}

		.btn-success {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
		}

		.btn-warning {
			background: linear-gradient(45deg, #f39c12, #e67e22);
			color: white;
		}

		.btn-secondary {
			background: linear-gradient(45deg, #95a5a6, #7f8c8d);
			color: white;
		}

		.btn-info {
			background: linear-gradient(45deg, #17a2b8, #138496);
			color: white;
		}

		/* ×›×¤×ª×•×¨×™ ×¤×™×œ×˜×¨ */
		.filter-btn {
			padding: 10px 18px;
			border: 2px solid #3498db;
			background: linear-gradient(45deg, #ecf0f1, #bdc3c7);
			color: #2c3e50;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			min-width: 100px;
		}

		.filter-btn:hover {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
		}

		.filter-btn.active {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
		}

		/* ×¨×©×™××•×ª × ×¤×ª×—×•×ª */
		select, .form-group select {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			cursor: pointer;
			min-height: 45px;
		}

		select:focus, .form-group select:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		select:hover {
			border-color: #7f8c8d;
			background: white;
		}

		/* ×©×“×•×ª ×ª××¨×™×š */
		input[type="date"] {
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			min-height: 45px;
		}

		input[type="date"]:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		/* ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×•×ª ×¤×™×œ×˜×¨ */
		.filter-actions .btn {
			margin: 5px 8px;
			padding: 10px 20px;
			font-size: 14px;
			min-width: 100px;
		}

		/* ×›×¤×ª×•×¨×™ ×™×™×‘×•× ×‘××¢×¨×›×ª */
		.form-section .btn {
			margin: 8px 5px;
			padding: 12px 20px;
			font-size: 14px;
			font-weight: bold;
			min-width: 150px;
		}

		/* ×©×™×¤×•×¨ × ×•×¡×£ ×œ×›×¤×ª×•×¨×™× ×§×˜× ×™× */
		.action-btn {
			padding: 10px 16px;
			font-size: 13px;
			font-weight: bold;
			min-width: 80px;
		}

		/* ×›×¤×ª×•×¨×™× ××•×§×¤×¦×™× (disabled) */
		button:disabled, .btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none !important;
			box-shadow: none !important;
		}

		/* ×©×™×¤×•×¨ ×œ×ª×™×‘×•×ª ×˜×§×¡×˜ */
		input[type="text"], input[type="number"], textarea {
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			min-height: 45px;
		}

		input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		/* ×©×™×¤×•×¨ ×œ×›×•×ª×¨×•×ª ×‘×¤×× ×œ×™× */
		.filter-header h3, .info-header h3 {
			font-size: 16px;
			font-weight: bold;
			margin: 0;
			text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
		}

		/* ××•×‘×™×™×œ - ×”×ª×××•×ª */
		@media (max-width: 768px) {
			.btn {
				padding: 10px 15px;
				font-size: 13px;
				min-width: 100px;
			}
			
			select, input[type="date"], input[type="text"], input[type="number"] {
				padding: 10px 12px;
				font-size: 13px;
				min-height: 40px;
			}
		}
		
		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
		}

		.stat-item {
			background: rgba(255,255,255,0.7);
			padding: 15px;
			border-radius: 8px;
			border-left: 4px solid #27ae60;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			backdrop-filter: blur(5px);
		}

		.stat-label {
			display: block;
			font-weight: bold;
			color: #495057;
			margin-bottom: 5px;
			font-size: 14px;
		}

		.stat-value {
			font-size: 1.4em;
			font-weight: bold;
			color: #2c3e50;
		}

		@media (max-width: 768px) {
			.stats-grid {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		.debt-card .summary-value {
			color: #e74c3c !important;
			font-weight: bold;
		}

		.debts-table tr:hover {
			background-color: #f8f9fa !important;
		}

		.action-btn {
			margin: 1px;
			padding: 4px 8px;
			font-size: 12px;
			border-radius: 3px;
			border: none;
			color: white;
			cursor: pointer;
		}

		.action-btn:hover {
			opacity: 0.8;
		}

		#statusText {
			transition: all 0.3s ease;
			padding: 8px 12px;
			border-radius: 6px;
			font-size: 14px;
		}

		#statusText.connected {
			background: linear-gradient(45deg, #28a745, #20c997);
			color: white;
			box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
		}



		/* ========== ×¡×˜×™×™×œ×™× ×œ××¢×¨×›×ª ×ª×›× ×•×Ÿ ××©×•×“×¨×’×ª ========== */

		.planning-date-header {
			text-align: center;
			background: linear-gradient(45deg, #4CAF50, #45a049);
			color: white;
			padding: 15px;
			border-radius: 10px;
			margin-bottom: 20px;
			box-shadow: 0 4px 6px rgba(0,0,0,0.1);
		}

		.planning-date-header h3 {
			margin: 0;
			font-size: 24px;
		}

		.planning-date-header p {
			margin: 5px 0 0 0;
			opacity: 0.9;
			font-size: 16px;
		}

		.planning-view-tabs {
			display: flex;
			justify-content: center;
			gap: 10px;
			margin-bottom: 20px;
		}

		.planning-tab-btn {
			padding: 10px 20px;
			border: 2px solid #ddd;
			background: white;
			border-radius: 25px;
			cursor: pointer;
			transition: all 0.3s ease;
			font-weight: bold;
			font-family: inherit;
		}

		.planning-tab-btn.active {
			background: #4CAF50;
			color: white;
			border-color: #4CAF50;
		}

		.planning-tab-btn:hover:not(.active) {
			border-color: #4CAF50;
			color: #4CAF50;
		}

		.planning-cards-container {
			min-height: 300px;
			border: 2px dashed #ddd;
			border-radius: 10px;
			padding: 15px;
			background: #fafafa;
			margin-bottom: 20px;
		}

		.planning-client-card {
			background: white;
			border-radius: 10px;
			padding: 15px;
			margin-bottom: 10px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			cursor: move;
			transition: all 0.3s ease;
			display: flex;
			align-items: center;
			justify-content: space-between;
			min-height: 80px;
		}

		.planning-client-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 8px rgba(0,0,0,0.15);
		}

		.planning-client-card.planning-dragging {
			opacity: 0.6;
			transform: rotate(5deg);
			z-index: 1000;
		}

		.planning-client-card.planning-drag-over {
			border: 2px dashed #4CAF50;
			background: #f0f8f0;
		}

		/* ×¦×‘×¢×™ ×¨××–×•×¨ ×—×œ×©×™× */
		.planning-status-green {
			border-right: 5px solid rgba(76, 175, 80, 0.6);
			background: rgba(76, 175, 80, 0.05);
		}

		.planning-status-yellow {
			border-right: 5px solid rgba(255, 193, 7, 0.6);
			background: rgba(255, 193, 7, 0.05);
		}

		.planning-status-orange {
			border-right: 5px solid rgba(255, 152, 0, 0.6);
			background: rgba(255, 152, 0, 0.05);
		}

		.planning-status-red {
			border-right: 5px solid rgba(244, 67, 54, 0.6);
			background: rgba(244, 67, 54, 0.05);
		}

		.planning-client-info {
			flex: 1;
			display: grid;
			grid-template-columns: 2fr 1fr 1fr;
			gap: 15px;
			align-items: center;
		}

		.planning-client-main {
			text-align: right;
		}

		.planning-client-name {
			font-weight: bold;
			font-size: 16px;
			color: #333;
			margin-bottom: 4px;
		}

		.planning-client-address {
			font-size: 12px;
			color: #666;
			margin-bottom: 2px;
		}

		.planning-client-notes {
			font-size: 11px;
			color: #888;
			margin-bottom: 2px;
		}

		.planning-client-next-visit {
			font-size: 12px;
			color: #555;
			font-weight: bold;
		}

		.planning-client-time {
			text-align: center;
			font-weight: bold;
			color: #4CAF50;
		}

		.planning-time-picker {
			border: 1px solid #ddd;
			border-radius: 5px;
			padding: 4px;
			font-size: 14px;
			background: #f9f9f9;
			font-family: inherit;
		}

		.planning-interval {
			font-size: 12px;
			color: #666;
			text-align: center;
		}

		.planning-client-amount {
			text-align: center;
			font-weight: bold;
			color: #2196F3;
			font-size: 16px;
		}

		.planning-client-actions {
			display: flex;
			gap: 8px;
		}

		.planning-action-btn {
			width: 35px;
			height: 35px;
			border: none;
			border-radius: 50%;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 14px;
			transition: all 0.3s ease;
			font-family: inherit;
		}

		.planning-complete {
			background: #4CAF50;
			color: white;
		}

		.planning-complete:hover {
			background: #45a049;
			transform: scale(1.1);
		}

		.planning-postpone {
			background: #FF9800;
			color: white;
		}

		.planning-postpone:hover {
			background: #f57c00;
			transform: scale(1.1);
		}

		.planning-menu {
			background: #607D8B;
			color: white;
		}

		.planning-menu:hover {
			background: #546E7A;
			transform: scale(1.1);
		}

		.planning-empty-state {
			text-align: center;
			padding: 40px;
			color: #666;
		}

		.planning-empty-state h3 {
			margin-bottom: 10px;
			color: #333;
		}

		/* ×ª×’×•×‘×” ×œ××•×‘×™×™×œ */
		@media (max-width: 768px) {
			.planning-client-info {
				grid-template-columns: 1fr;
				gap: 8px;
				text-align: right;
			}
			
			.planning-client-time, 
			.planning-client-amount {
				text-align: right;
				font-size: 14px;
			}
			
			.planning-action-btn {
				width: 30px;
				height: 30px;
				font-size: 12px;
			}
			
			.planning-view-tabs {
				flex-wrap: wrap;
			}
			
			.planning-tab-btn {
				padding: 8px 15px;
				font-size: 14px;
			}
		}

		/* ×× ×™××¦×™×•×ª ×’×¨×™×¨×” */
		@keyframes planningDropAnimation {
			0% { transform: scale(1.1); }
			100% { transform: scale(1); }
		}

		.planning-client-card.planning-dropped {
			animation: planningDropAnimation 0.3s ease;
		}

		/***************************************/
		/* ×™×™×‘×•× × ×ª×•× ×™× - ×›×¤×ª×•×¨×™× ××—×™×“×™× */
		.import-main-buttons,
		.import-other-buttons {
			display: flex;
			gap: 10px;
			margin: 15px 0;
			flex-wrap: wrap;
		}

		.import-main-buttons button,
		.import-other-buttons button {
			flex: 1;
			min-width: 200px;
			padding: 12px 15px;
			background: linear-gradient(145deg, #f8f9fa, #e9ecef);
			border: 2px solid #dee2e6;
			border-radius: 8px;
			color: #495057;
			font-weight: 500;
			font-size: 14px;
			cursor: pointer;
			transition: all 0.3s ease;
			text-align: center;
		}

		.import-main-buttons button:hover,
		.import-other-buttons button:hover {
			background: linear-gradient(145deg, #e9ecef, #dee2e6);
			border-color: #6c757d;
			transform: translateY(-1px);
			box-shadow: 0 4px 8px rgba(0,0,0,0.15);
		}

		/* ×›×¤×ª×•×¨ ×”×§×•×‘×¥ ×”××¨×›×–×™ */
		.btn.btn-warning {
			padding: 12px 20px;
			font-size: 14px;
			font-weight: 500;
			min-width: 200px;
		}

		/* ×ª×’×•×‘×” ×œ××•×‘×™×™×œ */
		@media (max-width: 768px) {
			.import-main-buttons,
			.import-other-buttons {
				flex-direction: column;
			}
			
			.import-main-buttons button,
			.import-other-buttons button {
				min-width: 100%;
				padding: 15px;
				font-size: 16px;
			}
			
			.btn.btn-warning {
				padding: 15px 20px;
				font-size: 16px;
			}
		}
		/***************************************/

	</style>
   
</head>
<body>
	<!-- Toast Container -->
	<div id="toastContainer" class="toast-container"></div>
    <div class="container">
        <header class="header">
            <h1>×˜×™×¤×•×œ×™×</h1>
			<div id="connectionStatus" class="connection-status">
				<button onclick="connectToGoogleSheets()" id="connectBtn" class="connect-btn">
					×”×ª×—×‘×¨ ×œ-Google Sheets
				</button>
				<button onclick="saveAllToSheets()" id="saveBtn" class="connect-btn" disabled>
					×©××•×¨ ×œ×¢× ×Ÿ
				</button>
				<button onclick="loadAllFromSheets()" id="loadBtn" class="connect-btn" disabled>
					×˜×¢×Ÿ ××”×¢× ×Ÿ
				</button>
				<span id="statusText" style="color: white; font-weight: bold; font-size: 16px;">×œ× ××—×•×‘×¨</span>
				<div id="lastSaved" style="font-size: 12px; color: white; margin-top: 4px;"></div>
			</div>
            <nav class="nav-buttons">
				<button onclick="showSection('planning')" class="nav-btn active">×ª×›× ×•×Ÿ ×™×•××™</button>
				<button onclick="showSection('visit')" class="nav-btn">×˜×™×¤×•×œ ×—×“×©</button>
				<button onclick="showSection('history')" class="nav-btn">×˜×™×¤×•×œ×™×</button> 
				<button onclick="showSection('locations')" class="nav-btn">×œ×§×•×—×•×ª</button>
				<button onclick="showSection('receipts')" class="nav-btn">×§×‘×œ×•×ª</button>
				<button onclick="showSection('debts')" class="nav-btn">ğŸ’° ×—×•×‘×•×ª</button>
				<button onclick="showSection('system')" class="nav-btn">××¢×¨×›×ª v2.1</button>
			</nav>
        </header>

        <main class="main-content">
            <!-- Planning Section -->
			<section id="planning" class="section active">
				<h2>ğŸ“… ×ª×›× ×•×Ÿ ×™×•××™ ×•×©×‘×•×¢×™</h2>
            
            <!-- ×›×•×ª×¨×ª ×ª××¨×™×š -->
            <div class="planning-date-header">
                <h3 id="planningDateTitle">×”×™×•× - ×¨×‘×™×¢×™</h3>
                <p id="planningDateFormatted">28 ×‘× ×•×‘××‘×¨ 2024</p>
            </div>

            <!-- ×˜××‘×™× -->
            <div class="planning-view-tabs">
                <button class="planning-tab-btn active" onclick="switchPlanningView('daily')">×™×•××™</button>
                <button class="planning-tab-btn" onclick="switchPlanningView('weekly')">×©×‘×•×¢×™</button>
                <button class="planning-tab-btn" onclick="switchPlanningView('overdue')">×××•×—×¨×•×ª</button>
            </div>

            <!-- ×›×¨×˜×™×¡×™ ×œ×§×•×—×•×ª -->
            <div class="planning-cards-container" id="planningCardsContainer">
                <!-- ×›×¨×˜×™×¡×™× ×™×˜×¢× ×• ×›××Ÿ ×“×™× ××™×ª -->
            </div>

            <!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª (×©××™×¨×” ×¢×œ ×”×§×™×™×) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                <div style="background: rgba(52, 152, 219, 0.1); border: 2px solid #3498db; border-radius: 8px; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 13px; color: #2c3e50;">×œ×§×•×—×•×ª:</span>
                        <span id="totalLocations" style="font-weight: bold; color: #2c3e50;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 13px; color: #2c3e50;">×¤×¢×™×œ×™×:</span>
                        <span id="activeLocations" style="font-weight: bold; color: #27ae60;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: #2c3e50;">×˜×™×¤×•×œ×™× ×”×©×‘×•×¢:</span>
                        <span id="weeklyVisits" style="font-weight: bold; color: #2c3e50;">0</span>
                    </div>
                </div>
                
                <div style="background: rgba(39, 174, 96, 0.1); border: 2px solid #27ae60; border-radius: 8px; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 13px; color: #2c3e50;">×”×›× ×¡×” ×”×©×‘×•×¢:</span>
                        <span id="weeklyIncome" style="font-weight: bold; color: #27ae60;">â‚ª0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: #2c3e50;">×—×•×‘×•×ª ×¤×ª×•×—×™×:</span>
                        <span id="openDebts" style="font-weight: bold; color: #e74c3c;">â‚ª0</span>
                    </div>
                </div>
            </div>
			</section>

            <!-- VisitSection -->
            <section id="visit" class="section">
                <h2>×˜×™×¤×•×œ ×—×“×©</h2>
                <div class="form-container">
                    <form id="visitForm">
                        <div class="form-group">
							<label for="locationSelect">×‘×—×¨ ×œ×§×•×—:</label>
							<select id="locationSelect" required>
								<option value="">×‘×—×¨ ×œ×§×•×—...</option>
							</select>
						</div>

						<!-- ×”×•×¡×£ ×›××Ÿ -->
						<div class="form-group">
							<label for="visitDate">×ª××¨×™×š ×˜×™×¤×•×œ:</label>
							<input type="date" id="visitDate" required>
						</div>

						<div class="form-group">
							<label for="visitTime">×©×¢×ª ×”×ª×—×œ×”:</label>
							<input type="time" id="visitTime" required>
						</div>
                        <div class="form-group">
                            <label for="visitType">×¡×•×’ ×˜×™×¤×•×œ:</label>
                            <select id="visitType" required>
                                <option value="××œ×">××œ×</option>
                                <option value="×—×œ×§×™">×—×œ×§×™</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="workDone">××” ×‘×•×¦×¢:</label>
                            <textarea id="workDone" placeholder="×ª×™××•×¨ ×”×¢×‘×•×“×” ×©×‘×•×¦×¢×”"></textarea>
                        </div>
                        <div class="form-group">
							<label for="manualDurationMinutes">××©×š ×”×˜×™×¤×•×œ (×“×§×•×ª):</label>
							<div style="display: flex; gap: 10px; align-items: center;">
								<input type="number" id="manualDurationMinutes" placeholder="90" min="0" onchange="updateHoursDisplay()" style="flex: 1;">
								<span style="color: #666; font-size: 14px;">×©×¢×•×ª:</span>
								<input type="text" id="calculatedHours" readonly style="width: 80px; background: #f8f9fa; color: #666; border: 2px solid #e9ecef; border-radius: 6px; padding: 8px; text-align: center;" placeholder="1.5">
							</div>
						</div>
                        <div class="form-group">
							<label for="numberOfWorkersVisit">××¡×¤×¨ ×¢×•×‘×“×™× ×‘×˜×™×¤×•×œ:</label>
							<div style="display: flex; gap: 10px; align-items: center;">
								<input type="number" id="numberOfWorkersVisit" value="1" min="1" onchange="calculateTreatmentCost()" style="width: 80px;">
								<span style="color: #666; font-size: 14px;">×¢×•×‘×“×™× (×›×•×œ×œ ××•×ª×š)</span>
							</div>
						</div>

						<div class="form-group">
							<label for="amount">×¡×›×•×:</label>
							<div style="display: flex; gap: 10px; align-items: center;">
								<input type="number" id="amount" placeholder="×¡×›×•× ×”×˜×™×¤×•×œ" style="flex: 1;">
								<button type="button" onclick="calculateTreatmentCost()" style="background: #f39c12; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
									ğŸ”„ ×—×©×‘
								</button>
							</div>
							<div id="costBreakdown" style="font-size: 12px; color: #666; margin-top: 5px;">
								<!-- ×›××Ÿ ×™×•×¤×™×¢ ×¤×™×¨×•×˜ ×”×—×™×©×•×‘ -->
							</div>
						</div>
                        <div class="form-group">
							<label for="expense">×”×•×¦××”:</label>
							<input type="number" id="expense" placeholder="×”×•×¦××•×ª × ×™×œ×•×•×ª" onchange="calculateTreatmentCost()">
						</div>
                        <button type="submit">×©××•×¨ ×˜×™×¤×•×œ</button>
                    </form>
                </div>
            </section>

			<!-- History Section -->
			<section id="history" class="section">
				<h2>ğŸ“‹ ×˜×™×¤×•×œ×™×</h2>
				
				<!-- Filter Panel -->
				<div class="filter-panel">
					<div class="filter-header" onclick="toggleFilterPanel()">
						<h3>ğŸ” ×¡×™× ×•×Ÿ ×˜×™×¤×•×œ×™× <span id="filterIcon">ğŸ”½</span></h3>
					</div>
					<div id="filterContent" class="filter-content">
						<div class="filter-row">
							<div class="filter-group">
								<label>×œ×§×•×—:</label>
								<select id="filterLocation">
									<option value="">×›×œ ×”×œ×§×•×—×•×ª</option>
								</select>
							</div>
							<div class="filter-group">
								<label>×¡×˜×˜×•×¡ ×ª×©×œ×•×:</label>
								<select id="filterPayment">
									<option value="">×”×›×œ</option>
									<option value="×›×Ÿ">×©×•×œ×</option>
									<option value="×œ×">×œ× ×©×•×œ×</option>
									<option value="×œ×œ×">×œ×œ× ×ª×©×œ×•×</option>
								</select>
							</div>
						</div>
						<div class="filter-row">
							<div class="filter-group">
								<label>××ª××¨×™×š:</label>
								<input type="date" id="filterDateFrom">
							</div>
							<div class="filter-group">
								<label>×¢×“ ×ª××¨×™×š:</label>
								<input type="date" id="filterDateTo">
							</div>
						</div>
						<div class="filter-actions">
							<button onclick="applyVisitFilters()" class="btn btn-primary">×¡× ×Ÿ</button>
							<button onclick="clearVisitFilters()" class="btn btn-secondary">× ×§×” ×¡×™× ×•×Ÿ</button>
						</div>
					</div>
				</div>

				<!-- Info Panel -->
				<div class="info-panel">
					<div class="info-header" onclick="toggleInfoPanel()">
						<h3>ğŸ“Š ××™×“×¢ <span id="infoIcon">ğŸ”½</span></h3>
					</div>
					<div id="infoContent" class="info-content">
						<div class="info-grid">
							<div class="info-item">
								<span class="info-label">×˜×™×¤×•×œ×™× ××•×¦×’×™×:</span>
								<span id="visitsCount" class="info-value">0</span>
							</div>
							<div class="info-item">
								<span class="info-label">×¡×”"×› ×©×¢×•×ª:</span>
								<span id="totalHours" class="info-value">0</span>
							</div>
							<div class="info-item">
								<span class="info-label">×¡×”"×› ×”×›× ×¡×•×ª:</span>
								<span id="totalIncome" class="info-value">â‚ª0</span>
							</div>
							<div class="info-item">
								<span class="info-label">×—×•×‘×•×ª ×¤×ª×•×—×™×:</span>
								<span id="outstandingDebt" class="info-value">â‚ª0</span>
							</div>
						</div>
					</div>
				</div>

				<!-- Visits Table -->
				<div class="table-container">
					<table id="visitsHistoryTable" class="data-table">
						<thead>
							<tr>
								<th>×ª××¨×™×š</th>
								<th>×œ×§×•×—</th>
								<th>×¡×•×’ ×˜×™×¤×•×œ</th>
								<th>×¢×‘×•×“×” ×©×‘×•×¦×¢×”</th>
								<th>××©×š (×©×¢×•×ª)</th>
								<th>×¡×›×•×</th>
								<th>×©×•×œ×</th>
								<th>×¤×¢×•×œ×•×ª</th>
							</tr>
						</thead>
						<tbody id="visitsHistoryTableBody">
						</tbody>
					</table>
				</div>
			</section>

            <!-- locations Section -->
            <section id="locations" class="section">
                <h2>× ×™×”×•×œ ×œ×§×•×—×•×ª</h2>
				<button onclick="showAddLocationForm()" class="add-btn">×”×•×¡×£ ×œ×§×•×— ×—×“×©</button>
                <div class="table-container">
                    <table id="locationsTable" class="data-table">
                        <thead>
                            <tr>
                                <th>×©×</th>
                                <th>×›×ª×•×‘×ª</th>
                                <th>××™×© ×§×©×¨</th>
                                <th>×™×•× ××•×ª×¨</th>
                                <th>××¨×•×•×—</th>
                                <th>×¤×¢×™×œ×”</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="locationsTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Receipts Section -->
            <section id="receipts" class="section">
                <h2>× ×™×”×•×œ ×§×‘×œ×•×ª</h2>
                <button onclick="showAddReceiptForm()" class="add-btn">×”×•×¡×£ ×§×‘×œ×” ×—×“×©×”</button>
                <div class="table-container">
                    <table id="receiptsTable" class="data-table">
                        <thead>
							<tr>
								<th>×¤× ×§×¡</th>
								<th>×§×‘×œ×”</th>
								<th>×ª××¨×™×š</th>
								<th>×‘×™× ×”</th>
								<th>×¡×›×•×</th>
								<th>×¡×•×’ ×ª×©×œ×•×</th>
								<th>×§×•×“X</th>  
								<th>×¤×¢×•×œ×•×ª</th>
							</tr>
						</thead>
                        <tbody id="receiptsTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

			<section id="debts" class="section">
				<h2>ğŸ’° × ×™×”×•×œ ×—×•×‘×•×ª</h2>
				
				<!-- ×¡×™×›×•× ×›×œ×œ×™ -->
				<div class="summary-cards">
					<div class="summary-card debt-card">
						<h3>×¡×”"×› ×—×•×‘×•×ª</h3>
						<div id="totalDebt" class="summary-value">â‚ª0</div>
					</div>
					<div class="summary-card">
						<h3>×œ×§×•×—×•×ª ×—×™×™×‘×™×</h3>
						<div id="debtorsCount" class="summary-value">0</div>
					</div>
					<div class="summary-card">
						<h3>×—×•×‘ ×××•×¦×¢</h3>
						<div id="averageDebt" class="summary-value">â‚ª0</div>
					</div>
					<div class="summary-card">
						<h3>×—×•×‘ ×”×›×™ ×™×©×Ÿ</h3>
						<div id="oldestDebt" class="summary-value">-</div>
					</div>
				</div>
				
				<!-- ×¨×©×™××ª ×—×•×‘×•×ª -->
				<div class="filter-panel">
					<div class="filter-header">
						<h3>ğŸ” ×—×•×‘×•×ª ×¤×ª×•×—×™×</h3>
					</div>
					<div class="filter-row">
						<div class="filter-group">
							<label>××™×•×Ÿ ×œ×¤×™:</label>
							<select id="debtSortBy" onchange="displayDebts()">
								<option value="amount_desc">×¡×›×•× (×’×‘×•×” ×œ× ××•×š)</option>
								<option value="amount_asc">×¡×›×•× (× ××•×š ×œ×’×‘×•×”)</option>
								<option value="date_old">×ª××¨×™×š (×”×›×™ ×™×©×Ÿ)</option>
								<option value="date_new">×ª××¨×™×š (×”×›×™ ×—×“×©)</option>
								<option value="location">×œ×§×•×— (×-×‘)</option>
							</select>
						</div>
						<div class="filter-group">
							<label>×¡×›×•× ××™× ×™××œ×™:</label>
							<input type="number" id="minDebtAmount" placeholder="0" onchange="displayDebts()">
						</div>
					</div>
				</div>
				
				<div class="table-container">
					<table id="debtsTable" class="data-table">
						<thead>
							<tr>
								<th>×œ×§×•×—</th>
								<th>×›×ª×•×‘×ª</th>
								<th>×˜×œ×¤×•×Ÿ</th>
								<th>××¡×¤×¨ ×˜×™×¤×•×œ×™×</th>
								<th>×¡×”"×› ×—×•×‘</th>
								<th>×˜×™×¤×•×œ ××—×¨×•×Ÿ</th>
								<th>×™××™×</th>
								<th>×¤×¢×•×œ×•×ª</th>
							</tr>
						</thead>
						<tbody id="debtsTableBody">
						</tbody>
					</table>
				</div>
			</section>

			<!-- System Section -->
			<section id="system" class="section">
				<h2>ğŸ› ï¸ ××¢×¨×›×ª</h2>
				
				<!-- Import Section -->
				<div class="form-section">
					<h3>ğŸ“¥ ×™×™×‘×•× × ×ª×•× ×™×</h3>
					
					<div class="import-main-buttons">
						<button onclick="createImportTable()">ğŸ“— ×¦×•×¨ ×˜×‘×œ×ª ×¢×–×¨ ×œ×™×™×‘×•×</button>
						<button onclick="importFromHelperTableFast()">ğŸš€ ×™×™×‘×•× ××”×™×¨ ×•×›×•×œ×œ</button>
					</div>
					
					<div class="import-other-buttons">
						<button onclick="importFromTelegram()">ğŸ’¬ ×™×™×‘×•× ××˜×œ×’×¨×</button>
					</div>
					
					<details>
						<summary>âš™ï¸ ×™×™×‘×•× ×—×œ×§×™ (×œ××ª×§×“××™×)</summary>
						<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
							<button class="btn btn-info" onclick="importCustomersFromHelper()">ğŸ‘¥ ×¨×§ ×œ×§×•×—×•×ª</button>
							<button class="btn btn-primary" onclick="importVisitsFromHelper()">ğŸ”§ ×¨×§ ×˜×™×¤×•×œ×™×</button>
							<button class="btn btn-warning" onclick="importReceiptsFromHelper()">ğŸ§¾ ×¨×§ ×§×‘×œ×•×ª</button>
						</div>
						<p style="font-size: 12px; color: #666; margin-top: 8px;">
							×”×©×ª××© ×‘×–×” ×¨×§ ×× ××ª×” ×¦×¨×™×š ×œ×™×™×‘× ×¡×•×’ × ×ª×•× ×™× ×¡×¤×¦×™×¤×™
						</p>
					</details>
					
					<div style="text-align: center; margin: 15px 0;">
						<span style="color: #666;">××•</span>
					</div>
					
					<div style="text-align: center;">
						<button class="btn btn-warning" onclick="document.getElementById('importFileInput').click()">
							ğŸ“ ×™×™×‘×•× ××”×™×¨ ××§×•×‘×¥
						</button>
						<input type="file" id="importFileInput" accept=".csv,.xlsx" style="display: none;" onchange="handleImportFile(event)">
					</div>
					
					<p style="text-align: center; font-size: 12px; color: #666; margin-top: 15px;">
						×™×™×‘×•× ×œ×§×•×—×•×ª, ×‘×™×§×•×¨×™× ×•×§×‘×œ×•×ª ××§×•×‘×¥ Excel ××• Google Sheets
					</p>
				</div>
				
				<!-- × ×™×”×•×œ × ×ª×•× ×™× -->
				<div class="form-section">
					<h3>ğŸ—‚ï¸ × ×™×”×•×œ × ×ª×•× ×™×</h3>
					
					<div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
						<h4 style="color: #856404; margin-bottom: 10px;">âš ï¸ × ×™×§×•×™ × ×ª×•× ×™×</h4>
						<p style="font-size: 14px; color: #856404; margin-bottom: 10px;">
							× ×§×” ××ª ×›×œ ×”× ×ª×•× ×™× ×”××§×•××™×™× ×œ×¤× ×™ ×™×™×‘×•× ×—×“×© (×œ× ××©×¤×™×¢ ×¢×œ ×”×¢× ×Ÿ)
						</p>
						
						<button class="btn" onclick="clearAllDataBeforeImport()" 
								style="background: #dc3545; color: white; border: none;">
							ğŸ—‘ï¸ × ×§×” ××ª ×›×œ ×”× ×ª×•× ×™× ×”××§×•××™×™×
						</button>
					</div>
					
					<!-- ×¡×˜×˜×•×¡ ×˜×‘×œ×ª ×¢×–×¨ -->
					<div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
						<h4 style="color: #495057; margin-bottom: 10px;">ğŸ“Š ×˜×‘×œ×ª ×¢×–×¨ ×œ×™×™×‘×•×</h4>
						<div id="importTableStatus">
							<span style="font-size: 13px; color: #666;">
								×‘×•×“×§ ×¡×˜×˜×•×¡ ×˜×‘×œ×ª ×¢×–×¨...
							</span>
						</div>
					</div>
				</div>
				
				<!-- Additional System Features -->
					<div class="form-section">
						<h3>âš™ï¸ ×”×’×“×¨×•×ª ××¢×¨×›×ª</h3>
						
						<!-- Cost Settings -->
						<div style="background: rgba(39, 174, 96, 0.1); border: 2px solid #27ae60; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
							<h4 style="color: #27ae60; margin-bottom: 10px;">ğŸ’° ×”×’×“×¨×•×ª ×¢×œ×•×ª ×˜×™×¤×•×œ</h4>
							<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
								<div class="form-group">
									<label for="hourlyRate">×©×¢×ª ×¢×‘×•×“×” (â‚ª):</label>
									<input type="number" id="hourlyRate" value="150" min="0" onchange="saveCostSettings()">
								</div>
								<div class="form-group">
									<label for="workerCost">×ª×•×¡×¤×ª ×œ×¤×•×¢×œ (â‚ª):</label>
									<input type="number" id="workerCost" value="50" min="0" onchange="saveCostSettings()">
								</div>
							</div>
						</div>
						
						<p style="color: #666;">×ª×›×•× ×•×ª × ×•×¡×¤×•×ª ×™×ª×•×•×¡×¤×• ×›××Ÿ ×‘×”××©×š...</p>
					</div>
			</section>
			
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <script>
		 // Google Sheets API Configuration
		const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
		const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
		let SPREADSHEET_ID = '1fSD5dh0bXRzFSeOZUwJ2bPjGRLqs2crGXPkebz6MpWc';
		const CLIENT_ID = '1040357646874-4sbkrokgjn4dd7a0e9rkrtjt8d9l3vie.apps.googleusercontent.com';
		const API_KEY = 'AIzaSyB25ms_UzbgfY9FnduMwMhGhlvwfVPaTg8';
		const SPREADSHEET_NAME = 'service_visits_data';

//////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>   ×œ××—×™×§×”
		// ×‘×“×™×§×” ×–×× ×™×ª - ×ª××—×§ ××—×¨×™ ×”×‘×“×™×§×”
		console.log('Spreadsheet ID:', SPREADSHEET_ID);
		console.log('API Key:', API_KEY);
		console.log('Client ID:', CLIENT_ID);
//////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>


		let gapi_loaded = false;
		let google_loaded = false;
		let access_token = null;
		let spreadsheet_id = SPREADSHEET_ID;
        
        // Sheet names
        const SHEETS = {
			LOCATIONS: 'Locations',
			VISITS: 'Visits',
			RECEIPTS: 'Receipts',
			SETTINGS: 'SystemSettings'
		};

        // Global variables
        let locations = [];
        let visits = [];
        let receipts = [];
        let currentFilter = 'today';
		// ×”×’×“×¨×•×ª ×¢×œ×•×ª
		let costSettings = {
			hourlyRate: 150,
			workerCost: 50
		};

		// Initialize Google APIs
		function initializeGoogleAPIs() {
			gapi.load('client', initializeGapiClient);
			google.accounts.id.initialize({
				client_id: CLIENT_ID,
				callback: handleCredentialResponse,
			});
		}
		
		async function initializeGapiClient() {
			try {
				await gapi.client.init({
					apiKey: API_KEY,
					discoveryDocs: [DISCOVERY_DOC],
				});
				gapi_loaded = true;
				console.log('GAPI client initialized successfully');
			} catch (error) {
				console.error('Error initializing GAPI client:', error);
				showToast('×©×’×™××” ×‘××ª×—×•×œ Google API', 'error');
			}
		}

		function handleCredentialResponse(response) {
			access_token = response.credential;
			showSuccess('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×” ×œ-Google!');
		}

		// ×ª×•×¡×¤×” - ×¤×•× ×§×¦×™×” ×©× ×§×¨××ª ××—×¨×™ ×”×”×ª×—×‘×¨×•×ª
		async function loadAllDataFromSheets() {
			if (!await validateToken()) {
				showToast('××™×Ÿ ×—×™×‘×•×¨ ×œ×’×•×’×œ - ×˜×•×¢×Ÿ × ×ª×•× ×™× ××§×•××™×™×', 'warning');
				return;
			}
			
			try {
				showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™× ×-Google Sheets...');
				
				await loadLocationsFromSheets();
				await loadVisitsFromSheets(); 
				await loadReceiptsFromSheets();
				
				// Update UI
				loadLocationsForSelect();
				loadLocationsTable();
				loadReceiptsTable();
				loadPlanningData();
				
				hideLoading();
				showSuccess('× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” ×-Google Sheets!');
				setTimeout(checkCriticalDebts, 2000); // ×”×ª×¨××” ××—×¨×™ 2 ×©× ×™×•×ª
				
			} catch (error) {
				console.error('Error loading data from sheets:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('âš ï¸ ×”×—×™×‘×•×¨ ×¤×’ ×‘××”×œ×š ×˜×¢×™× ×”', 'warning');
				} else {
					showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™× ×-Google Sheets');
				}
				throw error;
			}
		}

		

		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ××™×§×•××™× (×’×™× ×•×ª)
		async function loadLocationsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:O`
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					locations = rows.slice(1).map(row => ({
						ID: row[0] || '',
						name: row[1] || '',
						full_address: row[2] || '',
						neighborhood: row[3] || '',
						city: row[4] || '',
						contact_person: row[5] || '',
						phone: row[6] || '',
						allowed_day: row[7] || '',
						interval_weeks: row[8] || '',
						temp_addition: row[9] || 0,
						base_amount: row[10] || '',
						active: row[11] || '',
						notes: row[12] || '',
						last_visit: row[13] || '',
						next_visit: row[14] || ''
					}));
				}
				
			} catch (error) {
				console.error('Error loading locations:', error);
			}
		}

		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ×‘×™×§×•×¨×™× (×˜×™×¤×•×œ×™×)
		async function loadVisitsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:N` // â† ×©× ×” ×-A:L ×œ-A:N
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					visits = rows.slice(1).map(row => ({
						ID: row[0] || '',
						date: row[1] || '',
						location_id: row[2] || '',
						location_name: row[3] || '', // â† ×”×•×¡×£ ××ª ×”×©×“×” ×”×—×“×©!
						visit_type: row[4] || '',    // â† ×”×–×–×” ×©×œ ×›×œ ×”×©×“×•×ª
						work_done: row[5] || '',
						duration_minutes: row[6] || 0,
						num_workers: row[7] || 1,    // â† ×”×©×“×” ×”×–×” ×”×™×” ×—×¡×¨!
						start_time: row[8] || '',
						end_time: row[9] || '',
						amount: row[10] || 0,
						expense: row[11] || 0,
						paid: row[12] || '×œ×',
						notes: row[13] || ''         // â† ×¢×›×©×™×• ×–×” ×¢××•×“×” 13
					}));
				}
				
			} catch (error) {
				console.error('Error loading visits:', error);
			}
		}

		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ×§×‘×œ×•×ª
		async function loadReceiptsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:I`
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					receipts = rows.slice(1).map(row => ({
						ID: row[0] || '',
						book_number: row[1] || '',
						receipt_number: row[2] || '',
						date: row[3] || '',
						location_id: row[4] || '',
						location_name: row[5] || '',
						amount: row[6] || 0,
						payment_type: row[7] || '',
						notes: row[8] || ''
					}));
				}
				
			} catch (error) {
				console.error('Error loading receipts:', error);
			}
		}
		
		// ×ª×•×¡×¤×” - ×©××™×¨×ª ××™×§×•× ×—×“×© ×œ×©×™×˜×¡
		async function saveLocationToSheets(locationData) {
		
			if (!await validateToken()) {
				showToast('×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×©××™×¨×” ××§×•××™×ª ×‘×œ×‘×“', 'warning');
				return;
			}
    
			try {
				const values = [[
					locationData.ID,
					locationData.name,
					locationData.full_address,
					locationData.neighborhood,
					locationData.city,
					locationData.contact_person,
					locationData.phone,
					locationData.allowed_day,
					locationData.interval_weeks,
					locationData.temp_addition,
					locationData.base_amount,
					locationData.active,
					locationData.notes,
					locationData.last_visit,
					locationData.next_visit
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:O`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving location to sheets:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('âš ï¸ ×”×—×™×‘×•×¨ ×¤×’ - ×”×ª×—×‘×¨ ××—×“×©', 'warning');
					document.getElementById('statusText').textContent = 'ğŸ”“ × ×•×ª×§';
				} else {
					// ×©×’×™××•×ª ××—×¨×•×ª (×œ× ×§×©×•×¨×•×ª ×œ××¡×™××•×Ÿ)
					showToast('âš ï¸ ×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ', 'error');
				}
				throw error;

			}
		}

		// ×©××™×¨×ª ×‘×™×§×•×¨ ×—×“×© ×œ×©×™×˜×¡
		async function saveVisitToSheets(visitData) {
			if (!await validateToken()) {
				return;
			}
			
			try {
				const values = [[
					visitData.ID,
					visitData.date,
					visitData.location_id,
					visitData.location_name || '', // â† ×”×•×¡×£ ××ª ×”×©×“×” ×”×—×“×©!
					visitData.visit_type,
					visitData.work_done,
					visitData.duration_minutes,
					visitData.num_workers || 1,
					visitData.start_time,
					visitData.end_time,
					visitData.amount,
					visitData.expense || 0,
					visitData.paid,
					visitData.notes
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:N`, // â† ×©× ×” ×-A:M ×œ-A:N
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving visit to sheets:', error);
				throw error;
			}
		}

		// ×ª×•×¡×¤×” - ×©××™×¨×ª ×§×‘×œ×” ×œ×©×™×˜×¡
		async function saveReceiptToSheets(receiptData) {
			if (!await validateToken()) {
				return;
			}
			
			try {
				const values = [[
					receiptData.ID,
					receiptData.booklet_number || '',
					receiptData.receipt_number || '',
					receiptData.date,
					receiptData.location_id,
					receiptData.location_name || '',
					receiptData.amount,
					receiptData.payment_type || '',
					receiptData.tax_code || '',
					receiptData.notes || ''
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:J`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving receipt to sheets:', error);
				throw error;
			}
		}

		
		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ×›×œ ×”× ×ª×•× ×™× ××”×¢× ×Ÿ
		async function loadAllFromSheets() {
			try {
				showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™× ××”×¢× ×Ÿ...');
				
				await loadLocationsFromSheets();
				await loadVisitsFromSheets(); 
				await loadReceiptsFromSheets();
				
				// ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
				loadLocationsForSelect();
				loadLocationsTable();
				loadReceiptsTable();
				loadPlanningData();
				
				hideLoading();
				showSuccess('× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” ××”×¢× ×Ÿ!');
				
			} catch (error) {
				console.error('Error loading all data:', error);
				hideLoading();
				showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™× ××”×¢× ×Ÿ');
			}
		}


		// Local Storage functions
		function saveToLocalStorage() {
			try {
				localStorage.setItem('locations_data', JSON.stringify(locations));  // ×©×•× ×”
				localStorage.setItem('visits_data', JSON.stringify(visits));        // ×©×•× ×”
				localStorage.setItem('receipts_data', JSON.stringify(receipts));
				console.log('Data saved to local storage');
			} catch (error) {
				console.error('Error saving to local storage:', error);
			}
		}

		function loadFromLocalStorage() {
			try {
				const savedLocations = localStorage.getItem('locations_data');
				const savedVisits = localStorage.getItem('visits_data');
				const savedReceipts = localStorage.getItem('receipts_data');
				const savedCostSettings = localStorage.getItem('cost_settings'); // ×”×•×¡×£ ×–×”
				
				if (savedLocations) {
					locations = JSON.parse(savedLocations);
				}
				if (savedVisits) {
					visits = JSON.parse(savedVisits);
				}
				if (savedReceipts) {
					receipts = JSON.parse(savedReceipts);
				}
				if (savedCostSettings) { // ×”×•×¡×£ ××ª ×”×‘×œ×•×§ ×”×–×”
					costSettings = JSON.parse(savedCostSettings);
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
				}
				
				if (savedCostSettings) {
					costSettings = JSON.parse(savedCostSettings);
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
				}

				console.log('Data loaded from local storage');
				
			} catch (error) {
				console.error('Error loading from local storage:', error);
			}
		}



        document.addEventListener('DOMContentLoaded', function() {
			console.log('App starting...');
			initializeGoogleAPIs();
			loadAllData(); // ×–×” ×™×˜×¢×Ÿ × ×ª×•× ×™× ××§×•××™×™×
			setupEventListeners();
		});

        // Setup event listeners
        function setupEventListeners() {
            // Visitform submission
            document.getElementById('visitForm').addEventListener('submit', handleVisitSubmit);
        }

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Add active class to clicked button
            if (event && event.target) {
				event.target.classList.add('active');
			}
            
            // Load section-specific data
            switch(sectionName) {
                case 'planning':
                    loadPlanningData();
                    break;
                case 'visit':
                    loadLocationsForSelect();
                    break;
				case 'history':
					loadVisitsHistory();
					break;
                case 'locations':
                    loadLocationsTable();
                    break;
                case 'receipts':
                    loadReceiptsTable();
                    break;
				case 'debts':
                    displayDebts();
                    break;
            }
        }

        // Data loading functions
		async function loadAllData() {
			try {
				showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™×...');
				loadFromLocalStorage();
				hideLoading();
				loadPlanningData();
			} catch (error) {
				console.error('Error loading data:', error);
				showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×');
			}
		}

        async function loadlocations() {
            // For now, we'll use dummy data until we set up the Google Sheets API
            locations = [
                {
                    ID: 1,
                    name: "×’×™× ×ª ×“×•×’××” 1",
                    full_address: "×¨×—×•×‘ ×”×“×•×’××” 1, ×ª×œ ××‘×™×‘",
                    neighborhood: "××¨×›×–",
                    city: "×ª×œ ××‘×™×‘",
                    contact_person: "×™×•×¡×™ ×›×”×Ÿ",
                    phone: "050-1234567",
                    allowed_day: "×'",
                    interval_weeks: 4,
                    temp_addition: 0,
                    base_amount: 300,
                    active: "×›×Ÿ",
                    notes: "",
                    last_visit: "2024-01-15",
                    next_visit: "2024-02-12"
                },
                {
                    ID: 2,
                    name: "×’×™× ×ª ×“×•×’××” 2",
                    full_address: "×¨×—×•×‘ ×”×“×•×’××” 2, ×ª×œ ××‘×™×‘",
                    neighborhood: "×¦×¤×•×Ÿ",
                    city: "×ª×œ ××‘×™×‘",
                    contact_person: "××¨×™× ×œ×•×™",
                    phone: "052-7654321",
                    allowed_day: "×’'",
                    interval_weeks: 6,
                    temp_addition: 0,
                    base_amount: 400,
                    active: "×›×Ÿ",
                    notes: "",
                    last_visit: "2024-01-10",
                    next_visit: "2024-02-21"
                }
            ];
        }

        async function loadVisits() {
            visits = []; // Will be loaded from Google Sheets
        }

        async function loadReceipts() {
            receipts = []; // Will be loaded from Google Sheets
        }

        // Display functions
        function loadPlanningData() {
			// Debug - ×‘×“×™×§×ª × ×ª×•× ×™×
			debugPlanningData();
			
			// ×—×™×©×•×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª
			updatePlanningStats();
			
			// ×¡×™× ×•×Ÿ ×¨×’×™×œ
			filterVisits(currentFilter);
		}

	/////<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
	
	// ========== ××¢×¨×›×ª ×ª×›× ×•×Ÿ ××©×•×“×¨×’×ª ==========

		// ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×œ×ª×›× ×•×Ÿ ××©×•×“×¨×’
		let currentPlanningView = 'daily';
		let planningClients = [];

		// ×–×× ×™ ×¢×‘×•×“×” ×–××™× ×™× (07:00-19:00 ×‘×§×¤×™×¦×•×ª ×©×œ 30 ×“×§×•×ª)
		const timeSlots = [];
		for (let hour = 7; hour <= 19; hour++) {
			timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
			if (hour < 19) timeSlots.push(`${hour.toString().padStart(2, '0')}:30`);
		}

		// ×¤×•× ×§×¦×™×” ×¢×™×§×¨×™×ª ×œ×˜×¢×™× ×ª × ×ª×•× ×™ ×ª×›× ×•×Ÿ - ×’×¨×¡×” ××©×•×“×¨×’×ª
		function loadPlanningDataAdvanced() {
			updatePlanningStats();
			loadPlanningClientsAdvanced();
			updatePlanningDateHeader();
			renderPlanningCards();
		}

		// ×˜×¢×™× ×ª ×œ×§×•×—×•×ª ×œ×ª×›× ×•×Ÿ ×œ×¤×™ ×”×ª×¦×•×’×” ×”× ×•×›×—×™×ª - ×’×¨×¡×” ××ª×•×§× ×ª
		function loadPlanningClientsAdvanced() {
			const today = new Date();
			today.setHours(0, 0, 0, 0);
			
			/// console.log('ğŸ” ×˜×•×¢×Ÿ ×œ×§×•×—×•×ª ××ª×§×“× - ×¡×”"×› ×œ×§×•×—×•×ª:', locations.length);
			
			// ×¡×™× ×•×Ÿ ×œ×§×•×—×•×ª ×¤×¢×™×œ×™× - ×ª×™×§×•×Ÿ ×œ×‘×¢×™×™×ª active = true
			let filteredClients = locations.filter(location => {
				const isActive = location.active === "1";
				const hasNextVisit = location.next_visit && location.next_visit.trim() !== '';
				const hasInterval = location.interval_weeks && location.interval_weeks > 0;
				
				return isActive && hasNextVisit && hasInterval;
			});
			
			console.log('ğŸ” ×œ×§×•×—×•×ª ×¤×¢×™×œ×™× ×¢× ×ª××¨×™×›×™×:', filteredClients.length);
			
			// ×—×™×©×•×‘ ×™××™× ×‘××™×—×•×¨ ×œ×›×œ ×œ×§×•×—
			filteredClients = filteredClients.map(location => {
				const nextVisitDate = new Date(location.next_visit);
				const daysOverdue = Math.floor((today - nextVisitDate) / (1000 * 60 * 60 * 24));
				
				// ×§×‘×™×¢×ª ×¡×˜×˜×•×¡ ×¦×‘×¢
				let status = 'green';
				if (daysOverdue > 14) status = 'red';
				else if (daysOverdue > 7) status = 'orange';  
				else if (daysOverdue > 0) status = 'yellow';
				
				return {
					...location,
					daysOverdue: daysOverdue,
					status: status,
					scheduledTime: location.scheduled_time || '09:00'
				};
			});
			
			// ×¡×™× ×•×Ÿ ×œ×¤×™ ×ª×¦×•×’×” × ×•×›×—×™×ª
			switch (currentPlanningView) {
				case 'daily':
					// ×œ×§×•×—×•×ª ×©×¦×¨×™×›×™× ×˜×™×¤×•×œ ×”×™×•× ××• ×©×›×‘×¨ ×××—×¨×™×
					planningClients = filteredClients.filter(client => client.daysOverdue >= 0);
					break;
				case 'weekly':
					// ×œ×§×•×—×•×ª ×©×¦×¨×™×›×™× ×˜×™×¤×•×œ ×”×©×‘×•×¢ ×”×§×¨×•×‘ (×›×•×œ×œ ××™ ×©×›×‘×¨ ×××—×¨)
					planningClients = filteredClients.filter(client => client.daysOverdue >= -7);
					break;
				case 'overdue':
					// ×¨×§ ×œ×§×•×—×•×ª ×©×›×‘×¨ ×××—×¨×™×
					planningClients = filteredClients.filter(client => client.daysOverdue > 0);
					break;
			}
			
			/// console.log(`ğŸ” ×ª×•×¦××•×ª ×¡×™× ×•×Ÿ "${currentPlanningView}":`, planningClients.length, '×œ×§×•×—×•×ª');
			
			// ××™×•×Ÿ ×œ×¤×™ ×–××Ÿ ××ª×•×›× ×Ÿ (×¨×§ ×‘×ª×¦×•×’×” ×™×•××™×ª)
			if (currentPlanningView === 'daily') {
				planningClients.sort((a, b) => a.scheduledTime.localeCompare(b.scheduledTime));
			} else {
				planningClients.sort((a, b) => new Date(a.next_visit) - new Date(b.next_visit));
			}
		}
	
		// ×”×—×œ×¤×ª ×ª×¦×•×’×ª ×ª×›× ×•×Ÿ
		function switchPlanningView(view) {
			currentPlanningView = view;
			
			// ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨×™ ×˜××‘
			document.querySelectorAll('.planning-tab-btn').forEach(btn => btn.classList.remove('active'));
			const activeBtn = document.querySelector(`[onclick="switchPlanningView('${view}')"]`);
			if (activeBtn) activeBtn.classList.add('active');
			
			// ×˜×¢×™× ×” ××—×“×©
			loadPlanningDataAdvanced();
		}

		// ×¢×“×›×•×Ÿ ×›×•×ª×¨×ª ×ª××¨×™×š
		function updatePlanningDateHeader() {
			const today = new Date();
			const dayName = today.toLocaleDateString('he-IL', { weekday: 'long' });
			const dateFormatted = today.toLocaleDateString('he-IL', { 
				day: 'numeric', 
				month: 'long', 
				year: 'numeric' 
			});
			
			let headerTitle = '';
			switch (currentPlanningView) {
				case 'daily':
					headerTitle = `×”×™×•× - ${dayName}`;
					break;
				case 'weekly':
					headerTitle = `×”×©×‘×•×¢ - ${dayName}`;
					break;
				case 'overdue':
					headerTitle = '×××—×¨×•×ª - ×˜×™×¤×•×œ×™× ×©×“×—×•×™×™×';
					break;
			}
			
			const titleElement = document.getElementById('planningDateTitle');
			const dateElement = document.getElementById('planningDateFormatted');
			
			if (titleElement) titleElement.textContent = headerTitle;
			if (dateElement) dateElement.textContent = dateFormatted;
		}

		// ×¨×™× ×“×•×¨ ×›×¨×˜×™×¡×™ ×œ×§×•×—×•×ª ×œ×ª×›× ×•×Ÿ
		function renderPlanningCards() {
			const container = document.getElementById('planningCardsContainer');
			
			if (!container) {
				console.log('âš ï¸ ×œ× × ××¦× container ×œ×›×¨×˜×™×¡×™ ×”×ª×›× ×•×Ÿ');
				return;
			}
			
			if (planningClients.length === 0) {
				container.innerHTML = `
					<div class="planning-empty-state">
						<h3>ğŸ˜Š ××™×Ÿ ×œ×§×•×—×•×ª ×œ×ª×¦×•×’×” ×–×•</h3>
						<p>×›×œ ×”×˜×™×¤×•×œ×™× ××¢×•×“×›× ×™×!</p>
					</div>
				`;
				return;
			}

			container.innerHTML = planningClients.map((client, index) => {
				const nextVisitFormatted = formatDate(client.next_visit);
				const overdueDaysText = client.daysOverdue > 0 ? ` (××™×—×•×¨ ${client.daysOverdue} ×™××™×)` : '';
				
				return `
					<div class="planning-client-card planning-status-${client.status}" 
						 draggable="${currentPlanningView === 'daily' ? 'true' : 'false'}" 
						 data-client-id="${client.ID}"
						 data-index="${index}">
						<div class="planning-client-info">
							<div class="planning-client-main">
								<div class="planning-client-name">${client.name}</div>
								<div class="planning-client-address">${client.full_address}</div>
								${client.notes ? `<div class="planning-client-notes">ğŸ’¡ ${client.notes}</div>` : ''}
								<div class="planning-client-next-visit">
									ğŸ“… ${nextVisitFormatted}${overdueDaysText}
								</div>
							</div>
							<div class="planning-client-time">
								${currentPlanningView === 'daily' ? `
									<select class="planning-time-picker" onchange="updateClientScheduledTime('${client.ID}', this.value)">
										${timeSlots.map(time => 
											`<option value="${time}" ${time === client.scheduledTime ? 'selected' : ''}>${time}</option>`
										).join('')}
									</select>
								` : `<div class="planning-interval">×›×œ ${client.interval_weeks} ×©×‘×•×¢×•×ª</div>`}
							</div>
							<div class="planning-client-amount">â‚ª${client.base_amount || 0}</div>
						</div>
						<div class="planning-client-actions">
							<button class="planning-action-btn planning-complete" title="×¡×™×•× ×˜×™×¤×•×œ" onclick="completePlanningVisit('${client.ID}')">
								âœ“
							</button>
							<button class="planning-action-btn planning-postpone" title="×“×—×™×”" onclick="postponePlanningVisit('${client.ID}')">
								â°
							</button>
							<button class="planning-action-btn planning-menu" title="×¢×•×“ ×¤×¢×•×œ×•×ª" onclick="showPlanningClientMenu('${client.ID}')">
								â‹®
							</button>
						</div>
					</div>
				`;
			}).join('');

			// ×”×•×¡×¤×ª ××™×¨×•×¢×™ ×’×¨×™×¨×” (×¨×§ ×‘×ª×¦×•×’×” ×™×•××™×ª)
			if (currentPlanningView === 'daily') {
				addPlanningDragEvents();
			}
		}
	
		// ×¢×“×›×•×Ÿ ×©×¢×” ××ª×•×›× × ×ª ×œ×œ×§×•×—
		function updateClientScheduledTime(clientId, newTime) {
			const client = locations.find(loc => loc.ID === clientId);
			if (client) {
				client.scheduled_time = newTime;
				saveToLocalStorage();
				
				// ×©××™×¨×” ×‘×¢× ×Ÿ ×× ××—×•×‘×¨
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`×©×¢×ª ×˜×™×¤×•×œ ×¢×•×“×›× ×” ×œ-${newTime}`, 'success', 2000);
			}
		}

		// ×¡×™×•× ×˜×™×¤×•×œ (××¢×‘×¨ ×œ×˜×•×¤×¡ ×”×•×¡×¤×ª ×‘×™×§×•×¨)
		function completePlanningVisit(clientId) {
			showSection('visit');
			document.getElementById('locationSelect').value = clientId;
			document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
			
			const client = locations.find(loc => loc.ID === clientId);
			if (client && client.scheduled_time) {
				const timeInput = document.getElementById('visitTime');
				if (timeInput) timeInput.value = client.scheduled_time;
			}
		}

		// ×“×—×™×™×ª ×˜×™×¤×•×œ
		function postponePlanningVisit(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			const weeks = prompt(`×›××” ×©×‘×•×¢×•×ª ×œ×“×—×•×ª ××ª ×”×˜×™×¤×•×œ ×¢×‘×•×¨ ${client.name}?`, '1');
			if (weeks && !isNaN(weeks) && parseInt(weeks) > 0) {
				const currentNextVisit = new Date(client.next_visit);
				const postponedDate = new Date(currentNextVisit.getTime() + (parseInt(weeks) * 7 * 24 * 60 * 60 * 1000));
				
				client.next_visit = postponedDate.toISOString().split('T')[0];
				client.temp_addition = 0;
				
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`×˜×™×¤×•×œ × ×“×—×” ×œ-${formatDate(client.next_visit)}`, 'success');
				loadPlanningDataAdvanced();
			}
		}

		// ×ª×¤×¨×™×˜ ×¤×¢×•×œ×•×ª × ×•×¡×¤×•×ª ×œ×œ×§×•×—
		function showPlanningClientMenu(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			const actions = [
				'×¦×¤×™×™×” ×‘×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×',
				'×”×ª×—×œ×ª ×˜×™×¤×•×œ ××™×™×“×™',
				'×§×‘×™×¢×ª ×ª××¨×™×š ×¡×¤×¦×™×¤×™',
				'×¢×¨×™×›×ª ×¤×¨×˜×™ ×œ×§×•×—',
				'×‘×™×˜×•×œ'
			];
			
			const choice = prompt(`×‘×—×¨ ×¤×¢×•×œ×” ×¢×‘×•×¨ ${client.name}:\n\n` + 
				actions.map((action, i) => `${i + 1}. ${action}`).join('\n'));
			
			switch (choice) {
				case '1':
					showClientTreatmentHistory(clientId);
					break;
				case '2':
					startImmediateVisit(clientId);
					break;
				case '3':
					setSpecificVisitDate(clientId);
					break;
				case '4':
					editLocation(clientId);
					break;
			}
		}

		// ×¦×¤×™×™×” ×‘×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×
		function showClientTreatmentHistory(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			const clientVisits = visits.filter(visit => visit.location_id === clientId)
				.sort((a, b) => new Date(b.date) - new Date(a.date))
				.slice(0, 10);
			
			if (clientVisits.length === 0) {
				alert(`${client.name} - ××™×Ÿ ×¢×“×™×™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×`);
				return;
			}
			
			const historyText = clientVisits.map(visit => 
				`${formatDate(visit.date)} - ${visit.work_done || '×˜×™×¤×•×œ'} - â‚ª${visit.amount} (${visit.paid === '×›×Ÿ' ? '×©×•×œ×' : '×œ× ×©×•×œ×'})`
			).join('\n');
			
			alert(`×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™× - ${client.name}:\n\n${historyText}`);
		}

		// ×”×ª×—×œ×ª ×˜×™×¤×•×œ ××™×™×“×™
		function startImmediateVisit(clientId) {
			showSection('visit');
			document.getElementById('locationSelect').value = clientId;
			document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
			document.getElementById('visitTime').value = new Date().toTimeString().slice(0,5);
		}

		// ×§×‘×™×¢×ª ×ª××¨×™×š ×¡×¤×¦×™×¤×™ ×œ×˜×™×¤×•×œ
		function setSpecificVisitDate(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			const newDate = prompt(`×”×–×Ÿ ×ª××¨×™×š ×—×“×© ×œ×˜×™×¤×•×œ ×”×‘× ×¢×‘×•×¨ ${client.name}:`, client.next_visit);
			
			if (newDate && !isNaN(new Date(newDate))) {
				client.next_visit = newDate;
				client.temp_addition = 0;
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`×ª××¨×™×š ×”×˜×™×¤×•×œ ×”×‘× ×¢×‘×•×¨ ${client.name} ×¢×•×“×›×Ÿ ×œ-${formatDate(newDate)}`, 'success');
				loadPlanningDataAdvanced();
			}
		}
	
	
	// ×”×•×¡×¤×ª ××™×¨×•×¢×™ ×’×¨×™×¨×” ×œ×›×¨×˜×™×¡×™× (×¨×§ ×‘×ª×¦×•×’×” ×™×•××™×ª)
		let draggedPlanningCard = null;

		function addPlanningDragEvents() {
			const cards = document.querySelectorAll('.planning-client-card');
			
			cards.forEach(card => {
				card.addEventListener('dragstart', handlePlanningDragStart);
				card.addEventListener('dragend', handlePlanningDragEnd);
				card.addEventListener('dragover', handlePlanningDragOver);
				card.addEventListener('drop', handlePlanningDrop);
			});
		}

		function handlePlanningDragStart(e) {
			draggedPlanningCard = this;
			this.classList.add('planning-dragging');
			e.dataTransfer.effectAllowed = 'move';
		}

		function handlePlanningDragEnd(e) {
			this.classList.remove('planning-dragging');
			document.querySelectorAll('.planning-client-card').forEach(card => {
				card.classList.remove('planning-drag-over');
			});
		}

		function handlePlanningDragOver(e) {
			if (e.preventDefault) e.preventDefault();
			this.classList.add('planning-drag-over');
			e.dataTransfer.dropEffect = 'move';
			return false;
		}

		function handlePlanningDrop(e) {
			if (e.stopPropagation) e.stopPropagation();
			
			if (draggedPlanningCard !== this) {
				const draggedIndex = parseInt(draggedPlanningCard.dataset.index);
				const droppedIndex = parseInt(this.dataset.index);
				
				// ×”×—×œ×¤×ª ××§×•××•×ª ×‘××¢×¨×š
				const temp = planningClients[draggedIndex];
				planningClients[draggedIndex] = planningClients[droppedIndex];
				planningClients[droppedIndex] = temp;
				
				// ×¨×™× ×“×•×¨ ××—×“×©
				renderPlanningCards();
				
				showToast('×¡×“×¨ ×”×œ×§×•×—×•×ª ×©×•× ×”', 'info');
			}
			
			this.classList.remove('planning-drag-over');
			return false;
		}

		// ×©××™×¨×ª ×”×¤×•× ×§×¦×™×” ×”××§×•×¨×™×ª ×œ×¤× ×™ ×”×”×—×œ×¤×”
		window.originalLoadPlanningData = window.loadPlanningData;

		// ×”×—×œ×¤×ª ×”×¤×•× ×§×¦×™×” loadPlanningData
		window.loadPlanningData = function() {
			console.log('ğŸ”„ loadPlanningData × ×§×¨××”');
			
			// ×‘×“×™×§×” ×× ×™×© ××ª ×”××œ×× ×˜×™× ×”×—×“×©×™×
			if (document.getElementById('planningCardsContainer')) {
				console.log('ğŸ“Š ××©×ª××© ×‘××¢×¨×›×ª ×—×“×©×”');
				loadPlanningDataAdvanced();
			} else {
				console.log('ğŸ“Š ××©×ª××© ×‘××¢×¨×›×ª ×™×©× ×”');
				updatePlanningStats();
				filterVisits(window.currentFilter || 'today');
			}
		};

		// ×¢×“×›×•×Ÿ ×”×¤×•× ×§×¦×™×” refreshPlanningAfterTreatmentUpdate ×œ×¢×‘×•×“ ×¢× ×©×ª×™ ×”××¢×¨×›×•×ª
		function refreshPlanningAfterTreatmentUpdate() {
			const currentSection = document.querySelector('.section.active');
			if (currentSection && currentSection.id === 'planning') {
				loadPlanningData(); // ×–×” ×™×§×¨× ×œ××¢×¨×›×ª ×”××ª××™××”
			}
			
			loadLocationsForSelect();
		}
	
	/////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>


		// ×ª×•×¡×¤×” - ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
		function updatePlanningStats() {
			// ×œ×§×•×—×•×ª
			const totalLocations = locations.length;
			const activeLocations = locations.filter(loc => loc.active === '×›×Ÿ').length;
			
			// ×˜×™×¤×•×œ×™× ×”×©×‘×•×¢
			const today = new Date();
			const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
			const weeklyVisits = visits.filter(visit => {
				const visitDate = new Date(visit.date);
				return visitDate >= weekAgo && visitDate <= today;
			});
			
			// ×”×›× ×¡×” ×”×©×‘×•×¢
			const weeklyIncome = weeklyVisits.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			// ×—×•×‘×•×ª ×¤×ª×•×—×™×
			const openDebts = visits
				.filter(visit => visit.paid === '×œ×')
				.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			// ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
			document.getElementById('totalLocations').textContent = totalLocations;
			document.getElementById('activeLocations').textContent = `${activeLocations} (${totalLocations > 0 ? Math.round((activeLocations / totalLocations) * 100) : 0}%)`;
			document.getElementById('weeklyVisits').textContent = weeklyVisits.length;
			document.getElementById('weeklyIncome').textContent = `â‚ª${weeklyIncome.toLocaleString()}`;
			document.getElementById('openDebts').textContent = `â‚ª${openDebts.toLocaleString()}`;
		}

        function filterVisits(filter) {
			currentFilter = filter;
			
			// Update filter buttons
			document.querySelectorAll('.filter-btn').forEach(btn => {
				btn.classList.remove('active');
				if ((filter === 'today' && btn.textContent === '×”×™×•×') ||
					(filter === 'week' && btn.textContent === '×”×©×‘×•×¢') ||
					(filter === 'overdue' && btn.textContent === '×××•×—×¨×•×ª')) {
					btn.classList.add('active');
				}
			});
			
			// Filter locations based on next_visit date
			const today = new Date();
			today.setHours(0, 0, 0, 0); // ×ª×—×™×œ×ª ×”×™×•×
			const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
			
			let filteredlocations = locations.filter(location => {
				return location.active === "1" && location.next_visit && location.next_visit.trim() !== '';
			});
			
			switch(filter) {
				case 'today':
					// ×œ×§×•×—×•×ª ×©×”×ª××¨×™×š ×”×‘× ×©×œ×”× ×”×•× ×”×™×•× ××• ×¢×‘×¨ (×¦×¨×™×›×™× ×˜×™×¤×•×œ)
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						nextVisit.setHours(0, 0, 0, 0); // ×ª×—×™×œ×ª ×”×™×•×
						return nextVisit <= today;
					});
					break;
				case 'week':
					// ×œ×§×•×—×•×ª ×©×”×ª××¨×™×š ×”×‘× ×©×œ×”× ×”×•× ×”×©×‘×•×¢ ×”×§×¨×•×‘ ××• ×¢×‘×¨
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						return nextVisit <= weekFromNow;
					});
					break;
				case 'overdue':
					// ×œ×§×•×—×•×ª ×©×”×ª××¨×™×š ×”×‘× ×©×œ×”× ×¢×‘×¨ (×××•×—×¨×™×)
					const yesterday = new Date(today);
					yesterday.setDate(yesterday.getDate() - 1);
					
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						return nextVisit <= yesterday;
					});
					break;
			}
			
			displayPlanningTable(filteredlocations);
		}

        function displayPlanningTable(locationsToShow) {
            const tbody = document.getElementById('planningTableBody');
            tbody.innerHTML = '';
            
            if (locationsToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">××™×Ÿ ×’×™× ×•×ª ×œ×˜×™×¤×•×œ</td></tr>';
                return;
            }
            
            locationsToShow.forEach(location => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${location.name}</td>
                    <td>${location.full_address}</td>
                    <td>${location.allowed_day}</td>
                    <td>${formatDate(location.next_visit)}</td>
                    <td>
                        <button class="action-btn start-visit-btn" onclick="startVisitForlocation(${location.ID})">
                            ×”×ª×—×œ ×˜×™×¤×•×œ
                        </button>
                        <button class="action-btn edit-btn" onclick="postponeVisit(${location.ID})">
                            ×“×—×”
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadLocationsForSelect() {
            const select = document.getElementById('locationSelect');
            select.innerHTML = '<option value="">×‘×—×¨ ×œ×§×•×—...</option>';
            
            locations.filter(location => location.active === "1").forEach(location => {
                const option = document.createElement('option');
                option.value = location.ID;
                option.textContent = `${location.name} - ${location.full_address}`;
                select.appendChild(option);
            });
        }

       function loadLocationsTable() {
			const tbody = document.getElementById('locationsTableBody');
			tbody.innerHTML = '';
			
			locations.forEach(location => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${location.name}</td>
					<td>${location.full_address}</td>
					<td>${location.contact_person}</td>
					<td>${location.allowed_day}</td>
					<td>${location.interval_weeks} ×©×‘×•×¢×•×ª</td>
					<td>${location.active}</td>
					<td>
						<button class="action-btn edit-btn" onclick="editLocation('${location.ID}')">×¢×¨×•×š</button>
						<button class="action-btn delete-btn" onclick="deleteLocation('${location.ID}')">××—×§</button>
					</td>
				`;
				tbody.appendChild(row);
			});
		}

       function loadReceiptsTable() {
			const tbody = document.getElementById('receiptsTableBody');
			tbody.innerHTML = '';
			
			if (receipts.length === 0) {
				tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">××™×Ÿ ×§×‘×œ×•×ª</td></tr>';
				return;
			}

			receipts.forEach(receipt => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${receipt.book_number}</td>
					<td>${receipt.receipt_number}</td>
					<td>${formatDate(receipt.date)}</td>
					<td>${receipt.location_name}</td>
					<td>${receipt.amount}</td>
					<td>${receipt.payment_type}</td>
					<td>${receipt.codeX || ''}</td>
					<td>
						<button class="action-btn edit-btn" onclick="editReceipt('${receipt.ID}')">×¢×¨×•×š</button>
						<button class="action-btn delete-btn" onclick="deleteReceipt('${receipt.ID}')">××—×§</button>
					</td>
				`;
				tbody.appendChild(row);
			});
		}

        // Visithandling
        function startVisitForlocation(locationId) {
            const location = locations.find(g => g.ID === locationId);
            if (location) {
                showSection('visit');
                document.getElementById('locationSelect').value = locationId;
            }
        }

        function handleVisitSubmit(event) {
			event.preventDefault();
			
			const formData = new FormData(event.target);
			const selectedLocationId = document.getElementById('locationSelect').value;
			const visitDate = document.getElementById('visitDate').value; // ×”×ª××¨×™×š ×”× ×•×›×—×™
			
			// ×‘×“×™×§×•×ª ×‘×¡×™×¡×™×•×ª
			if (!selectedLocationId) {
				showError('×× × ×‘×—×¨ ×œ×§×•×—');
				return;
			}
			
			// ×‘×“×™×§×ª ×›×¤×™×œ×•×ª
			const duplicateVisit = checkDuplicateVisit(selectedLocationId, visitDate);
			if (duplicateVisit) {
				const location = locations.find(loc => loc.ID == selectedLocationId);
				const locationName = location ? location.name : '×œ×§×•×— ×œ× ×™×“×•×¢';
				
				const confirmMessage = `×›×‘×¨ ×§×™×™× ×˜×™×¤×•×œ ×œ×œ×§×•×— "${locationName}" ×”×™×•× (${formatDate(visitDate)}).\n\n×”×× ×œ×”×•×¡×™×£ ×˜×™×¤×•×œ × ×•×¡×£ ×‘×›×œ ×–××ª?`;
				
				if (!confirm(confirmMessage)) {
					return; // ×‘×™×˜×•×œ ×”×•×¡×¤×”
				}
			}

			const visitData = {
				location_id: selectedLocationId,  
				visit_type: document.getElementById('visitType').value,
				work_done: document.getElementById('workDone').value,
				duration_minutes: parseFloat(document.getElementById('manualDurationMinutes').value) || 0,
				workers_count: parseInt(document.getElementById('numberOfWorkersVisit').value) || 1,		
				amount: document.getElementById('amount').value || 0,
				expense: document.getElementById('expense').value || 0,
				paid: document.getElementById('paid') ? document.getElementById('paid').value : '×œ×', // ×”×•×¡×£ ×× ×§×™×™×
				notes: document.getElementById('notes') ? document.getElementById('notes').value : '', // ×”×•×¡×£ ×× ×§×™×™×
				date: visitDate,
				start_time: document.getElementById('visitTime').value,
				end_time: document.getElementById('visitTime').value
			};
			
			console.log('Visitdata:', visitData);
			
			// Here we would save to Google Sheets
			saveVisit(visitData);
		}

		// ×œ×©× ×•×ª ×‘×¤×•× ×§×¦×™×” ×”×§×™×™××ª - ×œ×”×•×¡×™×£ ×©××™×¨×” ×œ×©×™×˜×¡
		async function saveVisit(visitData) {
			try {
				// For now, just add to local array
				const newVisit = {
					ID: generateID(),
					location_name: location ? location.name : '',
					paid: visitData.paid || '×œ×',     // ××©×ª××© ×‘×¢×¨×š ××”×˜×•×¤×¡
					notes: visitData.notes || '',     // ××©×ª××© ×‘×¢×¨×š ××”×˜×•×¤×¡
					...visitData                      // ×©××¨ ×”× ×ª×•× ×™×
				};
				
				// ×‘×“×™×§×ª ×ª×§×™× ×•×ª
				const visitErrors = validateVisitData(visitData);
				if (showValidationErrors(visitErrors)) {
					return;
				}
				
				// ×‘×“×™×§×ª ×›×¤×™×œ×•×™×•×ª ×‘×™×§×•×¨
				const existingVisit = visits.find(visit => 
					visit.location_id === visitData.location_id &&
					visit.date === visitData.date &&
					Math.abs(new Date(`${visit.date} ${visit.start_time}`) - new Date(`${visitData.date} ${visitData.start_time}`)) < 60000 // ×¤×—×•×ª ××“×§×” ×”×¤×¨×©
				);

				if (existingVisit) {
					if (!confirm(`×›×‘×¨ ×§×™×™× ×‘×™×§×•×¨ ×‘××•×ª×” ×›×ª×•×‘×ª ×‘××•×ª×• ×ª××¨×™×š ×•×©×¢×” ×“×•××”.\n\n×”×× ×œ×”×•×¡×™×£ ×‘×›×œ ×–××ª?`)) {
						return; // ×‘×™×˜×•×œ ×”×•×¡×¤×”
					}
				}
				
				visits.push(newVisit);

				// ×ª×•×¡×¤×” - ×©××™×¨×” ×œ×’×•×’×œ ×©×™×˜×¡
				if (access_token) {
					await saveVisitToSheets(newVisit);
				}

				// Update next visitdate if it's a full visit
				if (visitData.visit_type === '××œ×') {
				   updateNextVisitDate(visitData.location_id);
				}
		
				showSuccess('×˜×™×¤×•×œ × ×©××¨ ×‘×”×¦×œ×—×”!');
				
				// Reset form
				document.getElementById('visitForm').reset();
			   		   
				// Reload planning data
				loadPlanningData();
				saveToLocalStorage();
				   
			} catch (error) {
				console.error('Error saving visit:', error);
				showError('×©×’×™××” ×‘×©××™×¨×ª ×”×˜×™×¤×•×œ');
			}
		}

		function updateNextVisitDate(locationId) {
			const location = locations.find(g => g.ID == locationId);
			if (location) {
               const lastVisit= new Date();
               const intervalWeeks = parseInt(location.interval_weeks) + parseInt(location.temp_addition || 0);
               const nextVisit= new Date(lastVisit.getTime() + (intervalWeeks * 7 * 24 * 60 * 60 * 1000));
               
               location.last_visit= lastVisit.toISOString().split('T')[0];
               location.next_visit= nextVisit.toISOString().split('T')[0];
               location.temp_addition = 0; // Reset temporary addition
               
               // Here we would update Google Sheets
               console.log(`Updated next visitfor ${location.name}: ${location.next_visit}`);
			}
		}

		function postponeVisit(locationId) {
			const location = locations.find(g => g.ID == locationId);
			if (location) {
				const weeks = prompt('×›××” ×©×‘×•×¢×•×ª ×œ×“×—×•×ª?', '1');
				if (weeks && !isNaN(weeks)) {
					const currentNext = new Date(location.next_visit);
					const newNext = new Date(currentNext.getTime() + (parseInt(weeks) * 7 * 24 * 60 * 60 * 1000));
					location.next_visit= newNext.toISOString().split('T')[0];

					loadPlanningData();
					showSuccess(`×˜×™×¤×•×œ × ×“×—×” ×‘-${weeks} ×©×‘×•×¢×•×ª`);
				}
			}
		}

       // location management
       function showAddLocationForm() {
           const modalHTML = `
               <div class="modal" id="locationModal">
                   <div class="modal-content">
                       <div class="modal-header">
                           h3>×”×•×¡×¤×ª ×œ×§×•×— ×—×“×©</h3>
                           <span class="close" onclick="closeModal('locationModal')">&times;</span>
                       </div>
                       <form id="locationForm" onsubmit="handleLocationSubmit(event)">
                           <div class="form-group">
                               <label for="locationName">×©× ×œ×§×•×—:</label>
                               <input type="text" id="locationName" required>
                           </div>
                           <div class="form-group">
                               <label for="locationAddress">×›×ª×•×‘×ª ××œ××”:</label>
                               <input type="text" id="locationAddress" required>
                           </div>
                           <div class="form-group">
                               <label for="locationNeighborhood">×©×›×•× ×”:</label>
                               <input type="text" id="locationNeighborhood">
                           </div>
                           <div class="form-group">
                               <label for="locationCity">×¢×™×¨:</label>
                               <input type="text" id="locationCity">
                           </div>
                           <div class="form-group">
                               <label for="locationContact">××™×© ×§×©×¨:</label>
                               <input type="text" id="locationContact" required>
                           </div>
                           <div class="form-group">
                               <label for="locationPhone">×˜×œ×¤×•×Ÿ:</label>
                               <input type="tel" id="locationPhone">
                           </div>
                           <div class="form-group">
                               <label for="locationDay">×™×•× ××•×ª×¨:</label>
                               <select id="locationDay" required>
                                   <option value="">×‘×—×¨ ×™×•×...</option>
                                   <option value="×'">×¨××©×•×Ÿ</option>
                                   <option value="×‘'">×©× ×™</option>
                                   <option value="×’'">×©×œ×™×©×™</option>
                                   <option value="×“'">×¨×‘×™×¢×™</option>
                                   <option value="×”'">×—××™×©×™</option>
                                   <option value="×•'">×©×™×©×™</option>
                                   <option value="×©×‘×ª">×©×‘×ª</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label for="locationInterval">××¨×•×•×— ×©×‘×•×¢×•×ª:</label>
                               <input type="number" id="locationInterval" required min="1" max="52">
                           </div>
                           <div class="form-group">
                               <label for="locationAmount">×¡×›×•× ×‘×¡×™×¡×™:</label>
                               <input type="number" id="locationAmount">
                           </div>
                           <div class="form-group">
                               <label for="locationActive">×¤×¢×™×œ×”:</label>
                               <select id="locationActive" required>
                                   <option value="×›×Ÿ">×›×Ÿ</option>
                                   <option value="×œ×">×œ×</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label for="locationNextVisit">×ª××¨×™×š ×œ×˜×™×¤×•×œ ×”×‘×:</label>
                               <input type="date" id="locationNextVisit" required>
                           </div>
                           <div class="form-group">
                               <label for="locationNotes">×”×¢×¨×•×ª:</label>
                               <textarea id="locationNotes"></textarea>
                           </div>
                           <button type="submit">×©××•×¨ ×œ×§×•×—</button>
                       </form>
                   </div>
               </div>
           `;
           
           document.getElementById('modalContainer').innerHTML = modalHTML;
           document.getElementById('locationModal').style.display = 'block';
           
           // Set default next visitdate to today
           document.getElementById('locationNextVisit').value = new Date().toISOString().split('T')[0];
       }

        async function handleLocationSubmit(event) {
            event.preventDefault();
           
			const locationData = {
				ID: generateID(),
				name: document.getElementById('locationName').value,
				full_address: document.getElementById('locationAddress').value,
				neighborhood: document.getElementById('locationNeighborhood').value,
				city: document.getElementById('locationCity').value,
				contact_person: document.getElementById('locationContact').value,
				phone: document.getElementById('locationPhone').value,
				allowed_day: document.getElementById('locationDay').value,
				interval_weeks: parseInt(document.getElementById('locationInterval').value),
				temp_addition: 0,
				base_amount: parseFloat(document.getElementById('locationAmount').value) || 0,
				active: document.getElementById('locationActive').value,
				notes: document.getElementById('locationNotes').value,
				last_visit: '',
				next_visit: document.getElementById('locationNextVisit').value
			};
           
		    // ×‘×“×™×§×ª ×›×¤×™×œ×•×™×•×ª ×œ×¤× ×™ ×”×•×¡×¤×”
			const existingLocation = locations.find(loc => 
				loc.full_address && locationData.full_address &&
				loc.full_address.toLowerCase().trim() === locationData.full_address.toLowerCase().trim()
			);

			if (existingLocation) {
				if (!confirm(`×œ×§×•×— ×¢× ×›×ª×•×‘×ª "${locationData.full_address}" ×›×‘×¨ ×§×™×™×.\n\n×”×× ×œ×”×•×¡×™×£ ×‘×›×œ ×–××ª?`)) {
					return; // ×‘×™×˜×•×œ ×”×•×¡×¤×”
				}
			}
		   
            // ×©××™×¨×” ×œ×–×™×›×¨×•×Ÿ ××§×•××™
			locations.push(locationData);

			// ×©××™×¨×” ××•×˜×•××˜×™×ª ×œ×¢× ×Ÿ
			if (access_token && spreadsheet_id) {
				document.getElementById('statusText').textContent = 'ğŸ”„ ×©×•××¨ ×œ×§×•×—...';
				try {
					await saveLocationToSheets(locationData);
					document.getElementById('statusText').textContent = '××—×•×‘×¨';
					showSuccess('×œ×§×•×— × ×©××¨ ×‘×”×¦×œ×—×” ×œ-Google Sheets!');
				} catch (error) {
					if (error.status === 401) {
						document.getElementById('statusText').textContent = 'ğŸ”“ × ×“×¨×© ×—×™×‘×•×¨ ××—×“×©';
						document.getElementById('statusText').classList.remove('connected');
						showToast('âš ï¸ ×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×”×ª×—×‘×¨ ××—×“×©', 'warning');
						access_token = null;
					} else {
						document.getElementById('statusText').textContent = 'âš ï¸ ×©×’×™××” ×‘×©××™×¨×”';
						showToast('âš ï¸ ×”×œ×§×•×— × ×©××¨ ××§×•××™×ª ×‘×œ×‘×“', 'warning');
					}
				}
			} else {
				showToast('ğŸ”“ ×œ×§×•×— × ×©××¨ ××§×•××™×ª - ×”×ª×—×‘×¨ ×œ×¢× ×Ÿ ×œ×©××™×¨×”', 'warning');
			}

			closeModal('locationModal');
			loadLocationsTable();
			loadLocationsForSelect();
			saveToLocalStorage();
        }

		function editLocation(locationId) {
			console.log(`âœ… editLocation ('${locationId}')`);
			const location = locations.find(g => g.ID == locationId);
			if (!location) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			console.log(`âœ… editLocation second: ('${locationId}')`);
			
			// ×¦×•×¨ ×—×œ×•×Ÿ ×¢×¨×™×›×”
			const editModalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ  ×¢×¨×™×›×ª ×œ×§×•×— - ${location.name}</h3>
					
					<form id="editLocationForm">
						<div class="form-group">
							<label>×©× ×”×œ×§×•×—:</label>
							<input type="text" id="editLocationName" value="${location.name || ''}" required>
						</div>
						
						<div class="form-group">
							<label>×›×ª×•×‘×ª ××œ××”:</label>
							<input type="text" id="editLocationAddress" value="${location.full_address || ''}" required>
						</div>
						
						<div class="form-group">
							<label>×©×›×•× ×”:</label>
							<input type="text" id="editLocationNeighborhood" value="${location.neighborhood || ''}">
						</div>
						
						<div class="form-group">
							<label>×¢×™×¨:</label>
							<input type="text" id="editLocationCity" value="${location.city || ''}">
						</div>
						
						<div class="form-group">
							<label>××™×© ×§×©×¨:</label>
							<input type="text" id="editLocationContact" value="${location.contact_person || ''}">
						</div>
						
						<div class="form-group">
							<label>×˜×œ×¤×•×Ÿ:</label>
							<input type="tel" id="editLocationPhone" value="${location.phone || ''}">
						</div>
						
						<div class="form-group">
							<label>×™×•× ××•×¢×“×£:</label>
							<select id="editLocationDay">
								<option value="×›×œ ×™×•×" ${location.allowed_day === '×›×œ ×™×•×' ? 'selected' : ''}>×›×œ ×™×•×</option>
								<option value="×¨××©×•×Ÿ" ${location.allowed_day === '×¨××©×•×Ÿ' ? 'selected' : ''}>×¨××©×•×Ÿ</option>
								<option value="×©× ×™" ${location.allowed_day === '×©× ×™' ? 'selected' : ''}>×©× ×™</option>
								<option value="×©×œ×™×©×™" ${location.allowed_day === '×©×œ×™×©×™' ? 'selected' : ''}>×©×œ×™×©×™</option>
								<option value="×¨×‘×™×¢×™" ${location.allowed_day === '×¨×‘×™×¢×™' ? 'selected' : ''}>×¨×‘×™×¢×™</option>
								<option value="×—××™×©×™" ${location.allowed_day === '×—××™×©×™' ? 'selected' : ''}>×—××™×©×™</option>
								<option value="×©×™×©×™" ${location.allowed_day === '×©×™×©×™' ? 'selected' : ''}>×©×™×©×™</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>××¨×•×•×— ×‘×©×‘×•×¢×•×ª:</label>
							<input type="number" id="editLocationInterval" value="${location.interval_weeks || 4}" min="1" required>
						</div>
						
						<div class="form-group">
							<label>×¡×›×•× ×‘×¡×™×¡ (â‚ª):</label>
							<input type="number" step="0.01" id="editLocationAmount" value="${location.base_amount || 0}">
						</div>
						
						<div class="form-group">
							<label>×¡×˜×˜×•×¡:</label>
							<select id="editLocationActive">
								<option value="1" ${location.active === '1' ? 'selected' : ''}>×¤×¢×™×œ</option>
								<option value="0" ${location.active === '0' ? 'selected' : ''}>×œ× ×¤×¢×™×œ</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>×˜×™×¤×•×œ ×”×‘×:</label>
							<input type="date" id="editLocationNextVisit" value="${location.next_visit || ''}">
						</div>
						
						<div class="form-group">
							<label>×”×¢×¨×•×ª:</label>
							<textarea id="editLocationNotes" rows="3">${location.notes || ''}</textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="button" onclick="saveEditedLocation('${locationId}')" class="btn btn-success">
								ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×
							</button>
							<button type="button" onclick="closeEditModal()" class="btn btn-secondary">
								âŒ ×‘×™×˜×•×œ
							</button>
						</div>
					</form>
				</div>
			`;
			
			// ×”×¦×’ ××ª ×”××•×“×œ
			showEditModal(editModalHTML);
		}

		// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×”×œ×§×•×— ×‘×¢× ×Ÿ (××•×¤×¦×™×•× ×œ×™×ª)
		async function updateLocationInCloud(updatedLocation) {
			if (!await validateToken()) return;
			
			try {
				// ×§×¨×™××ª ×›×œ ×”× ×ª×•× ×™× ××”×¢× ×Ÿ
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:O'
				});
				
				const rows = response.result.values || [];
				
				// ××¦×™××ª ×”×©×•×¨×” ×œ×¢×“×›×•×Ÿ
				let rowToUpdate = -1;
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] == updatedLocation.ID) {
						rowToUpdate = i + 1; // +1 ×›×™ Google Sheets ××ª×—×™×œ ×-1
						break;
					}
				}
				
				if (rowToUpdate > 0) {
					// ×¢×“×›×•×Ÿ ×”×©×•×¨×”
					const updatedRow = [
						updatedLocation.ID,
						updatedLocation.name,
						updatedLocation.full_address,
						updatedLocation.neighborhood,
						updatedLocation.city,
						updatedLocation.contact_person,
						updatedLocation.phone,
						updatedLocation.allowed_day,
						updatedLocation.interval_weeks,
						updatedLocation.temp_addition || 0,
						updatedLocation.base_amount,
						updatedLocation.active,
						updatedLocation.notes,
						updatedLocation.last_visit || '',
						updatedLocation.next_visit || ''
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Locations!A${rowToUpdate}:O${rowToUpdate}`,
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [updatedRow]
						}
					});
					
					console.log(`âœ… Updated location ${updatedLocation.ID} in cloud`);
				}
				
			} catch (error) {
				console.error('Error updating location in cloud:', error);
				throw error;
			}
		}
        

       function deleteLocation(locationId) {
           if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×œ×§×•×—?')) {
               locations = locations.filter(g => g.ID != locationId);
               loadLocationsTable();
               loadLocationsForSelect();
               loadPlanningData();
               showSuccess('×œ×§×•×— × ××—×§ ×‘×”×¦×œ×—×”!');
			   saveToLocalStorage();
           }
       }

       // Receipt management
       function showAddReceiptForm() {
           const modalHTML = `
               <div class="modal" id="receiptModal">
                   <div class="modal-content">
                       <div class="modal-header">
                           <h3>×”×•×¡×¤×ª ×§×‘×œ×” ×—×“×©×”</h3>
                           <span class="close" onclick="closeModal('receiptModal')">&times;</span>
                       </div>
                       <form id="receiptForm" onsubmit="handleReceiptSubmit(event)">
                           <div class="form-group">
                               <label for="receiptBook">××¡×¤×¨ ×¤× ×§×¡:</label>
                               <input type="number" id="receiptBook" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptNumber">××¡×¤×¨ ×§×‘×œ×”:</label>
                               <input type="number" id="receiptNumber" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptDate">×ª××¨×™×š:</label>
                               <input type="date" id="receiptDate" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptlocations">×’×™× ×”:</label>
                               <select id="receiptlocations" required>
                                   <option value="">×‘×—×¨ ×’×™× ×”...</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label for="receiptAmount">×¡×›×•×:</label>
                               <input type="number" id="receiptAmount" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptPaymentType">×¡×•×’ ×ª×©×œ×•×:</label>
                               <select id="receiptPaymentType" required>
                                   <option value="">×‘×—×¨ ×¡×•×’...</option>
                                   <option value="××–×•××Ÿ">××–×•××Ÿ</option>
                                   <option value="×¦'×§">×¦'×§</option>
                                   <option value="×”×¢×‘×¨×”">×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
                                   <option value="×‘×™×˜">×‘×™×˜</option>
                                   <option value="×¤×™×™×‘×•×§×¡">×¤×™×™×‘×•×§×¡</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label for="receiptNotes">×”×¢×¨×•×ª:</label>
                               <textarea id="receiptNotes"></textarea>
                           </div>
                           <button type="submit">×©××•×¨ ×§×‘×œ×”</button>
                       </form>
                   </div>
               </div>
           `;
           
           document.getElementById('modalContainer').innerHTML = modalHTML;
           document.getElementById('receiptModal').style.display = 'block';
           
           // Set default date to today
           document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
           
           // Populate locations select
           const select = document.getElementById('receiptlocations');
           locations.forEach(location => {
               const option = document.createElement('option');
               option.value = location.ID;
               option.textContent = `${location.name} - ${location.full_address}`;
               select.appendChild(option);
           });
       }

       async function handleReceiptSubmit(event) {
           event.preventDefault();
           
           const locationId = document.getElementById('receiptlocation').value;
           const location = locations.find(g => g.ID == locationId);
           
           const receiptData = {
				ID: Date.now(),
				book_number: document.getElementById('receiptBook').value,
				receipt_number: document.getElementById('receiptNumber').value,
				date: document.getElementById('receiptDate').value,
				location_id: locationId,        
				location_name: location ? location.name : '',  // ×©×•× ×” ×-location_name
				amount: parseFloat(document.getElementById('receiptAmount').value),
				payment_type: document.getElementById('receiptPaymentType').value,
				notes: document.getElementById('receiptNotes').value
			};
           
		   // ×ª×•×¡×¤×” - ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×œ×¤× ×™ ×©××™×¨×”
			const errors = validateReceiptData(receiptData);
			if (showValidationErrors(errors)) {
				return; // ×™×© ×©×’×™××•×ª - ×¢×¦×•×¨ ×›××Ÿ
			}
		   
		   // ×‘×“×™×§×ª ×›×¤×™×œ×•×™×•×ª ×§×‘×œ×”
			const existingReceipt = receipts.find(receipt => 
				(receipt.book_number === receiptData.book_number && receipt.receipt_number === receiptData.receipt_number) ||
				(receipt.location_id === receiptData.location_id && receipt.date === receiptData.date && receipt.amount === receiptData.amount)
			);

			if (existingReceipt) {
				if (!confirm(`×›×‘×¨ ×§×™×™××ª ×§×‘×œ×” ×¢× ××•×ª×• ××¡×¤×¨ ××• ×‘××•×ª×” ×›×ª×•×‘×ª/×ª××¨×™×š/×¡×›×•×.\n\n×”×× ×œ×”×•×¡×™×£ ×‘×›×œ ×–××ª?`)) {
					return; // ×‘×™×˜×•×œ ×”×•×¡×¤×”
				}
			}
		   
            receipts.push(receiptData);
		   
			if (access_token) {
				await saveReceiptToSheets(receiptData);
				showSuccess('×§×‘×œ×” × ×©××¨×” ×‘×”×¦×œ×—×” ×œ-Google Sheets!');
			} else {
				showSuccess('×§×‘×œ×” × ×©××¨×” ××§×•××™×ª!');
			}

			closeModal('receiptModal');
			loadReceiptsTable();
			saveToLocalStorage();
       }

       // Utility functions
       function closeModal(modalId) {
           document.getElementById(modalId).style.display = 'none';
       }

       function formatDate(dateString) {
           const date = new Date(dateString);
           return date.toLocaleDateString('he-IL');
       }

       function showLoading(message) {
           // Could implement loading spinner
           console.log('Loading:', message);
       }

       function hideLoading() {
           // Hide loading spinner
           console.log('Loading complete');
       }

       
       // Click outside modal to close
       window.onclick = function(event) {
           if (event.target.classList.contains('modal')) {
               event.target.style.display = 'none';
           }
       }
	   
	  function editReceipt(receiptId) {
			console.log(`âœ… editReceipt ('${receiptId}')`);
			const receipt = receipts.find(r => r.ID == receiptId);
			if (!receipt) {
				showToast('×§×‘×œ×” ×œ× × ××¦××”', 'error');
				return;
			}
			
			// ×‘× ×™×™×ª ××¤×©×¨×•×™×•×ª ×”×œ×§×•×—×•×ª
			let locationOptions = '<option value="">×‘×—×¨ ×œ×§×•×—</option>';
			locations.forEach(location => {
				const selected = location.ID == receipt.location_id ? 'selected' : '';
				locationOptions += `<option value="${location.ID}" ${selected}>${location.name} - ${location.full_address}</option>`;
			});
			
			// ×¦×•×¨ ×—×œ×•×Ÿ ×¢×¨×™×›×”
			const editModalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ§¾ ×¢×¨×™×›×ª ×§×‘×œ×”</h3>
					
					<form id="editReceiptForm">
						<div class="form-group">
							<label>××¡×¤×¨ ×¤× ×§×¡:</label>
							<input type="text" id="editReceiptBook" value="${receipt.book_number || ''}" required>
						</div>
						
						<div class="form-group">
							<label>××¡×¤×¨ ×§×‘×œ×”:</label>
							<input type="text" id="editReceiptNumber" value="${receipt.receipt_number || ''}" required>
						</div>
						
						<div class="form-group">
							<label>×ª××¨×™×š:</label>
							<input type="date" id="editReceiptDate" value="${receipt.date}" required>
						</div>
						
						<div class="form-group">
							<label>×œ×§×•×—:</label>
							<select id="editReceiptLocation" required>
								${locationOptions}
							</select>
						</div>
						
						<div class="form-group">
							<label>×¡×›×•× (â‚ª):</label>
							<input type="number" step="0.01" id="editReceiptAmount" value="${receipt.amount || 0}" required>
						</div>
						
						<div class="form-group">
							<label>×¡×•×’ ×ª×©×œ×•×:</label>
							<select id="editReceiptPaymentType">
								<option value="××–×•××Ÿ" ${receipt.payment_type === '××–×•××Ÿ' ? 'selected' : ''}>××–×•××Ÿ</option>
								<option value="×”×¢×‘×¨×”" ${receipt.payment_type === '×”×¢×‘×¨×”' ? 'selected' : ''}>×”×¢×‘×¨×”</option>
								<option value="×¦×³×§" ${receipt.payment_type === '×¦×³×§' ? 'selected' : ''}>×¦×³×§</option>
								<option value="×›×¨×˜×™×¡ ××©×¨××™" ${receipt.payment_type === '×›×¨×˜×™×¡ ××©×¨××™' ? 'selected' : ''}>×›×¨×˜×™×¡ ××©×¨××™</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>×”×¢×¨×•×ª:</label>
							<textarea id="editReceiptNotes" rows="3">${receipt.notes || ''}</textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="button" onclick="saveEditedReceipt('${receiptId}')" class="btn btn-success">
								ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×
							</button>
							<button type="button" onclick="closeEditModal()" class="btn btn-secondary">
								âŒ ×‘×™×˜×•×œ
							</button>
						</div>
					</form>
				</div>
			`;
			
			// ×”×¦×’ ××ª ×”××•×“×œ
			showEditModal(editModalHTML);
		}

		
		// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×”×§×‘×œ×” ×‘×¢× ×Ÿ (××•×¤×¦×™×•× ×œ×™×ª)
		async function updateReceiptInCloud(updatedReceipt) {
			if (!await validateToken()) return;
			
			try {
				// ×§×¨×™××ª ×›×œ ×”× ×ª×•× ×™× ××”×¢× ×Ÿ
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Receipts!A:I'
				});
				
				const rows = response.result.values || [];
				
				// ××¦×™××ª ×”×©×•×¨×” ×œ×¢×“×›×•×Ÿ
				let rowToUpdate = -1;
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] == updatedReceipt.ID) {
						rowToUpdate = i + 1; // +1 ×›×™ Google Sheets ××ª×—×™×œ ×-1
						break;
					}
				}
				
				if (rowToUpdate > 0) {
					// ×¢×“×›×•×Ÿ ×”×©×•×¨×”
					const updatedRow = [
						updatedReceipt.ID,
						updatedReceipt.book_number,
						updatedReceipt.receipt_number,
						updatedReceipt.date,
						updatedReceipt.location_id,
						updatedReceipt.location_name,
						updatedReceipt.amount,
						updatedReceipt.payment_type,
						updatedReceipt.notes
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Receipts!A${rowToUpdate}:I${rowToUpdate}`,
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [updatedRow]
						}
					});
					
					console.log(`âœ… Updated receipt ${updatedReceipt.ID} in cloud`);
				}
				
			} catch (error) {
				console.error('Error updating receipt in cloud:', error);
				throw error;
			}
		}

		
		function deleteReceipt(receiptId) {
			if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×§×‘×œ×”?')) {
				receipts = receipts.filter(r => r.ID != receiptId);
				loadReceiptsTable();
				saveToLocalStorage();
				showSuccess('×§×‘×œ×” × ××—×§×” ×‘×”×¦×œ×—×”!');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×”×•×“×¢×•×ª Toast ××ª×§×“××•×ª
		function showToast(message, type = 'info', duration = 3000) {
			const toastContainer = document.getElementById('toastContainer');
			
			if (!toastContainer) {
				console.error('Toast container not found');
				return;
			}
			
			const toast = document.createElement('div');
			toast.className = `toast ${type}`;
			toast.textContent = message;
			
			toastContainer.appendChild(toast);
			
			// Trigger animation
			setTimeout(() => {
				toast.classList.add('show');
			}, 100);
			
			// Remove toast after specified duration
			setTimeout(() => {
				toast.classList.remove('show');
				setTimeout(() => {
					if (toast.parentNode) {
						toast.parentNode.removeChild(toast);
					}
				}, 300);
			}, duration);
		}
	   
	   // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×”×•×“×¢×•×ª
		function showSuccess(message, duration = 3000) {
			showToast(message, 'success', duration);
		}

		function showError(message, duration = 4000) {
			showToast(message, 'error', duration);
		}

		function showWarning(message, duration = 3500) {
			showToast(message, 'warning', duration);
		}

		function showInfo(message, duration = 3000) {
			showToast(message, 'info', duration);
		}
	   
	   
	    // ×™×¦×™×¨×ª ×˜×‘×œ×ª ×¢×–×¨ ×œ×™×™×‘×•×
		async function clearAllDataBeforeImport() {
			if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×§×™×™××™× ×œ×¤× ×™ ×”×™×™×‘×•× ×”×—×“×©?\n\n×¤×¢×•×œ×” ×–×• ×ª××—×§:\n- ××ª ×›×œ ×”××™×§×•××™×\n- ××ª ×›×œ ×”×‘×™×§×•×¨×™×\n- ××ª ×›×œ ×”×§×‘×œ×•×ª\n\n×”× ×ª×•× ×™× ×‘×’×•×’×œ ×©×™×˜×¡ ×œ× ×™×™××—×§×•.')) {
				locations = [];
				visits = [];
				receipts = [];
				saveToLocalStorage();
				
				// ×¢×“×›×•×Ÿ ×¨×§ ×”×¤×•× ×§×¦×™×•×ª ×©×§×™×™××•×ª
				loadLocationsTable();
				loadReceiptsTable(); 
				loadFilterOptions();
				
				showToast('×›×œ ×”× ×ª×•× ×™× × ×•×§×• ×‘×”×¦×œ×—×”', 'success');
				return true;
			}
			return false;
		}

		// ×©×™×¤×•×¨ ×œ×¤×•× ×§×¦×™×” ×”×§×™×™××ª
		async function createImportTable() {
			if (!await validateToken()) {
				showToast('×”×ª×—×‘×¨ ×œ×’×•×’×œ ×§×•×“×', 'warning');
				return;
			}
			
			try {
				showLoading('×™×•×¦×¨ ×˜×‘×œ×ª ×¢×–×¨ ×œ×™×™×‘×•×...');
				
				const response = await gapi.client.sheets.spreadsheets.create({
					resource: {
						properties: {
							title: `import_table_${new Date().toISOString().split('T')[0]}`
						},
						sheets: [{
							properties: { title: 'Locations' },
						}, {
							properties: { title: 'Visits' },
						}, {
							properties: { title: 'Receipts' }
						}, {
							properties: { title: 'SystemSettings' }
						}]
					}
				});
				
				const newSpreadsheetId = response.result.spreadsheetId;
				
				// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×›×œ ×’×œ×™×•×Ÿ
				await addImportHeaders(newSpreadsheetId);
				
				// ×¤×ª×™×—×ª ×”×˜×‘×œ×”
				window.open(`https://docs.google.com/spreadsheets/d/${newSpreadsheetId}/edit`, '_blank');
				
				// ×©××™×¨×ª ID ×œ×™×™×‘×•× ×××•×—×¨ ×™×•×ª×¨
				localStorage.setItem('importTableId', newSpreadsheetId);
				
				showToast('×˜×‘×œ×ª ×¢×–×¨ × ×•×¦×¨×”! ××œ× ××ª ×”× ×ª×•× ×™× ×•××– ×—×–×•×¨ ×œ×™×™×‘×', 'success');
				
			} catch (error) {
				console.error('Error creating import table:', error);
				showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×‘×œ×ª ×¢×–×¨', 'error');
			} finally {
				hideLoading();
			}
		}

		// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×˜×‘×œ×ª ×¢×–×¨
		async function addImportHeaders(spreadsheetId) {
			if (!await validateToken()) {
				showToast('×‘×¢×™×” ×‘×—×™×‘×•×¨ ×œ×’×•×’×œ ×‘××”×œ×š ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª', 'error');
				return;
			}

			try {
				// ×›×œ ×”×›×•×ª×¨×•×ª ×‘×× ×’×œ×™×ª
				const locationHeaders = [['customer_name', 'street', 'house_number', 'city', 'frequency', 'contact_person', 'base_amount']];
				const visitHeaders = [['year', 'month', 'day', 'customer', 'contact_person', 'treatment', 'date', 'work_done', 'duration', 'amount', 'paid', 'expense', 'notes']];
				const receiptHeaders = [['code_x', 'booklet', 'receipt', 'year', 'month', 'day', 'address', 'amount', 'type', 'notes', 'details']];
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				await Promise.all([
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Locations!A1:G1',
						valueInputOption: 'RAW',
						resource: { values: locationHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Visits!A1:M1',
						valueInputOption: 'RAW', 
						resource: { values: visitHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Receipts!A1:K1',
						valueInputOption: 'RAW',
						resource: { values: receiptHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'SystemSettings!A1:B1',
						valueInputOption: 'RAW',
						resource: { values: [['Setting', 'Value']] }
					})
				]);			
				
				console.log('Headers added successfully to import table');
				
			} catch (error) {
				console.error('Error adding headers:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('âš ï¸ ×”×—×™×‘×•×¨ ×¤×’ ×‘××”×œ×š ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª', 'warning');
				} else {
					showToast('âš ï¸ ×©×’×™××” ×‘×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×˜×‘×œ×”', 'error');
				}
				throw error;
			}
		}
		
		
		// ×ª×•×¡×¤×” - ×¤×™×¢× ×•×— ×›×ª×•×‘×ª ××œ××” ×œ×—×œ×§×™×
		function parseFullAddress(fullAddress) {
			if (!fullAddress) return { street: '', houseNumber: '', city: '' };
			
			const parts = fullAddress.trim().split(' ');
			
			if (parts.length >= 3) {
				// ×”×¢×™×¨ ×”×™× ×”×—×œ×§ ×”××—×¨×•×Ÿ
				const city = parts[parts.length - 1];
				
				// ××¡×¤×¨ ×”×‘×™×ª ×”×•× ×”×—×œ×§ ×”×œ×¤× ×™ ××—×¨×•×Ÿ
				const houseNumber = parts[parts.length - 2];
				
				// ×”×¨×—×•×‘ ×”×•× ×›×œ ×”×©××¨
				const street = parts.slice(0, -2).join(' ');
				
				return { street, houseNumber, city };
			} else if (parts.length === 2) {
				return { street: parts[0], houseNumber: '', city: parts[1] };
			} else {
				return { street: fullAddress, houseNumber: '', city: '' };
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×™×™×‘×•× ×œ×§×•×—×•×ª ××˜×‘×œ×ª ×¢×–×¨
		async function importCustomersFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('×˜×‘×œ×ª ×¢×–×¨ ×œ× × ××¦××” - ×¦×•×¨ ×§×•×“×', 'warning');
					return;
				}
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: importTableId,
					range: 'Locations!A2:G1000' // ×¢×“ G ×‘××§×•× H
				});
				
				const rows = response.result.values || [];
				let importedCount = 0;
				let newLocations = []; // ××¢×¨×š ×œ××™×¡×•×£ ×›×œ ×”×œ×§×•×—×•×ª ×”×—×“×©×™×
				
				for (const row of rows) {
					if (row.length > 0 && row[0]) { // ×™×© ×©× ×œ×§×•×—
						// ××™×¤×•×™ ×œ×¤×™ ×”×›×•×ª×¨×•×ª ×”×—×“×©×•×ª ×‘×× ×’×œ×™×ª:
						const customerName = row[0].trim();  // customer_name
						const street = row[1] || '';         // street  
						const houseNumber = row[2] || '';    // house_number
						const city = row[3] || '';           // city
						const frequency = row[4] || '';      // frequency
						const contactPerson = row[5] || '';  // contact_person
						const baseAmount = row[6] || '';     // base_amount
						
						// ×‘× ×™×™×ª ×›×ª×•×‘×ª ××œ××”
						const fullAddress = `${street} ${houseNumber} ${city}`.trim();
						
						// ×‘×“×•×§ ×× ×œ×§×•×— ×›×‘×¨ ×§×™×™× (×œ×¤×™ ×›×ª×•×‘×ª ××œ××”)
						const existingCustomer = locations.find(loc => 
							loc.full_address && 
							loc.full_address.toLowerCase() === fullAddress.toLowerCase()
						);
						
						if (existingCustomer) {
							console.log(`×œ×§×•×— ${fullAddress} ×›×‘×¨ ×§×™×™× - ×“×•×œ×’`);
							continue;
						}
						
						const locationData = {
							ID: generateID(),
							name: customerName,           // ×©× ×”×œ×§×•×— (×¢×›×©×™×• × ×¤×¨×“ ××”×›×ª×•×‘×ª)
							full_address: fullAddress,   // ×›×ª×•×‘×ª ××œ××” ××•×¨×›×‘×ª
							neighborhood: '',
							city: city,
							contact_person: contactPerson,
							phone: '',
							allowed_day: '×›×œ ×™×•×',
							interval_weeks: parseInt(frequency) || 4,
							temp_addition: 0,
							base_amount: parseFloat(baseAmount) || 0,
							active: "1",
							notes: '×™×•×‘× ××˜×‘×œ×ª ×œ×§×•×—×•×ª',
							last_visit: '',
							next_visit: ''
						};
						
						locations.push(locationData);
						newLocations.push(locationData); // ×”×•×¡×£ ×œ××¢×¨×š ×”×—×“×©
						importedCount++;
					}
				}
				
				// ×©××™×¨×” ××§×‘×¦×™×ª ××—×ª ×‘×¡×•×£:
				if (newLocations.length > 0) {
					showToast(`×©×•××¨ ${newLocations.length} ×œ×§×•×—×•×ª ×‘×‘×ª ××—×ª...`, 'info', 2000);
					const success = await saveLocationsBatch(newLocations);
					
					if (success) {
						showToast(`âœ… ×™×•×‘××• ${importedCount} ×œ×§×•×—×•×ª ×‘××”×™×¨×•×ª!`, 'success');
					} else {
						showToast('âš ï¸ ×‘×¢×™×” ×‘×©××™×¨×” ×œ×¢× ×Ÿ - × ×©××¨ ××§×•××™×ª ×‘×œ×‘×“', 'warning');
					}
				} else {
					showToast('×œ× × ××¦××• ×œ×§×•×—×•×ª ×—×“×©×™× ×œ×™×™×‘×•×', 'info');
				}
				
				// ×¢×“×›×•×Ÿ ×ª×¦×•×’×•×ª
				saveToLocalStorage();
				loadLocationsTable();
				loadLocationsForSelect();
				
			} catch (error) {
				console.error('Error importing customers:', error);
				showToast('×©×’×™××” ×‘×™×™×‘×•× ×œ×§×•×—×•×ª', 'error');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×™×™×‘×•× ×˜×™×¤×•×œ×™× ××˜×‘×œ×ª ×¢×–×¨
		async function importVisitsFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('×˜×‘×œ×ª ×¢×–×¨ ×œ× × ××¦××” - ×¦×•×¨ ×§×•×“×', 'warning');
					return;
				}
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: importTableId,
					range: 'Visits!A2:M1000'
				});
				
				const rows = response.result.values || [];
				let importedCount = 0;
				let notFoundCustomers = [];
				let newVisits = []; // ××¢×¨×š ×œ××™×¡×•×£ ×›×œ ×”×‘×™×§×•×¨×™× ×”×—×“×©×™×
				
				for (const row of rows) {
					if (row.length > 3 && row[3]) { // ×™×© ×œ×§×•×— ×‘×¢××•×“×” 3 (customer)
						// ××™×¤×•×™ ×œ×¤×™ ×”×›×•×ª×¨×•×ª ×”×—×“×©×•×ª ×‘×× ×’×œ×™×ª:
						const year = row[0];                    // year
						const month = row[1];                   // month
						const day = row[2];                     // day
						const customerName = row[3].trim();     // customer
						const contactPerson = row[4] || '';     // contact_person
						const treatment = row[5] || '××œ×';      // treatment
						const dateField = row[6];               // date (×œ× × ×©×ª××© - × ×‘× ×” ××”×¢××•×“×•×ª ×”×¨××©×•× ×•×ª)
						const workDone = row[7] || '';          // work_done
						const duration = row[8] || 0;           // duration
						const amount = row[9] || 0;             // amount
						const paid = row[10] || '×œ×';           // paid
						const expense = row[11] || 0;           // expense
						const notes = row[12] || '';            // notes
						
						// ××¦× ×œ×§×•×— ×§×™×™× ×œ×¤×™ ×›×ª×•×‘×ª ××œ××”
						const existingCustomer = locations.find(loc => 
							loc.full_address && 
							loc.full_address.toLowerCase().includes(customerName.toLowerCase())
						);
						
						if (!existingCustomer) {
							if (!notFoundCustomers.includes(customerName)) {
								notFoundCustomers.push(customerName);
							}
							continue;
						}
						
						// ×‘× ×™×™×ª ×ª××¨×™×š × ×›×•×Ÿ ×-3 ×¢××•×“×•×ª
						const visitDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
						
						const visitData = {
							ID: generateID(),
							date: visitDate,
							location_id: existingCustomer.ID,
							location_name: existingCustomer.name,
							visit_type: treatment,
							work_done: workDone,
							duration_minutes: parseFloat(duration) * 60 || 0, // ×©×¢×•×ª â†’ ×“×§×•×ª
							start_time: '',
							end_time: '',
							amount: parseFloat(amount) || 0,
							expense: parseFloat(expense) || 0,
							paid: paid === '×›×Ÿ' ? '×›×Ÿ' : '×œ×',
							notes: notes
						};
						
						visits.push(visitData);
						newVisits.push(visitData); // ×”×•×¡×£ ×œ××¢×¨×š ×”×—×“×©
						// ×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×œ××—×¨ ×”×•×¡×¤×ª ×‘×™×§×•×¨ ×—×“×©
						// await updateSingleLocationTreatmentDates(visitData.location_id);
						importedCount++;
					}
				}
				
				// ×©××™×¨×” ××§×‘×¦×™×ª ××—×ª ×‘×¡×•×£:
				if (newVisits.length > 0) {
					showToast(`×©×•××¨ ${newVisits.length} ×‘×™×§×•×¨×™× ×‘×‘×ª ××—×ª...`, 'info', 2000);
					const success = await saveVisitsBatch(newVisits);
					
					if (success) {
						showToast(`âœ… ×™×•×‘××• ${importedCount} ×‘×™×§×•×¨×™× ×‘××”×™×¨×•×ª!`, 'success');
					} else {
						showToast('âš ï¸ ×‘×¢×™×” ×‘×©××™×¨×” ×œ×¢× ×Ÿ - × ×©××¨ ××§×•××™×ª ×‘×œ×‘×“', 'warning');
					}
				} else {
					showToast('×œ× × ××¦××• ×‘×™×§×•×¨×™× ×—×“×©×™× ×œ×™×™×‘×•×', 'info');
				}
				
				// ×¢×“×›×•×Ÿ ×ª×¦×•×’×•×ª
				saveToLocalStorage();
				loadPlanningData();
				
				// ×”×•×“×¢×” ×¢×œ ×œ×§×•×—×•×ª ×©×œ× × ××¦××•
				let message = `×™×•×‘××• ${importedCount} ×‘×™×§×•×¨×™× ×‘×”×¦×œ×—×”!`;
				if (notFoundCustomers.length > 0) {
					message += `\nâš ï¸ ${notFoundCustomers.length} ×œ×§×•×—×•×ª ×œ× × ××¦××•: ${notFoundCustomers.slice(0, 3).join(', ')}${notFoundCustomers.length > 3 ? '...' : ''}`;
					showToast(message, 'warning', 5000);
				}
				
			} catch (error) {
				console.error('Error importing visits:', error);
				showToast('×©×’×™××” ×‘×™×™×‘×•× ×‘×™×§×•×¨×™×', 'error');
			}
		}
	   
	   
	   // ×ª×•×¡×¤×” - ×™×™×‘×•× ×§×‘×œ×•×ª ××˜×‘×œ×ª ×¢×–×¨
		async function importReceiptsFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('×˜×‘×œ×ª ×¢×–×¨ ×œ× × ××¦××” - ×¦×•×¨ ×§×•×“×', 'warning');
					return;
				}
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: importTableId,
					range: 'Receipts!A2:K1000'
				});
				
				const rows = response.result.values || [];
				let importedCount = 0;
				let notFoundCustomers = [];
				
				for (const row of rows) {
					if (row.length > 6 && row[6]) { // ×™×© ×›×ª×•×‘×ª ×‘×¢××•×“×” 6 (G)
						const customerAddress = row[6].trim(); // ×¢××•×“×” "×›×ª×•×‘×ª"
						
						// ××¦× ×œ×§×•×— ×§×™×™× ×œ×¤×™ ×›×ª×•×‘×ª ××œ××”
						const existingCustomer = locations.find(loc => 
							loc.full_address && 
							loc.full_address.toLowerCase().includes(customerAddress.toLowerCase())
						);
						
						if (!existingCustomer) {
							if (!notFoundCustomers.includes(customerAddress)) {
								notFoundCustomers.push(customerAddress);
							}
							continue;
						}
						
						// ×‘× ×™×™×ª ×ª××¨×™×š ×-3 ×¢××•×“×•×ª
						const year = row[3];   // ×©× ×” - ×¢××•×“×” D
						const month = String(row[4]).padStart(2, '0');  // ×—×•×“×© - ×¢××•×“×” E
						const day = String(row[5]).padStart(2, '0');    // ×™×•× - ×¢××•×“×” F
						const receiptDate = `${year}-${month}-${day}`;
						
						const receiptData = {
							ID: generateID(),
							book_number: row[1] || '',      // ×¤× ×§×¡ - ×¢××•×“×” B
							receipt_number: row[2] || '',   // ×§×‘×œ×” - ×¢××•×“×” C
							date: receiptDate,              // ×ª××¨×™×š × ×›×•×Ÿ
							location_id: existingCustomer.ID,
							location_name: customerAddress,
							amount: parseFloat(row[7]) || 0, // ×¡×›×•× - ×¢××•×“×” H
							payment_type: row[8] || '',     // ×¡×•×’ - ×¢××•×“×” I
							codeX: row[0] || '',           // XK - ×¢××•×“×” A
							notes: `${row[9] || ''} ${row[10] || ''}`.trim() // ×”×¢×¨×•×ª + ×¤×™×¨×•×˜
						};
						
						receipts.push(receiptData);
						importedCount++;
					}
				}
				
				// ×©××™×¨×”
				await saveAllToSheets();
				loadReceiptsTable();
				
				let message = `×™×•×‘××• ${importedCount} ×§×‘×œ×•×ª ×‘×”×¦×œ×—×”!`;
				if (notFoundCustomers.length > 0) {
					message += `\nâš ï¸ ${notFoundCustomers.length} ×œ×§×•×—×•×ª ×œ× × ××¦××•: ${notFoundCustomers.slice(0, 3).join(', ')}${notFoundCustomers.length > 3 ? '...' : ''}`;
				}
				
				showToast(message, 'success');
				
			} catch (error) {
				console.error('Error importing receipts:', error);
				showToast('×©×’×™××” ×‘×™×™×‘×•× ×§×‘×œ×•×ª', 'error');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×”××¨×ª ×¤×•×¨××˜ ×ª××¨×™×š ×-DD/MM/YYYY ×œ-YYYY-MM-DD
		function convertDateFormat(dateStr) {
			if (!dateStr) return '';
			
			const parts = dateStr.split('/');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = parts[1].padStart(2, '0');
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			
			return dateStr;
		}
	   
	   
	   // ×ª×•×¡×¤×” - ×™×™×‘×•× ××œ× ××˜×‘×œ×ª ×”×¢×–×¨
		async function importFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('×˜×‘×œ×ª ×¢×–×¨ ×œ× × ××¦××” - ×¦×•×¨ ×§×•×“×', 'warning');
					return;
				}
				
				showToast('××ª×—×™×œ ×™×™×‘×•× ××œ×...', 'info');
				
				// ×™×™×‘×•× ×‘×¡×“×¨: ×œ×§×•×—×•×ª â†’ ×˜×™×¤×•×œ×™× â†’ ×§×‘×œ×•×ª
				await importCustomersFromHelper();
				await new Promise(resolve => setTimeout(resolve, 1000)); // ×”××ª× ×” ×§×¦×¨×”
				
				await importVisitsFromHelper();
				await new Promise(resolve => setTimeout(resolve, 1000)); // ×”××ª× ×” ×§×¦×¨×”
				
				await importReceiptsFromHelper();
				
				showToast('ğŸ‰ ×™×™×‘×•× ××œ× ×”×•×©×œ× ×‘×”×¦×œ×—×”!', 'success', 5000);
				
				setTimeout(() => {
					if (confirm('×™×™×‘×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”!\n\n×”×× ×œ××—×•×§ ××ª ×˜×‘×œ×ª ×”×¢×–×¨ ××”-Google Drive?')) {
						showToast('ğŸ’¡ × ×™×ª×Ÿ ×œ××—×•×§ ××ª ×˜×‘×œ×ª ×”×¢×–×¨ ×™×“× ×™×ª ×‘×’×•×’×œ ×“×¨×™×™×‘', 'info');
						localStorage.removeItem('importTableId');
					}
				}, 2000);
				
			} catch (error) {
				console.error('Error in full import:', error);
				showToast('×©×’×™××” ×‘×™×™×‘×•× ××œ×', 'error');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×‘×“×™×§×ª ×ª×§×™× ×•×ª × ×ª×•× ×™×
		function validateReceiptData(receiptData) {
			const errors = [];
			
			if (!receiptData.location_id) {
				errors.push('×—×•×‘×” ×œ×‘×—×•×¨ ×œ×§×•×—');
			}
			
			if (!receiptData.amount || receiptData.amount <= 0) {
				errors.push('×—×•×‘×” ×œ×”×–×™×Ÿ ×¡×›×•× ×—×™×•×‘×™');
			}
			
			if (!receiptData.date) {
				errors.push('×—×•×‘×” ×œ×”×–×™×Ÿ ×ª××¨×™×š');
			}
			
			return errors;
		}

		function showValidationErrors(errors) {
			if (errors.length > 0) {
				showToast(errors.join('\n'), 'error');
				return true; // ×™×© ×©×’×™××•×ª
			}
			return false; // ××™×Ÿ ×©×’×™××•×ª
		}
	   
	   
	    // ×ª×•×¡×¤×” - × ×™×”×•×œ ×¤×× ×œ×™ ×¡×™× ×•×Ÿ ×•××™×“×¢
		function toggleFilterPanel() {
			const content = document.getElementById('filterContent');
			const icon = document.getElementById('filterIcon');
			
			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				icon.textContent = 'ğŸ”½';
			} else {
				content.classList.add('collapsed');
				icon.textContent = 'ğŸ”¼';
			}
		}

		function toggleInfoPanel() {
			const content = document.getElementById('infoContent');
			const icon = document.getElementById('infoIcon');
			
			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				icon.textContent = 'ğŸ”½';
			} else {
				content.classList.add('collapsed');
				icon.textContent = 'ğŸ”¼';
			}
		}

		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ××¤×©×¨×•×™×•×ª ×¡×™× ×•×Ÿ
		function loadFilterOptions() {
			const locationSelect = document.getElementById('filterLocation');
			locationSelect.innerHTML = '<option value="">×›×œ ×”×œ×§×•×—×•×ª</option>';
			
			locations.forEach(location => {
				const option = document.createElement('option');
				option.value = location.ID;
				option.textContent = location.name;
				locationSelect.appendChild(option);
			});
		}
	   
		// ×ª×•×¡×¤×” - ×¡×™× ×•×Ÿ ×•×˜×¢×™× ×ª ×˜×™×¤×•×œ×™×
		function applyVisitFilters() {
			const locationFilter = document.getElementById('filterLocation').value;
			const paymentFilter = document.getElementById('filterPayment').value;
			const dateFromFilter = document.getElementById('filterDateFrom').value;
			const dateToFilter = document.getElementById('filterDateTo').value;
			
			let filteredVisits = visits.filter(visit => {
				// ×¡×™× ×•×Ÿ ×œ×¤×™ ×œ×§×•×—
				if (locationFilter && visit.location_id != locationFilter) {
					return false;
				}
				
				// ×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×˜×˜×•×¡ ×ª×©×œ×•×
				if (paymentFilter && visit.paid !== paymentFilter) {
					return false;
				}
				
				// ×¡×™× ×•×Ÿ ×œ×¤×™ ×ª××¨×™×š
				if (dateFromFilter && visit.date < dateFromFilter) {
					return false;
				}
				
				if (dateToFilter && visit.date > dateToFilter) {
					return false;
				}
				
				return true;
			});
			
			displayFilteredVisits(filteredVisits);
			updateVisitsInfo(filteredVisits);
		}

		function clearVisitFilters() {
			document.getElementById('filterLocation').value = '';
			document.getElementById('filterPayment').value = '';
			document.getElementById('filterDateFrom').value = '';
			document.getElementById('filterDateTo').value = '';
			
			displayFilteredVisits(visits);
			updateVisitsInfo(visits);
		}

		// ×ª×•×¡×¤×” - ×”×¦×’×ª ×˜×™×¤×•×œ×™× ××¡×•× × ×™×
		function displayFilteredVisits(filteredVisits) {
			const tbody = document.getElementById('visitsHistoryTableBody');
			tbody.innerHTML = '';
			
			if (filteredVisits.length === 0) {
				tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">××™×Ÿ ×˜×™×¤×•×œ×™× ×ª×•×××™× ×œ×¡×™× ×•×Ÿ</td></tr>';
				return;
			}
			
			// ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š (×”×—×“×©×™× ×¨××©×•× ×™×)
			filteredVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
			
			filteredVisits.forEach(visit => {
				const location = locations.find(loc => loc.ID == visit.location_id);
				const locationName = visit.location_name || (location ? location.name : `×œ× × ××¦× (ID: ${visit.location_id})`);
				//////////console.log(`Visit location_id: ${visit.location_id}, Found location:`, location);   //////>>>>>>>>>>>>>
				
				const row = document.createElement('tr');
				
				// ×”×“×’×©×ª ×©×•×¨×•×ª ×œ×¤×™ ×¡×˜×˜×•×¡ ×ª×©×œ×•×
				if (visit.paid === '×œ×') {
					row.style.backgroundColor = '#fff2cc'; // ×¦×”×•×‘ ×¢×“×™×Ÿ ×œ×—×•×‘×•×ª
				} else if (visit.paid === '×›×Ÿ') {
					row.style.backgroundColor = '#d4edda'; // ×™×¨×•×§ ×¢×“×™×Ÿ ×œ×©×•×œ×
				}
				
				row.innerHTML = `
					<td>${formatDate(visit.date)}</td>
					<td>${locationName}</td>
					<td>${visit.visit_type}</td>
					<td>${visit.work_done}</td>
					<td>${(visit.duration_minutes / 60).toFixed(2)}</td>
					<td>
						<div style="display: flex; flex-direction: column; align-items: center;">
							<span style="font-weight: bold; color: #27ae60;">â‚ª${visit.amount}</span>
							${getVisitCostBreakdown(visit)}
						</div>
					</td>
					<td>
						<span class="payment-status payment-${visit.paid}">
							${visit.paid === '×›×Ÿ' ? 'âœ… ×©×•×œ×' : visit.paid === '×œ×' ? 'âŒ ×œ× ×©×•×œ×' : 'âšª ×œ×œ×'}
						</span>
					</td>
					<td>
						<button class="action-btn edit-btn" onclick="editVisit('${visit.ID}')">×¢×¨×•×š</button>
						<button class="action-btn delete-btn" onclick="deleteVisit('${visit.ID}')">××—×§</button>
					</td>
				`;
				tbody.appendChild(row);
			});
		}

		// ×”×•×¡×£ ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×”×¦×’×ª ×¤×™×¨×•×˜ ×¢×œ×•×™×•×ª:
		function getVisitCostBreakdown(visit) {
			if (!visit.duration_minutes) return '<span style="font-size: 11px; color: #999;">×œ×œ× ×¤×™×¨×•×˜</span>';
			
			const hours = (visit.duration_minutes / 60).toFixed(2);
			const workers = visit.num_workers || 1;
			const expense = visit.expense || 0;
			
			let breakdown = `${hours}×©`;
			if (workers > 1) breakdown += ` Ã— ${workers}×¢`;
			if (expense > 0) breakdown += ` + â‚ª${expense}`;
			
			return `<span style="font-size: 11px; color: #666;">${breakdown}</span>`;
		}

		// ×ª×•×¡×¤×” - ×¢×“×›×•×Ÿ ×¤×× ×œ ×”××™×“×¢
		function updateVisitsInfo(filteredVisits) {
			const visitsCount = filteredVisits.length;
			const totalHours = filteredVisits.reduce((sum, visit) => sum + (visit.duration_minutes / 60), 0);
			const totalIncome = filteredVisits.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			const outstandingDebt = filteredVisits
				.filter(visit => visit.paid === '×œ×')
				.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			document.getElementById('visitsCount').textContent = visitsCount;
			document.getElementById('totalHours').textContent = totalHours.toFixed(2);
			document.getElementById('totalIncome').textContent = `â‚ª${totalIncome.toLocaleString()}`;
			document.getElementById('outstandingDebt').textContent = `â‚ª${outstandingDebt.toLocaleString()}`;
			
			// ×”×“×’×©×ª ×—×•×‘×•×ª ×¤×ª×•×—×™×
			const debtElement = document.getElementById('outstandingDebt');
			if (outstandingDebt > 0) {
				debtElement.style.color = '#e74c3c';
				debtElement.style.fontWeight = 'bold';
			} else {
				debtElement.style.color = '#27ae60';
				debtElement.style.fontWeight = 'bold';
			}
			
			// ×—×™×©×•×‘ × ×ª×•× ×™× ××¤×•×¨×˜×™× ×™×•×ª×¨ ×¢×œ ×—×•×‘×•×ª
			const unpaidVisits = filteredVisits.filter(visit => visit.paid === '×œ×');
			const uniqueDebtors = new Set(unpaidVisits.map(visit => visit.location_id)).size;
			
			// ×”×¦×’×ª ××™×“×¢ × ×•×¡×£ ×‘×›×¨×˜×™×¡×™ ×”×¡×™×›×•×
			if (outstandingDebt > 0) {
				const avgDebtPerClient = uniqueDebtors > 0 ? Math.round(outstandingDebt / uniqueDebtors) : 0;
				document.getElementById('outstandingDebt').title = 
					`${uniqueDebtors} ×œ×§×•×—×•×ª ×—×™×™×‘×™× | ×××•×¦×¢ â‚ª${avgDebtPerClient} ×œ×œ×§×•×—`;
			}
	
		}



		// ×ª×•×¡×¤×” - ×˜×¢×™× ×” ×¨××©×•× ×™×ª ×©×œ ×”×˜××‘
		function loadVisitsHistory() {
			loadFilterOptions();
			displayFilteredVisits(visits);
			updateVisitsInfo(visits);
		}

		async function editVisit(visitId) {
			console.log(`âœ… editVisit ('${visitId}') `);
			const visit = visits.find(v => v.ID == visitId);
			if (!visit) {
				showToast('×‘×™×§×•×¨ ×œ× × ××¦×', 'error');
				return;
			}
			
			console.log(`âœ… editVisit second: ('${visitId}') `);
			
			// ××¦× ××ª ×”×œ×§×•×—
			const location = locations.find(loc => loc.ID == visit.location_id);
			const locationName = location ? location.name : '×œ×§×•×— ×œ× × ××¦×';
			
			// ×¦×•×¨ ×—×œ×•×Ÿ ×¢×¨×™×›×”
			const editModalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">âœï¸ ×¢×¨×™×›×ª ×‘×™×§×•×¨ - ${locationName}</h3>
					
					<form id="editVisitForm">
						<div class="form-group">
							<label>×ª××¨×™×š:</label>
							<input type="date" id="editVisitDate" value="${visit.date}" required>
						</div>
						
						<div class="form-group">
							<label>×¡×•×’ ×˜×™×¤×•×œ:</label>
							<select id="editVisitType">
								<option value="××œ×" ${visit.visit_type === '××œ×' ? 'selected' : ''}>××œ×</option>
								<option value="×—×œ×§×™" ${visit.visit_type === '×—×œ×§×™' ? 'selected' : ''}>×—×œ×§×™</option>
								<option value="×‘×™×§×•×¨×ª" ${visit.visit_type === '×‘×™×§×•×¨×ª' ? 'selected' : ''}>×‘×™×§×•×¨×ª</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>×¢×‘×•×“×” ×©×‘×•×¦×¢×”:</label>
							<textarea id="editWorkDone" rows="3">${visit.work_done || ''}</textarea>
						</div>
						
						<div class="form-group">
							<label>××©×š ×–××Ÿ (×“×§×•×ª):</label>
							<input type="number" id="editDuration" value="${visit.duration_minutes || 0}">
						</div>
						
						<div class="form-group">
							<label>×©×¢×ª ×”×ª×—×œ×”:</label>
							<input type="time" id="editStartTime" value="${visit.start_time || ''}">
						</div>
						
						<div class="form-group">
							<label>×¡×›×•× (â‚ª):</label>
							<input type="number" step="0.01" id="editAmount" value="${visit.amount || 0}">
						</div>
						
						<div class="form-group">
							<label>×”×•×¦××•×ª (â‚ª):</label>
							<input type="number" step="0.01" id="editExpense" value="${visit.expense || 0}">
						</div>
						
						<div class="form-group">
							<label>×¡×˜×˜×•×¡ ×ª×©×œ×•×:</label>
							<select id="editPaid">
								<option value="×œ×" ${visit.paid === '×œ×' ? 'selected' : ''}>×œ× ×©×•×œ×</option>
								<option value="×›×Ÿ" ${visit.paid === '×›×Ÿ' ? 'selected' : ''}>×©×•×œ×</option>
								<option value="×œ×œ× ×ª×©×œ×•×" ${visit.paid === '×œ×œ× ×ª×©×œ×•×' ? 'selected' : ''}>×œ×œ× ×ª×©×œ×•×</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>×”×¢×¨×•×ª:</label>
							<textarea id="editNotes" rows="3">${visit.notes || ''}</textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="button" onclick="saveEditedVisit('${visitId}')" class="btn btn-success">
								ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×
							</button>
							<button type="button" onclick="closeEditModal()" class="btn btn-secondary">
								âŒ ×‘×™×˜×•×œ
							</button>
						</div>
					</form>
				</div>
			`;
			
			// ×”×¦×’ ××ª ×”××•×“×œ
			showEditModal(editModalHTML);
		}

		function showEditModal(content) {
			// ×”×¡×¨ ××•×“×œ ×§×™×™× ×× ×™×©
			const existingModal = document.getElementById('editModal');
			if (existingModal) {
				existingModal.remove();
			}
			
			// ×¦×•×¨ ××•×“×œ ×—×“×©
			const modal = document.createElement('div');
			modal.id = 'editModal';
			modal.style.cssText = `
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.5);
				display: flex;
				justify-content: center;
				align-items: center;
				z-index: 1000;
			`;
			
			modal.innerHTML = content;
			document.body.appendChild(modal);
			
			// ×¡×’×™×¨×” ×‘×œ×—×™×¦×” ×¢×œ ×”×¨×§×¢
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					closeEditModal();
				}
			});
		}

		function closeEditModal() {
			const modal = document.getElementById('editModal');
			if (modal) {
				modal.remove();
			}
		}

		
		// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×”×‘×™×§×•×¨ ×‘×¢× ×Ÿ
		async function updateVisitInCloud(updatedVisit) {
			if (!await validateToken()) return;
			
			try {
				// ×§×¨×™××ª ×›×œ ×”× ×ª×•× ×™× ××”×¢× ×Ÿ
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Visits!A:N'
				});
				
				const rows = response.result.values || [];
				
				// ××¦×™××ª ×”×©×•×¨×” ×œ×¢×“×›×•×Ÿ
				let rowToUpdate = -1;
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] == updatedVisit.ID) {
						rowToUpdate = i + 1; // +1 ×›×™ Google Sheets ××ª×—×™×œ ×-1
						break;
					}
				}
				
				if (rowToUpdate > 0) {
					// ×¢×“×›×•×Ÿ ×”×©×•×¨×”
					const updatedRow = [
						updatedVisit.ID,
						updatedVisit.date,
						updatedVisit.location_id,
						updatedVisit.location_name || '',
						updatedVisit.visit_type,
						updatedVisit.work_done,
						updatedVisit.duration_minutes,
						updatedVisit.num_workers || 1,
						updatedVisit.start_time,
						updatedVisit.end_time || '',
						updatedVisit.amount,
						updatedVisit.expense,
						updatedVisit.paid,
						updatedVisit.notes
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Visits!A${rowToUpdate}:N${rowToUpdate}`,
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [updatedRow]
						}
					});
					
					console.log(`âœ… Updated visit ${updatedVisit.ID} in cloud`);
				}
				
			} catch (error) {
				console.error('Error updating visit in cloud:', error);
				throw error;
			}
		}

		function deleteVisit(visitId) {
			console.log(`âœ… deleteVisit ('${visitId}') `);
			if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×˜×™×¤×•×œ?')) {
				visits = visits.filter(visit => visit.ID != visitId);
				applyVisitFilters(); // ×¨×¢× ×Ÿ ×ª×¦×•×’×”
				saveToLocalStorage();
				showToast('×˜×™×¤×•×œ × ××—×§ ×‘×”×¦×œ×—×”!', 'success');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×‘×“×™×§×ª ×¨×©××•×ª
		async function checkPermissions() {
			if (!access_token) {
				showToast('×œ× ××—×•×‘×¨ ×œ×’×•×’×œ - ×”×ª×—×‘×¨ ×§×•×“×', 'warning');
				return false;
			}
			
			try {
				// × ×¡×” ×œ×’×©×ª ×œ×˜×‘×œ×” ×”×¨××©×™×ª
				await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				return true;
			} catch (error) {
				if (error.status === 401) {
					showToast('×”×—×™×‘×•×¨ ×¤×’ - ×”×ª×—×‘×¨ ××—×“×©', 'warning');
					access_token = null;
				} else if (error.status === 403) {
					showToast('××™×Ÿ ×”×¨×©××” ×œ×˜×‘×œ×” - ×‘×“×•×§ ×©×™×ª×•×£', 'error');
				}
				return false;
			}
		}
	   
	   
	   // ×ª×•×¡×¤×” - ×‘×“×™×§×” ×ª×§×•×¤×ª×™×ª ×©×œ ×—×™×‘×•×¨
		setInterval(async () => {
			if (access_token) {
				const isValid = await validateToken();
				if (!isValid) {
					console.log('Token expired - disconnected');
				}
			}
		}, 300000); // ×‘×“×™×§×” ×›×œ 5 ×“×§×•×ª
	   
	   // ×ª×•×¡×¤×” - ×—×™×©×•×‘ ×©×¢×•×ª ××“×§×•×ª
		function updateHoursDisplay() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const hours = (minutes / 60).toFixed(2);
			document.getElementById('calculatedHours').value = hours > 0 ? hours : '';
		}
	   
	    // ×—×™×©×•×‘ ×¢×œ×•×ª ×˜×™×¤×•×œ ××¢×•×“×›×Ÿ
		function calculateTreatmentCost() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const workers = parseInt(document.getElementById('numberOfWorkersVisit').value) || 1;
			const expense = parseFloat(document.getElementById('expense').value) || 0;
			
			if (minutes > 0) {
				const hours = minutes / 60;
				const baseCost = costSettings.hourlyRate * hours;
				// ×ª×™×§×•×Ÿ: ×¢×œ×•×ª ×¢×•×‘×“×™× × ×•×¡×¤×™× (×œ× ×›×•×œ×œ ××•×ª×š)
				const workersCost = (workers - 1) * costSettings.workerCost * hours;
				const laborCost = baseCost + workersCost;
				const totalCost = laborCost + expense;
				
				// ×¢×“×›×Ÿ ××ª ×©×“×” ×”×¡×›×•×
				document.getElementById('amount').value = Math.round(totalCost);
				
				// ×”×¦×’ ×¤×™×¨×•×˜ ××¤×•×¨×˜ ×™×•×ª×¨
				let breakdown = `${hours.toFixed(2)} ×©×¢×•×ª Ã— â‚ª${costSettings.hourlyRate} = â‚ª${Math.round(baseCost)}`;
				
				if (workers > 1) {
					breakdown += `\n+ ${workers - 1} ×¢×•×‘×“×™× Ã— â‚ª${costSettings.workerCost}/×©×¢×” = â‚ª${Math.round(workersCost)}`;
				}
				
				if (expense > 0) {
					breakdown += `\n+ ×”×•×¦××•×ª: â‚ª${expense}`;
				}
				
				breakdown += `\n= ×¡×”"×›: â‚ª${Math.round(totalCost)}`;
				
				document.getElementById('costBreakdown').textContent = breakdown;
				document.getElementById('costBreakdown').style.whiteSpace = 'pre-line';
			} else {
				document.getElementById('costBreakdown').textContent = '';
			}
		}

		// ×”×•×¡×£ ×—×™×©×•×‘ ××•×˜×•××˜×™ ×›×©××§×œ×™×“×™× ××©×š ×–××Ÿ
		function updateHoursDisplay() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const hours = minutes > 0 ? (minutes / 60).toFixed(2) : '';
			document.getElementById('calculatedHours').value = hours;
			
			// ×—×©×‘ ×¢×œ×•×™×•×ª ××•×˜×•××˜×™×ª
			calculateTreatmentCost();
		}

		// ×©××™×¨×ª ×”×’×“×¨×•×ª ×¢×œ×•×ª ×¤×©×•×˜×” ×™×•×ª×¨
		function saveCostSettings() {
			costSettings.hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 150;
			costSettings.workerCost = parseFloat(document.getElementById('workerCost').value) || 50;
			
			localStorage.setItem('cost_settings', JSON.stringify(costSettings));
			
			if (access_token) {
				saveSettingsToCloud().then(success => {
					if (success) {
						showToast('×”×’×“×¨×•×ª ×¢×œ×•×ª × ×©××¨×• ×‘×¢× ×Ÿ', 'success');
					} else {
						showToast('×”×’×“×¨×•×ª × ×©××¨×• ××§×•××™×ª ×‘×œ×‘×“', 'warning');
					}
				});
			} else {
				showToast('×”×’×“×¨×•×ª × ×©××¨×• ××§×•××™×ª', 'success');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×‘×“×™×§×ª ×˜×™×¤×•×œ ×›×¤×•×œ
		function checkDuplicateVisit(locationId, visitDate) {
			const existingVisit = visits.find(visit => 
				visit.location_id == locationId && 
				visit.date === visitDate
			);
			
			return existingVisit;
		}
	   
	   // ×ª×•×¡×¤×” - ××ª×—×•×œ ×ª××¨×™×š ×•×©×¢×” × ×•×›×—×™×™×
		function initializeVisitForm() {
			const now = new Date();
			document.getElementById('visitDate').value = now.toISOString().split('T')[0];
			document.getElementById('visitTime').value = now.toTimeString().split(':').slice(0,2).join(':');
		}

		// ×§×¨×™××” ×œ××ª×—×•×œ ×›×©×”×“×£ × ×˜×¢×Ÿ
		document.addEventListener('DOMContentLoaded', function() {
			initializeVisitForm();
		});
	   
	   // ×¤×•× ×§×¦×™×” ×œ×©××™×¨×ª ×”×’×“×¨×•×ª ×œ×¢× ×Ÿ
		async function saveSettingsToCloud() {
			if (!await validateToken()) {
				return false;
			}
			
			try {
				const settingsData = [
					['Setting', 'Value'],
					['hourly_rate', costSettings.hourlyRate],
					['worker_cost', costSettings.workerCost],
					['last_updated', new Date().toISOString()]
				];
				
				await gapi.client.sheets.spreadsheets.values.clear({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A:B`
				});
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A1:B4`,
					valueInputOption: 'RAW',
					resource: { values: settingsData }
				});
				
				return true;
			} catch (error) {
				console.error('Error saving settings:', error);
				return false;
			}
		}

		// ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ×”×’×“×¨×•×ª ××”×¢× ×Ÿ
		async function loadSettingsFromCloud() {
			if (!await validateToken()) {
				return false;
			}
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A:B`
				});
				
				const rows = response.result.values || [];
				if (rows.length > 1) {
					rows.slice(1).forEach(row => {
						const [setting, value] = row;
						if (setting === 'hourly_rate') {
							costSettings.hourlyRate = parseFloat(value) || 150;
						}
						if (setting === 'worker_cost') {
							costSettings.workerCost = parseFloat(value) || 50;
						}
					});
					
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
					
					return true;
				}
			} catch (error) {
				console.error('Error loading settings:', error);
				return false;
			}
			
			return false;
		}
	   
	   // ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×‘×“×™×§×” ×•×™×¦×™×¨×ª ×”×˜×‘×œ×” ×”×¨××©×™×ª
		async function findOrCreateMainSpreadsheet() {
			try {
				console.log('Searching for existing main spreadsheet...');
				
				// ×—×™×¤×•×© ×˜×‘×œ×” ×§×™×™××ª
				const response = await gapi.client.request({
					path: 'https://www.googleapis.com/drive/v3/files',
					params: {
						q: `name='${SPREADSHEET_NAME}' and mimeType='application/vnd.google-apps.spreadsheet'`,
					}
				});
				
				if (response.result.files.length > 0) {
					console.log('Found existing spreadsheet');
					SPREADSHEET_ID = response.result.files[0].id;
					showToast('× ××¦××” ×˜×‘×œ×” ×§×™×™××ª!', 'success');
					
					// ×‘×“×™×§×” ×•×ª×™×§×•×Ÿ ×©×œ ××‘× ×” ×”×˜×‘×œ×”
					await checkAndFixTableStructure();
				} else {
					console.log('No spreadsheet found, creating new one...');
					await createNewMainSpreadsheet();
				}
				
			} catch (error) {
				console.error('Error in findOrCreateMainSpreadsheet:', error);
				showToast('×©×’×™××” ×‘×—×™×¤×•×© ×˜×‘×œ×”', 'error');
			}
		}

		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×™×¦×™×¨×ª ×˜×‘×œ×” ×¨××©×™×ª ×—×“×©×”
		async function createNewMainSpreadsheet() {
			console.log('Creating new main spreadsheet...');
			try {
				const response = await gapi.client.request({
					path: 'https://sheets.googleapis.com/v4/spreadsheets',
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${access_token}`,
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						properties: {
							title: SPREADSHEET_NAME
						},
						sheets: [
							{ properties: { title: 'Locations' } },
							{ properties: { title: 'Visits' } },
							{ properties: { title: 'Receipts' } },
							{ properties: { title: 'SystemSettings' } }
						]
					})
				});
				
				SPREADSHEET_ID = response.result.spreadsheetId;
				
				// ×”×•×¡×£ ×›×•×ª×¨×•×ª ×œ×›×œ ×”×’×™×œ×™×•× ×•×ª
				await addAllHeaders();
				
				showToast('× ×•×¦×¨×” ×˜×‘×œ×” ×—×“×©×”!', 'success');
				
			} catch (error) {
				console.error('Error creating spreadsheet:', error);
				showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×‘×œ×”', 'error');
			}
		}
		
		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×‘×“×™×§×” ×•×ª×™×§×•×Ÿ ××‘× ×” ×”×˜×‘×œ×”
		async function checkAndFixTableStructure() {
			console.log('Checking and fixing table structure...');
			
			try {
				// ×‘×“×™×§×ª ×›×•×ª×¨×•×ª ×‘×›×œ ×’×™×œ×™×•×Ÿ
				const sheetsToCheck = ['Locations', 'Visits', 'Receipts'];
				
				for (const sheetName of sheetsToCheck) {
					try {
						const response = await gapi.client.sheets.spreadsheets.values.get({
							spreadsheetId: SPREADSHEET_ID,
							range: `${sheetName}!A1:A1`
						});
						
						if (!response.result.values || !response.result.values[0][0]) {
							console.log(`Headers missing in ${sheetName}, adding them...`);
							await addHeadersToSheet(sheetName);
						}
					} catch (error) {
						console.log(`Sheet ${sheetName} missing or error, will add headers:`, error);
						await addHeadersToSheet(sheetName);
					}
				}
				
				console.log('âœ… Table structure verified');
				
			} catch (error) {
				console.log('Headers check failed, will force add them:', error);
				await addAllHeaders();
			}
		}
		
		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×’×™×œ×™×•×Ÿ ×¡×¤×¦×™×¤×™
		async function addHeadersToSheet(sheetName) {
			try {
				let headers = [];
				
				switch (sheetName) {
					case 'Locations':
						headers = [
							'ID', 'name', 'full_address', 'neighborhood', 'city', 
							'contact_person', 'phone', 'allowed_day', 'interval_weeks', 
							'temp_addition', 'base_amount', 'active', 'notes', 
							'last_visit', 'next_visit'
						];
						break;
					case 'Visits':
						headers = [
							'ID', 'date', 'location_id', 'location_name', 'visit_type', 'work_done', 
							'duration_minutes', 'num_workers', 'start_time', 'end_time', 
							'amount', 'expense', 'paid', 'notes'
						];
						break;
					case 'Receipts':
						headers = [
							'ID', 'book_number', 'receipt_number', 'date', 'location_id', 
							'location_name', 'amount', 'payment_type', 'notes'
						];
						break;
				}
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `${sheetName}!A1:${String.fromCharCode(64 + headers.length)}1`,
					valueInputOption: 'RAW',
					values: [headers]
				});
				
				console.log(`âœ… Added headers to ${sheetName}`);
				
			} catch (error) {
				console.error(`Error adding headers to ${sheetName}:`, error);
			}
		}
		
		// ×¤×•× ×§×¦×™×” ××©×•×¤×¨×ª ×œ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×›×œ ×”×’×™×œ×™×•× ×•×ª
		async function addAllHeaders() {
			try {
				console.log('Adding headers to all sheets...');
				
				await addHeadersToSheet('Locations');
				await addHeadersToSheet('Visits');
				await addHeadersToSheet('Receipts');
				
				// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ-SystemSettings
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'SystemSettings!A1:B1',
					valueInputOption: 'RAW',
					values: [['setting_key', 'setting_value']]
				});
				
				console.log('âœ… All headers added successfully');
				
			} catch (error) {
				console.error('Error adding all headers:', error);
			}
		}  
	   
	   async function importFromHelperTable() {
			if (!await validateToken()) {
				showToast('×”×ª×—×‘×¨ ×œ×’×•×’×œ ×§×•×“×', 'warning');
				return;
			}
			
			const importTableId = localStorage.getItem('importTableId');
			if (!importTableId) {
				showToast('×œ× × ××¦× ID ×©×œ ×˜×‘×œ×ª ×”×¢×–×¨', 'warning');
				return;
			}
			
			console.log('ğŸ” Import Table ID:', importTableId); // ×œ×•×’ ×—×“×©
			
			try {
				showLoading('××™×™×‘× × ×ª×•× ×™× ××˜×‘×œ×ª ×”×¢×–×¨...');
				
				let importedCount = 0;
				
				// ×™×™×‘×•× ××™×§×•××™×
				try {
					console.log('ğŸ“ Starting locations import...'); // ×œ×•×’ ×—×“×©
					
					const locationsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Locations!A2:O1000'
					});
					
					console.log('ğŸ“ Locations response:', locationsResponse.result); // ×œ×•×’ ×—×“×©
					
					if (locationsResponse.result.values && locationsResponse.result.values.length > 0) {
						console.log('ğŸ“ Found', locationsResponse.result.values.length, 'location rows'); // ×œ×•×’ ×—×“×©
						
						for (const row of locationsResponse.result.values) {
							if (row[0] && row[1]) {
								const locationData = parseLocationFromRow(row);
								locations.push(locationData);
								importedCount++;
								
								await new Promise(resolve => setTimeout(resolve, 200));
							}
						}
						showToast(`×™×•×‘××• ${importedCount} ××™×§×•××™×`, 'success');
					} else {
						console.log('ğŸ“ No locations data found'); // ×œ×•×’ ×—×“×©
					}
				} catch (error) {
					console.error('ğŸ“ Locations import error:', error); // ×œ×•×’ ×—×“×©
				}
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				// ×™×™×‘×•× ×‘×™×§×•×¨×™×
				try {
					console.log('ğŸ”§ Starting visits import...');
					
					const visitsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Visits!A2:M1000'
					});
					
					console.log('ğŸ”§ Visits response:', visitsResponse.result);
					
					let visitsCount = 0;
					if (visitsResponse.result.values && visitsResponse.result.values.length > 0) {
						console.log('ğŸ”§ Found', visitsResponse.result.values.length, 'visit rows');
						
						for (let i = 0; i < visitsResponse.result.values.length; i++) {
							const row = visitsResponse.result.values[i];
							if (row[0] && row[1]) {
								const visitData = parseVisitFromRow(row);
								if (!isDuplicateVisit(visitData)) {
									visits.push(visitData);
									// ×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×œ××—×¨ ×”×•×¡×¤×ª ×‘×™×§×•×¨ ×—×“×©
									//await updateSingleLocationTreatmentDates(visitData.location_id);
									visitsCount++;
								} else {
									console.log('âš ï¸ Duplicate visit skipped:', visitData.date, visitData.location_id);
								}
								visitsCount++;
								
								// ×”×¦×’ ×”×ª×§×“××•×ª ×›×œ 50 ×¨×©×•××•×ª
								if (visitsCount % 50 === 0) {
									console.log(`ğŸ”§ Processed ${visitsCount}/${visitsResponse.result.values.length} visits`);
									showToast(`××¢×‘×“ ×‘×™×§×•×¨ ${visitsCount}...`, 'info', 1000);
								}
								
								await new Promise(resolve => setTimeout(resolve, 100)); // ×”××ª× ×” ×§×¦×¨×” ×™×•×ª×¨
							}
						}
						showToast(`×™×•×‘××• ${visitsCount} ×‘×™×§×•×¨×™×`, 'success');
					} else {
						console.log('ğŸ”§ No visits data found');
					}
				} catch (error) {
					console.error('ğŸ”§ Visits import error:', error);
				}
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				// ×™×™×‘×•× ×§×‘×œ×•×ª
				try {
					console.log('ğŸ§¾ Starting receipts import...');
					
					const receiptsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Receipts!A2:J1000'
					});
					
					console.log('ğŸ§¾ Receipts response:', receiptsResponse.result);
					
					let receiptsCount = 0;
					if (receiptsResponse.result.values && receiptsResponse.result.values.length > 0) {
						console.log('ğŸ§¾ Found', receiptsResponse.result.values.length, 'receipt rows');
						
						for (let i = 0; i < receiptsResponse.result.values.length; i++) {
							const row = receiptsResponse.result.values[i];
							if (row[0] && row[3]) { // ID ×•×ª××¨×™×š
								const receiptData = parseReceiptFromRow(row);
								
								
								if (!isDuplicateReceipt(receiptData)) {
									receipts.push(receiptData);
									receiptsCount++;
								} else {
									console.log('âš ï¸ Duplicate receipt skipped:', receiptData.date, receiptData.location_id);
								}
								
								// ×”×¦×’ ×”×ª×§×“××•×ª ×›×œ 25 ×¨×©×•××•×ª (×§×‘×œ×•×ª ×‘×“×¨×š ×›×œ×œ ×¤×—×•×ª)
								if (receiptsCount % 25 === 0) {
									console.log(`ğŸ§¾ Processed ${receiptsCount}/${receiptsResponse.result.values.length} receipts`);
									showToast(`××¢×‘×“ ×§×‘×œ×” ${receiptsCount}...`, 'info', 1000);
								}
								
								await new Promise(resolve => setTimeout(resolve, 100)); // ×”××ª× ×” ×§×¦×¨×” ×™×•×ª×¨
							}
						}
						showToast(`×™×•×‘××• ${receiptsCount} ×§×‘×œ×•×ª`, 'success');
					} else {
						console.log('ğŸ§¾ No receipts data found');
					}
				} catch (error) {
					console.error('ğŸ§¾ Receipts import error:', error);
				}
				
				// ×©××™×¨×” ××§×•××™×ª ×•×¢×“×›×•×Ÿ ×ª×¦×•×’×”
				saveToLocalStorage();
				loadLocationsTable();
				loadReceiptsTable();
				loadFilterOptions();

				// ×‘×“×™×§×” ×©×”× ×ª×•× ×™× × ×˜×¢× ×• × ×›×•×Ÿ
				console.log('ğŸ” ×‘×“×™×§×ª ×™×™×‘×•×:');
				console.log(`×œ×§×•×—×•×ª: ${locations.length}`);
				console.log(`×‘×™×§×•×¨×™×: ${visits.length}`);
				console.log(`×§×‘×œ×•×ª: ${receipts.length}`);

				// ×”×¦×’ ×“×•×’××” ×©×œ ×”×¨×©×•××” ×”×¨××©×•× ×” ××›×œ ×¡×•×’
				if (locations.length > 0) {
					console.log('×“×•×’××” ×œ×§×•×—:', locations[0]);
				}
				if (visits.length > 0) {
					console.log('×“×•×’××” ×‘×™×§×•×¨:', visits[0]);
				}


				// ×ª×•×¡×¤×” ×—×©×•×‘×” - ×©××™×¨×” ×œ×¢× ×Ÿ!
				showToast('×©×•××¨ × ×ª×•× ×™× ×—×“×©×™× ×œ×¢× ×Ÿ...', 'info');

				try {
					/// await saveAllToSheets();
					/// await saveAllToSheetsOptimized();
					
					// ×©××™×¨×” ××”×™×¨×” ×œ×¤×™ ×¡×•×’ × ×ª×•× ×™×
					const locationSuccess = await saveLocationsBatch(newLocations || []);
					const visitSuccess = await saveVisitsBatch(newVisits || []);  
					const receiptSuccess = await saveReceiptsBatch(newReceipts || []);

					if (locationSuccess && visitSuccess && receiptSuccess) {
						showToast('ğŸš€ ×©××™×¨×” ××”×™×¨×” ×”×•×©×œ××” ×‘×”×¦×œ×—×”!', 'success');
					} else {
						showToast('âš ï¸ ×—×œ×§ ××”× ×ª×•× ×™× ×œ× × ×©××¨×• ×œ×¢× ×Ÿ', 'warning');
					}

					showToast(`ğŸ‰ ×™×™×‘×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”!
					ğŸ“ ${locationsCount || 0} ××™×§×•××™×
					ğŸ”§ ${visitsCount || 0} ×‘×™×§×•×¨×™×  
					ğŸ§¾ ${receiptsCount || 0} ×§×‘×œ×•×ª
					âœ… ×”×›×œ × ×©××¨ ×œ×¢× ×Ÿ!`, 'success', 6000);
				} catch (error) {
					console.error('Error saving imported data to cloud:', error);
					showToast('×™×™×‘×•× ×”×•×©×œ× ××§×•××™×ª, ××‘×œ ×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ', 'warning');
				}
				
			} catch (error) {
				console.error('Import error:', error);
				showToast('×©×’×™××” ×‘×™×™×‘×•× × ×ª×•× ×™×', 'error');
			} finally {
				hideLoading();
			}
		}

		// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×¤×¨×¡×•×¨ ×©×•×¨×•×ª
		function parseVisitFromRow(row) {
			return {
				ID: row[0] || generateID(),
				date: row[1] || '',
				location_id: row[2] || '',
				visit_type: row[3] || '',
				work_done: row[4] || '',
				duration_minutes: parseInt(row[5]) || 0,
				num_workers: parseInt(row[6]) || 1,
				start_time: row[7] || '',
				end_time: row[8] || '',
				amount: parseFloat(row[9]) || 0,
				expense: parseFloat(row[10]) || 0,
				paid: row[11] || '×œ×',
				notes: row[12] || ''
			};
		}

		function parseReceiptFromRow(row) {
			return {
				ID: row[0] || generateID(),
				booklet_number: row[1] || '',
				receipt_number: row[2] || '',
				date: row[3] || '',
				location_id: row[4] || '',
				location_name: row[5] || '',
				amount: parseFloat(row[6]) || 0,
				payment_type: row[7] || '',
				tax_code: row[8] || '',
				notes: row[9] || ''
			};
		}
	   
	   // ×”×•×¡×£ ××ª ×–×” ×œ×¡×•×£ ×”×§×•×“
		function updateImportTableStatus() {
			const importTableId = localStorage.getItem('importTableId');
			const statusDiv = document.getElementById('importTableStatus');
			
			if (importTableId && statusDiv) {
				statusDiv.innerHTML = `
					<span style="font-size: 13px; color: #28a745;">
						âœ… ×˜×‘×œ×ª ×¢×–×¨ ×–××™× ×”: 
						<a href="https://docs.google.com/spreadsheets/d/${importTableId}/edit" 
						   target="_blank" style="color: #007bff; text-decoration: underline;">
						   ×¤×ª×— ×˜×‘×œ×”
						</a>
					</span>
					<br>
					<button onclick="localStorage.removeItem('importTableId'); updateImportTableStatus();" 
							style="background: none; border: none; color: #dc3545; font-size: 12px; cursor: pointer; margin-top: 5px;">
						ğŸ—‘ï¸ ××—×§ ×§×™×©×•×¨ ×œ×˜×‘×œ×ª ×¢×–×¨
					</button>
				`;
			} else if (statusDiv) {
				statusDiv.innerHTML = `
					<span style="font-size: 13px; color: #666;">
						âŒ ×œ× × ××¦××” ×˜×‘×œ×ª ×¢×–×¨ ×©××•×¨×”
					</span>
					<br>
					<span style="font-size: 12px; color: #999;">
						×¦×•×¨ ×˜×‘×œ×ª ×¢×–×¨ ×—×“×©×” ×›×“×™ ×œ×™×™×‘× × ×ª×•× ×™×
					</span>
				`;
			}
		}

		// ×”×¨×¥ ××ª ×–×” ×›×©×”×“×£ × ×˜×¢×Ÿ
		document.addEventListener('DOMContentLoaded', function() {
			updateImportTableStatus();
		});

		// ×”×¨×¥ ×’× ×›×©×¢×•×‘×¨×™× ×œ×˜××‘ ×”××¢×¨×›×ª
		function showTab(event, tabName) {
			// ×”×§×•×“ ×”×§×™×™× ×©×œ×š...
			
			// ×”×•×¡×£ ××ª ×–×” ×‘×¡×•×£ ×”×¤×•× ×§×¦×™×”
			if (tabName === 'system') {
				setTimeout(updateImportTableStatus, 100);
			}
		}
	   
	   
	   // ×™×™×‘×•× ××˜×§×¡×˜ ×˜×œ×’×¨× - ×¤×•× ×§×¦×™×” ×¨××©×™×ª
		async function importFromTelegram() {
			// ×™×¦×™×¨×ª input ×§×•×‘×¥ ×¢× ×ª××™×›×” ×‘×§×‘×¦×™× ××¨×•×‘×™×
			const fileInput = document.createElement('input');
			fileInput.type = 'file';
			fileInput.accept = '.txt';
			fileInput.multiple = true; // ×ª××™×›×” ×‘×§×‘×¦×™× ××¨×•×‘×™×!
			
			fileInput.onchange = async (event) => {
				const files = Array.from(event.target.files);
				if (files.length === 0) return;
				
				try {
					showLoading(`××¤×¨×¡×¨ ${files.length} ×§×‘×¦×™ ×˜×œ×’×¨×...`);
					
					let allParsedVisits = [];
					
					// ×¢×‘×•×¨ ×¢×œ ×›×œ ×”×§×‘×¦×™×
					for (let i = 0; i < files.length; i++) {
						const file = files[i];
						console.log(`ğŸ“„ Processing file ${i+1}/${files.length}: ${file.name}`);
						
						const text = await file.text();
						const parsedVisits = parseTelegramText(text);
						
						console.log(`ğŸ“„ File ${file.name}: found ${parsedVisits.length} visits`);
						allParsedVisits = allParsedVisits.concat(parsedVisits);
						
						// ×”××ª× ×” ×§×¦×¨×” ×‘×™×Ÿ ×§×‘×¦×™×
						if (i < files.length - 1) {
							await new Promise(resolve => setTimeout(resolve, 300));
						}
					}
					
					if (allParsedVisits.length > 0) {
						showToast(`× ××¦××• ${allParsedVisits.length} ×‘×™×§×•×¨×™× ×-${files.length} ×§×‘×¦×™×`, 'success');
						
						// ×¤×ª×¨×•×Ÿ ×¤×©×•×˜ - ××™×©×•×¨ ×™×©×™×¨
						if (confirm(`× ××¦××• ${allParsedVisits.length} ×‘×™×§×•×¨×™× ××˜×œ×’×¨×.\n\n×”×× ×œ×™×™×‘× ××•×ª× ×œ××¢×¨×›×ª?`)) {
							window.pendingTelegramVisits = allParsedVisits;
							await confirmTelegramImport();
						} else {
							showToast('×™×™×‘×•× ×‘×•×˜×œ', 'info');
						}
					} else {
						showToast('×œ× × ××¦××• ×‘×™×§×•×¨×™× ×‘×§×‘×¦×™×', 'warning');
					}
					
				} catch (error) {
					console.error('Error parsing telegram files:', error);
					showToast('×©×’×™××” ×‘×¤×¨×¡×•×¨ ×§×‘×¦×™ ×˜×œ×’×¨×', 'error');
				} finally {
					hideLoading();
				}
			};
			
			fileInput.click();
		}

		// ×¤×•× ×§×¦×™×” ×¨××©×™×ª ×œ×¤×¨×¡×•×¨ ×”×˜×§×¡×˜
		function parseTelegramText(text) {
			const lines = text.split('\n');
			const visits = [];
			
			let currentDate = '';
			let currentTime = '';
			let currentAddress = '';
			let currentClient = null;
			let workDone = '';
			let duration = 0;
			
			console.log('ğŸ” Parsing', lines.length, 'lines...');
			
			for (let i = 0; i < lines.length; i++) {
				const line = lines[i].trim();
				if (!line) continue;
				
				// ×–×™×”×•×™ ×ª××¨×™×š
				if (isDateLine(line)) {
					currentDate = parseTelegramDate(line);
					console.log('ğŸ“… Found date:', currentDate);
					continue;
				}
				
				// ×–×™×”×•×™ ×©×¢×”
				if (isTimeLine(line)) {
					currentTime = line;
					console.log('ğŸ• Found time:', currentTime);
					continue;
				}
				
				// ×–×™×”×•×™ ×›×ª×•×‘×ª ×œ×§×•×—
				const foundClient = findClientInText(line);
				if (foundClient) {
					currentClient = foundClient;
					currentAddress = foundClient.full_address;
					console.log('ğŸ‘¤ Found client:', foundClient.name, 'at', currentAddress);
					continue;
				}
				
				// ×–×™×”×•×™ ×¡×™×•× ×¢×‘×•×“×”
				if (line.startsWith('×¡×™×•×')) {
					workDone = line.replace('×¡×™×•×', '').trim();
					console.log('ğŸ”§ Found work:', workDone);
					
					// ×—×¤×© ×–××Ÿ ×‘×©×•×¨×•×ª ×”×‘××•×ª
					for (let j = i + 1; j < Math.min(i + 5, lines.length); j++) {
						const nextLine = lines[j].trim();
						const foundDuration = parseWorkDuration(nextLine);
						if (foundDuration > 0) {
							duration = foundDuration;
							console.log('â±ï¸ Found duration:', duration, 'minutes');
							break;
						}
					}
					
					// ×¦×•×¨ ×‘×™×§×•×¨ ×× ×™×© ××¡×¤×™×§ ××™×“×¢
					if (currentDate && currentClient && workDone) {
						const visit = {
							date: currentDate,
							time: currentTime,
							client_name: currentClient.name,
							client_id: currentClient.ID,
							address: currentAddress,
							work_done: workDone,
							duration_minutes: duration || 60, // ×‘×¨×™×¨×ª ××—×“×œ ×©×¢×”
							raw_text: `${line}\n${lines.slice(i+1, i+3).join('\n')}`
						};
						
						visits.push(visit);
						console.log('âœ… Created visit:', visit);
					}
					
					// ××™×¤×•×¡ ×œ××¦×‘ ×”×‘×
					workDone = '';
					duration = 0;
				}
			}
			
			console.log('ğŸ“Š Total parsed visits:', visits.length);
			return visits;
		}

		// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×–×™×”×•×™ ×“×¤×•×¡×™×
		function isDateLine(line) {
			// ×–×™×”×•×™ ×ª××¨×™×š ×›××• "15 August 2024"
			const dateRegex = /^\d{1,2}\s+[A-Za-z]+\s+\d{4}$/;
			return dateRegex.test(line);
		}

		function isTimeLine(line) {
			// ×–×™×”×•×™ ×©×¢×” ×›××• "13:39"
			const timeRegex = /^\d{1,2}:\d{2}$/;
			return timeRegex.test(line);
		}

		function parseTelegramDate(dateStr) {
			// ×”××¨ "15 August 2024" ×œ-"2024-08-15"
			const months = {
				'January': '01', 'February': '02', 'March': '03', 'April': '04',
				'May': '05', 'June': '06', 'July': '07', 'August': '08',
				'September': '09', 'October': '10', 'November': '11', 'December': '12'
			};
			
			const parts = dateStr.split(' ');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = months[parts[1]] || '01';
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			
			return '';
		}

		function findClientInText(text) {
			// ×—×¤×© ×œ×§×•×— ×œ×¤×™ ×›×ª×•×‘×ª ××• ×©× ××”×¨×©×™××” ×”×§×™×™××ª
			for (const location of locations) {
				// ×”×ª×××” ××“×•×™×§×ª ×œ×©×
				if (location.name && text.includes(location.name)) {
					return location;
				}
				
				// ×”×ª×××” ×œ×¨×—×•×‘
				if (location.street && text.includes(location.street)) {
					return location;
				}
				
				// ×”×ª×××” ×œ×›×ª×•×‘×ª ××œ××”
				if (location.full_address && text.toLowerCase().includes(location.full_address.toLowerCase())) {
					return location;
				}
				
				// ×—×™×¤×•×© ×’××™×© ×™×•×ª×¨ - ×œ×¤×™ ×—×œ×§×™ ×›×ª×•×‘×ª
				if (location.full_address) {
					const addressParts = location.full_address.split(' ');
					if (addressParts.length >= 2) {
						const street = addressParts.slice(0, -1).join(' ');
						const number = addressParts[addressParts.length - 1];
						
						if (text.includes(street) && text.includes(number)) {
							return location;
						}
					}
				}
			}
			
			return null;
		}

		function parseWorkDuration(text) {
			const patterns = {
				'×©×¢×ª×™×™× ×•×—×¦×™': 150,
				'×©×¢×” ×•×¨×‘×¢ × ×˜×•': 75,
				'×©×¢×” ×•×¨×‘×¢': 75,
				'×©×¢×” ×•×—×¦×™': 90,
				'×©×¢×ª×™×™×': 120,
				'×©×¢×”': 60,
				'×—×¦×™ ×©×¢×”': 30
			};
			
			for (const [pattern, minutes] of Object.entries(patterns)) {
				if (text.includes(pattern)) {
					return minutes;
				}
			}
			
			return 0;
		}

		// ×ª×¦×•×’×” ××§×“×™××” ×©×œ ×”×‘×™×§×•×¨×™× ×©× ××¦××•
		function showTelegramPreview(parsedVisits) {
			let previewHTML = `
				<div style="background: white; padding: 20px; border-radius: 10px; max-width: 800px; max-height: 600px; overflow-y: auto;">
					<h3 style="margin-bottom: 20px;">ğŸ“‹ ×ª×¦×•×’×” ××§×“×™××” - ×‘×™×§×•×¨×™× ×©× ××¦××•</h3>
					
					<div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
						<p><strong>× ××¦××• ${parsedVisits.length} ×‘×™×§×•×¨×™× ×¤×•×˜× ×¦×™××œ×™×™×</strong></p>
						<p style="font-size: 14px; color: #666;">×‘×“×•×§ ××ª ×”× ×ª×•× ×™× ×•××©×¨ ×™×™×‘×•×</p>
					</div>
					
					<div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
						<table style="width: 100%; border-collapse: collapse;">
							<thead style="background: #f8f9fa; position: sticky; top: 0;">
								<tr>
									<th style="padding: 10px; border: 1px solid #ddd;">×ª××¨×™×š</th>
									<th style="padding: 10px; border: 1px solid #ddd;">×©×¢×”</th>
									<th style="padding: 10px; border: 1px solid #ddd;">×œ×§×•×—</th>
									<th style="padding: 10px; border: 1px solid #ddd;">×¢×‘×•×“×”</th>
									<th style="padding: 10px; border: 1px solid #ddd;">×–××Ÿ (×“×§')</th>
								</tr>
							</thead>
							<tbody>
			`;
			
			parsedVisits.forEach((visit, index) => {
				previewHTML += `
					<tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
						<td style="padding: 8px; border: 1px solid #ddd;">${visit.date}</td>
						<td style="padding: 8px; border: 1px solid #ddd;">${visit.time}</td>
						<td style="padding: 8px; border: 1px solid #ddd;">${visit.client_name}</td>
						<td style="padding: 8px; border: 1px solid #ddd;">${visit.work_done}</td>
						<td style="padding: 8px; border: 1px solid #ddd;">${visit.duration_minutes}</td>
					</tr>
				`;
			});
			
			previewHTML += `
							</tbody>
						</table>
					</div>
					
					<div style="margin-top: 20px; text-align: center; gap: 10px; display: flex; justify-content: center;">
						<button class="btn btn-success" onclick="confirmTelegramImport()">
							âœ… ××©×¨ ×™×™×‘×•× (${parsedVisits.length} ×‘×™×§×•×¨×™×)
						</button>
						<button class="btn btn-secondary" onclick="closeTelegramPreview()">
							âŒ ×‘×™×˜×•×œ
						</button>
					</div>
				</div>
			`;
			
			// ×©××•×¨ ××ª ×”× ×ª×•× ×™× ×œ××©×ª× ×” ×’×œ×•×‘×œ×™ ×œ×™×™×‘×•×
			window.pendingTelegramVisits = parsedVisits;
			
			// ×”×¦×’ ××•×“×œ
			showModal(previewHTML);
		}

		// ××™×©×•×¨ ×™×™×‘×•× ×”×‘×™×§×•×¨×™× ××˜×œ×’×¨×
		async function confirmTelegramImport() {
			if (!window.pendingTelegramVisits || window.pendingTelegramVisits.length === 0) {
				showToast('××™×Ÿ ×‘×™×§×•×¨×™× ×œ×™×™×‘×•×', 'warning');
				return;
			}
			
			try {
				showLoading('××™×™×‘× ×‘×™×§×•×¨×™× ××˜×œ×’×¨×...');
				
				let importedCount = 0;
				
				for (const telegramVisit of window.pendingTelegramVisits) {
					// ×¦×•×¨ ×‘×™×§×•×¨ ×—×“×© ×‘××‘× ×” ×”××¢×¨×›×ª
					const visitData = {
						ID: generateID(),
						date: telegramVisit.date,
						location_id: telegramVisit.client_id,
						visit_type: '×’×™× ×•×Ÿ', // ×‘×¨×™×¨×ª ××—×“×œ
						work_done: telegramVisit.work_done,
						duration_minutes: telegramVisit.duration_minutes,
						start_time: telegramVisit.time || '',
						end_time: '',
						amount: 0, // ×™×—×•×©×‘ ×œ×¤×™ ×–××Ÿ ×•×ª×¢×¨×™×£
						expense: 0,
						paid: '×œ×',
						notes: `×™×•×‘× ××˜×œ×’×¨×: ${telegramVisit.raw_text}`
					};
					
					// ×”×•×¡×£ ×œ××¢×¨×›×ª
					visits.push(visitData);
					// ×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×œ××—×¨ ×”×•×¡×¤×ª ×‘×™×§×•×¨ ×—×“×©
					//await updateSingleLocationTreatmentDates(visitData.location_id);
					importedCount++;
				}
				
				// ×©××•×¨ ×”×›×œ
				saveToLocalStorage();
				
				// ×¢×“×›×Ÿ ×ª×¦×•×’×•×ª
				loadReceiptsTable(); // ×–×” ××¢×“×›×Ÿ ×’× ×˜×‘×œ×ª ×‘×™×§×•×¨×™×
				loadFilterOptions();
				
				// ×©××•×¨ ×œ×¢× ×Ÿ
				/// await saveAllToSheets();
				await saveAllToSheetsOptimized();
				
				showToast(`ğŸ‰ ×™×™×‘×•× ×˜×œ×’×¨× ×”×•×©×œ×!
				ğŸ’¬ ${importedCount} ×‘×™×§×•×¨×™× ×™×•×‘××•
				âœ… ×”×›×œ × ×©××¨ ×œ×¢× ×Ÿ!
				ğŸ• ×ª×”×œ×™×š ×”×•×©×œ×`, 'success', 6000);;
				
				// × ×§×” ×•× ×¡×’×•×¨
				window.pendingTelegramVisits = null;
				closeTelegramPreview();
				
			} catch (error) {
				console.error('Error importing telegram visits:', error);
				showToast('×©×’×™××” ×‘×™×™×‘×•× ××˜×œ×’×¨×', 'error');
			} finally {
				hideLoading();
			}
		}

		// ×¡×’×™×¨×ª ×ª×¦×•×’×” ××§×“×™××”
		function closeTelegramPreview() {
			window.pendingTelegramVisits = null;
			closeModal();
		}


		function showModal(content) {
			// ×”×¡×¨ ××•×“×œ ×§×™×™× ×× ×™×©
			const existingModal = document.getElementById('telegramModal');
			if (existingModal) {
				existingModal.remove();
			}
			
			// ×¦×•×¨ ××•×“×œ
			const modal = document.createElement('div');
			modal.id = 'telegramModal';
			modal.style.cssText = `
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.5);
				display: flex;
				justify-content: center;
				align-items: center;
				z-index: 1000;
			`;
			
			modal.innerHTML = content;
			document.body.appendChild(modal);
			
			// ×¡×’×™×¨×” ×‘×œ×—×™×¦×” ×¢×œ ×”×¨×§×¢
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					closeModal();
				}
			});
		}

		function closeModal() {
			const modal = document.getElementById('telegramModal');
			if (modal) {
				modal.remove();
			}
		}
	   
	    function generateID() {
			return Date.now() + Math.random().toString(36).substr(2, 9);
		}
	   
	   
	   async function saveAllToSheetsOptimized() {
			if (!await validateToken()) {
				showToast('×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×©××™×¨×” ××§×•××™×ª ×‘×œ×‘×“', 'warning');
				return;
			}
			
			try {
				showLoading('×©×•××¨ × ×ª×•× ×™× ×œ×¢× ×Ÿ (××¦×‘ ××”×™×¨)...');
				
				// ×©××™×¨×” ××¦×•×•×™×ª - ×›×œ ×”××™×§×•××™× ×‘×‘×ª ××—×ª
				if (locations.length > 0) {
					showToast(`×©×•××¨ ${locations.length} ××™×§×•××™× ×‘×‘×ª ××—×ª...`, 'info', 2000);
					
					const locationValues = locations.map(loc => [
						loc.ID, loc.name, loc.full_address, loc.neighborhood, loc.city,
						loc.contact_person, loc.phone, loc.allowed_day, loc.interval_weeks,
						loc.temporary_addition, loc.base_amount, loc.active, loc.notes,
						loc.last_visit, loc.next_visit
					]);
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Locations!A2:O${locationValues.length + 1}`,
						valueInputOption: 'USER_ENTERED',
						resource: { values: locationValues }
					});
				}
				
				// ×©××™×¨×” ××¦×•×•×™×ª - ×›×œ ×”×‘×™×§×•×¨×™× ×‘×‘×ª ××—×ª
				if (visits.length > 0) {
					showToast(`×©×•××¨ ${visits.length} ×‘×™×§×•×¨×™× ×‘×‘×ª ××—×ª...`, 'info', 2000);
					
					const visitValues = visits.map(visit => [
						visit.ID, visit.date, visit.location_id, visit.location_name, visit.visit_type, // â† location_name ×”×•× ×¢××•×“×” D
						visit.work_done, visit.duration_minutes, visit.num_workers || 1,
						visit.start_time, visit.end_time, visit.amount, visit.expense || 0,
						visit.paid, visit.notes
					]);

					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Visits!A2:N${visitValues.length + 1}`, // â† ×©× ×” ×-M ×œ-N
						valueInputOption: 'USER_ENTERED',
						resource: { values: visitValues }
					});
				}
				
				// ×©××™×¨×” ××¦×•×•×™×ª - ×›×œ ×”×§×‘×œ×•×ª ×‘×‘×ª ××—×ª
				if (receipts.length > 0) {
					showToast(`×©×•××¨ ${receipts.length} ×§×‘×œ×•×ª ×‘×‘×ª ××—×ª...`, 'info', 2000);
					
					const receiptValues = receipts.map(receipt => [
						receipt.ID, receipt.book_number, receipt.receipt_number, receipt.date,
						receipt.location_id, receipt.location_name, receipt.amount,
						receipt.payment_type, receipt.notes
					]);
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Receipts!A2:I${receiptValues.length + 1}`,
						valueInputOption: 'USER_ENTERED',
						resource: { values: receiptValues }
					});
				}
				
				showToast(`ğŸš€ ×©××™×¨×” ××”×™×¨×” ×”×•×©×œ××”!
		âœ… ${locations.length + visits.length + receipts.length} ×¨×©×•××•×ª × ×©××¨×•
		âš¡ ×–××Ÿ ×—×™×¡×›×•×Ÿ: ~90%`, 'success', 5000);
				
			} catch (error) {
				console.error('Error in optimized save:', error);
				showToast('×©×’×™××” ×‘×©××™×¨×” ××”×™×¨×” - ×—×•×–×¨ ×œ×©×™×˜×” ×¨×’×™×œ×”', 'warning');
				
				// ×× × ×›×©×œ, ×—×–×•×¨ ×œ×©×™×˜×” ×”×¨×’×™×œ×”
				await saveAllToSheets();
			} finally {
				hideLoading();
			}
		}
	   
	   // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×—×•×‘×•×ª
		function displayDebts() {
			const sortBy = document.getElementById('debtSortBy').value;
			const minAmount = parseFloat(document.getElementById('minDebtAmount').value) || 0;
			
			// ×—×™×©×•×‘ ×—×•×‘×•×ª ×œ×›×œ ×œ×§×•×—
			const debtsByLocation = {};
			
			visits.forEach(visit => {
				if (visit.paid === '×œ×' && visit.amount > 0) {
					if (!debtsByLocation[visit.location_id]) {
						const location = locations.find(loc => loc.ID == visit.location_id);
						debtsByLocation[visit.location_id] = {
							location: location,
							visits: [],
							totalDebt: 0
						};
					}
					debtsByLocation[visit.location_id].visits.push(visit);
					debtsByLocation[visit.location_id].totalDebt += parseFloat(visit.amount);
				}
			});
			
			// ×”××¨×” ×œ××¢×¨×š ×•×¡×™× ×•×Ÿ
			let debtsArray = Object.values(debtsByLocation)
				.filter(debt => debt.totalDebt >= minAmount);
			
			// ××™×•×Ÿ
			debtsArray.sort((a, b) => {
				switch(sortBy) {
					case 'amount_desc':
						return b.totalDebt - a.totalDebt;
					case 'amount_asc':
						return a.totalDebt - b.totalDebt;
					case 'date_old':
						return new Date(a.visits[0].date) - new Date(b.visits[0].date);
					case 'date_new':
						return new Date(b.visits[0].date) - new Date(a.visits[0].date);
					case 'location':
						return a.location?.name.localeCompare(b.location?.name);
					default:
						return b.totalDebt - a.totalDebt;
				}
			});
			
			// ×”×¦×’×” ×‘×˜×‘×œ×”
			const tbody = document.getElementById('debtsTableBody');
			tbody.innerHTML = '';
			
			debtsArray.forEach(debt => {
				const location = debt.location || { name: '×œ× × ××¦×', full_address: '', phone: '' };
				const lastVisit = debt.visits[debt.visits.length - 1];
				const daysSinceLastVisit = Math.floor((new Date() - new Date(lastVisit.date)) / (1000 * 60 * 60 * 24));
				
				const row = document.createElement('tr');
				
				// ×”×“×’×©×ª ×—×•×‘×•×ª ×™×©× ×™×
				if (daysSinceLastVisit > 60) {
					row.style.backgroundColor = '#ffebee'; // ××“×•× ×¢×“×™×Ÿ
				} else if (daysSinceLastVisit > 30) {
					row.style.backgroundColor = '#fff3e0'; // ×›×ª×•× ×¢×“×™×Ÿ  
				}
				
				row.innerHTML = `
					<td>
						<strong>${location.name}</strong>
						<br><small style="color: #666;">${location.contact_person || ''}</small>
					</td>
					<td><small>${location.full_address || ''}</small></td>
					<td>
						${location.phone ? 
							`<a href="tel:${location.phone}" style="color: #007bff; text-decoration: none;">
								ğŸ“ ${location.phone}
							</a>` : 
							'<span style="color: #999;">-</span>'
						}
					</td>
					<td style="text-align: center;">
						<span style="background: #e3f2fd; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
							${debt.visits.length}
						</span>
					</td>
					<td style="text-align: center;">
						<strong style="color: #e74c3c; font-size: 16px;">â‚ª${debt.totalDebt.toLocaleString()}</strong>
					</td>
					<td style="text-align: center;">${formatDate(lastVisit.date)}</td>
					<td style="text-align: center;">
						<span style="color: ${daysSinceLastVisit > 60 ? '#e74c3c' : daysSinceLastVisit > 30 ? '#f39c12' : '#666'}; font-weight: bold;">
							${daysSinceLastVisit}
						</span>
					</td>
					<td style="text-align: center;">
						<button class="action-btn" onclick="showDebtDetails(${location.ID})" style="background: #007bff; margin: 2px;">
							ğŸ” ×¤×™×¨×•×˜
						</button>
						<button class="action-btn" onclick="markDebtAsPaid(${location.ID})" style="background: #28a745; margin: 2px;">
							âœ… ×¡×•×œ×§
						</button>
					</td>
				`;
				
				tbody.appendChild(row);
			});
			
			// ×¢×“×›×•×Ÿ ×¡×™×›×•×
			updateDebtsSummary(debtsArray);
		}

		// ×¢×“×›×•×Ÿ ×›×¨×˜×™×¡×™ ×¡×™×›×•×
		function updateDebtsSummary(debtsArray) {
			const totalDebt = debtsArray.reduce((sum, debt) => sum + debt.totalDebt, 0);
			const debtorsCount = debtsArray.length;
			const averageDebt = debtorsCount > 0 ? totalDebt / debtorsCount : 0;
			
			// ××¦×™××ª ×”×—×•×‘ ×”×›×™ ×™×©×Ÿ
			let oldestDebtDays = 0;
			if (debtsArray.length > 0) {
				const oldestVisit = debtsArray
					.flatMap(debt => debt.visits)
					.reduce((oldest, visit) => 
						new Date(visit.date) < new Date(oldest.date) ? visit : oldest
					);
				oldestDebtDays = Math.floor((new Date() - new Date(oldestVisit.date)) / (1000 * 60 * 60 * 24));
			}
			
			document.getElementById('totalDebt').textContent = `â‚ª${totalDebt.toLocaleString()}`;
			document.getElementById('totalDebt').style.color = totalDebt > 0 ? '#e74c3c' : '#27ae60';
			
			document.getElementById('debtorsCount').textContent = debtorsCount;
			document.getElementById('averageDebt').textContent = `â‚ª${Math.round(averageDebt).toLocaleString()}`;
			document.getElementById('oldestDebt').textContent = oldestDebtDays > 0 ? `${oldestDebtDays} ×™××™×` : '-';
			
			if (oldestDebtDays > 90) {
				document.getElementById('oldestDebt').style.color = '#e74c3c';
			} else if (oldestDebtDays > 30) {
				document.getElementById('oldestDebt').style.color = '#f39c12';
			}
		}

		// ×”×¦×’×ª ×¤×™×¨×•×˜ ×—×•×‘ ×œ×œ×§×•×—
		function showDebtDetails(locationId) {
			const location = locations.find(loc => loc.ID == locationId);
			const locationVisits = visits.filter(v => v.location_id == locationId && v.paid === '×œ×');
			
			let details = `×¤×™×¨×•×˜ ×—×•×‘ ×¢×‘×•×¨: ${location?.name}\n\n`;
			
			locationVisits.forEach(visit => {
				details += `ğŸ“… ${formatDate(visit.date)}\n`;
				details += `ğŸ”§ ${visit.work_done}\n`;
				details += `ğŸ’° â‚ª${visit.amount}\n`;
				details += `---\n`;
			});
			
			const totalDebt = locationVisits.reduce((sum, v) => sum + parseFloat(v.amount), 0);
			details += `\n×¡×”"×› ×—×•×‘: â‚ª${totalDebt}`;
			
			alert(details);
		}

		// ×¡×™××•×Ÿ ×—×•×‘ ×›××¡×•×œ×§
		function markDebtAsPaid(locationId) {
			if (confirm('×œ×¡××Ÿ ××ª ×›×œ ×”×—×•×‘×•×ª ×©×œ ×”×œ×§×•×— ×”×–×” ×›××¡×•×œ×§×™×?')) {
				visits.forEach(visit => {
					if (visit.location_id == locationId && visit.paid === '×œ×') {
						visit.paid = '×›×Ÿ';
					}
				});
				
				saveToLocalStorage();
				displayDebts();
				showToast('×”×—×•×‘×•×ª ×¡×•×× ×• ×›××¡×•×œ×§×™×!', 'success');
			}
		}

	   
	    // ×”×ª×¨××” ×¢×œ ×—×•×‘×•×ª ×—××•×¨×™×
		function checkCriticalDebts() {
			const criticalDebts = visits.filter(visit => {
				if (visit.paid !== '×œ×') return false;
				
				const daysSince = Math.floor((new Date() - new Date(visit.date)) / (1000 * 60 * 60 * 24));
				return daysSince > 90 || parseFloat(visit.amount) > 1000;
			});
			
			if (criticalDebts.length > 0) {
				const totalCritical = criticalDebts.reduce((sum, visit) => sum + parseFloat(visit.amount), 0);
				
				showToast(
					`âš ï¸ ×™×© ${criticalDebts.length} ×—×•×‘×•×ª ×“×—×•×¤×™× (â‚ª${totalCritical.toLocaleString()})`, 
					'warning', 
					8000
				);
			}
		}
	   
	   
	    // ×“×•×— ×”×›× ×¡×•×ª ×œ×—×•×“×© × ×•×›×—×™
		function generateMonthlyReport() {
			const currentMonth = new Date().getMonth();
			const currentYear = new Date().getFullYear();
			
			const monthlyVisits = visits.filter(visit => {
				const visitDate = new Date(visit.date);
				return visitDate.getMonth() === currentMonth && 
					   visitDate.getFullYear() === currentYear;
			});
			
			const totalRevenue = monthlyVisits.reduce((sum, visit) => 
				sum + parseFloat(visit.amount || 0), 0);
			
			const paidRevenue = monthlyVisits
				.filter(visit => visit.paid === '×›×Ÿ')
				.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			const totalHours = monthlyVisits.reduce((sum, visit) => 
				sum + (visit.duration_minutes || 0) / 60, 0);
			
			const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™',
				'×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
			
			const report = {
				month: monthNames[currentMonth],
				year: currentYear,
				totalVisits: monthlyVisits.length,
				totalRevenue: totalRevenue,
				paidRevenue: paidRevenue,
				pendingRevenue: totalRevenue - paidRevenue,
				totalHours: totalHours.toFixed(1),
				avgPerVisit: monthlyVisits.length > 0 ? Math.round(totalRevenue / monthlyVisits.length) : 0
			};
			
			return report;
		}

		// ×”×¦×’×ª ×“×•×— ×‘××•×“×œ
		function showMonthlyReport() {
			const report = generateMonthlyReport();
			
			const reportHTML = `
				<div style="background: white; padding: 20px; border-radius: 10px; max-width: 500px;">
					<h3>ğŸ“Š ×“×•×— ${report.month} ${report.year}</h3>
					
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
						<div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #1976d2;">${report.totalVisits}</div>
							<div style="color: #666;">×‘×™×§×•×¨×™×</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #2e7d32;">â‚ª${report.totalRevenue.toLocaleString()}</div>
							<div style="color: #666;">×¡×”"×› ×”×›× ×¡×•×ª</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #f3e5f5; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #7b1fa2;">â‚ª${report.paidRevenue.toLocaleString()}</div>
							<div style="color: #666;">× ×’×‘×”</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #fff3e0; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #f57c00;">â‚ª${report.pendingRevenue.toLocaleString()}</div>
							<div style="color: #666;">×‘×”××ª× ×”</div>
						</div>
					</div>
					
					<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
						<div><strong>×©×¢×•×ª ×¢×‘×•×“×”:</strong> ${report.totalHours} ×©×¢×•×ª</div>
						<div><strong>×××•×¦×¢ ×œ×‘×™×§×•×¨:</strong> â‚ª${report.avgPerVisit}</div>
						<div><strong>×××•×¦×¢ ×œ×©×¢×”:</strong> â‚ª${Math.round(report.paidRevenue / parseFloat(report.totalHours) || 0)}</div>
					</div>
					
					<button onclick="closeModal()" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; width: 100%;">
						×¡×’×•×¨
					</button>
				</div>
			`;
			
			showModal(reportHTML);
		}
	   
	    function isDuplicateVisit(newVisit) {
			return visits.some(existing => 
				existing.location_id === newVisit.location_id &&
				existing.date === newVisit.date &&
				existing.work_done === newVisit.work_done &&
				existing.amount === newVisit.amount
			);
		}
	   
	    function isDuplicateReceipt(newReceipt) {
			return receipts.some(existing => 
				existing.receipt_number === newReceipt.receipt_number &&
				existing.booklet_number === newReceipt.booklet_number &&
				existing.date === newReceipt.date
			);
		}
		
		
		function removeDuplicates() {
			const uniqueVisits = [];
			const seen = new Set();
			
			visits.forEach(visit => {
				const key = `${visit.location_id}-${visit.date}-${visit.work_done}-${visit.amount}`;
				if (!seen.has(key)) {
					seen.add(key);
					uniqueVisits.push(visit);
				}
			});
			
			const removedCount = visits.length - uniqueVisits.length;
			visits = uniqueVisits;
			
			console.log(`Removed ${removedCount} duplicate visits`);
			return removedCount;
		}
	   
	   function validateVisitData(visitData) {
			const errors = [];
			
			if (!visitData.location_id) {
				errors.push('×—×¡×¨ ××–×”×” ×œ×§×•×—');
			}
			
			if (!visitData.date) {
				errors.push('×—×¡×¨ ×ª××¨×™×š');
			}
			
			if (!visitData.work_done || visitData.work_done.trim() === '') {
				errors.push('×—×¡×¨ ×ª×™××•×¨ ×¢×‘×•×“×”');
			}
			
			return errors;
		}

		function showValidationErrors(errors) {
			if (errors.length > 0) {
				alert('×‘×¢×™×•×ª ×‘×˜×•×¤×¡:\n' + errors.join('\n'));
				return true; // ×™×© ×©×’×™××•×ª
			}
			return false; // ××™×Ÿ ×©×’×™××•×ª
		}
	   
	   // ×©××™×¨×” ××§×‘×¦×™×ª ×©×œ ×œ×§×•×—×•×ª
		async function saveLocationsBatch(locationsArray) {
			if (!await validateToken() || locationsArray.length === 0) return false;
			
			try {
			
			    // ×§×¨× ××ª ×”× ×ª×•× ×™× ×”×§×™×™××™× ×§×•×“×
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:A'
				});
				
				const existingIDs = new Set(response.result.values?.slice(1).map(row => row[0]) || []);
				
				// ×¡× ×Ÿ ×¨×§ ×¨×©×•××•×ª ×—×“×©×•×ª
				const newLocations = locationsArray.filter(location => !existingIDs.has(location.ID));
				
				if (newLocations.length === 0) {
					console.log('××™×Ÿ ×œ×§×•×—×•×ª ×—×“×©×™× ×œ×©××™×¨×”');
					return true;
				}
			
				const values = newLocations.map(location => [
					location.ID,
					location.name,
					location.full_address,
					location.neighborhood,
					location.city,
					location.contact_person,
					location.phone,
					location.allowed_day,
					location.interval_weeks,
					location.temp_addition,
					location.base_amount,
					location.active,
					location.notes,
					formatDateForSheets(location.last_visit),
					formatDateForSheets(location.next_visit)
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:O`,
					valueInputOption: 'USER_ENTERED',
					resource: { 
						values: values,
						majorDimension: 'ROWS'
					}
				});
				
				console.log(`âœ… Saved ${newLocations.length} locations in batch - from ${locationsArray.length}`);
				return true;
			} catch (error) {
				console.error('Error in batch save locations:', error);
				return false;
			}
		}

		// ×©××™×¨×” ××§×‘×¦×™×ª ×©×œ ×‘×™×§×•×¨×™×
		async function saveVisitsBatch(visitsArray) {
			if (!await validateToken() || visitsArray.length === 0) return false;
			
			try {
				// ×§×¨× ××ª ×”× ×ª×•× ×™× ×”×§×™×™××™× ×§×•×“×
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Visits!A:A'
				});
				
				const existingIDs = new Set(response.result.values?.slice(1).map(row => row[0]) || []);
				
				// ×¡× ×Ÿ ×¨×§ ×¨×©×•××•×ª ×—×“×©×•×ª
				const newVisits = visitsArray.filter(visit => !existingIDs.has(visit.ID));
				
				if (newVisits.length === 0) {
					console.log('âœ… No new visits to save');
					return true;
				}
				
				const values = newVisits.map(visit => [
					visit.ID,
					formatDateForSheets(visit.date),
					visit.location_id,
					visit.location_name,
					visit.visit_type,
					visit.work_done,
					visit.duration_minutes,
					visit.start_time,
					visit.end_time,
					visit.amount,
					visit.expense,
					visit.paid,
					visit.notes
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:M`,
					valueInputOption: 'USER_ENTERED',
					resource: { 
						values: values,
						majorDimension: 'ROWS'
					}
				});
				
				console.log(`âœ… Saved ${newVisits.length} visits in batch - from ${visitsArray.length}`);
				return true;
			} catch (error) {
				console.error('Error in batch save visits:', error);
				return false;
			}
		}

		// ×©××™×¨×” ××§×‘×¦×™×ª ×©×œ ×§×‘×œ×•×ª
		async function saveReceiptsBatch(receiptsArray) {
			if (!await validateToken() || receiptsArray.length === 0) return false;
			
			try {
				// ×§×¨× ××ª ×”× ×ª×•× ×™× ×”×§×™×™××™× ×§×•×“×
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Receipts!A:A'
				});
				
				const existingIDs = new Set(response.result.values?.slice(1).map(row => row[0]) || []);
				
				// ×¡× ×Ÿ ×¨×§ ×¨×©×•××•×ª ×—×“×©×•×ª
				const newReceipts = receiptsArray.filter(receipt => !existingIDs.has(receipt.ID));
				
				if (newReceipts.length === 0) {
					console.log('âœ… No new receipts to save');
					return true;
				}
				
				const values = newReceipts.map(receipt => [
					receipt.ID,
					receipt.book_number,
					receipt.receipt_number,
					formatDateForSheets(receipt.date),
					receipt.location_id,
					receipt.location_name,
					receipt.amount,
					receipt.payment_type,
					receipt.notes
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:I`,
					valueInputOption: 'USER_ENTERED',
					resource: { 
						values: values,
						majorDimension: 'ROWS'
					}
				});
				
				console.log(`âœ… Saved ${newReceipts.length} receipts in batch - from ${receiptsArray.length}`);
				return true;
			} catch (error) {
				console.error('Error in batch save receipts:', error);
				return false;
			}
		}
	   
	   // ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ×•×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ××—×¨×•×Ÿ ×•×˜×™×¤×•×œ ×”×‘×
		// ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ×•×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ××—×¨×•×Ÿ ×•×˜×™×¤×•×œ ×”×‘× - ×’×¨×¡×” ××ª×§× ×ª
		async function calculateTreatmentDates() {
			console.log('ğŸ”„ ××—×©×‘ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ××—×¨×•×Ÿ ×•×˜×™×¤×•×œ ×”×‘×...');
			
			let updatedLocations = [];
			
			for (const location of locations) {
				// ××¦× ××ª ×›×œ ×”×˜×™×¤×•×œ×™× ×©×œ ×”×œ×§×•×— ×”×–×”
				const locationVisits = visits.filter(visit => visit.location_id === location.ID);
				
				if (locationVisits.length > 0) {
					// ××™×™×Ÿ ×œ×¤×™ ×ª××¨×™×š (×”×—×“×© ×‘×™×•×ª×¨ ×¨××©×•×Ÿ)
					locationVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
					
					// ×”×˜×™×¤×•×œ ×”××—×¨×•×Ÿ
					const lastVisit = locationVisits[0];
					const lastVisitDate = lastVisit.date;
					
					// ×—×™×©×•×‘ ×ª××¨×™×š ×”×˜×™×¤×•×œ ×”×‘×
					const lastDate = new Date(lastVisitDate);
					const intervalDays = (location.interval_weeks || 4) * 7; // ×‘×¨×™×¨×ª ××—×“×œ 4 ×©×‘×•×¢×•×ª
					const nextDate = new Date(lastDate);
					nextDate.setDate(lastDate.getDate() + intervalDays);
					
					// ×¤×•×¨××˜ ×”×ª××¨×™×š ×œ-YYYY-MM-DD
					const nextVisitDate = nextDate.toISOString().split('T')[0];
					
					// ×¢×“×›×•×Ÿ ×”××•×‘×™×™×§×˜ ×”××§×•××™
					location.last_visit = lastVisitDate;
					location.next_visit = nextVisitDate;
					
					updatedLocations.push(location);
					
					console.log(`ğŸ“… ${location.name}: ×˜×™×¤×•×œ ××—×¨×•×Ÿ ${lastVisitDate} â†’ ×˜×™×¤×•×œ ×”×‘× ${nextVisitDate}`);
				}
			}
			
			// ×¢×“×›×•×Ÿ ×‘×’×•×’×œ ×©×™×˜×¡ ×‘××§×‘×™×œ - ×§×¨×™××” ××—×ª ×‘×œ×‘×“ ×¢×‘×•×¨ ×›×œ ×”×œ×§×•×—×•×ª
			if (updatedLocations.length > 0) {
				console.log(`ğŸ”„ ××¢×“×›×Ÿ ${updatedLocations.length} ×œ×§×•×—×•×ª ×‘×’×•×’×œ ×©×™×˜×¡...`);
				await updateTreatmentDatesInSheets(updatedLocations);
				showToast(`ğŸ“… ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×¢×•×“×›× ×• ×¢×‘×•×¨ ${updatedLocations.length} ×œ×§×•×—×•×ª`, 'success', 2000);
			}
			
			// ×¨×¢× ×Ÿ × ×ª×•× ×™ ×ª×›× ×•×Ÿ
			refreshPlanningAfterTreatmentUpdate();
			
			return updatedLocations.length;
		}
	   
	   
	    // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×”×˜×™×¤×•×œ ×‘×’×•×’×œ ×©×™×˜×¡
		async function updateTreatmentDatesInSheets(locationsToUpdate) {
			if (!await validateToken() || locationsToUpdate.length === 0) return false;
			
			console.log(`ğŸ”„ ××¢×“×›×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×¢×‘×•×¨ ${locationsToUpdate.length} ×œ×§×•×—×•×ª ×‘×’×•×’×œ ×©×™×˜×¡...`);
			
			try {
				// ×§×¨× ××ª ×›×œ ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™× ××”×˜×‘×œ×”
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:O'
				});
				
				const allRows = response.result.values || [];
				const updatedRows = [...allRows];
				let updatedCount = 0;
				
				// ×¢×‘×•×¨ ×›×œ ×œ×§×•×— ×©×¦×¨×™×š ×¢×“×›×•×Ÿ
				for (const location of locationsToUpdate) {
					// ××¦× ××ª ×”×©×•×¨×” ×”××ª××™××” ×‘×˜×‘×œ×”
					for (let i = 1; i < allRows.length; i++) { // ××ª×—×™×œ ×-1 ×›×“×™ ×œ×“×œ×’ ×¢×œ ×”×›×•×ª×¨×•×ª
						if (allRows[i][0] === location.ID) {
							// ×¢×“×›×Ÿ ××ª ×¢××•×“×•×ª ×”×ª××¨×™×›×™× (×¢××•×“×•×ª 13 ×•-14)
							updatedRows[i][13] = location.last_visit;   // last_visit
							updatedRows[i][14] = location.next_visit;   // next_visit
							updatedCount++;
							break;
						}
					}
				}
				
				// ×©××•×¨ ××ª ×›×œ ×”×˜×‘×œ×” ×”××¢×•×“×›× ×ª ×‘×§×¨×™××” ××—×ª ×‘×œ×‘×“
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:O',
					valueInputOption: 'USER_ENTERED',
					resource: {
						values: updatedRows
					}
				});
				
				console.log(`âœ… ×¢×•×“×›× ×• ${updatedCount} ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×‘×’×•×’×œ ×©×™×˜×¡`);
				return true;
			} catch (error) {
				console.error('Error updating treatment dates in sheets:', error);
				return false;
			}
		}
		
		// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×¢×‘×•×¨ ×œ×§×•×— ××—×“ ×œ××—×¨ ×”×•×¡×¤×ª ×‘×™×§×•×¨
		async function updateSingleLocationTreatmentDates(locationId) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) return;
			
			// ××¦× ××ª ×›×œ ×”×‘×™×§×•×¨×™× ×©×œ ×”×œ×§×•×— ×”×–×”
			const locationVisits = visits.filter(visit => visit.location_id === locationId);
			
			if (locationVisits.length > 0) {
				// ××™×™×Ÿ ×œ×¤×™ ×ª××¨×™×š (×”×—×“×© ×‘×™×•×ª×¨ ×¨××©×•×Ÿ)
				locationVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
				
				// ×”×˜×™×¤×•×œ ×”××—×¨×•×Ÿ
				const lastVisit = locationVisits[0];
				const lastVisitDate = lastVisit.date;
				
				// ×—×™×©×•×‘ ×ª××¨×™×š ×”×˜×™×¤×•×œ ×”×‘×
				const lastDate = new Date(lastVisitDate);
				const intervalDays = (location.interval_weeks || 4) * 7; // ×‘×¨×™×¨×ª ××—×“×œ 4 ×©×‘×•×¢×•×ª
				const nextDate = new Date(lastDate);
				nextDate.setDate(lastDate.getDate() + intervalDays);
				
				// ×¤×•×¨××˜ ×”×ª××¨×™×š ×œ-YYYY-MM-DD
				const nextVisitDate = nextDate.toISOString().split('T')[0];
				
				// ×¢×“×›×•×Ÿ ×”××•×‘×™×™×§×˜ ×”××§×•××™
				location.last_visit = lastVisitDate;
				location.next_visit = nextVisitDate;
				
				// ×¢×“×›×•×Ÿ ×‘×’×•×’×œ ×©×™×˜×¡
				await updateTreatmentDatesInSheets([location]);
				
				console.log(`ğŸ“… ×¢×•×“×›×Ÿ ×œ×§×•×— ${location.name}: ×˜×™×¤×•×œ ××—×¨×•×Ÿ ${lastVisitDate} â†’ ×˜×™×¤×•×œ ×”×‘× ${nextVisitDate}`);
				// ×¨×¢× ×Ÿ × ×ª×•× ×™ ×ª×›× ×•×Ÿ
				refreshPlanningAfterTreatmentUpdate();
			}
		}
	   
	   // ×¤×•× ×§×¦×™×” ×œ×—×™×“×•×© × ×ª×•× ×™ ×”×ª×›× ×•×Ÿ ×œ××—×¨ ×¢×“×›×•×Ÿ ×ª××¨×™×›×™×
		function refreshPlanningAfterTreatmentUpdate() {
			// ×¨×¢× ×Ÿ ××ª × ×ª×•× ×™ ×”×ª×›× ×•×Ÿ ×× ×”×˜××‘ ×¤×ª×•×—
			const currentSection = document.querySelector('.section.active');
			if (currentSection && currentSection.id === 'planning') {
				loadPlanningData();
			}
			
			// ×¨×¢× ×Ÿ ×’× ××ª ×¨×©×™××ª ×”×œ×§×•×—×•×ª ×‘×˜×•×¤×¡ ×”×‘×™×§×•×¨
			loadLocationsForSelect();
		}
	   
	   // ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ××¦×‘ × ×ª×•× ×™ ×”×ª×›× ×•×Ÿ - ×œ×“×™×‘×•×’
		function debugPlanningData() {
			console.log('=== Debug Planning Data ===');
			console.log(`×¡×”"×› ×œ×§×•×—×•×ª: ${locations.length}`);
			
			// ×‘×“×•×§ ××” ×™×© ×‘×©×“×” active
			console.log('×“×•×’×××•×ª ×©×œ ×©×“×” active:', locations.slice(0, 5).map(loc => ({ name: loc.name, active: loc.active, type: typeof loc.active })));

			const activeLocations = locations.filter(loc => loc.active === "×›×Ÿ" || loc.active === true || loc.active === "1");
			console.log(`×œ×§×•×—×•×ª ×¤×¢×™×œ×™×: ${activeLocations.length}`);
			
			const locationsWithDates = activeLocations.filter(loc => loc.next_visit && loc.next_visit.trim() !== '');
			console.log(`×œ×§×•×—×•×ª ×¢× ×ª××¨×™×›×™ ×˜×™×¤×•×œ: ${locationsWithDates.length}`);
			
			// ×”×¦×’ 5 ×œ×§×•×—×•×ª ×¨××©×•× ×™×
			locationsWithDates.slice(0, 5).forEach(loc => {
				console.log(`ğŸ‘¤ ${loc.name}: ××—×¨×•×Ÿ=${loc.last_visit}, ×”×‘×=${loc.next_visit}`);
			});
			
			const today = new Date();
			const todayStr = today.toISOString().split('T')[0];
			console.log(`×ª××¨×™×š ×”×™×•×: ${todayStr}`);
			
			const dueToday = locationsWithDates.filter(loc => {
				return new Date(loc.next_visit) <= today;
			});
			console.log(`×¦×¨×™×›×™× ×˜×™×¤×•×œ ×”×™×•×: ${dueToday.length}`);
			
			console.log('=== ×¡×™×•× Debug ===');
		}
	   
	   
		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×™×™×‘×•× ××”×™×¨ ×•×›×•×œ×œ ×©×œ ×›×œ ×”× ×ª×•× ×™×
		async function importFromHelperTableFast() {
			if (!await validateToken()) {
				showToast('×”×ª×—×‘×¨ ×œ×’×•×’×œ ×§×•×“×', 'warning');
				return;
			}
			
			const importTableId = localStorage.getItem('importTableId');
			if (!importTableId) {
				showToast('×œ× × ××¦× ID ×©×œ ×˜×‘×œ×ª ×”×¢×–×¨', 'warning');
				return;
			}
			
			console.log('ğŸš€ Starting FAST complete import from helper table...');
			
			try {
				showLoading('××™×™×‘× × ×ª×•× ×™× ××”×¨ ××˜×‘×œ×ª ×”×¢×–×¨...');
				
				// ××¢×§×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª
				const stats = {
					locations: { imported: 0, skipped: 0 },
					visits: { imported: 0, skipped: 0 },
					receipts: { imported: 0, skipped: 0 }
				};
				
				// ××¢×¨×›×™× ×œ× ×ª×•× ×™× ×—×“×©×™× ×‘×œ×‘×“
				const newLocations = [];
				const newVisits = [];
				const newReceipts = [];
				
				// ======== ×©×œ×‘ 1: ×§×¨×™××ª × ×ª×•× ×™× ×‘×¨×¦×£ (×›××• ×‘×¤×•× ×§×¦×™×•×ª ×©×¢×•×‘×“×•×ª) ========
				let locationsResponse, visitsResponse, receiptsResponse;
				
				try {
					console.log('ğŸ“Š Loading locations data...');
					locationsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Locations!A2:G1000'
					});
				} catch (error) {
					console.log('ğŸ“Š Locations sheet not found or empty');
					locationsResponse = { result: { values: [] } };
				}
				
				try {
					console.log('ğŸ”§ Loading visits data...');
					visitsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Visits!A2:M1000'
					});
				} catch (error) {
					console.log('ğŸ”§ Visits sheet not found or empty');
					visitsResponse = { result: { values: [] } };
				}
				
				try {
					console.log('ğŸ§¾ Loading receipts data...');
					receiptsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Receipts!A2:K1000'
					});
				} catch (error) {
					console.log('ğŸ§¾ Receipts sheet not found or empty');
					receiptsResponse = { result: { values: [] } };
				}
				
				console.log('ğŸ“Š Raw data loaded:', {
					locations: locationsResponse.result.values?.length || 0,
					visits: visitsResponse.result.values?.length || 0,
					receipts: receiptsResponse.result.values?.length || 0
				});
				
				// ======== ×©×œ×‘ 2: ×¢×™×‘×•×“ ×œ×§×•×—×•×ª ========
				if (locationsResponse.result.values?.length > 0) {
					showToast('××¢×‘×“ ×œ×§×•×—×•×ª...', 'info', 1500);
					
					for (const row of locationsResponse.result.values) {
						if (row.length > 0 && row[0]) { // ×™×© ×©× ×œ×§×•×—
							const customerName = row[0].trim();
							const street = row[1] || '';
							const houseNumber = row[2] || '';
							const city = row[3] || '';
							const fullAddress = `${street} ${houseNumber} ${city}`.trim();
							
							// ×‘×“×™×§×ª ×›×¤×™×œ×•×ª ×œ×¤×™ ×©× ×•/××• ×›×ª×•×‘×ª
							const isDuplicate = locations.some(existing =>
								existing.name.toLowerCase() === customerName.toLowerCase() ||
								(fullAddress && existing.full_address && 
								 existing.full_address.toLowerCase() === fullAddress.toLowerCase())
							);
							
							if (isDuplicate) {
								stats.locations.skipped++;
								console.log(`âš ï¸ Duplicate customer skipped: ${customerName}`);
								continue;
							}
							
							const locationData = {
								ID: generateID(),
								name: customerName,
								full_address: fullAddress || customerName, // â† ×ª×™×§×•×Ÿ: ×’× ×©× ×”×œ×§×•×— ×× ××™×Ÿ ×›×ª×•×‘×ª × ×¤×¨×“×ª
								neighborhood: '',
								city: city,
								contact_person: row[5] || '',
								phone: '',
								allowed_day: '',
								interval_weeks: parseInt(row[4]) || 4,
								temp_addition: 0,
								base_amount: parseFloat(row[6]) || 0,
								active: "1",
								notes: '',
								last_visit: '',
								next_visit: ''
							};
							
							locations.push(locationData);
							newLocations.push(locationData);
							stats.locations.imported++;
						}
					}
				}
				
				// ======== ×©×œ×‘ 3: ×¢×™×‘×•×“ ×‘×™×§×•×¨×™× ========
				if (visitsResponse.result.values?.length > 0) {
					showToast('××¢×‘×“ ×‘×™×§×•×¨×™×...', 'info', 1500);
					
					let notFoundCustomers = [];
					
					for (const row of visitsResponse.result.values) {
						if (row.length > 3 && row[3]) { // ×™×© ×œ×§×•×— ×‘×¢××•×“×” 3
							const customerName = row[3].trim();
							
							// ××¦× ×œ×§×•×— ×§×™×™×
							const existingCustomer = locations.find(loc =>
								loc.name && loc.name.toLowerCase() === customerName.toLowerCase()
							);
							
							if (!existingCustomer) {
								if (!notFoundCustomers.includes(customerName)) {
									notFoundCustomers.push(customerName);
								}
								stats.visits.skipped++;
								continue;
							}
							
							// ×‘× ×™×™×ª ×ª××¨×™×š ×-3 ×¢××•×“×•×ª: year, month, day
							const year = row[0];
							const month = String(row[1]).padStart(2, '0');
							const day = String(row[2]).padStart(2, '0');
							const visitDate = `${year}-${month}-${day}`;
							
							const workDone = row[7] || '';
							const amount = parseFloat(row[9]) || 0;
							
							// ×‘×“×™×§×ª ×›×¤×™×œ×•×ª ×‘×™×§×•×¨
							const isDuplicateVisit = visits.some(existing =>
								existing.location_id === existingCustomer.ID &&
								existing.date === visitDate &&
								existing.work_done === workDone &&
								Math.abs(existing.amount - amount) < 0.01
							);
							
							if (isDuplicateVisit) {
								stats.visits.skipped++;
								console.log(`âš ï¸ Duplicate visit skipped: ${customerName} on ${visitDate}`);
								continue;
							}
							
							const visitData = {
								ID: generateID(),
								date: visitDate,
								location_id: existingCustomer.ID,
								location_name: customerName, // â† ×”×•×¡×¤× ×• ××ª ×”×©×!
								visit_type: row[5] || 'regular',
								work_done: workDone,
								duration_minutes: (parseFloat(row[8]) || 0) * 60,
								num_workers: 1,
								start_time: '',
								end_time: '',
								amount: amount,
								expense: parseFloat(row[11]) || 0,
								paid: row[10] === '×›×Ÿ' || row[10] === 'yes' || row[10] === '1',
								notes: row[12] || ''
							};
							
							visits.push(visitData);
							newVisits.push(visitData);
							//** ×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×œ××—×¨ ×”×•×¡×¤×ª ×‘×™×§×•×¨ ×—×“×©
							//** await updateSingleLocationTreatmentDates(visitData.location_id);
							stats.visits.imported++;
						}
					}
					
					if (notFoundCustomers.length > 0) {
						console.log(`âš ï¸ ${notFoundCustomers.length} customers not found for visits:`, notFoundCustomers.slice(0, 5));
					}
				}
				
				// ======== ×©×œ×‘ 4: ×¢×™×‘×•×“ ×§×‘×œ×•×ª ========
				if (receiptsResponse.result.values?.length > 0) {
					showToast('××¢×‘×“ ×§×‘×œ×•×ª...', 'info', 1500);
					
					let notFoundAddresses = [];
					
					for (const row of receiptsResponse.result.values) {
						if (row.length > 6 && row[6]) { // ×™×© ×›×ª×•×‘×ª ×‘×¢××•×“×” 6
							const customerAddress = row[6].trim();
							
							// ××¦× ×œ×§×•×— ×œ×¤×™ ×›×ª×•×‘×ª - ×’× ×‘×©× ×•×’× ×‘×›×ª×•×‘×ª ××œ××”
							const existingCustomer = locations.find(loc =>
								(loc.name && loc.name.toLowerCase().includes(customerAddress.toLowerCase())) ||
								(loc.full_address && loc.full_address.toLowerCase().includes(customerAddress.toLowerCase()))
							);
							
							if (!existingCustomer) {
								if (!notFoundAddresses.includes(customerAddress)) {
									notFoundAddresses.push(customerAddress);
								}
								stats.receipts.skipped++;
								continue;
							}
							
							// ×‘× ×™×™×ª ×ª××¨×™×š
							const year = row[3];
							const month = String(row[4]).padStart(2, '0');
							const day = String(row[5]).padStart(2, '0');
							const receiptDate = `${year}-${month}-${day}`;
							
							const bookNumber = row[1] || '';
							const receiptNumber = row[2] || '';
							
							// ×‘×“×™×§×ª ×›×¤×™×œ×•×ª ×§×‘×œ×”
							const isDuplicateReceipt = receipts.some(existing =>
								existing.book_number === bookNumber &&
								existing.receipt_number === receiptNumber &&
								existing.date === receiptDate
							);
							
							if (isDuplicateReceipt) {
								stats.receipts.skipped++;
								console.log(`âš ï¸ Duplicate receipt skipped: ${bookNumber}/${receiptNumber}`);
								continue;
							}
							
							const receiptData = {
								ID: generateID(),
								book_number: bookNumber,
								receipt_number: receiptNumber,
								date: receiptDate,
								location_id: existingCustomer.ID,
								location_name: customerAddress,
								amount: parseFloat(row[7]) || 0,
								payment_type: row[8] || '',
								notes: `${row[9] || ''} ${row[10] || ''}`.trim()
							};
							
							receipts.push(receiptData);
							newReceipts.push(receiptData);
							stats.receipts.imported++;
						}
					}
					
					if (notFoundAddresses.length > 0) {
						console.log(`âš ï¸ ${notFoundAddresses.length} addresses not found for receipts:`, notFoundAddresses.slice(0, 5));
					}
				}
				
				// ======== ×©×œ×‘ 5: ×©××™×¨×” ××§×‘×¦×™×ª ×œ×¢× ×Ÿ ========
				showToast('×©×•××¨ × ×ª×•× ×™× ×—×“×©×™× ×œ×¢× ×Ÿ...', 'info');
				
				const savePromises = [];
				
				if (newLocations.length > 0) {
					savePromises.push(saveLocationsBatchNew(newLocations));
				}
				if (newVisits.length > 0) {
					savePromises.push(saveVisitsBatchNew(newVisits));
				}
				if (newReceipts.length > 0) {
					savePromises.push(saveReceiptsBatchNew(newReceipts));
				}
				
				const saveResults = await Promise.all(savePromises);
				const allSaved = saveResults.every(result => result === true);
				
				// ======== ×©×œ×‘ 6: ×¢×“×›×•×Ÿ ×××©×§ ========
				saveToLocalStorage();
				loadLocationsTable();
				loadReceiptsTable();
				loadLocationsForSelect();
				loadFilterOptions();
				
				hideLoading();
				
				// ======== ×“×™×•×•×— ×¡×•×¤×™ ========
				console.log('ğŸ“Š Import completed:', stats);
				
				const totalImported = stats.locations.imported + stats.visits.imported + stats.receipts.imported;
				const totalSkipped = stats.locations.skipped + stats.visits.skipped + stats.receipts.skipped;
				
				// ×—×™×©×•×‘ ×•×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ (×”×•×¡×¤×” ×—×“×©×”)
				if (stats.visits.imported > 0) {
					showToast('××—×©×‘ ×ª××¨×™×›×™ ×˜×™×¤×•×œ...', 'info', 2000);
					const updatedCount = await calculateTreatmentDates();
					if (updatedCount > 0) {
						showToast(`âœ… ×¢×•×“×›× ×• ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×¢×‘×•×¨ ${updatedCount} ×œ×§×•×—×•×ª`, 'success', 3000);
					}
				}
				
				if (totalImported > 0) {
					const message = `ğŸ‰ ×™×™×‘×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”!
					
		âœ… ×™×•×‘××•: ${stats.locations.imported} ×œ×§×•×—×•×ª, ${stats.visits.imported} ×‘×™×§×•×¨×™×, ${stats.receipts.imported} ×§×‘×œ×•×ª
		${totalSkipped > 0 ? `âš ï¸ ×“×•×œ×’×• (×›×¤×™×œ×•×™×•×ª): ${totalSkipped} ×¨×©×•××•×ª` : ''}
		${allSaved ? 'â˜ï¸ × ×©××¨ ×œ×¢× ×Ÿ ×‘×”×¦×œ×—×”' : 'âš ï¸ ×—×œ×§ ××”× ×ª×•× ×™× ×œ× × ×©××¨×• ×œ×¢× ×Ÿ'}`;
					
					showToast(message, 'success', 8000);
				} else {
					showToast('×œ× × ××¦××• × ×ª×•× ×™× ×—×“×©×™× ×œ×™×™×‘×•×', 'info');
				}
				
			} catch (error) {
				console.error('Error in fast import:', error);
				hideLoading();
				showToast('×©×’×™××” ×‘×™×™×‘×•× ××”×™×¨', 'error');
			}
		}

		// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×—×“×©×•×ª ×•××¢×•×“×›× ×•×ª ×œ×©××™×¨×” ××§×‘×¦×™×ª
		async function saveLocationsBatchNew(locationsArray) {
			if (!locationsArray.length) return true;
			
			try {
				const values = locationsArray.map(loc => [
					loc.ID, loc.name, loc.full_address, loc.neighborhood, loc.city,
					loc.contact_person, loc.phone, loc.allowed_day, loc.interval_weeks,
					loc.temp_addition, loc.base_amount, loc.active, loc.notes,
					loc.last_visit, loc.next_visit
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A2:O2',
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`âœ… Saved ${locationsArray.length} locations to cloud`);
				return true;
			} catch (error) {
				console.error('Error saving locations batch:', error);
				return false;
			}
		}

		async function saveVisitsBatchNew(visitsArray) {
			if (!visitsArray.length) return true;
			
			try {
				// ×”×¡×¨× ×• ××ª location_name ×©×œ× ×§×™×™× ×‘×‘×™×§×•×¨×™× - ××•×¤×¡, ×–×” ×›×Ÿ ×¦×¨×™×š ×œ×”×™×•×ª!
				const values = visitsArray.map(visit => [
					visit.ID, visit.date, visit.location_id, visit.location_name, visit.visit_type, visit.work_done,
					visit.duration_minutes, visit.num_workers, visit.start_time, visit.end_time,
					visit.amount, visit.expense, visit.paid, visit.notes
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Visits!A2:N2', // â† ×¢×›×©×™×• N ×›×™ ×™×© ×¢××•×“×” × ×•×¡×¤×ª
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`âœ… Saved ${visitsArray.length} visits to cloud`);
				return true;
			} catch (error) {
				console.error('Error saving visits batch:', error);
				return false;
			}
		}

		async function saveReceiptsBatchNew(receiptsArray) {
			if (!receiptsArray.length) return true;
			
			try {
				const values = receiptsArray.map(receipt => [
					receipt.ID, receipt.book_number, receipt.receipt_number, receipt.date,
					receipt.location_id, receipt.location_name, receipt.amount,
					receipt.payment_type, receipt.notes
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Receipts!A2:I2',
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`âœ… Saved ${receiptsArray.length} receipts to cloud`);
				return true;
			} catch (error) {
				console.error('Error saving receipts batch:', error);
				return false;
			}
		}

	   
	   ////////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	   
	   // ×”×—×œ×£ ××ª validateToken ×‘×¤×•× ×§×¦×™×” ×–×•:
		async function validateToken() {
			if (!access_token || !gapi.client) {
				updateCloudStatus('ğŸ” ×œ× ××—×•×‘×¨ ×œ×¢× ×Ÿ', '× ×•×ª×§');
				return false;
			}
			
			try {
				// ×‘×“×™×§×” ×¤×©×•×˜×” - × ×¡×” ×œ×§×¨×•× ××”×˜×‘×œ×”
				await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID || 'test'
				});
				return true;
			} catch (error) {
				if (error.status === 401) {
					console.log('Google token expired');
					access_token = null;
					updateCloudStatus('ğŸ” × ×“×¨×© ×—×™×‘×•×¨ ××—×“×©', '× ×•×ª×§');
					document.getElementById('statusText').classList.remove('connected');
					document.getElementById('saveBtn').disabled = true;
					document.getElementById('loadBtn').disabled = true;
					showToast('âš ï¸ ×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×”×ª×—×‘×¨ ××—×“×©', 'warning');
					return false;
				}
				updateCloudStatus('âš ï¸ ×‘×¢×™×™×ª ×—×™×‘×•×¨ ×œ×¢× ×Ÿ', '×©×’×™××”');
				return false;
			}
		}

		// ×”×—×œ×£ ××ª saveEditedLocation ×‘×¤×•× ×§×¦×™×” ×–×•:
		function saveEditedLocation(locationId) {
			console.log(`âœ… saveEditedLocation ('${locationId}')`);
			const locationIndex = locations.findIndex(g => g.ID == locationId);
			if (locationIndex === -1) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			try {
				// ×¢×“×›×Ÿ ××ª ×”×œ×§×•×— ×‘××¢×¨×š ×”××§×•××™
				const updatedLocation = {
					...locations[locationIndex], // ×©××•×¨ × ×ª×•× ×™× ×§×™×™××™×
					name: document.getElementById('editLocationName').value,
					full_address: document.getElementById('editLocationAddress').value,
					neighborhood: document.getElementById('editLocationNeighborhood').value,
					city: document.getElementById('editLocationCity').value,
					contact_person: document.getElementById('editLocationContact').value,
					phone: document.getElementById('editLocationPhone').value,
					allowed_day: document.getElementById('editLocationDay').value,
					interval_weeks: parseInt(document.getElementById('editLocationInterval').value) || 4,
					base_amount: parseFloat(document.getElementById('editLocationAmount').value) || 0,
					active: document.getElementById('editLocationActive').value,
					next_visit: document.getElementById('editLocationNextVisit').value,
					notes: document.getElementById('editLocationNotes').value
				};
				
				locations[locationIndex] = updatedLocation;
				
				// ×©××•×¨ ××§×•××™×ª ×ª××™×“
				saveToLocalStorage();
				updateCloudStatus('ğŸ’¾ ×©×•××¨...', '××¢×“×›×Ÿ');
				
				// × ×¡×” ×œ×©××•×¨ ×‘×¢× ×Ÿ
				if (access_token && SPREADSHEET_ID) {
					// ×©××•×¨ ×‘×¢× ×Ÿ ×¢× ×‘×“×™×§×ª ×—×™×‘×•×¨
					updateLocationInCloud(updatedLocation).then(() => {
						updateCloudStatus('âœ… ××—×•×‘×¨ ×•××¡×•× ×›×¨×Ÿ', '× ×©××¨');
						showToast('×œ×§×•×— ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×” ×‘××¢×¨×›×ª ×•×‘×¢× ×Ÿ!', 'success');
					}).catch(error => {
						if (error.status === 401) {
							updateCloudStatus('ğŸ” × ×“×¨×© ×—×™×‘×•×¨ ××—×“×©', '× ×•×ª×§');
							showToast('âš ï¸ ×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×”×œ×§×•×— × ×©××¨ ××§×•××™×ª ×‘×œ×‘×“', 'warning');
							access_token = null;
							document.getElementById('saveBtn').disabled = true;
							document.getElementById('loadBtn').disabled = true;
						} else {
							updateCloudStatus('âš ï¸ ×©×’×™××” ×‘×©××™×¨×”', '×©×’×™××”');
							showToast('âš ï¸ ×”×œ×§×•×— × ×©××¨ ××§×•××™×ª, ××‘×œ ×œ× ×”×¦×œ×™×— ×œ×©××•×¨ ×‘×¢× ×Ÿ', 'warning');
						}
					});
				} else {
					updateCloudStatus('ğŸ” ×©×™× ×•×™×™× ×œ× × ×©××¨×• ×‘×¢× ×Ÿ', '××§×•××™');
					showToast('ğŸ” ×œ×§×•×— × ×©××¨ ××§×•××™×ª - ×”×ª×—×‘×¨ ×œ×¢× ×Ÿ ×œ×©××™×¨×” ××œ××”', 'warning');
				}
				
				// ×¢×“×›×Ÿ ×ª×¦×•×’×”
				loadLocationsTable();
				loadLocationsForSelect();
				closeEditModal();
				
			} catch (error) {
				console.error('Error updating location:', error);
				updateCloudStatus('âŒ ×©×’×™××” ×‘××¢×¨×›×ª', '×©×’×™××”');
				showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×œ×§×•×—', 'error');
			}
		}

		// ×”×—×œ×£ ××ª saveEditedReceipt ×‘×¤×•× ×§×¦×™×” ×–×•:
		function saveEditedReceipt(receiptId) {
			console.log(`âœ… saveEditedReceipt ('${receiptId}')`);
			const receiptIndex = receipts.findIndex(r => r.ID == receiptId);
			if (receiptIndex === -1) {
				showToast('×§×‘×œ×” ×œ× × ××¦××”', 'error');
				return;
			}
			
			try {
				const locationId = document.getElementById('editReceiptLocation').value;
				const location = locations.find(g => g.ID == locationId);
				
				// ×¢×“×›×Ÿ ××ª ×”×§×‘×œ×” ×‘××¢×¨×š ×”××§×•××™
				const updatedReceipt = {
					...receipts[receiptIndex], // ×©××•×¨ × ×ª×•× ×™× ×§×™×™××™×
					book_number: document.getElementById('editReceiptBook').value,
					receipt_number: document.getElementById('editReceiptNumber').value,
					date: document.getElementById('editReceiptDate').value,
					location_id: locationId,
					location_name: location ? location.name : '',
					amount: parseFloat(document.getElementById('editReceiptAmount').value) || 0,
					payment_type: document.getElementById('editReceiptPaymentType').value,
					notes: document.getElementById('editReceiptNotes').value
				};
				
				receipts[receiptIndex] = updatedReceipt;
				
				// ×©××•×¨ ××§×•××™×ª ×ª××™×“
				saveToLocalStorage();
				updateCloudStatus('ğŸ’¾ ×©×•××¨ ×§×‘×œ×”...', '××¢×“×›×Ÿ');
				
				// × ×¡×” ×œ×©××•×¨ ×‘×¢× ×Ÿ
				if (access_token && SPREADSHEET_ID) {
					updateReceiptInCloud(updatedReceipt).then(() => {
						updateCloudStatus('âœ… ××—×•×‘×¨ ×•××¡×•× ×›×¨×Ÿ', '× ×©××¨');
						showToast('×§×‘×œ×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×” ×‘××¢×¨×›×ª ×•×‘×¢× ×Ÿ!', 'success');
					}).catch(error => {
						if (error.status === 401) {
							updateCloudStatus('ğŸ” × ×“×¨×© ×—×™×‘×•×¨ ××—×“×©', '× ×•×ª×§');
							showToast('âš ï¸ ×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×”×§×‘×œ×” × ×©××¨×” ××§×•××™×ª ×‘×œ×‘×“', 'warning');
							access_token = null;
						} else {
							updateCloudStatus('âš ï¸ ×©×’×™××” ×‘×©××™×¨×”', '×©×’×™××”');
							showToast('âš ï¸ ×”×§×‘×œ×” × ×©××¨×” ××§×•××™×ª, ××‘×œ ×œ× ×”×¦×œ×™×—×” ×œ×©××•×¨ ×‘×¢× ×Ÿ', 'warning');
						}
					});
				} else {
					updateCloudStatus('ğŸ” ×©×™× ×•×™×™× ×œ× × ×©××¨×• ×‘×¢× ×Ÿ', '××§×•××™');
					showToast('ğŸ” ×§×‘×œ×” × ×©××¨×” ××§×•××™×ª - ×”×ª×—×‘×¨ ×œ×¢× ×Ÿ ×œ×©××™×¨×” ××œ××”', 'warning');
				}
				
				// ×¢×“×›×Ÿ ×ª×¦×•×’×”
				loadReceiptsTable();
				closeEditModal();
				
			} catch (error) {
				console.error('Error updating receipt:', error);
				updateCloudStatus('âŒ ×©×’×™××” ×‘××¢×¨×›×ª', '×©×’×™××”');
				showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×§×‘×œ×”', 'error');
			}
		}

		// ×”×—×œ×£ ××ª saveEditedVisit ×‘×¤×•× ×§×¦×™×” ×–×•:
		async function saveEditedVisit(visitId) {
			console.log(`âœ… saveEditedVisit ('${visitId}')`);
			const visitIndex = visits.findIndex(v => v.ID == visitId);
			if (visitIndex === -1) {
				showToast('×‘×™×§×•×¨ ×œ× × ××¦×', 'error');
				return;
			}
			
			try {
				// ×¢×“×›×Ÿ ××ª ×”×‘×™×§×•×¨ ×‘××¢×¨×š ×”××§×•××™
				const updatedVisit = {
					...visits[visitIndex], // ×©××•×¨ × ×ª×•× ×™× ×§×™×™××™×
					date: document.getElementById('editVisitDate').value,
					visit_type: document.getElementById('editVisitType').value,
					work_done: document.getElementById('editWorkDone').value,
					duration_minutes: parseInt(document.getElementById('editDuration').value) || 0,
					start_time: document.getElementById('editStartTime').value,
					amount: parseFloat(document.getElementById('editAmount').value) || 0,
					expense: parseFloat(document.getElementById('editExpense').value) || 0,
					paid: document.getElementById('editPaid').value,
					notes: document.getElementById('editNotes').value
				};
				
				visits[visitIndex] = updatedVisit;
				
				// ×©××•×¨ ××§×•××™×ª ×ª××™×“
				saveToLocalStorage();
				updateCloudStatus('ğŸ’¾ ×©×•××¨ ×‘×™×§×•×¨...', '××¢×“×›×Ÿ');
				
				// × ×¡×” ×œ×©××•×¨ ×‘×¢× ×Ÿ
				if (access_token && SPREADSHEET_ID) {
					try {
						await updateVisitInCloud(updatedVisit);
						updateCloudStatus('âœ… ××—×•×‘×¨ ×•××¡×•× ×›×¨×Ÿ', '× ×©××¨');
						showToast('×‘×™×§×•×¨ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×” ×‘××¢×¨×›×ª ×•×‘×¢× ×Ÿ!', 'success');
					} catch (error) {
						if (error.status === 401) {
							updateCloudStatus('ğŸ” × ×“×¨×© ×—×™×‘×•×¨ ××—×“×©', '× ×•×ª×§');
							showToast('âš ï¸ ×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×”×‘×™×§×•×¨ × ×©××¨ ××§×•××™×ª ×‘×œ×‘×“', 'warning');
							access_token = null;
						} else {
							updateCloudStatus('âš ï¸ ×©×’×™××” ×‘×©××™×¨×”', '×©×’×™××”');
							showToast('âš ï¸ ×”×‘×™×§×•×¨ × ×©××¨ ××§×•××™×ª, ××‘×œ ×œ× ×”×¦×œ×™×— ×œ×©××•×¨ ×‘×¢× ×Ÿ', 'warning');
						}
					}
				} else {
					updateCloudStatus('ğŸ” ×©×™× ×•×™×™× ×œ× × ×©××¨×• ×‘×¢× ×Ÿ', '××§×•××™');
					showToast('ğŸ” ×‘×™×§×•×¨ × ×©××¨ ××§×•××™×ª - ×”×ª×—×‘×¨ ×œ×¢× ×Ÿ ×œ×©××™×¨×” ××œ××”', 'warning');
				}
				
				// ×¢×“×›×Ÿ ×ª×¦×•×’×”
				applyVisitFilters();
				closeEditModal();
				
			} catch (error) {
				console.error('Error updating visit:', error);
				updateCloudStatus('âŒ ×©×’×™××” ×‘××¢×¨×›×ª', '×©×’×™××”');
				showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×‘×™×§×•×¨', 'error');
			}
		}

		// ×”×—×œ×£ ××ª connectToGoogleSheets ×‘×¤×•× ×§×¦×™×” ×–×•:
		async function connectToGoogleSheets() {
			try {
				console.log('Connecting to Google Sheets...');
				updateCloudStatus('ğŸ”— ××ª×—×‘×¨...', '××ª×—×‘×¨');
				showToast('××ª×—×‘×¨ ×œ-Google Sheets...', 'info');
				
				const tokenClient = google.accounts.oauth2.initTokenClient({
					client_id: CLIENT_ID,
					scope: SCOPES,
					callback: async (response) => {
						access_token = response.access_token;
						
						// ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡
						updateCloudStatus('âœ… ××—×•×‘×¨ ×•××¡×•× ×›×¨×Ÿ', '×”×ª×—×‘×¨');
						document.getElementById('statusText').classList.add('connected');
						document.getElementById('saveBtn').disabled = false;
						document.getElementById('loadBtn').disabled = false;
						
						showToast('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×” ×œ-Google Sheets!', 'success');
						
						// ××¦×™××” ××• ×™×¦×™×¨×ª ×”×˜×‘×œ×” ×”×¨××©×™×ª
						await findOrCreateMainSpreadsheet();
						
						// ×˜×¢×™× ×” ××•×˜×•××˜×™×ª ×©×œ × ×ª×•× ×™× ×× ×§×™×™××™×
						if (SPREADSHEET_ID) {
							try {
								await loadAllDataFromSheets();
							} catch (error) {
								console.log('Could not auto-load data:', error);
							}
						}
					},
				});
				
				tokenClient.requestAccessToken();
				
			} catch (error) {
				console.error('Error connecting to Google Sheets:', error);
				updateCloudStatus('âŒ ×©×’×™××” ×‘×—×™×‘×•×¨', '×©×’×™××”');
				showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ-Google Sheets', 'error');
			}
		}

		// ×”×—×œ×£ ××ª saveAllToSheets ×‘×¤×•× ×§×¦×™×” ×–×•:
		async function saveAllToSheets() {
			if (!await validateToken()) {
				showToast('××™×Ÿ ×—×™×‘×•×¨ ×œ×’×•×’×œ - ×©××™×¨×” ××§×•××™×ª ×‘×œ×‘×“', 'warning');
				return;
			}
			
			try {
				updateCloudStatus('×©×•××¨ × ×ª×•× ×™× ×œ×¢× ×Ÿ...', '××¢×“×›×Ÿ');
				
				// ×©××™×¨×” ×‘×‘××¦'×™× (×œ× ×œ×•×œ××•×ª!)
				const savePromises = [];
				
				if (locations.length > 0) {
					showToast(`×©×•××¨ ${locations.length} ×œ×§×•×—×•×ª ×‘×‘×ª ××—×ª...`, 'info', 2000);
					savePromises.push(saveLocationsBatch(locations));
				}
				
				if (visits.length > 0) {
					showToast(`×©×•××¨ ${visits.length} ×‘×™×§×•×¨×™× ×‘×‘×ª ××—×ª...`, 'info', 2000);
					savePromises.push(saveVisitsBatch(visits));
				}
				
				if (receipts.length > 0) {
					showToast(`×©×•××¨ ${receipts.length} ×§×‘×œ×•×ª ×‘×‘×ª ××—×ª...`, 'info', 2000);
					savePromises.push(saveReceiptsBatch(receipts));
				}
				
				// ×”××ª×Ÿ ×œ×›×œ ×”×©××™×¨×•×ª ×‘××§×‘×™×œ
				await Promise.all(savePromises);
				
				updateCloudStatus('××—×•×‘×¨ ×•××¡×•× ×›×¨×Ÿ', '× ×©××¨');
				showToast(`×›×œ ×”× ×ª×•× ×™× × ×©××¨×• ×‘×¢× ×Ÿ ×‘×”×¦×œ×—×”!`, 'success', 3000);
				
			} catch (error) {
				console.error('Error saving all data to cloud:', error);
				updateCloudStatus('×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ', '×©×’×™××”');
				showToast('×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ - ×”× ×ª×•× ×™× × ×©××¨×• ××§×•××™×ª', 'error');
			}
		}

		// ×”×•×¡×£ ××ª ×¤×•× ×§×¦×™×™×ª updateCloudStatus ×”×—×“×©×”:
		function updateCloudStatus(status, lastAction) {
			const statusElement = document.getElementById('statusText');
			const lastSavedElement = document.getElementById('lastSaved');
			
			if (statusElement) {
				statusElement.textContent = status;
				
				// ×¢×“×›×•×Ÿ ×¦×‘×¢×™× ×œ×¤×™ ×¡×˜×˜×•×¡
				if (status.includes('××—×•×‘×¨') || status.includes('××¡×•× ×›×¨×Ÿ')) {
					statusElement.style.color = '#28a745'; // ×™×¨×•×§
					statusElement.style.fontWeight = 'bold';
					statusElement.style.background = 'transparent'; // ×”×¡×¨ ×¨×§×¢
					statusElement.classList.add('connected');
				} else if (status.includes('×©×•××¨') || status.includes('××¢×“×›×Ÿ')) {
					statusElement.style.color = '#ffc107'; // ×¦×”×•×‘
					statusElement.style.fontWeight = 'bold';
				} else if (status.includes('×©×’×™××”')) {
					statusElement.style.color = '#dc3545'; // ××“×•×
					statusElement.style.fontWeight = 'bold';
					statusElement.classList.remove('connected');
				} else if (status.includes('× ×“×¨×© ×—×™×‘×•×¨')) {
					statusElement.style.color = '#fd7e14'; // ×›×ª×•×
					statusElement.style.fontWeight = 'bold';
					statusElement.classList.remove('connected');
				}
			}
			
			// ×¢×“×›×•×Ÿ ×–××Ÿ ×¤×¢×•×œ×” ××—×¨×•× ×”
			if (lastSavedElement && lastAction) {
				lastSavedElement.textContent = `${lastAction}: ${new Date().toLocaleTimeString('he-IL')}`;
				//lastSavedElement.style.color = //'#333'; // ×¦×‘×¢ ×›×”×” ×™×•×ª×¨
			}
		}
	   
	   
	   
	   //////////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	   
	   
	   function formatDateForSheets(dateString) {
			if (!dateString) return '';
			const date = new Date(dateString);
			const day = String(date.getDate()).padStart(2, '0');
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const year = date.getFullYear();
			return `${day}/${month}/${year}`;
		}
	   
	   
   </script>
</body>
</html>
