<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×˜×™×¤×•×œ×™× ×•×œ×§×•×—×•×ª</title>
	
	<script src="https://apis.google.com/js/api.js"></script>
	<script src="https://accounts.google.com/gsi/client"></script>
	
    <style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			direction: rtl;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}

		/* Header ××¢×•×¦×‘ */
		.header {
			background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
			border-radius: 15px;
			padding: 30px;
			margin-bottom: 20px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.3);
			color: white;
		}

		.header h1 {
			font-size: 2.5em;
			margin-bottom: 10px;
			text-align: center;
			text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
			background: linear-gradient(45deg, #3498db, #2ecc71);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}

		/* Connection Status ××¢×•×¦×‘ */
		.connection-status {
			text-align: center;
			margin: 20px 0;
			padding: 20px;
			background: rgba(255,255,255,0.1);
			border-radius: 15px;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255,255,255,0.2);
		}

		.connect-btn {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 12px 24px;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			margin: 5px;
			transition: all 0.3s ease;
			box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
		}

		.connect-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
		}

		.connect-btn:disabled {
			background: #95a5a6;
			cursor: not-allowed;
			transform: none;
		}

		/* Navigation ××¢×•×¦×‘ */
		.nav-buttons {
			display: flex;
			gap: 15px;
			justify-content: center;
			flex-wrap: wrap;
			margin-top: 20px;
		}

		.nav-btn {
			padding: 15px 25px;
			border: none;
			background: rgba(255,255,255,0.1);
			color: white;
			border-radius: 10px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255,255,255,0.2);
		}

		.nav-btn:hover {
			background: rgba(255,255,255,0.2);
			transform: translateY(-2px);
		}

		.nav-btn.active {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
			transform: translateY(-2px);
		}

		/* Main Content ××¢×•×¦×‘ */
		.main-content {
			background: rgba(255,255,255,0.95);
			border-radius: 15px;
			padding: 30px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.2);
			backdrop-filter: blur(10px);
		}

		.section {
			display: none;
		}

		.section.active {
			display: block;
		}

		.section h2 {
			color: #2c3e50;
			margin-bottom: 30px;
			padding-bottom: 15px;
			border-bottom: 3px solid #3498db;
			font-size: 1.8em;
			position: relative;
		}

		.section h2::before {
			content: '';
			position: absolute;
			bottom: -3px;
			left: 0;
			width: 60px;
			height: 3px;
			background: linear-gradient(45deg, #e74c3c, #f39c12);
			border-radius: 2px;
		}

		/* Forms ××¢×•×¦×‘×™× */
		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			margin-bottom: 8px;
			color: #2c3e50;
			font-weight: bold;
			font-size: 14px;
		}

		.form-group input, .form-group select, .form-group textarea {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #e9ecef;
			border-radius: 8px;
			font-size: 14px;
			transition: all 0.3s ease;
			background: white;
		}

		.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
			transform: translateY(-1px);
		}

		/* Buttons ××¢×•×¦×‘×™× */
		.add-btn {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
			border: none;
			padding: 15px 30px;
			border-radius: 10px;
			cursor: pointer;
			margin-bottom: 20px;
			font-size: 16px;
			font-weight: bold;
			transition: all 0.3s ease;
			box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
		}

		.add-btn:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
		}

		.action-btn {
			padding: 8px 16px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 12px;
			margin: 0 3px;
			transition: all 0.3s ease;
			font-weight: bold;
		}

		.edit-btn {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
		}

		.edit-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
		}

		.delete-btn {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			color: white;
		}

		.delete-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
		}

		/* Tables ××¢×•×¦×‘×•×ª */
		.table-container {
			background: white;
			border-radius: 12px;
			overflow: hidden;
			box-shadow: 0 8px 25px rgba(0,0,0,0.15);
			margin-top: 20px;
		}

		.data-table {
			width: 100%;
			border-collapse: collapse;
			background: white;
		}

		.data-table thead {
			background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
			color: white;
		}

		.data-table th {
			padding: 15px 12px;
			text-align: right;
			font-weight: bold;
			border-bottom: 2px solid #3498db;
		}

		.data-table td {
			padding: 12px;
			border-bottom: 1px solid #ecf0f1;
			transition: background 0.3s ease;
		}

		.data-table tbody tr:hover {
			background: #f8f9fa;
			transform: scale(1.01);
		}

		.data-table tbody tr:nth-child(even) {
			background: #fbfcfd;
		}

		/*************************/
		/* Filter Panels ××¢×•×¦×‘×™× */
		
		.filter-panel-unified {
			background: #f8f9fa;
			padding: 15px;
			border-radius: 8px;
			margin-bottom: 20px;
			border: 1px solid #e9ecef;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}

		.filter-panel-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 15px;
			padding-bottom: 10px;
			border-bottom: 1px solid #dee2e6;
		}

		.filter-panel-title {
			font-size: 14px;
			font-weight: bold;
			color: #2c3e50;
			margin: 0;
		}

		.filter-row-unified {
			display: flex;
			gap: 15px;
			align-items: center;
			flex-wrap: wrap;
			margin-bottom: 10px;
		}

		.filter-row-unified:last-child {
			margin-bottom: 0;
		}

		.filter-group-unified {
			flex: 1;
			min-width: 150px;
		}

		.filter-group-unified.compact {
			flex: 0 0 120px;
		}

		.filter-group-unified.small {
			flex: 0 0 100px;
		}

		.filter-group-unified.medium {
			flex: 0 0 140px;
		}

		.filter-group-unified label {
			font-size: 12px;
			font-weight: bold;
			margin-bottom: 5px;
			display: block;
			color: #495057;
		}

		.filter-group-unified input,
		.filter-group-unified select {
			width: 100%;
			padding: 8px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 13px;
			background: white;
			transition: border-color 0.3s ease;
		}

		.filter-group-unified input:focus,
		.filter-group-unified select:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
		}

		.filter-clear-btn {
			background: #e74c3c;
			color: white;
			border: none;
			padding: 8px 12px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 12px;
			font-weight: bold;
			transition: all 0.3s ease;
		}

		.filter-clear-btn:hover {
			background: #c0392b;
			transform: translateY(-1px);
		}

		/* Mobile responsiveness */
		@media (max-width: 768px) {
			.filter-row-unified {
				flex-direction: column;
				gap: 10px;
			}
			
			.filter-group-unified,
			.filter-group-unified.compact,
			.filter-group-unified.small,
			.filter-group-unified.medium {
				flex: none;
				min-width: auto;
				width: 100%;
			}
			
			.filter-panel-header {
				flex-direction: column;
				gap: 10px;
				text-align: center;
			}
		}
		/***********************/

		/* Submit Button ××¢×•×¦×‘ */
		button[type="submit"] {
			width: 100%;
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 18px;
			border-radius: 10px;
			cursor: pointer;
			font-size: 18px;
			font-weight: bold;
			margin-top: 20px;
			transition: all 0.3s ease;
			box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
		}

		button[type="submit"]:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
		}

		/* Mobile Responsive */
		@media (max-width: 768px) {
			.container {
				padding: 10px;
			}
			
			.header {
				padding: 20px 15px;
			}
			
			.header h1 {
				font-size: 1.8em;
			}
			
			.nav-buttons {
				gap: 8px;
			}
			
			.nav-btn {
				padding: 12px 16px;
				font-size: 12px;
			}
			
			.main-content {
				padding: 20px 15px;
			}
		}

		/* Toast Notifications */
		.toast-container {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 1000;
			max-width: 300px;
		}

		.toast {
			background: linear-gradient(45deg, #2c3e50, #3498db);
			color: white;
			padding: 15px 20px;
			border-radius: 8px;
			margin-bottom: 10px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
			transform: translateX(400px);
			opacity: 0;
			transition: all 0.3s ease;
			border-right: 4px solid #27ae60;
			font-weight: bold;
		}

		.toast.success {
			border-right-color: #27ae60;
			background: linear-gradient(45deg, #27ae60, #2ecc71);
		}

		.toast.error {
			border-right-color: #e74c3c;
			background: linear-gradient(45deg, #e74c3c, #c0392b);
		}

		.toast.warning {
			border-right-color: #f39c12;
			background: linear-gradient(45deg, #f39c12, #e67e22);
		}

		.toast.info {
			border-right-color: #3498db;
			background: linear-gradient(45deg, #3498db, #2980b9);
		}

		.toast.show {
			transform: translateX(0);
			opacity: 1;
		}

		@media (max-width: 768px) {
			.toast-container {
				left: 10px;
				right: 10px;
				top: 10px;
				max-width: none;
			}
			
			.toast {
				transform: translateY(-100px);
			}
			
			.toast.show {
				transform: translateY(0);
			}
		}
		

		/* ×›×¤×ª×•×¨×™× ×›×œ×œ×™×™× */
		.btn {
			padding: 12px 20px;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			box-shadow: 0 3px 10px rgba(0,0,0,0.2);
			min-width: 120px;
		}

		.btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(0,0,0,0.3);
		}

		.btn-primary {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
		}

		.btn-success {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
		}

		.btn-warning {
			background: linear-gradient(45deg, #f39c12, #e67e22);
			color: white;
		}

		.btn-secondary {
			background: linear-gradient(45deg, #95a5a6, #7f8c8d);
			color: white;
		}

		.btn-info {
			background: linear-gradient(45deg, #17a2b8, #138496);
			color: white;
		}


		/* ×¨×©×™××•×ª × ×¤×ª×—×•×ª */
		select, .form-group select {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			cursor: pointer;
			min-height: 45px;
		}

		select:focus, .form-group select:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		select:hover {
			border-color: #7f8c8d;
			background: white;
		}

		/* ×©×“×•×ª ×ª××¨×™×š */
		input[type="date"] {
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			min-height: 45px;
		}

		input[type="date"]:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		
		/* ×›×¤×ª×•×¨×™ ×™×™×‘×•× ×‘××¢×¨×›×ª */
		.form-section .btn {
			margin: 8px 5px;
			padding: 12px 20px;
			font-size: 14px;
			font-weight: bold;
			min-width: 150px;
		}

		/* ×©×™×¤×•×¨ × ×•×¡×£ ×œ×›×¤×ª×•×¨×™× ×§×˜× ×™× */
		.action-btn {
			padding: 10px 16px;
			font-size: 13px;
			font-weight: bold;
			min-width: 80px;
		}

		/* ×›×¤×ª×•×¨×™× ××•×§×¤×¦×™× (disabled) */
		button:disabled, .btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none !important;
			box-shadow: none !important;
		}

		/* ×©×™×¤×•×¨ ×œ×ª×™×‘×•×ª ×˜×§×¡×˜ */
		input[type="text"], input[type="number"], textarea {
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			min-height: 45px;
		}

		input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		/* ×©×™×¤×•×¨ ×œ×›×•×ª×¨×•×ª ×‘×¤×× ×œ×™× */
		.filter-header h3, .info-header h3 {
			font-size: 16px;
			font-weight: bold;
			margin: 0;
			text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
		}

		/* ××•×‘×™×™×œ - ×”×ª×××•×ª */
		@media (max-width: 768px) {
			.btn {
				padding: 10px 15px;
				font-size: 13px;
				min-width: 100px;
			}
			
			select, input[type="date"], input[type="text"], input[type="number"] {
				padding: 10px 12px;
				font-size: 13px;
				min-height: 40px;
			}
		}
		
		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
		}

		.stat-item {
			background: rgba(255,255,255,0.7);
			padding: 15px;
			border-radius: 8px;
			border-left: 4px solid #27ae60;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			backdrop-filter: blur(5px);
		}

		.stat-label {
			display: block;
			font-weight: bold;
			color: #495057;
			margin-bottom: 5px;
			font-size: 14px;
		}

		.stat-value {
			font-size: 1.4em;
			font-weight: bold;
			color: #2c3e50;
		}

		@media (max-width: 768px) {
			.stats-grid {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		.debt-card .summary-value {
			color: #e74c3c !important;
			font-weight: bold;
		}

		.debts-table tr:hover {
			background-color: #f8f9fa !important;
		}

		.action-btn {
			margin: 1px;
			padding: 4px 8px;
			font-size: 12px;
			border-radius: 3px;
			border: none;
			color: white;
			cursor: pointer;
		}

		.action-btn:hover {
			opacity: 0.8;
		}

		#statusText {
			transition: all 0.3s ease;
			padding: 8px 12px;
			border-radius: 6px;
			font-size: 14px;
		}

		#statusText.connected {
			background: linear-gradient(45deg, #28a745, #20c997);
			color: white;
			box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
		}


		/* ×ª×¦×•×’×ª ×ª×›× ×•×Ÿ - ×©×•×¨×•×ª ×›×¤×•×œ×•×ª */
			.planning-cards-container {
				min-height: 300px;
				border: 2px dashed #ddd;
				border-radius: 10px;
				padding: 15px;
				background: #fafafa;
				margin-bottom: 20px;
			}

			.planning-client-row {
				background: white;
				border-radius: 8px;
				margin-bottom: 12px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
				transition: all 0.3s ease;
			}

			.planning-client-row:hover {
				transform: translateY(-1px);
				box-shadow: 0 4px 8px rgba(0,0,0,0.15);
			}

			/***************************************************************/	
			/* ×¦×‘×¢×™ ×¨××–×•×¨ */
			/* ×¦×‘×¢×™ ×¡×˜×˜×•×¡ ××©×•×¤×¨×™× ×œ×ª×›× ×•×Ÿ */
			.planning-status-green { 
				border-right: 4px solid #27ae60;
				background: linear-gradient(90deg, rgba(39, 174, 96, 0.1), white);
			}

			.planning-status-yellow { 
				border-right: 4px solid #f39c12;
				background: linear-gradient(90deg, rgba(243, 156, 18, 0.1), white);
			}

			.planning-status-orange { 
				border-right: 4px solid #e67e22;
				background: linear-gradient(90deg, rgba(230, 126, 34, 0.1), white);
			}

			.planning-status-red { 
				border-right: 4px solid #e74c3c;
				background: linear-gradient(90deg, rgba(231, 76, 60, 0.1), white);
			}

			.planning-status-gray {
				border-right: 4px solid #95a5a6;
				background: linear-gradient(90deg, rgba(149, 165, 166, 0.1), white);
			}

			/* ×›×¤×ª×•×¨ ×”×ª×—×œ ×˜×™×¤×•×œ ××¢×•×¦×‘ */
			.planning-complete {
				background: linear-gradient(45deg, #27ae60, #2ecc71);
				color: white;
				font-size: 14px;
				font-weight: bold;
				width: 36px;
				height: 36px;
			}

			.planning-complete:hover {
				background: linear-gradient(45deg, #219a52, #27ae60);
				transform: scale(1.05);
			}

			/* ×¢×™×¦×•×‘ ××©×•×¤×¨ ×œ×›×•×ª×¨×•×ª ×™×•× ×‘×©×‘×•×¢ */
			.weekly-day-header {
				background: linear-gradient(45deg, #3498db, #2980b9);
				color: white;
				padding: 12px 15px;
				border-radius: 8px;
				margin-bottom: 12px;
				font-size: 15px;
				font-weight: bold;
				text-align: center;
				box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
			}
			
			
			
			
			/****************************************************************/
			.planning-row-main {
				display: flex;
				align-items: center;
				padding: 12px 15px;
				gap: 15px;
			}

			.planning-client-info {
				flex: 1;
				text-align: right;
			}

			.planning-client-name {
				font-weight: bold;
				font-size: 16px;
				color: #333;
				margin-bottom: 3px;
			}

			.planning-client-address {
				font-size: 12px;
				color: #666;
				margin-bottom: 3px;
			}

			.planning-client-date {
				font-size: 12px;
				color: #555;
				font-weight: 500;
			}

			.planning-client-price {
				font-weight: bold;
				color: #2196F3;
				font-size: 16px;
				min-width: 80px;
				text-align: center;
			}

			.planning-client-actions {
				display: flex;
				gap: 8px;
			}

			.planning-action-btn {
				width: 32px;
				height: 32px;
				border: none;
				border-radius: 50%;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 12px;
				transition: all 0.3s ease;
			}

			
			.planning-postpone {
				background: #FF9800;
				color: white;
			}

			.planning-menu {
				background: #607D8B;
				color: white;
			}

			.planning-action-btn:hover {
				transform: scale(1.1);
			}

			.planning-row-details {
				background: #f8f9fa;
				padding: 8px 15px 12px 15px;
				border-top: 1px solid #e9ecef;
				font-size: 13px;
			}

			.client-requests {
				color: #0066cc;
				margin-bottom: 4px;
				font-weight: 500;
			}

			.client-notes {
				color: #666;
				font-style: italic;
			}

			/* ××•×‘×™×™×œ */
			@media (max-width: 768px) {
				.planning-row-main {
					flex-direction: column;
					align-items: stretch;
					gap: 10px;
				}
				
				.planning-client-info {
					text-align: center;
				}
				
				.planning-client-actions {
					justify-content: center;
				}
				
				.planning-action-btn {
					width: 40px;
					height: 40px;
					font-size: 14px;
				}
			}

			/* ×©××¨ ×”×¡×˜×™×™×œ×™× ×”×§×™×™××™× × ×©××¨×™× */
			
			.planning-tab-btn.active {
				background: #3498db; /* ×©×™× ×•×™ ××™×¨×•×§ ×œ×›×—×•×œ */
				color: white;
				border-color: #3498db;
			}

			.planning-view-tabs {
				display: flex;
				justify-content: center;
				gap: 10px;
				margin-bottom: 20px;
			}

			.planning-tab-btn {
				padding: 10px 20px;
				border: 2px solid #ddd;
				background: white;
				border-radius: 25px;
				cursor: pointer;
				transition: all 0.3s ease;
				font-weight: bold;
			}


		/***************************************/
		/* ×™×™×‘×•× × ×ª×•× ×™× - ×›×¤×ª×•×¨×™× ××—×™×“×™× */
		.import-main-buttons {
			display: flex;
			justify-content: center;
			gap: 15px;
			margin: 15px 0;
			flex-wrap: wrap;
		}

		.import-other-buttons {
			display: flex;
			justify-content: center;
			margin: 15px 0;
		}

		.import-main-buttons button,
		.import-other-buttons button {
			padding: 12px 20px;
			background: #ffc107;
			color: #212529;
			border: 1px solid #ffc107;
			border-radius: 5px;
			font-weight: 500;
			font-size: 14px;
			cursor: pointer;
			transition: all 0.3s ease;
			min-width: 200px;
			white-space: nowrap;
		}

		.import-main-buttons button:hover,
		.import-other-buttons button:hover {
			background: #e0a800;
			border-color: #d39e00;
			transform: translateY(-1px);
			box-shadow: 0 4px 8px rgba(0,0,0,0.15);
		}

		/* ×›×¤×ª×•×¨×™ ×”×™×™×‘×•× ×”×—×œ×§×™ */
		details[open] > div {
			display: flex !important;
			flex-wrap: wrap;
			gap: 8px;
			margin-top: 10px;
			justify-content: center;
		}

		details[open] > div button {
			flex: 1;
			min-width: 120px;
			max-width: 150px;
			font-size: 13px;
			padding: 10px 12px;
		}

		/* ×ª×’×•×‘×” ×œ××•×‘×™×™×œ */
		@media (max-width: 768px) {
			.import-main-buttons {
				flex-direction: column;
				align-items: center;
			}
			
			.import-main-buttons button,
			.import-other-buttons button {
				min-width: 80%;
				max-width: 300px;
				padding: 15px 20px;
				font-size: 16px;
			}
			
			details[open] > div {
				flex-direction: column;
			}
			
			details[open] > div button {
				min-width: 80%;
				max-width: 250px;
				font-size: 14px;
			}
		}
		/***************************************/

		/* ×¡×˜×™×™×œ×™× ×’ ×œ××¦×‘ ×©×‘×•×¢×™ */
		.weekly-day-section {
			margin-bottom: 25px;
		}

		.planning-empty-state {
			text-align: center;
			color: #666;
			padding: 40px 20px;
		}

		.planning-empty-state h3 {
			margin-bottom: 10px;
			color: #4CAF50;
		}


/***************************************/
/***************************************/

		/* ×¢×“×›×•×Ÿ CSS ×œ×›×¨×˜×™×¡×™×•×ª ×ª×›× ×•×Ÿ - ××‘× ×” ×“×•-×©×•×¨×ª×™ */
		.planning-row-details {
			background: #f8f9fa;
			padding: 8px 15px 12px 15px;
			border-top: 1px solid #e9ecef;
			font-size: 13px;
		}

		.client-requests {
			color: #0066cc;
			margin-bottom: 4px;
			font-weight: 500;
		}

		.client-notes {
			color: #666;
			font-style: italic;
		}

		.planning-active-toggle {
			margin-right: 5px;
		}

		.planning-history-btn {
			background: #6c757d;
			color: white;
			border: none;
			padding: 6px 10px;
			border-radius: 4px;
			font-size: 11px;
			cursor: pointer;
		}

		.planning-history-btn:hover {
			background: #5a6268;
		}

/***************************************/

		/* ×ª×™×§×•×Ÿ CSS ×œ×›×¤×ª×•×¨×™ ×”×¤×¢×•×œ×” ×”×—×“×©×™× */
		.planning-client-actions {
			display: flex;
			gap: 5px;
			align-items: center;
			flex-wrap: wrap;
		}

		.planning-date-input {
			padding: 4px 6px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 11px;
			width: 100px;
			background: white;
		}

		.planning-active-toggle {
			padding: 4px 6px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 11px;
			background: white;
			width: 70px;
		}

		.planning-history-btn {
			background: #6c757d;
			color: white;
			border: none;
			padding: 6px 8px;
			border-radius: 4px;
			font-size: 11px;
			cursor: pointer;
			min-width: 35px;
		}

		.planning-history-btn:hover {
			background: #5a6268;
		}

		
		/* ×˜××‘×™ ×™××™× */
		.days-tabs-container {
			margin-bottom: 20px;
		}

		.days-tabs {
			display: flex;
			gap: 5px;
			margin-bottom: 15px;
			flex-wrap: wrap;
			justify-content: center;
		}

		.day-tab-btn {
			padding: 10px 15px;
			border: 2px solid #ddd;
			background: white;
			border-radius: 20px;
			cursor: pointer;
			font-size: 13px;
			font-weight: bold;
			transition: all 0.3s ease;
			min-width: 100px;
		}

		.day-tab-btn:hover {
			background: #f8f9fa;
			border-color: #3498db;
		}

		.day-tab-btn.active {
			background: #3498db;
			color: white;
			border-color: #3498db;
		}

		.days-content {
			min-height: 200px;
		}

		.day-content {
			display: none;
		}

		.day-content.active {
			display: block;
		}
		
		
		/* ×ª×’×•×‘×” ×œ××•×‘×™×™×œ ×œ×˜××‘×™ ×™××™× */
		@media (max-width: 768px) {
			.days-tabs {
				flex-direction: column;
				align-items: center;
				gap: 8px;
			}
			
			.day-tab-btn {
				min-width: 80%;
				max-width: 250px;
				padding: 12px 20px;
				font-size: 14px;
			}
			
			.days-content {
				min-height: 150px;
			}
		}

		/* ×× ×™××¦×™×” ×—×œ×§×” ×œ×ª×•×›×Ÿ ×”×™××™× */
		.day-content {
			opacity: 0;
			transition: opacity 0.3s ease;
		}

		.day-content.active {
			display: block;
			opacity: 1;
		}

		/* ×©×™×¤×•×¨ ×œ×›×•×ª×¨×ª ×”××›×™×œ */
		.days-tabs-container {
			background: rgba(255,255,255,0.7);
			border-radius: 12px;
			padding: 15px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
		}

		.week-btn {
			background: #28a745;
			color: white;
			border: none;
			padding: 4px 6px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 10px;
			margin-left: 2px;
		}

		.week-btn:hover {
			background: #218838;
			transform: scale(1.05);
		}

		.week-btn-double {
			background: #17a2b8;
		}

		.week-btn-double:hover {
			background: #138496;
		}


		/* Notes row styles */
		.notes-row {
			background-color: #f8f9fa;
			border-top: none !important;
		}

		.notes-cell {
			padding: 8px 15px !important;
			border-top: 1px dashed #dee2e6 !important;
		}

		.notes-content {
			font-size: 13px;
			color: #495057;
			font-style: italic;
			background: #e9ecef;
			padding: 8px 12px;
			border-radius: 6px;
			border-left: 4px solid #6c757d;
		}

		/* Button styles */
		.btn {
			padding: 8px 16px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 12px;
			font-weight: bold;
			transition: all 0.3s ease;
		}

		.btn-secondary {
			background: #6c757d;
			color: white;
		}

		.btn-secondary:hover {
			background: #5a6268;
			transform: translateY(-1px);
		}

		/****************************/
		
		/* Payment status indicators */
		.payment-status-1 {
			color: #27ae60;
			font-weight: bold;
			background: #d5f4e6;
			padding: 2px 6px;
			border-radius: 4px;
			font-size: 12px;
		}

		.payment-status-0 {
			color: #e74c3c;
			font-weight: bold;
			background: #fadbd8;
			padding: 2px 6px;
			border-radius: 4px;
			font-size: 12px;
		}

		.payment-status-2 {
			color: #f39c12;
			font-weight: bold;
			background: #fef5e7;
			padding: 2px 6px;
			border-radius: 4px;
			font-size: 12px;
		}

		/* Performance optimization - reduce animations on large tables */
		.data-table tbody tr {
			transition: none; /* ×”×¡×¨ ×× ×™××¦×™×•×ª ×‘×˜×‘×œ××•×ª ×’×“×•×œ×•×ª */
		}

		.data-table tbody tr:hover {
			background: #f8f9fa;
			transform: none; /* ×”×¡×¨ scale effect ×©×’×•×¨× ×œ××™×˜×™×•×ª */
		}

		/* Loading indicator */
		.loading-indicator {
			text-align: center;
			padding: 20px;
			color: #666;
			font-style: italic;
		}

		.loading-indicator::before {
			content: "â³ ";
		}

		/* Quick filter buttons */
		.filter-quick-btn {
			background: #3498db;
			color: white;
			border: none;
			padding: 6px 10px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 11px;
			font-weight: bold;
			transition: all 0.3s ease;
			margin-right: 4px;
		}

		.filter-quick-btn:hover {
			background: #2980b9;
			transform: translateY(-1px);
		}

		.filter-quick-btn.active {
			background: #27ae60;
		}

		.filter-quick-btn.active:hover {
			background: #219a52;
		}


		.payment-btn {
			background: #28a745;
			color: white;
			border: none;
			padding: 4px 8px;
			border-radius: 3px;
			cursor: pointer;
			margin-right: 5px;
			font-size: 14px;
		}

		.payment-btn:hover {
			background: #218838;
		}

		/* ×¢×™×¦×•×‘ ×—×œ×•× ×™×ª ×ª×©×œ×•× */
			
		.visits-list {
			max-height: 250px;
			overflow-y: auto;
			border: 2px solid #ddd;
			border-radius: 8px;
			padding: 0; /* âœ… ×”×¡×¨×ª padding ××”××›×™×œ */
			margin: 10px 0;
			background: #f9f9f9;
		}

		.visit-item {
			display: grid; /* âœ… ×©×™× ×•×™ ×-flex ×œ×’×¨×™×“ */
			grid-template-columns: 40px 1fr 80px; /* âœ… ×¨×•×—×‘×™× ×§×‘×•×¢×™× */
			align-items: center;
			padding: 12px;
			border-bottom: 1px solid #eee;
			cursor: pointer;
			transition: background-color 0.2s;
			border-radius: 0; /* âœ… ×‘×™×˜×•×œ border-radius ×¤× ×™××™ */
			margin-bottom: 0; /* âœ… ×‘×™×˜×•×œ margin */
			gap: 10px; /* âœ… ×¨×•×•×— ×§×‘×•×¢ ×‘×™×Ÿ ×”×¢××•×“×•×ª */
		}

		.visit-item:hover {
			background: #f0f0f0;
		}

		.visit-item:last-child {
			border-bottom: none;
		}

		.visit-checkbox {
			width: 18px; /* âœ… ×¨×•×—×‘ ×§×‘×•×¢ */
			height: 18px; /* âœ… ×’×•×‘×” ×§×‘×•×¢ */
			margin: 0; /* âœ… ×‘×™×˜×•×œ margin */
			cursor: pointer;
			justify-self: center; /* âœ… ××¨×›×– ×‘×ª× ×”×’×¨×™×“ */
		}

		.visit-details {
			line-height: 1.4;
			min-width: 0; /* âœ… ×××¤×©×¨ word-wrap */
		}

		.visit-details div:first-child {
			font-weight: bold;
			color: #2c3e50;
			margin-bottom: 2px;
		}

		.visit-details div:last-child {
			font-size: 12px;
			color: #666;
			white-space: nowrap; /* âœ… ××•× ×¢ ×©×‘×™×¨×ª ×©×•×¨×” */
			overflow: hidden;
			text-overflow: ellipsis; /* âœ… × ×§×•×“×•×ª ×× ×”×˜×§×¡×˜ ××¨×•×š ××“×™ */
		}

		.visit-amount {
			font-weight: bold;
			color: #27ae60;
			text-align: left;
			font-size: 15px;
			justify-self: start; /* âœ… ×™×™×©×•×¨ ×œ×©×××œ ×‘×ª× ×”×’×¨×™×“ */
		}

		/* ×ª×’×•×‘×” ×œ××•×‘×™×™×œ */
		@media (max-width: 600px) {
			.visit-item {
				grid-template-columns: 35px 1fr 70px; /* âœ… ×§×¦×ª ×™×•×ª×¨ ×§×˜×Ÿ ×‘××•×‘×™×™×œ */
				padding: 10px;
				gap: 8px;
			}
			
			.visit-checkbox {
				width: 16px;
				height: 16px;
			}
			
			.visit-amount {
				font-size: 14px;
			}
			
			.visit-details div:first-child {
				font-size: 13px;
			}
			
			.visit-details div:last-child {
				font-size: 11px;
			}
		}

		.form-row {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 15px;
			margin-bottom: 15px;
		}

		.form-group {
			display: flex;
			flex-direction: column;
		}

		.form-group label {
			margin-bottom: 5px;
			font-weight: bold;
			color: #333;
		}

		#paymentDetailsSection {
			background: #f8f9fa;
			padding: 15px;
			border-radius: 8px;
			margin-top: 15px;
		}

		.payment-status-select {
			padding: 4px 8px;
			border: 1px solid #ddd;
			border-radius: 3px;
			font-size: 12px;
			background: white;
			cursor: pointer;
			min-width: 100px;
		}

		.payment-status-select:focus {
			outline: none;
			border-color: #007bff;
			box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
		}



		.client-option {
			padding: 10px;
			cursor: pointer;
			border-bottom: 1px solid #eee;
		}

		.client-option:hover {
			background-color: #f8f9fa;
		}

		.client-option:last-child {
			border-bottom: none;
		}

		/* ×¢×™×¦×•×‘ ×©×•×¨×•×ª ×¤×¨×˜×™× */
		.details-row {
			background-color: #f8f9fa !important;
			border-top: none !important;
		}

		.details-row:hover {
			background-color: #f1f3f4 !important;
		}

		.details-cell {
			padding: 10px 15px !important;
			border-top: 1px dashed #dee2e6 !important;
		}

		.details-content {
			font-size: 13px;
			color: #495057;
			line-height: 1.4;
		}

		.work-done-column {
		  width: 350px; /* ×¨×•×—×‘ ×§×‘×•×¢ */
		  max-width: 350px; /* ×œ×•×•×“× ×©×œ× ×¢×•×‘×¨ ××ª ×”×¨×•×—×‘ ×”×–×” */
		  overflow: hidden; /* ×”×¡×ª×¨×ª ×˜×§×¡×˜ ×—×•×¨×’ */
		  text-overflow: ellipsis; /* ×”×•×¡×¤×ª '...' ×‘×¡×•×£ ×× ×”×˜×§×¡×˜ × ×—×ª×š */
		  white-space: nowrap; /* ×œ×× ×•×¢ ×©×‘×™×¨×ª ×©×•×¨×•×ª */
		}

		.work-done-section {
			background: #e3f2fd;
			padding: 8px 12px;
			border-radius: 6px;
			border-left: 4px solid #2196f3;
			margin-bottom: 8px;
		}

		.notes-section {
			background: #fff3e0;
			padding: 8px 12px;
			border-radius: 6px;
			border-left: 4px solid #ff9800;
			font-style: italic;
		}

		.work-done-section strong,
		.notes-section strong {
			color: #2c3e50;
			font-size: 12px;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		/* ×©×™×¤×•×¨ ×œ×˜×‘×œ×” ×”×¨××©×™×ª */
		.data-table tbody tr.main-row {
			border-bottom: 1px solid #e9ecef;
		}

		.data-table tbody tr.details-row {
			border-bottom: 2px solid #dee2e6;
		}

		/* ××•×¤×˜×™××™×–×¦×™×” ×œ××•×‘×™×™×œ */
		@media (max-width: 768px) {
			.details-content {
				font-size: 12px;
			}
			
			.work-done-section,
			.notes-section {
				padding: 6px 8px;
				margin-bottom: 6px;
			}
		}

		/* ×ª×™×§×•×Ÿ z-index ×œ×—×œ×•× ×™×ª ×”×ª×©×œ×•× */
		#paymentModal {
			position: fixed !important;
			top: 0 !important;
			left: 0 !important;
			width: 100% !important;
			height: 100% !important;
			background: rgba(0,0,0,0.7) !important;
			display: flex !important;
			justify-content: center !important;
			align-items: center !important;
			z-index: 99999 !important; /* ×’×‘×•×” ×××•×“! */
			backdrop-filter: blur(3px);
		}

		#paymentModal .modal-content {
			background: white !important;
			border-radius: 12px !important;
			max-width: 600px !important;
			width: 90vw !important;
			max-height: 85vh !important;
			overflow-y: auto !important;
			position: relative !important;
			z-index: 100000 !important; /* ×¢×•×“ ×™×•×ª×¨ ×’×‘×•×”! */
			box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important;
		}

		/* ×•×™×“×•× ×©×’× ×”×—×œ×•× ×™×•×ª ×”××—×¨×•×ª ×™×¢×‘×“×• */
		#editModal {
			z-index: 99998 !important;
		}

		#telegramModal {
			z-index: 99997 !important;
		}

		/* ×”×¡×ª×¨×ª scroll ×©×œ ×”×’×•×£ ×›×©×—×œ×•× ×™×ª ×¤×ª×•×—×” */
		body.modal-open {
			overflow: hidden;
		}

		/* ×¢×™×¦×•×‘ ×©×•×¨×•×ª ×¤×¨×˜×™× ×‘×˜×‘×œ×ª ×”×˜×™×¤×•×œ×™× */
		.data-table tbody tr.main-row {
			border-bottom: 1px solid #e9ecef;
		}

		.data-table tbody tr.details-row {
			background-color: #f8f9fa !important;
			border-top: none !important;
			border-bottom: 2px solid #dee2e6;
		}

		.data-table tbody tr.details-row:hover {
			background-color: #f1f3f4 !important;
		}

		.details-cell {
			padding: 10px 15px !important;
			border-top: 1px dashed #dee2e6 !important;
		}

		.details-content {
			font-size: 13px;
			color: #495057;
			line-height: 1.4;
		}

		.work-done-section {
			background: #e3f2fd;
			padding: 8px 12px;
			border-radius: 6px;
			border-left: 4px solid #2196f3;
			margin-bottom: 8px;
		}

		.notes-section {
			background: #fff3e0;
			padding: 8px 12px;
			border-radius: 6px;
			border-left: 4px solid #ff9800;
			font-style: italic;
		}

		.work-done-section strong,
		.notes-section strong {
			color: #2c3e50;
			font-size: 12px;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		/* Badges ×œ×¡×•×’×™ ×˜×™×¤×•×œ */
		.visit-type-badge {
			padding: 4px 8px;
			border-radius: 12px;
			font-size: 11px;
			font-weight: bold;
			text-transform: uppercase;
		}

		.visit-type-××œ× {
			background: #d4edda;
			color: #155724;
		}

		.visit-type-×—×œ×§×™ {
			background: #fff3cd;
			color: #856404;
		}

		.visit-type-×‘×™×§×•×¨×ª {
			background: #d1ecf1;
			color: #0c5460;
		}

		.visit-type-other {
			background: #f8d7da;
			color: #721c24;
		}

		.duration-badge {
			background: #e7f3ff;
			color: #0366d6;
			padding: 2px 6px;
			border-radius: 8px;
			font-size: 11px;
			font-weight: bold;
		}

		/* ××•×¤×˜×™××™×–×¦×™×” ×œ××•×‘×™×™×œ */
		@media (max-width: 768px) {
			.details-content {
				font-size: 12px;
			}
			
			.work-done-section,
			.notes-section {
				padding: 6px 8px;
				margin-bottom: 6px;
			}
			
			.visit-type-badge,
			.duration-badge {
				font-size: 10px;
				padding: 2px 4px;
			}
		}

		/* ×ª×™×§×•×Ÿ ×—×™×•× ×™ - ×”×—×œ×•× ×™×ª ×¦×¨×™×›×” ×œ×”×™×•×ª ××•×¡×ª×¨×ª ×›×‘×¨×™×¨×ª ××—×“×œ */
		#paymentModal {
			position: fixed !important;
			top: 0 !important;
			left: 0 !important;
			width: 100% !important;
			height: 100% !important;
			background: rgba(0,0,0,0.7) !important;
			display: none !important; /* âœ… ×©×™× ×•×™ ×§×¨×™×˜×™ - none ×‘××§×•× flex! */
			justify-content: center !important;
			align-items: center !important;
			z-index: 99999 !important;
			backdrop-filter: blur(3px);
		}

		/* ×›×©×”×—×œ×•× ×™×ª ×¤×ª×•×—×” - ××– ×ª×”×™×” flex */
		#paymentModal.show {
			display: flex !important;
		}


		/* ×©×™×¤×•×¨×™× × ×•×¡×¤×™× ×œ×—×œ×•× ×™×ª ×”×ª×©×œ×•× */
		.payment-summary {
			background: #e8f5e8;
			border: 2px solid #27ae60;
			border-radius: 8px;
			padding: 15px;
			margin: 15px 0;
			text-align: center;
			font-size: 16px;
			color: #155724;
		}

		.visits-list {
			max-height: 250px;
			overflow-y: auto;
			border: 2px solid #ddd;
			border-radius: 8px;
			padding: 10px;
			margin: 10px 0;
			background: #f9f9f9;
		}

		.visit-item {
			display: flex;
			align-items: center;
			padding: 10px;
			border-bottom: 1px solid #eee;
			cursor: pointer;
			transition: background-color 0.2s;
			border-radius: 6px;
			margin-bottom: 5px;
		}

		.visit-item:hover {
			background: #f0f0f0;
		}

		.visit-item:last-child {
			border-bottom: none;
			margin-bottom: 0;
		}

		.visit-checkbox {
			margin-left: 10px;
			transform: scale(1.3);
			cursor: pointer;
		}

		.visit-details {
			flex: 1;
			margin: 0 15px;
			line-height: 1.4;
		}

		.visit-amount {
			font-weight: bold;
			color: #27ae60;
			min-width: 80px;
			text-align: left;
			font-size: 15px;
		}

		.client-dropdown {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			background: white;
			border: 2px solid #3498db;
			border-top: none;
			max-height: 200px;
			overflow-y: auto;
			z-index: 1000;
			border-radius: 0 0 8px 8px;
			box-shadow: 0 4px 8px rgba(0,0,0,0.1);
		}

		.client-option {
			padding: 12px;
			cursor: pointer;
			border-bottom: 1px solid #eee;
			transition: background-color 0.2s;
		}

		.client-option:hover {
			background: #f8f9fa;
		}

		.client-option:last-child {
			border-bottom: none;
		}

		/* ×©×™×¤×•×¨ ×›×¤×ª×•×¨×™× */
		.btn:hover {
			transform: translateY(-1px);
			box-shadow: 0 4px 8px rgba(0,0,0,0.2);
		}

		.btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none !important;
			box-shadow: none !important;
		}

		/* ===== ×¢×™×¦×•×‘ ××©×•×¤×¨ ×œ×›×¨×˜×™×¡×™×•×ª ×ª×›× ×•×Ÿ ×‘××•×‘×™×™×œ ===== */
		/* ===== ×¢×™×¦×•×‘ ×“×—×•×¡ ×œ××•×‘×™×™×œ ===== */
		@media (max-width: 768px) {
			
			/* ×”×›×¨×˜×™×¡×™×™×” ×”×¨××©×™×ª - ×“×—×•×¡×” */
			.planning-client-row {
				padding: 10px;
				margin-bottom: 8px;
				border-radius: 8px;
				background: white;
				box-shadow: 0 2px 6px rgba(0,0,0,0.1);
			}
			
			/* ×©× ×”×œ×§×•×— - ×§×˜×Ÿ ×™×•×ª×¨ */
			.planning-client-header {
				margin-bottom: 8px;
				padding-bottom: 6px;
				border-bottom: 1px solid #e0e0e0;
			}
			
			.planning-client-name-large {
				font-size: 15px;
				font-weight: 600;
				color: #2c3e50;
				line-height: 1.2;
			}
			
			/* ×”×¡×ª×¨×ª ×©×“×•×ª ×™×©× ×™× */
			.planning-client-info,
			.planning-client-price,
			.planning-client-actions {
				display: none;
			}
			
			/* ×§×˜×¢ ×”×ª××¨×™×›×™× - ×“×—×•×¡ */
			.planning-dates-section {
				margin-bottom: 8px;
				padding: 6px 8px;
				background: #f8f9fa;
				border-radius: 6px;
			}
			
			.planning-date-item {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 4px;
				padding: 2px 0;
			}
			
			.planning-date-item:last-child {
				margin-bottom: 0;
			}
			
			.date-label {
				font-size: 13px;
				color: #666;
				font-weight: 500;
			}
			
			.date-value {
				font-size: 14px;
				font-weight: 600;
				color: #2c3e50;
			}
			
			/* ×¡×›×•× - ×§×˜×Ÿ */
			.planning-amount-small {
				font-size: 12px;
				color: #999;
				text-align: center;
				margin-top: 4px;
				padding-top: 4px;
				border-top: 1px solid #e9ecef;
			}
			
			/* ×©×•×¨×ª ×›×¤×ª×•×¨×™× - ×“×—×•×¡×” */
			.planning-actions-row {
				display: flex;
				gap: 6px;
				margin-bottom: 8px;
			}
			
			.week-btn-mobile {
				flex: 1;
				padding: 8px 10px;
				background: #28a745;
				color: white;
				border: none;
				border-radius: 5px;
				font-size: 13px;
				font-weight: 600;
				cursor: pointer;
			}
			
			.week-btn-mobile:active {
				transform: scale(0.95);
			}
			
			.profile-btn-mobile {
				background: #6c757d;
				color: white;
				border: none;
				padding: 8px 12px;
				border-radius: 5px;
				font-size: 16px;
				cursor: pointer;
			}

			.profile-btn-mobile:active {
				transform: scale(0.95);
				background: #5a6268;
			}
			
			.active-checkbox-mobile {
				display: flex;
				align-items: center;
				justify-content: center;
				padding: 8px;
				background: #f8f9fa;
				border: 1px solid #ddd;
				border-radius: 5px;
				cursor: pointer;
			}
			
			.active-checkbox-mobile input[type="checkbox"] {
				width: 20px;
				height: 20px;
				margin: 0;
				cursor: pointer;
			}
			
			.active-checkbox-mobile span {
				display: none; /* ×”×¡×ª×¨×ª ×”×˜×§×¡×˜ */
			}
			
			/* ×©×•×¨×ª ×ª××¨×™×š ×•×”×ª×—×œ×” */
			.planning-date-row {
				display: flex;
				gap: 6px;
				align-items: center;
			}
			
			.planning-date-input-mobile {
				flex: 1;
				padding: 8px;
				border: 1px solid #ddd;
				border-radius: 5px;
				font-size: 13px;
			}
			
			.start-btn-mobile {
				width: 40px;
				height: 40px;
				background: linear-gradient(45deg, #27ae60, #2ecc71);
				color: white;
				border: none;
				border-radius: 50%;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 16px;
				transition: all 0.3s ease;
				box-shadow: 0 2px 6px rgba(39, 174, 96, 0.4);
			}

			.start-btn-mobile:active {
				transform: scale(0.95);
				background: linear-gradient(45deg, #219a52, #27ae60);
			}
			
			/* ×”×¢×¨×•×ª - ×§×˜× ×•×ª */
			.planning-row-details {
				margin-top: 8px;
				padding-top: 8px;
				border-top: 1px solid #e0e0e0;
			}
			
			.client-requests,
			.client-notes {
				padding: 6px;
				margin-bottom: 4px;
				background: #fff3cd;
				border-left: 3px solid #ffc107;
				border-radius: 4px;
				font-size: 12px;
				line-height: 1.3;
			}
			
			.client-notes {
				background: #d1ecf1;
				border-left-color: #17a2b8;
			}
		}

	

	</style>
   
</head>
<body>
	<!-- Toast Container -->
	<div id="toastContainer" class="toast-container"></div>
    <div class="container">
        <header class="header">
            <h1>×˜×™×¤×•×œ×™×</h1>
			<div id="connectionStatus" class="connection-status">
				<button onclick="connectToGoogleSheets()" id="connectBtn" class="connect-btn">
					×”×ª×—×‘×¨ ×œ-Google Sheets
				</button>
				<button onclick="saveAllToSheets()" id="saveBtn" class="connect-btn" disabled>
					×©××•×¨ ×œ×¢× ×Ÿ
				</button>
				<button onclick="loadAllFromSheets()" id="loadBtn" class="connect-btn" disabled>
					×˜×¢×Ÿ ××”×¢× ×Ÿ
				</button>
				<span id="statusText" style="color: white; font-weight: bold; font-size: 16px;">×œ× ××—×•×‘×¨</span>
				<div id="lastSaved" style="font-size: 12px; color: white; margin-top: 4px;"></div>
			</div>
           <nav class="nav-buttons">
				<button onclick="showSection('planning')" class="nav-btn active">×ª×›× ×•×Ÿ</button>
				<button onclick="showSection('history')" class="nav-btn">×˜×™×¤×•×œ×™×</button> 
				<button onclick="showSection('locations')" class="nav-btn">×œ×§×•×—×•×ª</button>
				<button onclick="showSection('receipts')" class="nav-btn">×§×‘×œ×•×ª</button>
				<button onclick="showSection('debts')" class="nav-btn">ğŸ’° ×—×•×‘×•×ª</button>
				<button onclick="showSection('payments')" class="nav-btn">ğŸ’³ ×ª×©×œ×•××™×</button>
				<button onclick="showSection('system')" class="nav-btn">××¢×¨×›×ª v2.1</button>
				
				<!-- Client selector - only visible when locked -->
				<button onclick="toggleClientLock()" class="nav-btn lock-btn" id="lockBtn" title="× ×¢×™×œ×ª ×¡×™× ×›×¨×•×Ÿ ×œ×§×•×—×•×ª">
					ğŸ”“
				</button>
				<select id="lockClientSelector" onchange="selectClientForLock(this.value)" style="display: none; padding: 8px; border: 2px solid #28a745; border-radius: 5px; background: #d4edda; color: #155724; font-size: 13px; min-width: 150px;">
					<option value="">×‘×—×¨ ×œ×§×•×—...</option>
				</select>
			</nav>
        </header>

        <main class="main-content">
            <!-- Planning Section -->
			<section id="planning" class="section active">
				<h2>ğŸ“… ×ª×›× ×•×Ÿ ×™×•××™ ×•×©×‘×•×¢×™</h2>
				
           <!-- ××¦×‘ ×™×•× ×¢×‘×•×“×” -->
			<div class="work-day-section" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #28a745; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
				<h3 style="margin: 0 0 15px 0; color: #28a745; font-size: 18px; display: flex; align-items: center; gap: 8px;">
					ğŸƒâ€â™‚ï¸ ×”×˜×™×¤×•×œ×™× ×©×œ×™ ×”×™×•×
					<span id="todayWorkStatus" style="font-size: 14px; color: #666; font-weight: normal;"></span>
				</h3>
				
				<div id="todayTreatmentsContainer">
					<!-- ×”×˜×™×¤×•×œ×™× ×©×œ ×”×™×•× ×™×•×›× ×¡×• ×›××Ÿ ×“×™× ××™×ª -->
				</div>
				
				<div style="text-align: center; margin-top: 15px;">
					<button onclick="refreshTodayTreatments()" class="btn" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
						ğŸ”„ ×¨×¢× ×Ÿ
					</button>
				</div>
			</div>
			
            <!-- ×˜××‘×™× -->
            <div class="planning-view-tabs">
				<button class="planning-tab-btn active" onclick="switchPlanningView('daily')">×™×•××™</button>
				<button class="planning-tab-btn" onclick="switchPlanningView('weekly')">×©×‘×•×¢×™</button>
				<button class="planning-tab-btn" onclick="switchPlanningView('overdue')">×××—×¨×•×ª</button>
				<button class="planning-tab-btn" onclick="switchPlanningView('future')">×¢×ª×™×“×™×™×</button>
			</div>

            <!-- ×›×¨×˜×™×¡×™ ×œ×§×•×—×•×ª -->
            <div class="planning-cards-container" id="planningCardsContainer">
                <!-- ×›×¨×˜×™×¡×™× ×™×˜×¢× ×• ×›××Ÿ ×“×™× ××™×ª -->
            </div>

            <!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª (×©××™×¨×” ×¢×œ ×”×§×™×™×) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                <div style="background: rgba(52, 152, 219, 0.1); border: 2px solid #3498db; border-radius: 8px; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 13px; color: #2c3e50;">×œ×§×•×—×•×ª:</span>
                        <span id="totalLocations" style="font-weight: bold; color: #2c3e50;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 13px; color: #2c3e50;">×¤×¢×™×œ×™×:</span>
                        <span id="activeLocations" style="font-weight: bold; color: #27ae60;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: #2c3e50;">×˜×™×¤×•×œ×™× ×”×©×‘×•×¢:</span>
                        <span id="weeklyVisits" style="font-weight: bold; color: #2c3e50;">0</span>
                    </div>
                </div>
                
                <div style="background: rgba(39, 174, 96, 0.1); border: 2px solid #27ae60; border-radius: 8px; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 13px; color: #2c3e50;">×”×›× ×¡×” ×”×©×‘×•×¢:</span>
                        <span id="weeklyIncome" style="font-weight: bold; color: #27ae60;">â‚ª0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: #2c3e50;">×—×•×‘×•×ª ×¤×ª×•×—×™×:</span>
                        <span id="openDebts" style="font-weight: bold; color: #e74c3c;">â‚ª0</span>
                    </div>
                </div>
            </div>
			</section>

			<!-- History Section -->
			<section id="history" class="section">
				<h2>ğŸ“‹ ×˜×™×¤×•×œ×™×</h2>
					<div style="display: flex; gap: 10px; margin-bottom: 20px;">
						<button onclick="showAddTreatmentForm()" class="add-btn">â• ×”×•×¡×£ ×˜×™×¤×•×œ ×—×“×©</button>
						<button onclick="showAddPaymentModal()" class="add-btn" style="background: linear-gradient(45deg, #f39c12, #e67e22);">ğŸ’° ×ª×©×œ×•× ×—×“×©</button>
					</div>
				<!-- Filter Panel -->
				<div class="filter-panel-unified">
					<div class="filter-panel-header">
						<h4 class="filter-panel-title">ğŸ” ×¡×™× ×•×Ÿ ×˜×™×¤×•×œ×™×</h4>
						<div style="display: flex; gap: 8px;">
							<button onclick="setQuickDateFilter('today')" class="filter-quick-btn">×”×™×•×</button>
							<button onclick="setQuickDateFilter('week')" class="filter-quick-btn">×”×©×‘×•×¢</button>
							<button onclick="setQuickDateFilter('month')" class="filter-quick-btn active">×”×—×•×“×©</button>
							<button onclick="clearVisitFilters()" class="filter-clear-btn">× ×§×” ×¡×™× ×•×Ÿ</button>
						</div>
					</div>
					
					<div class="filter-row-unified">
						<div class="filter-group-unified">
							<label>×—×™×¤×•×© ×—×›×:</label>
							<input type="text" id="visitSmartSearch" placeholder="×—×¤×© ×œ×§×•×— ×œ×¤×™ ×©×, ×›×ª×•×‘×ª, ×¢×™×¨..." 
								   oninput="handleVisitSmartSearch(this.value)">
						</div>
						<div class="filter-group-unified small">
							<button type="button" onclick="clearVisitSmartSearch()" class="filter-clear-btn">× ×§×” ×—×™×¤×•×©</button>
						</div>
						<div class="filter-group-unified medium">
							<label>×¡×˜×˜×•×¡ ×ª×©×œ×•×:</label>
							<select id="filterPayment">
								<option value="">×”×›×œ</option>
								<option value="×›×Ÿ">×©×•×œ×</option>
								<option value="×œ×">×œ× ×©×•×œ×</option>
								<option value="×œ×œ×">×œ×œ× ×ª×©×œ×•×</option>
							</select>
						</div>
						<div class="filter-group-unified small">
							<label>××§×¡×™××•× ×ª×•×¦××•×ª:</label>
							<select id="maxResults" onchange="applyVisitFilters()">
								<option value="50">50</option>
								<option value="100">100</option>
								<option value="200" selected>200</option>
								<option value="500">500</option>
							</select>
						</div>
					</div>
					
					<div class="filter-row-unified">
						<div class="filter-group-unified compact">
							<label>××ª××¨×™×š:</label>
							<input type="date" id="filterDateFrom" onchange="applyVisitFilters()">
						</div>
						<div class="filter-group-unified compact">
							<label>×¢×“ ×ª××¨×™×š:</label>
							<input type="date" id="filterDateTo" onchange="applyVisitFilters()">
						</div>
						<div class="filter-group-unified small">
							<label>×”×¦×’ ×œ×§×•×—×•×ª:</label>
							<select id="filterActiveClients" onchange="applyVisitFilters()">
								<option value="1" selected>×¤×¢×™×œ×™× ×‘×œ×‘×“</option>
								<option value="">×›×œ ×”×œ×§×•×—×•×ª</option>
								<option value="0">×œ× ×¤×¢×™×œ×™×</option>
							</select>
						</div>
					</div>
				</div>

				<!-- Treatments Stats Box -->
				<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
					<div id="treatmentsStatsBox" style="background: #e8f5e8; border: 1px solid #27ae60; border-radius: 6px; padding: 8px 12px; font-size: 13px; color: #2c3e50;">
						<span id="treatmentsCount">0</span> ×˜×™×¤×•×œ×™× ××•×¦×’×™×
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #27ae60; font-weight: bold;" id="treatmentsTotal">â‚ª0</span> ×¡×”"×› ×”×›× ×¡×•×ª
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #3498db; font-weight: bold;" id="treatmentsPaid">0</span> ×©×•×œ××•
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #e74c3c; font-weight: bold;" id="treatmentsUnpaid">0</span> ×œ× ×©×•×œ××•
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #ff6b35; font-weight: bold;" id="treatmentsDebts">â‚ª0</span> ×—×•×‘×•×ª ×¤×ª×•×—×™×
					</div>
				</div>

				<!-- Visits Table -->
				<div class="table-container">
					<table id="visitsHistoryTable" class="data-table">
						<thead>
							<tr>
								<th>×ª××¨×™×š</th>
								<th>×œ×§×•×—</th>
								<th class="work-done-column">×¡×•×’ ×˜×™×¤×•×œ</th>
								<th>××” ×‘×•×¦×¢</th>
								<th>××©×š</th>
								<th>×¡×›×•×</th>
								<th>×©×•×œ×</th>
								<th>×¤×¢×•×œ×•×ª</th>
							</tr>
						</thead>
						<tbody id="visitsHistoryTableBody">
						</tbody>
					</table>
				</div>
			</section>

            <!-- locations Section -->
            <section id="locations" class="section">
                <h2>× ×™×”×•×œ ×œ×§×•×—×•×ª</h2>
				<!-- ×¤×× ×œ ×¡×™× ×•×Ÿ -->
				<div class="filter-panel-compact" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
					<div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
						<div style="flex: 1; min-width: 150px;">
							<label style="font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block;">×©× ×œ×§×•×—:</label>
							<input type="text" id="filterClientName" placeholder="×—×¤×© ×œ×§×•×—..." onkeyup="filterLocationsTable()" 
								   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
						</div>
						
						<div style="flex: 0 0 120px;">
							<label style="font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block;">×™×•× ××•×¢×“×£:</label>
							<select id="filterDay" onchange="filterLocationsTable()" 
									style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
								<option value="">×›×œ ×”×™××™×</option>
								<option value="×›×œ ×™×•×">×›×œ ×™×•×</option>
								<option value="×">× (×¨××©×•×Ÿ)</option>
								<option value="×‘">×‘ (×©× ×™)</option>
								<option value="×’">×’ (×©×œ×™×©×™)</option>
								<option value="×“">×“ (×¨×‘×™×¢×™)</option>
								<option value="×”">×” (×—××™×©×™)</option>
								<option value="×•">×• (×©×™×©×™)</option>
								<option value="×©">×© (×©×‘×ª)</option>
							</select>
						</div>
						
						<div style="flex: 0 0 100px;">
							<label style="font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block;">××¨×•×•×— ×©×‘×•×¢×•×ª:</label>
							<select id="filterInterval" onchange="filterLocationsTable()" 
									style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
								<option value="">×”×›×œ</option>
								<option value="1">1</option>
								<option value="2">2</option>
								<option value="4">4</option>
								<option value="8">8</option>
								<option value="12">12</option>
								<option value="52">52</option>
							</select>
						</div>
						
						<div style="flex: 0 0 100px;">
							<label style="font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block;">×¡×˜×˜×•×¡:</label>
							<select id="filterActive" onchange="filterLocationsTable()" 
									style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
								<option value="">×”×›×œ</option>
								<option value="1" selected>×¤×¢×™×œ</option>
								<option value="0">×œ× ×¤×¢×™×œ</option>
							</select>
						</div>
						
						<div style="flex: 0 0 80px;">
							<button onclick="clearLocationFilters()" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 20px;">
								× ×§×” ×¡×™× ×•×Ÿ
							</button>
						</div>
					</div>
				</div>
				<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
					<button onclick="showAddLocationForm()" class="add-btn">×”×•×¡×£ ×œ×§×•×— ×—×“×©</button>
					
					<div id="locationsStatsBox" style="background: #e8f4fd; border: 1px solid #3498db; border-radius: 6px; padding: 8px 12px; font-size: 13px; color: #2c3e50;">
						<span id="locationsCount">0</span> ×œ×§×•×—×•×ª ××•×¦×’×™×
						<span style="margin-right: 10px; color: #666;">|</span>
						<span style="color: #27ae60; font-weight: bold;" id="activeCount">0</span> ×¤×¢×™×œ×™×
						<span style="margin-right: 10px; color: #666;">|</span>
						<span style="color: #e74c3c; font-weight: bold;" id="inactiveCount">0</span> ×œ× ×¤×¢×™×œ×™×
					</div>
				</div>
                <div class="table-container">
                    <table id="locationsTable" class="data-table">
                        <thead>
							<tr>
								<th>×©×</th>
								<th>×›×ª×•×‘×ª</th>
								<th>××™×© ×§×©×¨</th>
								<th>×™×•× ××•×ª×¨</th>
								<th>××¨×•×•×—</th>
								<th>×¤×¢×™×œ</th>
								<th>×˜×™×¤×•×œ ×§×•×“×</th>
								<th>×˜×™×¤×•×œ ×”×‘×</th>
								<th>×”×¢×¨×•×ª</th>
								<th>×¤×¢×•×œ×•×ª</th>
							</tr>
						</thead>
                        <tbody id="locationsTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Receipts Section -->
            <section id="receipts" class="section">
                <h2>× ×™×”×•×œ ×§×‘×œ×•×ª</h2>
                <button onclick="showAddReceiptForm()" class="add-btn">×”×•×¡×£ ×§×‘×œ×” ×—×“×©×”</button>
				<!-- Filter Panel for Receipts -->
				<!-- Unified Filter Panel for Receipts -->
				<div class="filter-panel-unified">
					<div class="filter-panel-header">
						<h4 class="filter-panel-title">ğŸ” ×¡×™× ×•×Ÿ ×§×‘×œ×•×ª</h4>
						<button onclick="clearReceiptFilters()" class="filter-clear-btn">× ×§×” ×¡×™× ×•×Ÿ</button>
					</div>
					
					<div class="filter-row-unified">
						<div class="filter-group-unified">
							<label>×—×™×¤×•×© ×—×›×:</label>
							<input type="text" id="receiptSmartSearch" placeholder="×—×¤×© ×œ×§×•×— ×œ×¤×™ ×©×, ×›×ª×•×‘×ª, ×¢×™×¨..." 
								   oninput="handleReceiptSmartSearch(this.value)">
						</div>
						<div class="filter-group-unified small">
							<button type="button" onclick="clearReceiptSmartSearch()" class="filter-clear-btn">× ×§×” ×—×™×¤×•×©</button>
						</div>
					</div>

					<div class="filter-row-unified">
						<div class="filter-group-unified medium">
							<label>×¤× ×§×¡ ×§×‘×œ×•×ª:</label>
							<select id="filterReceiptBook" onchange="applyReceiptFilters()">
								<option value="">×›×œ ×”×¤× ×§×¡×™×</option>
							</select>
						</div>
						<div class="filter-group-unified medium">
							<label>×¡×•×’ ×ª×©×œ×•×:</label>
							<select id="filterPaymentType" onchange="applyReceiptFilters()">
								<option value="">×›×œ ×”×¡×•×’×™×</option>
								<option value="××–×•××Ÿ">××–×•××Ÿ</option>
								<option value="×”×¢×‘×¨×”">×”×¢×‘×¨×”</option>
								<option value="×¦'×§">×¦'×§</option>
								<option value="×›×¨×˜×™×¡ ××©×¨××™">×›×¨×˜×™×¡ ××©×¨××™</option>
							</select>
						</div>
					</div>
					
					<div class="filter-row-unified">
						<div class="filter-group-unified compact">
							<label>××ª××¨×™×š:</label>
							<input type="date" id="filterReceiptDateFrom" onchange="applyReceiptFilters()">
						</div>
						<div class="filter-group-unified compact">
							<label>×¢×“ ×ª××¨×™×š:</label>
							<input type="date" id="filterReceiptDateTo" onchange="applyReceiptFilters()">
						</div>
						<div class="filter-group-unified medium">
							<label>××™×•×Ÿ:</label>
							<select id="receiptSortBy" onchange="applyReceiptFilters()">
								<option value="date_desc">×ª××¨×™×š (×—×“×© ×œ×™×©×Ÿ)</option>
								<option value="date_asc">×ª××¨×™×š (×™×©×Ÿ ×œ×—×“×©)</option>
								<option value="amount_desc">×¡×›×•× (×’×‘×•×” ×œ× ××•×š)</option>
								<option value="amount_asc">×¡×›×•× (× ××•×š ×œ×’×‘×•×”)</option>
								<option value="book_asc">×¤× ×§×¡ (×œ×¤×™ ×¡×“×¨)</option>
							</select>
						</div>
					</div>
				</div>
				<!-- Receipt Stats Box -->
				<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
					<div id="receiptsStatsBox" style="background: #e8f4fd; border: 1px solid #3498db; border-radius: 6px; padding: 8px 12px; font-size: 13px; color: #2c3e50;">
						<span id="receiptsCount">0</span> ×§×‘×œ×•×ª ××•×¦×’×•×ª
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #27ae60; font-weight: bold;" id="receiptsTotal">â‚ª0</span> ×¡×”"×›
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #3498db; font-weight: bold;" id="receiptsAverage">â‚ª0</span> ×××•×¦×¢
					</div>
				</div>
                <div class="table-container">
                    <table id="receiptsTable" class="data-table">
						<thead>
							<tr>
								<th>×¤× ×§×¡</th>
								<th>×§×‘×œ×”</th>
								<th>×ª××¨×™×š</th>
								<th>×œ×§×•×—</th>
								<th>×¡×›×•×</th>
								<th>×¡×•×’ ×ª×©×œ×•×</th>
								<th>×§×•×“X</th>
								<th>×¤×¢×•×œ×•×ª</th>
							</tr>
						</thead>
						<tbody id="receiptsTableBody">
						</tbody>
					</table>
                </div>
            </section>

			<section id="debts" class="section">
				<h2>ğŸ’° × ×™×”×•×œ ×—×•×‘×•×ª</h2>
				
				<!-- ×¨×©×™××ª ×—×•×‘×•×ª -->
				<div class="filter-panel-unified">
					<div class="filter-panel-header">
						<h4 class="filter-panel-title">ğŸ” ×—×•×‘×•×ª ×¤×ª×•×—×™×</h4>
						<button onclick="clearDebtFilters()" class="filter-clear-btn">× ×§×” ×¡×™× ×•×Ÿ</button>
					</div>
					
					<div class="filter-row-unified">
						<div class="filter-group-unified medium">
							<label>××™×•×Ÿ ×œ×¤×™:</label>
							<select id="debtSortBy" onchange="displayDebts()">
								<option value="amount_desc">×¡×›×•× (×’×‘×•×” ×œ× ××•×š)</option>
								<option value="amount_asc">×¡×›×•× (× ××•×š ×œ×’×‘×•×”)</option>
								<option value="date_old">×ª××¨×™×š (×”×›×™ ×™×©×Ÿ)</option>
								<option value="date_new">×ª××¨×™×š (×”×›×™ ×—×“×©)</option>
								<option value="location">×œ×§×•×— (×-×ª)</option>
							</select>
						</div>
						<div class="filter-group-unified compact">
							<label>×¡×›×•× ××™× ×™××œ×™:</label>
							<input type="number" id="minDebtAmount" placeholder="0" onchange="displayDebts()">
						</div>
					</div>
					
					<div class="filter-row-unified">
						<div class="filter-group-unified">
							<label>×—×™×¤×•×©/×‘×—×™×¨×ª ×œ×§×•×—:</label>
							<input type="text" 
								   id="debtClientSearch" 
								   list="debtClientOptions"
								   placeholder="×”×§×œ×“ ×©× ×œ×§×•×— ××• ×‘×—×¨ ××”×¨×©×™××”..."
								   onchange="handleDebtClientSelection(this.value)"
								   oninput="filterDebtClientOptions(this.value)"
								   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
							<datalist id="debtClientOptions">
								<!-- Options will be populated by JavaScript -->
							</datalist>
							<button type="button" 
									onclick="clearDebtClientSearch()" 
									style="margin-top: 5px; padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer;">
								× ×§×” ×‘×—×™×¨×”
							</button>
						</div>
						
						<div class="filter-group-unified compact">
							<label>×™×•× ××•×¢×“×£:</label>
							<select id="debtDayFilter" onchange="displayDebts()">
								<option value="">×›×œ ×”×™××™×</option>
								<option value="×›×œ ×™×•×">×›×œ ×™×•×</option>
								<option value="×">× (×¨××©×•×Ÿ)</option>
								<option value="×‘">×‘ (×©× ×™)</option>
								<option value="×’">×’ (×©×œ×™×©×™)</option>
								<option value="×“">×“ (×¨×‘×™×¢×™)</option>
								<option value="×”">×” (×—××™×©×™)</option>
								<option value="×•">×• (×©×™×©×™)</option>
								<option value="×©">×© (×©×‘×ª)</option>
							</select>
						</div>
					</div>
				</div>
				
				<!-- Debts Stats Box -->
				<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
					<div id="debtsStatsBox" style="background: #fdf2e8; border: 1px solid #f39c12; border-radius: 6px; padding: 8px 12px; font-size: 13px; color: #2c3e50;">
						<span id="debtsCount">0</span> ×—×™×™×‘×™× ××•×¦×’×™×
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #e74c3c; font-weight: bold;" id="debtsTotal">â‚ª0</span> ×¡×”"×› ×—×•×‘
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #f39c12; font-weight: bold;" id="debtsAverage">â‚ª0</span> ×××•×¦×¢
					</div>
				</div>
				
				<div class="table-container">
					<table id="debtsTable" class="data-table">
						<thead>
							<tr>
								<th>×œ×§×•×—</th>
								<th>×™×•× ××•×¢×“×£</th>
								<th>×¡×”"×› ×—×•×‘</th>
								<th>××¡' ×˜×™×¤×•×œ×™×</th>
								<th>×”×¢×¨×•×ª ×—×•×‘</th>
								<th>×¤×¢×•×œ×•×ª</th>
							</tr>
						</thead>
						<tbody id="debtsTableBody">
						</tbody>
					</table>
				</div>
			</section>

			<section id="payments" class="section">
				<h2>ğŸ’³ × ×™×”×•×œ ×ª×©×œ×•××™×</h2>
				
				<div class="section-actions" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
					<button onclick="showAddPaymentModal()" class="btn" style="background: #27ae60; color: white; padding: 12px 25px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);">
						â• ×”×•×¡×£ ×ª×©×œ×•× ×—×“×©
					</button>
					<button onclick="showSection('debts')" class="btn" style="background: #e74c3c; color: white; padding: 12px 25px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer;">
						ğŸ’° ×¢×‘×•×¨ ×œ×—×•×‘×•×ª
					</button>
					<p style="color: #666; font-size: 13px; margin: 0; flex: 1; min-width: 200px;">
						ğŸ’¡ ×”×•×¡×£ ×ª×©×œ×•× ×—×“×© ××• ×¢×‘×•×¨ ×œ×—×•×‘×•×ª ×œ× ×™×”×•×œ
					</p>
				</div>
				
				<!-- ×¤×× ×œ ×¡×™× ×•×Ÿ -->
				<!-- ×©×•×¨×” 1: ×—×™×¤×•×© -->
				<div class="filter-row-unified">
					<div class="filter-group-unified">
						<label>×—×™×¤×•×© ×—×›×:</label>
						<input type="text" 
							   id="paymentSmartSearch" 
							   placeholder="×”×§×œ×“ ×©× ×œ×§×•×— ×œ×—×™×¤×•×©..."
							   oninput="handlePaymentSmartSearch(this.value)"
							   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
					</div>
					<div class="filter-group-unified small">
						<button type="button" 
								onclick="clearPaymentSmartSearch()" 
								class="filter-clear-btn">
							× ×§×” ×—×™×¤×•×©
						</button>
					</div>
				</div>

				<!-- ×©×•×¨×” 2: ×ª××¨×™×›×™× -->
				<div class="filter-row-unified">
					<div class="filter-group-unified compact">
						<label>××ª××¨×™×š:</label>
						<input type="date" id="filterPaymentDateFrom"...>
					</div>
					<div class="filter-group-unified compact">
						<label>×¢×“ ×ª××¨×™×š:</label>
						<input type="date" id="filterPaymentDateTo"...>
					</div>
				</div>
				
				<!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª -->
				<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
					<div id="paymentsStatsBox" style="background: #e8f5e8; border: 1px solid #27ae60; border-radius: 6px; padding: 8px 12px; font-size: 13px; color: #2c3e50;">
						<span id="paymentsCount">0</span> ×ª×©×œ×•××™× ××•×¦×’×™×
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #27ae60; font-weight: bold;" id="paymentsTotal">â‚ª0</span> ×¡×”"×›
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #3498db; font-weight: bold;" id="paymentsAverage">â‚ª0</span> ×××•×¦×¢
					</div>
				</div>
				
				<!-- ×˜×‘×œ×ª ×ª×©×œ×•××™× -->
				<div class="table-container">
					<table id="paymentsTable" class="data-table">
						<thead>
							<tr>
								<th>×ª××¨×™×š</th>
								<th>×œ×§×•×—</th>
								<th>×¡×›×•×</th>
								<th>×××¦×¢×™ ×ª×©×œ×•×</th>
								<th>×”×¢×¨×•×ª</th>
								<th>×¤×¢×•×œ×•×ª</th>
							</tr>
						</thead>
						<tbody id="paymentsTableBody">
						</tbody>
					</table>
				</div>
			</section>

			<!-- System Section -->
			<section id="system" class="section">
				<h2>ğŸ› ï¸ ××¢×¨×›×ª</h2>
				
				<!-- Import Section -->
				<div class="form-section">
					<h3>ğŸ“¥ ×™×™×‘×•× × ×ª×•× ×™×</h3>
					
					<div class="import-main-buttons" style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
						<button onclick="createImportTable()" class="btn">
							ğŸ“— ×¦×•×¨ ×˜×‘×œ×ª ×¢×–×¨ ×œ×™×™×‘×•×
						</button>
						<button onclick="importFromHelperTableFast()" class="btn" style="background: #27ae60; color: white;">
							ğŸš€ ×™×™×‘×•× ××”×™×¨ ×•×›×•×œ×œ
						</button>
					</div>
					
					<div style="text-align: center; margin: 15px 0;">
						<span style="color: #666;">××•</span>
					</div>
					
					<div style="text-align: center;">
						<button class="btn btn-warning" onclick="document.getElementById('importFileInput').click()">
							ğŸ“ ×™×™×‘×•× ××”×™×¨ ××§×•×‘×¥
						</button>
						<input type="file" id="importFileInput" accept=".csv,.xlsx" style="display: none;" onchange="handleImportFile(event)">
					</div>
					
					<p style="text-align: center; font-size: 12px; color: #666; margin-top: 15px;">
						×™×™×‘×•× ×œ×§×•×—×•×ª, ×‘×™×§×•×¨×™× ×•×§×‘×œ×•×ª ××§×•×‘×¥ Excel ××• Google Sheets
					</p>
				</div>
				
				<!-- × ×™×”×•×œ × ×ª×•× ×™× -->
				<div class="form-section">
					<h3>ğŸ—‚ï¸ × ×™×”×•×œ × ×ª×•× ×™×</h3>
					
					<div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
						<h4 style="color: #856404; margin-bottom: 10px;">âš ï¸ × ×™×§×•×™ × ×ª×•× ×™×</h4>
						<p style="font-size: 14px; color: #856404; margin-bottom: 10px;">
							× ×§×” ××ª ×›×œ ×”× ×ª×•× ×™× ×”××§×•××™×™× ×œ×¤× ×™ ×™×™×‘×•× ×—×“×© (×œ× ××©×¤×™×¢ ×¢×œ ×”×¢× ×Ÿ)
						</p>
						
						<button class="btn" onclick="clearAllDataBeforeImport()" 
								style="background: #dc3545; color: white; border: none;">
							ğŸ—‘ï¸ × ×§×” ××ª ×›×œ ×”× ×ª×•× ×™× ×”××§×•××™×™×
						</button>
					</div>
					
					<!-- ×¡×˜×˜×•×¡ ×˜×‘×œ×ª ×¢×–×¨ -->
					<div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
						<h4 style="color: #495057; margin-bottom: 10px;">ğŸ“Š ×˜×‘×œ×ª ×¢×–×¨ ×œ×™×™×‘×•×</h4>
						<div id="importTableStatus">
							<span style="font-size: 13px; color: #666;">
								×‘×•×“×§ ×¡×˜×˜×•×¡ ×˜×‘×œ×ª ×¢×–×¨...
							</span>
						</div>
					</div>
				</div>
				
				<!-- Additional System Features -->
				<div class="form-section">
					<h3>âš™ï¸ ×”×’×“×¨×•×ª ××¢×¨×›×ª</h3>
					
					<!-- Cost Settings -->
					<div style="background: rgba(39, 174, 96, 0.1); border: 2px solid #27ae60; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
						<h4 style="color: #27ae60; margin-bottom: 10px;">ğŸ’° ×”×’×“×¨×•×ª ×¢×œ×•×ª ×˜×™×¤×•×œ</h4>
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
							<div class="form-group">
								<label for="hourlyRate">×©×¢×ª ×¢×‘×•×“×” (â‚ª):</label>
								<input type="number" id="hourlyRate" value="150" min="0" onchange="saveCostSettings()">
							</div>
							<div class="form-group">
								<label for="workerCost">×ª×•×¡×¤×ª ×œ×¤×•×¢×œ (â‚ª):</label>
								<input type="number" id="workerCost" value="50" min="0" onchange="saveCostSettings()">
							</div>
						</div>
					</div>
				</div>
			</section>
			
        </main>
    </div>

	<!-- ×—×œ×•× ×™×ª ×ª×©×œ×•× -->

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <script>
		// Google Sheets API Configuration
		const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
		const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
		//let SPREADSHEET_ID = prompt('Enter Spreadsheet ID:') || localStorage.getItem('SPREADSHEET_ID') || '';  // Changed to let
		//let CLIENT_ID = prompt('Enter Client ID:') || localStorage.getItem('CLIENT_ID') || '';  // Changed to let
		//let API_KEY = prompt('Enter API Key:') || localStorage.getItem('API_KEY') || '';  // Changed to let
		let SPREADSHEET_ID = '1fSD5dh0bXRzFSeOZUwJ2bPjGRLqs2crGXPkebz6MpWc';
		let  CLIENT_ID = '1040357646874-4sbkrokgjn4dd7a0e9rkrtjt8d9l3vie.apps.googleusercontent.com';
		let  API_KEY = 'AIzaSyB25ms_UzbgfY9FnduMwMhGhlvwfVPaTg8';
		const SPREADSHEET_NAME = 'service_visits_data';

		// Save for next time
		if (SPREADSHEET_ID) localStorage.setItem('SPREADSHEET_ID', SPREADSHEET_ID);
		if (CLIENT_ID) localStorage.setItem('CLIENT_ID', CLIENT_ID);
		if (API_KEY) localStorage.setItem('API_KEY', API_KEY);

		let gapi_loaded = false;
		let google_loaded = false;
		let access_token = null;
		let spreadsheet_id = SPREADSHEET_ID;
        
        // Sheet names
        const SHEETS = {
			LOCATIONS: 'Locations',
			VISITS: 'Visits',
			RECEIPTS: 'Receipts',
			SETTINGS: 'SystemSettings'
		};

        // Global variables
        let locations = [];
        let visits = [];
        let receipts = [];
        let currentFilter = 'today';
		// ×”×’×“×¨×•×ª ×¢×œ×•×ª
		let costSettings = {
			hourlyRate: 150,
			workerCost: 50
		};


		// Initialize Google APIs
		function initializeGoogleAPIs() {
			gapi.load('client', initializeGapiClient);
			google.accounts.id.initialize({
				client_id: CLIENT_ID,
				callback: handleCredentialResponse,
			});
		}
		
		async function initializeGapiClient() {
			try {
				await gapi.client.init({
					apiKey: API_KEY,
					discoveryDocs: [DISCOVERY_DOC],
				});
				gapi_loaded = true;
				console.log('GAPI client initialized successfully');
			} catch (error) {
				console.error('Error initializing GAPI client:', error);
				showToast('×©×’×™××” ×‘××ª×—×•×œ Google API', 'error');
			}
		}

		function handleCredentialResponse(response) {
			access_token = response.credential;
			showSuccess('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×” ×œ-Google!');
		}


		// Add this function if it's missing or not accessible:
		async function connectToGoogleSheets() {
			try {
				console.log('Connecting to Google Sheets...');
				updateCloudStatus('ğŸ”— ××ª×—×‘×¨...', '××ª×—×‘×¨');
				showToast('××ª×—×‘×¨ ×œ-Google Sheets...', 'info');
				
				const tokenClient = google.accounts.oauth2.initTokenClient({
					client_id: CLIENT_ID,
					scope: SCOPES,
					callback: async (response) => {
						access_token = response.access_token;
						
						// ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡
						updateCloudStatus('âœ… ××—×•×‘×¨ ×•××¡×•× ×›×¨×Ÿ', '×”×ª×—×‘×¨');
						document.getElementById('statusText').classList.add('connected');
						document.getElementById('saveBtn').disabled = false;
						document.getElementById('loadBtn').disabled = false;
						
						showToast('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×” ×œ-Google Sheets!', 'success');
						
						// ××¦×™××” ××• ×™×¦×™×¨×ª ×”×˜×‘×œ×” ×”×¨××©×™×ª
						await findOrCreateMainSpreadsheet();

						// ×•×“× ×©×›×œ ×”×˜×‘×œ××•×ª ×”×—×“×©×•×ª ×§×™×™××•×ª
						await checkAndFixTableStructure();

						// ×˜×¢×™× ×” ××•×˜×•××˜×™×ª ×©×œ × ×ª×•× ×™× ×× ×§×™×™××™×
						if (SPREADSHEET_ID) {
							try {
								await loadAllFromSheets();
							} catch (error) {
								console.log('Could not auto-load data:', error);
							}
						}
					},
				});
				
				tokenClient.requestAccessToken();
				
			} catch (error) {
				console.error('Error connecting to Google Sheets:', error);
				updateCloudStatus('âŒ ×©×’×™××” ×‘×—×™×‘×•×¨', '×©×’×™××”');
				showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ-Google Sheets', 'error');
			}
		}


		// Single comprehensive loading function
		async function loadAllFromSheets() {
			// Validate connection first
			if (!await validateToken()) {
				showToast('××™×Ÿ ×—×™×‘×•×¨ ×œ×’×•×’×œ - ×˜×•×¢×Ÿ × ×ª×•× ×™× ××§×•××™×™×', 'warning');
				return false;
			}
			
			showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™× ×-Google Sheets...');
			
			try {
				// Core data loading (required)
				await loadCoreData();
				
				// Optional data loading (non-critical)
				await loadOptionalData();
				
				// Update all UI components
				updateAllUIComponents();
				
				// Success feedback
				hideLoading();
				showSuccess('× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” ××”×¢× ×Ÿ!');
				
				// Schedule post-load tasks
				schedulePostLoadTasks();
				
				return true;
				
			} catch (error) {
				return handleLoadingError(error);
			}
		}

		// Helper functions for better organization:
		async function loadCoreData() {
			await loadLocationsFromSheets();
			await loadVisitsFromSheets(); 
			await loadReceiptsFromSheets();
		}

		async function loadOptionalData() {
			const optionalTasks = [
				{ fn: ensureClientNameInPayments, name: 'client name column' },
				{ fn: loadPaymentsFromCloud, name: 'payments' }
			];
			
			for (const task of optionalTasks) {
				try {
					await task.fn();
				} catch (error) {
					console.warn(`Could not load ${task.name}:`, error.message);
				}
			}
		}

		function updateAllUIComponents() {
			const uiUpdaters = [
				loadLocationsForSelect,
				loadLocationsTable,
				loadReceiptsTable,
				loadReceiptFilterOptions,
				loadFilterOptions,
				loadPaymentFilterOptions,
				loadPlanningData
			];
			
			uiUpdaters.forEach(updater => updater());
		}

		function schedulePostLoadTasks() {
			setTimeout(() => {
				if (typeof checkCriticalDebts === 'function') {
					checkCriticalDebts();
				}
			}, 2000);
		}

		function handleLoadingError(error) {
			console.error('Error loading data from sheets:', error);
			hideLoading();
			
			if (error.status === 401) {
				access_token = null;
				showToast('×”×—×™×‘×•×¨ ×¤×’ ×‘××”×œ×š ×˜×¢×™× ×”', 'warning');
			} else {
				showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™× ××”×¢× ×Ÿ');
			}
			
			return false;
		}


		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ××™×§×•××™× (×’×™× ×•×ª)
		async function loadLocationsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:P` // ×•×•×“× ×©×§×•×¨××™× ×¢×“ ×¢××•×“×” P
				});
				
				const rows = response.result.values;
				console.log('ğŸ” Raw locations data (first row):', rows ? rows[0] : 'No data');
				console.log('ğŸ” Raw locations data (second row):', rows ? rows[1] : 'No data');
				
				if (rows && rows.length > 1) {
					locations = rows.slice(1).map((row, index) => {
						const location = {
							ID: row[0] || '',
							name: row[1] || '',
							full_address: row[2] || '',
							neighborhood: row[3] || '',
							city: row[4] || '',
							contact_person: row[5] || '',
							phone: row[6] || '',
							allowed_day: row[7] || '',
							interval_weeks: row[8] || '',
							temp_addition: row[9] || 0,
							base_amount: row[10] || '',
							active: row[11] || '',
							notes: row[12] || '',
							last_visit: row[13] || '',
							next_visit: row[14] || '',
							client_requests: row[15] || '' // ×¢××•×“×” P
						};
						
						// ×œ×•×’ ×¨×§ ×œ×©×•×¨×•×ª ×¢× client_requests
						if (row[15]) {
							console.log(`âœ… Row ${index + 1} - ${location.name}: client_requests = "${row[15]}"`);
						}
						
						return location;
					});
				}
				
				console.log('ğŸ“Š Total locations loaded:', locations.length);
				
			} catch (error) {
				console.error('Error loading locations:', error);
			}
		}

		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ×‘×™×§×•×¨×™× (×˜×™×¤×•×œ×™×)
		async function loadVisitsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:N` // â† ×©× ×” ×-A:L ×œ-A:N
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					visits = rows.slice(1).map(row => ({
						ID: row[0] || '',
						date: row[1] || '',
						location_id: row[2] || '',
						location_name: row[3] || '',
						visit_type: row[4] || '',
						work_done: row[5] || '',
						duration_minutes: row[6] || 0,
						num_workers: row[7] || 1,
						start_time: row[8] || '',
						end_time: row[9] || '',
						amount: row[10] || 0,
						expense: row[11] || 0,
						notes: row[12] || ''
					}));
				}
				
			} catch (error) {
				console.error('Error loading visits:', error);
			}
		}

		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ×§×‘×œ×•×ª
		async function loadReceiptsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:I`
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					receipts = rows.slice(1).map(row => ({
						ID: row[0] || '',
						book_number: row[1] || '',
						receipt_number: row[2] || '',
						date: row[3] || '',
						location_id: row[4] || '',
						location_name: row[5] || '',
						amount: row[6] || 0,
						payment_type: row[7] || '',
						notes: row[8] || ''
					}));
				}
				
			} catch (error) {
				console.error('Error loading receipts:', error);
			}
		}
	
		// ×˜×¢×™× ×ª ×ª×©×œ×•××™× ×•×§×™×©×•×¨×™× ××”×¢× ×Ÿ
		async function loadPaymentsFromCloud() {
			if (!access_token || !SPREADSHEET_ID) {
				return;
			}
			
			try {
				// ×˜×¢×Ÿ ×ª×©×œ×•××™×
				const paymentsResponse = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Payments!A2:I1000'
				});
				
				if (paymentsResponse.result.values) {
					payments = paymentsResponse.result.values.map(row => ({
						ID: row[0] || '',
						date: row[1] || '',
						client_id: row[2] || '',
						client_name: row[3] || '',
						amount: parseFloat(row[4]) || 0,
						payment_method: row[5] || '',
						notes: row[6] || '',
						reference: row[7] || '',
						check_date: row[8] || ''
					}));
				}
				
				// ×˜×¢×Ÿ ×§×™×©×•×¨×™×
				const linksResponse = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'PaymentVisitLink!A2:D1000'
				});
				
				if (linksResponse.result.values) {
					paymentVisitLinks = linksResponse.result.values.map(row => ({
						ID: row[0] || '',
						payment_id: row[1] || '',
						visit_id: row[2] || '',
						amount_allocated: parseFloat(row[3]) || 0
					}));
				}
				
				console.log(`âœ… × ×˜×¢× ×• ${payments.length} ×ª×©×œ×•××™× ×•-${paymentVisitLinks.length} ×§×™×©×•×¨×™×`);
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×©×œ×•××™×:', error);
			}
		}
	
		// ×¤×•× ×§×¦×™×” ×œ×•×™×“×•× ×©×™×© ×¢××•×“×ª client_name ×‘×˜×‘×œ×ª Payments
		async function ensureClientNameInPayments() {
			if (!access_token || !SPREADSHEET_ID) return;
			
			try {
				// ×§×¨×™××ª ×”×›×•×ª×¨×•×ª ×”× ×•×›×—×™×•×ª
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Payments!1:1'
				});
				
				const headers = response.result.values ? response.result.values[0] : [];
				
				// ×‘×“×™×§×” ×× client_name ×§×™×™×
				if (!headers.includes('client_name')) {
					console.log('Adding client_name column to Payments sheet...');
					
					// ×”×•×¡×¤×ª ×”×¢××•×“×” ×”×—×“×©×”
					const newHeaders = [...headers, 'client_name'];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Payments!A1:${String.fromCharCode(64 + newHeaders.length)}1`,
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [newHeaders]
						}
					});
					
					console.log('âœ… client_name column added to Payments sheet');
				}
			} catch (error) {
				console.error('Error ensuring client_name column:', error);
			}
		}


		async function saveAllToSheets() {
			if (!await validateToken()) {
				showToast('××™×Ÿ ×—×™×‘×•×¨ ×œ×’×•×’×œ - ×©××™×¨×” ××§×•××™×ª ×‘×œ×‘×“', 'warning');
				return;
			}
			
			try {
				updateCloudStatus('×©×•××¨ × ×ª×•× ×™× ×œ×¢× ×Ÿ...', '××¢×“×›×Ÿ');
				
				// ×©××™×¨×” ×‘×‘××¦'×™× (×œ× ×œ×•×œ××•×ª!)
				const savePromises = [];
				
				if (locations.length > 0) {
					showToast(`×©×•××¨ ${locations.length} ×œ×§×•×—×•×ª ×‘×‘×ª ××—×ª...`, 'info', 2000);
					savePromises.push(saveLocationsBatch(locations));
				}
				
				if (visits.length > 0) {
					showToast(`×©×•××¨ ${visits.length} ×‘×™×§×•×¨×™× ×‘×‘×ª ××—×ª...`, 'info', 2000);
					savePromises.push(saveVisitsBatch(visits));
				}
				
				if (receipts.length > 0) {
					showToast(`×©×•××¨ ${receipts.length} ×§×‘×œ×•×ª ×‘×‘×ª ××—×ª...`, 'info', 2000);
					savePromises.push(saveReceiptsBatch(receipts));
				}
				
				// ×”××ª×Ÿ ×œ×›×œ ×”×©××™×¨×•×ª ×‘××§×‘×™×œ
				await Promise.all(savePromises);
				
				updateCloudStatus('××—×•×‘×¨ ×•××¡×•× ×›×¨×Ÿ', '× ×©××¨');
				showToast(`×›×œ ×”× ×ª×•× ×™× × ×©××¨×• ×‘×¢× ×Ÿ ×‘×”×¦×œ×—×”!`, 'success', 3000);
				
			} catch (error) {
				console.error('Error saving all data to cloud:', error);
				updateCloudStatus('×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ', '×©×’×™××”');
				showToast('×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ - ×”× ×ª×•× ×™× × ×©××¨×• ××§×•××™×ª', 'error');
			}
		}


		async function saveLocationToSheets(locationData) {
		
			if (!await validateToken()) {
				showToast('×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×©××™×¨×” ××§×•××™×ª ×‘×œ×‘×“', 'warning');
				return;
			}
    
			try {
				const values = [[
					locationData.ID,
					locationData.name,
					locationData.full_address,
					locationData.neighborhood,
					locationData.city,
					locationData.contact_person,
					locationData.phone,
					locationData.allowed_day,
					locationData.interval_weeks,
					locationData.temp_addition,
					locationData.base_amount,
					locationData.active,
					locationData.notes || '',
					locationData.last_visit,
					locationData.next_visit,
					locationData.client_requests || ''
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:P`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving location to sheets:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('âš ï¸ ×”×—×™×‘×•×¨ ×¤×’ - ×”×ª×—×‘×¨ ××—×“×©', 'warning');
					document.getElementById('statusText').textContent = 'ğŸ”“ × ×•×ª×§';
				} else {
					// ×©×’×™××•×ª ××—×¨×•×ª (×œ× ×§×©×•×¨×•×ª ×œ××¡×™××•×Ÿ)
					showToast('âš ï¸ ×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ', 'error');
				}
				throw error;

			}
		}


		// ×©××™×¨×ª ×‘×™×§×•×¨ ×—×“×© ×œ×©×™×˜×¡
		async function saveVisitToSheets(visitData) {
			if (!await validateToken()) {
				return;
			}
			
			try {
				const values = [[
					visitData.ID,                       // A: ID
					visitData.date,                     // B: date  
					visitData.location_id,              // C: location_id
					visitData.location_name || '',      // D: location_name
					visitData.visit_type,               // E: visit_type
					visitData.work_done,                // F: work_done
					visitData.duration_minutes,         // G: duration_minutes
					visitData.num_workers || 1,         // H: num_workers (THIS WAS MISSING!)
					visitData.start_time,               // I: start_time
					visitData.end_time,                 // J: end_time
					visitData.amount,                   // K: amount
					visitData.expense || 0,             // L: expense
					visitData.notes                     // M: notes
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:M`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving visit to sheets:', error);
				throw error;
			}
		}

		// ×ª×•×¡×¤×” - ×©××™×¨×ª ×§×‘×œ×” ×œ×©×™×˜×¡
		async function saveReceiptToSheets(receiptData) {
			if (!await validateToken()) {
				return;
			}
			
			try {
				const values = [[
					receiptData.ID,
					receiptData.booklet_number || '',
					receiptData.receipt_number || '',
					receiptData.date,
					receiptData.location_id,
					receiptData.location_name || '',
					receiptData.amount,
					receiptData.payment_type || '',
					receiptData.tax_code || '',
					receiptData.notes || ''
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:J`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving receipt to sheets:', error);
				throw error;
			}
		}

		
		// Local Storage functions
		function saveToLocalStorage() {
			try {
				localStorage.setItem('locations_data', JSON.stringify(locations));
				localStorage.setItem('visits_data', JSON.stringify(visits));
				localStorage.setItem('receipts_data', JSON.stringify(receipts));
				localStorage.setItem('payments_data', JSON.stringify(payments));
				localStorage.setItem('payment_links_data', JSON.stringify(paymentVisitLinks));
				localStorage.setItem('incomes_data', JSON.stringify(incomes));
				
				console.log('Data saved to local storage');
			} catch (error) {
				console.error('Error saving to local storage:', error);
			}
		}

		function loadFromLocalStorage() {
			try {
				const savedLocations = localStorage.getItem('locations_data');
				const savedVisits = localStorage.getItem('visits_data');
				const savedReceipts = localStorage.getItem('receipts_data');
				const savedPayments = localStorage.getItem('payments_data');
				const savedPaymentLinks = localStorage.getItem('payment_links_data');
				const savedIncomes = localStorage.getItem('incomes_data');
				const savedCostSettings = localStorage.getItem('cost_settings');
				
				if (savedLocations) {
					locations = JSON.parse(savedLocations);
				}
				if (savedVisits) {
					visits = JSON.parse(savedVisits);
				}
				if (savedReceipts) {
					receipts = JSON.parse(savedReceipts);
				}
				if (savedPayments) {
					payments = JSON.parse(savedPayments);
				}
				if (savedPaymentLinks) {
					paymentVisitLinks = JSON.parse(savedPaymentLinks);
				}
				if (savedIncomes) {
					incomes = JSON.parse(savedIncomes);
				}
				if (savedCostSettings) {
					costSettings = JSON.parse(savedCostSettings);
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
				}
				
				console.log('Data loaded from local storage');
				
			} catch (error) {
				console.error('Error loading from local storage:', error);
			}
		}


      
        // Navigation
        function showSection(sectionName) {
			// Hide all sections
			document.querySelectorAll('.section').forEach(section => {
				section.classList.remove('active');
			});
			
			// Show selected section
			const targetSection = document.getElementById(sectionName);
			if (!targetSection) {
				console.warn(`Section ${sectionName} not found`);
				return;
			}
			
			targetSection.classList.add('active');
			
			// Update navigation buttons
			document.querySelectorAll('.nav-btn').forEach(btn => {
				btn.classList.remove('active');
			});
			
			// Set active nav button
			const navButtons = document.querySelectorAll('.nav-btn');
			const buttonTexts = {
				'planning': '×ª×›× ×•×Ÿ',
				'history': '×˜×™×¤×•×œ×™×',
				'locations': '×œ×§×•×—×•×ª',
				'receipts': '×§×‘×œ×•×ª',
				'debts': 'ğŸ’° ×—×•×‘×•×ª',
				'payments': 'ğŸ’³ ×ª×©×œ×•××™×',
				'system': '××¢×¨×›×ª v3.0'
			};
			
			navButtons.forEach(btn => {
				if (btn.textContent.includes(buttonTexts[sectionName])) {
					btn.classList.add('active');
				}
			});
			
			// Load section-specific data
			switch(sectionName) {
				case 'planning':
					loadPlanningData();
					break;
				case 'history':
					loadFilterOptions();
					applyVisitFilters();
					break;
				case 'locations':
					loadLocationsTable();
					break;
				case 'receipts':
					loadReceiptFilterOptions(); // Only load filter options, don't reset filters
					// Don't call displayFilteredReceipts(receipts) - keep existing filters
					if (isClientLocked && lockedClientId) {
						// If locked, apply the locked client filter
						const receiptSearch = document.getElementById('receiptSmartSearch');
						if (receiptSearch) {
							receiptSearch.value = lockedClientName;
							handleReceiptSmartSearch(lockedClientName);
						}
					} else {
						// Only apply filters if no smart search is active
						const smartSearch = document.getElementById('receiptSmartSearch');
						if (!smartSearch || !smartSearch.value.trim()) {
							applyReceiptFilters();
						}
					}
					break;
				case 'debts':
					loadDebtClientOptions(); // Load client options first
					if (typeof displayDebts === 'function') {
						displayDebts();
					}
					break;
				case 'payments':
					if (typeof loadPaymentFilterOptions === 'function') {
						loadPaymentFilterOptions();
					}
					if (typeof applyPaymentFilters === 'function') {
						applyPaymentFilters();
					}
					break;
			}
		}

        // Data loading functions
		async function loadAllData() {
			try {
				showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™×...');
				loadFromLocalStorage();
				hideLoading();
				loadPlanningData();
			} catch (error) {
				console.error('Error loading data:', error);
				showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×');
			}
		}

        async function loadlocations() {
            // For now, we'll use dummy data until we set up the Google Sheets API
            locations = [
                {
                    ID: 1,
                    name: "×’×™× ×ª ×“×•×’××” 1",
                    full_address: "×¨×—×•×‘ ×”×“×•×’××” 1, ×ª×œ ××‘×™×‘",
                    neighborhood: "××¨×›×–",
                    city: "×ª×œ ××‘×™×‘",
                    contact_person: "×™×•×¡×™ ×›×”×Ÿ",
                    phone: "050-1234567",
                    allowed_day: "×'",
                    interval_weeks: 4,
                    temp_addition: 0,
                    base_amount: 300,
                    active: "×›×Ÿ",
                    notes: "",
                    last_visit: "2024-01-15",
                    next_visit: "2024-02-12"
                },
                {
                    ID: 2,
                    name: "×’×™× ×ª ×“×•×’××” 2",
                    full_address: "×¨×—×•×‘ ×”×“×•×’××” 2, ×ª×œ ××‘×™×‘",
                    neighborhood: "×¦×¤×•×Ÿ",
                    city: "×ª×œ ××‘×™×‘",
                    contact_person: "××¨×™× ×œ×•×™",
                    phone: "052-7654321",
                    allowed_day: "×’'",
                    interval_weeks: 6,
                    temp_addition: 0,
                    base_amount: 400,
                    active: "×›×Ÿ",
                    notes: "",
                    last_visit: "2024-01-10",
                    next_visit: "2024-02-21"
                }
            ];
        }

        async function loadVisits() {
            visits = []; // Will be loaded from Google Sheets
        }

        async function loadReceipts() {
            receipts = []; // Will be loaded from Google Sheets
        }

        // Display functions
        function loadPlanningData() {
			// Debug - ×‘×“×™×§×ª × ×ª×•× ×™×
			debugPlanningData();
			
			// ×—×™×©×•×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª
			updatePlanningStats();
			
			// ×¡×™× ×•×Ÿ ×¨×’×™×œ
			filterVisits(currentFilter);
			loadTodayTreatments(); 
		}

	/////<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
	
	// ========== ××¢×¨×›×ª ×ª×›× ×•×Ÿ ××©×•×“×¨×’×ª ==========

		// ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×œ×ª×›× ×•×Ÿ ××©×•×“×¨×’
		let currentPlanningView = 'daily';
		let planningClients = [];
		let selectedDayTab = null; 

		// ×–×× ×™ ×¢×‘×•×“×” ×–××™× ×™× (07:00-19:00 ×‘×§×¤×™×¦×•×ª ×©×œ 30 ×“×§×•×ª)
		const timeSlots = [];
		for (let hour = 7; hour <= 19; hour++) {
			timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
			if (hour < 19) timeSlots.push(`${hour.toString().padStart(2, '0')}:30`);
		}

		// ×¤×•× ×§×¦×™×” ×¢×™×§×¨×™×ª ×œ×˜×¢×™× ×ª × ×ª×•× ×™ ×ª×›× ×•×Ÿ - ×’×¨×¡×” ××©×•×“×¨×’×ª
		function loadPlanningDataAdvanced() {
			updatePlanningStats();
			loadPlanningClientsAdvanced();
			// updatePlanningDateHeader();
			renderPlanningCards();
		}

		// ×˜×¢×™× ×ª ×œ×§×•×—×•×ª ×œ×ª×›× ×•×Ÿ ×œ×¤×™ ×”×ª×¦×•×’×” ×”× ×•×›×—×™×ª - ×’×¨×¡×” ××ª×•×§× ×ª
		function loadPlanningClientsAdvanced() {
			const today = new Date();
			today.setHours(0, 0, 0, 0);
			
			console.log('ğŸ”„ ×˜×•×¢×Ÿ ×œ×§×•×—×•×ª ×œ×ª×›× ×•×Ÿ - ×ª×¦×•×’×”:', currentPlanningView);
			
			// ×¡×™× ×•×Ÿ ×œ×§×•×—×•×ª ×¤×¢×™×œ×™× ×‘×œ×‘×“
			const activeClients = locations.filter(client => client.active === "1");
			console.log('ğŸ“Š ×œ×§×•×—×•×ª ×¤×¢×™×œ×™×:', activeClients.length);
			
			// ×—×™×©×•×‘ × ×ª×•× ×™× ×œ×›×œ ×œ×§×•×— ×¤×¢×™×œ
			planningClients = activeClients.map(client => {
				const nextVisitDate = new Date(client.next_visit);
				nextVisitDate.setHours(0, 0, 0, 0);
				
				const daysDiff = Math.floor((nextVisitDate - today) / (1000 * 60 * 60 * 24));
				const daysOverdue = daysDiff < 0 ? Math.abs(daysDiff) : 0;
				
				return {
					...client,
					nextVisitDate: nextVisitDate,
					daysDiff: daysDiff,
					daysOverdue: daysOverdue,
					status: calculateClientStatus(daysDiff, daysOverdue)
				};
			});
			
			// ×¡×™× ×•×Ÿ ×œ×¤×™ ×ª×¦×•×’×” × ×•×›×—×™×ª
			planningClients = filterClientsByView(planningClients);
			
			// ××™×•×Ÿ ×”×œ×§×•×—×•×ª
			sortPlanningClients();
			
			console.log('âœ… ×œ×§×•×—×•×ª ×œ×ª×¦×•×’×”:', planningClients.length);
		}
	
		// ×—×™×©×•×‘ ×¡×˜×˜×•×¡ ×œ×§×•×— ×œ×¤×™ ×”×¤×¨×© ×™××™×
		function calculateClientStatus(daysDiff, daysOverdue) {
			if (daysOverdue > 14) return 'red';        // ××™×—×•×¨ ××¢×œ ×©×‘×•×¢×™×™×
			if (daysOverdue > 0) return 'orange';      // ××™×—×•×¨ ×¢×“ ×©×‘×•×¢×™×™×  
			if (daysDiff === 0) return 'green';        // ×”×™×•× ×‘×“×™×•×§
			if (daysDiff <= 7) return 'yellow';        // ×”×©×‘×•×¢ ×”×§×¨×•×‘
			return 'gray';                             // ×¢×ª×™×“×™ ×¨×—×•×§
		}

		// ×¡×™× ×•×Ÿ ×œ×§×•×—×•×ª ×œ×¤×™ ×”×ª×¦×•×’×” ×”× ×‘×—×¨×ª
		function filterClientsByView(clients) {
			const today = new Date();
			const todayDay = today.getDay(); // 0=×¨××©×•×Ÿ, 1=×©× ×™ ×•×›×•'
			const dayNames = ['×', '×‘', '×’', '×“', '×”', '×•', '×©'];
			
			switch (currentPlanningView) {
				case 'daily':
					// ×¨×§ ×œ×§×•×—×•×ª ×©×”×™×•× ×‘×“×™×•×§ ×”×ª××¨×™×š ×©×œ×”× (×‘×œ×™ ×××—×¨×™×)
					return clients.filter(client => client.daysDiff === 0);
					
				case 'weekly':
					// ×¨×§ ×ª××¨×™×›×™× ××“×•×™×§×™× (×œ× ×××—×¨×™×) - ××”×©×‘×•×¢ ×”×§×¨×•×‘
					return clients.filter(client => 
						client.daysDiff >= 0 && client.daysDiff <= 7
					);
					
				case 'overdue':
					// ×¨×§ ×××—×¨×™×
					return clients.filter(client => client.daysOverdue > 0);
					
				case 'future':
					// ×¨×§ ×œ×§×•×—×•×ª ×¢× ×˜×™×¤×•×œ ×‘×¢×•×“ ×™×•×ª×¨ ××©×‘×•×¢
					return clients.filter(client => client.daysDiff > 7);
					
				default:
					return clients;
			}
		}
	
		// ××™×•×Ÿ ×œ×§×•×—×•×ª ×œ×¤×™ ×”×ª×¦×•×’×” ×”× ×•×›×—×™×ª
		function sortPlanningClients() {
			planningClients.sort((a, b) => {
				// ×”×’×“×¨×ª dayOrder ×¤×¢× ××—×ª ×‘×ª×—×™×œ×ª ×”×¤×•× ×§×¦×™×”
				const dayOrder = ['×', '×‘', '×’', '×“', '×”', '×•', '×©'];
				
				switch (currentPlanningView) {
					case 'daily':
						// ××™×•×Ÿ ×œ×¤×™ ×©×¢×” ××•×¢×“×¤×ª ×× ×§×™×™××ª, ××—×¨×ª ×œ×¤×™ ×©×
						return (a.name || '').localeCompare(b.name || '');
						
					case 'weekly':
						// ××™×•×Ÿ ×œ×¤×™ ×™×•× ×‘×©×‘×•×¢, ×•××– ×œ×¤×™ ×ª××¨×™×š
						const aDay = dayOrder.indexOf(a.allowed_day || '×');
						const bDay = dayOrder.indexOf(b.allowed_day || '×');
						if (aDay !== bDay) return aDay - bDay;
						return a.daysDiff - b.daysDiff;
						
					case 'overdue':
						// ××™×•×Ÿ ×œ×¤×™ ×—×•××¨×ª ×”××™×—×•×¨ (×”×›×™ ×××—×¨ ×¨××©×•×Ÿ)
						return b.daysOverdue - a.daysOverdue;
						
					case 'future':
						// ××™×•×Ÿ ×œ×¤×™ ×™×•× ×‘×©×‘×•×¢, ×•××– ×œ×¤×™ ×ª××¨×™×š (×›××• ×©×‘×•×¢×™)
						const aDayFuture = dayOrder.indexOf(a.allowed_day || '×');
						const bDayFuture = dayOrder.indexOf(b.allowed_day || '×');
						if (aDayFuture !== bDayFuture) return aDayFuture - bDayFuture;
						// ×‘×ª×•×š ××•×ª×• ×™×•× - ×œ×¤×™ ×ª××¨×™×š ×•××– ×œ×¤×™ ×©×
						if (a.daysDiff !== b.daysDiff) return a.daysDiff - b.daysDiff;
						return (a.name || '').localeCompare(b.name || '');   
						
					default:
						return 0;
				}
			});
		}
	
		// ×”×—×œ×¤×ª ×ª×¦×•×’×ª ×ª×›× ×•×Ÿ ×¢× ×œ×•×’×™×§×” ××¢×•×“×›× ×ª
		function switchPlanningView(view) {
			// Update tab buttons
			document.querySelectorAll('.planning-tab-btn').forEach(btn => {
				btn.classList.remove('active');
			});
			
			// Set active button
			const buttonTexts = {
				'daily': '×™×•××™',
				'weekly': '×©×‘×•×¢×™', 
				'overdue': '×××—×¨×•×ª',
				'future': '×¢×ª×™×“×™×™×'
			};
			
			document.querySelectorAll('.planning-tab-btn').forEach(btn => {
				if (btn.textContent === buttonTexts[view]) {
					btn.classList.add('active');
				}
			});
			
			currentPlanningView = view;
			selectedDayTab = null;
			loadPlanningClientsAdvanced();  // Changed from loadPlanningClients(view)
			renderPlanningCards();  // Also need to render the cards after loading
		}

		
		// ×¨×™× ×“×•×¨ ×›×¨×˜×™×¡×™ ×œ×§×•×—×•×ª ×œ×ª×›× ×•×Ÿ
		function renderPlanningCards() {
			const container = document.getElementById('planningCardsContainer');
			
			if (!container) {
				console.log('âš ï¸ ×œ× × ××¦× container ×œ×›×¨×˜×™×¡×™ ×”×ª×›× ×•×Ÿ');
				return;
			}
			
			if (planningClients.length === 0) {
				let emptyMessage = '';
				switch (currentPlanningView) {
					case 'daily':
						emptyMessage = '<h3>ğŸ˜Š ××™×Ÿ ×œ×§×•×—×•×ª ××ª×•×›× × ×™× ×œ×”×™×•×</h3><p>×›×œ ×”×˜×™×¤×•×œ×™× ××¢×•×“×›× ×™×!</p>';
						break;
					case 'weekly':
						emptyMessage = '<h3>ğŸ“… ××™×Ÿ ×œ×§×•×—×•×ª ××ª×•×›× × ×™× ×”×©×‘×•×¢</h3><p>×ª×›× ×•×Ÿ × ×§×™ ×œ×©×‘×•×¢ ×”×§×¨×•×‘!</p>';
						break;
					case 'overdue':
						emptyMessage = '<h3>âœ… ××™×Ÿ ×œ×§×•×—×•×ª ×××—×¨×™×</h3><p>×›×œ ×”×˜×™×¤×•×œ×™× ×‘××•×¢×“×!</p>';
						break;
					case 'future':
						emptyMessage = '<h3>ğŸ”® ××™×Ÿ ×˜×™×¤×•×œ×™× ×¢×ª×™×“×™×™×</h3><p>×›×œ ×”×˜×™×¤×•×œ×™× ××ª×•×›× × ×™× ×œ×©×‘×•×¢ ×”×§×¨×•×‘!</p>';
						break;	
				}
				
				container.innerHTML = `
					<div class="planning-empty-state">
						${emptyMessage}
					</div>
				`;
				return;
			}

			// ×‘××¦×‘ ×©×‘×•×¢×™ - ×—×œ×•×§×” ×œ×¤×™ ×™××™×
			if (currentPlanningView === 'weekly' || currentPlanningView === 'overdue' || currentPlanningView === 'future') {
				renderWeeklyPlanningByDays();
			} else {
				// ×‘××¦×‘ ×™×•××™ ××• ×××—×¨×•×ª - ×¨×©×™××” ×¨×’×™×œ×”
				renderRegularPlanningList();
			}
			
			setTimeout(setTodayAsDefault, 100);
		}


		// ×¨×™× ×“×•×¨ ×œ××¦×‘ ×©×‘×•×¢×™ ×•×××—×¨×•×ª ×¢× ×˜××‘×™ ×™××™×
		function renderWeeklyPlanningByDays() {
			const container = document.getElementById('planningCardsContainer');
			const dayNames = ['×', '×‘', '×’', '×“', '×”', '×•', '×©'];
			
			// ×™×¦×™×¨×ª ××¢×¨×š ×¢× × ×ª×•× ×™ ×™××™×
			const daysData = dayNames.map(dayName => {
				const dayClients = planningClients.filter(client => 
					(client.allowed_day || '×') === dayName
				);
				// ××™×•×Ÿ ×œ×§×•×—×•×ª ×”×™×•×
				dayClients.sort((a, b) => {
					if (currentPlanningView === 'overdue') {
						return b.daysOverdue - a.daysOverdue; // ×××—×¨×™× - ×œ×¤×™ ×“×—×™×¤×•×ª
					} else {
						return a.daysDiff - b.daysDiff; // ×©×‘×•×¢×™ - ×œ×¤×™ ×ª××¨×™×š
					}
				});
				
				return { dayName, clients: dayClients };
			});
			
			// ×¨×§ ×™××™× ×¢× ×œ×§×•×—×•×ª
			const activeDays = daysData.filter(day => day.clients.length > 0);
			
			if (activeDays.length === 0) {
				container.innerHTML = '<div class="planning-empty-state"><h3>××™×Ÿ ×œ×§×•×—×•×ª ×œ×”×¦×™×’</h3></div>';
				return;
			}
			
			// ×™×¦×™×¨×ª HTML ×¢× ×˜××‘×™×
			let html = `
				<div class="days-tabs-container">
					<div class="days-tabs">
						${activeDays.map((day, index) => {
							// ×× ×™×© ×™×•× ×©× ×‘×—×¨, ×”×©×ª××© ×‘×•. ××—×¨×ª - ×”×™×•× ×”×¨××©×•×Ÿ
							const isActive = selectedDayTab ? (day.dayName === selectedDayTab) : (index === 0);
							return `<button class="day-tab-btn ${isActive ? 'active' : ''}" 
											 onclick="switchDayTab('${day.dayName}')" 
											 data-day="${day.dayName}">
										${day.dayName} (${day.clients.length})
									</button>`;
						}).join('')}
					</div>
					<div class="days-content">
						${activeDays.map((day, index) => {
							const isActive = selectedDayTab ? (day.dayName === selectedDayTab) : (index === 0);
							return `<div class="day-content ${isActive ? 'active' : ''}" data-day="${day.dayName}">
										${day.clients.map(client => renderClientRow(client)).join('')}
									</div>`;
						}).join('')}
					</div>
				</div>
			`;
			
			container.innerHTML = html;
		}

		// ×¨×™× ×“×•×¨ ×¨×’×™×œ (×™×•××™/×××—×¨×•×ª)
		function renderRegularPlanningList() {
			const container = document.getElementById('planningCardsContainer');
			container.innerHTML = planningClients.map(client => renderClientRow(client)).join('');
			setTimeout(setTodayAsDefault, 100);
		}

		// ×¨×™× ×“×•×¨ ×©×•×¨×ª ×œ×§×•×— (××©×•×ª×£ ×œ×©× ×™ ×”××¦×‘×™×)
		// Update the renderClientRow function to show last treatment date
		function renderClientRow(client) {
			const nextVisitFormatted = formatDate(client.next_visit);
			
			// Find last treatment date for this client
			const clientVisits = visits.filter(visit => visit.location_id === client.ID);
			const lastTreatmentDate = clientVisits.length > 0 
				? clientVisits.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date
				: '';
			
			// ×¦×‘×¢ ×œ×ª××¨×™×š ×”×‘× ×œ×¤×™ ×¡×˜×˜×•×¡
			let nextDateColor = '#2196F3'; // ×›×—×•×œ - ×‘×¨×™×¨×ª ××—×“×œ
			if (currentPlanningView === 'overdue') {
				nextDateColor = '#f44336'; // ××“×•× - ×××—×¨
			} else if (currentPlanningView === 'daily') {
				nextDateColor = '#4CAF50'; // ×™×¨×•×§ - ×”×™×•×
			}
			
			let statusText = '';
			
			// ×˜×§×¡×˜ ×¡×˜×˜×•×¡ ×œ×¤×™ ×ª×¦×•×’×”
			switch (currentPlanningView) {
				case 'daily':
					statusText = '××ª×•×›× ×Ÿ ×œ×”×™×•×';
					break;
				case 'weekly':
					statusText = client.daysDiff === 0 ? '×”×™×•×' : 
								client.daysDiff === 1 ? '××—×¨' : 
								`×‘×¢×•×“ ${client.daysDiff} ×™××™×`;
					break;
				case 'overdue':
					statusText = client.daysOverdue === 1 ? '××™×—×•×¨ ×™×•× ××—×“' : `××™×—×•×¨ ${client.daysOverdue} ×™××™×`;
					break;
				case 'future':
					statusText = `×‘×¢×•×“ ${client.daysDiff} ×™××™×`;
					break;	
			}
			
			return `
				<div class="planning-client-row planning-status-${client.status}" data-client-id="${client.ID}">
					<div class="planning-row-main">
						<!-- ×©× ×”×œ×§×•×— - ×’×“×•×œ ×•×‘×•×œ×˜ -->
						<div class="planning-client-header">
							<div class="planning-client-name-large">ğŸ‘¤ ${client.name}</div>
						</div>
						
						<!-- ×ª××¨×™×›×™× - ×’×“×•×œ×™× ×•×‘×•×œ×˜×™× -->
						<div class="planning-dates-section">
							${lastTreatmentDate ? 
								`<div class="planning-date-item">
									<span class="date-label">×§×•×“×:</span>
									<span class="date-value">${formatDate(lastTreatmentDate)}</span>
								</div>` 
								: 
								`<div class="planning-date-item">
									<span class="date-label">×§×•×“×:</span>
									<span class="date-value" style="color: #999;">---</span>
								</div>`
							}
							<div class="planning-date-item">
								<span class="date-label">×”×‘×:</span>
								<span class="date-value" style="color: ${nextDateColor}; font-weight: 600;">${nextVisitFormatted}</span>
							</div>
							${client.base_amount > 0 ? 
								`<div class="planning-amount-small">ğŸ’° ${client.base_amount} â‚ª</div>` 
								: ''
							}
						</div>

						<!-- ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” -->
						<div class="planning-actions-row">
							<button class="week-btn-mobile" onclick="setNextAllowedDay('${client.ID}', '${client.allowed_day}', 1)" title="×©×‘×•×¢ ×§×¨×•×‘">
								1W+
							</button>
							<button class="week-btn-mobile" onclick="setNextAllowedDay('${client.ID}', '${client.allowed_day}', 2)" title="×©×‘×•×¢×™×™×">
								2W+
							</button>
							<button class="profile-btn-mobile" onclick="showClientProfile('${client.ID}')" title="×¤×¨×•×¤×™×œ ×œ×§×•×—">
								ğŸ‘¤
							</button>
							<label class="active-checkbox-mobile" title="×¤×¢×™×œ">
								<input type="checkbox" ${client.active === '1' ? 'checked' : ''} onchange="toggleClientActive('${client.ID}', this.checked ? '1' : '0')">
							</label>
						</div>

						<!-- ×‘×—×™×¨×ª ×ª××¨×™×š ×•×”×ª×—×œ×” -->
						<div class="planning-date-row">
							<input type="date" class="planning-date-input-mobile" value="" onchange="updateClientNextVisit('${client.ID}', this.value)" id="dateInput_${client.ID}">
							<button class="start-btn-mobile" onclick="startTreatment('${client.ID}')" title="×”×ª×—×œ ×˜×™×¤×•×œ">
								â–¶
							</button>
						</div>
					
					<!-- ×”×¢×¨×•×ª ×•×‘×§×©×•×ª -->
					${(client.notes || client.client_requests) ? `
						<div class="planning-row-details">
							${client.client_requests ? `<div class="client-requests">ğŸ“¢ ×‘×§×©×•×ª: ${client.client_requests}</div>` : ''}
							${client.notes ? `<div class="client-notes">ğŸ’­ ×”×¢×¨×•×ª: ${client.notes}</div>` : ''}
						</div>
					` : ''}
				</div>
			`;
		}
	
		// ×”×—×œ×¤×ª ×˜××‘ ×™×•×
		function switchDayTab(dayName) {
			// ×©××™×¨×ª ×”×™×•× ×”× ×‘×—×¨
			selectedDayTab = dayName;
			
			// ×”×¡×¨×ª active ××›×œ ×”×›×¤×ª×•×¨×™×
			document.querySelectorAll('.day-tab-btn').forEach(btn => btn.classList.remove('active'));
			document.querySelectorAll('.day-content').forEach(content => content.classList.remove('active'));
			
			// ×”×•×¡×¤×ª active ×œ×›×¤×ª×•×¨ ×•×ª×•×›×Ÿ ×”× ×•×›×—×™×™×
			const activeBtn = document.querySelector(`[data-day="${dayName}"]`);
			const activeContent = document.querySelector(`.day-content[data-day="${dayName}"]`);
			
			if (activeBtn) activeBtn.classList.add('active');
			if (activeContent) activeContent.classList.add('active');
		}
		
	
		// ×¢×“×›×•×Ÿ ×©×¢×” ××ª×•×›× × ×ª ×œ×œ×§×•×—
		function updateClientScheduledTime(clientId, newTime) {
			const client = locations.find(loc => loc.ID === clientId);
			if (client) {
				client.scheduled_time = newTime;
				saveToLocalStorage();
				
				// ×©××™×¨×” ×‘×¢× ×Ÿ ×× ××—×•×‘×¨
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`×©×¢×ª ×˜×™×¤×•×œ ×¢×•×“×›× ×” ×œ-${newTime}`, 'success', 2000);
			}
		}

		// ×¡×™×•× ×˜×™×¤×•×œ (××¢×‘×¨ ×œ×˜×•×¤×¡ ×”×•×¡×¤×ª ×‘×™×§×•×¨)
		function completePlanningVisit(clientId) {
			showSection('visit');
			document.getElementById('locationSelect').value = clientId;
			document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
			
			const client = locations.find(loc => loc.ID === clientId);
			if (client && client.scheduled_time) {
				const timeInput = document.getElementById('visitTime');
				if (timeInput) timeInput.value = client.scheduled_time;
			}
		}

		// ×“×—×™×™×ª ×˜×™×¤×•×œ
		function postponePlanningVisit(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			const weeks = prompt(`×›××” ×©×‘×•×¢×•×ª ×œ×“×—×•×ª ××ª ×”×˜×™×¤×•×œ ×¢×‘×•×¨ ${client.name}?`, '1');
			if (weeks && !isNaN(weeks) && parseInt(weeks) > 0) {
				const currentNextVisit = new Date(client.next_visit);
				const postponedDate = new Date(currentNextVisit.getTime() + (parseInt(weeks) * 7 * 24 * 60 * 60 * 1000));
				
				client.next_visit = postponedDate.toISOString().split('T')[0];
				client.temp_addition = 0;
				
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`×˜×™×¤×•×œ × ×“×—×” ×œ-${formatDate(client.next_visit)}`, 'success');
				loadPlanningDataAdvanced();
			}
		}

		// ×ª×¤×¨×™×˜ ×¤×¢×•×œ×•×ª × ×•×¡×¤×•×ª ×œ×œ×§×•×—
		function showPlanningClientMenu(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			const actions = [
				'×¦×¤×™×™×” ×‘×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×',
				'×”×ª×—×œ×ª ×˜×™×¤×•×œ ××™×™×“×™',
				'×§×‘×™×¢×ª ×ª××¨×™×š ×¡×¤×¦×™×¤×™',
				'×¢×¨×™×›×ª ×¤×¨×˜×™ ×œ×§×•×—',
				'×‘×™×˜×•×œ'
			];
			
			const choice = prompt(`×‘×—×¨ ×¤×¢×•×œ×” ×¢×‘×•×¨ ${client.name}:\n\n` + 
				actions.map((action, i) => `${i + 1}. ${action}`).join('\n'));
			
			switch (choice) {
				case '1':
					showClientTreatmentHistory(clientId);
					break;
				case '2':
					startImmediateVisit(clientId);
					break;
				case '3':
					setSpecificVisitDate(clientId);
					break;
				case '4':
					editLocation(clientId);
					break;
			}
		}

		// ×¦×¤×™×™×” ×‘×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×
		function showClientTreatmentHistory(clientId) {
			// Use the existing working showClientHistory function instead of alert
			showClientHistory(clientId);
		}

		// ×”×ª×—×œ×ª ×˜×™×¤×•×œ ××™×™×“×™
		function startImmediateVisit(clientId) {
			showSection('visit');
			document.getElementById('locationSelect').value = clientId;
			document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
			document.getElementById('visitTime').value = new Date().toTimeString().slice(0,5);
		}

		// ×§×‘×™×¢×ª ×ª××¨×™×š ×¡×¤×¦×™×¤×™ ×œ×˜×™×¤×•×œ
		function setSpecificVisitDate(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			const newDate = prompt(`×”×–×Ÿ ×ª××¨×™×š ×—×“×© ×œ×˜×™×¤×•×œ ×”×‘× ×¢×‘×•×¨ ${client.name}:`, client.next_visit);
			
			if (newDate && !isNaN(new Date(newDate))) {
				client.next_visit = newDate;
				client.temp_addition = 0;
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`×ª××¨×™×š ×”×˜×™×¤×•×œ ×”×‘× ×¢×‘×•×¨ ${client.name} ×¢×•×“×›×Ÿ ×œ-${formatDate(newDate)}`, 'success');
				loadPlanningDataAdvanced();
			}
		}
	
	
	// ×”×•×¡×¤×ª ××™×¨×•×¢×™ ×’×¨×™×¨×” ×œ×›×¨×˜×™×¡×™× (×¨×§ ×‘×ª×¦×•×’×” ×™×•××™×ª)
		let draggedPlanningCard = null;

		function addPlanningDragEvents() {
			const cards = document.querySelectorAll('.planning-client-card');
			
			cards.forEach(card => {
				card.addEventListener('dragstart', handlePlanningDragStart);
				card.addEventListener('dragend', handlePlanningDragEnd);
				card.addEventListener('dragover', handlePlanningDragOver);
				card.addEventListener('drop', handlePlanningDrop);
			});
		}

		function handlePlanningDragStart(e) {
			draggedPlanningCard = this;
			this.classList.add('planning-dragging');
			e.dataTransfer.effectAllowed = 'move';
		}

		function handlePlanningDragEnd(e) {
			this.classList.remove('planning-dragging');
			document.querySelectorAll('.planning-client-card').forEach(card => {
				card.classList.remove('planning-drag-over');
			});
		}

		function handlePlanningDragOver(e) {
			if (e.preventDefault) e.preventDefault();
			this.classList.add('planning-drag-over');
			e.dataTransfer.dropEffect = 'move';
			return false;
		}

		function handlePlanningDrop(e) {
			if (e.stopPropagation) e.stopPropagation();
			
			if (draggedPlanningCard !== this) {
				const draggedIndex = parseInt(draggedPlanningCard.dataset.index);
				const droppedIndex = parseInt(this.dataset.index);
				
				// ×”×—×œ×¤×ª ××§×•××•×ª ×‘××¢×¨×š
				const temp = planningClients[draggedIndex];
				planningClients[draggedIndex] = planningClients[droppedIndex];
				planningClients[droppedIndex] = temp;
				
				// ×¨×™× ×“×•×¨ ××—×“×©
				renderPlanningCards();
				
				showToast('×¡×“×¨ ×”×œ×§×•×—×•×ª ×©×•× ×”', 'info');
			}
			
			this.classList.remove('planning-drag-over');
			return false;
		}

		// ×©××™×¨×ª ×”×¤×•× ×§×¦×™×” ×”××§×•×¨×™×ª ×œ×¤× ×™ ×”×”×—×œ×¤×”
		window.originalLoadPlanningData = window.loadPlanningData;

		// ×”×—×œ×¤×ª ×”×¤×•× ×§×¦×™×” loadPlanningData
		window.loadPlanningData = function() {
			console.log('ğŸ”„ loadPlanningData × ×§×¨××”');
			
			// ×‘×“×™×§×” ×× ×™×© ××ª ×”××œ×× ×˜×™× ×”×—×“×©×™×
			if (document.getElementById('planningCardsContainer')) {
				console.log('ğŸ“Š ××©×ª××© ×‘××¢×¨×›×ª ×—×“×©×”');
				loadPlanningDataAdvanced();
			} else {
				console.log('ğŸ“Š ××©×ª××© ×‘××¢×¨×›×ª ×™×©× ×”');
				updatePlanningStats();
				filterVisits(window.currentFilter || 'today');
			}
		};

		// ×¢×“×›×•×Ÿ ×”×¤×•× ×§×¦×™×” refreshPlanningAfterTreatmentUpdate ×œ×¢×‘×•×“ ×¢× ×©×ª×™ ×”××¢×¨×›×•×ª
		// Make sure this function exists and gets called after dates update
		
		function refreshPlanningAfterTreatmentUpdate() {
			// ×¨×¢× ×Ÿ ××ª × ×ª×•× ×™ ×”×ª×›× ×•×Ÿ ×× ×”×˜××‘ ×¤×ª×•×—
			const currentSection = document.querySelector('.section.active');
			if (currentSection && currentSection.id === 'planning') {
				loadPlanningData();
			}
			
			// ×¨×¢× ×Ÿ ×’× ××ª ×¨×©×™××ª ×”×œ×§×•×—×•×ª ×‘×˜×•×¤×¡ ×”×‘×™×§×•×¨
			loadLocationsForSelect();
			
			// âœ… ×”×•×¡×£: ×¨×¢× ×Ÿ ××ª ×˜×‘×œ×ª ×”×˜×™×¤×•×œ×™× ×× ×¤×ª×•×—×”
			const historySection = document.getElementById('history');
			if (historySection && historySection.classList.contains('active')) {
				applyVisitFilters();
			}
			
			// ×¨×¢× ×Ÿ ××ª ×”×˜×™×¤×•×œ×™× ×©×œ ×”×™×•×
			loadTodayTreatments();
		}
	
	/////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>


		// ×ª×•×¡×¤×” - ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
		function updatePlanningStats() {
			// ×œ×§×•×—×•×ª
			const totalLocations = locations.length;
			const activeLocations = locations.filter(loc => loc.active === '×›×Ÿ').length;
			
			// ×˜×™×¤×•×œ×™× ×”×©×‘×•×¢
			const today = new Date();
			const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
			const weeklyVisits = visits.filter(visit => {
				const visitDate = new Date(visit.date);
				return visitDate >= weekAgo && visitDate <= today;
			});
			
			// ×”×›× ×¡×” ×”×©×‘×•×¢
			const weeklyIncome = weeklyVisits.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			// ×—×•×‘×•×ª ×¤×ª×•×—×™×
			const openDebts = visits
				.filter(visit => visit.paid === '0')
				.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			// ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
			document.getElementById('totalLocations').textContent = totalLocations;
			document.getElementById('activeLocations').textContent = `${activeLocations} (${totalLocations > 0 ? Math.round((activeLocations / totalLocations) * 100) : 0}%)`;
			document.getElementById('weeklyVisits').textContent = weeklyVisits.length;
			document.getElementById('weeklyIncome').textContent = `â‚ª${weeklyIncome.toLocaleString()}`;
			document.getElementById('openDebts').textContent = `â‚ª${openDebts.toLocaleString()}`;
		}

        function filterVisits(filter) {
			currentFilter = filter;
			
			// Update filter buttons
			document.querySelectorAll('.filter-btn').forEach(btn => {
				btn.classList.remove('active');
				if ((filter === 'today' && btn.textContent === '×”×™×•×') ||
					(filter === 'week' && btn.textContent === '×”×©×‘×•×¢') ||
					(filter === 'overdue' && btn.textContent === '×××•×—×¨×•×ª')) {
					btn.classList.add('active');
				}
			});
			
			// Filter locations based on next_visit date
			const today = new Date();
			today.setHours(0, 0, 0, 0); // ×ª×—×™×œ×ª ×”×™×•×
			const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
			
			let filteredlocations = locations.filter(location => {
				return location.active === "1" && location.next_visit && location.next_visit.trim() !== '';
			});
			
			switch(filter) {
				case 'today':
					// ×œ×§×•×—×•×ª ×©×”×ª××¨×™×š ×”×‘× ×©×œ×”× ×”×•× ×”×™×•× ××• ×¢×‘×¨ (×¦×¨×™×›×™× ×˜×™×¤×•×œ)
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						nextVisit.setHours(0, 0, 0, 0); // ×ª×—×™×œ×ª ×”×™×•×
						return nextVisit <= today;
					});
					break;
				case 'week':
					// ×œ×§×•×—×•×ª ×©×”×ª××¨×™×š ×”×‘× ×©×œ×”× ×”×•× ×”×©×‘×•×¢ ×”×§×¨×•×‘ ××• ×¢×‘×¨
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						return nextVisit <= weekFromNow;
					});
					break;
				case 'overdue':
					// ×œ×§×•×—×•×ª ×©×”×ª××¨×™×š ×”×‘× ×©×œ×”× ×¢×‘×¨ (×××•×—×¨×™×)
					const yesterday = new Date(today);
					yesterday.setDate(yesterday.getDate() - 1);
					
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						return nextVisit <= yesterday;
					});
					break;
			}
			
			displayPlanningTable(filteredlocations);
			updateTreatmentsStats(filteredVisits);
		}

        function displayPlanningTable(locationsToShow) {
            const tbody = document.getElementById('planningTableBody');
            tbody.innerHTML = '';
            
            if (locationsToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">××™×Ÿ ×’×™× ×•×ª ×œ×˜×™×¤×•×œ</td></tr>';
                return;
            }
            
            locationsToShow.forEach(location => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${location.name}</td>
                    <td>${location.full_address}</td>
                    <td>${location.allowed_day}</td>
                    <td>${formatDate(location.next_visit)}</td>
                    <td>
                        <button class="action-btn start-visit-btn" onclick="startVisitForlocation(${location.ID})">
                            ×”×ª×—×œ ×˜×™×¤×•×œ
                        </button>
                        <button class="action-btn edit-btn" onclick="postponeVisit(${location.ID})">
                            ×“×—×”
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

       function calculateDurationFromTimes() {
			const startTime = document.getElementById('visitTime').value;
			const endTime = document.getElementById('endTime').value;
			
			if (!startTime || !endTime) return;
			
			const start = new Date(`2000-01-01T${startTime}`);
			const end = new Date(`2000-01-01T${endTime}`);
			
			if (end <= start) {
				showToast('×©×¢×ª ×¡×™×•× ×—×™×™×‘×ª ×œ×”×™×•×ª ××—×¨×™ ×©×¢×ª ×”×ª×—×œ×”', 'warning');
				return;
			}
			
			const diffMs = end - start;
			const totalMinutes = Math.round(diffMs / (1000 * 60));
			const hours = Math.floor(totalMinutes / 60);
			const minutes = totalMinutes % 60;
			const decimalHours = (totalMinutes / 60).toFixed(1);
			
			// ×‘×“×™×§×” ×©×”××œ×× ×˜×™× ×§×™×™××™× ×œ×¤× ×™ ×¢×“×›×•×Ÿ
			const durationHoursEl = document.getElementById('durationHours');
			const durationMinutesEl = document.getElementById('durationMinutes');
			const manualDurationEl = document.getElementById('manualDurationMinutes');
			const calculatedHoursEl = document.getElementById('calculatedHours');
			
			if (durationHoursEl) durationHoursEl.value = hours;
			if (durationMinutesEl) durationMinutesEl.value = minutes;
			if (manualDurationEl) manualDurationEl.value = totalMinutes;
			if (calculatedHoursEl) calculatedHoursEl.value = decimalHours;
			
			// ×¢×“×›×•×Ÿ ×”××—×™×¨ ××•×˜×•××˜×™×ª
			if (typeof calculateTreatmentCost === 'function') {
				calculateTreatmentCost();
			}
		}


	   function loadLocationsTable() {
			const filteredData = getFilteredLocations();
			
			const tbody = document.getElementById('locationsTableBody');
			tbody.innerHTML = '';
			
			if (filteredData.length === 0) {
				tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px; color: #666;">××™×Ÿ ×œ×§×•×—×•×ª ×ª×•×××™× ×œ×¡×™× ×•×Ÿ</td></tr>';
				updateLocationsStats(filteredData);
				return;
			}
			
			filteredData.forEach(location => {
				const row = document.createElement('tr');
				
				// Find last treatment date for this client
				const clientVisits = visits.filter(visit => String(visit.location_id) === String(location.ID));
				const lastTreatmentDate = clientVisits.length > 0 
					? clientVisits.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date
					: '';
				
				row.innerHTML = `
					<td>
						<strong>${location.name}</strong>
						${location.contact_person ? `<br><small style="color: #666;">${location.contact_person}</small>` : ''}
					</td>
					<td>${location.full_address}</td>
					<td>${location.contact_person || ''}</td>
					<td>${location.allowed_day}</td>
					<td style="text-align: center;">
						<span class="interval-badge">${location.interval_weeks || 4} ×©×‘×•×¢×•×ª</span>
					</td>
					<td style="text-align: center;">
						<input type="checkbox" 
							   ${location.active === '1' ? 'checked' : ''} 
							   onchange="toggleLocationStatus('${location.ID}', this.checked ? '1' : '0')"
							   style="transform: scale(1.2); cursor: pointer;">
					</td>
					<td style="text-align: center; font-size: 12px; color: ${lastTreatmentDate ? '#2c3e50' : '#999'};">
						${lastTreatmentDate ? formatDate(lastTreatmentDate) : '-'}
					</td>
					<td style="text-align: center; font-size: 12px; color: ${location.next_visit ? '#e74c3c' : '#999'};">
						${location.next_visit ? formatDate(location.next_visit) : '-'}
					</td>
					<td>
						<input type="text" 
							   value="${location.notes || ''}" 
							   placeholder="×”×¢×¨×•×ª..."
							   style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"
							   onchange="updateLocationNotes('${location.ID}', this.value)">
					</td>
					<td>
						<button class="action-btn profile-btn" onclick="showClientProfile('${location.ID}')" title="×¤×¨×•×¤×™×œ ×œ×§×•×— ××œ×" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">ğŸ‘¤ ×¤×¨×•×¤×™×œ</button>
						<button class="action-btn edit-btn" onclick="editLocation('${location.ID}')">×¢×¨×™×›×”</button>
						<button class="action-btn delete-btn" onclick="deleteLocation('${location.ID}')">××—×™×§×”</button>
					</td>
				`;
				tbody.appendChild(row);
			});
			
			updateLocationsStats(filteredData);
		}

		// ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×”×œ×§×•×—×•×ª
		function updateLocationsStats(filteredData) {
			const activeClients = filteredData.filter(loc => loc.active === "1").length;
			const inactiveClients = filteredData.filter(loc => loc.active === "0").length;
			
			document.getElementById('locationsCount').textContent = filteredData.length;
			document.getElementById('activeCount').textContent = activeClients;
			document.getElementById('inactiveCount').textContent = inactiveClients;
		}

        function loadReceiptsTable() {
			// ×˜×¢×Ÿ ××¤×©×¨×•×™×•×ª ×¡×™× ×•×Ÿ
			loadReceiptFilterOptions();
			
			// ××œ ×ª×¦×™×’ ××ª ×›×œ ×”×§×‘×œ×•×ª ××•×˜×•××˜×™×ª - ×©××•×¨ ×¢×œ ×”×¡×™× ×•×Ÿ ×”×§×™×™×
			// displayFilteredReceipts(receipts); // <- ××—×§ ××ª ×”×©×•×¨×” ×”×–×•
			
			// ×‘××§×•× ×–×”, ×‘×“×•×§ ×× ×™×© ×¡×™× ×•×Ÿ ×¤×¢×™×œ
			const smartSearch = document.getElementById('receiptSmartSearch');
			if (smartSearch && smartSearch.value.trim()) {
				// ×™×© ×—×™×¤×•×© ×¤×¢×™×œ - ×”×©×ª××© ×‘×•
				handleReceiptSmartSearch(smartSearch.value);
			} else {
				// ××™×Ÿ ×—×™×¤×•×© - ×”×¦×’ ×”×›×œ
				applyReceiptFilters();
			}
		}

        // Visithandling
        function startVisitForlocation(locationId) {
            const location = locations.find(g => g.ID === locationId);
            if (location) {
                showSection('visit');
                document.getElementById('locationSelect').value = locationId;
            }
        }

        function handleVisitSubmit(event) {
			event.preventDefault();
			
			// ×‘×“×™×§×•×ª ×‘×˜×™×—×•×ª ×œ×›×œ ×”××œ×× ×˜×™×
			const clientSearchInput = document.getElementById('clientSearchInput');
			const selectedClientIdInput = document.getElementById('selectedClientId');

			let selectedLocationId = '';
			if (selectedClientIdInput && selectedClientIdInput.value) {
				selectedLocationId = selectedClientIdInput.value;
			} else if (clientSearchInput && clientSearchInput.value) {
				// ×× ××™×Ÿ ID × ×‘×—×¨, × ×¡×” ×œ××¦×•× ×œ×¤×™ ×”×˜×§×¡×˜
				const searchValue = clientSearchInput.value;
				const matchingClient = locations.find(loc => 
					`${loc.name} - ${loc.full_address}` === searchValue ||
					loc.name === searchValue
				);
				if (matchingClient) {
					selectedLocationId = matchingClient.ID;
				}
			}

			const visitDateElement = document.getElementById('visitDate');
			const visitDate = visitDateElement ? visitDateElement.value : '';

			const endTimeElement = document.getElementById('endTime');
			const endTime = endTimeElement ? endTimeElement.value : '';

			const paymentStatusElement = document.getElementById('paymentStatus');
			const paymentStatus = paymentStatusElement ? paymentStatusElement.value : '0';

			const visitTypeElement = document.getElementById('visitType');
			const visitType = visitTypeElement ? visitTypeElement.value : '××œ×';

			const workDoneElement = document.getElementById('workDone');
			const workDone = workDoneElement ? workDoneElement.value : '';

			const amountElement = document.getElementById('amount');
			const amount = amountElement ? amountElement.value : '0';

			const notesElement = document.getElementById('notes');
			const notes = notesElement ? notesElement.value : '';

			const manualDurationElement = document.getElementById('manualDurationMinutes');
			const durationMinutes = manualDurationElement ? parseFloat(manualDurationElement.value) || 0 : 0;

			const numberOfWorkersElement = document.getElementById('numberOfWorkersVisit');
			const numberOfWorkers = numberOfWorkersElement ? parseInt(numberOfWorkersElement.value) || 1 : 1;

			const expenseElement = document.getElementById('expense');
			const expense = expenseElement ? expenseElement.value : '0';

			const visitTimeElement = document.getElementById('visitTime');
			const startTime = visitTimeElement ? visitTimeElement.value : '';
			
			// ×‘×“×™×§×•×ª ×‘×¡×™×¡×™×•×ª
			if (!selectedLocationId) {
				showToast('×× × ×‘×—×¨ ×œ×§×•×—', 'error');
				return;
			}
			
			if (!visitDate) {
				showToast('× ×“×¨×© ×ª××¨×™×š ×˜×™×¤×•×œ', 'error');
				return;
			}
			
			// ×‘×“×™×§×ª ×›×¤×™×œ×•×ª
			const duplicateVisit = checkDuplicateVisit(selectedLocationId, visitDate);
			if (duplicateVisit) {
				const location = locations.find(loc => loc.ID == selectedLocationId);
				const locationName = location ? location.name : '×œ×§×•×— ×œ× ×™×“×•×¢';
				
				const confirmMessage = `×›×‘×¨ ×§×™×™× ×˜×™×¤×•×œ ×œ×œ×§×•×— "${locationName}" ×”×™×•× (${formatDate(visitDate)}).\n\n×”×× ×œ×”×•×¡×™×£ ×˜×™×¤×•×œ × ×•×¡×£ ×‘×›×œ ×–××ª?`;
				
				if (!confirm(confirmMessage)) {
					return; // ×‘×™×˜×•×œ ×”×•×¡×¤×”
				}
			}

			// ×—×™×©×•×‘ ××•×˜×•××˜×™ ×©×œ ××©×š ×”×–××Ÿ ×× ×™×© ×©×¢×ª ×”×ª×—×œ×” ×•×¡×™×•×
			let calculatedDuration = durationMinutes;
			if (startTime && endTime) {
				const start = new Date(`2000-01-01 ${startTime}`);
				const end = new Date(`2000-01-01 ${endTime}`);
				const diffMs = end - start;
				if (diffMs > 0) {
					calculatedDuration = Math.round(diffMs / (1000 * 60)); // ×”×¤×¨×© ×‘×“×§×•×ª
					if (manualDurationElement) {
						manualDurationElement.value = calculatedDuration;
					}
				}
			}

			const visitData = {
				location_id: selectedLocationId,  
				visit_type: visitType,
				work_done: workDone,
				duration_minutes: calculatedDuration,
				workers_count: numberOfWorkers,		
				amount: parseFloat(amount) || 0,
				expense: parseFloat(expense) || 0,
				date: visitDate,
				start_time: startTime,
				end_time: endTime,
				paid: paymentStatus,
				notes: notes
			};
			
			console.log('Visit data:', visitData);
			
			// ×©××™×¨×ª ×”×˜×™×¤×•×œ
			saveVisit(visitData);
		}


		// Fixed saveVisit - proper mapping for workers_count to num_workers
		async function saveVisit(visitData) {
			try {
				// Find the client
				const location = locations.find(loc => loc.ID === visitData.location_id);
				
				// Create the correct visit object structure
				const newVisit = {
					ID: generateID(),
					date: visitData.date,
					location_id: visitData.location_id,
					location_name: location ? location.name : '×œ×§×•×— ×œ× ×™×“×•×¢',
					visit_type: visitData.visit_type,
					work_done: visitData.work_done,
					duration_minutes: visitData.duration_minutes,
					num_workers: visitData.workers_count || 1,    // âœ… CORRECT mapping!
					start_time: visitData.start_time,
					end_time: visitData.end_time,
					amount: visitData.amount,
					expense: visitData.expense || 0,
					notes: visitData.notes
					// âœ… REMOVED: no 'paid' field - this caused the column shift problem
				};

				// Add to visits array
				visits.push(newVisit);
				
				// Save locally (always succeeds)
				saveToLocalStorage();
				
				// Try to save to cloud
				let cloudSaved = false;
				if (access_token && SPREADSHEET_ID) {
					try {
						await saveVisitToSheets(newVisit);
						cloudSaved = true;
					} catch (error) {
						console.error('Cloud save failed:', error);
						cloudSaved = false;
					}
				}
				
				// Update treatment dates
				await updateSingleLocationTreatmentDates(newVisit.location_id);
				
				// Refresh display
				document.getElementById('visitForm')?.reset();
				loadPlanningData();
				
				// Success message based on actual result
				if (access_token && SPREADSHEET_ID) {
					if (cloudSaved) {
						showToast('âœ… ×”×˜×™×¤×•×œ × ×©××¨ ×‘×”×¦×œ×—×” ×‘××¢×¨×›×ª ×•×‘×¢× ×Ÿ!', 'success');
					} else {
						showToast('âš ï¸ ×”×˜×™×¤×•×œ × ×©××¨ ××§×•××™×ª ×‘×œ×‘×“ - ×‘×¢×™×” ×‘×—×™×‘×•×¨ ×œ×¢× ×Ÿ', 'warning');
					}
				} else {
					showToast('ğŸ’¾ ×”×˜×™×¤×•×œ × ×©××¨ ××§×•××™×ª - ×”×ª×—×‘×¨ ×œ×¢× ×Ÿ ×œ×©××™×¨×” ××œ××”', 'info');
				}
				
			} catch (error) {
				console.error('Error saving visit:', error);
				showToast('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×˜×™×¤×•×œ - × ×¡×” ×©× ×™×ª', 'error');
			}
		}
		
		
		function postponeVisit(locationId) {
			const location = locations.find(g => g.ID == locationId);
			if (location) {
				const weeks = prompt('×›××” ×©×‘×•×¢×•×ª ×œ×“×—×•×ª?', '1');
				if (weeks && !isNaN(weeks)) {
					const currentNext = new Date(location.next_visit);
					const newNext = new Date(currentNext.getTime() + (parseInt(weeks) * 7 * 24 * 60 * 60 * 1000));
					location.next_visit= newNext.toISOString().split('T')[0];

					loadPlanningData();
					showSuccess(`×˜×™×¤×•×œ × ×“×—×” ×‘-${weeks} ×©×‘×•×¢×•×ª`);
				}
			}
		}

        // location management
        function showAddLocationForm() {
			const modalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">×”×•×¡×¤×ª ×œ×§×•×— ×—×“×©</h3>
					
					<form id="locationForm" onsubmit="handleLocationSubmit(event)">
						<div class="form-group">
							<label for="locationName">×©× ×œ×§×•×—:</label>
							<input type="text" id="locationName" required>
						</div>
						<div class="form-group">
							<label for="locationAddress">×›×ª×•×‘×ª ××œ××”:</label>
							<input type="text" id="locationAddress" required>
						</div>
						<div class="form-group">
							<label for="locationNeighborhood">×©×›×•× ×”:</label>
							<input type="text" id="locationNeighborhood">
						</div>
						<div class="form-group">
							<label for="locationCity">×¢×™×¨:</label>
							<input type="text" id="locationCity">
						</div>
						<div class="form-group">
							<label for="locationContact">××™×© ×§×©×¨:</label>
							<input type="text" id="locationContact">
						</div>
						<div class="form-group">
							<label for="locationPhone">×˜×œ×¤×•×Ÿ:</label>
							<input type="tel" id="locationPhone">
						</div>
						<div class="form-group">
							<label for="locationDay">×™×•× ××•×¢×“×£:</label>
							<select id="locationDay">
								<option value="×›×œ ×™×•×">×›×œ ×™×•×</option>
								<option value="×">× (×¨××©×•×Ÿ)</option>
								<option value="×‘">×‘ (×©× ×™)</option>
								<option value="×’">×’ (×©×œ×™×©×™)</option>
								<option value="×“">×“ (×¨×‘×™×¢×™)</option>
								<option value="×”">×” (×—××™×©×™)</option>
								<option value="×•">×• (×©×™×©×™)</option>
								<option value="×©">×© (×©×‘×ª)</option>
							</select>
						</div>
						<div class="form-group">
							<label for="locationInterval">××¨×•×•×— ×©×‘×•×¢×•×ª:</label>
							<input type="number" id="locationInterval" value="4" min="1">
						</div>
						<div class="form-group">
							<label for="locationAmount">×¡×›×•× ×‘×¡×™×¡×™:</label>
							<input type="number" id="locationAmount">
						</div>
						<div class="form-group">
							<label for="locationActive">×¤×¢×™×œ×•×ª:</label>
							<select id="locationActive" required>
								<option value="1">×¤×¢×™×œ</option>
								<option value="0">×œ× ×¤×¢×™×œ</option>
							</select>
						</div>
						<div class="form-group">
							<label for="locationNextVisit">×ª××¨×™×š ×œ×˜×™×¤×•×œ ×”×‘×:</label>
							<input type="date" id="locationNextVisit" required>
						</div>
						<div class="form-group">
							<label for="locationClientRequests">×‘×§×©×•×ª ×œ×§×•×—:</label>
							<textarea id="locationClientRequests" rows="2"></textarea>
						</div>
						<div class="form-group">
							<label for="locationNotes">×”×¢×¨×•×ª:</label>
							<textarea id="locationNotes" rows="3"></textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="submit" class="btn btn-success">×©××•×¨ ×œ×§×•×—</button>
							<button type="button" onclick="closeAnyModal()" class="btn btn-secondary">×‘×™×˜×•×œ</button>
						</div>
					</form>
				</div>
			`;
			
			showEditModal(modalHTML);
			
			// Set default date
			document.getElementById('locationNextVisit').value = new Date().toISOString().split('T')[0];
		}

        async function handleLocationSubmit(event) {
            event.preventDefault();
           
			const locationData = {
				ID: generateID(),
				name: document.getElementById('locationName').value,
				full_address: document.getElementById('locationAddress').value,
				neighborhood: document.getElementById('locationNeighborhood').value,
				city: document.getElementById('locationCity').value,
				contact_person: document.getElementById('locationContact').value,
				phone: document.getElementById('locationPhone').value,
				allowed_day: document.getElementById('locationDay').value,
				interval_weeks: parseInt(document.getElementById('locationInterval').value),
				temp_addition: 0,
				base_amount: parseFloat(document.getElementById('locationAmount').value) || 0,
				active: document.getElementById('locationActive').value,
				notes: document.getElementById('locationNotes').value,
				client_requests: document.getElementById('locationClientRequests').value || '', // ×©×“×” ×—×“×©
				last_visit: '',
				next_visit: document.getElementById('locationNextVisit').value
			};
           
		    // ×‘×“×™×§×ª ×›×¤×™×œ×•×™×•×ª ×’× ×œ×¤×™ ID ×•×’× ×œ×¤×™ ×›×ª×•×‘×ª
			const existingLocation = locations.find(loc => 
				loc.ID === locationData.ID || 
				(loc.full_address && locationData.full_address &&
				 loc.full_address.toLowerCase().trim() === locationData.full_address.toLowerCase().trim())
			);

			if (existingLocation) {
				if (!confirm(`×œ×§×•×— ×¢× ×›×ª×•×‘×ª "${locationData.full_address}" ×›×‘×¨ ×§×™×™×.\n\n×”×× ×œ×”×•×¡×™×£ ×‘×›×œ ×–××ª?`)) {
					return; // ×‘×™×˜×•×œ ×”×•×¡×¤×”
				}
			}
		   
            // ×©××™×¨×” ×œ×–×™×›×¨×•×Ÿ ××§×•××™
			locations.push(locationData);

			// ×©××™×¨×” ××•×˜×•××˜×™×ª ×œ×¢× ×Ÿ
			if (access_token && spreadsheet_id) {
				document.getElementById('statusText').textContent = 'ğŸ”„ ×©×•××¨ ×œ×§×•×—...';
				try {
					await saveLocationToSheets(locationData);
					document.getElementById('statusText').textContent = '××—×•×‘×¨';
					showSuccess('×œ×§×•×— × ×©××¨ ×‘×”×¦×œ×—×” ×œ-Google Sheets!');
				} catch (error) {
					if (error.status === 401) {
						document.getElementById('statusText').textContent = 'ğŸ”“ × ×“×¨×© ×—×™×‘×•×¨ ××—×“×©';
						document.getElementById('statusText').classList.remove('connected');
						showToast('âš ï¸ ×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×”×ª×—×‘×¨ ××—×“×©', 'warning');
						access_token = null;
					} else {
						document.getElementById('statusText').textContent = 'âš ï¸ ×©×’×™××” ×‘×©××™×¨×”';
						showToast('âš ï¸ ×”×œ×§×•×— × ×©××¨ ××§×•××™×ª ×‘×œ×‘×“', 'warning');
					}
				}
			} else {
				showToast('ğŸ”“ ×œ×§×•×— × ×©××¨ ××§×•××™×ª - ×”×ª×—×‘×¨ ×œ×¢× ×Ÿ ×œ×©××™×¨×”', 'warning');
			}

			closeAnyModal();
			loadLocationsTable();
			loadLocationsForSelect();
			saveToLocalStorage();
        }


		// âœ… NEW: Show comprehensive client profile modal
		function showClientProfile(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			// Get client's visits
			const clientVisits = visits
				.filter(v => v.location_id === clientId)
				.sort((a, b) => b.date.localeCompare(a.date));
			
			// Calculate statistics
			const totalVisits = clientVisits.length;
			const totalIncome = clientVisits.reduce((sum, v) => sum + (parseFloat(v.amount) || 0), 0);
			const totalPaid = clientVisits.reduce((sum, v) => sum + getVisitPaidAmount(v.ID), 0);
			const totalDebt = totalIncome - totalPaid;
			
			// Last visit date
			const lastVisit = clientVisits.length > 0 ? clientVisits[0].date : '××™×Ÿ';
			
			// Build modal HTML
			const modalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 900px; width: 95vw; max-height: 90vh; overflow-y: auto;">
					<!-- Header -->
					<div style="border-bottom: 3px solid #3498db; padding-bottom: 15px; margin-bottom: 20px;">
						<h2 style="margin: 0; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
							ğŸ‘¤ ${client.name}
							<span style="font-size: 14px; color: #666; font-weight: normal;">${client.full_address}</span>
						</h2>
					</div>
					
					<!-- Statistics Cards -->
					<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
						<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white;">
							<div style="font-size: 13px; opacity: 0.9;">×¡×”"×› ×˜×™×¤×•×œ×™×</div>
							<div style="font-size: 28px; font-weight: bold;">${totalVisits}</div>
						</div>
						<div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 15px; border-radius: 10px; color: white;">
							<div style="font-size: 13px; opacity: 0.9;">×¡×”"×› ×”×›× ×¡×•×ª</div>
							<div style="font-size: 28px; font-weight: bold;">â‚ª${totalIncome.toFixed(0)}</div>
						</div>
						<div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 15px; border-radius: 10px; color: white;">
							<div style="font-size: 13px; opacity: 0.9;">×©×•×œ×</div>
							<div style="font-size: 28px; font-weight: bold;">â‚ª${totalPaid.toFixed(0)}</div>
						</div>
						<div style="background: ${totalDebt > 0 ? 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' : 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)'}; padding: 15px; border-radius: 10px; color: white;">
							<div style="font-size: 13px; opacity: 0.9;">${totalDebt > 0 ? '×—×•×‘' : '×œ×œ× ×—×•×‘×•×ª'}</div>
							<div style="font-size: 28px; font-weight: bold;">â‚ª${Math.abs(totalDebt).toFixed(0)}</div>
						</div>
					</div>
					
					<!-- Next Treatment Info -->
					<div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
						<div style="display: flex; justify-content: space-between; align-items: center;">
							<div>
								<div style="font-size: 14px; color: #2e7d32; margin-bottom: 5px;">ğŸ“… ×˜×™×¤×•×œ ×”×‘× ××ª×•×›× ×Ÿ ×œ:</div>
								<div style="font-size: 20px; font-weight: bold; color: #1b5e20;">${formatDate(client.next_visit)}</div>
								<div style="font-size: 12px; color: #666; margin-top: 3px;">×˜×™×¤×•×œ ××—×¨×•×Ÿ: ${lastVisit !== '××™×Ÿ' ? formatDate(lastVisit) : '××™×Ÿ'}</div>
							</div>
							<button onclick="startTreatment('${clientId}')" 
									style="padding: 12px 24px; background: #4caf50; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold;">
								ğŸš€ ×”×ª×—×œ ×˜×™×¤×•×œ ×¢×›×©×™×•
							</button>
						</div>
					</div>
					
					<!-- Tabs -->
					<div style="border-bottom: 2px solid #e0e0e0; margin-bottom: 20px;">
						<button onclick="switchClientProfileTab('treatments')" 
								class="client-profile-tab active" 
								data-tab="treatments"
								style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid #3498db; cursor: pointer; font-size: 15px; font-weight: bold; color: #3498db;">
							ğŸ”§ ×˜×™×¤×•×œ×™× (${totalVisits})
						</button>
						<button onclick="switchClientProfileTab('payments')" 
								class="client-profile-tab" 
								data-tab="payments"
								style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 15px; color: #666;">
							ğŸ’° ×ª×©×œ×•××™×
						</button>
						<button onclick="switchClientProfileTab('info')" 
								class="client-profile-tab" 
								data-tab="info"
								style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 15px; color: #666;">
							â„¹ï¸ ×¤×¨×˜×™×
						</button>
					</div>
					
					<!-- Tab Content -->
					<div id="clientProfileTabContent">
						<!-- Will be populated by switchClientProfileTab -->
					</div>
					
					<!-- Close Button -->
					<div style="text-align: center; margin-top: 20px;">
						<button onclick="closeAnyModal()" 
								style="padding: 10px 30px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
							×¡×’×•×¨
						</button>
					</div>
				</div>
			`;
			
			showEditModal(modalHTML);
			
			// Show treatments tab by default
			setTimeout(() => switchClientProfileTab('treatments', clientId), 100);
		}


		// âœ… NEW: Switch between tabs in client profile
		function switchClientProfileTab(tabName, clientId) {
			// If clientId not provided, try to get it from the modal
			if (!clientId) {
				const modal = document.getElementById('editModal');
				if (!modal) return;
				// Try to extract clientId from the modal content
				const startButton = modal.querySelector('[onclick*="startTreatment"]');
				if (startButton) {
					const match = startButton.getAttribute('onclick').match(/'([^']+)'/);
					clientId = match ? match[1] : null;
				}
			}
			
			if (!clientId) {
				console.error('Client ID not found');
				return;
			}
			
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			// Update tab buttons
			document.querySelectorAll('.client-profile-tab').forEach(btn => {
				if (btn.dataset.tab === tabName) {
					btn.style.borderBottom = '3px solid #3498db';
					btn.style.color = '#3498db';
					btn.style.fontWeight = 'bold';
				} else {
					btn.style.borderBottom = '3px solid transparent';
					btn.style.color = '#666';
					btn.style.fontWeight = 'normal';
				}
			});
			
			const contentDiv = document.getElementById('clientProfileTabContent');
			if (!contentDiv) return;
			
			// Generate content based on tab
			let html = '';
			
			if (tabName === 'treatments') {
				// Treatments tab
				const clientVisits = visits
					.filter(v => v.location_id === clientId)
					.sort((a, b) => b.date.localeCompare(a.date));
				
				if (clientVisits.length === 0) {
					html = '<div style="text-align: center; padding: 40px; color: #666;">×¢×“×™×™×Ÿ ××™×Ÿ ×˜×™×¤×•×œ×™× ×œ×œ×§×•×— ×–×”</div>';
				} else {
					html = `
						<div style="max-height: 400px; overflow-y: auto;">
							<table style="width: 100%; border-collapse: collapse;">
								<thead style="position: sticky; top: 0; background: #f8f9fa;">
									<tr style="border-bottom: 2px solid #dee2e6;">
										<th style="padding: 10px; text-align: right;">×ª××¨×™×š</th>
										<th style="padding: 10px; text-align: right;">×¢×‘×•×“×”</th>
										<th style="padding: 10px; text-align: right;">×–××Ÿ</th>
										<th style="padding: 10px; text-align: right;">×¡×›×•×</th>
										<th style="padding: 10px; text-align: right;">×ª×©×œ×•×</th>
									</tr>
								</thead>
								<tbody>
									${clientVisits.map(visit => {
										const paidInfo = parsePaidField(visit.paid);
										let paymentBadge = '';
										
										if (paidInfo.status === 'paid') {
											paymentBadge = `<span style="background: #d4edda; color: #155724; padding: 3px 8px; border-radius: 4px; font-size: 12px;">âœ“ ×©×•×œ×</span>`;
										} else if (paidInfo.status === '3') {
											paymentBadge = `<span style="background: #fff3cd; color: #856404; padding: 3px 8px; border-radius: 4px; font-size: 12px;">âš  ×—×œ×§×™</span>`;
										} else if (paidInfo.status === 'no_payment') {
											paymentBadge = `<span style="background: #e2e3e5; color: #383d41; padding: 3px 8px; border-radius: 4px; font-size: 12px;">ğŸš« ×œ×œ×</span>`;
										} else {
											paymentBadge = `<span style="background: #f8d7da; color: #721c24; padding: 3px 8px; border-radius: 4px; font-size: 12px;">âœ— ×œ× ×©×•×œ×</span>`;
										}
										
										const duration = visit.duration_minutes ? `${(visit.duration_minutes / 60).toFixed(1)}×©` : '-';
										
										return `
											<tr style="border-bottom: 1px solid #dee2e6;">
												<td style="padding: 10px;">${formatDate(visit.date)}</td>
												<td style="padding: 10px; font-size: 13px; color: #666;">${visit.work_done || '-'}</td>
												<td style="padding: 10px;">${duration}</td>
												<td style="padding: 10px; font-weight: bold; color: #27ae60;">${visit.amount || 0}â‚ª</td>
												<td style="padding: 10px;">${paymentBadge}</td>
											</tr>
										`;
									}).join('')}
								</tbody>
							</table>
						</div>
					`;
				}
				
			} else if (tabName === 'payments') {
				// Payments tab - show actual payments from payments array
				const clientPayments = payments
					.filter(p => p.client_id === clientId)
					.sort((a, b) => b.date.localeCompare(a.date));
				
				html = `
					<div style="margin-bottom: 15px; text-align: center;">
						<button onclick="showAddPaymentModal('${clientId}')" 
								style="padding: 12px 24px; background: #27ae60; color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);">
							â• ×”×•×¡×£ ×ª×©×œ×•×
						</button>
					</div>
				`;
				
				if (clientPayments.length === 0) {
					html += '<div style="text-align: center; padding: 40px; color: #666;">×¢×“×™×™×Ÿ ××™×Ÿ ×ª×©×œ×•××™× ×œ×œ×§×•×— ×–×”</div>';
				} else {
					const totalPaid = clientPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
					
					html += `
						<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #27ae60;">
							<div style="display: flex; justify-content: space-between; align-items: center;">
								<span style="font-size: 14px; color: #27ae60; font-weight: bold;">×¡×š ×”×›×œ ×ª×©×œ×•××™×:</span>
								<span style="font-size: 24px; font-weight: bold; color: #27ae60;">â‚ª${totalPaid.toFixed(2)}</span>
							</div>
						</div>
						
						<div style="max-height: 400px; overflow-y: auto;">
							${clientPayments.map(payment => {
								// ××¦× ×˜×™×¤×•×œ×™× ××§×•×©×¨×™×
								const relatedLinks = paymentVisitLinks.filter(link => link.payment_id === payment.ID);
								const linkedVisitsCount = relatedLinks.length;
								const totalLinked = relatedLinks.reduce((sum, link) => sum + (link.amount_allocated || 0), 0);
								
								// ×˜×§×¡×˜ ×××¦×¢×™ ×ª×©×œ×•×
								let methodText = '';
								switch(payment.payment_method) {
									case 'cash': methodText = 'ğŸ’µ ××–×•××Ÿ'; break;
									case 'check': methodText = 'ğŸ“ ×¦\'×§'; break;
									case 'transfer': methodText = 'ğŸ¦ ×”×¢×‘×¨×”'; break;
									case 'app': methodText = 'ğŸ“± ××¤×œ×™×§×¦×™×”'; break;
									default: methodText = payment.payment_method || '';
								}
								
								return `
									<div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 12px; background: white;">
										<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
											<div>
												<div style="font-size: 16px; font-weight: bold; color: #2c3e50;">${formatDate(payment.date)}</div>
												<div style="font-size: 13px; color: #666; margin-top: 3px;">${methodText}</div>
											</div>
											<div style="text-align: left;">
												<div style="font-size: 24px; font-weight: bold; color: #27ae60;">â‚ª${payment.amount.toFixed(2)}</div>
												${linkedVisitsCount > 0 ? 
													`<div style="font-size: 11px; color: #666; margin-top: 2px;">××§×•×©×¨: â‚ª${totalLinked.toFixed(2)}</div>` 
													: ''}
											</div>
										</div>
										
										${payment.reference ? 
											`<div style="font-size: 12px; color: #666; margin-bottom: 5px;">
												<strong>××¡××›×ª×:</strong> ${payment.reference}
											</div>` 
											: ''}
										
										${payment.check_date ? 
											`<div style="font-size: 12px; color: #666; margin-bottom: 5px;">
												<strong>×ª××¨×™×š ×¤×™×¨×¢×•×Ÿ:</strong> ${formatDate(payment.check_date)}
											</div>` 
											: ''}
										
										${payment.notes ? 
											`<div style="font-size: 13px; color: #555; background: #f8f9fa; padding: 8px; border-radius: 4px; margin-top: 8px;">
												ğŸ’¬ ${payment.notes}
											</div>` 
											: ''}
										
										${linkedVisitsCount > 0 ? 
											`<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6;">
												<div style="font-size: 12px; color: #666; font-weight: bold; margin-bottom: 5px;">
													ğŸ”— ××§×•×©×¨ ×œ-${linkedVisitsCount} ×˜×™×¤×•×œ×™×
												</div>
											</div>` 
											: `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6; font-size: 12px; color: #f39c12;">
												âš ï¸ ×œ× ××§×•×©×¨ ×œ×˜×™×¤×•×œ×™×
											</div>`}
										
										<div style="text-align: center; margin-top: 10px;">
											<button onclick="showPaymentDetails('${payment.ID}')" 
													style="padding: 6px 16px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">
												ğŸ” ×¤×¨×˜×™× ××œ××™×
											</button>
										</div>
									</div>
								`;
							}).join('')}
						</div>
					`;
				}
				
			} else if (tabName === 'info') {
				// Info tab
				html = `
					<div style="display: grid; gap: 15px;">
						<div>
							<strong style="color: #666;">×›×ª×•×‘×ª ××œ××”:</strong>
							<div style="margin-top: 5px;">${client.full_address}</div>
						</div>
						<div>
							<strong style="color: #666;">××™×© ×§×©×¨:</strong>
							<div style="margin-top: 5px;">${client.contact_person || '×œ× ×¦×•×™×Ÿ'}</div>
						</div>
						<div>
							<strong style="color: #666;">×˜×œ×¤×•×Ÿ:</strong>
							<div style="margin-top: 5px;">${client.phone || '×œ× ×¦×•×™×Ÿ'}</div>
						</div>
						<div>
							<strong style="color: #666;">×™×•× ××•×¢×“×£:</strong>
							<div style="margin-top: 5px;">${client.allowed_day || '×œ× ×¦×•×™×Ÿ'}</div>
						</div>
						<div>
							<strong style="color: #666;">×ª×“×™×¨×•×ª (×©×‘×•×¢×•×ª):</strong>
							<div style="margin-top: 5px;">${client.interval_weeks || 4} ×©×‘×•×¢×•×ª</div>
						</div>
						<div>
							<strong style="color: #666;">××—×™×¨ ×‘×¡×™×¡:</strong>
							<div style="margin-top: 5px;">${client.base_amount || 0}â‚ª</div>
						</div>
						<div>
							<strong style="color: #666;">×”×¢×¨×•×ª:</strong>
							<div style="margin-top: 5px; background: #f8f9fa; padding: 10px; border-radius: 5px; min-height: 60px;">
								${client.notes || '××™×Ÿ ×”×¢×¨×•×ª'}
							</div>
						</div>
						<div style="text-align: center; margin-top: 10px;">
							<button onclick="editLocation('${clientId}')" 
									style="padding: 8px 20px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">
								âœï¸ ×¢×¨×•×š ×¤×¨×˜×™ ×œ×§×•×—
							</button>
						</div>
					</div>
				`;
			}
			
			contentDiv.innerHTML = html;
		}


		function editLocation(locationId) {
			console.log(`âœ… editLocation ('${locationId}')`);
			const location = locations.find(g => g.ID == locationId);
			if (!location) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			console.log(`âœ… editLocation second: ('${locationId}')`);
			
			// ×¦×•×¨ ×—×œ×•×Ÿ ×¢×¨×™×›×”
			const editModalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ  ×¢×¨×™×›×ª ×œ×§×•×— - ${location.name}</h3>
					
					<form id="editLocationForm">
						<div class="form-group">
							<label>×©× ×”×œ×§×•×—:</label>
							<input type="text" id="editLocationName" value="${location.name || ''}" required>
						</div>
						
						<div class="form-group">
							<label>×›×ª×•×‘×ª ××œ××”:</label>
							<input type="text" id="editLocationAddress" value="${location.full_address || ''}" required>
						</div>
						
						<div class="form-group">
							<label>×©×›×•× ×”:</label>
							<input type="text" id="editLocationNeighborhood" value="${location.neighborhood || ''}">
						</div>
						
						<div class="form-group">
							<label>×¢×™×¨:</label>
							<input type="text" id="editLocationCity" value="${location.city || ''}">
						</div>
						
						<div class="form-group">
							<label>××™×© ×§×©×¨:</label>
							<input type="text" id="editLocationContact" value="${location.contact_person || ''}">
						</div>
						
						<div class="form-group">
							<label>×˜×œ×¤×•×Ÿ:</label>
							<input type="tel" id="editLocationPhone" value="${location.phone || ''}">
						</div>
						
						<div class="form-group">
							<label>×™×•× ××•×¢×“×£:</label>
							<select id="editLocationDay" value="${location.allowed_day||''}">
								<option value="×›×œ ×™×•×" ${location.allowed_day === '×›×œ ×™×•×' ? 'selected' : ''}>×›×œ ×™×•×</option>
								<option value="×" ${location.allowed_day === '×' ? 'selected' : ''}>× (×¨××©×•×Ÿ)</option>
								<option value="×‘" ${location.allowed_day === '×‘' ? 'selected' : ''}>×‘ (×©× ×™)</option>
								<option value="×’" ${location.allowed_day === '×’' ? 'selected' : ''}>×’ (×©×œ×™×©×™)</option>
								<option value="×“" ${location.allowed_day === '×“' ? 'selected' : ''}>×“ (×¨×‘×™×¢×™)</option>
								<option value="×”" ${location.allowed_day === '×”' ? 'selected' : ''}>×” (×—××™×©×™)</option>
								<option value="×•" ${location.allowed_day === '×•' ? 'selected' : ''}>×• (×©×™×©×™)</option>
								<option value="×©" ${location.allowed_day === '×©' ? 'selected' : ''}>×© (×©×‘×ª)</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>××¨×•×•×— ×‘×©×‘×•×¢×•×ª:</label>
							<input type="number" id="editLocationInterval" value="${location.interval_weeks || 4}" min="1" required onchange="updateNextVisitFromInterval()">
						</div>
						
						<div class="form-group">
							<label>×¡×›×•× ×‘×¡×™×¡ (â‚ª):</label>
							<input type="number" id="editLocationAmount" value="${location.base_amount || 0}" step="0.01">
						</div>
						
						<div class="form-group">
							<label>×¡×˜×˜×•×¡:</label>
							<select id="editLocationActive">
								<option value="1" ${location.active === '1' ? 'selected' : ''}>×¤×¢×™×œ</option>
								<option value="0" ${location.active === '0' ? 'selected' : ''}>×œ× ×¤×¢×™×œ</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>×˜×™×¤×•×œ ××—×¨×•×Ÿ:</label>
							<input type="date" id="editLocationLastVisit" value="${location.last_visit || ''}" readonly style="background: #f8f9fa;">
						</div>

						<div class="form-group">
							<label>×˜×™×¤×•×œ ×”×‘×:</label>
							<input type="date" id="editLocationNextVisit" value="${location.next_visit || ''}">
						</div>
						
						<div class="form-group">
							<label>×”×¢×¨×•×ª:</label>
							<textarea id="editLocationNotes" rows="3">${location.notes || ''}</textarea>
						</div>
						
						<div class="form-group">
							<label>×‘×§×©×•×ª ×œ×§×•×—:</label>
							<textarea id="editLocationClientRequests" rows="2">${location.client_requests || ''}</textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="button" onclick="saveEditedLocation('${locationId}')" class="btn btn-success">
								ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×
							</button>
							<button type="button" onclick="closeAnyModal()" class="btn btn-secondary">
								âŒ ×‘×™×˜×•×œ
							</button>
						</div>
					</form>
				</div>
			`;
			
			// ×”×¦×’ ××ª ×”××•×“×œ
			showEditModal(editModalHTML);
		}


       function deleteLocation(locationId) {
           if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×œ×§×•×—?')) {
               locations = locations.filter(g => g.ID != locationId);
               loadLocationsTable();
               loadLocationsForSelect();
               loadPlanningData();
               showSuccess('×œ×§×•×— × ××—×§ ×‘×”×¦×œ×—×”!');
			   saveToLocalStorage();
           }
       }

       // Receipt management
       function showAddReceiptForm() {
			const modalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ§¾ ×”×•×¡×¤×ª ×§×‘×œ×” ×—×“×©×”</h3>
					
					<form id="receiptForm" onsubmit="handleReceiptSubmit(event)">
						<div class="form-group">
							<label for="receiptBook">××¡×¤×¨ ×¤× ×§×¡:</label>
							<input type="text" id="receiptBook" required>
						</div>
						
						<div class="form-group">
							<label for="receiptNumber">××¡×¤×¨ ×§×‘×œ×”:</label>
							<input type="text" id="receiptNumber" required>
						</div>
						
						<div class="form-group">
							<label for="receiptDate">×ª××¨×™×š:</label>
							<input type="date" id="receiptDate" required>
						</div>
						
						<div class="form-group">
							<label for="receiptLocation">×œ×§×•×—:</label>
							<select id="receiptLocation" required>
								<option value="">×‘×—×¨ ×œ×§×•×—</option>
							</select>
						</div>
						
						<div class="form-group">
							<label for="receiptAmount">×¡×›×•× (â‚ª):</label>
							<input type="number" step="0.01" id="receiptAmount" required>
						</div>
						
						<div class="form-group">
							<label for="receiptPaymentType">×¡×•×’ ×ª×©×œ×•×:</label>
							<select id="receiptPaymentType">
								<option value="××–×•××Ÿ">××–×•××Ÿ</option>
								<option value="×”×¢×‘×¨×”">×”×¢×‘×¨×”</option>
								<option value="×¦'×§">×¦'×§</option>
								<option value="×›×¨×˜×™×¡ ××©×¨××™">×›×¨×˜×™×¡ ××©×¨××™</option>
							</select>
						</div>
						
						<div class="form-group">
							<label for="receiptNotes">×”×¢×¨×•×ª:</label>
							<textarea id="receiptNotes" rows="3"></textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="submit" class="btn btn-success">
								ğŸ’¾ ×©××•×¨ ×§×‘×œ×”
							</button>
							<button type="button" onclick="closeAnyModal()" class="btn btn-secondary">
								âŒ ×‘×™×˜×•×œ
							</button>
						</div>
					</form>
				</div>
			`;
			
			showEditModal(modalHTML);
			
			// ×”×’×“×¨×•×ª ×¨××©×•× ×™×•×ª
			setTimeout(() => {
				// ×”×’×“×¨×ª ×ª××¨×™×š ×”×™×•×
				document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
				
				// ×˜×¢×™× ×ª ×œ×§×•×—×•×ª ×œ×‘×—×™×¨×”
				const receiptLocation = document.getElementById('receiptLocation');
				locations.forEach(location => {
					const option = document.createElement('option');
					option.value = location.ID;
					option.textContent = `${location.name} - ${location.full_address}`;
					receiptLocation.appendChild(option);
				});
			}, 100);
		}

		async function handleReceiptSubmit(event) {
			event.preventDefault();
			
			try {
				// ××¦× ××ª ×”×œ×§×•×— ×”× ×‘×—×¨
				const selectedLocationId = document.getElementById('receiptLocation').value;
				const location = locations.find(loc => loc.ID === selectedLocationId);
				
				if (!selectedLocationId || !location) {
					showToast('×—×•×‘×” ×œ×‘×—×•×¨ ×œ×§×•×—', 'error');
					return;
				}
				
				const receiptData = {
					ID: generateID(),
					book_number: document.getElementById('receiptBook').value,
					receipt_number: document.getElementById('receiptNumber').value,
					date: document.getElementById('receiptDate').value,
					location_id: selectedLocationId,
					location_name: location.name,
					amount: parseFloat(document.getElementById('receiptAmount').value),
					payment_type: document.getElementById('receiptPaymentType').value,
					notes: document.getElementById('receiptNotes').value || ''
				};
				
				// ×‘×“×™×§×ª ×ª×§×™× ×•×ª
				const errors = validateReceiptData(receiptData);
				if (showValidationErrors(errors)) {
					return;
				}
				
				// ×‘×“×™×§×ª ×›×¤×™×œ×•×™×•×ª ×§×‘×œ×”
				const existingReceipt = receipts.find(receipt => 
					(receipt.book_number === receiptData.book_number && receipt.receipt_number === receiptData.receipt_number) ||
					(receipt.location_id === receiptData.location_id && receipt.date === receiptData.date && receipt.amount === receiptData.amount)
				);

				if (existingReceipt) {
					if (!confirm(`×›×‘×¨ ×§×™×™××ª ×§×‘×œ×” ×¢× ××•×ª×• ××¡×¤×¨ ××• ×‘××•×ª×” ×›×ª×•×‘×ª/×ª××¨×™×š/×¡×›×•×.\n\n×”×× ×œ×”×•×¡×™×£ ×‘×›×œ ×–××ª?`)) {
						return;
					}
				}
				
				// ×”×•×¡×¤×” ×œ××¢×¨×š
				receipts.push(receiptData);
				
				// ×©××™×¨×” ××§×•××™×ª
				saveToLocalStorage();
				
				// ×©××™×¨×” ×‘×¢× ×Ÿ
				if (access_token) {
					try {
						await saveReceiptToSheets(receiptData);
						showToast('×§×‘×œ×” × ×©××¨×” ×‘×”×¦×œ×—×” ×‘××¢×¨×›×ª ×•×‘×¢× ×Ÿ!', 'success');
					} catch (error) {
						showToast('×§×‘×œ×” × ×©××¨×” ××§×•××™×ª, ××š × ×›×©×œ×” ×‘×©××™×¨×” ×œ×¢× ×Ÿ', 'warning');
					}
				} else {
					showToast('×§×‘×œ×” × ×©××¨×” ××§×•××™×ª - ×”×ª×—×‘×¨ ×œ×¢× ×Ÿ ×œ×©××™×¨×” ××œ××”', 'info');
				}

				// ×¡×’×™×¨×ª ×”××•×“×œ ×•×¨×¢× ×•×Ÿ
				closeAnyModal();
				loadReceiptsTable();
				loadReceiptFilterOptions();
				
			} catch (error) {
				console.error('Error saving receipt:', error);
				showToast('×©×’×™××” ×‘×©××™×¨×ª ×”×§×‘×œ×”', 'error');
			}
		}

       // Utility functions
       function closeModal(modalId) {
           document.getElementById(modalId).style.display = 'none';
       }

       function formatDate(dateString) {
           const date = new Date(dateString);
           return date.toLocaleDateString('he-IL');
       }

       function showLoading(message) {
           // Could implement loading spinner
           console.log('Loading:', message);
       }

       function hideLoading() {
           // Hide loading spinner
           console.log('Loading complete');
       }

       
       // Click outside modal to close
       window.onclick = function(event) {
           if (event.target.classList.contains('modal')) {
               event.target.style.display = 'none';
           }
       }
	   
	  function editReceipt(receiptId) {
			console.log(`âœ… editReceipt ('${receiptId}')`);
			const receipt = receipts.find(r => r.ID == receiptId);
			if (!receipt) {
				showToast('×§×‘×œ×” ×œ× × ××¦××”', 'error');
				return;
			}
			
			// ×‘× ×™×™×ª ××¤×©×¨×•×™×•×ª ×”×œ×§×•×—×•×ª
			let locationOptions = '<option value="">×‘×—×¨ ×œ×§×•×—</option>';
			locations.forEach(location => {
				const selected = location.ID == receipt.location_id ? 'selected' : '';
				locationOptions += `<option value="${location.ID}" ${selected}>${location.name} - ${location.full_address}</option>`;
			});
			
			// ×¦×•×¨ ×—×œ×•×Ÿ ×¢×¨×™×›×”
			const editModalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ§¾ ×¢×¨×™×›×ª ×§×‘×œ×”</h3>
					
					<form id="editReceiptForm">
						<div class="form-group">
							<label>××¡×¤×¨ ×¤× ×§×¡:</label>
							<input type="text" id="editReceiptBook" value="${receipt.book_number || ''}" required>
						</div>
						
						<div class="form-group">
							<label>××¡×¤×¨ ×§×‘×œ×”:</label>
							<input type="text" id="editReceiptNumber" value="${receipt.receipt_number || ''}" required>
						</div>
						
						<div class="form-group">
							<label>×ª××¨×™×š:</label>
							<input type="date" id="editReceiptDate" value="${receipt.date}" required>
						</div>
						
						<div class="form-group">
							<label>×œ×§×•×—:</label>
							<select id="editReceiptLocation" required>
								${locationOptions}
							</select>
						</div>
						
						<div class="form-group">
							<label>×¡×›×•× (â‚ª):</label>
							<input type="number" step="0.01" id="editReceiptAmount" value="${receipt.amount || 0}" required>
						</div>
						
						<div class="form-group">
							<label>×¡×•×’ ×ª×©×œ×•×:</label>
							<select id="editReceiptPaymentType">
								<option value="××–×•××Ÿ" ${receipt.payment_type === '××–×•××Ÿ' ? 'selected' : ''}>××–×•××Ÿ</option>
								<option value="×”×¢×‘×¨×”" ${receipt.payment_type === '×”×¢×‘×¨×”' ? 'selected' : ''}>×”×¢×‘×¨×”</option>
								<option value="×¦×³×§" ${receipt.payment_type === '×¦×³×§' ? 'selected' : ''}>×¦×³×§</option>
								<option value="×›×¨×˜×™×¡ ××©×¨××™" ${receipt.payment_type === '×›×¨×˜×™×¡ ××©×¨××™' ? 'selected' : ''}>×›×¨×˜×™×¡ ××©×¨××™</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>×”×¢×¨×•×ª:</label>
							<textarea id="editReceiptNotes" rows="3">${receipt.notes || ''}</textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="button" onclick="saveEditedReceipt('${receiptId}')" class="btn btn-success">
								ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×
							</button>
							<button type="button" onclick="closeAnyModal()" class="btn btn-secondary">
								âŒ ×‘×™×˜×•×œ
							</button>
						</div>
					</form>
				</div>
			`;
			
			// ×”×¦×’ ××ª ×”××•×“×œ
			showEditModal(editModalHTML);
		}

		
		// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×”×§×‘×œ×” ×‘×¢× ×Ÿ (××•×¤×¦×™×•× ×œ×™×ª)
		async function updateReceiptInCloud(updatedReceipt) {
			if (!await validateToken()) return;
			
			try {
				// ×§×¨×™××ª ×›×œ ×”× ×ª×•× ×™× ××”×¢× ×Ÿ
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Receipts!A:I'
				});
				
				const rows = response.result.values || [];
				
				// ××¦×™××ª ×”×©×•×¨×” ×œ×¢×“×›×•×Ÿ
				let rowToUpdate = -1;
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] == updatedReceipt.ID) {
						rowToUpdate = i + 1; // +1 ×›×™ Google Sheets ××ª×—×™×œ ×-1
						break;
					}
				}
				
				if (rowToUpdate > 0) {
					// ×¢×“×›×•×Ÿ ×”×©×•×¨×”
					const updatedRow = [
						updatedReceipt.ID,
						updatedReceipt.book_number,
						updatedReceipt.receipt_number,
						updatedReceipt.date,
						updatedReceipt.location_id,
						updatedReceipt.location_name,
						updatedReceipt.amount,
						updatedReceipt.payment_type,
						updatedReceipt.notes
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Receipts!A${rowToUpdate}:I${rowToUpdate}`,
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [updatedRow]
						}
					});
					
					console.log(`âœ… Updated receipt ${updatedReceipt.ID} in cloud`);
				}
				
			} catch (error) {
				console.error('Error updating receipt in cloud:', error);
				throw error;
			}
		}

		
		function deleteReceipt(receiptId) {
			if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×§×‘×œ×”?')) {
				receipts = receipts.filter(r => r.ID != receiptId);
				loadReceiptsTable();
				loadReceiptFilterOptions();
				saveToLocalStorage();
				showSuccess('×§×‘×œ×” × ××—×§×” ×‘×”×¦×œ×—×”!');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×”×•×“×¢×•×ª Toast ××ª×§×“××•×ª
		function showToast(message, type = 'info', duration = 3000) {
			const toastContainer = document.getElementById('toastContainer');
			
			if (!toastContainer) {
				console.error('Toast container not found');
				return;
			}
			
			const toast = document.createElement('div');
			toast.className = `toast ${type}`;
			toast.textContent = message;
			
			toastContainer.appendChild(toast);
			
			// Trigger animation
			setTimeout(() => {
				toast.classList.add('show');
			}, 100);
			
			// Remove toast after specified duration
			setTimeout(() => {
				toast.classList.remove('show');
				setTimeout(() => {
					if (toast.parentNode) {
						toast.parentNode.removeChild(toast);
					}
				}, 300);
			}, duration);
		}
	   
	   // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×”×•×“×¢×•×ª
		function showSuccess(message, duration = 3000) {
			showToast(message, 'success', duration);
		}

		function showError(message, duration = 4000) {
			showToast(message, 'error', duration);
		}

		function showWarning(message, duration = 3500) {
			showToast(message, 'warning', duration);
		}

		function showInfo(message, duration = 3000) {
			showToast(message, 'info', duration);
		}
	   
	   
		// ×™×¦×™×¨×ª ×˜×‘×œ×ª ×¢×–×¨ ×œ×™×™×‘×•×
		async function clearAllDataBeforeImport() {
			if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×§×™×™××™× ×œ×¤× ×™ ×”×™×™×‘×•× ×”×—×“×©?\n\n×¤×¢×•×œ×” ×–×• ×ª××—×§:\n- ××ª ×›×œ ×”××™×§×•××™×\n- ××ª ×›×œ ×”×‘×™×§×•×¨×™×\n- ××ª ×›×œ ×”×§×‘×œ×•×ª\n- ××ª ×›×œ ×”×ª×©×œ×•××™×\n- ××ª ×›×œ ×”×§×™×©×•×¨×™× ×‘×™×Ÿ ×ª×©×œ×•××™× ×œ×‘×™×§×•×¨×™×\n- ××ª ×›×œ ×”×”×›× ×¡×•×ª\n\n×”× ×ª×•× ×™× ×‘×’×•×’×œ ×©×™×˜×¡ ×œ× ×™×™××—×§×•.')) {
				return false;
			}
			
			try {
				console.log('ğŸ—‘ï¸ Starting complete data cleanup...');
				
				// Clear all arrays
				locations = [];
				visits = [];
				receipts = [];
				payments = [];
				paymentVisitLinks = [];
				incomes = [];  // âœ… ADDED: Clear incomes too
				
				console.log('âœ… All arrays cleared');
				
				// Save empty arrays to localStorage
				saveToLocalStorage();
				console.log('âœ… Empty data saved to localStorage');
				
				// Clear localStorage keys explicitly (belt and suspenders approach)
				localStorage.removeItem('locations_data');
				localStorage.removeItem('visits_data');
				localStorage.removeItem('receipts_data');
				localStorage.removeItem('payments_data');
				localStorage.removeItem('payment_links_data');
				localStorage.removeItem('incomes_data');
				console.log('âœ… localStorage keys removed');
				
				// Update UI displays
				if (typeof loadLocationsTable === 'function') {
					loadLocationsTable();
					console.log('âœ… Locations table refreshed');
				}
				if (typeof loadLocationsForSelect === 'function') {
					loadLocationsForSelect();
					console.log('âœ… Location selectors refreshed');
				}
				
				showToast('âœ… ×›×œ ×”× ×ª×•× ×™× ×”××§×•××™×™× × ×•×§×• ×‘×”×¦×œ×—×”', 'success');
				console.log('âœ… Complete cleanup finished successfully');
				return true;
				
			} catch (error) {
				console.error('âŒ Error during cleanup:', error);
				showToast('âŒ ×©×’×™××” ×‘× ×™×§×•×™ × ×ª×•× ×™×', 'error');
				return false;
			}
		}
		
		
		// ×©×™×¤×•×¨ ×œ×¤×•× ×§×¦×™×” ×”×§×™×™××ª
		async function createImportTable() {
			if (!await validateToken()) {
				showToast('×”×ª×—×‘×¨ ×œ×’×•×’×œ ×§×•×“×', 'warning');
				return;
			}
			
			try {
				showLoading('×™×•×¦×¨ ×˜×‘×œ×ª ×¢×–×¨ ×œ×™×™×‘×•×...');
				
				const response = await gapi.client.sheets.spreadsheets.create({
					resource: {
						properties: {
							title: `import_table_${new Date().toISOString().split('T')[0]}`
						},
						sheets: [{
							properties: { title: 'Locations' },
						}, {
							properties: { title: 'Visits' },
						}, {
							properties: { title: 'Receipts' }
						}, {
							properties: { title: 'SystemSettings' }
						}]
					}
				});
				
				const newSpreadsheetId = response.result.spreadsheetId;
				
				// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×›×œ ×’×œ×™×•×Ÿ
				await addImportHeaders(newSpreadsheetId);
				
				// ×¤×ª×™×—×ª ×”×˜×‘×œ×”
				window.open(`https://docs.google.com/spreadsheets/d/${newSpreadsheetId}/edit`, '_blank');
				
				// ×©××™×¨×ª ID ×œ×™×™×‘×•× ×××•×—×¨ ×™×•×ª×¨
				localStorage.setItem('importTableId', newSpreadsheetId);
				
				showToast('×˜×‘×œ×ª ×¢×–×¨ × ×•×¦×¨×”! ××œ× ××ª ×”× ×ª×•× ×™× ×•××– ×—×–×•×¨ ×œ×™×™×‘×', 'success');
				
			} catch (error) {
				console.error('Error creating import table:', error);
				showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×‘×œ×ª ×¢×–×¨', 'error');
			} finally {
				hideLoading();
			}
		}

		// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×˜×‘×œ×ª ×¢×–×¨
		async function addImportHeaders(spreadsheetId) {
			if (!await validateToken()) {
				showToast('×‘×¢×™×” ×‘×—×™×‘×•×¨ ×œ×’×•×’×œ ×‘××”×œ×š ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª', 'error');
				return;
			}

			try {
				// ×›×œ ×”×›×•×ª×¨×•×ª ×‘×× ×’×œ×™×ª
				const locationHeaders = [['customer_name', 'street', 'house_number', 'city', 'frequency', 'contact_person', 'base_amount', 'allowed_day', 'active']];
				const visitHeaders = [['year', 'month', 'day', 'customer', 'contact_person', 'treatment', 'date', 'work_done', 'duration', 'amount', 'paid', 'expense', 'notes']];
				const receiptHeaders = [['code_x', 'booklet', 'receipt', 'year', 'month', 'day', 'address', 'amount', 'type', 'notes', 'details']];
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				await Promise.all([
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Locations!A1:G1',
						valueInputOption: 'RAW',
						resource: { values: locationHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Visits!A1:M1',
						valueInputOption: 'RAW', 
						resource: { values: visitHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Receipts!A1:K1',
						valueInputOption: 'RAW',
						resource: { values: receiptHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'SystemSettings!A1:B1',
						valueInputOption: 'RAW',
						resource: { values: [['Setting', 'Value']] }
					})
				]);			
				
				console.log('Headers added successfully to import table');
				
			} catch (error) {
				console.error('Error adding headers:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('âš ï¸ ×”×—×™×‘×•×¨ ×¤×’ ×‘××”×œ×š ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª', 'warning');
				} else {
					showToast('âš ï¸ ×©×’×™××” ×‘×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×˜×‘×œ×”', 'error');
				}
				throw error;
			}
		}
		
		
		// ×ª×•×¡×¤×” - ×¤×™×¢× ×•×— ×›×ª×•×‘×ª ××œ××” ×œ×—×œ×§×™×
		function parseFullAddress(fullAddress) {
			if (!fullAddress) return { street: '', houseNumber: '', city: '' };
			
			const parts = fullAddress.trim().split(' ');
			
			if (parts.length >= 3) {
				// ×”×¢×™×¨ ×”×™× ×”×—×œ×§ ×”××—×¨×•×Ÿ
				const city = parts[parts.length - 1];
				
				// ××¡×¤×¨ ×”×‘×™×ª ×”×•× ×”×—×œ×§ ×”×œ×¤× ×™ ××—×¨×•×Ÿ
				const houseNumber = parts[parts.length - 2];
				
				// ×”×¨×—×•×‘ ×”×•× ×›×œ ×”×©××¨
				const street = parts.slice(0, -2).join(' ');
				
				return { street, houseNumber, city };
			} else if (parts.length === 2) {
				return { street: parts[0], houseNumber: '', city: parts[1] };
			} else {
				return { street: fullAddress, houseNumber: '', city: '' };
			}
		}
	   
	      
	   
	   
	   // ×ª×•×¡×¤×” - ×”××¨×ª ×¤×•×¨××˜ ×ª××¨×™×š ×-DD/MM/YYYY ×œ-YYYY-MM-DD
		function convertDateFormat(dateStr) {
			if (!dateStr) return '';
			
			const parts = dateStr.split('/');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = parts[1].padStart(2, '0');
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			
			return dateStr;
		}
	   
	   
	  	   
	   // ×ª×•×¡×¤×” - ×‘×“×™×§×ª ×ª×§×™× ×•×ª × ×ª×•× ×™×
		function validateReceiptData(receiptData) {
			const errors = [];
			
			if (!receiptData.location_id) {
				errors.push('×—×•×‘×” ×œ×‘×—×•×¨ ×œ×§×•×—');
			}
			
			if (!receiptData.amount || receiptData.amount <= 0) {
				errors.push('×—×•×‘×” ×œ×”×–×™×Ÿ ×¡×›×•× ×—×™×•×‘×™');
			}
			
			if (!receiptData.date) {
				errors.push('×—×•×‘×” ×œ×”×–×™×Ÿ ×ª××¨×™×š');
			}
			
			return errors;
		}

		function showValidationErrors(errors) {
			if (errors.length > 0) {
				showToast(errors.join('\n'), 'error');
				return true; // ×™×© ×©×’×™××•×ª
			}
			return false; // ××™×Ÿ ×©×’×™××•×ª
		}
	   
	   
	    // ×ª×•×¡×¤×” - × ×™×”×•×œ ×¤×× ×œ×™ ×¡×™× ×•×Ÿ ×•××™×“×¢
		function toggleFilterPanel() {
			const content = document.getElementById('filterContent');
			const icon = document.getElementById('filterIcon');
			
			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				icon.textContent = 'ğŸ”½';
			} else {
				content.classList.add('collapsed');
				icon.textContent = 'ğŸ”¼';
			}
		}

		function toggleInfoPanel() {
			const content = document.getElementById('infoContent');
			const icon = document.getElementById('infoIcon');
			
			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				icon.textContent = 'ğŸ”½';
			} else {
				content.classList.add('collapsed');
				icon.textContent = 'ğŸ”¼';
			}
		}

		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ××¤×©×¨×•×™×•×ª ×¡×™× ×•×Ÿ
		function loadFilterOptions() {
			const locationSelect = document.getElementById('filterLocation');
			
			if (locationSelect) {
				locationSelect.innerHTML = '<option value="">×›×œ ×”×œ×§×•×—×•×ª</option>';
				
				locations.forEach(location => {
					const option = document.createElement('option');
					option.value = location.ID;
					option.textContent = location.name;
					locationSelect.appendChild(option);
				});
			}
		}
	   
		// ×ª×•×¡×¤×” - ×¡×™× ×•×Ÿ ×•×˜×¢×™× ×ª ×˜×™×¤×•×œ×™×
		function applyVisitFilters() {
			console.log('ğŸ” ××¡× ×Ÿ ×˜×™×¤×•×œ×™×...');
			
			// Check for smart search first
			const smartSearch = document.getElementById('visitSmartSearch')?.value;
			if (smartSearch && smartSearch.trim()) {
				handleVisitSmartSearch(smartSearch);
				return;
			}
			
			let filteredVisits = [...visits];
			
			// Filter by active status with null safety
			const activeFilter = document.getElementById('filterActiveClients')?.value || '1';
			if (activeFilter !== '') {
				const activeStatus = activeFilter === '1';
				const activeLocationIds = locations
					.filter(loc => (activeStatus ? loc.active === "1" : loc.active !== "1"))
					.map(loc => loc.ID);
				filteredVisits = filteredVisits.filter(visit => 
					activeLocationIds.includes(visit.location_id)
				);
			}
			
			// Filter by payment status with null safety
			const paymentFilter = document.getElementById('filterPayment')?.value || '';
			if (paymentFilter) {
				filteredVisits = filteredVisits.filter(visit => {
					const paymentStatus = getVisitPaymentStatus(visit.ID);
					switch(paymentFilter) {
						case '×›×Ÿ': return paymentStatus === 'paid';
						case '×œ×': return paymentStatus === 'unpaid';
						case '×œ×œ×': return paymentStatus === 'no_payment';
						default: return true;
					}
				});
			}
			
			// Filter by date range with null safety
			const dateFrom = document.getElementById('filterDateFrom')?.value || '';
			const dateTo = document.getElementById('filterDateTo')?.value || '';
			
			if (dateFrom) {
				filteredVisits = filteredVisits.filter(visit => visit.date >= dateFrom);
			}
			if (dateTo) {
				filteredVisits = filteredVisits.filter(visit => visit.date <= dateTo);
			}
			
			// Limit results with null safety
			const maxResults = parseInt(document.getElementById('maxResults')?.value) || 200;
			
			// Sort by date (newest first)
			filteredVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
			
			// Limit number of results
			if (filteredVisits.length > maxResults) {
				filteredVisits = filteredVisits.slice(0, maxResults);
			}
			
			console.log(`âœ… × ××¦××• ${filteredVisits.length} ×˜×™×¤×•×œ×™× ××ª×•×š ${visits.length}`);
			
			displayFilteredVisits(filteredVisits);
			updateTreatmentsStats(filteredVisits);
		}

		
		// ×ª×•×¡×¤×” - ×”×¦×’×ª ×˜×™×¤×•×œ×™× ××¡×•× × ×™×
		function displayFilteredVisits(filteredVisits) {
			const tbody = document.getElementById('visitsHistoryTableBody');
			
			// Clear quickly
			tbody.innerHTML = '';
			
			if (filteredVisits.length === 0) {
				tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #666;">××™×Ÿ ×˜×™×¤×•×œ×™× ×ª×•×××™× ×œ×¡×™× ×•×Ÿ</td></tr>';
				return;
			}
			
			// Sort by date descending
			filteredVisits.sort((a, b) => b.date.localeCompare(a.date));
			
			const fragment = document.createDocumentFragment();
			const locationMap = new Map();
			locations.forEach(loc => locationMap.set(loc.ID, loc));
			
			filteredVisits.forEach(visit => {
				const location = locationMap.get(visit.location_id);
				const locationName = visit.location_name || location?.name || '×œ×§×•×— ×œ× ×™×“×•×¢';
				
				// Main row
				const mainRow = document.createElement('tr');
				mainRow.className = 'main-row';
				const hours = visit.duration_minutes ? (visit.duration_minutes / 60).toFixed(1) : '0';
				
				// âœ… NEW: Parse paid field for better display
				const paidInfo = parsePaidField(visit.paid);
				let paymentDisplay = '';
				
				if (paidInfo.status === 'paid') {
					paymentDisplay = `
						<div style="color: #27ae60; font-weight: bold;">
							âœ… ×©×•×œ×
							${paidInfo.date ? `<div style="font-size: 11px; color: #666;">${formatDate(paidInfo.date)}</div>` : ''}
						</div>
					`;
				} else if (paidInfo.status === '3') {
					const debt = (parseFloat(visit.amount) || 0) - paidInfo.amount;
					paymentDisplay = `
						<div style="color: #f39c12; font-weight: bold;">
							âš ï¸ ×—×œ×§×™: ${paidInfo.amount}â‚ª
							<div style="font-size: 11px; color: #666;">×—×•×‘: ${debt}â‚ª</div>
						</div>
					`;
				} else if (paidInfo.status === 'no_payment') {
					paymentDisplay = `<div style="color: #95a5a6;">ğŸš« ×œ×œ× ×ª×©×œ×•×</div>`;
				} else {
					paymentDisplay = `<div style="color: #e74c3c; font-weight: bold;">âŒ ×œ× ×©×•×œ×</div>`;
				}
				
				mainRow.innerHTML = `
					<td>${formatDate(visit.date)}</td>
					<td><strong>${locationName}</strong></td>
					<td><span class="visit-type-badge visit-type-${visit.visit_type || 'other'}">${visit.visit_type || '-'}</span></td>
					<td class="work-done-column">${visit.work_done}</td>
					<td><span class="duration-badge">${hours}×©</span></td>
					<td style="font-weight: bold; color: #27ae60; font-size: 15px;">${visit.amount || 0} â‚ª</td>
					<td>
						${paymentDisplay}
						<select class="payment-status-select" onchange="updatePaymentStatus('${visit.ID}', this.value)" style="margin-top: 5px; font-size: 12px;">
							<option value="">-- ×©× ×” ×¡×˜×˜×•×¡ --</option>
							<option value="paid">âœ… ×¡××Ÿ ×›×©×•×œ×</option>
							<option value="3">âš ï¸ ×ª×©×œ×•× ×—×œ×§×™</option>
							<option value="unpaid">âŒ ×œ× ×©×•×œ×</option>
							<option value="no_payment">ğŸš« ×œ×œ× ×ª×©×œ×•×</option>
						</select>
					</td>
					<td>
						<button onclick="addPaymentForVisit('${visit.ID}')" class="icon-btn" title="×”×•×¡×£ ×ª×©×œ×•×" style="background: #27ae60; color: white;">ğŸ’°</button>
						<button onclick="editVisit('${visit.ID}')" class="icon-btn" title="×¢×¨×•×š">âœï¸</button>
						<button onclick="deleteVisit('${visit.ID}')" class="icon-btn" title="××—×§">ğŸ—‘ï¸</button>
						<button onclick="toggleVisitDetails('${visit.ID}')" class="icon-btn" title="×¤×¨×˜×™×">â„¹ï¸</button>
					</td>
				`;
				fragment.appendChild(mainRow);
				
				// Details row (collapsed by default)
				const detailsRow = document.createElement('tr');
				detailsRow.id = `details-${visit.ID}`;
				detailsRow.className = 'details-row';
				detailsRow.style.display = 'none';
				detailsRow.innerHTML = `
					<td colspan="8">
						<div class="visit-details-content">
							<div><strong>×¢×‘×•×“×” ×©×‘×•×¦×¢×”:</strong> ${visit.work_done || '×œ× ×¦×•×™×Ÿ'}</div>
							<div><strong>×©×¢×ª ×”×ª×—×œ×”:</strong> ${visit.start_time || '-'} | <strong>×©×¢×ª ×¡×™×•×:</strong> ${visit.end_time || '-'}</div>
							<div><strong>×¢×•×‘×“×™×:</strong> ${visit.num_workers || 1}</div>
							<div><strong>×”×•×¦××”:</strong> ${visit.expense || 0} â‚ª</div>
							<div><strong>×”×¢×¨×•×ª:</strong> ${visit.notes || '××™×Ÿ'}</div>
						</div>
					</td>
				`;
				fragment.appendChild(detailsRow);
			});
			
			tbody.appendChild(fragment);
			console.log(`ğŸ“Š ×”×•×¦×’×• ${filteredVisits.length} ×˜×™×¤×•×œ×™×`);
		}

		// ×”×•×¡×£ ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×”×¦×’×ª ×¤×™×¨×•×˜ ×¢×œ×•×™×•×ª:
		function getVisitCostBreakdown(visit) {
			if (!visit.duration_minutes) return '<span style="font-size: 11px; color: #999;">×œ×œ× ×¤×™×¨×•×˜</span>';
			
			const hours = (visit.duration_minutes / 60).toFixed(2);
			const workers = visit.num_workers || 1;
			const expense = visit.expense || 0;
			
			let breakdown = `${hours}×©`;
			if (workers > 1) breakdown += ` Ã— ${workers}×¢`;
			if (expense > 0) breakdown += ` + â‚ª${expense}`;
			
			return `<span style="font-size: 11px; color: #666;">${breakdown}</span>`;
		}

		

		// ×˜×¢×™× ×” ×¨××©×•× ×™×ª ×©×œ ×”×˜××‘
		function loadVisitsHistory() {
			loadFilterOptions();
			
			// ×”×’×“×¨×ª ×¡×™× ×•×Ÿ ×‘×¨×™×¨×ª ××—×“×œ - ×—×•×“×© ××—×¨×•×Ÿ
			setDefaultDateFilter();
			
			// ×˜×¢×™× ×” ×¢× ×¡×™× ×•×Ÿ ××”×—×•×“×© ×”××—×¨×•×Ÿ
			applyVisitFilters();
		}

		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×”×’×“×¨×ª ×ª××¨×™×›×™ ×‘×¨×™×¨×ª ××—×“×œ
		function setDefaultDateFilter() {
			const today = new Date();
			const lastMonth = new Date();
			lastMonth.setMonth(today.getMonth() - 1);
			
			// ×”×’×“×¨×ª ×ª××¨×™×›×™× ×‘×©×“×•×ª ×”×¡×™× ×•×Ÿ
			const dateFromInput = document.getElementById('filterDateFrom');
			const dateToInput = document.getElementById('filterDateTo');
			
			if (dateFromInput && dateToInput) {
				dateFromInput.value = lastMonth.toISOString().split('T')[0];
				dateToInput.value = today.toISOString().split('T')[0];
			}
		}

		async function editVisit(visitId) {
			console.log(`âœ… editVisit ('${visitId}') `);
			const visit = visits.find(v => v.ID == visitId);
			if (!visit) {
				showToast('×‘×™×§×•×¨ ×œ× × ××¦×', 'error');
				return;
			}
			
			console.log(`âœ… editVisit second: ('${visitId}') `);
			
			// ××¦× ××ª ×”×œ×§×•×—
			const location = locations.find(loc => loc.ID == visit.location_id);
			const locationName = location ? location.name : '×œ×§×•×— ×œ× × ××¦×';
			
			// ×¦×•×¨ ×—×œ×•×Ÿ ×¢×¨×™×›×”
			const editModalHTML = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 650px; width: 90vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
					<h3 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 22px; border-bottom: 2px solid #e67e22; padding-bottom: 10px;">âœï¸ ×¢×¨×™×›×ª ×˜×™×¤×•×œ - ${locationName}</h3>
					
					<form id="editVisitForm" style="display: flex; flex-direction: column; gap: 18px;">
						
						<!-- ×ª××¨×™×š -->
						<div class="form-group" style="margin: 0;">
							<label for="editVisitDate" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">×ª××¨×™×š:</label>
							<input type="date" id="editVisitDate" value="${visit.date}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
						</div>
						
						<!-- ×¡×•×’ ×˜×™×¤×•×œ - ×›×¤×ª×•×¨×™ ×¨×“×™×• -->
						<div class="form-group" style="margin: 0;">
							<label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">×¡×•×’ ×˜×™×¤×•×œ:</label>
							<div style="display: flex; gap: 15px;">
								<label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 8px 15px; border: 2px solid #ddd; border-radius: 6px; transition: all 0.2s;">
									<input type="radio" name="editVisitType" value="××œ×" ${visit.visit_type === '××œ×' ? 'checked' : ''} onchange="document.getElementById('editVisitTypeHidden').value=this.value" style="margin: 0;">
									<span style="font-size: 14px;">××œ×</span>
								</label>
								<label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 8px 15px; border: 2px solid #ddd; border-radius: 6px; transition: all 0.2s;">
									<input type="radio" name="editVisitType" value="×—×œ×§×™" ${visit.visit_type === '×—×œ×§×™' ? 'checked' : ''} onchange="document.getElementById('editVisitTypeHidden').value=this.value" style="margin: 0;">
									<span style="font-size: 14px;">×—×œ×§×™</span>
								</label>
								<label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 8px 15px; border: 2px solid #ddd; border-radius: 6px; transition: all 0.2s;">
									<input type="radio" name="editVisitType" value="×‘×™×§×•×¨×ª" ${visit.visit_type === '×‘×™×§×•×¨×ª' ? 'checked' : ''} onchange="document.getElementById('editVisitTypeHidden').value=this.value" style="margin: 0;">
									<span style="font-size: 14px;">×‘×™×§×•×¨×ª</span>
								</label>
								<input type="hidden" id="editVisitTypeHidden" value="${visit.visit_type || '××œ×'}">
							</div>
						</div>
						
						<!-- ×¢×‘×•×“×” ×©×‘×•×¦×¢×” -->
						<div class="form-group" style="margin: 0;">
							<label for="editWorkDone" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">×¢×‘×•×“×” ×©×‘×•×¦×¢×”:</label>
							<textarea id="editWorkDone" rows="2" placeholder="×ª×™××•×¨ ×”×¢×‘×•×“×”..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;">${visit.work_done || ''}</textarea>
						</div>
						
						<!-- ××©×š ×˜×™×¤×•×œ - ×”×ª×—×œ×”/×¡×™×•× -->
						<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">
							<label style="display: block; margin-bottom: 10px; font-weight: 600; color: #555;">â±ï¸ ××©×š ×”×˜×™×¤×•×œ:</label>
							<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
								<div>
									<label for="editStartTime" style="display: block; margin-bottom: 5px; font-size: 13px; color: #666;">×©×¢×ª ×”×ª×—×œ×”:</label>
									<div style="display: flex; gap: 6px;">
										<input type="time" id="editStartTime" value="${visit.start_time || ''}" onchange="calculateEditDuration()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
										<button type="button" onclick="setCurrentTime('editStartTime')" style="padding: 8px 12px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;">×¢×›×©×™×•</button>
									</div>
								</div>
								<div>
									<label for="editEndTime" style="display: block; margin-bottom: 5px; font-size: 13px; color: #666;">×©×¢×ª ×¡×™×•×:</label>
									<div style="display: flex; gap: 6px;">
										<input type="time" id="editEndTime" value="${visit.end_time || ''}" onchange="calculateEditDuration()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
										<button type="button" onclick="setCurrentTime('editEndTime')" style="padding: 8px 12px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;">×¢×›×©×™×•</button>
									</div>
								</div>
							</div>
							<div id="editDurationDisplay" style="text-align: center; padding: 8px; background: white; border-radius: 6px; font-weight: 600; color: #e67e22; font-size: 15px;">
								××©×š: <strong>${visit.duration_minutes || 0}</strong> ×“×§×•×ª (<strong>${((visit.duration_minutes || 0) / 60).toFixed(1)}</strong> ×©×¢×•×ª)
							</div>
							<input type="hidden" id="editManualDurationMinutes" value="${visit.duration_minutes || 0}">
							<input type="hidden" id="editCalculatedHours" value="${((visit.duration_minutes || 0) / 60).toFixed(2)}">
						</div>
						
						<!-- ×¢×œ×•×ª ×•×¢×•×‘×“×™× -->
						<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
							<div class="form-group" style="margin: 0;">
								<label for="editAmount" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ğŸ’° ×¡×›×•×:</label>
								<input type="number" id="editAmount" step="0.01" min="0" value="${visit.amount || 0}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
							</div>
							
							<div class="form-group" style="margin: 0;">
								<label for="editNumWorkers" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ğŸ‘· ×¢×•×‘×“×™×:</label>
								<input type="number" id="editNumWorkers" min="1" value="${visit.num_workers || 1}" onchange="calculateEditTreatmentCost()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
							</div>
							
							<div class="form-group" style="margin: 0;">
								<label for="editExpense" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ğŸ’¸ ×”×•×¦××”:</label>
								<input type="number" id="editExpense" step="0.01" min="0" value="${visit.expense || 0}" onchange="calculateEditTreatmentCost()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
							</div>
						</div>
						
						<!-- ×”×¢×¨×•×ª -->
						<div class="form-group" style="margin: 0;">
							<label for="editNotes" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ğŸ“ ×”×¢×¨×•×ª:</label>
							<textarea id="editNotes" rows="2" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;">${visit.notes || ''}</textarea>
						</div>
						
						<!-- ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” -->
						<div style="display: flex; gap: 12px; justify-content: center; margin-top: 10px; padding-top: 15px; border-top: 1px solid #e9ecef;">
							<button type="button" onclick="saveEditedVisit('${visitId}')" style="background: #e67e22; color: white; padding: 12px 35px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 8px rgba(230,126,34,0.3);">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
							<button type="button" onclick="closeAnyModal()" style="background: #95a5a6; color: white; padding: 12px 35px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s;">âœ– ×‘×™×˜×•×œ</button>
						</div>
					</form>
				</div>
				
				<style>
					label:has(input[type="radio"]:checked) {
						border-color: #e67e22 !important;
						background: #fff3e0 !important;
					}
				</style>
			`;
			
			// ×”×¦×’ ××ª ×”××•×“×œ
			showEditModal(editModalHTML);
			
			// âœ… ××ª×—×•×œ ×¢×¨×›×™× ××—×•×©×‘×™× ××—×¨×™ ×™×¦×™×¨×ª ×”×˜×•×¤×¡

			setTimeout(() => {
				// ×—×™×©×•×‘ ×¢×¨×›×™× ×¨××©×•× ×™×™×
				updateEditFromTotalMinutes();
				calculateEditTreatmentCost();
				
				// ×× ×™×© ×©×¢×•×ª ×”×ª×—×œ×” ×•×¡×™×•×, ×—×©×‘ ××ª ×”×–××Ÿ
				const startTime = document.getElementById('editStartTime').value;
				const endTime = document.getElementById('editEndTime').value;
				if (startTime && endTime) {
					calculateEditDuration();
				}
			}, 100);
		}

		// ×”×¦×’×ª ××•×“×œ ×¢×¨×™×›×” (×× ×œ× ×§×™×™××ª)
		function showEditModal(content) {
			// ×”×¡×¨ ××•×“×œ ×§×™×™× ×× ×™×©
			const existingModal = document.getElementById('editModal');
			if (existingModal) {
				existingModal.remove();
			}
			
			// ×¦×•×¨ ××•×“×œ ×—×“×©
			const modal = document.createElement('div');
			modal.id = 'editModal';
			modal.style.cssText = `
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.6);
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 10000;
				backdrop-filter: blur(3px);
			`;
			
			modal.innerHTML = content;
			
			// ×”×•×¡×¤×” ×œ×¢××•×“
			document.body.appendChild(modal);
			
			// ×¡×’×™×¨×” ×‘×œ×—×™×¦×” ×¢×œ ×”×¨×§×¢
			modal.addEventListener('click', function(e) {
				if (e.target === modal) {
					closeAnyModal();
				}
			});
			
			// âœ… ×ª×™×§×•×Ÿ ×”×˜×¢×™× ×” ×©×œ ×–×× ×™× - × ×•×•×“× ×©×œ× × ×˜×¢×Ÿ ×¢×¨×š ×œ× ×ª×§×™×Ÿ
			setTimeout(() => {
				const startTimeInput = document.getElementById('editStartTime');
				const endTimeInput = document.getElementById('editEndTime');
				
				if (startTimeInput && startTimeInput.value === '00:00') {
					startTimeInput.value = '';
				}
				
				if (endTimeInput && endTimeInput.value === '00:00') {
					endTimeInput.value = '';
				}
			}, 50);
		}

		// ×¡×’×™×¨×ª ××•×“×œ ×¢×¨×™×›×”
		function closeEditModal() {
			const modal = document.getElementById('editModal');
			if (modal) {
				modal.remove();
			}
		}

		function closeAddTreatmentModal() {
			// Try multiple possible modal IDs
			const possibleIds = ['editModal', 'telegramModal', 'clientModal'];
			
			for (const id of possibleIds) {
				const modal = document.getElementById(id);
				if (modal) {
					modal.remove();
					return;
				}
			}
			
			// Fallback: remove any modal-like div
			const modals = document.querySelectorAll('[style*="position: fixed"][style*="z-index"]');
			modals.forEach(m => m.remove());
		}

		// Add these functions after the editVisit function

		function calculateEditDuration() {
			const startTime = document.getElementById('editStartTime').value;
			const endTime = document.getElementById('editEndTime').value;
			
			if (!startTime || !endTime) {
				return;
			}
			
			try {
				const start = new Date(`2000-01-01T${startTime}`);
				const end = new Date(`2000-01-01T${endTime}`);
				
				// ×‘×“×™×§×” ×©×”×–×× ×™× ×ª×§×™× ×™×
				if (isNaN(start.getTime()) || isNaN(end.getTime())) {
					console.warn('Invalid time values detected');
					return;
				}
				
				let diffMinutes = (end - start) / (1000 * 60);
				
				// ×× ×”×¡×™×•× ×œ×¤× ×™ ×”×”×ª×—×œ×”, ×–×” ×›× ×¨××” ×œ××—×¨×ª
				if (diffMinutes < 0) {
					diffMinutes += 24 * 60;
				}
				
				// ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
				const displayDiv = document.getElementById('editDurationDisplay');
				if (displayDiv) {
					displayDiv.innerHTML = `××©×š: <strong>${diffMinutes}</strong> ×“×§×•×ª (<strong>${(diffMinutes / 60).toFixed(1)}</strong> ×©×¢×•×ª)`;
				}
				
				// ×¢×“×›×•×Ÿ ×”×©×“×•×ª ×”××•×¡×ª×¨×™×
				const manualField = document.getElementById('editManualDurationMinutes');
				const calcField = document.getElementById('editCalculatedHours');
				if (manualField) manualField.value = diffMinutes;
				if (calcField) calcField.value = (diffMinutes / 60).toFixed(2);
				
				// ×—×™×©×•×‘ ×¢×œ×•×ª
				if (typeof calculateEditTreatmentCost === 'function') {
					calculateEditTreatmentCost();
				}
				
			} catch (error) {
				console.error('Error calculating duration:', error);
			}
		}

		function updateEditManualDuration() {
			const hours = parseInt(document.getElementById('editDurationHours').value) || 0;
			const minutes = parseInt(document.getElementById('editDurationMinutes').value) || 0;
			const totalMinutes = hours * 60 + minutes;
			const decimalHours = (totalMinutes / 60).toFixed(1);
			
			document.getElementById('editDuration').value = totalMinutes;
			document.getElementById('editCalculatedHours').value = decimalHours;
			
			calculateEditTreatmentCost();
		}

		function updateEditFromTotalMinutes() {
			// This function is no longer needed with the new form design
			// The duration is now calculated automatically from start/end times
			console.log('updateEditFromTotalMinutes called - skipping (deprecated)');
		}

		function calculateEditTreatmentCost() {
			// Try to get duration from multiple possible field names
			let totalMinutes = 0;
			
			const manualField = document.getElementById('editManualDurationMinutes');
			const durationField = document.getElementById('editDuration');
			
			if (manualField && manualField.value) {
				totalMinutes = parseInt(manualField.value) || 0;
			} else if (durationField && durationField.value) {
				totalMinutes = parseInt(durationField.value) || 0;
			}
			
			const numWorkers = parseInt(document.getElementById('editNumWorkers')?.value) || 1;
			const expense = parseFloat(document.getElementById('editExpense')?.value) || 0;
			
			if (totalMinutes > 0 && costSettings && costSettings.hourlyRate) {
				const hours = totalMinutes / 60;
				const baseCost = costSettings.hourlyRate * hours;
				const workersCost = (numWorkers - 1) * costSettings.workerCost * hours;
				const laborCost = baseCost + workersCost;
				const totalCost = laborCost + expense;
				
				const amountField = document.getElementById('editAmount');
				if (amountField) {
					amountField.value = Math.round(totalCost);
				}
			}
		}
		
		// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×”×‘×™×§×•×¨ ×‘×¢× ×Ÿ
		async function updateVisitInCloud(updatedVisit) {
			if (!await validateToken()) return;
			
			try {
				// ×§×¨×™××ª ×›×œ ×”× ×ª×•× ×™× ××”×¢× ×Ÿ
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Visits!A:N'
				});
				
				const rows = response.result.values || [];
				
				// ××¦×™××ª ×”×©×•×¨×” ×œ×¢×“×›×•×Ÿ
				let rowToUpdate = -1;
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] == updatedVisit.ID) {
						rowToUpdate = i + 1; // +1 ×›×™ Google Sheets ××ª×—×™×œ ×-1
						break;
					}
				}
				
				if (rowToUpdate > 0) {
					// ×¢×“×›×•×Ÿ ×”×©×•×¨×”
					const updatedRow = [
					updatedVisit.ID,
					updatedVisit.date,
					updatedVisit.location_id,
					updatedVisit.location_name || '',
					updatedVisit.visit_type,
					updatedVisit.work_done,
					updatedVisit.duration_minutes,
					updatedVisit.num_workers || 1,
					updatedVisit.start_time || '',
					updatedVisit.end_time || '',
					updatedVisit.amount,
					updatedVisit.paid || '0',  
					updatedVisit.expense,
					updatedVisit.notes
				];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Visits!A${rowToUpdate}:N${rowToUpdate}`,
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [updatedRow]
						}
					});
					
					console.log(`âœ… Updated visit ${updatedVisit.ID} in cloud`);
				}
				
			} catch (error) {
				console.error('Error updating visit in cloud:', error);
				throw error;
			}
		}

		function deleteVisit(visitId) {
			console.log(`âœ… deleteVisit ('${visitId}') `);
			if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×˜×™×¤×•×œ?')) {
				visits = visits.filter(visit => visit.ID != visitId);
				applyVisitFilters(); // ×¨×¢× ×Ÿ ×ª×¦×•×’×”
				saveToLocalStorage();
				showToast('×˜×™×¤×•×œ × ××—×§ ×‘×”×¦×œ×—×”!', 'success');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×‘×“×™×§×ª ×¨×©××•×ª
		async function checkPermissions() {
			if (!access_token) {
				showToast('×œ× ××—×•×‘×¨ ×œ×’×•×’×œ - ×”×ª×—×‘×¨ ×§×•×“×', 'warning');
				return false;
			}
			
			try {
				// × ×¡×” ×œ×’×©×ª ×œ×˜×‘×œ×” ×”×¨××©×™×ª
				await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				return true;
			} catch (error) {
				if (error.status === 401) {
					showToast('×”×—×™×‘×•×¨ ×¤×’ - ×”×ª×—×‘×¨ ××—×“×©', 'warning');
					access_token = null;
				} else if (error.status === 403) {
					showToast('××™×Ÿ ×”×¨×©××” ×œ×˜×‘×œ×” - ×‘×“×•×§ ×©×™×ª×•×£', 'error');
				}
				return false;
			}
		}
	   
	   
	   // ×ª×•×¡×¤×” - ×‘×“×™×§×” ×ª×§×•×¤×ª×™×ª ×©×œ ×—×™×‘×•×¨
		setInterval(async () => {
			if (access_token) {
				const isValid = await validateToken();
				if (!isValid) {
					console.log('Token expired - disconnected');
				}
			}
		}, 300000); // ×‘×“×™×§×” ×›×œ 5 ×“×§×•×ª
	   
	   
	    // ×—×™×©×•×‘ ×¢×œ×•×ª ×˜×™×¤×•×œ ××¢×•×“×›×Ÿ
		function calculateTreatmentCost() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const workers = parseInt(document.getElementById('numberOfWorkersVisit').value) || 1;
			const expense = parseFloat(document.getElementById('expense').value) || 0;
			
			if (minutes > 0) {
				const hours = minutes / 60;
				const baseCost = costSettings.hourlyRate * hours;
				// ×ª×™×§×•×Ÿ: ×¢×œ×•×ª ×¢×•×‘×“×™× × ×•×¡×¤×™× (×œ× ×›×•×œ×œ ××•×ª×š)
				const workersCost = (workers - 1) * costSettings.workerCost * hours;
				const laborCost = baseCost + workersCost;
				const totalCost = laborCost + expense;
				
				// ×¢×“×›×Ÿ ××ª ×©×“×” ×”×¡×›×•×
				document.getElementById('amount').value = Math.round(totalCost);
				
				// ×”×¦×’ ×¤×™×¨×•×˜ ××¤×•×¨×˜ ×™×•×ª×¨
				let breakdown = `${hours.toFixed(2)} ×©×¢×•×ª Ã— â‚ª${costSettings.hourlyRate} = â‚ª${Math.round(baseCost)}`;
				
				if (workers > 1) {
					breakdown += `\n+ ${workers - 1} ×¢×•×‘×“×™× Ã— â‚ª${costSettings.workerCost}/×©×¢×” = â‚ª${Math.round(workersCost)}`;
				}
				
				if (expense > 0) {
					breakdown += `\n+ ×”×•×¦××•×ª: â‚ª${expense}`;
				}
				
				breakdown += `\n= ×¡×”"×›: â‚ª${Math.round(totalCost)}`;
				
				document.getElementById('costBreakdown').textContent = breakdown;
				document.getElementById('costBreakdown').style.whiteSpace = 'pre-line';
			} else {
				document.getElementById('costBreakdown').textContent = '';
			}
		}

		// ×”×•×¡×£ ×—×™×©×•×‘ ××•×˜×•××˜×™ ×›×©××§×œ×™×“×™× ××©×š ×–××Ÿ
		function updateHoursDisplay() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const hours = minutes > 0 ? (minutes / 60).toFixed(2) : '';
			document.getElementById('calculatedHours').value = hours;
			
			// ×—×©×‘ ×¢×œ×•×™×•×ª ××•×˜×•××˜×™×ª
			calculateTreatmentCost();
		}

		// ×©××™×¨×ª ×”×’×“×¨×•×ª ×¢×œ×•×ª ×¤×©×•×˜×” ×™×•×ª×¨
		function saveCostSettings() {
			costSettings.hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 150;
			costSettings.workerCost = parseFloat(document.getElementById('workerCost').value) || 50;
			
			localStorage.setItem('cost_settings', JSON.stringify(costSettings));
			
			if (access_token) {
				saveSettingsToCloud().then(success => {
					if (success) {
						showToast('×”×’×“×¨×•×ª ×¢×œ×•×ª × ×©××¨×• ×‘×¢× ×Ÿ', 'success');
					} else {
						showToast('×”×’×“×¨×•×ª × ×©××¨×• ××§×•××™×ª ×‘×œ×‘×“', 'warning');
					}
				});
			} else {
				showToast('×”×’×“×¨×•×ª × ×©××¨×• ××§×•××™×ª', 'success');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×‘×“×™×§×ª ×˜×™×¤×•×œ ×›×¤×•×œ
		function checkDuplicateVisit(locationId, visitDate) {
			const existingVisit = visits.find(visit => 
				visit.location_id == locationId && 
				visit.date === visitDate
			);
			
			return existingVisit;
		}
	   
	   
	   // ×¤×•× ×§×¦×™×” ×œ×©××™×¨×ª ×”×’×“×¨×•×ª ×œ×¢× ×Ÿ
		async function saveSettingsToCloud() {
			if (!await validateToken()) {
				return false;
			}
			
			try {
				const settingsData = [
					['Setting', 'Value'],
					['hourly_rate', costSettings.hourlyRate],
					['worker_cost', costSettings.workerCost],
					['last_updated', new Date().toISOString()]
				];
				
				await gapi.client.sheets.spreadsheets.values.clear({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A:B`
				});
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A1:B4`,
					valueInputOption: 'RAW',
					resource: { values: settingsData }
				});
				
				return true;
			} catch (error) {
				console.error('Error saving settings:', error);
				return false;
			}
		}

		// ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ×”×’×“×¨×•×ª ××”×¢× ×Ÿ
		async function loadSettingsFromCloud() {
			if (!await validateToken()) {
				return false;
			}
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A:B`
				});
				
				const rows = response.result.values || [];
				if (rows.length > 1) {
					rows.slice(1).forEach(row => {
						const [setting, value] = row;
						if (setting === 'hourly_rate') {
							costSettings.hourlyRate = parseFloat(value) || 150;
						}
						if (setting === 'worker_cost') {
							costSettings.workerCost = parseFloat(value) || 50;
						}
					});
					
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
					
					return true;
				}
			} catch (error) {
				console.error('Error loading settings:', error);
				return false;
			}
			
			return false;
		}
	   
	   // ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×‘×“×™×§×” ×•×™×¦×™×¨×ª ×”×˜×‘×œ×” ×”×¨××©×™×ª
		async function findOrCreateMainSpreadsheet() {
			try {
				console.log('Searching for existing main spreadsheet...');
				
				// ×—×™×¤×•×© ×˜×‘×œ×” ×§×™×™××ª
				const response = await gapi.client.request({
					path: 'https://www.googleapis.com/drive/v3/files',
					params: {
						q: `name='${SPREADSHEET_NAME}' and mimeType='application/vnd.google-apps.spreadsheet'`,
					}
				});
				
				if (response.result.files.length > 0) {
					console.log('Found existing spreadsheet');
					SPREADSHEET_ID = response.result.files[0].id;
					showToast('× ××¦××” ×˜×‘×œ×” ×§×™×™××ª!', 'success');
					
					// ×‘×“×™×§×” ×•×ª×™×§×•×Ÿ ×©×œ ××‘× ×” ×”×˜×‘×œ×”
					await checkAndFixTableStructure();
				} else {
					console.log('No spreadsheet found, creating new one...');
					await createNewMainSpreadsheet();
				}
				
			} catch (error) {
				console.error('Error in findOrCreateMainSpreadsheet:', error);
				showToast('×©×’×™××” ×‘×—×™×¤×•×© ×˜×‘×œ×”', 'error');
			}
		}

		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×™×¦×™×¨×ª ×˜×‘×œ×” ×¨××©×™×ª ×—×“×©×”
		async function createNewMainSpreadsheet() {
			console.log('Creating new main spreadsheet...');
			try {
				const response = await gapi.client.request({
					path: 'https://sheets.googleapis.com/v4/spreadsheets',
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${access_token}`,
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						properties: {
							title: SPREADSHEET_NAME
						},
						sheets: [
							{ properties: { title: 'Locations' } },
							{ properties: { title: 'Visits' } },
							{ properties: { title: 'Receipts' } },
							{ properties: { title: 'SystemSettings' } }
						]
					})
				});
				
				SPREADSHEET_ID = response.result.spreadsheetId;
				
				// ×”×•×¡×£ ×›×•×ª×¨×•×ª ×œ×›×œ ×”×’×™×œ×™×•× ×•×ª
				await addAllHeaders();
				
				showToast('× ×•×¦×¨×” ×˜×‘×œ×” ×—×“×©×”!', 'success');
				
			} catch (error) {
				console.error('Error creating spreadsheet:', error);
				showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×‘×œ×”', 'error');
			}
		}
		

		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×‘×“×™×§×” ×•×ª×™×§×•×Ÿ ××‘× ×” ×”×˜×‘×œ×”
		async function checkAndFixTableStructure() {
			console.log('Checking and fixing table structure...');
			
			try {
				// ×‘×“×™×§×ª ×›×•×ª×¨×•×ª ×‘×›×œ ×’×™×œ×™×•×Ÿ - ×›×•×œ×œ ×”×—×“×©×™×
				const sheetsToCheck = ['Locations', 'Visits', 'Receipts', 'TelegramVisits', 'TelegramIncomes', 'Payments', 'PaymentVisitLink'];
				
				for (const sheetName of sheetsToCheck) {
					try {
						const response = await gapi.client.sheets.spreadsheets.values.get({
							spreadsheetId: SPREADSHEET_ID,
							range: `${sheetName}!A1:A1`
						});
						
						if (!response.result.values || !response.result.values[0][0]) {
							console.log(`Headers missing in ${sheetName}, adding them...`);
							await addHeadersToSheet(sheetName);
						}
					} catch (error) {
						console.log(`Sheet ${sheetName} missing or error, will add headers:`, error);
						await addHeadersToSheet(sheetName);
					}
				}
				
				console.log('âœ… Table structure verified');
				
			} catch (error) {
				console.log('Headers check failed, will force add them:', error);
				await addAllHeaders();
			}
		}
		
		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×’×™×œ×™×•×Ÿ ×¡×¤×¦×™×¤×™
		async function addHeadersToSheet(sheetName) {
			const headersMap = {
				'Locations': ['ID', 'name', 'full_address', 'neighborhood', 'city', 'contact_person', 'phone', 'allowed_day', 'interval_weeks', 'temp_addition', 'base_amount', 'active', 'notes', 'last_visit', 'next_visit', 'client_requests'],
				'Visits': ['ID', 'date', 'location_id', 'location_name', 'visit_type', 'work_done', 'duration_minutes', 'num_workers', 'start_time', 'end_time', 'amount', 'paid', 'expense', 'notes'],  // âœ… ADDED: 'paid' field
				'Receipts': ['ID', 'book_number', 'receipt_number', 'date', 'location_id', 'location_name', 'amount', 'payment_type', 'notes'],
				'TelegramVisits': ['message_id', 'date', 'text', 'processed', 'location_id', 'visit_id'],
				'TelegramIncomes': ['message_id', 'date', 'text', 'processed', 'receipt_id'],
				'Payments': ['ID', 'date', 'client_id', 'client_name', 'amount', 'payment_method', 'notes', 'reference', 'check_date'],	
				'PaymentVisitLink': ['ID', 'payment_id', 'visit_id', 'amount_allocated']
			};
			
			const headers = headersMap[sheetName];
			if (!headers) {
				console.error(`No headers defined for sheet: ${sheetName}`);
				return;
			}
			
			try {
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `${sheetName}!A1:${String.fromCharCode(64 + headers.length)}1`,
					valueInputOption: 'RAW',
					resource: {
						values: [headers]
					}
				});
				console.log(`âœ… Headers added to ${sheetName}`);
			} catch (error) {
				console.error(`Error adding headers to ${sheetName}:`, error);
			}
		}
		
		// ×¤×•× ×§×¦×™×” ××©×•×¤×¨×ª ×œ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×›×œ ×”×’×™×œ×™×•× ×•×ª
		async function addAllHeaders() {
			try {
				console.log('Adding headers to all sheets...');
				
				await addHeadersToSheet('Locations');
				await addHeadersToSheet('Visits');
				await addHeadersToSheet('Receipts');
				await addHeadersToSheet('Payments');           
				await addHeadersToSheet('PaymentVisitLink');   
				await addHeadersToSheet('TelegramVisits');     
				await addHeadersToSheet('TelegramIncomes');    
				
				// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ-SystemSettings
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'SystemSettings!A1:B1',
					valueInputOption: 'RAW',
					values: [['setting_key', 'setting_value']]
				});
				
				console.log('âœ… All headers added successfully');
				
			} catch (error) {
				console.error('Error adding all headers:', error);
			}
		}
	   
	   async function importFromHelperTable() {
			if (!await validateToken()) {
				showToast('×”×ª×—×‘×¨ ×œ×’×•×’×œ ×§×•×“×', 'warning');
				return;
			}
			
			const importTableId = localStorage.getItem('importTableId');
			if (!importTableId) {
				showToast('×œ× × ××¦× ID ×©×œ ×˜×‘×œ×ª ×”×¢×–×¨', 'warning');
				return;
			}
			
			console.log('ğŸ” Import Table ID:', importTableId); // ×œ×•×’ ×—×“×©
			
			try {
				showLoading('××™×™×‘× × ×ª×•× ×™× ××˜×‘×œ×ª ×”×¢×–×¨...');
				
				let importedCount = 0;
				
				// ×™×™×‘×•× ××™×§×•××™×
				try {
					console.log('ğŸ“ Starting locations import...'); // ×œ×•×’ ×—×“×©
					
					const locationsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Locations!A2:O1000'
					});
					
					console.log('ğŸ“ Locations response:', locationsResponse.result); // ×œ×•×’ ×—×“×©
					
					if (locationsResponse.result.values && locationsResponse.result.values.length > 0) {
						console.log('ğŸ“ Found', locationsResponse.result.values.length, 'location rows'); // ×œ×•×’ ×—×“×©
						
						for (const row of locationsResponse.result.values) {
							if (row[0] && row[1]) {
								const locationData = parseLocationFromRow(row);
								locations.push(locationData);
								importedCount++;
								
								await new Promise(resolve => setTimeout(resolve, 200));
							}
						}
						showToast(`×™×•×‘××• ${importedCount} ××™×§×•××™×`, 'success');
					} else {
						console.log('ğŸ“ No locations data found'); // ×œ×•×’ ×—×“×©
					}
				} catch (error) {
					console.error('ğŸ“ Locations import error:', error); // ×œ×•×’ ×—×“×©
				}
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				// ×™×™×‘×•× ×‘×™×§×•×¨×™×
				try {
					console.log('ğŸ”§ Starting visits import...');
					
					const visitsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Visits!A2:M1000'
					});
					
					console.log('ğŸ”§ Visits response:', visitsResponse.result);
					
					let visitsCount = 0;
					if (visitsResponse.result.values && visitsResponse.result.values.length > 0) {
						console.log('ğŸ”§ Found', visitsResponse.result.values.length, 'visit rows');
						
						for (let i = 0; i < visitsResponse.result.values.length; i++) {
							const row = visitsResponse.result.values[i];
							if (row[0] && row[1]) {
								const visitData = parseVisitFromRow(row);
								if (!isDuplicateVisit(visitData)) {
									visits.push(visitData);
									// ×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×œ××—×¨ ×”×•×¡×¤×ª ×‘×™×§×•×¨ ×—×“×©
									//await updateSingleLocationTreatmentDates(visitData.location_id);
									visitsCount++;
								} else {
									console.log('âš ï¸ Duplicate visit skipped:', visitData.date, visitData.location_id);
								}
								visitsCount++;
								
								// ×”×¦×’ ×”×ª×§×“××•×ª ×›×œ 50 ×¨×©×•××•×ª
								if (visitsCount % 50 === 0) {
									console.log(`ğŸ”§ Processed ${visitsCount}/${visitsResponse.result.values.length} visits`);
									showToast(`××¢×‘×“ ×‘×™×§×•×¨ ${visitsCount}...`, 'info', 1000);
								}
								
								await new Promise(resolve => setTimeout(resolve, 100)); // ×”××ª× ×” ×§×¦×¨×” ×™×•×ª×¨
							}
						}
						showToast(`×™×•×‘××• ${visitsCount} ×‘×™×§×•×¨×™×`, 'success');
					} else {
						console.log('ğŸ”§ No visits data found');
					}
				} catch (error) {
					console.error('ğŸ”§ Visits import error:', error);
				}
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				// ×™×™×‘×•× ×§×‘×œ×•×ª
				try {
					console.log('ğŸ§¾ Starting receipts import...');
					
					const receiptsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Receipts!A2:J1000'
					});
					
					console.log('ğŸ§¾ Receipts response:', receiptsResponse.result);
					
					let receiptsCount = 0;
					if (receiptsResponse.result.values && receiptsResponse.result.values.length > 0) {
						console.log('ğŸ§¾ Found', receiptsResponse.result.values.length, 'receipt rows');
						
						for (let i = 0; i < receiptsResponse.result.values.length; i++) {
							const row = receiptsResponse.result.values[i];
							if (row[0] && row[3]) { // ID ×•×ª××¨×™×š
								const receiptData = parseReceiptFromRow(row);
								
								
								if (!isDuplicateReceipt(receiptData)) {
									receipts.push(receiptData);
									receiptsCount++;
								} else {
									console.log('âš ï¸ Duplicate receipt skipped:', receiptData.date, receiptData.location_id);
								}
								
								// ×”×¦×’ ×”×ª×§×“××•×ª ×›×œ 25 ×¨×©×•××•×ª (×§×‘×œ×•×ª ×‘×“×¨×š ×›×œ×œ ×¤×—×•×ª)
								if (receiptsCount % 25 === 0) {
									console.log(`ğŸ§¾ Processed ${receiptsCount}/${receiptsResponse.result.values.length} receipts`);
									showToast(`××¢×‘×“ ×§×‘×œ×” ${receiptsCount}...`, 'info', 1000);
								}
								
								await new Promise(resolve => setTimeout(resolve, 100)); // ×”××ª× ×” ×§×¦×¨×” ×™×•×ª×¨
							}
						}
						showToast(`×™×•×‘××• ${receiptsCount} ×§×‘×œ×•×ª`, 'success');
					} else {
						console.log('ğŸ§¾ No receipts data found');
					}
				} catch (error) {
					console.error('ğŸ§¾ Receipts import error:', error);
				}
				
				// ×©××™×¨×” ××§×•××™×ª ×•×¢×“×›×•×Ÿ ×ª×¦×•×’×”
				saveToLocalStorage();
				loadLocationsTable();
				loadReceiptsTable();
				loadFilterOptions();

				// ×‘×“×™×§×” ×©×”× ×ª×•× ×™× × ×˜×¢× ×• × ×›×•×Ÿ
				console.log('ğŸ” ×‘×“×™×§×ª ×™×™×‘×•×:');
				console.log(`×œ×§×•×—×•×ª: ${locations.length}`);
				console.log(`×‘×™×§×•×¨×™×: ${visits.length}`);
				console.log(`×§×‘×œ×•×ª: ${receipts.length}`);

				// ×”×¦×’ ×“×•×’××” ×©×œ ×”×¨×©×•××” ×”×¨××©×•× ×” ××›×œ ×¡×•×’
				if (locations.length > 0) {
					console.log('×“×•×’××” ×œ×§×•×—:', locations[0]);
				}
				if (visits.length > 0) {
					console.log('×“×•×’××” ×‘×™×§×•×¨:', visits[0]);
				}


				// ×ª×•×¡×¤×” ×—×©×•×‘×” - ×©××™×¨×” ×œ×¢× ×Ÿ!
				showToast('×©×•××¨ × ×ª×•× ×™× ×—×“×©×™× ×œ×¢× ×Ÿ...', 'info');

				try {
					/// await saveAllToSheets();
					/// await saveAllToSheetsOptimized();
					
					// ×©××™×¨×” ××”×™×¨×” ×œ×¤×™ ×¡×•×’ × ×ª×•× ×™×
					const locationSuccess = await saveLocationsBatch(newLocations || []);
					const visitSuccess = await saveVisitsBatch(newVisits || []);  
					const receiptSuccess = await saveReceiptsBatch(newReceipts || []);

					if (locationSuccess && visitSuccess && receiptSuccess) {
						showToast('ğŸš€ ×©××™×¨×” ××”×™×¨×” ×”×•×©×œ××” ×‘×”×¦×œ×—×”!', 'success');
					} else {
						showToast('âš ï¸ ×—×œ×§ ××”× ×ª×•× ×™× ×œ× × ×©××¨×• ×œ×¢× ×Ÿ', 'warning');
					}

					showToast(`ğŸ‰ ×™×™×‘×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”!
					ğŸ“ ${locationsCount || 0} ××™×§×•××™×
					ğŸ”§ ${visitsCount || 0} ×‘×™×§×•×¨×™×  
					ğŸ§¾ ${receiptsCount || 0} ×§×‘×œ×•×ª
					âœ… ×”×›×œ × ×©××¨ ×œ×¢× ×Ÿ!`, 'success', 6000);
				} catch (error) {
					console.error('Error saving imported data to cloud:', error);
					showToast('×™×™×‘×•× ×”×•×©×œ× ××§×•××™×ª, ××‘×œ ×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ', 'warning');
				}
				
			} catch (error) {
				console.error('Import error:', error);
				showToast('×©×’×™××” ×‘×™×™×‘×•× × ×ª×•× ×™×', 'error');
			} finally {
				hideLoading();
			}
		}

	
		// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×¤×¨×¡×•×¨ ×©×•×¨×•×ª
		function parseVisitFromRow(row) {
			return {
				ID: row[0] || generateID(),
				date: row[1] || '',
				location_id: row[2] || '',
				location_name: row[3] || '',
				visit_type: row[4] || '',
				work_done: row[5] || '',
				duration_minutes: parseInt(row[6]) || 0,
				num_workers: parseInt(row[7]) || 1,
				start_time: row[8] || '',
				end_time: row[9] || '',
				amount: parseFloat(row[10]) || 0,
				paid: (row[11] === '×›×Ÿ' || row[11] === 'yes' || row[11] === '1') ? '1' : '0',
				expense: parseFloat(row[12]) || 0,
				notes: row[13] || ''
			};
		}



		function parseReceiptFromRow(row) {
			return {
				ID: row[0] || generateID(),
				booklet_number: row[1] || '',
				receipt_number: row[2] || '',
				date: row[3] || '',
				location_id: row[4] || '',
				location_name: row[5] || '',
				amount: parseFloat(row[6]) || 0,
				payment_type: row[7] || '',
				tax_code: row[8] || '',
				notes: row[9] || ''
			};
		}
	   
	   // ×”×•×¡×£ ××ª ×–×” ×œ×¡×•×£ ×”×§×•×“
		function updateImportTableStatus() {
			const importTableId = localStorage.getItem('importTableId');
			const statusDiv = document.getElementById('importTableStatus');
			
			if (importTableId && statusDiv) {
				statusDiv.innerHTML = `
					<span style="font-size: 13px; color: #28a745;">
						âœ… ×˜×‘×œ×ª ×¢×–×¨ ×–××™× ×”: 
						<a href="https://docs.google.com/spreadsheets/d/${importTableId}/edit" 
						   target="_blank" style="color: #007bff; text-decoration: underline;">
						   ×¤×ª×— ×˜×‘×œ×”
						</a>
					</span>
					<br>
					<button onclick="localStorage.removeItem('importTableId'); updateImportTableStatus();" 
							style="background: none; border: none; color: #dc3545; font-size: 12px; cursor: pointer; margin-top: 5px;">
						ğŸ—‘ï¸ ××—×§ ×§×™×©×•×¨ ×œ×˜×‘×œ×ª ×¢×–×¨
					</button>
				`;
			} else if (statusDiv) {
				statusDiv.innerHTML = `
					<span style="font-size: 13px; color: #666;">
						âŒ ×œ× × ××¦××” ×˜×‘×œ×ª ×¢×–×¨ ×©××•×¨×”
					</span>
					<br>
					<span style="font-size: 12px; color: #999;">
						×¦×•×¨ ×˜×‘×œ×ª ×¢×–×¨ ×—×“×©×” ×›×“×™ ×œ×™×™×‘× × ×ª×•× ×™×
					</span>
				`;
			}
		}

		// ×”×¨×¥ ××ª ×–×” ×›×©×”×“×£ × ×˜×¢×Ÿ
		document.addEventListener('DOMContentLoaded', function() {
			updateImportTableStatus();
		});

		// ×”×¨×¥ ×’× ×›×©×¢×•×‘×¨×™× ×œ×˜××‘ ×”××¢×¨×›×ª
		function showTab(event, tabName) {
			// ×”×§×•×“ ×”×§×™×™× ×©×œ×š...
			
			// ×”×•×¡×£ ××ª ×–×” ×‘×¡×•×£ ×”×¤×•× ×§×¦×™×”
			if (tabName === 'system') {
				setTimeout(() => {
					updateImportTableStatus();
					updateTelegramHelperStatus(); // ×”×•×¡×£ ×©×•×¨×” ×–×•
				}, 100);
			}
		}
	   
	   


		// ×”×•×¡×£ ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ××™×“×¢ ×¢×œ ×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨×
		function updateTelegramHelperStatus() {
			const telegramTableId = localStorage.getItem('telegramHelperTableId');
			const statusDiv = document.getElementById('telegramHelperStatus');
			
			if (statusDiv) {
				if (telegramTableId) {
					statusDiv.innerHTML = `
						<span style="color: green;">âœ“ ×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨× ××•×›× ×”</span>
						<br>
						<a href="https://docs.google.com/spreadsheets/d/${telegramTableId}" target="_blank" style="font-size: 12px;">
							×¤×ª×— ×‘×’×•×’×œ ×©×™×˜×¡
						</a>
					`;
				} else {
					statusDiv.innerHTML = `
						<span style="color: orange;">âš  ×œ× × ××¦××” ×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨×</span>
						<br>
						<span style="font-size: 12px;">×¦×•×¨ ×˜×‘×œ×” ×—×“×©×” ×ª×—×™×œ×”</span>
					`;
				}
			}
		}


		// ×¤×•× ×§×¦×™×” ×¢×–×¨ ×œ×¡×™×•× ×‘×™×§×•×¨
		function finalizeVisit(visit, pendingNotes) {
			const client = visit.client;
			
			// ×× ×œ× × ××¦× ×–××Ÿ, × ×¡×” ×œ×—×©×‘ ××”×©×¢×•×ª ××• ×§×‘×¢ ×‘×¨×™×¨×ª ××—×“×œ
			if (visit.duration === 0) {
				if (visit.time) {
					// ×›××Ÿ ××¤×©×¨ ×œ×”×•×¡×™×£ ×œ×•×’×™×§×” ×œ×—×™×©×•×‘ ×–××Ÿ ××”×¤×¨×© ×©×¢×•×ª
					visit.duration = 60; // ×‘×¨×™×¨×ª ××—×“×œ ×©×œ ×©×¢×”
				} else {
					visit.duration = 60;
				}
			}
			
			// ×¤×•×¨××˜ ×©××ª××™× ×‘×“×™×•×§ ×œ×§×•×“ ×”×§×™×™× ×©×œ confirmTelegramImport
			return {
				date: visit.date,
				time: visit.time || '',
				client_name: client ? client.name : '×œ× ×–×•×”×”',
				client_id: client ? client.ID : null,
				address: client ? client.full_address : '',
				work_done: visit.workDescription.join(' '),
				duration_minutes: visit.duration,
				raw_text: visit.workDescription.join('\n') + '\n' + [...visit.notes, ...pendingNotes].join('\n')
			};
		}

		// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×–×™×”×•×™ ×“×¤×•×¡×™×
		function isDateLine(line) {
			// ×–×™×”×•×™ ×ª××¨×™×š ×›××• "15 August 2024"
			const dateRegex = /^\d{1,2}\s+[A-Za-z]+\s+\d{4}$/;
			return dateRegex.test(line);
		}

		function isTimeLine(line) {
			// ×–×™×”×•×™ ×©×¢×” ×›××• "13:39"
			const timeRegex = /^\d{1,2}:\d{2}$/;
			return timeRegex.test(line);
		}

		function parseTelegramDate(dateStr) {
			// ×”××¨ "15 August 2024" ×œ-"2024-08-15"
			const months = {
				'January': '01', 'February': '02', 'March': '03', 'April': '04',
				'May': '05', 'June': '06', 'July': '07', 'August': '08',
				'September': '09', 'October': '10', 'November': '11', 'December': '12'
			};
			
			const parts = dateStr.split(' ');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = months[parts[1]] || '01';
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			
			return '';
		}



		// ×¤×•× ×§×¦×™×” ×¢×–×¨ ×œ××¦×™××ª ×œ×§×•×— ×œ×¤×™ ×©×
		function findLocationByName(customerName) {
			if (!customerName) return null;
			
			return locations.find(loc => 
				loc.name && loc.name.toLowerCase().includes(customerName.toLowerCase())
			) || null;
		}


		// ×¤×•× ×§×¦×™×” ××©×•×¤×¨×ª ×œ×–×™×”×•×™ ×œ×§×•×—×•×ª - ×ª×—×œ×™×£ ××ª findClientInText ×”×§×™×™××ª
		function findClientSmart(text, locations) {
			if (!text || !locations) return null;
			
			const textLower = text.toLowerCase().trim();
			
			// ×©×œ×‘ 1: ×”×ª×××” ×™×©×™×¨×” ××œ××”
			//for (const location of locations) {
			//	if (location.name && textLower.includes(location.name.toLowerCase())) {
			//		return location;
			//	}
			//	if (location.full_address && textLower.includes(location.full_address.toLowerCase())) {
			//		return location;
			//	}
			//}
			
			// ×©×œ×‘ 2: ×–×™×”×•×™ ×œ×¤×™ ×¨×—×•×‘ + ××¡×¤×¨ (×¢× ××• ×‘×œ×™ ×¢×™×¨)
			const addressMatch = textLower.match(/([×-×ª\s']+)\s+(\d+)/);
			if (addressMatch) {
				const street = addressMatch[1].trim();
				const number = addressMatch[2];
				
				for (const location of locations) {
					if (location.name) {
						const locationParts = location.name.toLowerCase().split(' ');
						if (locationParts.length >= 2) {
							const locationStreet = locationParts[0];
							const locationNumber = locationParts[1];
							
							if (street.includes(locationStreet) && number === locationNumber) {
								return location;
							}
						}
					}
				}
			}
			
			// ×©×œ×‘ 3: ×–×™×”×•×™ ×©××•×ª ×—×œ×§×™×™× (×›××• "×•×™× ×™×§" ×‘××§×•× "×•×™× ×™×§ 49 ×¨××©×œ×¦")
			const words = textLower.split(/\s+/);
			for (const word of words) {
				if (word.length >= 3) { // ×¨×§ ××™×œ×™× ×©×œ 3 ××•×ª×™×•×ª ××• ×™×•×ª×¨
					for (const location of locations) {
						if (location.name && location.name.toLowerCase().startsWith(word)) {
							// ×•×•×“× ×©×–×” ×”×©× ×”×™×—×™×“ ×©××ª×—×™×œ ×›×š
							const matches = locations.filter(loc => 
								loc.name && loc.name.toLowerCase().startsWith(word)
							);
							if (matches.length === 1) {
								return location;
							}
						}
					}
				}
			}
			
			// ×©×œ×‘ 4: ×–×™×”×•×™ ×œ×¤×™ ×¨×—×•×‘ ×‘×œ×‘×“ (×œ×©××•×ª ×™×“×•×¢×™×)
			for (const word of words) {
				if (word.length >= 4) {
					for (const location of locations) {
						if (location.name) {
							const locationStreet = location.name.toLowerCase().split(' ')[0];
							if (locationStreet === word) {
								return location;
							}
						}
					}
				}
			}
			
			return null;
		}


		// ×¤×•× ×§×¦×™×” ××©×•×¤×¨×ª ×œ×—×™×œ×•×¥ ×–×× ×™× - ×ª×—×œ×™×£ ××ª extractDuration ×”×§×™×™××ª
		function extractTimeFromText(text) {
			if (!text) return 0;
			
			const textLower = text.toLowerCase().trim();
			
			// ×“×¤×•×¡ 1: ××¡×¤×¨ + "×©×¢×•×ª"
			let match = textLower.match(/(\d+(?:\.\d+)?)\s*×©×¢×•×ª/);
			if (match) {
				return Math.round(parseFloat(match[1]) * 60);
			}
			
			// ×“×¤×•×¡ 2: "×©×¢×ª×™×™×" ×¢× ×•×¨×™××¦×™×•×ª
			if (textLower.includes('×©×¢×ª×™×™×')) {
				if (textLower.includes('×•×—×¦×™')) return 150;
				if (textLower.includes('×•×¨×‘×¢')) return 135;
				if (textLower.includes('×•×©×œ×•×©×ª ×¨×‘×¢×™')) return 165;
				return 120;
			}
			
			// ×“×¤×•×¡ 3: "×©×¢×”" ×¢× ×•×¨×™××¦×™×•×ª
			if (textLower.includes('×©×¢×”') && !textLower.includes('×©×¢×•×ª')) {
				if (textLower.includes('×•×—×¦×™')) return 90;
				if (textLower.includes('×•×¨×‘×¢')) return 75;
				if (textLower.includes('×•×©×œ×•×©×ª ×¨×‘×¢×™')) return 105;
				return 60;
			}
			
			// ×“×¤×•×¡ 4: "×—×¦×™ ×©×¢×”", "×¨×‘×¢ ×©×¢×”"
			if (textLower.includes('×—×¦×™ ×©×¢×”')) return 30;
			if (textLower.includes('×¨×‘×¢ ×©×¢×”')) return 15;
			
			// ×“×¤×•×¡ 5: ××¡×¤×¨ ×¢×©×¨×•× ×™ ×¢× ×©×¢×•×ª (×›××• "1.75 ×©×¢×•×ª")
			match = textLower.match(/(\d+\.\d+)\s*×©×¢×”/);
			if (match) {
				return Math.round(parseFloat(match[1]) * 60);
			}
			
			// ×“×¤×•×¡ 6: ×›××•×™×•×ª ××™×œ×•×œ×™×•×ª
			if (textLower.includes('×›×©×¢×ª×™×™×')) return 120;
			if (textLower.includes('×›×©×¢×”')) return 60;
			if (textLower.includes('×›××¢×˜ ×©×¢×ª×™×™×')) return 115;
			if (textLower.includes('×›××¢×˜ ×©×¢×”')) return 55;
			
			// ×“×¤×•×¡ 7: ×“×§×•×ª
			match = textLower.match(/(\d+)\s*×“×§/);
			if (match) {
				return parseInt(match[1]);
			}
			
			// ×“×¤×•×¡ 8: ×‘×™×˜×•×™×™× ××™×•×—×“×™×
			if (textLower.includes('×œ×¤× ×™ ×¨×‘×¢ ×©×¢×”')) return 15;
			if (textLower.includes('×œ×¤× ×™ ×—×¦×™ ×©×¢×”')) return 30;
			if (textLower.includes('×œ×¤× ×™ ×›×©×¢×”')) return 60;
			
			// ×“×¤×•×¡ 9: ××¡×¤×¨×™× ×¢× × ×§×•×“×” (×›××• "2.5" ××• "3.25")
			match = textLower.match(/(\d+)\.(\d+)/);
			if (match) {
				const hours = parseInt(match[1]);
				const fraction = parseInt(match[2]);
				if (fraction === 5) return hours * 60 + 30; // .5 = ×—×¦×™ ×©×¢×”
				if (fraction === 25) return hours * 60 + 15; // .25 = ×¨×‘×¢ ×©×¢×”
				if (fraction === 75) return hours * 60 + 45; // .75 = ×©×œ×•×©×ª ×¨×‘×¢×™ ×©×¢×”
			}
			
			// ×“×¤×•×¡ 10: ×˜×•×•×—×™ ×–××Ÿ (×›××• "2-3 ×©×¢×•×ª")
			match = textLower.match(/(\d+)-(\d+)\s*×©×¢×•×ª/);
			if (match) {
				const avg = (parseInt(match[1]) + parseInt(match[2])) / 2;
				return Math.round(avg * 60);
			}
			
			return 0;
		}
	
		
		// ×¤×•× ×§×¦×™×” ×œ×–×™×”×•×™ ×”×× ×©×•×¨×” ××¦×™×™× ×ª ×ª×—×™×œ×ª ×‘×™×§×•×¨ ×—×“×©
		function isNewVisitStart(text, locations) {
			if (!text) return false;
			
			const textLower = text.toLowerCase().trim();
			
			// ×–×™×”×•×™ ×™×©×™×¨×•×ª ×©×œ ×œ×§×•×—
			if (findClientSmart(text, locations)) return true;
			
			// ×“×¤×•×¡×™ ×›×ª×•×‘×•×ª ×™×©×¨××œ×™×•×ª
			if (/[×-×ª\s']+\s+\d+/.test(text)) return true;
			
			// ××™×œ×•×ª ××¤×ª×— ×©××¦×™×™× ×•×ª ×”×ª×—×œ×ª ×¢×‘×•×“×”
			const startKeywords = [
				'××ª×—×™×œ', '×”×ª×—×œ×ª×™', '××ª×—×™×œ×™×',
				'×™×¦×™××”', '×”×’×¢×ª×™', '× ×•×¡×¢ ×œ',
				'×‘×“×™×§×ª ×”×©×§×™×”', '×˜×™×¤×•×œ ×¨××©×•× ×™',
				'×”×—×œ×¤×ª', '×”×ª×§× ×ª', '×ª×™×§×•×Ÿ'
			];
			
			for (const keyword of startKeywords) {
				if (textLower.includes(keyword)) return true;
			}
			
			// ×–×™×”×•×™ ×œ×¤×™ ×©××•×ª ×’× ×™×/××–×•×¨×™× ××•×›×¨×™×
			const gardenKeywords = [
				'××‘×¦×¢ × ×—×©×•×Ÿ', '××‘×¦×¢ ××©×”', '×”××¨×’× ×™×ª',
				'××–×¨', '×’×Ÿ ×™×‘× ×”', '×©×™×™× ×§×™×Ÿ'
			];
			
			for (const keyword of gardenKeywords) {
				if (textLower.includes(keyword.toLowerCase())) return true;
			}
			
			return false;
		}

		// ×¤×•× ×§×¦×™×” ×œ×–×™×”×•×™ ×”×× ×©×•×¨×” ××¦×™×™× ×ª ×¡×™×•× ×‘×™×§×•×¨
		function isVisitEnd(text) {
			if (!text) return false;
			
			const textLower = text.toLowerCase().trim();
			
			// ××™×œ×•×ª ×¡×™×•× ××¤×•×¨×©×•×ª
			if (textLower.includes('×¡×™×•×') || textLower.includes('×¡×™×™××ª×™')) return true;
			
			// ×‘×™×˜×•×™×™ ×–××Ÿ ×©××¦×™×™× ×™× ×¡×™×•×
			if (textLower.includes('×©×¢×•×ª') || textLower.includes('×©×¢×”')) {
				// ×× ×™×© ×–××Ÿ + ×‘×™×˜×•×™ ×¡×™×›×•×
				if (textLower.includes('×¡×”×›') || textLower.includes('×¢×“ ×›×”') || 
					textLower.includes('×›×•×œ×œ') || textLower.includes('×œ×§×—')) {
					return true;
				}
			}
			
			// ×‘×™×˜×•×™×™ ××¢×‘×¨ ×œ×‘×™×§×•×¨ ×”×‘×
			if (textLower.includes('× ×•×¡×¢ ×œ') || textLower.includes('×¢×•×‘×¨ ×œ') ||
				textLower.includes('×××©×™×š ×œ') || textLower.includes('×”×‘×™×ª×”')) {
				return true;
			}
			
			// ×”×¤×¡×§×•×ª ×©××¡×™×™××•×ª ×‘×™×§×•×¨
			if (textLower.includes('×”×¤×¡×§×” ×‘×‘×™×ª') || textLower.includes('×‘×‘×™×ª')) {
				return true;
			}
			
			return false;
		}

		// ×¤×•× ×§×¦×™×” ×œ×–×™×”×•×™ ×”×¢×¨×•×ª ×©×›×“××™ ×œ×©××•×¨
		function extractNotes(text) {
			if (!text) return '';
			
			const textLower = text.toLowerCase();
			let notes = [];
			
			// ×”×¢×¨×•×ª ×¢×œ ×ª×©×œ×•×
			if (textLower.includes('×§×™×‘×œ×ª×™') && /\d+/.test(text)) {
				notes.push(text);
			}
			
			// ×”×¢×¨×•×ª ×¢×œ ×”××©×š ×¢×‘×•×“×”
			if (textLower.includes('×œ×—×–×•×¨') || textLower.includes('×œ×”××©×™×š') ||
				textLower.includes('× ×©××¨') || textLower.includes('×¦×¨×™×š')) {
				notes.push(text);
			}
			
			// ×‘×¢×™×•×ª ××• ×ª×§×œ×•×ª
			if (textLower.includes('×‘×¢×™×”') || textLower.includes('×ª×§×œ×”') ||
				textLower.includes('×œ× ×¢×•×‘×“') || textLower.includes('× ×©×‘×¨')) {
				notes.push(text);
			}
			
			// ×”×¢×¨×•×ª ×¢×œ ××–×’ ××•×•×™×¨ ××• ×ª× ××™×
			if (textLower.includes('×’×©×') || textLower.includes('×—×•×') ||
				textLower.includes('×¨×˜×•×‘') || textLower.includes('×™×‘×©')) {
				notes.push(text);
			}
			
			return notes.join(' | ');
		}
		
	

		// ××™×©×•×¨ ×™×™×‘×•× ×”×‘×™×§×•×¨×™× ××˜×œ×’×¨× - ×’×™×¨×¡×” ××¢×•×“×›× ×ª
		async function confirmTelegramImport() {
			if (!window.pendingTelegramVisits || window.pendingTelegramVisits.length === 0) {
				showToast('××™×Ÿ ×‘×™×§×•×¨×™× ×œ×™×™×‘×•×', 'warning');
				return;
			}
			
			try {
				showLoading('××™×™×‘× ×‘×™×§×•×¨×™× ××˜×œ×’×¨×...');
				
				// ×©×œ×‘ 1: ×©××•×¨ ×œ×˜×‘×œ×ª TelegramVisits (×–×× ×™)
				const telegramVisitsWithIds = window.pendingTelegramVisits.map(visit => ({
					...visit,
					ID: generateID()
				}));
				
				await saveTelegramVisitsToCloud(telegramVisitsWithIds);
				
				// ×©×œ×‘ 2: ×”××¨ ×œ×‘×™×§×•×¨×™× ×¨×’×™×œ×™× ×‘××¢×¨×›×ª
				let importedCount = 0;
				
				for (const telegramVisit of telegramVisitsWithIds) {
					// ××¦× ××• ×¦×•×¨ ×œ×§×•×—
					let locationId = null;
					const existingLocation = locations.find(loc => 
						loc.name.toLowerCase() === telegramVisit.client_name.toLowerCase()
					);
					
					if (existingLocation) {
						locationId = existingLocation.ID;
					} else {
						// ×¦×•×¨ ×œ×§×•×— ×—×“×© ×× ×œ× ×§×™×™×
						locationId = generateID();
						const newLocation = {
							ID: locationId,
							name: telegramVisit.client_name,
							full_address: '',
							neighborhood: '',
							city: '',
							contact_person: '',
							phone: '',
							allowed_day: '×',
							interval_weeks: 4,
							temp_addition: false,
							base_amount: 0,
							active: true,
							notes: '× ×•×¦×¨ ××•×˜×•××˜×™×ª ××™×™×‘×•× ×˜×œ×’×¨×',
							last_visit: telegramVisit.date,
							next_visit: '',
							client_requests: ''
						};
						locations.push(newLocation);
					}
					
					// ×¦×•×¨ ×‘×™×§×•×¨ ×‘××¢×¨×›×ª ×”×¨××©×™×ª
					const visitData = {
						ID: generateID(),
						date: telegramVisit.date,
						location_id: locationId,
						location_name: telegramVisit.client_name,
						visit_type: '××œ×',  // âœ… FIX: Use correct visit type from your system
						work_done: telegramVisit.work_done,
						duration_minutes: telegramVisit.duration_minutes,
						num_workers: 1,
						start_time: telegramVisit.time || '',
						end_time: '',
						amount: 0,
						expense: 0,
						notes: `×™×•×‘× ××˜×œ×’×¨×: ${telegramVisit.raw_text}`
					};
					
					visits.push(visitData);
					importedCount++;
				}
				
				// ×©××•×¨ ×”×›×œ
				saveToLocalStorage();
				
				// ×¢×“×›×Ÿ ×ª×¦×•×’×•×ª
				loadLocationsTable();
				loadReceiptsTable();
				loadFilterOptions();
				
				// ×©××•×¨ ×œ×¢×œ× ×Ÿ
				await saveAllToSheetsOptimized();
				
				hideLoading();
				closeAnyModal();
				
				showToast(`ğŸ‰ ×™×™×‘×•× ×˜×œ×’×¨× ×”×•×©×œ×!
		ğŸ“± ${importedCount} ×‘×™×§×•×¨×™× ×™×•×‘××•
		ğŸ’¾ ×”×›×œ × ×©××¨ ×œ×¢×œ× ×Ÿ!`, 'success', 5000);
				
				// × ×§×” ××ª ×”× ×ª×•× ×™× ×”×–×× ×™×™×
				window.pendingTelegramVisits = null;
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×™×™×‘×•× ××˜×œ×’×¨×:', error);
				hideLoading();
				showToast('×©×’×™××” ×‘×™×™×‘×•× ××˜×œ×’×¨×', 'error');
			}
		}

		


		function showtelegramModal(content) {
			// ×”×¡×¨ ××•×“×œ ×§×™×™× ×× ×™×©
			const existingModal = document.getElementById('telegramModal');
			if (existingModal) {
				existingModal.remove();
			}
			
			// ×¦×•×¨ ××•×“×œ
			const modal = document.createElement('div');
			modal.id = 'telegramModal';
			modal.style.cssText = `
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.5);
				display: flex;
				justify-content: center;
				align-items: center;
				z-index: 1000;
			`;
			
			modal.innerHTML = content;
			document.body.appendChild(modal);
			
			// ×¡×’×™×¨×” ×‘×œ×—×™×¦×” ×¢×œ ×”×¨×§×¢
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					closeAnyModal();
				}
			});
		}

		function closeTelegramModal() {
			const modal = document.getElementById('telegramModal');
			if (modal) {
				modal.remove();
			}
		}
	   
	    function generateID() {
			return Date.now() + Math.random().toString(36).substr(2, 9);
		}
	   
	   
	   async function saveAllToSheetsOptimized() {
			if (!await validateToken()) {
				showToast('× ×“×¨×© ×—×™×‘×•×¨ ×œ×¢× ×Ÿ', 'warning');
				return false;
			}
			
			try {
				await checkAndFixTableStructure();
				
				// ×©××™×¨×ª ×›×œ ×”×˜×‘×œ××•×ª
				const locationSuccess = locations.length > 0 ? await saveLocationsBatch(locations) : true;
				const visitSuccess = visits.length > 0 ? await saveVisitsBatch(visits) : true;
				const receiptSuccess = receipts.length > 0 ? await saveReceiptsBatch(receipts) : true;
				const incomeSuccess = incomes.length > 0 ? await saveIncomesBatch(incomes) : true;
				const paymentSuccess = payments.length > 0 ? await savePaymentsBatch(payments) : true;
				const linkSuccess = paymentVisitLinks.length > 0 ? await savePaymentVisitLinksBatch(paymentVisitLinks) : true;

				const allSaved = locationSuccess && visitSuccess && receiptSuccess && incomeSuccess && paymentSuccess && linkSuccess;
							

			if (allSaved) {
					showToast('âœ… ×›×œ ×”× ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×”', 'success');
				} else {
					showToast('âš ï¸ ×—×œ×§ ××”× ×ª×•× ×™× ×œ× × ×©××¨×•', 'warning');
				}
				
				return allSaved;
				
			} catch (error) {
				console.error('Error saving all data:', error);
				showToast('×©×’×™××” ×‘×©××™×¨×ª × ×ª×•× ×™×', 'error');
				return false;
			}
		}
	   
	   // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×—×•×‘×•×ª
		function displayDebts() {
			const container = document.getElementById('debtsContainer');
			if (!container) return;
			
			// Get filter values
			const sortBy = document.getElementById('debtSortBy')?.value || 'amount_desc';
			const minAmount = parseFloat(document.getElementById('minDebtAmount')?.value) || 0;
			const selectedDay = document.getElementById('debtDayFilter')?.value || '';
			const selectedClientId = document.getElementById('debtClientSearch')?.getAttribute('data-selected-id') || '';
			
			// âœ… UPDATED: Calculate debts with partial payment support
			const clientDebts = new Map();
			
			visits.forEach(visit => {
				if (visit.amount > 0) {
					const visitAmount = parseFloat(visit.amount) || 0;
					const paidAmount = getVisitPaidAmount(visit.ID);
					const debt = visitAmount - paidAmount;
					
					// Only show if there's actual debt
					if (debt > 0.01) { // Small threshold for rounding errors
						const clientId = visit.location_id;
						if (!clientDebts.has(clientId)) {
							clientDebts.set(clientId, {
								clientId: clientId,
								clientName: visit.location_name || '×œ× ×™×“×•×¢',
								totalDebt: 0,
								visits: []
							});
						}
						
						const clientDebt = clientDebts.get(clientId);
						clientDebt.totalDebt += debt;
						
						const paidInfo = parsePaidField(visit.paid);
						clientDebt.visits.push({
							visitId: visit.ID,
							date: visit.date,
							amount: visitAmount,
							paidAmount: paidAmount,
							debt: debt,
							workDone: visit.work_done || '',
							paymentStatus: paidInfo.status
						});
					}
				}
			});
			
			// Convert to array
			let debtsArray = Array.from(clientDebts.values());
			
			// Apply filters
			if (minAmount > 0) {
				debtsArray = debtsArray.filter(d => d.totalDebt >= minAmount);
			}
			
			if (selectedClientId) {
				debtsArray = debtsArray.filter(d => d.clientId === selectedClientId);
			}
			
			if (selectedDay && selectedDay !== '') {
				debtsArray = debtsArray.filter(d => {
					const client = locations.find(loc => loc.ID === d.clientId);
					return client && client.allowed_day === selectedDay;
				});
			}
			
			// Sort
			debtsArray.sort((a, b) => {
				switch(sortBy) {
					case 'amount_desc': return b.totalDebt - a.totalDebt;
					case 'amount_asc': return a.totalDebt - b.totalDebt;
					case 'location': return a.clientName.localeCompare(b.clientName, 'he');
					case 'date_old': 
						return new Date(a.visits[0]?.date || '9999') - new Date(b.visits[0]?.date || '9999');
					case 'date_new':
						return new Date(b.visits[0]?.date || '0') - new Date(a.visits[0]?.date || '0');
					default: return 0;
				}
			});
			
			// Update statistics
			updateDebtStats(debtsArray);
			
			// Display debts
			if (debtsArray.length === 0) {
				container.innerHTML = '<div class="empty-state"><h3>ğŸ‰ ××™×Ÿ ×—×•×‘×•×ª ×¤×ª×•×—×™×!</h3></div>';
				return;
			}
			
			// âœ… UPDATED: Show partial payments in display
			const html = debtsArray.map(debt => `
				<div class="debt-card">
					<div class="debt-header">
						<h3>${debt.clientName}</h3>
						<div class="debt-total">${debt.totalDebt.toFixed(2)} â‚ª</div>
					</div>
					<div class="debt-visits">
						${debt.visits.map(v => `
							<div class="debt-visit-item">
								<span class="debt-date">${formatDate(v.date)}</span>
								<span class="debt-work">${v.workDone}</span>
								<span class="debt-amount">
									${v.amount} â‚ª
									${v.paymentStatus === '3' ? 
										`<span style="color: #f39c12; font-size: 11px;">(×©×•×œ×: ${v.paidAmount}â‚ª)</span>` : 
										''}
								</span>
							</div>
						`).join('')}
					</div>
					<div class="debt-actions">
						<button onclick="showAddPaymentModal('${debt.clientId}')" class="btn" style="background: #27ae60; color: white; flex: 1;">
							â• ×”×•×¡×£ ×ª×©×œ×•×
						</button>
						<button onclick="markClientDebtsPaid('${debt.clientId}')" class="btn-pay" style="flex: 1;">
							âœ“ ×¡××Ÿ ×”×›×œ ×›×©×•×œ×
						</button>
						<button onclick="showClientTreatments('${debt.clientId}')" class="btn-payment" style="flex: 1;">
							ğŸ“‹ ×¢×‘×•×¨ ×œ×˜×™×¤×•×œ×™×
						</button>
					</div>
				</div>
			`).join('');
			
			container.innerHTML = html;
		}


		async function markClientDebtsPaid(clientId) {
			const clientName = locations.find(loc => loc.ID === clientId)?.name || '×”×œ×§×•×—';
			
			if (!confirm(`×”×× ×œ×¡××Ÿ ××ª ×›×œ ×”×—×•×‘×•×ª ×©×œ ${clientName} ×›×©×•×œ××•?`)) {
				return;
			}
			
			// âœ… UPDATED: Mark as paid with today's date
			const today = new Date().toISOString().split('T')[0];
			let updatedCount = 0;
			
			visits.forEach(visit => {
				if (visit.location_id === clientId && visit.amount > 0) {
					const paidInfo = parsePaidField(visit.paid);
					
					// Only update if not already fully paid
					if (paidInfo.status !== 'paid' && paidInfo.status !== 'no_payment') {
						visit.paid = `paid:${today}`;
						updatedCount++;
					}
				}
			});
			
			if (updatedCount === 0) {
				showToast('××™×Ÿ ×—×•×‘×•×ª ×¤×ª×•×—×™× ×œ×œ×§×•×— ×–×”', 'info');
				return;
			}
			
			// Save locally
			saveToLocalStorage();
			
			// Save to cloud if connected
			if (access_token && SPREADSHEET_ID) {
				const success = await saveAllToSheetsOptimized();
				if (success) {
					showToast(`âœ… ${updatedCount} ×˜×™×¤×•×œ×™× ×¡×•×× ×• ×›×©×•×œ××• ×•× ×©××¨×• ×‘×¢× ×Ÿ`, 'success');
				} else {
					showToast(`âš ï¸ ${updatedCount} ×˜×™×¤×•×œ×™× ×¡×•×× ×• ×›×©×•×œ××• ××§×•××™×ª ×‘×œ×‘×“`, 'warning');
				}
			} else {
				showToast(`ğŸ’¾ ${updatedCount} ×˜×™×¤×•×œ×™× ×¡×•×× ×• ×›×©×•×œ××• ××§×•××™×ª`, 'info');
			}
			
			// Refresh displays
			displayDebts();
			filterVisits();
		}


		// Function to populate debt filter dropdowns
		// Update loadDebtFilterOptions function with safety checks:
		function loadDebtFilterOptions() {
			const clientSelect = document.getElementById('debtClientFilter');
			
			if (clientSelect) {
				clientSelect.innerHTML = '<option value="">All clients</option>';
				
				// Get unique clients with debts
				const clientsWithDebts = new Set();
				
				visits.forEach(visit => {
					if (visit.amount > 0) {
						const visitAmount = parseFloat(visit.amount) || 0;
						const paidAmount = getVisitPaidAmount(visit.ID);
						const debt = visitAmount - paidAmount;
						
						if (debt > 0) {
							clientsWithDebts.add(visit.location_id);
						}
					}
				});
				
				// Add clients to dropdown
				locations
					.filter(loc => clientsWithDebts.has(loc.ID))
					.sort((a, b) => a.name.localeCompare(b.name))
					.forEach(location => {
						const option = document.createElement('option');
						option.value = location.ID;
						option.textContent = location.name;
						clientSelect.appendChild(option);
					});
			}
		}


		// ×¢×“×›×•×Ÿ ×›×¨×˜×™×¡×™ ×¡×™×›×•×
		function updateDebtsSummary(debtsArray) {
			const totalDebt = debtsArray.reduce((sum, debt) => sum + debt.totalDebt, 0);
			const debtorsCount = debtsArray.length;
			const averageDebt = debtorsCount > 0 ? totalDebt / debtorsCount : 0;
			
			// ××¦×™××ª ×”×—×•×‘ ×”×›×™ ×™×©×Ÿ
			let oldestDebtDays = 0;
			if (debtsArray.length > 0) {
				const oldestVisit = debtsArray
					.flatMap(debt => debt.visits)
					.reduce((oldest, visit) => 
						new Date(visit.date) < new Date(oldest.date) ? visit : oldest
					);
				oldestDebtDays = Math.floor((new Date() - new Date(oldestVisit.date)) / (1000 * 60 * 60 * 24));
			}
			
			document.getElementById('totalDebt').textContent = `â‚ª${totalDebt.toLocaleString()}`;
			document.getElementById('totalDebt').style.color = totalDebt > 0 ? '#e74c3c' : '#27ae60';
			
			document.getElementById('debtorsCount').textContent = debtorsCount;
			document.getElementById('averageDebt').textContent = `â‚ª${Math.round(averageDebt).toLocaleString()}`;
			document.getElementById('oldestDebt').textContent = oldestDebtDays > 0 ? `${oldestDebtDays} ×™××™×` : '-';
			
			if (oldestDebtDays > 90) {
				document.getElementById('oldestDebt').style.color = '#e74c3c';
			} else if (oldestDebtDays > 30) {
				document.getElementById('oldestDebt').style.color = '#f39c12';
			}
		}

		// ×”×¦×’×ª ×¤×™×¨×•×˜ ×—×•×‘ ×œ×œ×§×•×— ×‘××•×“×œ × ×•×—
		function showDebtDetails(locationId) {
			const location = locations.find(loc => loc.ID == locationId);
			const locationVisits = visits.filter(v => v.location_id == locationId && v.paid === '0');
			
			if (!location || locationVisits.length === 0) {
				showToast('×œ× × ××¦××• ×—×•×‘×•×ª ×œ×œ×§×•×— ×–×”', 'info');
				return;
			}
			
			// ××™×•×Ÿ ×‘×™×§×•×¨×™× ×œ×¤×™ ×ª××¨×™×š
			locationVisits.sort((a, b) => new Date(a.date) - new Date(b.date));
			
			const totalDebt = locationVisits.reduce((sum, v) => sum + parseFloat(v.amount), 0);
			
			// ×™×¦×™×¨×ª ×¨×©×™××ª ×”×‘×™×§×•×¨×™×
			let visitsHTML = '';
			locationVisits.forEach(visit => {
				const workDone = visit.work_done || '×œ× ×¦×•×™×Ÿ';
				const notes = visit.notes ? `<div style="color: #888; font-size: 12px; margin-top: 5px;">ğŸ’­ ${visit.notes}</div>` : '';
				
				visitsHTML += `
					<div style="border: 1px solid #e9ecef; border-radius: 6px; padding: 12px; margin-bottom: 10px;">
						<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
							<strong>ğŸ“… ${formatDate(visit.date)}</strong>
							<strong style="color: #e74c3c;">â‚ª${parseFloat(visit.amount).toLocaleString()}</strong>
						</div>
						<div style="color: #666; font-size: 14px;">
							ğŸ”§ ${workDone}
						</div>
						${notes}
					</div>
				`;
			});
			
			// ×ª×•×›×Ÿ ×”××•×“×œ
			const modalContent = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 90vw; max-height: 70vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ’° ×¤×™×¨×•×˜ ×—×•×‘×•×ª - ${location.name}</h3>
					
					<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
						<strong>×¡×”"×› ×—×•×‘: â‚ª${totalDebt.toLocaleString()}</strong><br>
						<span style="color: #666;">××¡×¤×¨ ×˜×™×¤×•×œ×™×: ${locationVisits.length}</span>
					</div>
					
					<div style="max-height: 300px; overflow-y: auto;">
						${visitsHTML}
					</div>
					
					<div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
						<button type="button" onclick="markDebtAsPaid(${locationId}); closeAnyModal();" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
							âœ… ×¡××Ÿ ×›××¡×•×œ×§
						</button>
						<button type="button" onclick="closeAnyModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
							âŒ ×¡×’×•×¨
						</button>
					</div>
				</div>
			`;
			
			showEditModal(modalContent);
		}  

		// ×¡×™××•×Ÿ ×—×•×‘ ×›××¡×•×œ×§
		function markDebtAsPaid(locationId) {
			const location = locations.find(loc => loc.ID == locationId);
			if (!location) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			const unpaidVisits = visits.filter(v => v.location_id == locationId && v.paid === '0');
			
			if (unpaidVisits.length === 0) {
				showToast('××™×Ÿ ×—×•×‘×•×ª ×¤×ª×•×—×™× ×œ×œ×§×•×— ×–×”', 'info');
				return;
			}
			
			const totalDebt = unpaidVisits.reduce((sum, v) => sum + parseFloat(v.amount), 0);
			
			if (confirm(`×œ×¡××Ÿ ××ª ×›×œ ×”×—×•×‘×•×ª ×©×œ ${location.name} ×›××¡×•×œ×§×™×?\n\n×¡×”"×›: â‚ª${totalDebt.toLocaleString()}\n××¡×¤×¨ ×˜×™×¤×•×œ×™×: ${unpaidVisits.length}`)) {
				// ×¢×“×›×•×Ÿ ×›×œ ×”×‘×™×§×•×¨×™× ×”×—×™×™×‘×™×
				unpaidVisits.forEach(visit => {
					visit.paid = '1';
				});
				
				// ×©××™×¨×” ××§×•××™×ª
				saveToLocalStorage();
				
				// ×©××™×¨×” ×‘×¢× ×Ÿ ×× ××—×•×‘×¨
				if (access_token && SPREADSHEET_ID) {
					saveAllToSheets().then(() => {
						console.log('âœ… ×—×•×‘×•×ª ×¢×•×“×›× ×• ×‘×¢× ×Ÿ');
					}).catch(error => {
						console.error('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¢× ×Ÿ:', error);
						showToast('×”×—×•×‘×•×ª ×¢×•×“×›× ×• ××§×•××™×ª, ××š ×œ× ×‘×¢× ×Ÿ', 'warning');
					});
				}
				
				// ×¨×¢× ×•×Ÿ ×”×ª×¦×•×’×”
				displayDebts();
				
				showToast(`×”×—×•×‘×•×ª ×©×œ ${location.name} ×¡×•×× ×• ×›××¡×•×œ×§×™×! (â‚ª${totalDebt.toLocaleString()})`, 'success');
			}
		}

	   
	    // ×”×ª×¨××” ×¢×œ ×—×•×‘×•×ª ×—××•×¨×™×
		function checkCriticalDebts() {
			const criticalDebts = visits.filter(visit => {
				if (visit.paid !== '0') return false;
				
				const daysSince = Math.floor((new Date() - new Date(visit.date)) / (1000 * 60 * 60 * 24));
				return daysSince > 90 || parseFloat(visit.amount) > 1000;
			});
			
			if (criticalDebts.length > 0) {
				const totalCritical = criticalDebts.reduce((sum, visit) => sum + parseFloat(visit.amount), 0);
				
				showToast(
					`âš ï¸ ×™×© ${criticalDebts.length} ×—×•×‘×•×ª ×“×—×•×¤×™× (â‚ª${totalCritical.toLocaleString()})`, 
					'warning', 
					8000
				);
			}
		}
	   
	   
	    // ×“×•×— ×”×›× ×¡×•×ª ×œ×—×•×“×© × ×•×›×—×™
		function generateMonthlyReport() {
			const currentMonth = new Date().getMonth();
			const currentYear = new Date().getFullYear();
			
			const monthlyVisits = visits.filter(visit => {
				const visitDate = new Date(visit.date);
				return visitDate.getMonth() === currentMonth && 
					   visitDate.getFullYear() === currentYear;
			});
			
			const totalRevenue = monthlyVisits.reduce((sum, visit) => 
				sum + parseFloat(visit.amount || 0), 0);
			
			const paidRevenue = monthlyVisits
				.filter(visit => visit.paid === '1')
				.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			const totalHours = monthlyVisits.reduce((sum, visit) => 
				sum + (visit.duration_minutes || 0) / 60, 0);
			
			const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™',
				'×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
			
			const report = {
				month: monthNames[currentMonth],
				year: currentYear,
				totalVisits: monthlyVisits.length,
				totalRevenue: totalRevenue,
				paidRevenue: paidRevenue,
				pendingRevenue: totalRevenue - paidRevenue,
				totalHours: totalHours.toFixed(1),
				avgPerVisit: monthlyVisits.length > 0 ? Math.round(totalRevenue / monthlyVisits.length) : 0
			};
			
			return report;
		}

		// ×”×¦×’×ª ×“×•×— ×‘××•×“×œ
		function showMonthlyReport() {
			const report = generateMonthlyReport();
			
			const reportHTML = `
				<div style="background: white; padding: 20px; border-radius: 10px; max-width: 500px;">
					<h3>ğŸ“Š ×“×•×— ${report.month} ${report.year}</h3>
					
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
						<div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #1976d2;">${report.totalVisits}</div>
							<div style="color: #666;">×‘×™×§×•×¨×™×</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #2e7d32;">â‚ª${report.totalRevenue.toLocaleString()}</div>
							<div style="color: #666;">×¡×”"×› ×”×›× ×¡×•×ª</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #f3e5f5; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #7b1fa2;">â‚ª${report.paidRevenue.toLocaleString()}</div>
							<div style="color: #666;">× ×’×‘×”</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #fff3e0; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #f57c00;">â‚ª${report.pendingRevenue.toLocaleString()}</div>
							<div style="color: #666;">×‘×”××ª× ×”</div>
						</div>
					</div>
					
					<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
						<div><strong>×©×¢×•×ª ×¢×‘×•×“×”:</strong> ${report.totalHours} ×©×¢×•×ª</div>
						<div><strong>×××•×¦×¢ ×œ×‘×™×§×•×¨:</strong> â‚ª${report.avgPerVisit}</div>
						<div><strong>×××•×¦×¢ ×œ×©×¢×”:</strong> â‚ª${Math.round(report.paidRevenue / parseFloat(report.totalHours) || 0)}</div>
					</div>
					
					<button onclick="closeAnyModal()" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; width: 100%;">
						×¡×’×•×¨
					</button>
				</div>
			`;
			
			showModal(reportHTML);
		}
	   
	    function isDuplicateVisit(newVisit) {
			return visits.some(existing => 
				existing.location_id === newVisit.location_id &&
				existing.date === newVisit.date &&
				existing.work_done === newVisit.work_done &&
				existing.amount === newVisit.amount
			);
		}
	   
	    function isDuplicateReceipt(newReceipt) {
			return receipts.some(existing => 
				existing.receipt_number === newReceipt.receipt_number &&
				existing.booklet_number === newReceipt.booklet_number &&
				existing.date === newReceipt.date
			);
		}
		
		
		function removeDuplicates() {
			const uniqueVisits = [];
			const seen = new Set();
			
			visits.forEach(visit => {
				const key = `${visit.location_id}-${visit.date}-${visit.work_done}-${visit.amount}`;
				if (!seen.has(key)) {
					seen.add(key);
					uniqueVisits.push(visit);
				}
			});
			
			const removedCount = visits.length - uniqueVisits.length;
			visits = uniqueVisits;
			
			console.log(`Removed ${removedCount} duplicate visits`);
			return removedCount;
		}
	   
	   function validateVisitData(visitData) {
			const errors = [];
			
			if (!visitData.location_id) {
				errors.push('×—×¡×¨ ××–×”×” ×œ×§×•×—');
			}
			
			if (!visitData.date) {
				errors.push('×—×¡×¨ ×ª××¨×™×š');
			}
			
			if (!visitData.work_done || visitData.work_done.trim() === '') {
				errors.push('×—×¡×¨ ×ª×™××•×¨ ×¢×‘×•×“×”');
			}
			
			return errors;
		}


	   // ×©××™×¨×” ××§×‘×¦×™×ª ×©×œ ×œ×§×•×—×•×ª
		async function saveLocationsBatch(locationsArray) {
			if (!await validateToken() || locationsArray.length === 0) return false;
			
			try {
				const locationValues = locationsArray.map(loc => [
					loc.ID,
					loc.name,
					loc.full_address,
					loc.neighborhood,
					loc.city,
					loc.contact_person,
					loc.phone,
					loc.allowed_day,
					loc.interval_weeks,
					loc.temp_addition || 0,
					loc.base_amount,
					loc.active,
					loc.notes || '',
					loc.last_visit || '',
					loc.next_visit || '',
					loc.client_requests || ''  // ×©×“×” ×—×¡×¨!
				]);
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `Locations!A2:P${locationValues.length + 1}`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: locationValues }
				});
				
				console.log(`âœ… Saved ${locationsArray.length} locations to cloud`);
				return true;
			} catch (error) {
				console.error('Error saving locations batch:', error);
				return false;
			}
		}

		// ×©××™×¨×” ××§×‘×¦×™×ª ×©×œ ×‘×™×§×•×¨×™×
		async function saveVisitsBatch(visitsToSave) {
			if (!await validateToken()) return false;
			
			try {
				console.log('ğŸ”µ saveVisitsBatch called with', visitsToSave.length, 'visits');
				
				const values = visitsToSave.map(visit => [
					visit.ID || '',
					visit.date || '',
					visit.location_id || '',
					visit.location_name || '',
					visit.visit_type || '',
					visit.work_done || '',
					visit.duration_minutes || 0,
					visit.num_workers || 1,
					visit.start_time || '',
					visit.end_time || '',
					visit.amount || 0,
					visit.paid || 'no',  // âœ… ADDED: paid field in correct position
					visit.expense || 0,
					visit.notes || ''
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Visits!A:N',  // âœ… UPDATED: Now 14 columns (A:N)
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`âœ… Saved ${visitsToSave.length} visits to cloud`);
				return true;
				
			} catch (error) {
				console.error('Error saving visits batch:', error);
				return false;
			}
		}

		// ×©××™×¨×” ××§×‘×¦×™×ª ×©×œ ×§×‘×œ×•×ª
		async function saveReceiptsBatch(receiptsArray) {
			if (!await validateToken() || receiptsArray.length === 0) return false;
			
			try {
				// ×§×¨× ××ª ×”× ×ª×•× ×™× ×”×§×™×™××™× ×§×•×“×
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Receipts!A:A'
				});
				
				const existingIDs = new Set(response.result.values?.slice(1).map(row => row[0]) || []);
				
				// ×¡× ×Ÿ ×¨×§ ×¨×©×•××•×ª ×—×“×©×•×ª
				const newReceipts = receiptsArray.filter(receipt => !existingIDs.has(receipt.ID));
				
				if (newReceipts.length === 0) {
					console.log('âœ… No new receipts to save');
					return true;
				}
				
				const values = newReceipts.map(receipt => [
					receipt.ID,
					receipt.book_number,
					receipt.receipt_number,
					formatDateForSheets(receipt.date),
					receipt.location_id,
					receipt.location_name,
					receipt.amount,
					receipt.payment_type,
					receipt.notes
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:I`,
					valueInputOption: 'USER_ENTERED',
					resource: { 
						values: values,
						majorDimension: 'ROWS'
					}
				});
				
				console.log(`âœ… Saved ${newReceipts.length} receipts in batch - from ${receiptsArray.length}`);
				return true;
			} catch (error) {
				console.error('Error in batch save receipts:', error);
				return false;
			}
		}
		
		
		// ×©××™×¨×” ××§×‘×¦×™×ª ×©×œ ×ª×©×œ×•××™×
		async function savePaymentsBatch(paymentsArray) {
			if (!await validateToken()) return false;
			
			try {
				console.log('ğŸ’³ savePaymentsBatch called with', paymentsArray.length, 'payments');
				
				const values = paymentsArray.map(payment => [
					payment.ID || '',
					payment.date || '',
					payment.client_id || '',
					payment.client_name || '',
					payment.amount || 0,
					payment.payment_method || '',
					payment.notes || '',
					payment.reference || '',
					payment.check_date || ''
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Payments!A:I',
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`âœ… Saved ${paymentsArray.length} payments to cloud`);
				return true;
				
			} catch (error) {
				console.error('Error saving payments batch:', error);
				return false;
			}
		}

		// ×©××™×¨×” ××§×‘×¦×™×ª ×©×œ ×§×™×©×•×¨×™ ×ª×©×œ×•××™×
		async function savePaymentVisitLinksBatch(linksArray) {
			if (!await validateToken()) return false;
			
			try {
				console.log('ğŸ”— savePaymentVisitLinksBatch called with', linksArray.length, 'links');
				
				const values = linksArray.map(link => [
					link.ID || '',
					link.payment_id || '',
					link.visit_id || '',
					link.amount_allocated || 0
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'PaymentVisitLink!A:D',
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`âœ… Saved ${linksArray.length} payment links to cloud`);
				return true;
				
			} catch (error) {
				console.error('Error saving payment links batch:', error);
				return false;
			}
		}
		
	   
	   // ===== ×× ×’× ×•×Ÿ ×ª×©×œ×•××™× ×—×“×© ===== 

		// ×¤×ª×™×—×ª ××•×“×œ ×œ×”×•×¡×¤×ª ×ª×©×œ×•× ×—×“×©
		function showAddPaymentModal(clientId = null) {
			let selectedClientId = clientId;
			let selectedClientName = '';
			
			// ×× ×™×© ×œ×§×•×— × ×‘×—×¨, ×§×— ××ª ×”×©× ×©×œ×•
			if (clientId) {
				const client = locations.find(loc => loc.ID === clientId);
				if (client) {
					selectedClientName = client.name;
				}
			}
			
			const modalHTML = `
				<div style="background: white; padding: 30px; border-radius: 12px; max-width: 700px; width: 90vw; max-height: 80vh; overflow-y: auto; direction: rtl;">
					<h3 style="margin-bottom: 25px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
						ğŸ’° ×”×•×¡×¤×ª ×ª×©×œ×•× ×—×“×©
					</h3>
					
					<!-- ×‘×—×™×¨×ª ×œ×§×•×— -->
					<div class="form-group" style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: bold;">×œ×§×•×—:</label>
						${clientId ? 
							`<input type="text" value="${selectedClientName}" disabled style="width: 100%; padding: 10px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 6px;">` :
							`<input type="text" 
								id="paymentClientSearch" 
								placeholder="×”×ª×—×œ ×œ×”×§×œ×™×“ ×©× ×œ×§×•×—..."
								oninput="searchClientForPayment(this.value)"
								autocomplete="off"
								style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
							<input type="hidden" id="selectedPaymentClientId">
							<div id="paymentClientResults" style="border: 1px solid #ddd; border-top: none; max-height: 150px; overflow-y: auto; display: none;"></div>`
						}
					</div>
					
					<!-- ×ª××¨×™×š ×•×©×¢×” -->
					<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 20px;">
						<div class="form-group">
							<label style="display: block; margin-bottom: 8px; font-weight: bold;">×ª××¨×™×š:</label>
							<input type="date" id="paymentDate" value="${new Date().toISOString().split('T')[0]}" 
								style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
						</div>
						<div class="form-group">
							<label style="display: block; margin-bottom: 8px; font-weight: bold;">×©×¢×”:</label>
							<input type="time" id="paymentTime" value="${new Date().toTimeString().slice(0,5)}"
								style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
						</div>
					</div>
					
					<!-- ×¡×›×•× ×•×××¦×¢×™ ×ª×©×œ×•× -->
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
						<div class="form-group">
							<label style="display: block; margin-bottom: 8px; font-weight: bold;">×¡×›×•× (â‚ª):</label>
							<input type="number" id="paymentAmount" placeholder="0" step="0.01"
								style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
						</div>
						<div class="form-group">
							<label style="display: block; margin-bottom: 8px; font-weight: bold;">×××¦×¢×™ ×ª×©×œ×•×:</label>
							<select id="paymentMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
								<option value="cash">××–×•××Ÿ</option>
								<option value="check">×¦'×§</option>
								<option value="transfer">×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
								<option value="app">××¤×œ×™×§×¦×™×” (×‘×™×˜/×¤×™×™×‘×•×§×¡)</option>
							</select>
						</div>
					</div>
					
					<!-- ×¤×¨×˜×™ ×¦'×§ (××•×¦×’ ×¨×§ ×× ×‘×—×¨×• ×¦'×§) -->
					<div id="checkDetailsSection" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
							<div class="form-group">
								<label style="display: block; margin-bottom: 8px; font-weight: bold;">××¡×¤×¨ ×¦'×§:</label>
								<input type="text" id="checkReference" placeholder="××¡×¤×¨ ×¦'×§"
									style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
							</div>
							<div class="form-group">
								<label style="display: block; margin-bottom: 8px; font-weight: bold;">×ª××¨×™×š ×¤×™×¨×¢×•×Ÿ:</label>
								<input type="date" id="checkDate"
									style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
							</div>
						</div>
					</div>
					
					<!-- ×”×¢×¨×•×ª -->
					<div class="form-group" style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: bold;">×”×¢×¨×•×ª:</label>
						<textarea id="paymentNotes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."
							style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
					</div>
					
					<!-- ×¨×©×™××ª ×˜×™×¤×•×œ×™× ×¤×ª×•×—×™× -->
					<div id="openVisitsSection" style="display: none; background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 2px solid #ffc107;">
						<h4 style="margin: 0 0 15px 0; color: #856404;">×‘×—×¨ ×˜×™×¤×•×œ×™× ×œ×¡×’×™×¨×”:</h4>
						<div id="openVisitsList" style="max-height: 200px; overflow-y: auto;"></div>
						<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 14px; color: #666;">
							<strong>×¡×›×•× × ×‘×—×¨:</strong> <span id="selectedVisitsTotal">0</span> â‚ª
						</div>
					</div>
					
					<!-- ×›×¤×ª×•×¨×™× -->
					<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
						<button onclick="closeAnyModal()" class="btn" style="background: #95a5a6; color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer;">
							×‘×™×˜×•×œ
						</button>
						<button onclick="saveNewPayment()" class="btn" style="background: #27ae60; color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
							ğŸ’¾ ×©××•×¨ ×ª×©×œ×•×
						</button>
					</div>
				</div>
			`;
			
			showModal(modalHTML);
			
			// ×©××™×¨×ª ×”×œ×§×•×— ×”× ×‘×—×¨ ×× ×™×©
			if (clientId) {
				window.selectedPaymentClientId = clientId;
				loadOpenVisitsForPayment(clientId);
			}
			
			// ×”×•×¡×¤×ª event listener ×œ×©×™× ×•×™ ×××¦×¢×™ ×ª×©×œ×•×
			setTimeout(() => {
				const methodSelect = document.getElementById('paymentMethod');
				if (methodSelect) {
					methodSelect.addEventListener('change', toggleCheckDetails);
				}
			}, 100);
		}


		// ×¤×•× ×§×¦×™×” ×—×“×©×”: ×¤×ª×™×—×ª ××•×“×œ ×ª×©×œ×•× ×¢×‘×•×¨ ×˜×™×¤×•×œ ×¡×¤×¦×™×¤×™
		function addPaymentForVisit(visitId) {
			const visit = visits.find(v => v.ID === visitId);
			if (!visit) {
				showToast('×˜×™×¤×•×œ ×œ× × ××¦×', 'error');
				return;
			}
			
			// ×¤×ª×™×—×ª ×”××•×“×œ ×¢× ×”×œ×§×•×— ×©×œ ×”×˜×™×¤×•×œ
			showAddPaymentModal(visit.location_id);
			
			// ×”××ª× ×” ×§×¦×¨×” ×œ×˜×¢×™× ×ª ×”××•×“×œ ×•××– ×‘×—×™×¨×ª ×”×˜×™×¤×•×œ ×”×¡×¤×¦×™×¤×™
			setTimeout(() => {
				const checkbox = document.querySelector(`input[type="checkbox"][data-visit-id="${visitId}"]`);
				if (checkbox) {
					checkbox.checked = true;
					updateSelectedVisitsTotal();
				}
			}, 300);
		}


		// ×”×¦×’×”/×”×¡×ª×¨×” ×©×œ ×¤×¨×˜×™ ×¦'×§
		function toggleCheckDetails() {
			const method = document.getElementById('paymentMethod').value;
			const checkSection = document.getElementById('checkDetailsSection');
			if (checkSection) {
				checkSection.style.display = (method === 'check') ? 'block' : 'none';
			}
		}

		// ×—×™×¤×•×© ×œ×§×•×— ×œ×”×•×¡×¤×ª ×ª×©×œ×•×
		function searchClientForPayment(searchTerm) {
			const resultsDiv = document.getElementById('paymentClientResults');
			
			if (!searchTerm || searchTerm.trim().length < 2) {
				resultsDiv.style.display = 'none';
				return;
			}
			
			const matchingClients = searchClientsAdvanced(searchTerm);
			
			if (matchingClients.length === 0) {
				resultsDiv.innerHTML = '<div style="padding: 10px; color: #999;">×œ× × ××¦××• ×œ×§×•×—×•×ª</div>';
				resultsDiv.style.display = 'block';
				return;
			}
			
			resultsDiv.innerHTML = matchingClients.slice(0, 10).map(client => {
				const safeName = client.name.replace(/'/g, '&#39;');
				return `
					<div onclick="selectClientForPayment('${client.ID}', '${safeName}')" 
						 style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; background: white;"
						 onmouseover="this.style.background='#f0f0f0'" 
						 onmouseout="this.style.background='white'">
						<strong>${client.name}</strong>
						${client.full_address ? `<br><small style="color: #666;">${client.full_address}</small>` : ''}
					</div>
				`;
			}).join('');
			
			resultsDiv.style.display = 'block';
		}

		// ×‘×—×™×¨×ª ×œ×§×•×— ×œ×”×•×¡×¤×ª ×ª×©×œ×•×
		function selectClientForPayment(clientId, clientName) {
			document.getElementById('paymentClientSearch').value = clientName;
			document.getElementById('selectedPaymentClientId').value = clientId;
			document.getElementById('paymentClientResults').style.display = 'none';
			
			window.selectedPaymentClientId = clientId;
			
			// ×˜×¢×Ÿ ×˜×™×¤×•×œ×™× ×¤×ª×•×—×™× ×©×œ ×”×œ×§×•×—
			loadOpenVisitsForPayment(clientId);
		}
	   
	   
	   // ×˜×¢×™× ×ª ×˜×™×¤×•×œ×™× ×¤×ª×•×—×™× ×©×œ ×œ×§×•×—
		function loadOpenVisitsForPayment(clientId) {
			const openVisitsSection = document.getElementById('openVisitsSection');
			const openVisitsList = document.getElementById('openVisitsList');
			
			if (!openVisitsSection || !openVisitsList) return;
			
			// ××¦× ××ª ×›×œ ×”×˜×™×¤×•×œ×™× ×”×¤×ª×•×—×™× (×œ× ×©×•×œ××• ×‘××œ×•××) ×©×œ ×”×œ×§×•×—
			const clientVisits = visits.filter(visit => {
				if (visit.location_id !== clientId) return false;
				if (!visit.amount || visit.amount <= 0) return false;
				
				// ×‘×“×•×§ ×× ×™×© ×—×•×‘
				const paidAmount = getVisitPaidAmount(visit.ID);
				const debt = parseFloat(visit.amount) - paidAmount;
				
				return debt > 0.01; // ×™×© ×—×•×‘
			});
			
			if (clientVisits.length === 0) {
				openVisitsSection.style.display = 'none';
				return;
			}
			
			// ××™×™×Ÿ ×œ×¤×™ ×ª××¨×™×š
			clientVisits.sort((a, b) => new Date(a.date) - new Date(b.date));
			
			// ×”×¦×’ ××ª ×”×˜×™×¤×•×œ×™×
			openVisitsList.innerHTML = clientVisits.map(visit => {
				const paidAmount = getVisitPaidAmount(visit.ID);
				const debt = parseFloat(visit.amount) - paidAmount;
				
				return `
					<div style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px; background: white;">
						<label style="display: flex; align-items: center; cursor: pointer;">
							<input type="checkbox" 
								   class="visit-checkbox" 
								   data-visit-id="${visit.ID}"
								   data-visit-amount="${visit.amount}"
								   data-visit-debt="${debt.toFixed(2)}"
								   onchange="updateSelectedVisitsTotal()"
								   style="margin-left: 10px; transform: scale(1.3);">
							<div style="flex: 1;">
								<div style="display: flex; justify-content: space-between; align-items: center;">
									<span style="font-weight: bold;">${formatDate(visit.date)}</span>
									<span style="color: #e74c3c; font-weight: bold;">${debt.toFixed(2)} â‚ª</span>
								</div>
								<div style="font-size: 13px; color: #666; margin-top: 4px;">
									${visit.work_done || '×˜×™×¤×•×œ'}
									${paidAmount > 0 ? `<span style="color: #f39c12;"> (×©×•×œ×: ${paidAmount}â‚ª)</span>` : ''}
								</div>
							</div>
						</label>
					</div>
				`;
			}).join('');
			
			openVisitsSection.style.display = 'block';
			updateSelectedVisitsTotal();
		}

		// ×¢×“×›×•×Ÿ ×¡×›×•× ×”×˜×™×¤×•×œ×™× ×”× ×‘×—×¨×™×
		function updateSelectedVisitsTotal() {
			const checkboxes = document.querySelectorAll('.visit-checkbox:checked');
			let total = 0;
			
			checkboxes.forEach(cb => {
				const debt = parseFloat(cb.getAttribute('data-visit-debt')) || 0;
				total += debt;
			});
			
			const totalSpan = document.getElementById('selectedVisitsTotal');
			if (totalSpan) {
				totalSpan.textContent = total.toFixed(2);
			}
		}

		// ×©××™×¨×ª ×ª×©×œ×•× ×—×“×©
		async function saveNewPayment() {
			// ×§×‘×œ × ×ª×•× ×™× ××”×˜×•×¤×¡
			const clientId = window.selectedPaymentClientId || document.getElementById('selectedPaymentClientId')?.value;
			const date = document.getElementById('paymentDate')?.value;
			const amount = parseFloat(document.getElementById('paymentAmount')?.value) || 0;
			const method = document.getElementById('paymentMethod')?.value;
			const notes = document.getElementById('paymentNotes')?.value || '';
			const reference = document.getElementById('checkReference')?.value || '';
			const checkDate = document.getElementById('checkDate')?.value || '';
			
			// ×‘×“×™×§×•×ª ×ª×§×™× ×•×ª
			if (!clientId) {
				showToast('×™×© ×œ×‘×—×•×¨ ×œ×§×•×—', 'error');
				return;
			}
			
			if (!date) {
				showToast('×™×© ×œ×”×–×™×Ÿ ×ª××¨×™×š', 'error');
				return;
			}
			
			if (amount <= 0) {
				showToast('×™×© ×œ×”×–×™×Ÿ ×¡×›×•× ×ª×§×™×Ÿ', 'error');
				return;
			}
			
			// ××¦× ××ª ×”×œ×§×•×—
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			// ×§×‘×œ ××ª ×”×˜×™×¤×•×œ×™× ×”× ×‘×—×¨×™×
			const selectedCheckboxes = document.querySelectorAll('.visit-checkbox:checked');
			const selectedVisits = Array.from(selectedCheckboxes).map(cb => ({
				visitId: cb.getAttribute('data-visit-id'),
				debt: parseFloat(cb.getAttribute('data-visit-debt'))
			}));
			
			// ×‘×“×•×§ ×©×™×© ×˜×™×¤×•×œ×™× × ×‘×—×¨×™×
			if (selectedVisits.length === 0) {
				if (!confirm('×œ× × ×‘×—×¨×• ×˜×™×¤×•×œ×™× ×œ×¡×’×™×¨×”. ×”×× ×œ×”××©×™×š ×‘×›×œ ×–××ª?')) {
					return;
				}
			}
			
			try {
				showLoading('×©×•××¨ ×ª×©×œ×•×...');
				
				// ×¦×•×¨ ××ª ×”×ª×©×œ×•×
				const payment = {
					ID: generateID(),
					date: date,
					client_id: clientId,
					client_name: client.name,
					amount: amount,
					payment_method: method,
					notes: notes,
					reference: reference,
					check_date: checkDate
				};
				
				// ×”×•×¡×£ ×œ×¨×©×™××ª ×”×ª×©×œ×•××™×
				payments.push(payment);
				
				// ×¦×•×¨ ×§×™×©×•×¨×™× ×œ×˜×™×¤×•×œ×™×
				let remainingAmount = amount;
				
				selectedVisits.forEach(selectedVisit => {
					if (remainingAmount <= 0) return;
					
					const visit = visits.find(v => v.ID === selectedVisit.visitId);
					if (!visit) return;
					
					const debt = selectedVisit.debt;
					const amountToAllocate = Math.min(remainingAmount, debt);
					
					// ×¦×•×¨ ×§×™×©×•×¨
					const link = {
						ID: generateID(),
						payment_id: payment.ID,
						visit_id: visit.ID,
						amount_allocated: amountToAllocate
					};
					
					paymentVisitLinks.push(link);
					
					// ×¢×“×›×Ÿ ××ª ×”×˜×™×¤×•×œ
					const currentPaid = getVisitPaidAmount(visit.ID);
					const newPaidAmount = currentPaid + amountToAllocate;
					const visitAmount = parseFloat(visit.amount);
					
					if (newPaidAmount >= visitAmount - 0.01) {
						// ×©×•×œ× ×‘××œ×•××•
						visit.paid = `paid:${date}`;
					} else {
						// ×©×•×œ× ×—×œ×§×™×ª
						visit.paid = `partial:${newPaidAmount.toFixed(2)}`;
					}
					
					remainingAmount -= amountToAllocate;
				});
				
				// ×©××•×¨ ××§×•××™×ª
				saveToLocalStorage();
				
				// ×©××•×¨ ×œ×¢× ×Ÿ
				if (access_token && SPREADSHEET_ID) {
					await saveAllToSheetsOptimized();
					showToast('âœ… ×ª×©×œ×•× × ×•×¡×£ ×‘×”×¦×œ×—×” ×•× ×©××¨ ×œ×¢× ×Ÿ!', 'success');
				} else {
					showToast('ğŸ’¾ ×ª×©×œ×•× × ×•×¡×£ ×‘×”×¦×œ×—×” (××§×•××™×ª)', 'info');
				}
				
				hideLoading();
				closeAnyModal();
				
				// ×¨×¢× ×Ÿ ×ª×¦×•×’×•×ª
				if (typeof displayDebts === 'function') {
					displayDebts();
				}
				if (typeof applyPaymentFilters === 'function') {
					applyPaymentFilters();
				}
				if (typeof filterVisits === 'function') {
					filterVisits();
				}
				
			} catch (error) {
				console.error('Error saving payment:', error);
				hideLoading();
				showToast('×©×’×™××” ×‘×©××™×¨×ª ×”×ª×©×œ×•×', 'error');
			}
		}


		// ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ××—×™×§×ª ×ª×©×œ×•× (×œ×¢×ª×™×“)
		function deletePayment(paymentId) {
			if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×ª×©×œ×•×? ×¤×¢×•×œ×” ×–×• ×ª×‘×˜×œ ××ª ×”×§×™×©×•×¨×™× ×œ×˜×™×¤×•×œ×™×.')) {
				return;
			}
			
			// ××—×§ ×§×™×©×•×¨×™×
			const linksToRemove = paymentVisitLinks.filter(link => link.payment_id === paymentId);
			linksToRemove.forEach(link => {
				const visit = visits.find(v => v.ID === link.visit_id);
				if (visit) {
					// ×”×—×–×¨ ××ª ×”×˜×™×¤×•×œ ×œ××¦×‘ ×œ× ×©×•×œ×
					visit.paid = 'unpaid';
				}
				
				// ××—×§ ××ª ×”×§×™×©×•×¨
				const linkIndex = paymentVisitLinks.findIndex(l => l.ID === link.ID);
				if (linkIndex > -1) {
					paymentVisitLinks.splice(linkIndex, 1);
				}
			});
			
			// ××—×§ ××ª ×”×ª×©×œ×•×
			const paymentIndex = payments.findIndex(p => p.ID === paymentId);
			if (paymentIndex > -1) {
				payments.splice(paymentIndex, 1);
			}
			
			// ×©××•×¨
			saveToLocalStorage();
			
			if (access_token && SPREADSHEET_ID) {
				saveAllToSheetsOptimized();
			}
			
			showToast('×ª×©×œ×•× × ××—×§ ×‘×”×¦×œ×—×”', 'success');
			
			// ×¨×¢× ×Ÿ ×ª×¦×•×’×•×ª
			if (typeof applyPaymentFilters === 'function') {
				applyPaymentFilters();
			}
			if (typeof displayDebts === 'function') {
				displayDebts();
			}
		}

	   
	   // ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ×•×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ××—×¨×•×Ÿ ×•×˜×™×¤×•×œ ×”×‘×
		// ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ×•×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ××—×¨×•×Ÿ ×•×˜×™×¤×•×œ ×”×‘× - ×’×¨×¡×” ××ª×§× ×ª
		async function calculateTreatmentDates() {
			console.log('ğŸ”„ ××—×©×‘ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ××—×¨×•×Ÿ ×•×˜×™×¤×•×œ ×”×‘×...');
			
			let updatedLocations = [];
			
			for (const location of locations) {
				// ××¦× ××ª ×›×œ ×”×˜×™×¤×•×œ×™× ×©×œ ×”×œ×§×•×— ×”×–×”
				const locationVisits = visits.filter(visit => visit.location_id === location.ID);
				
				if (locationVisits.length > 0) {
					// ××™×™×Ÿ ×œ×¤×™ ×ª××¨×™×š (×”×—×“×© ×‘×™×•×ª×¨ ×¨××©×•×Ÿ)
					locationVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
					
					// ×”×˜×™×¤×•×œ ×”××—×¨×•×Ÿ
					const lastVisit = locationVisits[0];
					const lastVisitDate = lastVisit.date;
					
					// ×—×™×©×•×‘ ×™×•× ××•×¢×“×£ ×œ×¤×™ ×”×‘×™×§×•×¨ ×”××—×¨×•×Ÿ
					if (!location.allowed_day || location.allowed_day === '') {
						const lastDate = new Date(lastVisitDate);
						const dayNames = ['×', '×‘', '×’', '×“', '×”', '×•', '×©'];
						location.allowed_day = dayNames[lastDate.getDay()];
						/// console.log(`ğŸ“… ${location.name}: ×™×•× ××•×¢×“×£ ×—×•×©×‘ ×›-${location.allowed_day} (×œ×¤×™ ×‘×™×§×•×¨ ×-${lastVisitDate})`);
					}
					
					// ×—×™×©×•×‘ ×ª××¨×™×š ×”×˜×™×¤×•×œ ×”×‘×
					const lastDate = new Date(lastVisitDate);
					const intervalDays = (location.interval_weeks || 4) * 7; // ×‘×¨×™×¨×ª ××—×“×œ 4 ×©×‘×•×¢×•×ª
					const nextDate = new Date(lastDate);
					nextDate.setDate(lastDate.getDate() + intervalDays);
					
					// ×¤×•×¨××˜ ×”×ª××¨×™×š ×œ-YYYY-MM-DD
					const nextVisitDate = nextDate.toISOString().split('T')[0];
					
					// ×¢×“×›×•×Ÿ ×”××•×‘×™×™×§×˜ ×”××§×•××™
					location.last_visit = lastVisitDate;
					location.next_visit = nextVisitDate;
					
					updatedLocations.push(location);
					
					// console.log(`ğŸ“… ${location.name}: ×˜×™×¤×•×œ ××—×¨×•×Ÿ ${lastVisitDate} â†’ ×˜×™×¤×•×œ ×”×‘× ${nextVisitDate}`);
				}
			}
			
			// ×¢×“×›×•×Ÿ ×‘×’×•×’×œ ×©×™×˜×¡ ×‘××§×‘×™×œ - ×§×¨×™××” ××—×ª ×‘×œ×‘×“ ×¢×‘×•×¨ ×›×œ ×”×œ×§×•×—×•×ª
			if (updatedLocations.length > 0) {
				console.log(`ğŸ”„ ××¢×“×›×Ÿ ${updatedLocations.length} ×œ×§×•×—×•×ª ×‘×’×•×’×œ ×©×™×˜×¡...`);
				await updateTreatmentDatesInSheets(updatedLocations);
				showToast(`ğŸ“… ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×¢×•×“×›× ×• ×¢×‘×•×¨ ${updatedLocations.length} ×œ×§×•×—×•×ª`, 'success', 2000);
			}
			
			// ×¨×¢× ×Ÿ × ×ª×•× ×™ ×ª×›× ×•×Ÿ
			refreshPlanningAfterTreatmentUpdate();
			
			return updatedLocations.length;
		}
	   
	   
	    // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×”×˜×™×¤×•×œ ×‘×’×•×’×œ ×©×™×˜×¡
		async function updateTreatmentDatesInSheets(locationsToUpdate) {
			if (!await validateToken() || locationsToUpdate.length === 0) return false;
			
			console.log(`ğŸ”„ ××¢×“×›×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×¢×‘×•×¨ ${locationsToUpdate.length} ×œ×§×•×—×•×ª ×‘×’×•×’×œ ×©×™×˜×¡...`);
			
			try {
				// ×§×¨× ××ª ×›×œ ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™× ××”×˜×‘×œ×”
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:P'
				});
				
				const allRows = response.result.values || [];
				const updatedRows = [...allRows];
				let updatedCount = 0;
				
				// ×¢×‘×•×¨ ×›×œ ×œ×§×•×— ×©×¦×¨×™×š ×¢×“×›×•×Ÿ
				for (const location of locationsToUpdate) {
					// ××¦× ××ª ×”×©×•×¨×” ×”××ª××™××” ×‘×˜×‘×œ×”
					for (let i = 1; i < allRows.length; i++) { // ××ª×—×™×œ ×-1 ×›×“×™ ×œ×“×œ×’ ×¢×œ ×”×›×•×ª×¨×•×ª
						if (allRows[i][0] === location.ID) {
							// ×¢×“×›×Ÿ ××ª ×¢××•×“×•×ª ×”×ª××¨×™×›×™× ×•×”×™×•× ×”××•×¢×“×£
							updatedRows[i][7] = location.allowed_day;   // allowed_day (×¢××•×“×” 7)
							updatedRows[i][13] = location.last_visit;   // last_visit
							updatedRows[i][14] = location.next_visit;   // next_visit
							updatedCount++;
							break;
						}
					}
				}
				
				// ×©××•×¨ ××ª ×›×œ ×”×˜×‘×œ×” ×”××¢×•×“×›× ×ª ×‘×§×¨×™××” ××—×ª ×‘×œ×‘×“
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:P',
					valueInputOption: 'USER_ENTERED',
					resource: {
						values: updatedRows
					}
				});
				
				console.log(`âœ… ×¢×•×“×›× ×• ${updatedCount} ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×‘×’×•×’×œ ×©×™×˜×¡`);
				return true;
			} catch (error) {
				console.error('Error updating treatment dates in sheets:', error);
				return false;
			}
		}
		
		// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×¢×‘×•×¨ ×œ×§×•×— ××—×“ ×œ××—×¨ ×”×•×¡×¤×ª ×‘×™×§×•×¨
		// Verify this function exists and works correctly - it should already be in your code
		// If it's missing any part, here's the complete correct version:

		async function updateSingleLocationTreatmentDates(locationId) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) return;
			
			// ××¦× ××ª ×›×œ ×”×‘×™×§×•×¨×™× ×©×œ ×”×œ×§×•×— ×”×–×”
			const locationVisits = visits.filter(visit => visit.location_id === locationId);
			
			if (locationVisits.length > 0) {
				// ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š (×”×—×“×© ×‘×™×•×ª×¨ ×¨××©×•×Ÿ)
				locationVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
				
				// ×”×˜×™×¤×•×œ ×”××—×¨×•×Ÿ
				const lastVisit = locationVisits[0];
				const lastVisitDate = lastVisit.date;
				
				// ×—×™×©×•×‘ ×ª××¨×™×š ×”×˜×™×¤×•×œ ×”×‘×
				const lastDate = new Date(lastVisitDate);
				const intervalDays = (location.interval_weeks || 4) * 7; // ×‘×¨×™×¨×ª ××—×“×œ 4 ×©×‘×•×¢×•×ª
				const nextDate = new Date(lastDate);
				nextDate.setDate(lastDate.getDate() + intervalDays);
				
				// ×¤×•×¨××˜ ×”×ª××¨×™×š ×œ-YYYY-MM-DD
				const nextVisitDate = nextDate.toISOString().split('T')[0];
				
				// ×¢×“×›×•×Ÿ ×”××•×‘×™×™×§×˜ ×”××§×•××™
				location.last_visit = lastVisitDate;
				location.next_visit = nextVisitDate;
				
				// ×¢×“×›×•×Ÿ ×‘×’×•×’×œ ×©×™×˜×¡
				await updateTreatmentDatesInSheets([location]);
				
				console.log(`ğŸ“… ×¢×•×“×›×Ÿ ×œ×§×•×— ${location.name}: ×˜×™×¤×•×œ ××—×¨×•×Ÿ ${lastVisitDate} â†’ ×˜×™×¤×•×œ ×”×‘× ${nextVisitDate}`);
				
				// ×¨×¢× ×Ÿ × ×ª×•× ×™ ×ª×›× ×•×Ÿ
				refreshPlanningAfterTreatmentUpdate();
			}
		}
	   
	   
	   // ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ××¦×‘ × ×ª×•× ×™ ×”×ª×›× ×•×Ÿ - ×œ×“×™×‘×•×’
		function debugPlanningData() {
			console.log('=== Debug Planning Data ===');
			console.log(`×¡×”"×› ×œ×§×•×—×•×ª: ${locations.length}`);
			
			// ×‘×“×•×§ ××” ×™×© ×‘×©×“×” active
			console.log('×“×•×’×××•×ª ×©×œ ×©×“×” active:', locations.slice(0, 5).map(loc => ({ name: loc.name, active: loc.active, type: typeof loc.active })));

			const activeLocations = locations.filter(loc => loc.active === "×›×Ÿ" || loc.active === true || loc.active === "1");
			console.log(`×œ×§×•×—×•×ª ×¤×¢×™×œ×™×: ${activeLocations.length}`);
			
			const locationsWithDates = activeLocations.filter(loc => loc.next_visit && loc.next_visit.trim() !== '');
			console.log(`×œ×§×•×—×•×ª ×¢× ×ª××¨×™×›×™ ×˜×™×¤×•×œ: ${locationsWithDates.length}`);
			
			// ×”×¦×’ 5 ×œ×§×•×—×•×ª ×¨××©×•× ×™×
			locationsWithDates.slice(0, 5).forEach(loc => {
				console.log(`ğŸ‘¤ ${loc.name}: ××—×¨×•×Ÿ=${loc.last_visit}, ×”×‘×=${loc.next_visit}`);
			});
			
			const today = new Date();
			const todayStr = today.toISOString().split('T')[0];
			console.log(`×ª××¨×™×š ×”×™×•×: ${todayStr}`);
			
			const dueToday = locationsWithDates.filter(loc => {
				return new Date(loc.next_visit) <= today;
			});
			console.log(`×¦×¨×™×›×™× ×˜×™×¤×•×œ ×”×™×•×: ${dueToday.length}`);
			
			console.log('=== ×¡×™×•× Debug ===');
		}
	   
	   
		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×™×™×‘×•× ××”×™×¨ ×•×›×•×œ×œ ×©×œ ×›×œ ×”× ×ª×•× ×™×
		async function importFromHelperTableFast() {
			console.log('ğŸš€ Starting FAST complete import from helper table...');
			
			if (!await validateToken()) {
				showToast('×”×ª×—×‘×¨ ×œ×’×•×’×œ ×§×•×“×', 'warning');
				return;
			}
			
			const importTableId = localStorage.getItem('importTableId');
			console.log('ğŸ” Import Table ID:', importTableId);  // âœ… ×”×•×¡×£ ××ª ×–×”

			if (!importTableId) {
				showToast('×œ× × ××¦× ID ×©×œ ×˜×‘×œ×ª ×”×¢×–×¨', 'warning');
				return;
			}

console.log('âœ… Import table ID exists, proceeding with import...');  // âœ… ×”×•×¡×£ ××ª ×–×”
			
			try {
				showLoading('××™×™×‘× × ×ª×•× ×™× ××”×¨ ××˜×‘×œ×ª ×”×¢×–×¨...');
				
				// Statistics tracking
				const stats = {
					locations: { imported: 0, skipped: 0 },
					visits: { imported: 0, skipped: 0 },
					receipts: { imported: 0, skipped: 0 }
				};
				
				// Arrays for new data only
				const newLocations = [];
				const newVisits = [];
				const newReceipts = [];
				const payments = [];
				const paymentVisitLinks = [];
				
				console.log('ğŸ“Š About to load data from helper table:', importTableId);  // âœ… ×”×•×¡×£ ××ª ×–×”
				
				// ======== STEP 1: Import Locations ========
				try {
					console.log('ğŸ“Š Starting locations import...');
					const locationsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Locations!A2:I1000'
					});
					
					if (locationsResponse.result.values?.length > 0) {
						for (const row of locationsResponse.result.values) {
							if (row.length > 0 && row[0]) { // Has customer name
								const customerName = row[0].trim();
								const street = row[1] || '';
								const houseNumber = row[2] || '';
								const city = row[3] || '';
								const fullAddress = `${street} ${houseNumber} ${city}`.trim();
								
								// Check if customer already exists
								const existingCustomer = locations.find(loc => 
									loc.name.toLowerCase() === customerName.toLowerCase() ||
									(fullAddress && loc.full_address && 
									 loc.full_address.toLowerCase() === fullAddress.toLowerCase())
								);
								
								if (!existingCustomer) {
									const locationData = {
										ID: generateID(),
										name: customerName,
										full_address: fullAddress || customerName,
										neighborhood: '',
										city: city,
										contact_person: row[5] || '',
										phone: '',
										allowed_day: row[7] || '×',
										interval_weeks: parseInt(row[4]) || 4,
										temp_addition: false,
										base_amount: parseFloat(row[6]) || 0,
										active: row[8] || '1',
										notes: '×™×•×‘× ××˜×‘×œ×ª ×¢×–×¨',
										last_visit: '',
										next_visit: '',
										client_requests: ''
									};
									
									locations.push(locationData);
									newLocations.push(locationData);
									stats.locations.imported++;
								} else {
									stats.locations.skipped++;
								}
							}
						}
						console.log(`âœ… Processed ${stats.locations.imported} new locations`);
					}
				} catch (error) {
					console.error('âŒ Error importing locations:', error);
				}
				
				// ======== STEP 2: Import Visits ========
				try {
					console.log('ğŸ”§ Starting visits import...');
					const visitsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Visits!A2:M1000'
					});
					
					if (visitsResponse.result.values?.length > 0) {
						let notFoundCustomers = [];
						
						for (const row of visitsResponse.result.values) {
							if (row.length > 3 && row[3]) { // Has customer in column 3
								const customerName = row[3].trim();
								
								// Find existing customer
								const existingCustomer = locations.find(loc =>
									loc.name && loc.name.toLowerCase() === customerName.toLowerCase()
								);
								
								if (!existingCustomer) {
									if (!notFoundCustomers.includes(customerName)) {
										notFoundCustomers.push(customerName);
									}
									stats.visits.skipped++;
									continue;
								}
								
								// Build date from 3 columns: year, month, day
								const year = row[0];
								const month = String(row[1]).padStart(2, '0');
								const day = String(row[2]).padStart(2, '0');
								const visitDate = `${year}-${month}-${day}`;
								
								const workDone = row[7] || '';
								const amount = parseFloat(row[9]) || 0;
								
								// Check for duplicates
								const isDuplicate = visits.some(existing =>
									existing.location_id === existingCustomer.ID &&
									existing.date === visitDate &&
									existing.work_done === workDone &&
									Math.abs(existing.amount - amount) < 0.01
								);
								
								if (!isDuplicate) {
									const visitData = {
										ID: generateID(),
										date: visitDate,
										location_id: existingCustomer.ID,
										location_name: customerName,
										visit_type: row[5] || 'regular',
										work_done: workDone,
										duration_minutes: (() => {
											const val = parseFloat(row[8]) || 0;
											// If value < 24, assume it's hours and convert to minutes
											// If value >= 24, assume it's already in minutes
											return val < 24 ? val * 60 : val;
										})(),
										num_workers: 1,
										start_time: '',
										end_time: '',
										amount: amount,
										paid: mapPaymentStatus(row[10]),
										expense: parseFloat(row[11]) || 0,
										notes: row[12] || ''
									};
									
									visits.push(visitData);
									newVisits.push(visitData);
									stats.visits.imported++;
									
									// Create payment if marked as paid
									const paidStatus = row[10] || '';
									if (paidStatus === '1' || paidStatus === '×›×Ÿ' || paidStatus === '×©×•×œ×') {
										const payment = {
											ID: generateID(),
											date: visitDate,
											time: '12:00',
											amount: amount,
											payment_method: 'cash',
											source_type: 'import_from_helper_fast',
											client_id: existingCustomer.ID,
											client_name: existingCustomer.name,
											notes: `×ª×©×œ×•× ×¢×‘×•×¨ ×™×™×‘×•× ××”×™×¨ - ${workDone}`,
											status: 'completed',
											created_at: new Date().toISOString()
										};
										
										payments.push(payment);
										
										const link = {
											ID: generateID(),
											payment_id: payment.ID,
											visit_id: visitData.ID,
											amount_allocated: amount,
											link_type: 'full_payment',
											created_at: new Date().toISOString()
										};
										
										paymentVisitLinks.push(link);
									}
								} else {
									stats.visits.skipped++;
								}
							}
						}
						
						if (notFoundCustomers.length > 0) {
							console.log(`âš ï¸ ${notFoundCustomers.length} customers not found for visits:`, notFoundCustomers.slice(0, 5));
						}
						console.log(`âœ… Processed ${stats.visits.imported} new visits`);
					}
				} catch (error) {
					console.error('âŒ Error importing visits:', error);
				}
				
				
				// ======== STEP 3: Import Receipts ========
				try {
					console.log('ğŸ§¾ Starting receipts import...');
					const receiptsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Receipts!A2:K1000'
					});
					
					if (receiptsResponse.result.values?.length > 0) {
						let notFoundAddresses = [];
						
						for (const row of receiptsResponse.result.values) {
							if (row.length > 6 && row[6]) { // Has address in column 6
								const customerAddress = row[6].trim();
								
								// Find customer by address - search in both name and full_address
								const existingCustomer = locations.find(loc =>
									(loc.name && loc.name.toLowerCase().includes(customerAddress.toLowerCase())) ||
									(loc.full_address && loc.full_address.toLowerCase().includes(customerAddress.toLowerCase()))
								);
								
								if (!existingCustomer) {
									if (!notFoundAddresses.includes(customerAddress)) {
										notFoundAddresses.push(customerAddress);
									}
									stats.receipts.skipped++;
									continue;
								}
								
								// Build date
								const year = row[3];
								const month = String(row[4]).padStart(2, '0');
								const day = String(row[5]).padStart(2, '0');
								const receiptDate = `${year}-${month}-${day}`;
								
								const bookNumber = row[1] || '';
								const receiptNumber = row[2] || '';
								
								// Check for duplicates
								const isDuplicateReceipt = receipts.some(existing =>
									existing.book_number === bookNumber &&
									existing.receipt_number === receiptNumber &&
									existing.date === receiptDate
								);
								
								if (!isDuplicateReceipt) {
									const receiptData = {
										ID: generateID(),
										book_number: bookNumber,
										receipt_number: receiptNumber,
										date: receiptDate,
										location_id: existingCustomer.ID,
										location_name: customerAddress,
										amount: parseFloat(row[7]) || 0,
										payment_type: row[8] || '',
										notes: `${row[9] || ''} ${row[10] || ''}`.trim()
									};
									
									receipts.push(receiptData);
									newReceipts.push(receiptData);
									stats.receipts.imported++;
								} else {
									stats.receipts.skipped++;
								}
							}
						}
						
						if (notFoundAddresses.length > 0) {
							console.log(`âš ï¸ ${notFoundAddresses.length} addresses not found for receipts:`, notFoundAddresses.slice(0, 5));
						}
						console.log(`âœ… Processed ${stats.receipts.imported} new receipts`);
					}
				} catch (error) {
					console.error('âŒ Error importing receipts:', error);
				}
				
				
				// ======== STEP 4: Save to Local Storage ========
				saveToLocalStorage();
				
				
				// ======== STEP 4.5: Calculate Treatment Dates ========
				if (stats.visits.imported > 0) {
					showToast('××—×©×‘ ×ª××¨×™×›×™ ×˜×™×¤×•×œ...', 'info', 2000);
					const updatedCount = await calculateTreatmentDates();
					if (updatedCount > 0) {
						console.log(`âœ… ×¢×•×“×›× ×• ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×¢×‘×•×¨ ${updatedCount} ×œ×§×•×—×•×ª`);
					}
				}
				
				// ======== STEP 5: Save to Cloud ========
				console.log('â˜ï¸ Saving to cloud...');
				const savePromises = [];
				
				if (newLocations.length > 0) {
					console.log('ğŸ”µ saveLocationsBatch called for new locations');
					savePromises.push(saveLocationsBatch(newLocations));
				}
				
				if (newVisits.length > 0) {
					console.log('ğŸ”µ saveVisitsBatch called with', newVisits.length, 'visits - checking for duplicates');
					savePromises.push(saveVisitsBatch(newVisits));
				}
				
				if (newReceipts.length > 0) {
					console.log('ğŸ”µ saveReceiptsBatch called with', newReceipts.length, 'receipts');
					savePromises.push(saveReceiptsBatch(newReceipts));
				}
				
				const saveResults = await Promise.all(savePromises);
				const allSaved = saveResults.every(result => result === true);
				
				// ======== STEP 6: Update UI ========
				loadLocationsTable();
				loadLocationsForSelect();
				loadPlanningData();
				
				hideLoading();
				
				// ======== STEP 7: Final Report ========
				const totalImported = stats.locations.imported + stats.visits.imported;
				const totalSkipped = stats.locations.skipped + stats.visits.skipped;
				
				if (totalImported > 0) {
					const message = `ğŸ‰ ×™×™×‘×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”!
					
		âœ… ×™×•×‘××•: ${stats.locations.imported} ×œ×§×•×—×•×ª, ${stats.visits.imported} ×‘×™×§×•×¨×™×, ${stats.receipts.imported} ×§×‘×œ×•×ª
		${totalSkipped > 0 ? `âš ï¸ ×“×•×œ×’×• (×›×¤×™×œ×•×™×•×ª): ${totalSkipped} ×¨×©×•××•×ª` : ''}
		${allSaved ? 'â˜ï¸ × ×©××¨ ×œ×¢× ×Ÿ ×‘×”×¦×œ×—×”' : 'âš ï¸ ×—×œ×§ ××”× ×ª×•× ×™× ×œ× × ×©××¨×• ×œ×¢× ×Ÿ'}`;
					
					showToast(message, 'success', 8000);
				} else {
					showToast('×œ× × ××¦××• × ×ª×•× ×™× ×—×“×©×™× ×œ×™×™×‘×•×', 'info');
				}
				
			} catch (error) {
				console.error('âŒ Error in fast import:', error);
				hideLoading();
				showToast('×©×’×™××” ×‘×™×™×‘×•× ××”×™×¨', 'error');
			}
		}
		

	   
	   ////////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

		// ×”×—×œ×£ ××ª saveEditedLocation ×‘×¤×•× ×§×¦×™×” ×–×•:
		function saveEditedLocation(locationId) {
			console.log(`âœ… saveEditedLocation ('${locationId}')`);
			const locationIndex = locations.findIndex(g => g.ID == locationId);
			if (locationIndex === -1) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			try {
				// ×¢×“×›×Ÿ ××ª ×”×œ×§×•×— ×‘××¢×¨×š ×”××§×•××™
				const updatedLocation = {
					...locations[locationIndex], // ×©××•×¨ × ×ª×•× ×™× ×§×™×™××™×
					name: document.getElementById('editLocationName').value,
					full_address: document.getElementById('editLocationAddress').value,
					neighborhood: document.getElementById('editLocationNeighborhood').value,
					city: document.getElementById('editLocationCity').value,
					contact_person: document.getElementById('editLocationContact').value,
					phone: document.getElementById('editLocationPhone').value,
					allowed_day: document.getElementById('editLocationDay').value,
					interval_weeks: parseInt(document.getElementById('editLocationInterval').value) || 4,
					base_amount: parseFloat(document.getElementById('editLocationAmount').value) || 0,
					active: document.getElementById('editLocationActive').value,
					next_visit: document.getElementById('editLocationNextVisit').value,
					client_requests: document.getElementById('editLocationClientRequests').value,
					notes: document.getElementById('editLocationNotes').value
				};
				
				locations[locationIndex] = updatedLocation;
				
				// ×©××•×¨ ××§×•××™×ª ×ª××™×“
				saveToLocalStorage();
				updateCloudStatus('ğŸ’¾ ×©×•××¨...', '××¢×“×›×Ÿ');
				
				// × ×¡×” ×œ×©××•×¨ ×‘×¢× ×Ÿ
				if (access_token && SPREADSHEET_ID) {
					console.log('ğŸ” About to call updateLocationInCloud with:', updatedLocation.client_requests);
					// ×¢×“×›×•×Ÿ ×‘×¢× ×Ÿ (×œ× ×”×•×¡×¤×” ×—×“×©×”)
					updateLocationInCloud(updatedLocation).then(() => {
						updateCloudStatus('âœ… ××—×•×‘×¨ ×•××¡×•× ×›×¨×Ÿ', '× ×©××¨');
						showToast('×œ×§×•×— ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×” ×‘××¢×¨×›×ª ×•×‘×¢× ×Ÿ!', 'success');
					}).catch(error => {
						console.error('âŒ updateLocationInCloud failed:', error);
						if (error.status === 401) {
							updateCloudStatus('ğŸ” × ×“×¨×© ×—×™×‘×•×¨ ××—×“×©', '× ×•×ª×§');
							showToast('âš ï¸ ×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×”×œ×§×•×— × ×©××¨ ××§×•××™×ª ×‘×œ×‘×“', 'warning');
							access_token = null;
							document.getElementById('saveBtn').disabled = true;
							document.getElementById('loadBtn').disabled = true;
						} else {
							updateCloudStatus('âš ï¸ ×©×’×™××” ×‘×©××™×¨×”', '×©×’×™××”');
							showToast('âš ï¸ ×”×œ×§×•×— × ×©××¨ ××§×•××™×ª, ××‘×œ ×œ× ×”×¦×œ×™×— ×œ×©××•×¨ ×‘×¢× ×Ÿ', 'warning');
						}
					});
				} else {
					updateCloudStatus('ğŸ” ×©×™× ×•×™×™× ×œ× × ×©××¨×• ×‘×¢× ×Ÿ', '××§×•××™');
					showToast('ğŸ” ×œ×§×•×— × ×©××¨ ××§×•××™×ª - ×”×ª×—×‘×¨ ×œ×¢× ×Ÿ ×œ×©××™×¨×” ××œ××”', 'warning');
				}
				
				// ×¢×“×›×Ÿ ×ª×¦×•×’×”
				loadLocationsTable();
				loadLocationsForSelect();
				closeAnyModal();
				
			} catch (error) {
				console.error('Error updating location:', error);
				updateCloudStatus('âŒ ×©×’×™××” ×‘××¢×¨×›×ª', '×©×’×™××”');
				showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×œ×§×•×—', 'error');
			}
		}

		// ×—×™×©×•×‘ ××•×˜×•××˜×™ ×©×œ ×ª××¨×™×š ×˜×™×¤×•×œ ×”×‘× ×›×©××©× ×™× ××¨×•×•×—
		function updateNextVisitFromInterval() {
			const lastVisit = document.getElementById('editLocationLastVisit').value;
			const intervalWeeks = parseInt(document.getElementById('editLocationInterval').value) || 4;
			
			if (lastVisit) {
				const lastDate = new Date(lastVisit);
				const nextDate = new Date(lastDate);
				nextDate.setDate(lastDate.getDate() + (intervalWeeks * 7));
				
				document.getElementById('editLocationNextVisit').value = nextDate.toISOString().split('T')[0];
			}
		}


		// ×”×—×œ×£ ××ª saveEditedReceipt ×‘×¤×•× ×§×¦×™×” ×–×•:
		function saveEditedReceipt(receiptId) {
			console.log(`âœ… saveEditedReceipt ('${receiptId}')`);
			const receiptIndex = receipts.findIndex(r => r.ID == receiptId);
			if (receiptIndex === -1) {
				showToast('×§×‘×œ×” ×œ× × ××¦××”', 'error');
				return;
			}
			
			try {
				const locationId = document.getElementById('editReceiptLocation').value;
				const location = locations.find(g => g.ID == locationId);
				
				// ×¢×“×›×Ÿ ××ª ×”×§×‘×œ×” ×‘××¢×¨×š ×”××§×•××™
				const updatedReceipt = {
					...receipts[receiptIndex], // ×©××•×¨ × ×ª×•× ×™× ×§×™×™××™×
					book_number: document.getElementById('editReceiptBook').value,
					receipt_number: document.getElementById('editReceiptNumber').value,
					date: document.getElementById('editReceiptDate').value,
					location_id: locationId,
					location_name: location ? location.name : '',
					amount: parseFloat(document.getElementById('editReceiptAmount').value) || 0,
					payment_type: document.getElementById('editReceiptPaymentType').value,
					notes: document.getElementById('editReceiptNotes').value
				};
				
				receipts[receiptIndex] = updatedReceipt;
				
				// ×©××•×¨ ××§×•××™×ª ×ª××™×“
				saveToLocalStorage();
				updateCloudStatus('ğŸ’¾ ×©×•××¨ ×§×‘×œ×”...', '××¢×“×›×Ÿ');
				
				// × ×¡×” ×œ×©××•×¨ ×‘×¢× ×Ÿ
				if (access_token && SPREADSHEET_ID) {
					updateReceiptInCloud(updatedReceipt).then(() => {
						updateCloudStatus('âœ… ××—×•×‘×¨ ×•××¡×•× ×›×¨×Ÿ', '× ×©××¨');
						showToast('×§×‘×œ×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×” ×‘××¢×¨×›×ª ×•×‘×¢× ×Ÿ!', 'success');
					}).catch(error => {
						if (error.status === 401) {
							updateCloudStatus('ğŸ” × ×“×¨×© ×—×™×‘×•×¨ ××—×“×©', '× ×•×ª×§');
							showToast('âš ï¸ ×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×”×§×‘×œ×” × ×©××¨×” ××§×•××™×ª ×‘×œ×‘×“', 'warning');
							access_token = null;
						} else {
							updateCloudStatus('âš ï¸ ×©×’×™××” ×‘×©××™×¨×”', '×©×’×™××”');
							showToast('âš ï¸ ×”×§×‘×œ×” × ×©××¨×” ××§×•××™×ª, ××‘×œ ×œ× ×”×¦×œ×™×—×” ×œ×©××•×¨ ×‘×¢× ×Ÿ', 'warning');
						}
					});
				} else {
					updateCloudStatus('ğŸ” ×©×™× ×•×™×™× ×œ× × ×©××¨×• ×‘×¢× ×Ÿ', '××§×•××™');
					showToast('ğŸ” ×§×‘×œ×” × ×©××¨×” ××§×•××™×ª - ×”×ª×—×‘×¨ ×œ×¢× ×Ÿ ×œ×©××™×¨×” ××œ××”', 'warning');
				}
				
				// ×¢×“×›×Ÿ ×ª×¦×•×’×”
				loadReceiptsTable();
				loadReceiptFilterOptions();
				closeAnyModal();
				
			} catch (error) {
				console.error('Error updating receipt:', error);
				updateCloudStatus('âŒ ×©×’×™××” ×‘××¢×¨×›×ª', '×©×’×™××”');
				showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×§×‘×œ×”', 'error');
			}
		}



		// saveEditedVisit
		async function saveEditedVisit(visitId) {
			// ×× ×œ× ×§×™×‘×œ× ×• visitId ×›×¤×¨××˜×¨, × ×¡×” ×œ×§×¨×•× ××”×©×“×”
			if (!visitId) {
				const editVisitIdElement = document.getElementById('editVisitId');
				if (editVisitIdElement) {
					visitId = editVisitIdElement.value;
				}
			}
			
			if (!visitId) {
				showToast('âŒ ×œ× × ××¦× ××–×”×” ×˜×™×¤×•×œ', 'error');
				return;
			}
			
			const visitIndex = visits.findIndex(v => v.ID === visitId);
			
			if (visitIndex === -1) {
				showToast('×‘×™×§×•×¨ ×œ× × ××¦×', 'error');
				return;
			}
			
			// ğŸ›¡ï¸ ×”×’× ×” ××¤× ×™ ×œ×—×™×¦×•×ª ×›×¤×•×œ×•×ª
			if (isSubmittingVisit) {
				console.log('âš ï¸ Already saving, ignoring duplicate click');
				return;
			}
			
			isSubmittingVisit = true;
			
			try {
				// Update visit object
				visits[visitIndex] = {
					ID: visitId,
					date: document.getElementById('editVisitDate')?.value || visits[visitIndex].date,
					location_id: visits[visitIndex].location_id,
					location_name: visits[visitIndex].location_name,
					visit_type: document.getElementById('editVisitTypeHidden')?.value || visits[visitIndex].visit_type,
					work_done: document.getElementById('editWorkDone')?.value || '',
					duration_minutes: parseInt(document.getElementById('editManualDurationMinutes')?.value) || 0,
					num_workers: parseInt(document.getElementById('editNumWorkers')?.value) || 1,
					start_time: document.getElementById('editStartTime')?.value || '',
					end_time: document.getElementById('editEndTime')?.value || '',
					amount: parseFloat(document.getElementById('editAmount')?.value) || 0,
					paid: visits[visitIndex].paid || '0',
					expense: parseFloat(document.getElementById('editExpense')?.value) || 0,
					notes: document.getElementById('editNotes')?.value || ''
				};
				
				// Save locally
				saveToLocalStorage();
				
				// Save to cloud if connected
				if (access_token && SPREADSHEET_ID) {
					await saveAllToSheetsOptimized();
				}
				
				// Update treatment dates
				await updateSingleLocationTreatmentDates(visits[visitIndex].location_id);
				
				// Close modal
				closeAnyModal();
				
				// Refresh display
				const visitsTable = document.getElementById('visitsTableBody');
				if (visitsTable && visitsTable.offsetParent !== null) {
					if (typeof filterVisits === 'function') {
						filterVisits();
					}
				}
				
				loadPlanningData();
				
				showToast('âœ… ×”×˜×™×¤×•×œ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”', 'success');
				
			} catch (error) {
				console.error('Error saving visit:', error);
				showToast('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×˜×™×¤×•×œ', 'error');
			} finally {
				// ğŸ”“ ×©×—×¨×¨ ××ª ×”× ×¢×™×œ×”
				isSubmittingVisit = false;
			}
		}

	

	   
	   //////////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	   
	   
	   function formatDateForSheets(dateString) {
			if (!dateString) return '';
			const date = new Date(dateString);
			const day = String(date.getDate()).padStart(2, '0');
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const year = date.getFullYear();
			return `${day}/${month}/${year}`;
		}
	   
	   
	   // ×¤×•× ×§×¦×™×” ×œ×”××¨×ª ×¡×˜×˜×•×¡ ×ª×©×œ×•× ×œ×§×™×“×•×“ ××¡×¤×¨×™
		function mapPaymentStatus(value) {
			if (!value || value.trim() === '') return "0";
			const normalized = value.toString().toLowerCase().trim();
			
			// ×”××¨×” ×¤×©×•×˜×” ×œ×¤×™ ×”×¢×¨×›×™× ×©×™×›×•×œ×™× ×œ×”×’×™×¢ ××”×™×™×‘×•×
			if (normalized === "×›×Ÿ" || normalized === "true" || normalized === "1") return "1";
			if (normalized === "×œ×œ× ×ª×©×œ×•×" || normalized === "×œ×œ×") return "2";
			if (normalized === "×—×œ×§×™" || normalized === "×©×•×œ× ×—×œ×§×™×ª") return "3";  // âœ… ×”×•×¡×£ ××ª ×–×”
			return "0"; // ×›×œ ×”×©××¨ = ×œ× ×©×•×œ×
		}
   
	   
	   function parseAddressForImport(customerName) {
			if (!customerName) return { name: '', fullAddress: '', neighborhood: '', city: '' };
			
			const originalAddress = customerName.trim();
			const parts = originalAddress.split(' ');
			let city = '';
			
			if (parts.length >= 3) {
				// ×—×™×¤×•×© ××¡×¤×¨ ×‘×™×ª (××¡×¤×¨ + ××•×œ×™ ××•×ª ×/×‘)
				let houseNumberIndex = -1;
				for (let i = 0; i < parts.length; i++) {
					if (/^\d+[×-×‘]?$/.test(parts[i])) {
						houseNumberIndex = i;
						break; // ×œ×•×§×— ××ª ×”××¡×¤×¨ ×”×¨××©×•×Ÿ ×©× ××¦×
					}
				}
				
				if (houseNumberIndex !== -1 && houseNumberIndex < parts.length - 1) {
					// ×™×© ××¡×¤×¨ ×‘×™×ª - ×›×œ ××” ×©××—×¨×™×• ×”×•× ×¢×™×¨
					city = parts.slice(houseNumberIndex + 1).join(' ');
				} else {
					// ××™×Ÿ ××¡×¤×¨ ×‘×™×ª - ×›×œ ×”×›×ª×•×‘×ª ×”×™× ×¢×™×¨
					city = originalAddress;
				}
			} else {
				// ×¤×—×•×ª ×-3 ××™×œ×™× - ×›×œ ×”×›×ª×•×‘×ª ×”×™× ×¢×™×¨
				city = originalAddress;
			}
			
			// âœ… ×”××¨×ª ×”×§×™×¦×•×¨ ××—×¨×™ ×©×§×‘×¢× ×• ××ª ×”×¢×™×¨
			if (city === '×¨××©×œ×¦') {
				city = '×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ';
			}
			
			return {
				name: originalAddress, // ×”×©× ×”××§×•×¨×™ ×œ×œ× ×©×™× ×•×™
				fullAddress: originalAddress,
				neighborhood: '', // ×¨×™×§ ×œ××™×œ×•×™ ×™×“× ×™
				city: city
			};
		}
		
		
		// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×ª××¨×™×š ×˜×™×¤×•×œ ×”×‘×
		// ×¢×“×›×•×Ÿ ×ª××¨×™×š ×˜×™×¤×•×œ ×”×‘× ×œ×œ×§×•×—
		function updateClientNextVisit(clientId, newDate) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('×œ× × ××¦× ×œ×§×•×—', 'error');
				return;
			}
			
			// ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×”×ª××¨×™×š
			if (!newDate || isNaN(new Date(newDate))) {
				showToast('×ª××¨×™×š ×œ× ×ª×§×™×Ÿ', 'error');
				return;
			}
			
			const oldDate = client.next_visit;
			client.next_visit = newDate;
			
			// ××™×¤×•×¡ ×”×•×¡×¤×•×ª ×–×× ×™×•×ª
			if (client.temp_addition) {
				client.temp_addition = 0;
			}
			
			// ×©××™×¨×” ××§×•××™×ª
			saveToLocalStorage();
			
			// ×©××™×¨×” ×‘×¢× ×Ÿ ×× ××—×•×‘×¨
			if (access_token && SPREADSHEET_ID) {
				updateLocationInCloud(client).then(() => {
					console.log('âœ… ×ª××¨×™×š ×¢×•×“×›×Ÿ ×‘×¢× ×Ÿ');
				}).catch(error => {
					console.error('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¢× ×Ÿ:', error);
					showToast('×”×ª××¨×™×š ×¢×•×“×›×Ÿ ××§×•××™×ª, ××š ×œ× ×‘×¢× ×Ÿ', 'warning');
				});
			}
			
			const formattedDate = formatDate(newDate);
			showToast(`×ª××¨×™×š ×”×˜×™×¤×•×œ ×”×‘× ×¢×‘×•×¨ ${client.name} ×¢×•×“×›×Ÿ ×œ-${formattedDate}`, 'success');
			
			// ×¨×¢× ×•×Ÿ ×”×ª×¦×•×’×”
			setTimeout(() => {
				loadPlanningDataAdvanced();
			}, 300);
		}

		// ×¤×•× ×§×¦×™×” ×œ×”×¤×™×›×ª ×œ×§×•×— ×œ×¤×¢×™×œ/×œ× ×¤×¢×™×œ
		function toggleClientActive(clientId, activeValue) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			client.active = activeValue;
			
			// ×©××™×¨×”
			saveToLocalStorage();
			
			// ×¢×“×›×•×Ÿ ×‘×¢× ×Ÿ ×× ××—×•×‘×¨
			if (access_token && SPREADSHEET_ID) {
				updateLocationInCloud(client);
			}
			
			const statusText = activeValue === "1" ? "×¤×¢×™×œ" : "×œ× ×¤×¢×™×œ";
			showToast(`${client.name} ×”×•×’×“×¨ ×›-${statusText}`, 'success');
			
			// ×¨×¢× ×•×Ÿ ×”×ª×¦×•×’×” (×”×œ×§×•×— ×™×™×¢×œ× ×× ×œ× ×¤×¢×™×œ)
			loadPlanningDataAdvanced();
		}

		// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×
		function showClientHistory(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			// ××¦×™××ª 3 ×”×˜×™×¤×•×œ×™× ×”××—×¨×•× ×™×
			const clientVisits = visits
				.filter(visit => visit.location_id === clientId)
				.sort((a, b) => new Date(b.date) - new Date(a.date))
				.slice(0, 3);
			
			if (clientVisits.length === 0) {
				showToast(`${client.name} - ××™×Ÿ ×¢×“×™×™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×`, 'info');
				return;
			}
			
			// ×‘× ×™×™×ª ×ª×•×›×Ÿ ×”×—×œ×•× ×™×ª
			let historyHtml = `
				<div style="background: white; padding: 20px; border-radius: 10px; max-width: 500px; max-height: 400px; overflow-y: auto;">
					<h3 style="margin-bottom: 15px; color: #333;">ğŸ“‹ ×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™× - ${client.name}</h3>
					<div style="margin-bottom: 20px; font-size: 12px; color: #666;">
						×›×ª×•×‘×ª: ${client.full_address}
					</div>
					<div style="space-y: 10px;">
			`;
			
			clientVisits.forEach((visit, index) => {
				const visitDate = formatDate(visit.date);
				const amount = visit.amount || 0;
				const workDone = visit.work_done || '×˜×™×¤×•×œ';
				const paidInfo = parsePaidField(visit.paid);
				const paidStatus = paidInfo.text;
				let paidColor = '#dc3545'; // ×œ× ×©×•×œ×
				if (paidInfo.status === '1') paidColor = '#28a745'; // ×©×•×œ×
				else if (paidInfo.status === '2') paidColor = '#6c757d'; // ×œ×œ× ×ª×©×œ×•×
				else if (paidInfo.status === '3') paidColor = '#ffc107'; // ×—×œ×§×™
				
				historyHtml += `
					<div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 10px; background: ${index === 0 ? '#f8f9ff' : '#fafafa'};">
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
							<strong style="color: #2c3e50;">ğŸ“… ${visitDate}</strong>
							<span style="font-weight: bold; color: ${paidColor};">${paidStatus}</span>
						</div>
						<div style="margin-bottom: 5px; color: #666;">
							ğŸ› ï¸ ×¢×‘×•×“×”: ${workDone}
						</div>
						<div style="display: flex; justify-content: space-between; font-size: 14px;">
							<span>ğŸ’° â‚ª${amount}</span>
							${visit.duration_minutes ? `<span>â±ï¸ ${visit.duration_minutes} ×“×§'</span>` : ''}
						</div>
						${visit.notes ? `<div style="margin-top: 8px; font-size: 12px; color: #666; font-style: italic;">ğŸ“ ${visit.notes}</div>` : ''}
					</div>
				`;
			});
			
			historyHtml += `
					</div>
					<div style="text-align: center; margin-top: 20px;">
						<button onclick="closeAnyModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
							×¡×’×•×¨
						</button>
					</div>
				</div>
			`;
			
			// ×”×¦×’×ª ×”×—×œ×•× ×™×ª
			showModal(historyHtml);
		}
		
	   
	   // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×œ×§×•×— ×¡×¤×¦×™×¤×™ ×‘×¢× ×Ÿ
		async function updateLocationInCloud(client) {
			if (!await validateToken()) return;
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:A'
				});
				
				const rows = response.result.values || [];
				const rowIndex = rows.findIndex(row => row[0] === client.ID);
				
				if (rowIndex > 0) {
					const rowNumber = rowIndex + 1;
					const clientRow = [
						client.ID, client.name, client.full_address, client.neighborhood, client.city,
						client.contact_person, client.phone, client.allowed_day, client.interval_weeks,
						client.temp_addition || 0, // âœ… ×”×•×¡×£ ×‘×“×™×§×”
						client.base_amount, client.active, client.notes,
						client.last_visit, client.next_visit, client.client_requests || ''
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Locations!A${rowNumber}:P${rowNumber}`,
						valueInputOption: 'USER_ENTERED',
						resource: { values: [clientRow] }
					});
					
					console.log('âœ… Successfully updated client in cloud'); // ×œ×•×’ ×œ×”×¦×œ×—×”
				} else {
					throw new Error(`Client with ID ${client.ID} not found in spreadsheet`);
				}
			} catch (error) {
				console.error('Error updating client in cloud:', error);
				throw error; // âœ… ×—×©×•×‘ - ×”×¢×‘×¨ ××ª ×”×©×’×™××” ×”×œ××”
			}
		}
	   
	   
	   // ===== ×¤×•× ×§×¦×™×•×ª ×¤×¢× ×•×— ×”×›× ×¡×•×ª ××˜×œ×’×¨× =====

		// ×”××¨×ª ×ª××¨×™×š ××¤×•×¨××˜ ×˜×œ×’×¨× ×œ-ISO
		function parseTelegramDateToISO(dateStr) {
			const months = {
				'January': '01', 'February': '02', 'March': '03', 'April': '04',
				'May': '05', 'June': '06', 'July': '07', 'August': '08',
				'September': '09', 'October': '10', 'November': '11', 'December': '12'
			};
			
			const parts = dateStr.split(' ');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = months[parts[1]] || '01';
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			return dateStr;
		}

		// ×¤×¢× ×•×— ×©×•×¨×ª ×”×›× ×¡×” ×‘×•×“×“×ª
		function parseIncomeLineFromTelegram(line, date, time) {
			try {
				// ×—×™×œ×•×¥ ×›×ª×•×‘×ª ×œ×§×•×—
				let clientAddress = '';
				const dotIndex = line.indexOf('.');
				if (dotIndex > 0) {
					clientAddress = line.substring(0, dotIndex).trim();
				} else {
					const beforeReceived = line.split('×§×™×‘×œ×ª×™')[0].trim();
					clientAddress = beforeReceived.replace(/[.,]$/, '');
				}

				// ×—×™×œ×•×¥ ×¡×›×•× - ×’×¨×¡×” ××©×•×¤×¨×ª
				let amount = 0;
				const amountPatterns = [
					/×§×™×‘×œ×ª×™\s+×ª×©×œ×•×\s+(\d+)/,     
					/×§×™×‘×œ×ª×™\s+(\d+)/,              
					/×§×™×‘×œ×ª×™\s+×¦'×§\s+(\d+)/,        
					/×§×™×‘×œ×ª×™\s+×¢×•×“\s+(\d+)/,        
					/(\d+)\s+××–×•××Ÿ/,               
					/(\d+)\s+×‘×™×˜/,                 
					/(\d+)\s+×”×¢×‘×¨×”/,               
					/(\d+)\s+×¤×™×™×‘×•×§×¡/,
					/(\d+)\s+×¦'×§/
				];
				
				for (const pattern of amountPatterns) {
					const match = line.match(pattern);
					if (match) {
						amount = parseInt(match[1]);
						break;
					}
				}
				
				// ×× ×¢×“×™×™×Ÿ ×œ× ××¦×× ×•, ×—×¤×© ××¡×¤×¨×™× ×’×“×•×œ×™×
				if (amount === 0) {
					const allNumbers = line.match(/\d+/g);
					if (allNumbers && allNumbers.length > 0) {
						const numbers = allNumbers.map(n => parseInt(n)).filter(n => n >= 50);
						if (numbers.length > 0) {
							amount = Math.max(...numbers);
						}
					}
				}

				// ×–×™×”×•×™ ×××¦×¢×™ ×ª×©×œ×•× - ×¢× ×ª×™×§×•×Ÿ "×œ× ×¦×•×™×Ÿ" = ××–×•××Ÿ
				let paymentMethod = '××–×•××Ÿ'; // ×‘×¨×™×¨×ª ××—×“×œ ×‘××§×•× "×œ× ×¦×•×™×Ÿ"
				if (line.includes('×”×¢×‘×¨×” ×œ×—×©×‘×•×Ÿ') || line.includes('×”×¢×‘×¨×”')) {
					paymentMethod = '×”×¢×‘×¨×” ×‘× ×§××™×ª';
				} else if (line.includes('×¦\'×§')) {
					paymentMethod = '×¦\'×§';
				} else if (line.includes('×‘×™×˜')) {
					paymentMethod = '×‘×™×˜';
				} else if (line.includes('××–×•××Ÿ')) {
					paymentMethod = '××–×•××Ÿ';
				} else if (line.includes('×¤×™×™×‘×•×§×¡')) {
					paymentMethod = '×¤×™×™×‘×•×§×¡';
				}

				// ×—×™×œ×•×¥ ×”×¢×¨×•×ª
				let notes = '';
				if (line.includes('×¢×‘×•×¨')) {
					const match = line.match(/×¢×‘×•×¨[^.]+/);
					if (match) notes += match[0] + ' ';
				}
				if (line.includes('×©×›×—×ª×™') || line.includes('×œ× ×¨×©××ª×™') || line.includes('×œ× ×¢×“×›× ×ª×™')) {
					notes += '×œ× ×ª×•×¢×“ ××™×“ ';
				}
				if (line.includes('×¢×œ ×”×—×©×‘×•×Ÿ') || line.includes('×—×•×‘')) {
					notes += '×ª×©×œ×•× ×¢×œ ×—×©×‘×•×Ÿ ';
				}

				return {
					date: date,
					time: time,
					client_address: clientAddress,
					amount: amount,
					payment_method: paymentMethod,
					notes: notes.trim(),
					raw_text: line
				};
			} catch (error) {
				console.error('×©×’×™××” ×‘×¤×¢× ×•×— ×©×•×¨×ª ×”×›× ×¡×”:', line, error);
				return null;
			}
		}

		// ×¤×¢× ×•×— ××œ× ×©×œ × ×ª×•× ×™ ×”×›× ×¡×•×ª ××˜×œ×’×¨×
		function parseIncomesFromTelegramText(telegramText) {
			const lines = telegramText.split('\n').map(line => line.replace(/\r$/, '').trim());
			const incomes = [];
			let currentDate = '';
			let currentTime = '';
			
			for (let i = 0; i < lines.length; i++) {
				const line = lines[i];
				
				// ×–×™×”×•×™ ×ª××¨×™×š (15 August 2024)
				if (/^\d{1,2} \w+ \d{4}$/.test(line)) {
					currentDate = parseTelegramDateToISO(line);
					continue;
				}
				
				// ×–×™×”×•×™ ×©×¢×” (20:04)
				if (/^\d{1,2}:\d{2}$/.test(line)) {
					currentTime = line;
					continue;
				}
				
				// ×–×™×”×•×™ ×”×•×“×¢×ª ×”×›× ×¡×” (××›×™×œ×” "×§×™×‘×œ×ª×™" ×•××¡×¤×¨)
				if (line.includes('×§×™×‘×œ×ª×™') && /\d+/.test(line)) {
					const income = parseIncomeLineFromTelegram(line, currentDate, currentTime);
					if (income && income.amount > 0) {
						incomes.push(income);
					}
				}
			}
			
			return incomes;
		}


		// ===== ×¤×•× ×§×¦×™×•×ª ××™×©×•×¨ ×™×™×‘×•× ×”×›× ×¡×•×ª =====

		// ===== ×¤×•× ×§×¦×™×•×ª ×•×™×“×•× ×§×™×•× ×’×™×œ×™×•× ×•×ª × ×“×¨×©×™× =====

		// ×•×™×“×•× ×§×™×•× ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª ×‘××¢×¨×›×ª ×”×¨××©×™×ª
		async function ensureIncomesSheetExists() {
			if (!await validateToken()) return false;
			
			try {
				const response = await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				
				const existingSheets = response.result.sheets.map(sheet => sheet.properties.title);
				
				if (!existingSheets.includes('Incomes')) {
					console.log('×™×•×¦×¨ ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª...');
					
					await gapi.client.sheets.spreadsheets.batchUpdate({
						spreadsheetId: SPREADSHEET_ID,
						resource: {
							requests: [{
								addSheet: {
									properties: {
										title: 'Incomes',
										gridProperties: {
											rowCount: 1000,
											columnCount: 12
										}
									}
								}
							}]
						}
					});
					
					// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª
					const headers = [
						'ID', '×ª××¨×™×š', '×©×¢×”', '×›×ª×•×‘×ª_×œ×§×•×—', '××–×”×”_×œ×§×•×—', 
						'×¡×›×•×', '×××¦×¢×™_×ª×©×œ×•×', '×”×¢×¨×•×ª', '×˜×§×¡×˜_××§×•×¨×™', 
						'××§×•×¨_×™×™×‘×•×', '×ª××¨×™×š_×™×™×‘×•×', '×¡×˜×˜×•×¡'
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: 'Incomes!A1:L1',
						valueInputOption: 'RAW',
						resource: { values: [headers] }
					});
					
					console.log('âœ… ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª × ×•×¦×¨');
				}
				
				return true;
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×•×™×“×•× ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª:', error);
				return false;
			}
		}

		
		// ×”×•×¡×¤×ª ×›×¤×ª×•×¨ ×”×¢×œ××” ×œ×××©×§ (×œ×”×•×¡×™×£ ×œ××§×•× ×”××ª××™× ×‘×××©×§)
		function addTelegramIncomeUploadButton() {
			const uploadHTML = `
				<div class="upload-section" style="margin: 20px 0; padding: 20px; border: 2px dashed #3498db; border-radius: 10px; text-align: center;">
					<h3 style="color: #3498db; margin-bottom: 15px;">ğŸ“¤ ×™×™×‘×•× ×”×›× ×¡×•×ª ××˜×œ×’×¨×</h3>
					<p style="color: #666; margin-bottom: 20px;">×‘×—×¨ ×§×•×‘×¥ ×˜×§×¡×˜ ×¢× ×™×™×¦×•× ×”×›× ×¡×•×ª ××˜×œ×’×¨×</p>
					<input type="file" id="telegramIncomeFile" accept=".txt,.json" style="display: none;" onchange="handleTelegramIncomeFileUpload(event)">
					<button class="btn btn-primary" onclick="document.getElementById('telegramIncomeFile').click()" style="padding: 12px 25px; font-size: 16px;">
						ğŸ“ ×‘×—×¨ ×§×•×‘×¥ ×”×›× ×¡×•×ª ××˜×œ×’×¨×
					</button>
				</div>
			`;
			
			return uploadHTML;
		}


		// ===== ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ × ×•×¡×¤×•×ª ×œ××¢×¨×›×ª ×”×›× ×¡×•×ª =====

		// ×™×¦×™×¨×ª ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ×¨×©×™××ª ×”×›× ×¡×•×ª (×× ×œ× ×§×™×™××ª)
		function loadIncomesTable() {
			if (typeof incomes === 'undefined' || !incomes.length) {
				console.log('ğŸ“Š ××™×Ÿ ×”×›× ×¡×•×ª ×œ×”×¦×’×”');
				return;
			}
			
			console.log(`ğŸ“Š ×˜×•×¢×Ÿ ${incomes.length} ×”×›× ×¡×•×ª ×œ×ª×¦×•×’×”`);
			// ×›××Ÿ ×ª×•×¡×™×£ ××ª ×”×œ×•×’×™×§×” ×œ×”×¦×’×ª ×”×›× ×¡×•×ª ×‘×××©×§ ×‘×¢×ª×™×“
		}

		// ××ª×—×•×œ ××¢×¨×š ×”×›× ×¡×•×ª ×× ×œ× ×§×™×™×
		if (typeof incomes === 'undefined') {
			window.incomes = [];
		}

	
		// ===== ×¤×•× ×§×¦×™×•×ª ×™×¦×™×¨×ª ×’×™×œ×™×•× ×•×ª × ×•×¡×¤×™× ×‘××¢×¨×›×ª =====

		// ×™×¦×™×¨×ª ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª ×‘×§×•×‘×¥ ×”×¨××©×™
		async function createIncomesSheet() {
			if (!await validateToken()) {
				showToast('×”×ª×—×‘×¨ ×œ×’×•×’×œ ×§×•×“×', 'warning');
				return false;
			}
			
			try {
				showLoading('×™×•×¦×¨ ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª...');
				
				// ×‘×“×™×§×” ×× ×”×’×™×œ×™×•×Ÿ ×›×‘×¨ ×§×™×™×
				const sheetsResponse = await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				
				const existingSheet = sheetsResponse.result.sheets.find(sheet => 
					sheet.properties.title === 'Incomes'
				);
				
				if (existingSheet) {
					hideLoading();
					showToast('×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª ×›×‘×¨ ×§×™×™×', 'info');
					return true;
				}
				
				// ×™×¦×™×¨×ª ×”×’×™×œ×™×•×Ÿ ×”×—×“×©
				await gapi.client.sheets.spreadsheets.batchUpdate({
					spreadsheetId: SPREADSHEET_ID,
					resource: {
						requests: [{
							addSheet: {
								properties: {
									title: 'Incomes',
									gridProperties: {
										rowCount: 1000,
										columnCount: 10
									}
								}
							}
						}]
					}
				});
				
				// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª
				const headers = [
					'ID', '×ª××¨×™×š', '×©×¢×”', '×›×ª×•×‘×ª_×œ×§×•×—', '××–×”×”_×œ×§×•×—', 
					'×¡×›×•×', '×××¦×¢×™_×ª×©×œ×•×', '×”×¢×¨×•×ª', '×˜×§×¡×˜_××§×•×¨×™', '××§×•×¨_×™×™×‘×•×'
				];
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Incomes!A1:J1',
					valueInputOption: 'RAW',
					resource: { values: [headers] }
				});
				
				hideLoading();
				showToast('âœ… ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª × ×•×¦×¨ ×‘×”×¦×œ×—×”!', 'success');
				return true;
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×™×¦×™×¨×ª ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª:', error);
				hideLoading();
				showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª', 'error');
				return false;
			}
		}

		

		// ===== ×¤×•× ×§×¦×™×•×ª ×©××™×¨×” ×œ×˜×‘×œ××•×ª ×”×—×“×©×•×ª =====



		// ×˜×¢×™× ×ª ×”×›× ×¡×•×ª ××˜×œ×’×¨× ××”×¢×œ× ×Ÿ
		async function loadTelegramIncomesFromCloud() {
			if (!access_token || !SPREADSHEET_ID) {
				return [];
			}
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'TelegramIncomes!A2:L1000'
				});
				
				if (!response.result.values) {
					return [];
				}
				
				return response.result.values.map(row => ({
					ID: row[0] || '',
					date: row[1] || '',
					time: row[2] || '',
					client_address: row[3] || '',
					amount: parseFloat(row[4]) || 0,
					payment_method: row[5] || '',
					notes: row[6] || '',
					raw_text: row[7] || '',
					matched_to_visit: row[8] === 'true' || row[8] === true,
					visit_ids: row[9] ? row[9].split(',') : [],
					processed: row[10] === 'true' || row[10] === true,
					created_at: row[11] || ''
				}));
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×›× ×¡×•×ª ××˜×œ×’×¨×:', error);
				return [];
			}
		}

		// ===== ×¤×•× ×§×¦×™×•×ª ×œ×•×’×™×§×ª ×ª×©×œ×•××™× ×—×“×©×” =====

		// ××©×ª× ×™ ×’×œ×•×‘×œ×™×™× ×œ×ª×©×œ×•××™×
		let payments = [];
		let paymentVisitLinks = [];

		// ×‘×“×™×§×ª ×¡×˜×˜×•×¡ ×ª×©×œ×•× ×©×œ ×‘×™×§×•×¨
		function getVisitPaymentStatus(visitId) {
			const visit = visits.find(v => v.ID === visitId);
			if (!visit) return 'unpaid';
			
			// âœ… UPDATED: Use the new parser
			const paidInfo = parsePaidField(visit.paid);
			return paidInfo.status;
		}


		// âœ… Parse the paid field to get detailed payment info
		function parsePaidField(paidValue) {
			// ×˜×™×¤×•×œ ×‘×¢×¨×š ×¨×™×§
			if (!paidValue || paidValue === '0') {
				return { status: '0', text: '×œ× ×©×•×œ×', date: null, amount: 0 };
			}
			
			// ×©×•×œ× ××œ×
			if (paidValue === '1') {
				return { status: '1', text: '×©×•×œ×', date: null, amount: null };
			}
			
			// ×œ×œ× ×ª×©×œ×•×
			if (paidValue === '2') {
				return { status: '2', text: '×œ×œ× ×ª×©×œ×•×', date: null, amount: 0 };
			}
			
			// ×©×•×œ× ×—×œ×§×™×ª
			if (paidValue === '3') {
				return { status: '3', text: '×©×•×œ× ×—×œ×§×™×ª', date: null, amount: 0 };
			}
			
			// ×©×•×œ× ×¢× ×ª××¨×™×š: "1:2024-10-23"
			if (paidValue.startsWith('1:')) {
				const date = paidValue.substring(2);
				return { status: '1', text: '×©×•×œ×', date: date, amount: null };
			}
			
			// ×©×•×œ× ×—×œ×§×™×ª ×¢× ×¡×›×•×: "3:500"
			if (paidValue.startsWith('3:')) {
				const amount = parseFloat(paidValue.substring(2)) || 0;
				return { status: '3', text: '×©×•×œ× ×—×œ×§×™×ª', date: null, amount: amount };
			}
			
			// Default fallback
			return { status: '0', text: '×œ× ×©×•×œ×', date: null, amount: 0 };
		}

		


		// ×˜×§×¡×˜ ×¡×˜×˜×•×¡ ×ª×©×œ×•× ××¢×•×“×›×Ÿ
		function getPaymentStatusText(status) {
						
			switch (status) {
				case '1': return '×©×•×œ×';
				case '0': return '×œ× ×©×•×œ×';
				case '2': return '×œ×œ× ×ª×©×œ×•×';
				case '3': return '×©×•×œ× ×—×œ×§×™×ª';
				default: return '×œ× ×™×“×•×¢';
			}
		}

		// ×—×™×©×•×‘ ×¡×›×•× ×©×•×œ× ×¢×‘×•×¨ ×‘×™×§×•×¨
		function getVisitPaidAmount(visitId) {
			const visit = visits.find(v => v.ID === visitId);
			if (!visit) return 0;
			
			// ×©×™×˜×” 1: ×—×™×©×•×‘ ××ª×•×š PaymentVisitLinks (×”××“×•×™×§ ×‘×™×•×ª×¨)
			const relatedLinks = paymentVisitLinks.filter(link => link.visit_id === visitId);
			if (relatedLinks.length > 0) {
				// ×™×© ×§×™×©×•×¨×™ ×ª×©×œ×•× - ×—×©×‘ ×œ×¤×™ ×”×§×™×©×•×¨×™×
				const totalFromLinks = relatedLinks.reduce((sum, link) => sum + (parseFloat(link.amount_allocated) || 0), 0);
				return totalFromLinks;
			}
			
			// ×©×™×˜×” 2: ×—×™×©×•×‘ ××ª×•×š visit.paid (backwards compatibility)
			const paidInfo = parsePaidField(visit.paid);
			const visitAmount = parseFloat(visit.amount) || 0;
			
			if (paidInfo.status === 'paid') {
				// Fully paid - return full amount
				return visitAmount;
			}
			
			if (paidInfo.status === '3') {
				// Partially paid - return the partial amount
				return paidInfo.amount;
			}
			
			if (paidInfo.status === 'no_payment') {
				// No payment needed - return full amount (no debt)
				return visitAmount;
			}
			
			// Unpaid - return 0
			return 0;
		}

		// ===== ×¤×•× ×§×¦×™×•×ª ×˜×™×¤×•×œ ×‘×ª×©×œ×•××™× ===== 

		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×¡×™××•×Ÿ ×—×•×‘×•×ª ×›×©×•×œ××™×
		async function markAllDebtsPaid(locationId) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			// ××¦× ×›×œ ×”×‘×™×§×•×¨×™× ×”×œ× ×©×•×œ××™× ×©×œ ×”×œ×§×•×—
			const unpaidVisits = visits.filter(visit => {
				if (visit.location_id !== locationId || !visit.amount || visit.amount <= 0) {
					return false;
				}
				
				const paidAmount = getVisitPaidAmount(visit.ID);
				const debt = parseFloat(visit.amount) - paidAmount;
				return debt > 0;
			});
			
			if (unpaidVisits.length === 0) {
				showToast('××™×Ÿ ×—×•×‘×•×ª ×¤×ª×•×—×™× ×œ×œ×§×•×— ×–×”', 'info');
				return;
			}
			
			const totalDebt = unpaidVisits.reduce((sum, visit) => {
				const paidAmount = getVisitPaidAmount(visit.ID);
				return sum + (parseFloat(visit.amount) - paidAmount);
			}, 0);
			
			if (confirm(`×œ×¡××Ÿ ××ª ×›×œ ×”×—×•×‘×•×ª ×©×œ ${location.name} ×›××¡×•×œ×§×™×?\n\n×¡×”"×›: â‚ª${totalDebt.toLocaleString()}\n××¡×¤×¨ ×˜×™×¤×•×œ×™×: ${unpaidVisits.length}`)) {
				
				try {
					showLoading('×™×•×¦×¨ ×ª×©×œ×•× ×•××¢×“×›×Ÿ ××¢×¨×›×ª...');
					
					// ×¦×•×¨ ×ª×©×œ×•× ××—×“ ×¢×‘×•×¨ ×›×œ ×”×—×•×‘×•×ª
					const payment = {
						ID: generateID(),
						date: new Date().toISOString().split('T')[0],
						time: new Date().toTimeString().substr(0, 5),
						amount: totalDebt,
						payment_method: 'cash',
						source_type: 'debt_settlement',
						client_id: locationId,
						notes: `×¡×™×œ×•×§ ×—×•×‘×•×ª - ${unpaidVisits.length} ×˜×™×¤×•×œ×™×`,
						status: 'completed',
						created_at: new Date().toISOString()
					};
					
					// ×”×•×¡×£ ×ª×©×œ×•× ×œ××¢×¨×›×ª
					payments.push(payment);
					
					// ×¦×•×¨ ×§×™×©×•×¨×™× ×œ×›×œ ×”×‘×™×§×•×¨×™×
					for (const visit of unpaidVisits) {
						const paidAmount = getVisitPaidAmount(visit.ID);
						const debtAmount = parseFloat(visit.amount) - paidAmount;
						
						if (debtAmount > 0) {
							const link = {
								ID: generateID(),
								payment_id: payment.ID,
								visit_id: visit.ID,
								amount_allocated: debtAmount,
								link_type: 'debt_settlement',
								created_at: new Date().toISOString()
							};
							
							paymentVisitLinks.push(link);
						}
					}
					
					// ×©××™×¨×” ××§×•××™×ª
					saveToLocalStorage();
					
					// ×©××™×¨×” ×‘×¢× ×Ÿ
					if (access_token && SPREADSHEET_ID) {
						await saveAllToSheetsOptimized();
						
						// ×©××•×¨ ××ª ×›×œ ×”×§×™×©×•×¨×™×
						for (const link of paymentVisitLinks.filter(l => l.payment_id === payment.ID)) {
							await saveAllToSheetsOptimized();
						}
					}
					
					hideLoading();
					
					// ×¨×¢× ×•×Ÿ ×”×ª×¦×•×’×”
					displayDebts();
					
					showToast(`×”×—×•×‘×•×ª ×©×œ ${location.name} ×¡×•×× ×• ×›××¡×•×œ×§×™×!
		ğŸ’° â‚ª${totalDebt.toLocaleString()} ×¡×•×œ×§×•
		ğŸ“‹ ${unpaidVisits.length} ×˜×™×¤×•×œ×™× ×¢×•×“×›× ×•`, 'success', 5000);
					
				} catch (error) {
					hideLoading();
					console.error('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×ª×©×œ×•××™×:', error);
					showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×ª×©×œ×•××™×', 'error');
				}
			}
		}


		// ×¤×•× ×§×¦×™×•×ª ×œ×—×™×¤×•×© ×œ×§×•×—×•×ª ×”×™×‘×¨×™×“×™
		let clientDropdownOpen = false;

		function handleClientSearch(searchTerm) {
			if (searchTerm.length === 0) {
				showAllClients();
				return;
			}
			
			// ×©×™××•×© ×‘×¤×•× ×§×¦×™×™×ª ×”×—×™×¤×•×© ×”×—×›××” ×”×—×“×©×”
			const filteredClients = searchClientsAdvanced(searchTerm);
			populateClientDropdown(filteredClients);
			showClientDropdown();
		}

		function showAllClients() {
			const allClients = locations
				.filter(location => location.active === "1")
				.slice(0, 10);
			populateClientDropdown(allClients);
		}

		function showClientDropdown() {
			document.getElementById('clientDropdown').style.display = 'block';
			clientDropdownOpen = true;
		}

		function hideClientDropdown() {
			setTimeout(() => {
				document.getElementById('clientDropdown').style.display = 'none';
				clientDropdownOpen = false;
			}, 200);
		}

		function toggleClientDropdown() {
			if (clientDropdownOpen) {
				hideClientDropdown();
			} else {
				showAllClients();
				showClientDropdown();
			}
		}

		function populateClientDropdown(clients) {
			const dropdown = document.getElementById('clientDropdown');
			if (!dropdown) return;
			
			if (clients.length === 0) {
				dropdown.innerHTML = '<div style="padding: 10px; color: #666; text-align: center;">×œ× × ××¦××• ×œ×§×•×—×•×ª</div>';
				return;
			}
			
			const html = clients.map(client => `
				<div class="client-option" onclick="selectClientFromDropdown('${client.ID}')" 
					 style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;">
					<div style="font-weight: bold;">${client.name}</div>
					<div style="font-size: 12px; color: #666;">${client.full_address}</div>
				</div>
			`).join('');
			
			dropdown.innerHTML = html;
		}

		function selectClientFromDropdown(clientId) {
			const client = locations.find(c => c.ID === clientId);
			if (!client) return;
			
			document.getElementById('clientSearchInput').value = `${client.name} - ${client.full_address}`;
			document.getElementById('selectedClientId').value = clientId;
			
			hideClientDropdown();
		}

		function openAddClientModal() {
			showAddLocationForm();
		}

		// ×”×’×“×¨×ª ×”×©×¢×” ×”× ×•×›×—×™×ª
		// Update the existing setCurrentTime function to handle edit form
		function setCurrentTime(timeInputId) {
			const now = new Date();
			const hours = String(now.getHours()).padStart(2, '0');
			const minutes = String(now.getMinutes()).padStart(2, '0');
			const currentTime = `${hours}:${minutes}`;
			
			document.getElementById(timeInputId).value = currentTime;
			
			// ×—×™×©×•×‘ ××©×š ×˜×™×¤×•×œ ×× ×©× ×™ ×”×©×“×•×ª ××œ××™×
			if (timeInputId.includes('modal')) {
				calculateModalDuration();
			} else if (timeInputId.includes('edit')) {
				calculateEditDuration(); // âœ… ×”×•×¡×¤×” ×œ×˜×•×¤×¡ ×”×¢×¨×™×›×”
			} else {
				calculateDurationFromTimes();
			}
			
			showToast(`×©×¢×” × ×•×›×—×™×ª: ${currentTime}`, 'info');
		}

		function calculateModalDuration() {
			const startTime = document.getElementById('modalStartTime').value;
			const endTime = document.getElementById('modalEndTime').value;
			
			if (startTime && endTime) {
				const start = new Date(`2000-01-01T${startTime}`);
				const end = new Date(`2000-01-01T${endTime}`);
				
				let diffMinutes = (end - start) / (1000 * 60);
				
				// ×× ×”×¡×™×•× ×œ×¤× ×™ ×”×”×ª×—×œ×”, ×–×” ×›× ×¨××” ×œ××—×¨×ª
				if (diffMinutes < 0) {
					diffMinutes += 24 * 60;
				}
				
				const hours = Math.floor(diffMinutes / 60);
				const minutes = diffMinutes % 60;
				
				// ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
				const displayDiv = document.getElementById('modalDurationDisplay');
				if (displayDiv) {
					displayDiv.innerHTML = `××©×š: <strong>${diffMinutes}</strong> ×“×§×•×ª (<strong>${(diffMinutes / 60).toFixed(1)}</strong> ×©×¢×•×ª)`;
				}
				
				// ×¢×“×›×•×Ÿ ×”×©×“×•×ª ×”××•×¡×ª×¨×™×
				document.getElementById('modalManualDurationMinutes').value = diffMinutes;
				document.getElementById('modalCalculatedHours').value = (diffMinutes / 60).toFixed(2);
				
				// ×—×™×©×•×‘ ×¢×œ×•×ª
				calculateModalTreatmentCost();
			}
		}

		function updateModalManualDuration() {
			const hours = parseInt(document.getElementById('modalDurationHours').value) || 0;
			const minutes = parseInt(document.getElementById('modalDurationMinutes').value) || 0;
			const totalMinutes = hours * 60 + minutes;
			const decimalHours = (totalMinutes / 60).toFixed(1);
			
			document.getElementById('modalManualDurationMinutes').value = totalMinutes;
			document.getElementById('modalCalculatedHours').value = decimalHours;
			
			calculateModalTreatmentCost();
		}

		function updateModalFromTotalMinutes() {
			const totalMinutes = parseInt(document.getElementById('modalManualDurationMinutes').value) || 0;
			const hours = Math.floor(totalMinutes / 60);
			const minutes = totalMinutes % 60;
			const decimalHours = (totalMinutes / 60).toFixed(1);
			
			document.getElementById('modalDurationHours').value = hours;
			document.getElementById('modalDurationMinutes').value = minutes;
			document.getElementById('modalCalculatedHours').value = decimalHours;
			
			calculateModalTreatmentCost();
		}

		function calculateModalTreatmentCost() {
			const totalMinutes = parseInt(document.getElementById('modalManualDurationMinutes')?.value) || 0;
			const numWorkers = parseInt(document.getElementById('modalNumWorkers')?.value) || 1;
			const expense = parseFloat(document.getElementById('modalExpense')?.value) || 0;
			
			if (totalMinutes > 0 && costSettings && costSettings.hourlyRate) {
				const hours = totalMinutes / 60;
				const baseCost = costSettings.hourlyRate * hours;
				const workersCost = (numWorkers - 1) * costSettings.workerCost * hours;
				const laborCost = baseCost + workersCost;
				const totalCost = laborCost + expense;
				
				const amountField = document.getElementById('modalAmount');
				if (amountField) {
					amountField.value = Math.round(totalCost);
				}
			}
		}

		function loadModalClientOptions() {
			const activeLocations = locations.filter(loc => loc.active === "1" || loc.active === true || loc.active === "×›×Ÿ");
			
			// ××™×•×Ÿ ×œ×¤×™ ×©×
			activeLocations.sort((a, b) => a.name.localeCompare(b.name, 'he'));
			
			// ×”×’×“×¨×ª autocompletion ×œ×—×™×¤×•×© ×œ×§×•×—×•×ª
			const searchInput = document.getElementById('modalClientSearchInput');
			const optionsDiv = document.getElementById('modalClientOptions');
			
			// × ×§×” ×¨×©×™××ª ××¤×©×¨×•×™×•×ª ×§×•×“××ª
			optionsDiv.innerHTML = '';
			
			// ×”×•×¡×£ event listener ×œ×—×™×¤×•×©
			searchInput.addEventListener('input', function() {
				filterClientOptions('modalClientSearchInput', 'modalClientOptions');
			});
		}

		function selectModalClient(clientId, clientName) {
			document.getElementById('modalSelectedClientId').value = clientId;
			document.getElementById('modalClientSearchInput').value = clientName;
			document.getElementById('modalClientOptions').style.display = 'none';
			
			// ×—×™×©×•×‘ ×¢×œ×•×ª ××•×˜×•××˜×™ ×›×©××‘×—×¨×™× ×œ×§×•×—
			calculateModalTreatmentCost();
		}



		// ×§×‘×™×¢×ª ×˜×™×¤×•×œ ×œ×©×‘×•×¢/×©×‘×•×¢×™×™×
		function setNextAllowedDay(clientId, allowedDay, weeksAhead = 1) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			// ××™×¤×•×™ ×™××™× ×œ× ×™× ×“×§×¡ ×”×©×‘×•×¢ (0=×¨××©×•×Ÿ, 1=×©× ×™...)
			const dayToNumber = {
				'×': 0,
				'×‘': 1,
				'×’': 2,
				'×“': 3,
				'×”': 4,
				'×•': 5,
				'×©': 6,
				'×›×œ ×™×•×': 0 // ×‘×¨×™×¨×ª ××—×“×œ
			};
			
			const targetDayOfWeek = dayToNumber[allowedDay] || 0;
			const today = new Date();
			
			// ×—×™×©×•×‘ ×”×ª××¨×™×š ×”× ×›×•×Ÿ - ×™×•× ××•×¢×“×£ ×‘×¢×•×“ X ×©×‘×•×¢×•×ª
			const daysUntilTargetDay = (targetDayOfWeek - today.getDay() + 7) % 7;
			const targetDate = new Date(today);
			
			// ×× ×”×™×•× ×”××•×¢×“×£ ×”×•× ×”×™×•× - ×§×— ××•×ª×• ×‘×©×‘×•×¢ ×”×‘×
			if (daysUntilTargetDay === 0 && weeksAhead === 1) {
				targetDate.setDate(today.getDate() + 7);
			} else {
				// ××—×¨×ª - ×§×— ×”×™×•× ×”××•×¢×“×£ + ×©×‘×•×¢×•×ª × ×•×¡×¤×™×
				targetDate.setDate(today.getDate() + daysUntilTargetDay + ((weeksAhead - 1) * 7));
			}
			
			const dateString = targetDate.toISOString().split('T')[0];
			
			// ×¢×“×›×•×Ÿ ×”×ª××¨×™×š
			updateClientNextVisit(clientId, dateString);
			
			const weekText = weeksAhead === 1 ? '×©×‘×•×¢' : '×©×‘×•×¢×™×™×';
			showToast(`× ×§×‘×¢ ${allowedDay} ×‘×¢×•×“ ${weekText} (${formatDate(dateString)})`, 'success');
		}

		function loadLocationsForSelect() {
			const select = document.getElementById('locationSelect');
			if (!select) return; // ×”×•×¡×£ ×‘×“×™×§×”
			
			select.innerHTML = '<option value="">×‘×—×¨ ×œ×§×•×—...</option>';
			
			locations.filter(location => location.active === "1").forEach(location => {
				const option = document.createElement('option');
				option.value = location.ID;
				option.textContent = `${location.name} - ${location.full_address}`;
				select.appendChild(option);
			});
		}

		// ×”×’×“×¨×ª ×ª××¨×™×š ×”×™×•× ×œ×›×œ ×©×“×•×ª ×”×ª××¨×™×š
		function setTodayAsDefault() {
			const today = new Date().toISOString().split('T')[0];
			document.querySelectorAll('.planning-date-input').forEach(input => {
				if (!input.value) {
					input.value = today;
				}
			});
		}

		// ×¡×™× ×•×Ÿ ×˜×‘×œ×ª ×œ×§×•×—×•×ª
		function filterLocationsTable() {
			loadLocationsTable(); // ×˜×¢×Ÿ ××—×“×© ×¢× ×¡×™× ×•×Ÿ
		}

		// ×§×‘×œ×ª ×¨×©×™××” ××¡×•× × ×ª ×©×œ ×œ×§×•×—×•×ª
		function getFilteredLocations() {
			let filteredData = [...locations];
			
			// ×¡×™× ×•×Ÿ ×œ×¤×™ ×©×
			const nameFilter = document.getElementById('filterClientName')?.value.toLowerCase();
			if (nameFilter) {
				filteredData = filteredData.filter(location => 
					location.name.toLowerCase().includes(nameFilter) ||
					location.full_address.toLowerCase().includes(nameFilter)
				);
			}
			
			// ×¡×™× ×•×Ÿ ×œ×¤×™ ×™×•×
			const dayFilter = document.getElementById('filterDay')?.value;
			if (dayFilter) {
				filteredData = filteredData.filter(location => location.allowed_day === dayFilter);
			}
			
			// ×¡×™× ×•×Ÿ ×œ×¤×™ ××¨×•×•×—
			const intervalFilter = document.getElementById('filterInterval')?.value;
			if (intervalFilter) {
				filteredData = filteredData.filter(location => location.interval_weeks == intervalFilter);
			}
			
			// ×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×˜×˜×•×¡
			const activeFilter = document.getElementById('filterActive')?.value;
			if (activeFilter !== "") {
				filteredData = filteredData.filter(location => location.active === activeFilter);
			}
			
			return filteredData;
		}

		// × ×™×§×•×™ ×¡×™× ×•× ×™×
		function clearLocationFilters() {
			const nameFilter = document.getElementById('filterClientName');
			const dayFilter = document.getElementById('filterDay');
			const intervalFilter = document.getElementById('filterInterval');
			const activeFilter = document.getElementById('filterActive');
			
			if (nameFilter) nameFilter.value = '';
			if (dayFilter) dayFilter.value = '';
			if (intervalFilter) intervalFilter.value = '';
			if (activeFilter) activeFilter.value = '';
			
			loadLocationsTable();
		}


		function startTreatment(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			// ×‘×“×™×§×” ×”×× ×™×© ×›×‘×¨ ×˜×™×¤×•×œ ×”×™×•× ×œ×œ×§×•×—
			const today = new Date().toISOString().split('T')[0];
			const existingTodayVisit = visits.find(visit => 
				visit.location_id === clientId && 
				visit.date === today
			);
			
			if (existingTodayVisit) {
				// ×™×© ×›×‘×¨ ×˜×™×¤×•×œ ×”×™×•× - ×¤×ª×— ×¢×¨×™×›×”
				showToast(`× ××¦× ×˜×™×¤×•×œ ×§×™×™× ×”×™×•× ×¢×‘×•×¨ ${client.name} - ×¤×•×ª×— ×œ×¢×¨×™×›×”`, 'info');
				editVisit(existingTodayVisit.ID);
			} else {
				// ××™×Ÿ ×˜×™×¤×•×œ ×”×™×•× - ×¦×•×¨ ×—×“×©
				showToast(`×¤×•×ª×— ×˜×™×¤×•×œ ×—×“×© ×¢×‘×•×¨ ${client.name}`, 'success');
				
				// ×¤×ª×— ×˜×•×¤×¡ ×˜×™×¤×•×œ ×—×“×© ×¢× ×”×œ×§×•×— ××•×›×Ÿ ××¨××©
				showAddTreatmentForm();
				
				// ××—×¨×™ ×¤×ª×™×—×ª ×”×˜×•×¤×¡, ××œ× ××ª ×¤×¨×˜×™ ×”×œ×§×•×—
				setTimeout(() => {
					const clientSearchInput = document.getElementById('modalClientSearchInput');
					const selectedClientId = document.getElementById('modalSelectedClientId');
					const modalDate = document.getElementById('modalVisitDate');
					
					if (clientSearchInput && selectedClientId) {
						clientSearchInput.value = `${client.name} - ${client.full_address}`;
						selectedClientId.value = clientId;
					}
					
					if (modalDate) {
						modalDate.value = today;
					}
					
					// ×—×™×©×•×‘ ×¢×œ×•×ª ××•×˜×•××˜×™
					if (typeof calculateModalTreatmentCost === 'function') {
						calculateModalTreatmentCost();
					}
				}, 100);
			}
		}



		// Receipt filtering functions
		function loadReceiptFilterOptions() {
			// Load book numbers
			const bookSelect = document.getElementById('filterReceiptBook');
			if (bookSelect) {
				const uniqueBooks = [...new Set(receipts.map(r => r.book_number).filter(b => b))];
				bookSelect.innerHTML = '<option value="">×›×œ ×”×¤× ×§×¡×™×</option>';
				uniqueBooks.sort().forEach(book => {
					bookSelect.innerHTML += `<option value="${book}">${book}</option>`;
				});
			}
		}

		// Update applyReceiptFilters function - add this at the beginning:
		function applyReceiptFilters() {
			// Check if smart search is active
			const smartSearch = document.getElementById('receiptSmartSearch')?.value;
			if (smartSearch && smartSearch.trim()) {
				handleReceiptSmartSearch(smartSearch);
				return;
			}
			
			let filteredReceipts = [...receipts];
			
			// Apply filters with null safety
			const bookFilter = document.getElementById('filterReceiptBook')?.value || '';
			const paymentFilter = document.getElementById('filterPaymentType')?.value || '';
			const dateFrom = document.getElementById('filterReceiptDateFrom')?.value || '';
			const dateTo = document.getElementById('filterReceiptDateTo')?.value || '';
			const sortBy = document.getElementById('receiptSortBy')?.value || 'date_desc';
			
			if (bookFilter) {
				filteredReceipts = filteredReceipts.filter(r => r.book_number === bookFilter);
			}
			
			if (paymentFilter) {
				filteredReceipts = filteredReceipts.filter(r => r.payment_type === paymentFilter);
			}
			
			if (dateFrom) {
				filteredReceipts = filteredReceipts.filter(r => r.date >= dateFrom);
			}
			
			if (dateTo) {
				filteredReceipts = filteredReceipts.filter(r => r.date <= dateTo);
			}
			
			// Sort results
			filteredReceipts.sort((a, b) => {
				switch(sortBy) {
					case 'date_asc': return a.date.localeCompare(b.date);
					case 'date_desc': return b.date.localeCompare(a.date);
					case 'amount_asc': return (a.amount || 0) - (b.amount || 0);
					case 'amount_desc': return (b.amount || 0) - (a.amount || 0);
					case 'book_asc': return (a.book_number || '').localeCompare(b.book_number || '');
					default: return b.date.localeCompare(a.date);
				}
			});
			
			displayFilteredReceipts(filteredReceipts);
			updateReceiptsStats(filteredReceipts);
		}

		function sortReceiptResults(receipts, sortBy) {
			switch(sortBy) {
				case 'date_desc':
					receipts.sort((a, b) => new Date(b.date) - new Date(a.date));
					break;
				case 'date_asc':
					receipts.sort((a, b) => new Date(a.date) - new Date(b.date));
					break;
				case 'amount_desc':
					receipts.sort((a, b) => (b.amount || 0) - (a.amount || 0));
					break;
				case 'amount_asc':
					receipts.sort((a, b) => (a.amount || 0) - (b.amount || 0));
					break;
				case 'book_asc':
					receipts.sort((a, b) => (a.book_number || '').localeCompare(b.book_number || ''));
					break;
			}
		}

		function clearReceiptFilters() {
			const bookFilter = document.getElementById('filterReceiptBook');
			const paymentType = document.getElementById('filterPaymentType');
			const dateFrom = document.getElementById('filterReceiptDateFrom');
			const dateTo = document.getElementById('filterReceiptDateTo');
			const sortBy = document.getElementById('receiptSortBy');
			const smartSearch = document.getElementById('receiptSmartSearch');
			
			if (bookFilter) bookFilter.value = '';
			if (paymentType) paymentType.value = '';
			if (dateFrom) dateFrom.value = '';
			if (dateTo) dateTo.value = '';
			if (sortBy) sortBy.value = 'date_desc';
			if (smartSearch) smartSearch.value = '';
			
			displayFilteredReceipts(receipts);
		}

		function displayFilteredReceipts(filteredReceipts) {
			const tbody = document.getElementById('receiptsTableBody');
			tbody.innerHTML = '';
			
			if (filteredReceipts.length === 0) {
				tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">××™×Ÿ ×§×‘×œ×•×ª ××ª××™××•×ª ×œ×¡×™× ×•×Ÿ</td></tr>';
				return;
			}

			filteredReceipts.forEach(receipt => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${receipt.book_number || ''}</td>
					<td>${receipt.receipt_number || ''}</td>
					<td>${formatDate(receipt.date)}</td>
					<td>${receipt.location_name || ''}</td>
					<td>â‚ª${receipt.amount || 0}</td>
					<td>${receipt.payment_type || ''}</td>
					<td>${receipt.codeX || ''}</td>
					<td>
						<button class="action-btn edit-btn" onclick="editReceipt('${receipt.ID}')">×¢×¨×•×š</button>
						<button class="action-btn delete-btn" onclick="deleteReceipt('${receipt.ID}')">××—×§</button>
					</td>
				`;
				tbody.appendChild(row);
				
				// ×”×•×¡×¤×ª ×©×•×¨×ª ×”×¢×¨×•×ª ×× ×§×™×™××•×ª
				if (receipt.notes && receipt.notes.trim() !== '') {
					const notesRow = document.createElement('tr');
					notesRow.className = 'notes-row';
					notesRow.innerHTML = `
						<td colspan="8" class="notes-cell">
							<div class="notes-content">
								<strong>ğŸ“ ×”×¢×¨×•×ª:</strong> ${receipt.notes}
							</div>
						</td>
					`;
					tbody.appendChild(notesRow);
				}
			});
			updateReceiptsStats(filteredReceipts);
		}

		// Update stats functions for all tabs

		function updateReceiptsStats(filteredReceipts) {
			const count = filteredReceipts.length;
			const total = filteredReceipts.reduce((sum, receipt) => {
				const amount = parseFloat(receipt.amount) || 0;
				return sum + amount;
			}, 0);
			const average = count > 0 ? Math.round(total / count) : 0;
			
			document.getElementById('receiptsCount').textContent = count;
			document.getElementById('receiptsTotal').textContent = `${Math.round(total)} â‚ª`; // ×”×¢×‘×¨ ××ª â‚ª ×œ×¡×•×£
			document.getElementById('receiptsAverage').textContent = `${average} â‚ª`;
		}


		function updateDebtsStats(debtsArray) {
			const totalDebt = debtsArray.reduce((sum, debt) => sum + debt.totalDebt, 0);
			const debtorsCount = debtsArray.length;
			const averageDebt = debtorsCount > 0 ? totalDebt / debtorsCount : 0;
			
			// Update stats display
			const debtsCountElement = document.getElementById('debtsCount');
			const debtsTotalElement = document.getElementById('debtsTotal');
			const debtsAverageElement = document.getElementById('debtsAverage');
			
			if (debtsCountElement) debtsCountElement.textContent = debtorsCount;
			if (debtsTotalElement) debtsTotalElement.textContent = `â‚ª${Math.round(totalDebt).toLocaleString()}`;
			if (debtsAverageElement) debtsAverageElement.textContent = `â‚ª${Math.round(averageDebt).toLocaleString()}`;
		}

		function updateTreatmentsStats(filteredTreatments) {
			const count = filteredTreatments.length;
			const total = filteredTreatments.reduce((sum, treatment) => {
				const amount = parseFloat(treatment.amount) || 0;
				return sum + amount;
			}, 0);
			const paidCount = filteredTreatments.filter(t => getVisitPaymentStatus(t.ID) === 'paid').length;
			const unpaidCount = filteredTreatments.filter(t => getVisitPaymentStatus(t.ID) === 'unpaid').length;
			
			// ×—×™×©×•×‘ ×—×•×‘×•×ª ×¤×ª×•×—×™×
			const openDebts = filteredTreatments
				.filter(t => getVisitPaymentStatus(t.ID) === 'unpaid')
				.reduce((sum, treatment) => {
					const amount = parseFloat(treatment.amount) || 0;
					const paidAmount = getVisitPaidAmount(treatment.ID);
					return sum + (amount - paidAmount);
				}, 0);
			
			document.getElementById('treatmentsCount').textContent = count;
			document.getElementById('treatmentsTotal').textContent = `${Math.round(total)} â‚ª`;
			document.getElementById('treatmentsPaid').textContent = paidCount;
			document.getElementById('treatmentsUnpaid').textContent = unpaidCount;
			
			// ×”×•×¡×£ ×—×•×‘ ×œ×¡×˜×˜×™×¡×˜×™×§×•×ª
			const debtsElement = document.getElementById('treatmentsDebts');
			if (debtsElement) {
				debtsElement.textContent = `${Math.round(openDebts)} â‚ª`;
			}
		}


		// ×¤×•× ×§×¦×™×” ×œ×¡×™× ×•×Ÿ ××”×™×¨ ×œ×¤×™ ×ª××¨×™×›×™×
		function setQuickDateFilter(period) {
			const today = new Date();
			const dateFromInput = document.getElementById('filterDateFrom');
			const dateToInput = document.getElementById('filterDateTo');
			
			// ×”×¡×¨×ª active ××›×œ ×”×›×¤×ª×•×¨×™×
			document.querySelectorAll('.filter-quick-btn').forEach(btn => btn.classList.remove('active'));
			
			let fromDate;
			
			switch(period) {
				case 'today':
					fromDate = new Date(today);
					break;
				case 'week':
					fromDate = new Date(today);
					fromDate.setDate(today.getDate() - 7);
					break;
				case 'month':
					fromDate = new Date(today);
					fromDate.setMonth(today.getMonth() - 1);
					break;
			}
			
			dateFromInput.value = fromDate.toISOString().split('T')[0];
			dateToInput.value = today.toISOString().split('T')[0];
			
			// ×¡×™××•×Ÿ ×”×›×¤×ª×•×¨ ×›×¤×¢×™×œ
			event.target.classList.add('active');
			
			// ×”×¤×¢×œ×ª ×”×¡×™× ×•×Ÿ
			applyVisitFilters();
		}


		function clearVisitFilters() {
			const locationFilter = document.getElementById('filterLocation');
			const paymentFilter = document.getElementById('filterPayment');
			const dateFrom = document.getElementById('filterDateFrom');
			const dateTo = document.getElementById('filterDateTo');
			const maxResults = document.getElementById('maxResults');
			const activeFilter = document.getElementById('filterActiveClients');
			const smartSearch = document.getElementById('visitSmartSearch');
			
			if (locationFilter) locationFilter.value = '';
			if (paymentFilter) paymentFilter.value = '';
			if (dateFrom) dateFrom.value = '';
			if (dateTo) dateTo.value = '';
			if (maxResults) maxResults.value = '200';
			if (activeFilter) activeFilter.value = '1';
			if (smartSearch) smartSearch.value = '';
			
			// Clear quick filter buttons
			document.querySelectorAll('.filter-quick-btn').forEach(btn => 
				btn.classList.remove('active')
			);
			
			displayFilteredVisits(visits);
			updateTreatmentsStats(visits);
		}



		function showAddTreatmentForm() {

			const modalContent = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 650px; width: 90vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
					<h3 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 22px; border-bottom: 2px solid #3498db; padding-bottom: 10px;">ğŸ”§ ×˜×™×¤×•×œ ×—×“×©</h3>
					
					<form id="modalVisitForm" onsubmit="handleModalVisitSubmit(event)" style="display: flex; flex-direction: column; gap: 18px;">
						
						<!-- ×ª××¨×™×š ×•×œ×§×•×— -->
						<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px;">
							<div class="form-group" style="margin: 0;">
								<label for="modalVisitDate" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">×ª××¨×™×š:</label>
								<input type="date" id="modalVisitDate" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
							</div>
							
							<div class="form-group" style="margin: 0; position: relative;">
								<label for="modalClientSearchInput" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">×œ×§×•×—:</label>
								<input type="text" id="modalClientSearchInput" placeholder="ğŸ” ×—×™×¤×•×© ×œ×§×•×—..." onkeyup="filterClientOptions('modalClientSearchInput', 'modalClientOptions')" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
								<div id="modalClientOptions" class="client-options" style="display: none;"></div>
								<input type="hidden" id="modalSelectedClientId">
							</div>
						</div>
						
						<!-- ×¡×•×’ ×˜×™×¤×•×œ - ×›×¤×ª×•×¨×™ ×¨×“×™×• -->
						<div class="form-group" style="margin: 0;">
							<label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">×¡×•×’ ×˜×™×¤×•×œ:</label>
							<div style="display: flex; gap: 15px;">
								<label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 8px 15px; border: 2px solid #ddd; border-radius: 6px; transition: all 0.2s;">
									<input type="radio" name="modalVisitType" value="××œ×" checked onchange="document.getElementById('modalVisitTypeHidden').value=this.value" style="margin: 0;">
									<span style="font-size: 14px;">××œ×</span>
								</label>
								<label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 8px 15px; border: 2px solid #ddd; border-radius: 6px; transition: all 0.2s;">
									<input type="radio" name="modalVisitType" value="×—×œ×§×™" onchange="document.getElementById('modalVisitTypeHidden').value=this.value" style="margin: 0;">
									<span style="font-size: 14px;">×—×œ×§×™</span>
								</label>
								<label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 8px 15px; border: 2px solid #ddd; border-radius: 6px; transition: all 0.2s;">
									<input type="radio" name="modalVisitType" value="×‘×™×§×•×¨×ª" onchange="document.getElementById('modalVisitTypeHidden').value=this.value" style="margin: 0;">
									<span style="font-size: 14px;">×‘×™×§×•×¨×ª</span>
								</label>
								<input type="hidden" id="modalVisitTypeHidden" value="××œ×">
							</div>
						</div>
						
						<!-- ×¢×‘×•×“×” ×©×‘×•×¦×¢×” -->
						<div class="form-group" style="margin: 0;">
							<label for="modalWorkDone" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">×¢×‘×•×“×” ×©×‘×•×¦×¢×”:</label>
							<textarea id="modalWorkDone" rows="2" placeholder="×ª×™××•×¨ ×”×¢×‘×•×“×”..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
						</div>
						
						<!-- ××©×š ×˜×™×¤×•×œ - ×”×ª×—×œ×”/×¡×™×•× -->
						<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">
							<label style="display: block; margin-bottom: 10px; font-weight: 600; color: #555;">â±ï¸ ××©×š ×”×˜×™×¤×•×œ:</label>
							<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
								<div>
									<label for="modalStartTime" style="display: block; margin-bottom: 5px; font-size: 13px; color: #666;">×©×¢×ª ×”×ª×—×œ×”:</label>
									<div style="display: flex; gap: 6px;">
										<input type="time" id="modalStartTime" onchange="calculateModalDuration()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
										<button type="button" onclick="setCurrentTime('modalStartTime')" style="padding: 8px 12px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;">×¢×›×©×™×•</button>
									</div>
								</div>
								<div>
									<label for="modalEndTime" style="display: block; margin-bottom: 5px; font-size: 13px; color: #666;">×©×¢×ª ×¡×™×•×:</label>
									<div style="display: flex; gap: 6px;">
										<input type="time" id="modalEndTime" onchange="calculateModalDuration()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
										<button type="button" onclick="setCurrentTime('modalEndTime')" style="padding: 8px 12px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;">×¢×›×©×™×•</button>
									</div>
								</div>
							</div>
							<div id="modalDurationDisplay" style="text-align: center; padding: 8px; background: white; border-radius: 6px; font-weight: 600; color: #3498db; font-size: 15px;">
								××©×š: -- ×“×§×•×ª (-- ×©×¢×•×ª)
							</div>
							<input type="hidden" id="modalManualDurationMinutes" value="0">
							<input type="hidden" id="modalCalculatedHours" value="0">
						</div>
						
						<!-- ×¢×œ×•×ª ×•×¢×•×‘×“×™× -->
						<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
							<div class="form-group" style="margin: 0;">
								<label for="modalAmount" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ğŸ’° ×¡×›×•× ×œ×’×‘×™×™×”:</label>
								<input type="number" id="modalAmount" step="0.01" min="0" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
							</div>
							
							<div class="form-group" style="margin: 0;">
								<label for="modalNumWorkers" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ğŸ‘· ×¢×•×‘×“×™×:</label>
								<input type="number" id="modalNumWorkers" min="1" value="1" onchange="calculateModalTreatmentCost()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
							</div>
							
							<div class="form-group" style="margin: 0;">
								<label for="modalExpense" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ğŸ’¸ ×”×•×¦××”:</label>
								<input type="number" id="modalExpense" step="0.01" min="0" value="0" placeholder="0" onchange="calculateModalTreatmentCost()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
							</div>
						</div>
						
						<!-- ×”×¢×¨×•×ª -->
						<div class="form-group" style="margin: 0;">
							<label for="modalNotes" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ğŸ“ ×”×¢×¨×•×ª:</label>
							<textarea id="modalNotes" rows="2" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
						</div>
						
						<!-- ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” -->
						<div style="display: flex; gap: 12px; justify-content: center; margin-top: 10px; padding-top: 15px; border-top: 1px solid #e9ecef;">
							<button type="submit" style="background: #27ae60; color: white; padding: 12px 35px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 8px rgba(39,174,96,0.3);">ğŸ’¾ ×©××•×¨ ×˜×™×¤×•×œ</button>
							<button type="button" onclick="closeAnyModal()" style="background: #95a5a6; color: white; padding: 12px 35px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s;">âœ– ×‘×™×˜×•×œ</button>
						</div>
					</form>
				</div>
				
				<style>
					label:has(input[type="radio"]:checked) {
						border-color: #3498db !important;
						background: #e3f2fd !important;
					}
				</style>
			`;
			
			showModal(modalContent);
			
			// ×”×’×“×¨×ª ×ª××¨×™×š ×”×™×•×
			document.getElementById('modalVisitDate').value = new Date().toISOString().split('T')[0];
			
			// ×˜×¢×™× ×ª ×¨×©×™××ª ×œ×§×•×—×•×ª
			loadModalClientOptions();
		}
		
		
		// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×”×¢×¨×•×ª ×—×•×‘
		async function updateDebtNotes(locationId, notes) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			// ×¢×“×›×•×Ÿ ××§×•××™
			location.debt_notes = notes;
			saveToLocalStorage();
			
			// ×¢×“×›×•×Ÿ ×‘×¢× ×Ÿ (×× ××—×•×‘×¨)
			if (access_token && SPREADSHEET_ID) {
				try {
					await updateLocationInCloud(location);
					console.log('×”×¢×¨×•×ª ×—×•×‘ ×¢×•×“×›× ×• ×‘×¢× ×Ÿ');
				} catch (error) {
					console.log('×”×¢×¨×•×ª ×¢×•×“×›× ×• ××§×•××™×ª ×‘×œ×‘×“');
				}
			}
		}

		// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×¤×¢×™×œ×•×ª ×œ×§×•×—
		async function updateLocationActive(locationId, activeStatus) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			// ×¢×“×›×•×Ÿ ××§×•××™
			location.active = activeStatus;
			saveToLocalStorage();
			
			// ×¢×“×›×•×Ÿ ×‘×¢× ×Ÿ (×× ××—×•×‘×¨)
			if (access_token && SPREADSHEET_ID) {
				try {
					await updateLocationInCloud(location);
					console.log('×¡×˜×˜×•×¡ ×¤×¢×™×œ×•×ª ×¢×•×“×›×Ÿ ×‘×¢× ×Ÿ');
				} catch (error) {
					console.log('×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ ××§×•××™×ª ×‘×œ×‘×“');
				}
			}
			
			// ×¨×¢× ×•×Ÿ ×˜×‘×œ××•×ª ×¨×œ×•×•× ×˜×™×•×ª
			loadLocationsForSelect(); // ×¢×“×›×•×Ÿ ×¨×©×™××•×ª × ×¤×ª×—×•×ª
			updateLocationsStats(getFilteredLocations()); // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
		}

		// ××¢×‘×¨ ×œ×˜××‘ ×˜×™×¤×•×œ×™× ××¡×•× ×Ÿ ×œ×¤×™ ×œ×§×•×—
		function showClientTreatments(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			// Jump to treatments tab
			showSection('history');
			
			// Wait for tab to load, then apply client filter
			setTimeout(() => {
				// Clear existing filters
				if (typeof clearVisitFilters === 'function') {
					clearVisitFilters();
				}
				
				// Set smart search to client name
				const smartSearchInput = document.getElementById('visitSmartSearch');
				if (smartSearchInput) {
					smartSearchInput.value = client.name;
					// Trigger the search
					if (typeof handleVisitSmartSearch === 'function') {
						handleVisitSmartSearch(client.name);
					}
				}
				
				showToast(`××¦×™×’ ×˜×™×¤×•×œ×™× ×¢×‘×•×¨ ${client.name}`, 'success', 2000);
			}, 200);
		}

		function showClientReceipts(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			// Jump to receipts tab
			showSection('receipts');
			
			// Wait for tab to load, then apply client filter
			setTimeout(() => {
				// Clear existing filters
				if (typeof clearReceiptFilters === 'function') {
					clearReceiptFilters();
				}
				
				// Set client filter if dropdown exists
				const clientFilter = document.getElementById('filterReceiptClient');
				if (clientFilter) {
					clientFilter.value = clientId;
					// Apply filters
					if (typeof applyReceiptFilters === 'function') {
						applyReceiptFilters();
					}
				}
				
				showToast(`××¦×™×’ ×§×‘×œ×•×ª ×¢×‘×•×¨ ${client.name}`, 'info', 2000);
			}, 200);
		}


		// ×˜×¢×™× ×ª ×œ×§×•×—×•×ª ×œ×‘×—×™×¨×” ×‘××•×“×œ
		function loadClientsForModal() {
			const clientSearchInput = document.getElementById('modalClientSearchInput');
			const clientOptions = document.getElementById('modalClientOptions');
			
			if (!clientSearchInput || !clientOptions) return;
			
			// ×”×’×“×¨×ª ×××–×™×Ÿ ×œ×§×œ×˜
			clientSearchInput.addEventListener('input', function() {
				filterClientOptions('modalClientSearchInput', 'modalClientOptions');
			});
		}

		// ×¡×™× ×•×Ÿ ××¤×©×¨×•×™×•×ª ×œ×§×•×—×•×ª ×‘××•×“×œ (×× ×¦×œ ××ª ×”×¤×•× ×§×¦×™×” ×”×§×™×™××ª)
		// ×”×¤×•× ×§×¦×™×” filterClientOptions ×›×‘×¨ ×§×™×™××ª ×•×ª×¢×‘×•×“ ×¢× ×”-IDs ×”×—×“×©×™×

		// ×˜×™×¤×•×œ ×‘×©×œ×™×—×ª ×”×˜×•×¤×¡ ××”××•×“×œ
		// ××©×ª× ×” ×’×œ×•×‘×œ×™ ×œ×× ×™×¢×ª ×œ×—×™×¦×•×ª ×›×¤×•×œ×•×ª
		let isSubmittingVisit = false;

		async function handleModalVisitSubmit(event) {
			event.preventDefault();
			
			// ğŸ›¡ï¸ ×”×’× ×” ××¤× ×™ ×œ×—×™×¦×•×ª ×›×¤×•×œ×•×ª
			if (isSubmittingVisit) {
				console.log('âš ï¸ Already submitting, ignoring duplicate click');
				return;
			}
			
			isSubmittingVisit = true;
			
			try {
				// ××™×¡×•×£ × ×ª×•× ×™× ××”×˜×•×¤×¡
				const visitDate = document.getElementById('modalVisitDate').value;
				const selectedClientId = document.getElementById('modalSelectedClientId').value;
				const visitType = document.getElementById('modalVisitTypeHidden').value;
				const workDone = document.getElementById('modalWorkDone').value;
				const startTime = document.getElementById('modalStartTime').value;
				const endTime = document.getElementById('modalEndTime').value;
				const durationMinutes = parseInt(document.getElementById('modalManualDurationMinutes').value) || 0;
				const numWorkers = parseInt(document.getElementById('modalNumWorkers').value) || 1;
				const amount = parseFloat(document.getElementById('modalAmount').value) || 0;
				const expense = parseFloat(document.getElementById('modalExpense').value) || 0;
				const notes = document.getElementById('modalNotes').value;
				
				// ×‘×“×™×§×•×ª ×‘×¡×™×¡×™×•×ª
				if (!selectedClientId) {
					showToast('âŒ ×× × ×‘×—×¨ ×œ×§×•×—', 'error');
					isSubmittingVisit = false;
					return;
				}
				
				if (!visitDate) {
					showToast('âŒ × ×“×¨×© ×ª××¨×™×š ×˜×™×¤×•×œ', 'error');
					isSubmittingVisit = false;
					return;
				}
				
				if (!visitType) {
					showToast('âŒ × ×“×¨×© ×¡×•×’ ×˜×™×¤×•×œ', 'error');
					isSubmittingVisit = false;
					return;
				}
				
				// Get client info
				const client = locations.find(loc => loc.ID === selectedClientId);
				const clientName = client ? client.name : '×œ×§×•×— ×œ× ×™×“×•×¢';
				
				// Create new visit
				const newVisit = {
					ID: generateID(),
					date: visitDate,
					location_id: selectedClientId,
					location_name: clientName,
					visit_type: visitType,
					work_done: workDone,
					duration_minutes: durationMinutes,
					num_workers: numWorkers,
					start_time: startTime || '',
					end_time: endTime || '',
					amount: amount,
					paid: '0', 
					expense: expense,
					notes: notes
				};
				
				// Add to visits array
				visits.push(newVisit);
				
				// Save locally
				saveToLocalStorage();
				
				// Save to cloud if connected
				let cloudSaved = false;
				if (access_token && SPREADSHEET_ID) {
					try {
						cloudSaved = await saveVisitsBatch([newVisit]);
					} catch (error) {
						console.error('Cloud save failed:', error);
					}
				}
				
				// Update treatment dates
				await updateSingleLocationTreatmentDates(newVisit.location_id);

				// Close modal
				closeAnyModal();

				// Refresh displays
				loadPlanningData();

				// Refresh visits table only if we're on the history tab
				const visitsTable = document.getElementById('visitsTableBody');
				if (visitsTable && visitsTable.offsetParent !== null) {
					// We're on the history tab, safe to call filterVisits
					if (typeof filterVisits === 'function') {
						filterVisits();
					}
				}
				
				// Success message
				if (access_token && SPREADSHEET_ID) {
					if (cloudSaved) {
						showToast('âœ… ×”×˜×™×¤×•×œ × ×©××¨ ×‘×”×¦×œ×—×” ×‘××¢×¨×›×ª ×•×‘×¢× ×Ÿ!', 'success');
					} else {
						showToast('âš ï¸ ×”×˜×™×¤×•×œ × ×©××¨ ××§×•××™×ª ×‘×œ×‘×“ - ×‘×¢×™×” ×‘×—×™×‘×•×¨ ×œ×¢× ×Ÿ', 'warning');
					}
				} else {
					showToast('ğŸ’¾ ×”×˜×™×¤×•×œ × ×©××¨ ××§×•××™×ª - ×”×ª×—×‘×¨ ×œ×¢× ×Ÿ ×œ×©××™×¨×” ××œ××”', 'info');
				}
				
			} catch (error) {
				console.error('Error submitting visit:', error);
				showToast('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×˜×™×¤×•×œ', 'error');
			} finally {
				// ğŸ”“ ×©×—×¨×¨ ××ª ×”× ×¢×™×œ×”
				isSubmittingVisit = false;
			}
		}

		function filterClientOptions(inputId, optionsId) {
			const searchInput = document.getElementById(inputId);
			const optionsDiv = document.getElementById(optionsId);
			const searchTerm = searchInput.value.toLowerCase();
			
			if (searchTerm.length < 1) {
				optionsDiv.style.display = 'none';
				return;
			}
			
			const activeLocations = locations.filter(loc => 
				(loc.active === "1" || loc.active === true || loc.active === "×›×Ÿ") &&
				loc.name.toLowerCase().includes(searchTerm)
			);
			
			if (activeLocations.length === 0) {
				optionsDiv.innerHTML = '<div style="padding: 10px; color: #666;">××™×Ÿ ×œ×§×•×—×•×ª ×ª×•×××™×</div>';
				optionsDiv.style.display = 'block';
				return;
			}
			
			let optionsHTML = '';
			activeLocations.slice(0, 10).forEach(location => {
				const safeName = (location.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
				const safeAddress = (location.full_address || '×œ×œ× ×›×ª×•×‘×ª').replace(/'/g, "\\'").replace(/"/g, '&quot;');
				
				optionsHTML += `
					<div class="client-option" onclick="selectModalClient('${location.ID}', '${safeName}')">
						<strong>${safeName}</strong>
						<div style="font-size: 12px; color: #666;">${safeAddress}</div>
					</div>
				`;
			});

			optionsDiv.innerHTML = optionsHTML;
			optionsDiv.style.display = 'block';
		}


		///>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

		
	///   ×¤×•× ×§×¦×™×•×ª ×ª×©×œ×•××™×   //////////
	
		// ×˜×¢×™× ×ª ××¤×©×¨×•×™×•×ª ×¡×™× ×•×Ÿ ×ª×©×œ×•××™×
		function loadPaymentFilterOptions() {
			const clientSelect = document.getElementById('filterPaymentClient');
			
			if (clientSelect) {
				clientSelect.innerHTML = '<option value="">×›×œ ×”×œ×§×•×—×•×ª</option>';
				
				// Create unique client list from payments
				const uniqueClients = [...new Set(payments.map(p => p.client_name).filter(name => name))];
				uniqueClients.sort().forEach(clientName => {
					clientSelect.innerHTML += `<option value="${clientName}">${clientName}</option>`;
				});
			}
		}

		// ×¡×™× ×•×Ÿ ×ª×©×œ×•××™×
		function applyPaymentFilters() {
			// Check if smart search is active
			const smartSearch = document.getElementById('paymentSmartSearch')?.value;
			if (smartSearch && smartSearch.trim()) {
				handlePaymentSmartSearch(smartSearch);
				return;
			}
			
			// Get filter values with null safety
			const clientFilter = document.getElementById('filterPaymentClient')?.value || '';
			const dateFromFilter = document.getElementById('filterPaymentDateFrom')?.value || '';
			const dateToFilter = document.getElementById('filterPaymentDateTo')?.value || '';
			
			let filteredPayments = [...payments];
			
			// Filter by client
			if (clientFilter) {
				filteredPayments = filteredPayments.filter(p => p.client_name === clientFilter);
			}
			
			// Filter by date range
			if (dateFromFilter) {
				filteredPayments = filteredPayments.filter(p => p.date >= dateFromFilter);
			}
			if (dateToFilter) {
				filteredPayments = filteredPayments.filter(p => p.date <= dateToFilter);
			}
			
			displayPayments(filteredPayments);
			updatePaymentsStats(filteredPayments);
		}

		// ×”×¦×’×ª ×ª×©×œ×•××™× ×‘×˜×‘×œ×”
		function displayPayments(paymentsToShow = payments) {
			const tbody = document.querySelector('#paymentsTable tbody');
			if (!tbody) return;
			
			tbody.innerHTML = '';
			
			paymentsToShow.forEach(payment => {
				const row = tbody.insertRow();
				
				// ×¤×™×¨×•×˜ ×××¦×¢×™ ×ª×©×œ×•× ××©×•×¤×¨
				let paymentMethodText = '';
				switch(payment.payment_method) {
					case 'cash': paymentMethodText = '××–×•××Ÿ'; break;
					case 'check': paymentMethodText = '×¦\'×§'; break;
					case 'transfer': paymentMethodText = '×”×¢×‘×¨×”'; break;
					case 'app': paymentMethodText = '××¤×œ×™×§×¦×™×”'; break;
					default: paymentMethodText = payment.payment_method || '×œ× ×¦×•×™×Ÿ';
				}
				
				// ×”×¦×’×ª ××¡××›×ª× ×× ×§×™×™××ª
				if (payment.reference) {
					paymentMethodText += ` (${payment.reference})`;
				}
				
				row.innerHTML = `
					<td>${formatDate(payment.date)}</td>
					<td>${payment.client_name || '×œ× ×™×“×•×¢'}</td>
					<td>â‚ª${payment.amount.toLocaleString()}</td>
					<td>${paymentMethodText}</td>
					<td title="${payment.notes || ''}">${(payment.notes || '').substring(0, 50)}${payment.notes && payment.notes.length > 50 ? '...' : ''}</td>
					<td>
						<button onclick="showPaymentDetails('${payment.ID}')" class="btn-info" title="×¤×™×¨×•×˜ ××œ×">ğŸ” ×¤×™×¨×•×˜</button>
					</td>
				`;
			});
		}

		// ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×ª×©×œ×•××™×
		function updatePaymentsStats(filteredPayments) {
			const count = filteredPayments.length;
			const total = filteredPayments.reduce((sum, payment) => sum + (parseFloat(payment.amount) || 0), 0);
			const average = count > 0 ? Math.round(total / count) : 0;
			
			document.getElementById('paymentsCount').textContent = count;
			document.getElementById('paymentsTotal').textContent = `â‚ª${Math.round(total).toLocaleString()}`;
			document.getElementById('paymentsAverage').textContent = `â‚ª${average.toLocaleString()}`;
		}

		// × ×™×§×•×™ ×¡×™× ×•× ×™×
		function clearPaymentFilters() {
			document.getElementById('filterPaymentClient').value = '';
			document.getElementById('filterPaymentDateFrom').value = '';
			document.getElementById('filterPaymentDateTo').value = '';
			
			// × ×™×§×•×™ ×”×—×™×¤×•×© ×”×—×›×
			if (document.getElementById('paymentSmartSearch')) {
				document.getElementById('paymentSmartSearch').value = '';
			}
			
			applyPaymentFilters();
		}


		// ×”×¦×’×ª ×¤×™×¨×•×˜ ×ª×©×œ×•×
		function showPaymentDetails(paymentId) {
			const payment = payments.find(p => p.ID === paymentId);
			if (!payment) {
				showToast('×ª×©×œ×•× ×œ× × ××¦×', 'error');
				return;
			}
			
			// ××¦× ×˜×™×¤×•×œ×™× ×§×©×•×¨×™× ×œ×ª×©×œ×•×
			const relatedLinks = paymentVisitLinks.filter(link => link.payment_id === paymentId);
			const relatedVisits = relatedLinks.map(link => {
				const visit = visits.find(visit => visit.ID === link.visit_id);
				if (visit) {
					return {
						...visit,
						allocated_amount: link.amount_allocated || 0
					};
				}
				return null;
			}).filter(visit => visit);
			
			// ×—×™×©×•×‘ ×¡×›×•× ××§×•×©×¨
			const totalAllocated = relatedLinks.reduce((sum, link) => sum + (link.amount_allocated || 0), 0);
			const unallocated = payment.amount - totalAllocated;
			
			// ×˜×§×¡×˜ ×××¦×¢×™ ×ª×©×œ×•×
			let methodText = '';
			switch(payment.payment_method) {
				case 'cash': methodText = '××–×•××Ÿ'; break;
				case 'check': methodText = '×¦\'×§'; break;
				case 'transfer': methodText = '×”×¢×‘×¨×” ×‘× ×§××™×ª'; break;
				case 'app': methodText = '××¤×œ×™×§×¦×™×” (×‘×™×˜/×¤×™×™×‘×•×§×¡)'; break;
				default: methodText = payment.payment_method || '×œ× ×¦×•×™×™×Ÿ';
			}
			
			const modalContent = `
				<div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto; direction: rtl;">
					<h3 style="margin-bottom: 25px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
						ğŸ’³ ×¤×¨×˜×™ ×ª×©×œ×•×
					</h3>
					
					<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px; color: white;">
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
							<span style="font-size: 14px; opacity: 0.9;">×¡×›×•× ×”×ª×©×œ×•×:</span>
							<span style="font-size: 28px; font-weight: bold;">â‚ª${Math.round(payment.amount).toLocaleString()}</span>
						</div>
						<div style="font-size: 13px; opacity: 0.8;">
							ğŸ“… ${formatDate(payment.date)}
						</div>
					</div>
					
					<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
						<div style="margin-bottom: 15px;">
							<strong style="color: #666; font-size: 12px; display: block; margin-bottom: 5px;">ğŸ‘¤ ×œ×§×•×—:</strong>
							<div style="font-size: 16px; color: #2c3e50;">${payment.client_name || '×œ× ×™×“×•×¢'}</div>
						</div>
						
						<div style="margin-bottom: 15px;">
							<strong style="color: #666; font-size: 12px; display: block; margin-bottom: 5px;">ğŸ’³ ×××¦×¢×™ ×ª×©×œ×•×:</strong>
							<div style="font-size: 16px; color: #2c3e50;">${methodText}</div>
						</div>
						
						${payment.reference ? `
							<div style="margin-bottom: 15px;">
								<strong style="color: #666; font-size: 12px; display: block; margin-bottom: 5px;">ğŸ”¢ ××¡××›×ª×:</strong>
								<div style="font-size: 16px; color: #2c3e50;">${payment.reference}</div>
							</div>
						` : ''}
						
						${payment.check_date ? `
							<div style="margin-bottom: 15px;">
								<strong style="color: #666; font-size: 12px; display: block; margin-bottom: 5px;">ğŸ“† ×ª××¨×™×š ×¤×™×¨×¢×•×Ÿ ×¦'×§:</strong>
								<div style="font-size: 16px; color: #2c3e50;">${formatDate(payment.check_date)}</div>
							</div>
						` : ''}
						
						${payment.notes ? `
							<div>
								<strong style="color: #666; font-size: 12px; display: block; margin-bottom: 5px;">ğŸ“ ×”×¢×¨×•×ª:</strong>
								<div style="font-size: 14px; color: #555; line-height: 1.6;">${payment.notes}</div>
							</div>
						` : ''}
					</div>
					
					<div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #27ae60;">
						<h4 style="margin: 0 0 15px 0; color: #27ae60; font-size: 16px;">ğŸ”— ×˜×™×¤×•×œ×™× ××§×•×©×¨×™×:</h4>
						
						${relatedVisits.length > 0 ? 
							relatedVisits.map(visit => `
								<div style="padding: 12px; background: white; border-radius: 6px; margin-bottom: 10px; border-right: 4px solid #27ae60;">
									<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
										<strong style="color: #2c3e50;">${formatDate(visit.date)}</strong>
										<span style="background: #27ae60; color: white; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: bold;">
											â‚ª${visit.allocated_amount.toFixed(2)}
										</span>
									</div>
									<div style="font-size: 13px; color: #666;">
										${visit.work_done || '×œ×œ× ×ª×™××•×¨'}
									</div>
								</div>
							`).join('') 
							: '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">××™×Ÿ ×˜×™×¤×•×œ×™× ××§×•×©×¨×™× ×œ×ª×©×œ×•× ×–×”</div>'
						}
						
						${relatedVisits.length > 0 ? `
							<div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #27ae60; display: flex; justify-content: space-between; font-size: 14px;">
								<span><strong>×¡×›×•× ××§×•×©×¨:</strong></span>
								<span style="color: #27ae60; font-weight: bold;">â‚ª${totalAllocated.toFixed(2)}</span>
							</div>
							${unallocated > 0.01 ? `
								<div style="display: flex; justify-content: space-between; font-size: 14px; margin-top: 5px;">
									<span><strong>×¡×›×•× ×œ× ××§×•×©×¨:</strong></span>
									<span style="color: #f39c12; font-weight: bold;">â‚ª${unallocated.toFixed(2)}</span>
								</div>
							` : ''}
						` : ''}
					</div>
					
					<div style="text-align: center;">
						<button onclick="closeAnyModal()" style="background: #95a5a6; color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-size: 15px;">
							×¡×’×•×¨
						</button>
					</div>
				</div>
			`;
			
			showModal(modalContent);
		}

		// ×˜×¢×™× ×ª ×˜××‘ ×ª×©×œ×•××™×
		function loadPayments() {
			loadPaymentFilterOptions();
			applyPaymentFilters();
		}

		// ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ×ª×©×œ×•× ××—×¨×•×Ÿ ×©×œ ×œ×§×•×—
		function getLastPaymentDate(locationId) {
			const clientPayments = payments.filter(p => p.client_id === locationId);
			
			if (clientPayments.length === 0) {
				return null;
			}
			
			// ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š - ×”××—×¨×•×Ÿ ×¨××©×•×Ÿ
			clientPayments.sort((a, b) => new Date(b.date) - new Date(a.date));
			
			return clientPayments[0].date;
		}

		// ×¤×•× ×§×¦×™×” ×œ×¤×•×¨××˜ ×ª×¦×•×’×ª ×ª×©×œ×•× ××—×¨×•×Ÿ
		function formatLastPayment(locationId) {
			const lastPaymentDate = getLastPaymentDate(locationId);
			
			if (!lastPaymentDate) {
				return '<span style="color: #999; font-size: 12px;">××™×Ÿ ×ª×©×œ×•××™×</span>';
			}
			
			const daysSince = Math.floor((new Date() - new Date(lastPaymentDate)) / (1000 * 60 * 60 * 24));
			const color = daysSince > 90 ? '#e74c3c' : daysSince > 30 ? '#f39c12' : '#27ae60';
			
			return `
				<div style="text-align: center;">
					<div style="font-size: 12px;">${formatDate(lastPaymentDate)}</div>
					<div style="color: ${color}; font-size: 11px; font-weight: bold;">
						${daysSince === 0 ? '×”×™×•×' : daysSince === 1 ? '××ª××•×œ' : `×œ×¤× ×™ ${daysSince} ×™××™×`}
					</div>
				</div>
			`;
		}


		
		// ×¤×•× ×§×¦×™×” ×œ×§×‘×œ×ª ×©× ×œ×§×•×— ×œ×¤×™ ID
		function getClientNameById(clientId) {
			const location = locations.find(loc => loc.ID === clientId);
			return location ? location.name : null;
		}


		// ×©××™×¨×ª ×”×›× ×¡×•×ª ×‘×§×‘×•×¦×”
		async function saveIncomesBatch(incomesArray) {
			if (!incomesArray.length || !access_token || !SPREADSHEET_ID) {
				return false;
			}
			
			try {
				const values = incomesArray.map(income => [
					income.ID,
					income.date,
					income.time || '',
					income.client_address,
					income.client_id || '',
					income.amount,
					income.payment_method,
					income.notes || '',
					income.raw_text || '',
					income.imported_from || 'manual',
					income.import_date || new Date().toISOString().split('T')[0],
					income.matched_to_visit || false
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Incomes!A:L',
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`âœ… × ×©××¨×• ${incomesArray.length} ×”×›× ×¡×•×ª ×‘×¢× ×Ÿ`);
				return true;
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×©××™×¨×ª ×”×›× ×¡×•×ª ×‘×§×‘×•×¦×”:', error);
				return false;
			}
		}		


		// ×—×™×¤×•×© ×—×›× ×œ×§×•×—×•×ª - ×”×—×œ×¤×ª ×”×¤×•× ×§×¦×™×” ×”×§×™×™××ª
		function searchClientsAdvanced(searchTerm) {
			if (!searchTerm || searchTerm.trim() === '') {
				return locations.filter(location => location.active === "1").slice(0, 10);
			}
			
			const term = searchTerm.toLowerCase().trim();
			
			return locations
				.filter(location => location.active === "1")
				.filter(location => {
					const name = (location.name || '').toLowerCase();
					const address = (location.full_address || '').toLowerCase();
					const city = (location.city || '').toLowerCase();
					const neighborhood = (location.neighborhood || '').toLowerCase();
					const contact = (location.contact_person || '').toLowerCase();
					
					// ×—×™×¤×•×© ×—×œ×§×™ ×‘×›×œ ×”×©×“×•×ª ×”×¨×œ×•×•× ×˜×™×™×
					return name.includes(term) || 
						   address.includes(term) || 
						   city.includes(term) ||
						   neighborhood.includes(term) ||
						   contact.includes(term);
				})
				.slice(0, 15); // ×”×’×“×œ×ª ××¡×¤×¨ ×”×ª×•×¦××•×ª ×œ-15
		}



		// ×¢×“×›×•×Ÿ ×˜×™×¤×•×œ×™× × ×‘×—×¨×™× ×•×—×™×©×•×‘ ×¡×›×•×
		function updateSelectedVisits() {
			const checkboxes = document.querySelectorAll('.visit-checkbox:checked');
			selectedVisitIds = Array.from(checkboxes).map(cb => cb.value);
			
			let totalAmount = 0;
			selectedVisitIds.forEach(visitId => {
				const visit = visits.find(v => v.ID === visitId);
				if (visit) {
					totalAmount += parseFloat(visit.amount) || 0;
				}
			});
			
			document.getElementById('selectedAmount').textContent = totalAmount.toLocaleString();
			document.getElementById('selectedCount').textContent = selectedVisitIds.length;
			
			// ×”×¦×’×ª ×¤×¨×˜×™ ×”×ª×©×œ×•× ×× ×™×© ×˜×™×¤×•×œ×™× × ×‘×—×¨×™×
			if (selectedVisitIds.length > 0) {
				document.getElementById('paymentDetailsSection').style.display = 'block';
				document.getElementById('savePaymentBtn').disabled = false;
				
				// ×¢×“×›×•×Ÿ ×”×¢×¨×•×ª ××•×˜×•××˜×™
				const selectedDates = selectedVisitIds.map(visitId => {
					const visit = visits.find(v => v.ID === visitId);
					return visit ? formatDate(visit.date) : '';
				}).filter(date => date);
				
				document.getElementById('paymentNotes').value = 
					`×ª×©×œ×•× ×¢×‘×•×¨ ${selectedVisitIds.length} ×˜×™×¤×•×œ×™×: ${selectedDates.join(', ')}`;
			} else {
				document.getElementById('paymentDetailsSection').style.display = 'none';
				document.getElementById('savePaymentBtn').disabled = true;
			}
		}



		// ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×ª×©×œ×•× ×©×œ ×˜×™×¤×•×œ
		async function updatePaymentStatus(visitId, newStatus) {
			const visit = visits.find(v => v.ID === visitId);
			if (!visit) {
				showToast('×˜×™×¤×•×œ ×œ× × ××¦×', 'error');
				return;
			}
			
			// ×”××¨×ª ×¤×•×¨××˜ ×™×©×Ÿ ×œ×—×“×© ×× × ×“×¨×©
			if (newStatus === 'paid') newStatus = '1';
			if (newStatus === 'unpaid') newStatus = '0';
			if (newStatus === 'no_payment') newStatus = '2';
			if (newStatus === 'partial') newStatus = '3';
			
			// ×× ××¡×× ×™× ×›"×©×•×œ×"
			if (newStatus === '1') {
				const today = new Date();
				const defaultDate = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
				
				const dateInput = prompt('×ª××¨×™×š ×ª×©×œ×•× (DD/MM/YYYY):\n\n×œ×—×¥ OK ×œ×”×™×•×, ××• ×”×–×Ÿ ×ª××¨×™×š ××—×¨:', defaultDate);
				
				if (dateInput === null) return; // User cancelled
				
				let paymentDate;
				
				if (!dateInput || dateInput.trim() === '') {
					paymentDate = today.toISOString().split('T')[0];
				} else {
					const parts = dateInput.trim().split('/');
					if (parts.length !== 3) {
						showToast('×¤×•×¨××˜ ×ª××¨×™×š ×œ× ×ª×§×™×Ÿ. ×”×©×ª××© ×‘: DD/MM/YYYY', 'error');
						return;
					}
					
					const day = parts[0].padStart(2, '0');
					const month = parts[1].padStart(2, '0');
					const year = parts[2];
					
					const dateObj = new Date(`${year}-${month}-${day}`);
					if (isNaN(dateObj.getTime())) {
						showToast('×ª××¨×™×š ×œ× ×ª×§×™×Ÿ', 'error');
						return;
					}
					
					paymentDate = `${year}-${month}-${day}`;
				}
				
				visit.paid = `1:${paymentDate}`;
				
			} else if (newStatus === '3') {
				// ×ª×©×œ×•× ×—×œ×§×™
				const visitAmount = parseFloat(visit.amount) || 0;
				const partialAmount = prompt(`×›××” ×©×•×œ×? (××ª×•×š ${visitAmount}â‚ª)`, '');
				
				if (partialAmount === null) return;
				
				const amount = parseFloat(partialAmount);
				if (isNaN(amount) || amount <= 0) {
					showToast('×¡×›×•× ×œ× ×ª×§×™×Ÿ', 'error');
					return;
				}
				
				if (amount >= visitAmount) {
					// ×©×•×œ× ××œ× - ×¢×‘×•×¨ ×œ×¡×˜×˜×•×¡ "×©×•×œ×"
					const today = new Date().toISOString().split('T')[0];
					visit.paid = `1:${today}`;
				} else {
					visit.paid = `3:${amount}`;
				}
				
			} else if (newStatus === '2') {
				visit.paid = '2';
				
			} else if (newStatus === '0') {
				visit.paid = '0';
			}
			
			// Save locally
			saveToLocalStorage();
			
			// Save to cloud if connected
			if (access_token && SPREADSHEET_ID) {
				const success = await saveAllToSheetsOptimized();
				if (success) {
					showToast('âœ… ×¡×˜×˜×•×¡ ×ª×©×œ×•× ×¢×•×“×›×Ÿ', 'success', 2000);
				} else {
					showToast('âš ï¸ ×¢×•×“×›×Ÿ ××§×•××™×ª ×‘×œ×‘×“', 'warning', 2000);
				}
			} else {
				showToast('ğŸ’¾ ×¢×•×“×›×Ÿ ××§×•××™×ª', 'info', 2000);
			}
			
			// Refresh display
			filterVisits();
		}

		// ××—×™×§×ª ×ª×©×œ×•××™× ×”×§×©×•×¨×™× ×œ×˜×™×¤×•×œ
		function removePaymentsForVisit(visitId) {
			const linksToRemove = paymentVisitLinks.filter(link => link.visit_id === visitId);
			
			linksToRemove.forEach(link => {
				// ×”×¡×¨ ××ª ×”×§×™×©×•×¨
				const linkIndex = paymentVisitLinks.findIndex(l => l.ID === link.ID);
				if (linkIndex > -1) {
					paymentVisitLinks.splice(linkIndex, 1);
				}
				
				// ×‘×“×•×§ ×× ×”×ª×©×œ×•× ×§×©×•×¨ ×œ×˜×™×¤×•×œ×™× × ×•×¡×¤×™×
				const otherLinks = paymentVisitLinks.filter(l => l.payment_id === link.payment_id);
				
				// ×× ××™×Ÿ ×§×™×©×•×¨×™× × ×•×¡×¤×™×, ××—×§ ××ª ×”×ª×©×œ×•×
				if (otherLinks.length === 0) {
					const paymentIndex = payments.findIndex(p => p.ID === link.payment_id);
					if (paymentIndex > -1) {
						payments.splice(paymentIndex, 1);
					}
				}
			});
		}


		// ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×ª×¨×’×•× ×××¦×¢×™ ×ª×©×œ×•×
		function getPaymentMethodText(method) {
			const methods = {
				'cash': '××–×•××Ÿ',
				'check': '×¦\'×§',
				'transfer': '×”×¢×‘×¨×” ×‘× ×§××™×ª',
				'app': '××¤×œ×™×§×¦×™×”'
			};
			return methods[method] || method;
		}

		// ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×”×¦×’×ª ××•×“××œ ×›×œ×œ×™
		function showModal(content) {
			// ×”×¡×¨ ××•×“×œ ×§×™×™× ×× ×™×©
			const existingModal = document.getElementById('telegramModal');
			if (existingModal) {
				existingModal.remove();
			}
			
			// ×¦×•×¨ ××•×“×œ
			const modal = document.createElement('div');
			modal.id = 'telegramModal';
			modal.style.cssText = `
				position: fixed !important;
				top: 0 !important;
				left: 0 !important;
				width: 100% !important;
				height: 100% !important;
				background: rgba(0,0,0,0.7) !important;
				display: flex !important;
				justify-content: center !important;
				align-items: center !important;
				z-index: 9999 !important;
			`;
			
			modal.innerHTML = content;
			document.body.appendChild(modal);
			
			// ×¡×’×™×¨×” ×‘×œ×—×™×¦×” ×¢×œ ×”×¨×§×¢
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					closeAnyModal();
				}
			});
		}

		// ×—×™×¤×•×© ×—×›× ×‘×˜×™×¤×•×œ×™×
		function handleVisitSmartSearch(searchTerm) {
			if (!searchTerm.trim()) {
				// ×× ××™×Ÿ ××•× ×— ×—×™×¤×•×©, ×”×¦×’ ×”×›×œ
				applyVisitFilters();
				return;
			}
			
			// ××¦×™××ª ×œ×§×•×—×•×ª ××ª××™××™×
			const matchingClients = searchClientsAdvanced(searchTerm);
			const clientIds = matchingClients.map(client => client.ID);
			
			if (clientIds.length === 0) {
				displayFilteredVisits([]);
				updateTreatmentsStats([]);
				return;
			}
			
			// ×¡×™× ×•×Ÿ ×”×˜×™×¤×•×œ×™× ×œ×¤×™ ×”×œ×§×•×—×•×ª ×©× ××¦××•
			let filteredVisits = visits.filter(visit => clientIds.includes(visit.location_id));
			
			// ×”×—×œ×ª ×”×¡×™× ×•× ×™× ×”×¨×’×™×œ×™× (×ª××¨×™×›×™×, ×ª×©×œ×•××™×) ×¢×œ ×”×ª×•×¦××•×ª
			filteredVisits = applyAdditionalFiltersToVisits(filteredVisits);
			
			displayFilteredVisits(filteredVisits);
			updateTreatmentsStats(filteredVisits);
		}

		// × ×™×§×•×™ ×—×™×¤×•×© ×—×›×
		function clearVisitSmartSearch() {
			const searchInput = document.getElementById('visitSmartSearch');
			if (searchInput) {
				searchInput.value = '';
			}
			applyVisitFilters();
		}

		// ×¤×•× ×§×¦×™×” ×œh×—×œ×ª ×”×¡×™× ×•× ×™× ×”×¨×’×™×œ×™× ×¢×œ ×§×‘×•×¦×” ××¡×•×™××ª ×©×œ ×‘×™×§×•×¨×™×
		function applyAdditionalFiltersToVisits(visitsArray) {
			let filtered = [...visitsArray];
			
			// ×¡×™× ×•×Ÿ ×œ×¤×™ ×ª×©×œ×•×
			const paymentFilter = document.getElementById('filterPayment')?.value;
			if (paymentFilter) {
				filtered = filtered.filter(visit => {
					const paymentStatus = getVisitPaymentStatus(visit.ID);
					switch(paymentFilter) {
						case '×›×Ÿ': return paymentStatus === 'paid';
						case '×œ×': return paymentStatus === 'unpaid';
						case '×œ×œ×': return paymentStatus === 'no_payment';
						default: return true;
					}
				});
			}
			
			// ×¡×™× ×•×Ÿ ×œ×¤×™ ×ª××¨×™×š
			const dateFrom = document.getElementById('filterDateFrom')?.value;
			const dateTo = document.getElementById('filterDateTo')?.value;
			
			if (dateFrom) {
				filtered = filtered.filter(visit => visit.date >= dateFrom);
			}
			if (dateTo) {
				filtered = filtered.filter(visit => visit.date <= dateTo);
			}
			
			return filtered;
		}

		
		// ×—×™×¤×•×© ×—×›× ×‘×ª×©×œ×•××™×
		function handlePaymentSmartSearch(searchTerm) {
			if (!searchTerm.trim()) {
				applyPaymentFilters();
				return;
			}
			
			// ××¦×™××ª ×œ×§×•×—×•×ª ××ª××™××™×
			const matchingClients = searchClientsAdvanced(searchTerm);
			const clientNames = matchingClients.map(client => client.name);
			
			if (clientNames.length === 0) {
				displayPayments([]);
				updatePaymentsStats([]);
				return;
			}
			
			// ×¡×™× ×•×Ÿ ×”×ª×©×œ×•××™× ×œ×¤×™ ×”×œ×§×•×—×•×ª ×©× ××¦××•
			let filteredPayments = payments.filter(payment => 
				clientNames.some(name => 
					payment.client_name && payment.client_name.includes(name)
				)
			);
			
			// ×”×—×œ×ª ×”×¡×™× ×•× ×™× ×”×¨×’×™×œ×™×
			filteredPayments = applyAdditionalPaymentFilters(filteredPayments);
			
			displayPayments(filteredPayments);
			updatePaymentsStats(filteredPayments);
		}

		// × ×™×§×•×™ ×—×™×¤×•×© ×—×›× ×‘×ª×©×œ×•××™×
		function clearPaymentSmartSearch() {
			const searchInput = document.getElementById('paymentSmartSearch');
			if (searchInput) {
				searchInput.value = '';
			}
			applyPaymentFilters();
		}

		// ×¤×•× ×§×¦×™×” ×œ×”×—×œ×ª ×¡×™× ×•× ×™× × ×•×¡×¤×™× ×¢×œ ×ª×©×œ×•××™×
		function applyAdditionalPaymentFilters(paymentsArray) {
			let filtered = [...paymentsArray];
			
			// ×¡×™× ×•×Ÿ ×œ×¤×™ ×ª××¨×™×š
			const dateFrom = document.getElementById('filterPaymentDateFrom')?.value;
			const dateTo = document.getElementById('filterPaymentDateTo')?.value;
			
			if (dateFrom) {
				filtered = filtered.filter(p => p.date >= dateFrom);
			}
			if (dateTo) {
				filtered = filtered.filter(p => p.date <= dateTo);
			}
			
			return filtered;
		}

		// Add new function for clearing debt filters:
		function clearDebtFilters() {
			const sortBy = document.getElementById('debtSortBy');
			const minAmount = document.getElementById('minDebtAmount');
			const dayFilter = document.getElementById('debtDayFilter');
			const clientSearch = document.getElementById('debtClientSearch');
			
			if (sortBy) sortBy.value = 'amount_desc';
			if (minAmount) minAmount.value = '';
			if (dayFilter) dayFilter.value = '';
			if (clientSearch) {
				clientSearch.value = '';
				clientSearch.removeAttribute('data-selected-id');
			}
			
			displayDebts();
		}

		// Smart search for receipts
		function handleReceiptSmartSearch(searchTerm) {
			if (!searchTerm.trim()) {
				applyReceiptFilters();
				return;
			}
			
			// Find matching clients
			const matchingClients = searchClientsAdvanced(searchTerm);
			const clientNames = matchingClients.map(client => client.name);
			
			if (clientNames.length === 0) {
				displayFilteredReceipts([]);
				updateReceiptsStats([]);
				return;
			}
			
			// Filter receipts by found clients
			let filteredReceipts = receipts.filter(receipt => 
				clientNames.some(name => 
					receipt.location_name && receipt.location_name.includes(name)
				)
			);
			
			// Apply additional filters
			filteredReceipts = applyAdditionalReceiptFilters(filteredReceipts);
			
			displayFilteredReceipts(filteredReceipts);
			updateReceiptsStats(filteredReceipts);
		}

		// Clear smart search for receipts
		function clearReceiptSmartSearch() {
			document.getElementById('receiptSmartSearch').value = '';
			applyReceiptFilters();
		}

		// Apply additional receipt filters
		function applyAdditionalReceiptFilters(receiptsArray) {
			let filtered = [...receiptsArray];
			
			// Filter by book
			const bookFilter = document.getElementById('filterReceiptBook')?.value;
			if (bookFilter) {
				filtered = filtered.filter(r => r.book_number === bookFilter);
			}
			
			// Filter by payment type
			const paymentFilter = document.getElementById('filterPaymentType')?.value;
			if (paymentFilter) {
				filtered = filtered.filter(r => r.payment_type === paymentFilter);
			}
			
			// Filter by date range
			const dateFrom = document.getElementById('filterReceiptDateFrom')?.value;
			const dateTo = document.getElementById('filterReceiptDateTo')?.value;
			
			if (dateFrom) {
				filtered = filtered.filter(r => r.date >= dateFrom);
			}
			if (dateTo) {
				filtered = filtered.filter(r => r.date <= dateTo);
			}
			
			return filtered;
		}


		// Add this helper function at the top of your script:
		function safeSetHTML(elementId, html) {
			const element = document.getElementById(elementId);
			if (element) {
				element.innerHTML = html;
				return true;
			}
			return false;
		}

		function safeSetValue(elementId, value) {
			const element = document.getElementById(elementId);
			if (element) {
				element.value = value;
				return true;
			}
			return false;
		} 


		document.addEventListener('DOMContentLoaded', function() {
			console.log('App starting...');
			
			// Initialize Google APIs first
			initializeGoogleAPIs();
			
			// Initialize data from local storage
			loadFromLocalStorage();
			
			// Set default section
			showSection('planning');
			
			// Initialize cost settings if they exist
			if (costSettings.hourlyRate) {
				const hourlyRateEl = document.getElementById('hourlyRate');
				if (hourlyRateEl) hourlyRateEl.value = costSettings.hourlyRate;
			}
			
			// Auto-connect to Google Sheets if credentials exist
			if (localStorage.getItem('google_access_token')) {
				setTimeout(() => {
					if (typeof connectToGoogleSheets === 'function') {
						connectToGoogleSheets();
					}
				}, 1000);
			}
			
			console.log('App initialization complete');
		});

	
		
		async function validateToken() {
			if (!access_token || !gapi.client) {
				updateCloudStatus('ğŸ” ×œ× ××—×•×‘×¨ ×œ×¢× ×Ÿ', '× ×•×ª×§');
				return false;
			}

			try {
				// ×‘×“×™×§×” ×¤×©×•×˜×” - × ×¡×” ×œ×§×¨×•× ××”×˜×‘×œ×”
				await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID || 'test'
				});
				return true;
			} catch (error) {
				if (error.status === 401) {
					console.log('Google token expired');
					access_token = null;
					updateCloudStatus('ğŸ” × ×“×¨×© ×—×™×‘×•×¨ ××—×“×©', '× ×•×ª×§');
					document.getElementById('statusText').classList.remove('connected');
					document.getElementById('saveBtn').disabled = true;
					document.getElementById('loadBtn').disabled = true;
					showToast('âš ï¸ ×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×”×ª×—×‘×¨ ××—×“×©', 'warning');
					return false;
				}
				updateCloudStatus('âš ï¸ ×‘×¢×™×™×ª ×—×™×‘×•×¨ ×œ×¢× ×Ÿ', '×©×’×™××”');
				return false;
			}
		}
		
		
		function updateCloudStatus(status, lastAction) {
			const statusElement = document.getElementById('statusText');
			const lastSavedElement = document.getElementById('lastSaved');
			
			if (statusElement) {
				statusElement.textContent = status;
				
				// ×¢×“×›×•×Ÿ ×¦×‘×¢×™× ×œ×¤×™ ×¡×˜×˜×•×¡
				if (status.includes('××—×•×‘×¨') || status.includes('××¡×•× ×›×¨×Ÿ')) {
					statusElement.style.color = '#28a745'; // ×™×¨×•×§
					statusElement.style.fontWeight = 'bold';
					statusElement.style.background = 'transparent'; // ×”×¡×¨ ×¨×§×¢
					statusElement.classList.add('connected');
				} else if (status.includes('×©×•××¨') || status.includes('××¢×“×›×Ÿ')) {
					statusElement.style.color = '#ffc107'; // ×¦×”×•×‘
					statusElement.style.fontWeight = 'bold';
				} else if (status.includes('×©×’×™××”')) {
					statusElement.style.color = '#dc3545'; // ××“×•×
					statusElement.style.fontWeight = 'bold';
					statusElement.classList.remove('connected');
				} else if (status.includes('× ×“×¨×© ×—×™×‘×•×¨')) {
					statusElement.style.color = '#fd7e14'; // ×›×ª×•×
					statusElement.style.fontWeight = 'bold';
					statusElement.classList.remove('connected');
				}
			}
			
			// ×¢×“×›×•×Ÿ ×–××Ÿ ×¤×¢×•×œ×” ××—×¨×•× ×”
			if (lastSavedElement && lastAction) {
				lastSavedElement.textContent = `${lastAction}: ${new Date().toLocaleTimeString('he-IL')}`;
				//lastSavedElement.style.color = //'#333'; // ×¦×‘×¢ ×›×”×” ×™×•×ª×¨
			}
		}
		
		
		// Add this function for the "proceed to payment details" button
		function proceedToPaymentDetails() {
			// ×‘×“×™×§×” ×©× ×‘×—×¨×• ×˜×™×¤×•×œ×™×
			if (selectedVisitIds.length === 0) {
				showToast('×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×˜×™×¤×•×œ ××—×“', 'error');
				return;
			}
			
			// ××¢×‘×¨ ×œ×©×œ×‘ ×”×‘×
			document.getElementById('visitsSelectionSection').style.display = 'none';
			document.getElementById('paymentDetailsSection').style.display = 'block';
			
			// ××¤×©×¨ ××ª ×›×¤×ª×•×¨ ×”×©××™×¨×”
			document.getElementById('savePaymentBtn').disabled = false;
			
			// ×¢×“×›×•×Ÿ ×”×›×•×ª×¨×ª
			const totalAmount = selectedVisitIds.reduce((sum, visitId) => {
				const visit = visits.find(v => v.ID === visitId);
				return sum + (parseFloat(visit?.amount) || 0);
			}, 0);
			
			document.getElementById('paymentModalTitle').textContent = 
				`ğŸ’° ×ª×©×œ×•× ${totalAmount}â‚ª ×¢×‘×•×¨: ${selectedClient.name}`;
		}


		// Add event listeners to checkboxes when creating visit items
		function loadClientVisitsForPayment(clientId) {
			const clientVisits = visits.filter(visit => 
				visit.location_id === clientId && 
				getVisitPaymentStatus(visit.ID) !== 'paid'
			);
			
			if (clientVisits.length === 0) {
				document.getElementById('visitsList').innerHTML = 
					'<div style="text-align: center; padding: 20px; color: #666;">××™×Ÿ ×˜×™×¤×•×œ×™× ×¤×ª×•×—×™× ×œ×œ×§×•×— ×–×”</div>';
				return;
			}
			
			const visitsHtml = clientVisits.map(visit => {
				const isPreSelected = selectedVisitIds.includes(visit.ID);
				return `
					<div class="visit-item">
						<input type="checkbox" 
							   class="visit-checkbox" 
							   id="visit_${visit.ID}" 
							   value="${visit.ID}"
							   ${isPreSelected ? 'checked' : ''}
							   onchange="updateSelectedVisitsCount()">
						<div class="visit-details">
							<div style="font-weight: bold;">${formatDate(visit.date)}</div>
							<div style="font-size: 12px; color: #666;">${visit.work_done || '×œ×œ× ×ª×™××•×¨'}</div>
						</div>
						<div class="visit-amount">${visit.amount || 0}â‚ª</div>
					</div>
				`;
			}).join('');
			
			document.getElementById('visitsList').innerHTML = visitsHtml;
			
			// ×¢×“×›×•×Ÿ ×¡×¤×™×¨×” ×¨××©×•× ×™×ª
			updateSelectedVisitsCount();
		}


		// Add this debug function to test if the dates update system works
		function testTreatmentDatesUpdate() {
			console.log('ğŸ§ª Testing treatment dates update system...');
			
			// ×‘×“×•×§ ×›××” ×œ×§×•×—×•×ª ×™×©
			console.log(`Total locations: ${locations.length}`);
			console.log(`Total visits: ${visits.length}`);
			
			// ××¦× ×œ×§×•×— ×¢× ×‘×™×§×•×¨×™×
			const locationsWithVisits = locations.filter(loc => {
				const hasVisits = visits.some(visit => visit.location_id === loc.ID);
				return hasVisits;
			});
			
			console.log(`Locations with visits: ${locationsWithVisits.length}`);
			
			// ×”×¦×’ ×“×•×’×××•×ª
			locationsWithVisits.slice(0, 3).forEach(location => {
				const clientVisits = visits.filter(v => v.location_id === location.ID);
				const latestVisit = clientVisits.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
				
				console.log(`ğŸ‘¤ ${location.name}:`);
				console.log(`   Last visit in system: ${location.last_visit}`);
				console.log(`   Next visit in system: ${location.next_visit}`);
				console.log(`   Latest actual visit: ${latestVisit ? latestVisit.date : 'none'}`);
				console.log(`   Interval weeks: ${location.interval_weeks || 4}`);
			});
			
			console.log('ğŸ§ª Test complete - check console output above');
		}


		// Load and display today's treatments in the work day section
		function loadTodayTreatments() {
			const today = new Date().toISOString().split('T')[0];
			const todayVisits = visits.filter(visit => visit.date === today)
				.sort((a, b) => {
					const timeA = a.start_time || '23:59';
					const timeB = b.start_time || '23:59';
					return timeA.localeCompare(timeB);
				});
			
			const container = document.getElementById('todayTreatmentsContainer');
			const statusElement = document.getElementById('todayWorkStatus');
			
			if (todayVisits.length === 0) {
				container.innerHTML = `
					<div style="text-align: center; padding: 15px; color: #666; font-style: italic;">
						×¢×“×™×™×Ÿ ×œ× ×”×ª×—×œ×ª ×˜×™×¤×•×œ×™× ×”×™×•× ğŸŒ…
					</div>
				`;
				statusElement.textContent = '';
				return;
			}
			
			// âœ… NEW: Separate in-progress from completed
			const inProgressVisits = todayVisits.filter(v => v.start_time && !v.end_time);
			const completedVisits = todayVisits.filter(v => v.end_time);
			const notStartedVisits = todayVisits.filter(v => !v.start_time);
			
			// Update status summary
			const totalIncome = todayVisits.reduce((sum, v) => sum + parseFloat(v.amount || 0), 0);
			statusElement.textContent = `(${completedVisits.length}/${todayVisits.length} ×”×¡×ª×™×™××• â€¢ â‚ª${totalIncome} ×¡×”"×›)`;
			
			// Generate treatments HTML
			let html = '';
			
			// âœ… Show in-progress treatments first
			if (inProgressVisits.length > 0) {
				html += `<div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
					<h4 style="margin: 0 0 10px 0; color: #856404;">ğŸ”„ ×‘×ª×”×œ×™×š ×¢×›×©×™×•</h4>`;
				
				html += inProgressVisits.map(visit => {
					const client = locations.find(loc => loc.ID === visit.location_id);
					const clientName = visit.location_name || client?.name || '×œ×§×•×— ×œ× ××–×•×”×”';
					const startTime = visit.start_time || '--:--';
					const workDone = visit.work_done || '×œ×œ× ×ª×™××•×¨';
					
					return `
						<div style="background: white; padding: 10px; border-radius: 5px; margin-bottom: 8px; border-left: 4px solid #ffc107;">
							<div style="display: flex; justify-content: space-between; align-items: center;">
								<div style="flex: 1;">
									<div style="font-weight: bold; color: #2c3e50;">${clientName}</div>
									<div style="font-size: 12px; color: #666;">${workDone}</div>
									<div style="font-size: 11px; color: #856404; margin-top: 3px;">â±ï¸ ×”×ª×—×œ×”: ${startTime}</div>
								</div>
								<button onclick="editVisit('${visit.ID}')" 
										style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">
									âœ… ×¡×™×™× ×˜×™×¤×•×œ
								</button>
							</div>
						</div>
					`;
				}).join('');
				
				html += `</div>`;
			}
			
			// Show completed treatments
			if (completedVisits.length > 0) {
				html += `<div style="margin-bottom: 10px;">
					<h4 style="margin: 0 0 10px 0; color: #27ae60;">âœ… ×”×•×©×œ××• ×”×™×•×</h4>`;
				
				html += completedVisits.map(visit => {
					const client = locations.find(loc => loc.ID === visit.location_id);
					const clientName = visit.location_name || client?.name || '×œ×§×•×— ×œ× ××–×•×”×”';
					const startTime = visit.start_time || '--:--';
					const endTime = visit.end_time || '--:--';
					const amount = visit.amount || 0;
					const workDone = visit.work_done || '×œ×œ× ×ª×™××•×¨';
					
					return `
						<div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 8px; opacity: 0.8;">
							<div style="display: flex; justify-content: space-between;">
								<div style="flex: 1;">
									<div style="font-weight: bold; color: #2c3e50;">${clientName}</div>
									<div style="font-size: 12px; color: #666;">${workDone}</div>
									<div style="font-size: 11px; color: #666; margin-top: 3px;">
										${startTime} â†’ ${endTime}
									</div>
								</div>
								<div style="text-align: left; color: #27ae60; font-weight: bold;">
									${amount}â‚ª
								</div>
							</div>
						</div>
					`;
				}).join('');
				
				html += `</div>`;
			}
			
			// Show not started treatments
			if (notStartedVisits.length > 0) {
				html += `<div>
					<h4 style="margin: 0 0 10px 0; color: #666;">ğŸ“‹ ××ª×•×›× × ×™×</h4>`;
				
				html += notStartedVisits.map(visit => {
					const client = locations.find(loc => loc.ID === visit.location_id);
					const clientName = visit.location_name || client?.name || '×œ×§×•×— ×œ× ××–×•×”×”';
					
					return `
						<div style="background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 8px;">
							<div style="font-weight: bold; color: #495057;">${clientName}</div>
							<button onclick="editVisit('${visit.ID}')" 
									style="margin-top: 5px; padding: 6px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
								â–¶ï¸ ×”×ª×—×œ ×˜×™×¤×•×œ
							</button>
						</div>
					`;
				}).join('');
				
				html += `</div>`;
			}
			
			container.innerHTML = html;
		}

		// Refresh today's treatments - called by refresh button
		function refreshTodayTreatments() {
			loadTodayTreatments();
			showToast('×”×˜×™×¤×•×œ×™× ×©×œ ×”×™×•× ×¢×•×“×›× ×•', 'success', 1500);
		}

		// Add to the existing loadPlanningData function - call loadTodayTreatments() at the end
		// You need to add this line: loadTodayTreatments(); 
		// to the end of the loadPlanningData() function
		
		
		function updateLocationNotes(locationId, newNotes) {
			const location = locations.find(loc => loc.ID === locationId);
			if (location) {
				location.notes = newNotes;
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(location);
				}
			}
		}

		// Load client options for debts filter
		function loadDebtClientOptions() {
			const datalist = document.getElementById('debtClientOptions');
			if (!datalist) return;
			
			// Get clients with debts
			const clientsWithDebts = new Set();
			visits.forEach(visit => {
				if (visit.amount > 0) {
					const visitAmount = parseFloat(visit.amount) || 0;
					const paidAmount = getVisitPaidAmount(visit.ID);
					const debt = visitAmount - paidAmount;
					if (debt > 0) {
						clientsWithDebts.add(visit.location_id);
					}
				}
			});
			
			// Populate datalist
			datalist.innerHTML = '';
			locations
				.filter(loc => clientsWithDebts.has(loc.ID))
				.sort((a, b) => a.name.localeCompare(b.name, 'he'))
				.forEach(client => {
					const option = document.createElement('option');
					option.value = client.name;
					option.setAttribute('data-client-id', client.ID);
					datalist.appendChild(option);
				});
		}

		// Handle client selection
		function handleDebtClientSelection(clientName) {
			const option = document.querySelector(`#debtClientOptions option[value="${clientName}"]`);
			const clientId = option ? option.getAttribute('data-client-id') : '';
			
			// Store selected client ID for filtering
			document.getElementById('debtClientSearch').setAttribute('data-selected-id', clientId);
			
			// Apply filter
			displayDebts();
		}

		// Clear client search
		function clearDebtClientSearch() {
			const searchInput = document.getElementById('debtClientSearch');
			searchInput.value = '';
			searchInput.removeAttribute('data-selected-id');
			displayDebts();
		}

		// Filter client options as user types (optional enhancement)
		function filterDebtClientOptions(searchTerm) {
			// This function can be enhanced later if needed
			// For now, the datalist handles filtering automatically
		}


		
		// Global client lock system
		let isClientLocked = false;
		let lockedClientId = null;
		let lockedClientName = '';

		function toggleClientLock() {
			const lockBtn = document.getElementById('lockBtn');
			const clientSelector = document.getElementById('lockClientSelector');
			
			if (isClientLocked) {
				// Unlock - release all tabs and hide client selector
				isClientLocked = false;
				lockedClientId = null;
				lockedClientName = '';
				
				lockBtn.textContent = 'ğŸ”“';
				lockBtn.classList.remove('locked');
				lockBtn.title = '× ×¢×™×œ×ª ×¡×™× ×›×¨×•×Ÿ ×œ×§×•×—×•×ª';
				
				// Hide client selector
				clientSelector.style.display = 'none';
				clientSelector.value = '';
				
				showToast('× ×¢×™×œ×” ×©×•×—×¨×¨×” - ×›×œ ×”×˜××‘×™× ×¢×¦×××™×™×', 'info', 2000);
			} else {
				// Lock - show client selector
				isClientLocked = true;
				
				lockBtn.textContent = 'ğŸ”’';
				lockBtn.classList.add('locked');
				lockBtn.title = '××©×—×¨×¨ × ×¢×™×œ×”';
				
				// Show and populate client selector
				clientSelector.style.display = 'inline-block';
				clientSelector.innerHTML = `
					<option value="">×‘×—×¨ ×œ×§×•×—...</option>
					${locations.filter(loc => loc.active === '1').sort((a, b) => a.name.localeCompare(b.name, 'he')).map(client => 
						`<option value="${client.ID}">${client.name}</option>`
					).join('')}
				`;
				
				showToast('× ×¢×™×œ×” ×¤×¢×™×œ×” - ×‘×—×¨ ×œ×§×•×— ××”×¨×©×™××”', 'info', 3000);
			}
		}

		function selectClientForLock(clientId) {
			if (!clientId || !isClientLocked) return;
			
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			lockedClientId = clientId;
			lockedClientName = client.name;
			
			// Apply client to all tabs
			syncAllTabsToClient(clientId, client.name);
			
			showToast(`×›×œ ×”×˜××‘×™× ××¡×•× ×›×¨× ×™× ×œ: ${client.name}`, 'success', 3000);
		}

		function syncAllTabsToClient(clientId, clientName) {
			// Sync visits/history tab
			const visitSearch = document.getElementById('visitSmartSearch');
			if (visitSearch) {
				visitSearch.value = clientName;
				if (typeof handleVisitSmartSearch === 'function') {
					handleVisitSmartSearch(clientName);
				}
			}
			
			// Sync debts tab
			const debtSearch = document.getElementById('debtClientSearch');
			if (debtSearch) {
				debtSearch.value = clientName;
				debtSearch.setAttribute('data-selected-id', clientId);
				if (typeof displayDebts === 'function') {
					displayDebts();
				}
			}
			
			// Sync payments tab
			const paymentSearch = document.getElementById('paymentSmartSearch');
			if (paymentSearch) {
				paymentSearch.value = clientName;
				if (typeof handlePaymentSmartSearch === 'function') {
					handlePaymentSmartSearch(clientName);
				}
			}
			
			// Fix receipts tab - use the smart search
			const receiptSearch = document.getElementById('receiptSmartSearch');
			if (receiptSearch) {
				receiptSearch.value = clientName;
				if (typeof handleReceiptSmartSearch === 'function') {
					handleReceiptSmartSearch(clientName);
				}
			}
			
			// For locations tab - filter the table directly
			if (typeof filterLocationsTable === 'function') {
				const nameFilter = document.getElementById('filterClientName');
				if (nameFilter) {
					nameFilter.value = clientName;
					filterLocationsTable();
				}
			}
		}

		// âœ… TEMPORARY: Placeholder for future CSV import feature
		function handleImportFile(event) {
			showToast('âš ï¸ ×ª×›×•× ×” ×–×• ×‘×¤×™×ª×•×— - ×‘×™× ×ª×™×™× ×”×©×ª××© ×‘×™×™×‘×•× ×“×¨×š ×˜×‘×œ×ª ×”×¢×–×¨', 'info', 3000);
			event.target.value = ''; // Reset file input
		}

		function closeAnyModal() {
			// List of all possible modal IDs
			const modalIds = ['editModal', 'telegramModal', 'clientModal', 'addTreatmentModal'];
			
			// Try to close by ID
			for (const id of modalIds) {
				const modal = document.getElementById(id);
				if (modal) {
					modal.remove();
					console.log(`âœ… Closed modal: ${id}`);
					return true;
				}
			}
			
			// Fallback: find and remove any modal-like element
			const modalElements = document.querySelectorAll('[style*="position: fixed"][style*="background"]');
			if (modalElements.length > 0) {
				modalElements.forEach(el => el.remove());
				console.log(`âœ… Closed ${modalElements.length} modal(s) by style`);
				return true;
			}
			
			console.warn('âš ï¸ No modal found to close');
			return false;
		}


   </script>
</body>
</html>
