<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×˜×™×¤×•×œ×™× ×•×œ×§×•×—×•×ª</title>
	
	<script src="https://apis.google.com/js/api.js"></script>
	<script src="https://accounts.google.com/gsi/client"></script>
	
    <style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			direction: rtl;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}

		/* Header ××¢×•×¦×‘ */
		.header {
			background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
			border-radius: 15px;
			padding: 30px;
			margin-bottom: 20px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.3);
			color: white;
		}

		.header h1 {
			font-size: 2.5em;
			margin-bottom: 10px;
			text-align: center;
			text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
			background: linear-gradient(45deg, #3498db, #2ecc71);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}

		/* Connection Status ××¢×•×¦×‘ */
		.connection-status {
			text-align: center;
			margin: 20px 0;
			padding: 20px;
			background: rgba(255,255,255,0.1);
			border-radius: 15px;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255,255,255,0.2);
		}

		.connect-btn {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 12px 24px;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			margin: 5px;
			transition: all 0.3s ease;
			box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
		}

		.connect-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
		}

		.connect-btn:disabled {
			background: #95a5a6;
			cursor: not-allowed;
			transform: none;
		}

		/* Navigation ××¢×•×¦×‘ */
		.nav-buttons {
			display: flex;
			gap: 15px;
			justify-content: center;
			flex-wrap: wrap;
			margin-top: 20px;
		}

		.nav-btn {
			padding: 15px 25px;
			border: none;
			background: rgba(255,255,255,0.1);
			color: white;
			border-radius: 10px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255,255,255,0.2);
		}

		.nav-btn:hover {
			background: rgba(255,255,255,0.2);
			transform: translateY(-2px);
		}

		.nav-btn.active {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
			transform: translateY(-2px);
		}

		/* Main Content ××¢×•×¦×‘ */
		.main-content {
			background: rgba(255,255,255,0.95);
			border-radius: 15px;
			padding: 30px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.2);
			backdrop-filter: blur(10px);
		}

		.section {
			display: none;
		}

		.section.active {
			display: block;
		}

		.section h2 {
			color: #2c3e50;
			margin-bottom: 30px;
			padding-bottom: 15px;
			border-bottom: 3px solid #3498db;
			font-size: 1.8em;
			position: relative;
		}

		.section h2::before {
			content: '';
			position: absolute;
			bottom: -3px;
			left: 0;
			width: 60px;
			height: 3px;
			background: linear-gradient(45deg, #e74c3c, #f39c12);
			border-radius: 2px;
		}

		/* Forms ××¢×•×¦×‘×™× */
		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			margin-bottom: 8px;
			color: #2c3e50;
			font-weight: bold;
			font-size: 14px;
		}

		.form-group input, .form-group select, .form-group textarea {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #e9ecef;
			border-radius: 8px;
			font-size: 14px;
			transition: all 0.3s ease;
			background: white;
		}

		.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
			transform: translateY(-1px);
		}

		/* Buttons ××¢×•×¦×‘×™× */
		.add-btn {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
			border: none;
			padding: 15px 30px;
			border-radius: 10px;
			cursor: pointer;
			margin-bottom: 20px;
			font-size: 16px;
			font-weight: bold;
			transition: all 0.3s ease;
			box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
		}

		.add-btn:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
		}

		.action-btn {
			padding: 8px 16px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 12px;
			margin: 0 3px;
			transition: all 0.3s ease;
			font-weight: bold;
		}

		.edit-btn {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
		}

		.edit-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
		}

		.delete-btn {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			color: white;
		}

		.delete-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
		}

		/* Tables ××¢×•×¦×‘×•×ª */
		.table-container {
			background: white;
			border-radius: 12px;
			overflow: hidden;
			box-shadow: 0 8px 25px rgba(0,0,0,0.15);
			margin-top: 20px;
		}

		.data-table {
			width: 100%;
			border-collapse: collapse;
			background: white;
		}

		.data-table thead {
			background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
			color: white;
		}

		.data-table th {
			padding: 15px 12px;
			text-align: right;
			font-weight: bold;
			border-bottom: 2px solid #3498db;
		}

		.data-table td {
			padding: 12px;
			border-bottom: 1px solid #ecf0f1;
			transition: background 0.3s ease;
		}

		.data-table tbody tr:hover {
			background: #f8f9fa;
			transform: scale(1.01);
		}

		.data-table tbody tr:nth-child(even) {
			background: #fbfcfd;
		}

		/* Filter Panels ××¢×•×¦×‘×™× */
		.filter-panel, .info-panel {
			background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%);
			border: 2px solid #95a5a6;
			border-radius: 12px;
			margin-bottom: 20px;
			overflow: hidden;
			box-shadow: 0 5px 15px rgba(0,0,0,0.1);
		}

		.filter-header, .info-header {
			background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
			padding: 15px 20px;
			cursor: pointer;
			color: white;
			transition: all 0.3s ease;
			border-bottom: 2px solid #3498db;
		}

		.filter-header:hover, .info-header:hover {
			background: linear-gradient(135deg, #4a6741 0%, #2c3e50 100%);
		}

		.filter-content, .info-content {
			padding: 25px;
			display: block;
			background: white;
		}

		.filter-content.collapsed, .info-content.collapsed {
			display: none;
		}

		/* Submit Button ××¢×•×¦×‘ */
		button[type="submit"] {
			width: 100%;
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 18px;
			border-radius: 10px;
			cursor: pointer;
			font-size: 18px;
			font-weight: bold;
			margin-top: 20px;
			transition: all 0.3s ease;
			box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
		}

		button[type="submit"]:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
		}

		/* Mobile Responsive */
		@media (max-width: 768px) {
			.container {
				padding: 10px;
			}
			
			.header {
				padding: 20px 15px;
			}
			
			.header h1 {
				font-size: 1.8em;
			}
			
			.nav-buttons {
				gap: 8px;
			}
			
			.nav-btn {
				padding: 12px 16px;
				font-size: 12px;
			}
			
			.main-content {
				padding: 20px 15px;
			}
		}

		/* Toast Notifications */
		.toast-container {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 1000;
			max-width: 300px;
		}

		.toast {
			background: linear-gradient(45deg, #2c3e50, #3498db);
			color: white;
			padding: 15px 20px;
			border-radius: 8px;
			margin-bottom: 10px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
			transform: translateX(400px);
			opacity: 0;
			transition: all 0.3s ease;
			border-right: 4px solid #27ae60;
			font-weight: bold;
		}

		.toast.success {
			border-right-color: #27ae60;
			background: linear-gradient(45deg, #27ae60, #2ecc71);
		}

		.toast.error {
			border-right-color: #e74c3c;
			background: linear-gradient(45deg, #e74c3c, #c0392b);
		}

		.toast.warning {
			border-right-color: #f39c12;
			background: linear-gradient(45deg, #f39c12, #e67e22);
		}

		.toast.show {
			transform: translateX(0);
			opacity: 1;
		}
		

		/* ×›×¤×ª×•×¨×™× ×›×œ×œ×™×™× */
		.btn {
			padding: 12px 20px;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			box-shadow: 0 3px 10px rgba(0,0,0,0.2);
			min-width: 120px;
		}

		.btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(0,0,0,0.3);
		}

		.btn-primary {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
		}

		.btn-success {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
		}

		.btn-warning {
			background: linear-gradient(45deg, #f39c12, #e67e22);
			color: white;
		}

		.btn-secondary {
			background: linear-gradient(45deg, #95a5a6, #7f8c8d);
			color: white;
		}

		.btn-info {
			background: linear-gradient(45deg, #17a2b8, #138496);
			color: white;
		}

		/* ×›×¤×ª×•×¨×™ ×¤×™×œ×˜×¨ */
		.filter-btn {
			padding: 10px 18px;
			border: 2px solid #3498db;
			background: linear-gradient(45deg, #ecf0f1, #bdc3c7);
			color: #2c3e50;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			min-width: 100px;
		}

		.filter-btn:hover {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
		}

		.filter-btn.active {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
		}

		/* ×›×¤×ª×•×¨×™ ×˜×™×™××¨ */
		.timer-buttons button {
			padding: 12px 25px;
			border: none;
			border-radius: 10px;
			cursor: pointer;
			font-size: 16px;
			font-weight: bold;
			transition: all 0.3s ease;
			min-width: 140px;
			box-shadow: 0 4px 12px rgba(0,0,0,0.2);
		}

		#startBtn {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
		}

		#startBtn:hover:not(:disabled) {
			transform: translateY(-3px);
			box-shadow: 0 6px 18px rgba(39, 174, 96, 0.4);
		}

		#pauseBtn {
			background: linear-gradient(45deg, #f39c12, #e67e22);
			color: white;
		}

		#pauseBtn:hover:not(:disabled) {
			transform: translateY(-3px);
			box-shadow: 0 6px 18px rgba(243, 156, 18, 0.4);
		}

		#stopBtn {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			color: white;
		}

		#stopBtn:hover:not(:disabled) {
			transform: translateY(-3px);
			box-shadow: 0 6px 18px rgba(231, 76, 60, 0.4);
		}

		/* ×¨×©×™××•×ª × ×¤×ª×—×•×ª */
		select, .form-group select {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			cursor: pointer;
			min-height: 45px;
		}

		select:focus, .form-group select:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		select:hover {
			border-color: #7f8c8d;
			background: white;
		}

		/* ×©×“×•×ª ×ª××¨×™×š */
		input[type="date"] {
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			min-height: 45px;
		}

		input[type="date"]:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		/* ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×•×ª ×¤×™×œ×˜×¨ */
		.filter-actions .btn {
			margin: 5px 8px;
			padding: 10px 20px;
			font-size: 14px;
			min-width: 100px;
		}

		/* ×›×¤×ª×•×¨×™ ×™×™×‘×•× ×‘××¢×¨×›×ª */
		.form-section .btn {
			margin: 8px 5px;
			padding: 12px 20px;
			font-size: 14px;
			font-weight: bold;
			min-width: 150px;
		}

		/* ×ª×™×§×•×Ÿ ×œ×›×¤×ª×•×¨×™× ×‘×’×¨×™×“ */
		.nav-buttons .nav-btn,
		.filter-buttons .filter-btn,
		.timer-buttons button,
		.filter-actions .btn {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			letter-spacing: 0.5px;
		}

		/* ×©×™×¤×•×¨ × ×•×¡×£ ×œ×›×¤×ª×•×¨×™× ×§×˜× ×™× */
		.action-btn {
			padding: 10px 16px;
			font-size: 13px;
			font-weight: bold;
			min-width: 80px;
		}

		/* ×›×¤×ª×•×¨×™× ××•×§×¤×¦×™× (disabled) */
		button:disabled, .btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none !important;
			box-shadow: none !important;
		}

		/* ×©×™×¤×•×¨ ×œ×ª×™×‘×•×ª ×˜×§×¡×˜ */
		input[type="text"], input[type="number"], textarea {
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			min-height: 45px;
		}

		input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		/* ×©×™×¤×•×¨ ×œ×›×•×ª×¨×•×ª ×‘×¤×× ×œ×™× */
		.filter-header h3, .info-header h3 {
			font-size: 16px;
			font-weight: bold;
			margin: 0;
			text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
		}

		/* ××•×‘×™×™×œ - ×”×ª×××•×ª */
		@media (max-width: 768px) {
			.btn {
				padding: 10px 15px;
				font-size: 13px;
				min-width: 100px;
			}
			
			.timer-buttons button {
				padding: 10px 18px;
				font-size: 14px;
				min-width: 110px;
			}
			
			select, input[type="date"], input[type="text"], input[type="number"] {
				padding: 10px 12px;
				font-size: 13px;
				min-height: 40px;
			}
		}
		
	</style>
   
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>×˜×™×¤×•×œ×™×</h1>
			<div id="connectionStatus" class="connection-status">
				<button onclick="connectToGoogleSheets()" id="connectBtn" class="connect-btn">
					×”×ª×—×‘×¨ ×œ-Google Sheets
				</button>
				<button onclick="saveAllToSheets()" id="saveBtn" class="connect-btn" disabled>
					×©××•×¨ ×œ×¢× ×Ÿ
				</button>
				<button onclick="loadAllFromSheets()" id="loadBtn" class="connect-btn" disabled>
					×˜×¢×Ÿ ××”×¢× ×Ÿ
				</button>
				<span id="statusText">×œ× ××—×•×‘×¨</span>
			</div>
            <nav class="nav-buttons">
				<button onclick="showSection('planning')" class="nav-btn active">×ª×›× ×•×Ÿ ×™×•××™</button>
				<button onclick="showSection('visit')" class="nav-btn">×˜×™×¤×•×œ ×—×“×©</button>
				<button onclick="showSection('history')" class="nav-btn">×˜×™×¤×•×œ×™×</button> 
				<button onclick="showSection('locations')" class="nav-btn">×œ×§×•×—×•×ª</button>
				<button onclick="showSection('receipts')" class="nav-btn">×§×‘×œ×•×ª</button>
				<button onclick="showSection('system')" class="nav-btn">××¢×¨×›×ª v2.3</button>
			</nav>
        </header>

        <main class="main-content">
            <!-- Planning Section -->
            <section id="planning" class="section active">
                <h2>×ª×›× ×•×Ÿ ×™×•××™ - ×’×™× ×•×ª ×œ×˜×™×¤×•×œ</h2>
                <div class="filter-buttons">
					<button onclick="filterVisits('today')" class="filter-btn active">×”×™×•×</button>
					<button onclick="filterVisits('week')" class="filter-btn">×”×©×‘×•×¢</button>
					<button onclick="filterVisits('overdue')" class="filter-btn">×××—×¨×•×ª</button>
				</div>
                <div class="table-container">
                    <table id="planningTable" class="data-table">
                        <thead>
                            <tr>
                                <th>×©× ×’×™× ×”</th>
                                <th>×›×ª×•×‘×ª</th>
                                <th>×™×•× ××•×ª×¨</th>
                                <th>×˜×™×¤×•×œ ×”×‘×</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="planningTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- VisitSection -->
            <section id="visit" class="section">
                <h2>×˜×™×¤×•×œ ×—×“×©</h2>
                <div class="form-container">
                    <form id="visitForm">
                        <div class="form-group">
                            <label for="locationSelect">×‘×—×¨ ×’×™× ×”:</label>
                            <select id="locationSelect" required>
                                <option value="">×‘×—×¨ ×’×™× ×”...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="visitType">×¡×•×’ ×˜×™×¤×•×œ:</label>
                            <select id="visitType" required>
                                <option value="××œ×">××œ×</option>
                                <option value="×—×œ×§×™">×—×œ×§×™</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="workDone">××” ×‘×•×¦×¢:</label>
                            <textarea id="workDone" placeholder="×ª×™××•×¨ ×”×¢×‘×•×“×” ×©×‘×•×¦×¢×”"></textarea>
                        </div>
                        <div class="timer-section">
                            <div class="timer-display">
                                <span id="timerDisplay">00:00:00</span>
                            </div>
                            <div class="timer-buttons">
                                <button type="button" id="startBtn" onclick="startVisit()">×”×ª×—×œ ×˜×™×¤×•×œ</button>
                                <button type="button" id="pauseBtn" onclick="pauseVisit()" disabled>×”×¤×¡×§×”</button>
                                <button type="button" id="stopBtn" onclick="stopVisit()" disabled>×¡×™×•× ×˜×™×¤×•×œ</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="manualDuration">××©×š ×™×“× ×™ (×“×§×•×ª):</label>
                            <input type="number" id="manualDuration" placeholder="×¢×¨×™×›×” ×™×“× ×™×ª">
                        </div>
                        <div class="form-group">
                            <label for="amount">×¡×›×•×:</label>
                            <input type="number" id="amount" placeholder="×¡×›×•× ×”×˜×™×¤×•×œ">
                        </div>
                        <div class="form-group">
                            <label for="expense">×”×•×¦××”:</label>
                            <input type="number" id="expense" placeholder="×”×•×¦××•×ª × ×œ×•×•×ª">
                        </div>
                        <button type="submit">×©××•×¨ ×˜×™×¤×•×œ</button>
                    </form>
                </div>
            </section>

			<!-- History Section -->
			<section id="history" class="section">
				<h2>ğŸ“‹ ×˜×™×¤×•×œ×™×</h2>
				
				<!-- Filter Panel -->
				<div class="filter-panel">
					<div class="filter-header" onclick="toggleFilterPanel()">
						<h3>ğŸ” ×¡×™× ×•×Ÿ ×˜×™×¤×•×œ×™× <span id="filterIcon">ğŸ”½</span></h3>
					</div>
					<div id="filterContent" class="filter-content">
						<div class="filter-row">
							<div class="filter-group">
								<label>×œ×§×•×—:</label>
								<select id="filterLocation">
									<option value="">×›×œ ×”×œ×§×•×—×•×ª</option>
								</select>
							</div>
							<div class="filter-group">
								<label>×¡×˜×˜×•×¡ ×ª×©×œ×•×:</label>
								<select id="filterPayment">
									<option value="">×”×›×œ</option>
									<option value="×›×Ÿ">×©×•×œ×</option>
									<option value="×œ×">×œ× ×©×•×œ×</option>
									<option value="×œ×œ×">×œ×œ× ×ª×©×œ×•×</option>
								</select>
							</div>
						</div>
						<div class="filter-row">
							<div class="filter-group">
								<label>××ª××¨×™×š:</label>
								<input type="date" id="filterDateFrom">
							</div>
							<div class="filter-group">
								<label>×¢×“ ×ª××¨×™×š:</label>
								<input type="date" id="filterDateTo">
							</div>
						</div>
						<div class="filter-actions">
							<button onclick="applyVisitFilters()" class="btn btn-primary">×¡× ×Ÿ</button>
							<button onclick="clearVisitFilters()" class="btn btn-secondary">× ×§×” ×¡×™× ×•×Ÿ</button>
						</div>
					</div>
				</div>

				<!-- Info Panel -->
				<div class="info-panel">
					<div class="info-header" onclick="toggleInfoPanel()">
						<h3>ğŸ“Š ××™×“×¢ <span id="infoIcon">ğŸ”½</span></h3>
					</div>
					<div id="infoContent" class="info-content">
						<div class="info-grid">
							<div class="info-item">
								<span class="info-label">×˜×™×¤×•×œ×™× ××•×¦×’×™×:</span>
								<span id="visitsCount" class="info-value">0</span>
							</div>
							<div class="info-item">
								<span class="info-label">×¡×”"×› ×©×¢×•×ª:</span>
								<span id="totalHours" class="info-value">0</span>
							</div>
							<div class="info-item">
								<span class="info-label">×¡×”"×› ×”×›× ×¡×•×ª:</span>
								<span id="totalIncome" class="info-value">â‚ª0</span>
							</div>
							<div class="info-item">
								<span class="info-label">×—×•×‘×•×ª ×¤×ª×•×—×™×:</span>
								<span id="outstandingDebt" class="info-value">â‚ª0</span>
							</div>
						</div>
					</div>
				</div>

				<!-- Visits Table -->
				<div class="table-container">
					<table id="visitsHistoryTable" class="data-table">
						<thead>
							<tr>
								<th>×ª××¨×™×š</th>
								<th>×œ×§×•×—</th>
								<th>×¡×•×’ ×˜×™×¤×•×œ</th>
								<th>×¢×‘×•×“×” ×©×‘×•×¦×¢×”</th>
								<th>××©×š (×©×¢×•×ª)</th>
								<th>×¡×›×•×</th>
								<th>×©×•×œ×</th>
								<th>×¤×¢×•×œ×•×ª</th>
							</tr>
						</thead>
						<tbody id="visitsHistoryTableBody">
						</tbody>
					</table>
				</div>
			</section>

            <!-- locations Section -->
            <section id="locations" class="section">
                <h2>× ×™×”×•×œ ×œ×§×•×—×•×ª</h2>
				<button onclick="showAddLocationForm()" class="add-btn">×”×•×¡×£ ×œ×§×•×— ×—×“×©</button>
                <div class="table-container">
                    <table id="locationsTable" class="data-table">
                        <thead>
                            <tr>
                                <th>×©×</th>
                                <th>×›×ª×•×‘×ª</th>
                                <th>××™×© ×§×©×¨</th>
                                <th>×™×•× ××•×ª×¨</th>
                                <th>××¨×•×•×—</th>
                                <th>×¤×¢×™×œ×”</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="locationsTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Receipts Section -->
            <section id="receipts" class="section">
                <h2>× ×™×”×•×œ ×§×‘×œ×•×ª</h2>
                <button onclick="showAddReceiptForm()" class="add-btn">×”×•×¡×£ ×§×‘×œ×” ×—×“×©×”</button>
                <div class="table-container">
                    <table id="receiptsTable" class="data-table">
                        <thead>
							<tr>
								<th>×¤× ×§×¡</th>
								<th>×§×‘×œ×”</th>
								<th>×ª××¨×™×š</th>
								<th>×‘×™× ×”</th>
								<th>×¡×›×•×</th>
								<th>×¡×•×’ ×ª×©×œ×•×</th>
								<th>×§×•×“X</th>  
								<th>×¤×¢×•×œ×•×ª</th>
							</tr>
						</thead>
                        <tbody id="receiptsTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

			<!-- System Section -->
			<section id="system" class="section">
				<h2>ğŸ› ï¸ ××¢×¨×›×ª v2.5</h2>
				
				<!-- Import Section -->
				<div class="form-section">
					<h3>ğŸ“¥ ×™×™×‘×•× × ×ª×•× ×™×</h3>
					
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
						<button class="btn btn-primary" onclick="createImportTable()">
							ğŸ”— ×¦×•×¨ ×˜×‘×œ×ª ×¢×–×¨ ×œ×™×™×‘×•×
						</button>
						<button class="btn btn-success" onclick="importFromHelper()">
							ğŸ“¥ ×™×™×‘× ×”×›×œ ××˜×‘×œ×ª ×”×¢×–×¨
						</button>
					</div>

					<!-- ×™×™×‘×•× ×—×œ×§×™ - ××§×•×¤×œ -->
					<details style="margin-top: 15px;">
						<summary style="cursor: pointer; color: #666; font-size: 14px;">âš™ï¸ ×™×™×‘×•× ×—×œ×§×™ (×œ××ª×§×“××™×)</summary>
						<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
							<button class="btn btn-info" onclick="importCustomersFromHelper()">ğŸ‘¥ ×¨×§ ×œ×§×•×—×•×ª</button>
							<button class="btn btn-primary" onclick="importVisitsFromHelper()">ğŸ”§ ×¨×§ ×˜×™×¤×•×œ×™×</button>
							<button class="btn btn-warning" onclick="importReceiptsFromHelper()">ğŸ§¾ ×¨×§ ×§×‘×œ×•×ª</button>
						</div>
						<p style="font-size: 12px; color: #666; margin-top: 8px;">
							×”×©×ª××© ×‘×–×” ×¨×§ ×× ××ª×” ×¦×¨×™×š ×œ×™×™×‘× ×¡×•×’ × ×ª×•× ×™× ×¡×¤×¦×™×¤×™
						</p>
					</details>
					
					<div style="text-align: center; margin: 15px 0;">
						<span style="color: #666;">××•</span>
					</div>
					
					<div style="text-align: center;">
						<button class="btn btn-warning" onclick="document.getElementById('importFileInput').click()">
							ğŸ“ ×™×™×‘×•× ××”×™×¨ ××§×•×‘×¥
						</button>
						<input type="file" id="importFileInput" accept=".csv,.xlsx" style="display: none;" onchange="handleImportFile(event)">
					</div>
					
					<p style="text-align: center; font-size: 12px; color: #666; margin-top: 15px;">
						×™×™×‘×•× ×œ×§×•×—×•×ª, ×‘×™×§×•×¨×™× ×•×§×‘×œ×•×ª ××§×•×‘×¥ Excel ××• Google Sheets
					</p>
				</div>
				
				<!-- Additional System Features -->
				<div class="form-section">
					<h3>âš™ï¸ ×”×’×“×¨×•×ª ××¢×¨×›×ª</h3>
					<p>×ª×›×•× ×•×ª × ×•×¡×¤×•×ª ×™×ª×•×•×¡×¤×• ×›××Ÿ ×‘×”××©×š...</p>
				</div>
			</section>
			
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <script>
		 // Google Sheets API Configuration
		const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
		const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
		const SPREADSHEET_ID = '1fSD5dh0bXRzFSeOZUwJ2bPjGRLqs2crGXPkebz6MpWc';
		const CLIENT_ID = '1040357646874-4sbkrokgjn4dd7a0e9rkrtjt8d9l3vie.apps.googleusercontent.com';
		const API_KEY = 'AIzaSyB25ms_UzbgfY9FnduMwMhGhlvwfVPaTg8';

//////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>   ×œ××—×™×§×”
		// ×‘×“×™×§×” ×–×× ×™×ª - ×ª××—×§ ××—×¨×™ ×”×‘×“×™×§×”
		console.log('Spreadsheet ID:', SPREADSHEET_ID);
		console.log('API Key:', API_KEY);
		console.log('Client ID:', CLIENT_ID);
//////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>


		let gapi_loaded = false;
		let google_loaded = false;
		let access_token = null;
		let spreadsheet_id = SPREADSHEET_ID;
        
        // Sheet names
        const SHEETS = {
			LOCATIONS: 'locations',  
			VISITS: 'visits',          
			RECEIPTS: 'receipts'     
		};

        // Global variables
        let locations = [];
        let visits = [];
        let receipts = [];
        let currentFilter = 'today';
        let timer = {
            startTime: null,
            pauseTime: 0,
            interval: null,
            isRunning: false,
            isPaused: false
        };

		// Initialize Google APIs
		function initializeGoogleAPIs() {
			gapi.load('client', initializeGapiClient);
			google.accounts.id.initialize({
				client_id: CLIENT_ID,
				callback: handleCredentialResponse,
			});
		}
		
		async function initializeGapiClient() {
			try {
				await gapi.client.init({
					apiKey: API_KEY,
					discoveryDocs: [DISCOVERY_DOC],
				});
				gapi_loaded = true;
				console.log('GAPI client initialized successfully');
			} catch (error) {
				console.error('Error initializing GAPI client:', error);
				showToast('×©×’×™××” ×‘××ª×—×•×œ Google API', 'error');
			}
		}

		function handleCredentialResponse(response) {
			access_token = response.credential;
			showSuccess('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×” ×œ-Google!');
		}

		// ×ª×•×¡×¤×” - ×¤×•× ×§×¦×™×” ×©× ×§×¨××ª ××—×¨×™ ×”×”×ª×—×‘×¨×•×ª
		async function loadAllDataFromSheets() {
			if (!await validateToken()) {
				showToast('××™×Ÿ ×—×™×‘×•×¨ ×œ×’×•×’×œ - ×˜×•×¢×Ÿ × ×ª×•× ×™× ××§×•××™×™×', 'warning');
				return;
			}
			
			try {
				showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™× ×-Google Sheets...');
				
				await loadLocationsFromSheets();
				await loadVisitsFromSheets(); 
				await loadReceiptsFromSheets();
				
				// Update UI
				loadLocationsForSelect();
				loadLocationsTable();
				loadReceiptsTable();
				loadPlanningData();
				
				hideLoading();
				showSuccess('× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” ×-Google Sheets!');
				
			} catch (error) {
				console.error('Error loading data from sheets:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('âš ï¸ ×”×—×™×‘×•×¨ ×¤×’ ×‘××”×œ×š ×˜×¢×™× ×”', 'warning');
				} else {
					showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™× ×-Google Sheets');
				}
				throw error;
			}
		}

		async function connectToGoogleSheets() {
			try {
				console.log('Connecting to Google Sheets...');
				showSuccess('××ª×—×‘×¨ ×œ-Google Sheets...');
				
				document.getElementById('statusText').textContent = '××—×•×‘×¨';
				document.getElementById('statusText').classList.add('connected');
				document.getElementById('saveBtn').disabled = false;
				document.getElementById('loadBtn').disabled = false;
				
				const tokenClient = google.accounts.oauth2.initTokenClient({
					client_id: CLIENT_ID,
					scope: SCOPES,
					callback: (response) => {
						access_token = response.access_token;
						showSuccess('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×” ×œ-Google Sheets!');
						document.getElementById('statusText').textContent = '××—×•×‘×¨';
						document.getElementById('statusText').classList.add('connected');
						loadAllDataFromSheets();
					},
				});
				
				tokenClient.requestAccessToken();
				
			} catch (error) {
				console.error('Error connecting to Google Sheets:', error);
				showError('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ-Google Sheets');
			}
		}

		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ××™×§×•××™× (×’×™× ×•×ª)
		async function loadLocationsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:O`
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					locations = rows.slice(1).map(row => ({
						ID: row[0] || '',
						name: row[1] || '',
						full_address: row[2] || '',
						neighborhood: row[3] || '',
						city: row[4] || '',
						contact_person: row[5] || '',
						phone: row[6] || '',
						allowed_day: row[7] || '',
						interval_weeks: row[8] || '',
						temp_addition: row[9] || 0,
						base_amount: row[10] || '',
						active: row[11] || '',
						notes: row[12] || '',
						last_visit: row[13] || '',
						next_visit: row[14] || ''
					}));
				}
				
			} catch (error) {
				console.error('Error loading locations:', error);
			}
		}

		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ×‘×™×§×•×¨×™× (×˜×™×¤×•×œ×™×)
		async function loadVisitsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:L`
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					visits = rows.slice(1).map(row => ({
						ID: row[0] || '',
						date: row[1] || '',
						location_id: row[2] || '',
						visit_type: row[3] || '',
						work_done: row[4] || '',
						duration_minutes: row[5] || 0,
						start_time: row[6] || '',
						end_time: row[7] || '',
						amount: row[8] || 0,
						expense: row[9] || 0,
						paid: row[10] || '×œ×',
						notes: row[11] || ''
					}));
				}
				
			} catch (error) {
				console.error('Error loading visits:', error);
			}
		}

		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ×§×‘×œ×•×ª
		async function loadReceiptsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:I`
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					receipts = rows.slice(1).map(row => ({
						ID: row[0] || '',
						book_number: row[1] || '',
						receipt_number: row[2] || '',
						date: row[3] || '',
						location_id: row[4] || '',
						location_name: row[5] || '',
						amount: row[6] || 0,
						payment_type: row[7] || '',
						notes: row[8] || ''
					}));
				}
				
			} catch (error) {
				console.error('Error loading receipts:', error);
			}
		}
		
		// ×ª×•×¡×¤×” - ×©××™×¨×ª ××™×§×•× ×—×“×© ×œ×©×™×˜×¡
		async function saveLocationToSheets(locationData) {
		
			if (!await validateToken()) {
				showToast('×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×©××™×¨×” ××§×•××™×ª ×‘×œ×‘×“', 'warning');
				return;
			}
    
			try {
				const values = [[
					locationData.ID,
					locationData.name,
					locationData.full_address,
					locationData.neighborhood,
					locationData.city,
					locationData.contact_person,
					locationData.phone,
					locationData.allowed_day,
					locationData.interval_weeks,
					locationData.temp_addition,
					locationData.base_amount,
					locationData.active,
					locationData.notes,
					locationData.last_visit,
					locationData.next_visit
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:O`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving location to sheets:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('âš ï¸ ×”×—×™×‘×•×¨ ×¤×’ - ×”×ª×—×‘×¨ ××—×“×©', 'warning');
					document.getElementById('statusText').textContent = 'ğŸ”“ × ×•×ª×§';
				} else {
					// ×©×’×™××•×ª ××—×¨×•×ª (×œ× ×§×©×•×¨×•×ª ×œ××¡×™××•×Ÿ)
					showToast('âš ï¸ ×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ', 'error');
				}
				throw error;

			}
		}

		// ×ª×•×¡×¤×” - ×©××™×¨×ª ×‘×™×§×•×¨ ×—×“×© ×œ×©×™×˜×¡
		async function saveVisitToSheets(visitData) {
			try {
				const values = [[
					visitData.ID,
					visitData.date,
					visitData.location_id,
					visitData.visit_type,
					visitData.work_done,
					visitData.duration_minutes,
					visitData.start_time,
					visitData.end_time,
					visitData.amount,
					visitData.expense,
					visitData.paid,
					visitData.notes
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:L`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving visit to sheets:', error);
				throw error;
			}
		}
		
		// ×ª×•×¡×¤×” - ×©××™×¨×ª ×§×‘×œ×” ×—×“×©×” ×œ×©×™×˜×¡
		async function saveReceiptToSheets(receiptData) {
			try {
				const values = [[
					receiptData.ID,
					receiptData.book_number,
					receiptData.receipt_number,
					receiptData.date,
					receiptData.location_id,
					receiptData.location_name,
					receiptData.amount,
					receiptData.payment_type,
					receiptData.notes
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:I`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
				console.log('Receipt saved to sheets');
				
			} catch (error) {
				console.error('Error saving receipt to sheets:', error);
				throw error;
			}
		}

		// ×ª×•×¡×¤×” - ×©××™×¨×ª ×›×œ ×”× ×ª×•× ×™× ×œ×¢× ×Ÿ
		async function saveAllToSheets() {
			try {
				showLoading('×©×•××¨ × ×ª×•× ×™× ×œ×¢× ×Ÿ...');
				
				// ×©××™×¨×ª ×›×œ ×”×œ×§×•×—×•×ª
				for (const location of locations) {
					await saveLocationToSheets(location);
				}
				
				// ×©××™×¨×ª ×›×œ ×”×‘×™×§×•×¨×™×
				for (const visit of visits) {
					await saveVisitToSheets(visit);
				}
				
				// ×©××™×¨×ª ×›×œ ×”×§×‘×œ×•×ª
				for (const receipt of receipts) {
					await saveReceiptToSheets(receipt);
				}
				
				hideLoading();
				showSuccess('×›×œ ×”× ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×” ×œ×¢× ×Ÿ!');
				
			} catch (error) {
				console.error('Error saving all data:', error);
				hideLoading();
				showError('×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™× ×œ×¢× ×Ÿ');
			}
		}

		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ×›×œ ×”× ×ª×•× ×™× ××”×¢× ×Ÿ
		async function loadAllFromSheets() {
			try {
				showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™× ××”×¢× ×Ÿ...');
				
				await loadLocationsFromSheets();
				await loadVisitsFromSheets(); 
				await loadReceiptsFromSheets();
				
				// ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
				loadLocationsForSelect();
				loadLocationsTable();
				loadReceiptsTable();
				loadPlanningData();
				
				hideLoading();
				showSuccess('× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” ××”×¢× ×Ÿ!');
				
			} catch (error) {
				console.error('Error loading all data:', error);
				hideLoading();
				showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™× ××”×¢× ×Ÿ');
			}
		}


		// Local Storage functions
		function saveToLocalStorage() {
			try {
				localStorage.setItem('locations_data', JSON.stringify(locations));  // ×©×•× ×”
				localStorage.setItem('visits_data', JSON.stringify(visits));        // ×©×•× ×”
				localStorage.setItem('receipts_data', JSON.stringify(receipts));
				console.log('Data saved to local storage');
			} catch (error) {
				console.error('Error saving to local storage:', error);
			}
		}

		function loadFromLocalStorage() {
			try {
				const savedLocations = localStorage.getItem('locations_data');     // ×©×•× ×”
				const savedVisits = localStorage.getItem('visits_data');          // ×©×•× ×”
				const savedReceipts = localStorage.getItem('receipts_data');
				
				if (savedLocations) {
					locations = JSON.parse(savedLocations);  // ×©×•× ×”
				}
				if (savedVisits) {
					visits = JSON.parse(savedVisits);        // ×©×•× ×”
				}
				if (savedReceipts) {
					receipts = JSON.parse(savedReceipts);
				}
				
				console.log('Data loaded from local storage');
				
			} catch (error) {
				console.error('Error loading from local storage:', error);
			}
		}



        document.addEventListener('DOMContentLoaded', function() {
			console.log('App starting...');
			initializeGoogleAPIs();
			loadAllData(); // ×–×” ×™×˜×¢×Ÿ × ×ª×•× ×™× ××§×•××™×™×
			setupEventListeners();
		});

        // Setup event listeners
        function setupEventListeners() {
            // Visitform submission
            document.getElementById('visitForm').addEventListener('submit', handleVisitSubmit);
        }

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Add active class to clicked button
            if (event && event.target) {
				event.target.classList.add('active');
			}
            
            // Load section-specific data
            switch(sectionName) {
                case 'planning':
                    loadPlanningData();
                    break;
                case 'visit':
                    loadLocationsForSelect();
                    break;
				case 'history':
					loadVisitsHistory();
					break;
                case 'locations':
                    loadLocationsTable();
                    break;
                case 'receipts':
                    loadReceiptsTable();
                    break;
            }
        }

        // Timer functions
        function startVisit() {
            timer.startTime = Date.now() - timer.pauseTime;
            timer.isRunning = true;
            timer.isPaused = false;
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;
            
            timer.interval = setInterval(updateTimerDisplay, 1000);
        }

        function pauseVisit() {
            if (timer.isPaused) {
                // Resume
                timer.startTime = Date.now() - timer.pauseTime;
                timer.isPaused = false;
                timer.interval = setInterval(updateTimerDisplay, 1000);
                document.getElementById('pauseBtn').textContent = '×”×¤×¡×§×”';
            } else {
                // Pause
                clearInterval(timer.interval);
                timer.pauseTime = Date.now() - timer.startTime;
                timer.isPaused = true;
                document.getElementById('pauseBtn').textContent = '×”××©×š';
            }
        }

        function stopVisit() {
            clearInterval(timer.interval);
            const totalDuration = Math.floor((Date.now() - timer.startTime) / 60000); // minutes
            
            document.getElementById('manualDuration').value = totalDuration;
            
            // Reset timer
            timer = {
                startTime: null,
                pauseTime: 0,
                interval: null,
                isRunning: false,
                isPaused: false
            };
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('pauseBtn').textContent = '×”×¤×¡×§×”';
            document.getElementById('timerDisplay').textContent = '00:00:00';
        }

        function updateTimerDisplay() {
            const elapsed = Date.now() - timer.startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            document.getElementById('timerDisplay').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Data loading functions
		async function loadAllData() {
			try {
				showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™×...');
				loadFromLocalStorage();
				hideLoading();
				loadPlanningData();
			} catch (error) {
				console.error('Error loading data:', error);
				showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×');
			}
		}

        async function loadlocations() {
            // For now, we'll use dummy data until we set up the Google Sheets API
            locations = [
                {
                    ID: 1,
                    name: "×’×™× ×ª ×“×•×’××” 1",
                    full_address: "×¨×—×•×‘ ×”×“×•×’××” 1, ×ª×œ ××‘×™×‘",
                    neighborhood: "××¨×›×–",
                    city: "×ª×œ ××‘×™×‘",
                    contact_person: "×™×•×¡×™ ×›×”×Ÿ",
                    phone: "050-1234567",
                    allowed_day: "×'",
                    interval_weeks: 4,
                    temp_addition: 0,
                    base_amount: 300,
                    active: "×›×Ÿ",
                    notes: "",
                    last_visit: "2024-01-15",
                    next_visit: "2024-02-12"
                },
                {
                    ID: 2,
                    name: "×’×™× ×ª ×“×•×’××” 2",
                    full_address: "×¨×—×•×‘ ×”×“×•×’××” 2, ×ª×œ ××‘×™×‘",
                    neighborhood: "×¦×¤×•×Ÿ",
                    city: "×ª×œ ××‘×™×‘",
                    contact_person: "××¨×™× ×œ×•×™",
                    phone: "052-7654321",
                    allowed_day: "×’'",
                    interval_weeks: 6,
                    temp_addition: 0,
                    base_amount: 400,
                    active: "×›×Ÿ",
                    notes: "",
                    last_visit: "2024-01-10",
                    next_visit: "2024-02-21"
                }
            ];
        }

        async function loadVisits() {
            visits = []; // Will be loaded from Google Sheets
        }

        async function loadReceipts() {
            receipts = []; // Will be loaded from Google Sheets
        }

        // Display functions
        function loadPlanningData() {
            filterVisits(currentFilter);
        }

        function filterVisits(filter) {
			currentFilter = filter;
			
			// Update filter buttons - fix the event.target issue
			document.querySelectorAll('.filter-btn').forEach(btn => {
				btn.classList.remove('active');
				// Add active class to the button that matches the current filter
				if ((filter === 'today' && btn.textContent === '×”×™×•×') ||
					(filter === 'week' && btn.textContent === '×”×©×‘×•×¢') ||
					(filter === 'overdue' && btn.textContent === '×××—×¨×•×ª')) {
					btn.classList.add('active');
				}
			});
			
			// Filter locations based on next_visitdate
			const today = new Date();
			const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
			
			let filteredlocations = locations.filter(location => location.active === "×›×Ÿ");
			
			switch(filter) {
				case 'today':
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit= new Date(location.next_visit);
						return nextVisit<= today;
					});
					break;
				case 'week':
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit= new Date(location.next_visit);
						return nextVisit<= weekFromNow;
					});
					break;
				case 'overdue':
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit= new Date(location.next_visit);
						return nextVisit< today;
					});
					break;
			}
			
			displayPlanningTable(filteredlocations);
		}

        function displayPlanningTable(locationsToShow) {
            const tbody = document.getElementById('planningTableBody');
            tbody.innerHTML = '';
            
            if (locationsToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">××™×Ÿ ×’×™× ×•×ª ×œ×˜×™×¤×•×œ</td></tr>';
                return;
            }
            
            locationsToShow.forEach(location => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${location.name}</td>
                    <td>${location.full_address}</td>
                    <td>${location.allowed_day}</td>
                    <td>${formatDate(location.next_visit)}</td>
                    <td>
                        <button class="action-btn start-visit-btn" onclick="startVisitForlocation(${location.ID})">
                            ×”×ª×—×œ ×˜×™×¤×•×œ
                        </button>
                        <button class="action-btn edit-btn" onclick="postponeVisit(${location.ID})">
                            ×“×—×”
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadLocationsForSelect() {
            const select = document.getElementById('locationSelect');
            select.innerHTML = '<option value="">×‘×—×¨ ×’×™× ×”...</option>';
            
            locations.filter(location => location.active === "×›×Ÿ").forEach(location => {
                const option = document.createElement('option');
                option.value = location.ID;
                option.textContent = `${location.name} - ${location.full_address}`;
                select.appendChild(option);
            });
        }

        function loadLocationsTable() {
            const tbody = document.getElementById('locationsTableBody');
            tbody.innerHTML = '';
            
            locations.forEach(location => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${location.name}</td>
                    <td>${location.full_address}</td>
                    <td>${location.contact_person}</td>
                    <td>${location.allowed_day}</td>
                    <td>${location.interval_weeks} ×©×‘×•×¢×•×ª</td>
                    <td>${location.active}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editLocation(${location.ID})">×¢×¨×•×š</button>
                        <button class="action-btn delete-btn" onclick="deleteLocation(${location.ID})">××—×§</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

       function loadReceiptsTable() {
			const tbody = document.getElementById('receiptsTableBody');
			tbody.innerHTML = '';
			
			if (receipts.length === 0) {
				tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">××™×Ÿ ×§×‘×œ×•×ª</td></tr>';
				return;
			}
			
			receipts.forEach(receipt => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${receipt.book_number}</td>
					<td>${receipt.receipt_number}</td>
					<td>${formatDate(receipt.date)}</td>
					<td>${receipt.location_name}</td>
					<td>${receipt.amount}</td>
					<td>${receipt.payment_type}</td>
					<td>${receipt.codeX || ''}</td>
					<td>
						<button class="action-btn edit-btn" onclick="editReceipt(${receipt.ID})">×¢×¨×•×š</button>
						<button class="action-btn delete-btn" onclick="deleteReceipt(${receipt.ID})">××—×§</button>
					</td>
				`;
				tbody.appendChild(row);
			});
		}

        // Visithandling
        function startVisitForlocation(locationId) {
            const location = locations.find(g => g.ID === locationId);
            if (location) {
                showSection('visit');
                document.getElementById('locationSelect').value = locationId;
            }
        }

        function handleVisitSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
      
			const visitData = {
				location_id: document.getElementById('locationSelect').value,  
				visit_type: document.getElementById('visitType').value,
				work_done: document.getElementById('workDone').value,
				duration_minutes: document.getElementById('manualDuration').value || 0,
				amount: document.getElementById('amount').value || 0,
				expense: document.getElementById('expense').value || 0,
				date: new Date().toISOString().split('T')[0],
				start_time: new Date().toTimeString().split(' ')[0],
				end_time: new Date().toTimeString().split(' ')[0]
			};
            
            console.log('Visitdata:', visitData);
            
            // Here we would save to Google Sheets
            saveVisit(visitData);
        }

		// ×œ×©× ×•×ª ×‘×¤×•× ×§×¦×™×” ×”×§×™×™××ª - ×œ×”×•×¡×™×£ ×©××™×¨×” ×œ×©×™×˜×¡
		async function saveVisit(visitData) {
			try {
				// For now, just add to local array
				const newVisit= {
					ID: Date.now(),
					...visitData,
					paid: '×œ×',
					notes: ''
				};
				
				// ×‘×“×™×§×ª ×ª×§×™× ×•×ª
				const visitErrors = validateVisitData(visitData);
				if (showValidationErrors(visitErrors)) {
					return;
				}
				
				// ×‘×“×™×§×ª ×›×¤×™×œ×•×™×•×ª ×‘×™×§×•×¨
				const existingVisit = visits.find(visit => 
					visit.location_id === visitData.location_id &&
					visit.date === visitData.date &&
					Math.abs(new Date(`${visit.date} ${visit.start_time}`) - new Date(`${visitData.date} ${visitData.start_time}`)) < 60000 // ×¤×—×•×ª ××“×§×” ×”×¤×¨×©
				);

				if (existingVisit) {
					if (!confirm(`×›×‘×¨ ×§×™×™× ×‘×™×§×•×¨ ×‘××•×ª×” ×›×ª×•×‘×ª ×‘××•×ª×• ×ª××¨×™×š ×•×©×¢×” ×“×•××”.\n\n×”×× ×œ×”×•×¡×™×£ ×‘×›×œ ×–××ª?`)) {
						return; // ×‘×™×˜×•×œ ×”×•×¡×¤×”
					}
				}
				
				visits.push(newVisit);

				// ×ª×•×¡×¤×” - ×©××™×¨×” ×œ×’×•×’×œ ×©×™×˜×¡
				if (access_token) {
					await saveVisitToSheets(newVisit);
				}

				// Update next visitdate if it's a full visit
				if (visitData.visit_type === '××œ×') {
				   updateNextVisitDate(visitData.location_id);
				}
			   
				showSuccess('×˜×™×¤×•×œ × ×©××¨ ×‘×”×¦×œ×—×”!');
				
				// Reset form
				document.getElementById('visitForm').reset();
			   
				// Reset timer display
				document.getElementById('timerDisplay').textContent = '00:00:00';
			   
				// Reload planning data
				loadPlanningData();
				saveToLocalStorage();
				   
			} catch (error) {
				console.error('Error saving visit:', error);
				showError('×©×’×™××” ×‘×©××™×¨×ª ×”×˜×™×¤×•×œ');
			}
		}

		function updateNextVisitDate(locationId) {
			const location = locations.find(g => g.ID == locationId);
			if (location) {
               const lastVisit= new Date();
               const intervalWeeks = parseInt(location.interval_weeks) + parseInt(location.temp_addition || 0);
               const nextVisit= new Date(lastVisit.getTime() + (intervalWeeks * 7 * 24 * 60 * 60 * 1000));
               
               location.last_visit= lastVisit.toISOString().split('T')[0];
               location.next_visit= nextVisit.toISOString().split('T')[0];
               location.temp_addition = 0; // Reset temporary addition
               
               // Here we would update Google Sheets
               console.log(`Updated next visitfor ${location.name}: ${location.next_visit}`);
			}
		}

		function postponeVisit(locationId) {
			const location = locations.find(g => g.ID == locationId);
			if (location) {
				const weeks = prompt('×›××” ×©×‘×•×¢×•×ª ×œ×“×—×•×ª?', '1');
				if (weeks && !isNaN(weeks)) {
					const currentNext = new Date(location.next_visit);
					const newNext = new Date(currentNext.getTime() + (parseInt(weeks) * 7 * 24 * 60 * 60 * 1000));
					location.next_visit= newNext.toISOString().split('T')[0];

					loadPlanningData();
					showSuccess(`×˜×™×¤×•×œ × ×“×—×” ×‘-${weeks} ×©×‘×•×¢×•×ª`);
				}
			}
		}

       // location management
       function showAddLocationForm() {
           const modalHTML = `
               <div class="modal" id="locationModal">
                   <div class="modal-content">
                       <div class="modal-header">
                           <h3>×”×•×¡×¤×ª ×’×™× ×” ×—×“×©×”</h3>
                           <span class="close" onclick="closeModal('locationModal')">&times;</span>
                       </div>
                       <form id="locationForm" onsubmit="handleLocationSubmit(event)">
                           <div class="form-group">
                               <label for="locationName">×©× ×’×™× ×”:</label>
                               <input type="text" id="locationName" required>
                           </div>
                           <div class="form-group">
                               <label for="locationAddress">×›×ª×•×‘×ª ××œ××”:</label>
                               <input type="text" id="locationAddress" required>
                           </div>
                           <div class="form-group">
                               <label for="locationNeighborhood">×©×›×•× ×”:</label>
                               <input type="text" id="locationNeighborhood">
                           </div>
                           <div class="form-group">
                               <label for="locationCity">×¢×™×¨:</label>
                               <input type="text" id="locationCity">
                           </div>
                           <div class="form-group">
                               <label for="locationContact">××™×© ×§×©×¨:</label>
                               <input type="text" id="locationContact" required>
                           </div>
                           <div class="form-group">
                               <label for="locationPhone">×˜×œ×¤×•×Ÿ:</label>
                               <input type="tel" id="locationPhone">
                           </div>
                           <div class="form-group">
                               <label for="locationDay">×™×•× ××•×ª×¨:</label>
                               <select id="locationDay" required>
                                   <option value="">×‘×—×¨ ×™×•×...</option>
                                   <option value="×'">×¨××©×•×Ÿ</option>
                                   <option value="×‘'">×©× ×™</option>
                                   <option value="×’'">×©×œ×™×©×™</option>
                                   <option value="×“'">×¨×‘×™×¢×™</option>
                                   <option value="×”'">×—××™×©×™</option>
                                   <option value="×•'">×©×™×©×™</option>
                                   <option value="×©×‘×ª">×©×‘×ª</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label for="locationInterval">××¨×•×•×— ×©×‘×•×¢×•×ª:</label>
                               <input type="number" id="locationInterval" required min="1" max="52">
                           </div>
                           <div class="form-group">
                               <label for="locationAmount">×¡×›×•× ×‘×¡×™×¡×™:</label>
                               <input type="number" id="locationAmount">
                           </div>
                           <div class="form-group">
                               <label for="locationActive">×¤×¢×™×œ×”:</label>
                               <select id="locationActive" required>
                                   <option value="×›×Ÿ">×›×Ÿ</option>
                                   <option value="×œ×">×œ×</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label for="locationNextVisit">×ª××¨×™×š ×œ×˜×™×¤×•×œ ×”×‘×:</label>
                               <input type="date" id="locationNextVisit" required>
                           </div>
                           <div class="form-group">
                               <label for="locationNotes">×”×¢×¨×•×ª:</label>
                               <textarea id="locationNotes"></textarea>
                           </div>
                           <button type="submit">×©××•×¨ ×’×™× ×”</button>
                       </form>
                   </div>
               </div>
           `;
           
           document.getElementById('modalContainer').innerHTML = modalHTML;
           document.getElementById('locationModal').style.display = 'block';
           
           // Set default next visitdate to today
           document.getElementById('locationNextVisit').value = new Date().toISOString().split('T')[0];
       }

        async function handleLocationSubmit(event) {
            event.preventDefault();
           
			const locationData = {
				ID: Date.now(),
				name: document.getElementById('locationName').value,
				full_address: document.getElementById('locationAddress').value,
				neighborhood: document.getElementById('locationNeighborhood').value,
				city: document.getElementById('locationCity').value,
				contact_person: document.getElementById('locationContact').value,
				phone: document.getElementById('locationPhone').value,
				allowed_day: document.getElementById('locationDay').value,
				interval_weeks: parseInt(document.getElementById('locationInterval').value),
				temp_addition: 0,
				base_amount: parseFloat(document.getElementById('locationAmount').value) || 0,
				active: document.getElementById('locationActive').value,
				notes: document.getElementById('locationNotes').value,
				last_visit: '',
				next_visit: document.getElementById('locationNextVisit').value
			};
           
		    // ×‘×“×™×§×ª ×›×¤×™×œ×•×™×•×ª ×œ×¤× ×™ ×”×•×¡×¤×”
			const existingLocation = locations.find(loc => 
				loc.full_address && locationData.full_address &&
				loc.full_address.toLowerCase().trim() === locationData.full_address.toLowerCase().trim()
			);

			if (existingLocation) {
				if (!confirm(`×œ×§×•×— ×¢× ×›×ª×•×‘×ª "${locationData.full_address}" ×›×‘×¨ ×§×™×™×.\n\n×”×× ×œ×”×•×¡×™×£ ×‘×›×œ ×–××ª?`)) {
					return; // ×‘×™×˜×•×œ ×”×•×¡×¤×”
				}
			}
		   
            // ×©××™×¨×” ×œ×–×™×›×¨×•×Ÿ ××§×•××™
			locations.push(locationData);

			// ×©××™×¨×” ××•×˜×•××˜×™×ª ×œ×¢× ×Ÿ
			if (access_token && spreadsheet_id) {
				document.getElementById('statusText').textContent = 'ğŸ”„ ×©×•××¨ ×œ×§×•×—...';
				try {
					await saveLocationToSheets(locationData);
					document.getElementById('statusText').textContent = '××—×•×‘×¨';
					showSuccess('×œ×§×•×— × ×©××¨ ×‘×”×¦×œ×—×” ×œ-Google Sheets!');
				} catch (error) {
					if (error.status === 401) {
						document.getElementById('statusText').textContent = 'ğŸ”“ × ×“×¨×© ×—×™×‘×•×¨ ××—×“×©';
						document.getElementById('statusText').classList.remove('connected');
						showToast('âš ï¸ ×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×”×ª×—×‘×¨ ××—×“×©', 'warning');
						access_token = null;
					} else {
						document.getElementById('statusText').textContent = 'âš ï¸ ×©×’×™××” ×‘×©××™×¨×”';
						showToast('âš ï¸ ×”×œ×§×•×— × ×©××¨ ××§×•××™×ª ×‘×œ×‘×“', 'warning');
					}
				}
			} else {
				showToast('ğŸ”“ ×œ×§×•×— × ×©××¨ ××§×•××™×ª - ×”×ª×—×‘×¨ ×œ×¢× ×Ÿ ×œ×©××™×¨×”', 'warning');
			}

			closeModal('locationModal');
			loadLocationsTable();
			loadLocationsForSelect();
			saveToLocalStorage();
        }

		function editLocation(locationId) {
			const location = locations.find(g => g.ID == locationId);
			if (!location) return;

			showAddLocationForm();

			// Populate form with existing data
			setTimeout(() => {
			    document.getElementById('locationName').value = location.name;
			    document.getElementById('locationAddress').value = location.full_address;
			    document.getElementById('locationNeighborhood').value = location.neighborhood || '';
			    document.getElementById('locationCity').value = location.city || '';
			    document.getElementById('locationContact').value = location.contact_person;
			    document.getElementById('locationPhone').value = location.phone || '';
			    document.getElementById('locationDay').value = location.allowed_day;
			    document.getElementById('locationInterval').value = location.interval_weeks;
			    document.getElementById('locationAmount').value = location.base_amount;
			    document.getElementById('locationActive').value = location.active;
			    document.getElementById('locationNextVisit').value = location.next_visit;
			    document.getElementById('locationNotes').value = location.notes || '';
			   
			    // Change form submission to update instead of add
			    document.getElementById('locationForm').onsubmit = function(event) {
				   event.preventDefault();
				   updatelocation(locationId);
			    };
			   
			   document.querySelector('.modal-header h3').textContent = '×¢×¨×™×›×ª ×’×™× ×”';
			}, 100);
		}
        
       function updatelocation(locationId) {
           const location = locations.find(g => g.ID == locationId);
           if (!location) return;
           
           location.name = document.getElementById('locationName').value;
           location.full_address = document.getElementById('locationAddress').value;
           location.neighborhood = document.getElementById('locationNeighborhood').value;
           location.city = document.getElementById('locationCity').value;
           location.contact_person = document.getElementById('locationContact').value;
           location.phone = document.getElementById('locationPhone').value;
           location.allowed_day = document.getElementById('locationDay').value;
           location.interval_weeks = parseInt(document.getElementById('locationInterval').value);
           location.base_amount = parseFloat(document.getElementById('locationAmount').value) || 0;
           location.active = document.getElementById('locationActive').value;
           location.next_visit= document.getElementById('locationNextVisit').value;
           location.notes = document.getElementById('locationNotes').value;
           
           closeModal('locationModal');
           loadLocationsTable();
           loadLocationsForSelect();
           loadPlanningData();
           showSuccess('×’×™× ×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!');
		   saveToLocalStorage();
       }

       function deleteLocation(locationId) {
           if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×’×™× ×”?')) {
               locations = locations.filter(g => g.ID != locationId);
               loadLocationsTable();
               loadLocationsForSelect();
               loadPlanningData();
               showSuccess('×’×™× ×” × ××—×§×” ×‘×”×¦×œ×—×”!');
			   saveToLocalStorage();
           }
       }

       // Receipt management
       function showAddReceiptForm() {
           const modalHTML = `
               <div class="modal" id="receiptModal">
                   <div class="modal-content">
                       <div class="modal-header">
                           <h3>×”×•×¡×¤×ª ×§×‘×œ×” ×—×“×©×”</h3>
                           <span class="close" onclick="closeModal('receiptModal')">&times;</span>
                       </div>
                       <form id="receiptForm" onsubmit="handleReceiptSubmit(event)">
                           <div class="form-group">
                               <label for="receiptBook">××¡×¤×¨ ×¤× ×§×¡:</label>
                               <input type="number" id="receiptBook" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptNumber">××¡×¤×¨ ×§×‘×œ×”:</label>
                               <input type="number" id="receiptNumber" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptDate">×ª××¨×™×š:</label>
                               <input type="date" id="receiptDate" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptlocations">×’×™× ×”:</label>
                               <select id="receiptlocations" required>
                                   <option value="">×‘×—×¨ ×’×™× ×”...</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label for="receiptAmount">×¡×›×•×:</label>
                               <input type="number" id="receiptAmount" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptPaymentType">×¡×•×’ ×ª×©×œ×•×:</label>
                               <select id="receiptPaymentType" required>
                                   <option value="">×‘×—×¨ ×¡×•×’...</option>
                                   <option value="××–×•××Ÿ">××–×•××Ÿ</option>
                                   <option value="×¦'×§">×¦'×§</option>
                                   <option value="×”×¢×‘×¨×”">×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
                                   <option value="×‘×™×˜">×‘×™×˜</option>
                                   <option value="×¤×™×™×‘×•×§×¡">×¤×™×™×‘×•×§×¡</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label for="receiptNotes">×”×¢×¨×•×ª:</label>
                               <textarea id="receiptNotes"></textarea>
                           </div>
                           <button type="submit">×©××•×¨ ×§×‘×œ×”</button>
                       </form>
                   </div>
               </div>
           `;
           
           document.getElementById('modalContainer').innerHTML = modalHTML;
           document.getElementById('receiptModal').style.display = 'block';
           
           // Set default date to today
           document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
           
           // Populate locations select
           const select = document.getElementById('receiptlocations');
           locations.forEach(location => {
               const option = document.createElement('option');
               option.value = location.ID;
               option.textContent = `${location.name} - ${location.full_address}`;
               select.appendChild(option);
           });
       }

       async function handleReceiptSubmit(event) {
           event.preventDefault();
           
           const locationId = document.getElementById('receiptlocation').value;
           const location = locations.find(g => g.ID == locationId);
           
           const receiptData = {
				ID: Date.now(),
				book_number: document.getElementById('receiptBook').value,
				receipt_number: document.getElementById('receiptNumber').value,
				date: document.getElementById('receiptDate').value,
				location_id: locationId,        
				location_name: location ? location.name : '',  // ×©×•× ×” ×-location_name
				amount: parseFloat(document.getElementById('receiptAmount').value),
				payment_type: document.getElementById('receiptPaymentType').value,
				notes: document.getElementById('receiptNotes').value
			};
           
		   // ×ª×•×¡×¤×” - ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×œ×¤× ×™ ×©××™×¨×”
			const errors = validateReceiptData(receiptData);
			if (showValidationErrors(errors)) {
				return; // ×™×© ×©×’×™××•×ª - ×¢×¦×•×¨ ×›××Ÿ
			}
		   
		   // ×‘×“×™×§×ª ×›×¤×™×œ×•×™×•×ª ×§×‘×œ×”
			const existingReceipt = receipts.find(receipt => 
				(receipt.book_number === receiptData.book_number && receipt.receipt_number === receiptData.receipt_number) ||
				(receipt.location_id === receiptData.location_id && receipt.date === receiptData.date && receipt.amount === receiptData.amount)
			);

			if (existingReceipt) {
				if (!confirm(`×›×‘×¨ ×§×™×™××ª ×§×‘×œ×” ×¢× ××•×ª×• ××¡×¤×¨ ××• ×‘××•×ª×” ×›×ª×•×‘×ª/×ª××¨×™×š/×¡×›×•×.\n\n×”×× ×œ×”×•×¡×™×£ ×‘×›×œ ×–××ª?`)) {
					return; // ×‘×™×˜×•×œ ×”×•×¡×¤×”
				}
			}
		   
            receipts.push(receiptData);
		   
			if (access_token) {
				await saveReceiptToSheets(receiptData);
				showSuccess('×§×‘×œ×” × ×©××¨×” ×‘×”×¦×œ×—×” ×œ-Google Sheets!');
			} else {
				showSuccess('×§×‘×œ×” × ×©××¨×” ××§×•××™×ª!');
			}

			closeModal('receiptModal');
			loadReceiptsTable();
			saveToLocalStorage();
       }

       // Utility functions
       function closeModal(modalId) {
           document.getElementById(modalId).style.display = 'none';
       }

       function formatDate(dateString) {
           const date = new Date(dateString);
           return date.toLocaleDateString('he-IL');
       }

       function showLoading(message) {
           // Could implement loading spinner
           console.log('Loading:', message);
       }

       function hideLoading() {
           // Hide loading spinner
           console.log('Loading complete');
       }

       function showError(message) {
           // Show error message
           const errorDiv = document.createElement('div');
           errorDiv.className = 'error';
           errorDiv.textContent = message;
           document.querySelector('.main-content').insertBefore(errorDiv, document.querySelector('.main-content').firstChild);
           
           setTimeout(() => {
               errorDiv.remove();
           }, 5000);
       }

       function showSuccess(message) {
           // Show success message
           const successDiv = document.createElement('div');
           successDiv.className = 'success';
           successDiv.textContent = message;
           document.querySelector('.main-content').insertBefore(successDiv, document.querySelector('.main-content').firstChild);
           
           setTimeout(() => {
               successDiv.remove();
           }, 3000);
       }

       // Click outside modal to close
       window.onclick = function(event) {
           if (event.target.classList.contains('modal')) {
               event.target.style.display = 'none';
           }
       }
	   
	   function editReceipt(receiptId) {
			const receipt = receipts.find(r => r.ID == receiptId);
			if (!receipt) return;
			
			showAddReceiptForm();
			
			// Populate form with existing data
			setTimeout(() => {
				document.getElementById('receiptBook').value = receipt.book_number;
				document.getElementById('receiptNumber').value = receipt.receipt_number;
				document.getElementById('receiptDate').value = receipt.date;
				document.getElementById('receiptLocation').value = receipt.location_id;
				document.getElementById('receiptAmount').value = receipt.amount;
				document.getElementById('receiptPaymentType').value = receipt.payment_type;
				document.getElementById('receiptNotes').value = receipt.notes || '';
				
				// Change form submission to update instead of add
				document.getElementById('receiptForm').onsubmit = function(event) {
					event.preventDefault();
					updateReceipt(receiptId);
				};
				
				document.querySelector('.modal-header h3').textContent = '×¢×¨×™×›×ª ×§×‘×œ×”';
			}, 100);
		}

		function updateReceipt(receiptId) {
			const receipt = receipts.find(r => r.ID == receiptId);
			if (!receipt) return;
			
			const locationId = document.getElementById('receiptLocation').value;
			const location = locations.find(g => g.ID == locationId);
			
			receipt.book_number = document.getElementById('receiptBook').value;
			receipt.receipt_number = document.getElementById('receiptNumber').value;
			receipt.date = document.getElementById('receiptDate').value;
			receipt.location_id = locationId;
			receipt.location_name = location ? location.name : '';
			receipt.amount = parseFloat(document.getElementById('receiptAmount').value);
			receipt.payment_type = document.getElementById('receiptPaymentType').value;
			receipt.notes = document.getElementById('receiptNotes').value;
			
			closeModal('receiptModal');
			loadReceiptsTable();
			saveToLocalStorage();
			showSuccess('×§×‘×œ×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!');
		}

		function deleteReceipt(receiptId) {
			if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×§×‘×œ×”?')) {
				receipts = receipts.filter(r => r.ID != receiptId);
				loadReceiptsTable();
				saveToLocalStorage();
				showSuccess('×§×‘×œ×” × ××—×§×” ×‘×”×¦×œ×—×”!');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×”×•×“×¢×•×ª Toast ××ª×§×“××•×ª
		function showToast(message, type = 'info', duration = 3000) {
			// ×”×¡×¨ toast ×§×™×™×
			const existingToast = document.querySelector('.toast');
			if (existingToast) {
				existingToast.remove();
			}
			
			// ×¦×•×¨ toast ×—×“×©
			const toast = document.createElement('div');
			toast.className = `toast toast-${type}`;
			toast.textContent = message;
			
			// ×”×•×¡×£ styles
			toast.style.cssText = `
				position: fixed;
				top: 20px;
				right: 20px;
				padding: 12px 20px;
				border-radius: 6px;
				color: white;
				font-weight: bold;
				z-index: 10000;
				max-width: 400px;
				box-shadow: 0 4px 12px rgba(0,0,0,0.3);
				transform: translateX(100%);
				transition: transform 0.3s ease;
			`;
			
			// ×¦×‘×¢×™× ×œ×¤×™ ×¡×•×’
			const colors = {
				success: '#27ae60',
				error: '#e74c3c',
				warning: '#f39c12',
				info: '#3498db'
			};
			
			toast.style.backgroundColor = colors[type] || colors.info;
			
			document.body.appendChild(toast);
			
			// ×× ×™××¦×™×” ×›× ×™×¡×”
			setTimeout(() => {
				toast.style.transform = 'translateX(0)';
			}, 10);
			
			// ×”×¡×¨×” ××•×˜×•××˜×™×ª
			setTimeout(() => {
				toast.style.transform = 'translateX(100%)';
				setTimeout(() => toast.remove(), 300);
			}, duration);
		}
	   
	   
	    // ×™×¦×™×¨×ª ×˜×‘×œ×ª ×¢×–×¨ ×œ×™×™×‘×•×
		async function createImportTable() {
			if (!await validateToken()) {
				showToast('×”×ª×—×‘×¨ ×œ×’×•×’×œ ×§×•×“×', 'warning');
				return;
			}
			
			try {
				showToast('×™×•×¦×¨ ×˜×‘×œ×ª ×¢×–×¨ ×œ×™×™×‘×•×...', 'info');
				
				// ×™×¦×™×¨×ª ×˜×‘×œ×” ×—×“×©×” ×¢× access_token ×‘××§×•× API key
				const response = await gapi.client.sheets.spreadsheets.create({
					resource: {
						properties: {
							title: `Import_Helper_${new Date().toISOString().split('T')[0]}`
						},
						sheets: [{
							properties: { title: 'Locations' },
						}, {
							properties: { title: 'Visits' },
						}, {
							properties: { title: 'Receipts' }
						}]
					}
				});
				
				const newSpreadsheetId = response.result.spreadsheetId;
				
				// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×›×œ ×’×œ×™×•×Ÿ
				await addImportHeaders(newSpreadsheetId);
				
				// ×¤×ª×™×—×ª ×”×˜×‘×œ×”
				window.open(`https://docs.google.com/spreadsheets/d/${newSpreadsheetId}/edit`, '_blank');
				
				// ×©××™×¨×ª ID ×œ×™×™×‘×•× ×××•×—×¨ ×™×•×ª×¨
				localStorage.setItem('importTableId', newSpreadsheetId);
				
				showToast('×˜×‘×œ×ª ×¢×–×¨ × ×•×¦×¨×”! ×”×“×‘×§ ××ª ×”× ×ª×•× ×™× ×©×œ×š ×”×—×œ ××©×•×¨×” 2', 'success');
				
			} catch (error) {
				console.error('Error creating import table:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('âš ï¸ ×”×—×™×‘×•×¨ ×¤×’ ×‘××”×œ×š ×™×¦×™×¨×ª ×”×˜×‘×œ×”', 'warning');
				} else {
					showToast(`×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×‘×œ×ª ×¢×–×¨: ${error.result?.error?.message || error.message}`, 'error');
				}
				throw error;
				
			}
		}

		// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×˜×‘×œ×ª ×¢×–×¨
		async function addImportHeaders(spreadsheetId) {
			if (!await validateToken()) {
				showToast('×‘×¢×™×” ×‘×—×™×‘×•×¨ ×œ×’×•×’×œ ×‘××”×œ×š ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª', 'error');
				return;
			}

			try {
				const locationHeaders = [['ID', '×©× ×œ×§×•×—', '×¨×—×•×‘', '×‘×™×ª', '×¢×™×¨', '×ª×“×™×¨×•×ª', '××™×© ×§×©×¨', '×¡×›×•× ×‘×¡×™×¡×™']];
				const visitHeaders = [['ID', '×©× ×”', '×—×•×“×©', '×™×•×', '×œ×§×•×—', '××™×© ×§×©×¨', '×˜×™×¤×•×œ', '×ª××¨×™×š', '××” ×‘×•×¦×¢', '××©×š', '×¡×›×•×', '×©×•×œ×', '×”×•×¦××”', '×”×¢×¨×•×ª']];
				const receiptHeaders = [['ID', 'XK', '×¤× ×§×¡', '×§×‘×œ×”', '×©× ×”', '×—×•×“×©', '×™×•×', '×›×ª×•×‘×ª', '×¡×›×•×', '×¡×•×’', '×§×•×“X', '×”×¢×¨×•×ª', '×¤×™×¨×•×˜']];
				
				// ×”××ª×Ÿ ×§×¦×ª ×œ×˜×‘×œ×” ×œ×”×™×•×•×¦×¨
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				await Promise.all([
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Locations!A1:H1',
						valueInputOption: 'RAW',
						resource: { values: locationHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Visits!A1:N1',
						valueInputOption: 'RAW', 
						resource: { values: visitHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Receipts!A1:M1',
						valueInputOption: 'RAW',
						resource: { values: receiptHeaders }
					})
				]);
				
				console.log('Headers added successfully to import table');
				
			} catch (error) {
				console.error('Error adding headers:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('âš ï¸ ×”×—×™×‘×•×¨ ×¤×’ ×‘××”×œ×š ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª', 'warning');
				} else {
					showToast('âš ï¸ ×©×’×™××” ×‘×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×˜×‘×œ×”', 'error');
				}
				throw error;
			}
		}
		
		// ×ª×•×¡×¤×” - ×¤×™×¢× ×•×— ×›×ª×•×‘×ª ××œ××” ×œ×—×œ×§×™×
		function parseFullAddress(fullAddress) {
			if (!fullAddress) return { street: '', houseNumber: '', city: '' };
			
			const parts = fullAddress.trim().split(' ');
			
			if (parts.length >= 3) {
				// ×”×¢×™×¨ ×”×™× ×”×—×œ×§ ×”××—×¨×•×Ÿ
				const city = parts[parts.length - 1];
				
				// ××¡×¤×¨ ×”×‘×™×ª ×”×•× ×”×—×œ×§ ×”×œ×¤× ×™ ××—×¨×•×Ÿ
				const houseNumber = parts[parts.length - 2];
				
				// ×”×¨×—×•×‘ ×”×•× ×›×œ ×”×©××¨
				const street = parts.slice(0, -2).join(' ');
				
				return { street, houseNumber, city };
			} else if (parts.length === 2) {
				return { street: parts[0], houseNumber: '', city: parts[1] };
			} else {
				return { street: fullAddress, houseNumber: '', city: '' };
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×™×™×‘×•× ×œ×§×•×—×•×ª ××˜×‘×œ×ª ×¢×–×¨
		async function importCustomersFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('×˜×‘×œ×ª ×¢×–×¨ ×œ× × ××¦××” - ×¦×•×¨ ×§×•×“×', 'warning');
					return;
				}
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: importTableId,
					range: 'Locations!A2:H1000'
				});
				
				const rows = response.result.values || [];
				let importedCount = 0;
				
				for (const row of rows) {
					if (row.length > 1 && row[1]) { // ×™×© ×©× ×œ×§×•×—
						const customerName = row[1].trim();
						
						// ×‘×“×•×§ ×× ×œ×§×•×— ×›×‘×¨ ×§×™×™×
						const existingCustomer = locations.find(loc => 
							loc.full_address && 
							loc.full_address.toLowerCase() === customerName.toLowerCase()
						);
						
						if (existingCustomer) {
							showToast(`×œ×§×•×— ${customerName} ×›×‘×¨ ×§×™×™× - ×“×•×œ×’`, 'warning');
							continue;
						}
						
						// ×× ×™×© ×¨×—×•×‘ ×•×‘×™×ª × ×¤×¨×“×™× - ×”×©×ª××© ×‘×”×
						let street = row[2] || '';
						let houseNumber = row[3] || '';
						let city = row[4] || '';
						
						// ×× ×œ× - ×¤×¢× ×— ××”×©×
						if (!street && !houseNumber && !city) {
							const parsed = parseFullAddress(customerName);
							street = parsed.street;
							houseNumber = parsed.houseNumber;
							city = parsed.city;
						}
						
						const locationData = {
							ID: Date.now() + importedCount,
							name: customerName, // ×©× ×”×œ×§×•×— ×”×•× ×”×›×ª×•×‘×ª ×”××œ××”
							full_address: customerName, // ×–×” ×”××–×”×” ×”×™×™×—×•×“×™
							neighborhood: '', // ×¨×™×§ - ×™××•×œ× ×‘×”××©×š
							city: city,
							contact_person: row[6] || '', // ××™×© ×§×©×¨
							phone: '',
							allowed_day: '×›×œ ×™×•×',
							interval_weeks: parseInt(row[5]) || 4, // ×ª×“×™×¨×•×ª
							temp_addition: 0,
							base_amount: parseFloat(row[7]) || 0, // ×¡×›×•× ×‘×¡×™×¡×™
							active: '×›×Ÿ',
							notes: '×™×•×‘× ××˜×‘×œ×ª ×œ×§×•×—×•×ª',
							last_visit: '',
							next_visit: ''
						};
						
						locations.push(locationData);
						importedCount++;
					}
				}
				
				// ×©××™×¨×”
				await saveAllToSheets();
				loadLocationsTable();
				loadLocationsForSelect();
				
				showToast(`×™×•×‘××• ${importedCount} ×œ×§×•×—×•×ª ×‘×”×¦×œ×—×”!`, 'success');
				
			} catch (error) {
				console.error('Error importing customers:', error);
				showToast('×©×’×™××” ×‘×™×™×‘×•× ×œ×§×•×—×•×ª', 'error');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×™×™×‘×•× ×˜×™×¤×•×œ×™× ××˜×‘×œ×ª ×¢×–×¨
		async function importVisitsFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('×˜×‘×œ×ª ×¢×–×¨ ×œ× × ××¦××” - ×¦×•×¨ ×§×•×“×', 'warning');
					return;
				}
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: importTableId,
					range: 'Visits!A2:N1000'
				});
				
				const rows = response.result.values || [];
				let importedCount = 0;
				let notFoundCustomers = [];
				
				for (const row of rows) {
					if (row.length > 4 && row[4]) { // ×™×© ×œ×§×•×—
						const customerAddress = row[4].trim(); // ×¢××•×“×” "×œ×§×•×—"
						
						// ××¦× ×œ×§×•×— ×§×™×™× ×œ×¤×™ ×›×ª×•×‘×ª ××œ××”
						const existingCustomer = locations.find(loc => 
							loc.full_address && 
							loc.full_address.toLowerCase() === customerAddress.toLowerCase()
						);
						
						if (!existingCustomer) {
							if (!notFoundCustomers.includes(customerAddress)) {
								notFoundCustomers.push(customerAddress);
							}
							continue;
						}
						
						// ×‘× ×™×™×ª ×ª××¨×™×š ××”×¢××•×“×•×ª ×©× ×”/×—×•×“×©/×™×•× ××• ××¢××•×“×” "×ª××¨×™×š"
						let visitDate = '';
						if (row[7]) { // ×™×© ×ª××¨×™×š ×‘×¤×•×¨××˜ DD/MM/YYYY
							visitDate = convertDateFormat(row[7]);
						} else if (row[1] && row[2] && row[3]) { // ×™×© ×©× ×”/×—×•×“×©/×™×•×
							const year = row[1];
							const month = String(row[2]).padStart(2, '0');
							const day = String(row[3]).padStart(2, '0');
							visitDate = `${year}-${month}-${day}`;
						}
						
						const visitData = {
							ID: Date.now() + importedCount,
							date: visitDate,
							location_id: existingCustomer.ID,
							visit_type: row[6] || '××œ×', // ×¢××•×“×” "×˜×™×¤×•×œ"
							work_done: row[8] || '', // ×¢××•×“×” "××” ×‘×•×¦×¢"
							duration_minutes: parseFloat(row[9]) * 60 || 0, // ××©×š ×‘×©×¢×•×ª â†’ ×“×§×•×ª
							start_time: '',
							end_time: '',
							amount: parseFloat(row[10]) || 0, // ×¡×›×•×
							expense: parseFloat(row[12]) || 0, // ×”×•×¦××”
							paid: row[11] === '×›×Ÿ' ? '×›×Ÿ' : '×œ×', // ×©×•×œ×
							notes: row[13] || '' // ×”×¢×¨×•×ª
						};
						
						visits.push(visitData);
						importedCount++;
					}
				}
				
				// ×©××™×¨×”
				await saveAllToSheets();
				loadPlanningData();
				
				let message = `×™×•×‘××• ${importedCount} ×˜×™×¤×•×œ×™× ×‘×”×¦×œ×—×”!`;
				if (notFoundCustomers.length > 0) {
					message += `\nâš ï¸ ${notFoundCustomers.length} ×œ×§×•×—×•×ª ×œ× × ××¦××•: ${notFoundCustomers.slice(0, 3).join(', ')}${notFoundCustomers.length > 3 ? '...' : ''}`;
				}
				
				showToast(message, 'success');
				
			} catch (error) {
				console.error('Error importing visits:', error);
				showToast('×©×’×™××” ×‘×™×™×‘×•× ×˜×™×¤×•×œ×™×', 'error');
			}
		}
	   
	   
	   // ×ª×•×¡×¤×” - ×™×™×‘×•× ×§×‘×œ×•×ª ××˜×‘×œ×ª ×¢×–×¨
		async function importReceiptsFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('×˜×‘×œ×ª ×¢×–×¨ ×œ× × ××¦××” - ×¦×•×¨ ×§×•×“×', 'warning');
					return;
				}
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: importTableId,
					range: 'Receipts!A2:M1000'
				});
				
				const rows = response.result.values || [];
				let importedCount = 0;
				let notFoundCustomers = [];
				
				for (const row of rows) {
					if (row.length > 7 && row[7]) { // ×™×© ×›×ª×•×‘×ª
						const customerAddress = row[7].trim(); // ×¢××•×“×” "×›×ª×•×‘×ª"
						
						// ××¦× ×œ×§×•×— ×§×™×™× ×œ×¤×™ ×›×ª×•×‘×ª ××œ××”
						const existingCustomer = locations.find(loc => 
							loc.full_address && 
							loc.full_address.toLowerCase() === customerAddress.toLowerCase()
						);
						
						if (!existingCustomer) {
							if (!notFoundCustomers.includes(customerAddress)) {
								notFoundCustomers.push(customerAddress);
							}
							continue;
						}
						
						// ×‘× ×™×™×ª ×ª××¨×™×š ××”×¢××•×“×•×ª ×©× ×”/×—×•×“×©/×™×•×
						let receiptDate = '';
						if (row[4] && row[5] && row[6]) {
							const year = row[4];
							const month = String(row[5]).padStart(2, '0');
							const day = String(row[6]).padStart(2, '0');
							receiptDate = `${year}-${month}-${day}`;
						}
						
						const receiptData = {
							ID: Date.now() + importedCount,
							book_number: row[2] || '', // ×¤× ×§×¡
							receipt_number: row[3] || '', // ×§×‘×œ×”
							date: receiptDate,
							location_id: existingCustomer.ID,
							location_name: customerAddress,
							amount: parseFloat(row[8]) || 0, // ×¡×›×•×
							payment_type: row[9] || '', // ×¡×•×’
							codeX: row[1] || '', // XK â†’ ×§×•×“X
							notes: `${row[11] || ''} ${row[12] || ''}`.trim() // ×”×¢×¨×•×ª + ×¤×™×¨×•×˜
						};
						
						receipts.push(receiptData);
						importedCount++;
					}
				}
				
				// ×©××™×¨×”
				await saveAllToSheets();
				loadReceiptsTable();
				
				let message = `×™×•×‘××• ${importedCount} ×§×‘×œ×•×ª ×‘×”×¦×œ×—×”!`;
				if (notFoundCustomers.length > 0) {
					message += `\nâš ï¸ ${notFoundCustomers.length} ×œ×§×•×—×•×ª ×œ× × ××¦××•: ${notFoundCustomers.slice(0, 3).join(', ')}${notFoundCustomers.length > 3 ? '...' : ''}`;
				}
				
				showToast(message, 'success');
				
			} catch (error) {
				console.error('Error importing receipts:', error);
				showToast('×©×’×™××” ×‘×™×™×‘×•× ×§×‘×œ×•×ª', 'error');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×”××¨×ª ×¤×•×¨××˜ ×ª××¨×™×š ×-DD/MM/YYYY ×œ-YYYY-MM-DD
		function convertDateFormat(dateStr) {
			if (!dateStr) return '';
			
			const parts = dateStr.split('/');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = parts[1].padStart(2, '0');
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			
			return dateStr;
		}
	   
	   
	   // ×ª×•×¡×¤×” - ×™×™×‘×•× ××œ× ××˜×‘×œ×ª ×”×¢×–×¨
		async function importFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('×˜×‘×œ×ª ×¢×–×¨ ×œ× × ××¦××” - ×¦×•×¨ ×§×•×“×', 'warning');
					return;
				}
				
				showToast('××ª×—×™×œ ×™×™×‘×•× ××œ×...', 'info');
				
				// ×™×™×‘×•× ×‘×¡×“×¨: ×œ×§×•×—×•×ª â†’ ×˜×™×¤×•×œ×™× â†’ ×§×‘×œ×•×ª
				await importCustomersFromHelper();
				await new Promise(resolve => setTimeout(resolve, 1000)); // ×”××ª× ×” ×§×¦×¨×”
				
				await importVisitsFromHelper();
				await new Promise(resolve => setTimeout(resolve, 1000)); // ×”××ª× ×” ×§×¦×¨×”
				
				await importReceiptsFromHelper();
				
				showToast('ğŸ‰ ×™×™×‘×•× ××œ× ×”×•×©×œ× ×‘×”×¦×œ×—×”!', 'success', 5000);
				
				setTimeout(() => {
					if (confirm('×™×™×‘×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”!\n\n×”×× ×œ××—×•×§ ××ª ×˜×‘×œ×ª ×”×¢×–×¨ ××”-Google Drive?')) {
						showToast('ğŸ’¡ × ×™×ª×Ÿ ×œ××—×•×§ ××ª ×˜×‘×œ×ª ×”×¢×–×¨ ×™×“× ×™×ª ×‘×’×•×’×œ ×“×¨×™×™×‘', 'info');
						localStorage.removeItem('importTableId');
					}
				}, 2000);
				
			} catch (error) {
				console.error('Error in full import:', error);
				showToast('×©×’×™××” ×‘×™×™×‘×•× ××œ×', 'error');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×‘×“×™×§×ª ×ª×§×™× ×•×ª × ×ª×•× ×™×
		function validateReceiptData(receiptData) {
			const errors = [];
			
			if (!receiptData.location_id) {
				errors.push('×—×•×‘×” ×œ×‘×—×•×¨ ×œ×§×•×—');
			}
			
			if (!receiptData.amount || receiptData.amount <= 0) {
				errors.push('×—×•×‘×” ×œ×”×–×™×Ÿ ×¡×›×•× ×—×™×•×‘×™');
			}
			
			if (!receiptData.date) {
				errors.push('×—×•×‘×” ×œ×”×–×™×Ÿ ×ª××¨×™×š');
			}
			
			return errors;
		}

		function showValidationErrors(errors) {
			if (errors.length > 0) {
				showToast(errors.join('\n'), 'error');
				return true; // ×™×© ×©×’×™××•×ª
			}
			return false; // ××™×Ÿ ×©×’×™××•×ª
		}
	   
	   
	    // ×ª×•×¡×¤×” - × ×™×”×•×œ ×¤×× ×œ×™ ×¡×™× ×•×Ÿ ×•××™×“×¢
		function toggleFilterPanel() {
			const content = document.getElementById('filterContent');
			const icon = document.getElementById('filterIcon');
			
			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				icon.textContent = 'ğŸ”½';
			} else {
				content.classList.add('collapsed');
				icon.textContent = 'ğŸ”¼';
			}
		}

		function toggleInfoPanel() {
			const content = document.getElementById('infoContent');
			const icon = document.getElementById('infoIcon');
			
			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				icon.textContent = 'ğŸ”½';
			} else {
				content.classList.add('collapsed');
				icon.textContent = 'ğŸ”¼';
			}
		}

		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ××¤×©×¨×•×™×•×ª ×¡×™× ×•×Ÿ
		function loadFilterOptions() {
			const locationSelect = document.getElementById('filterLocation');
			locationSelect.innerHTML = '<option value="">×›×œ ×”×œ×§×•×—×•×ª</option>';
			
			locations.forEach(location => {
				const option = document.createElement('option');
				option.value = location.ID;
				option.textContent = location.name;
				locationSelect.appendChild(option);
			});
		}
	   
		// ×ª×•×¡×¤×” - ×¡×™× ×•×Ÿ ×•×˜×¢×™× ×ª ×˜×™×¤×•×œ×™×
		function applyVisitFilters() {
			const locationFilter = document.getElementById('filterLocation').value;
			const paymentFilter = document.getElementById('filterPayment').value;
			const dateFromFilter = document.getElementById('filterDateFrom').value;
			const dateToFilter = document.getElementById('filterDateTo').value;
			
			let filteredVisits = visits.filter(visit => {
				// ×¡×™× ×•×Ÿ ×œ×¤×™ ×œ×§×•×—
				if (locationFilter && visit.location_id != locationFilter) {
					return false;
				}
				
				// ×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×˜×˜×•×¡ ×ª×©×œ×•×
				if (paymentFilter && visit.paid !== paymentFilter) {
					return false;
				}
				
				// ×¡×™× ×•×Ÿ ×œ×¤×™ ×ª××¨×™×š
				if (dateFromFilter && visit.date < dateFromFilter) {
					return false;
				}
				
				if (dateToFilter && visit.date > dateToFilter) {
					return false;
				}
				
				return true;
			});
			
			displayFilteredVisits(filteredVisits);
			updateVisitsInfo(filteredVisits);
		}

		function clearVisitFilters() {
			document.getElementById('filterLocation').value = '';
			document.getElementById('filterPayment').value = '';
			document.getElementById('filterDateFrom').value = '';
			document.getElementById('filterDateTo').value = '';
			
			displayFilteredVisits(visits);
			updateVisitsInfo(visits);
		}

		// ×ª×•×¡×¤×” - ×”×¦×’×ª ×˜×™×¤×•×œ×™× ××¡×•× × ×™×
		function displayFilteredVisits(filteredVisits) {
			const tbody = document.getElementById('visitsHistoryTableBody');
			tbody.innerHTML = '';
			
			if (filteredVisits.length === 0) {
				tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">××™×Ÿ ×˜×™×¤×•×œ×™× ×ª×•×××™× ×œ×¡×™× ×•×Ÿ</td></tr>';
				return;
			}
			
			// ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š (×”×—×“×©×™× ×¨××©×•× ×™×)
			filteredVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
			
			filteredVisits.forEach(visit => {
				const location = locations.find(loc => loc.ID == visit.location_id);
				const locationName = location ? location.name : '×œ× × ××¦×';
				
				const row = document.createElement('tr');
				
				// ×”×“×’×©×ª ×©×•×¨×•×ª ×œ×¤×™ ×¡×˜×˜×•×¡ ×ª×©×œ×•×
				if (visit.paid === '×œ×') {
					row.style.backgroundColor = '#fff2cc'; // ×¦×”×•×‘ ×¢×“×™×Ÿ ×œ×—×•×‘×•×ª
				} else if (visit.paid === '×›×Ÿ') {
					row.style.backgroundColor = '#d4edda'; // ×™×¨×•×§ ×¢×“×™×Ÿ ×œ×©×•×œ×
				}
				
				row.innerHTML = `
					<td>${formatDate(visit.date)}</td>
					<td>${locationName}</td>
					<td>${visit.visit_type}</td>
					<td>${visit.work_done}</td>
					<td>${(visit.duration_minutes / 60).toFixed(2)}</td>
					<td>â‚ª${visit.amount}</td>
					<td>
						<span class="payment-status payment-${visit.paid}">
							${visit.paid === '×›×Ÿ' ? 'âœ… ×©×•×œ×' : visit.paid === '×œ×' ? 'âŒ ×œ× ×©×•×œ×' : 'âšª ×œ×œ×'}
						</span>
					</td>
					<td>
						<button class="action-btn edit-btn" onclick="editVisit(${visit.ID})">×¢×¨×•×š</button>
						<button class="action-btn delete-btn" onclick="deleteVisit(${visit.ID})">××—×§</button>
					</td>
				`;
				tbody.appendChild(row);
			});
		}

		// ×ª×•×¡×¤×” - ×¢×“×›×•×Ÿ ×¤×× ×œ ×”××™×“×¢
		function updateVisitsInfo(filteredVisits) {
			const visitsCount = filteredVisits.length;
			const totalHours = filteredVisits.reduce((sum, visit) => sum + (visit.duration_minutes / 60), 0);
			const totalIncome = filteredVisits.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			const outstandingDebt = filteredVisits
				.filter(visit => visit.paid === '×œ×')
				.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			document.getElementById('visitsCount').textContent = visitsCount;
			document.getElementById('totalHours').textContent = totalHours.toFixed(2);
			document.getElementById('totalIncome').textContent = `â‚ª${totalIncome.toLocaleString()}`;
			document.getElementById('outstandingDebt').textContent = `â‚ª${outstandingDebt.toLocaleString()}`;
			
			// ×”×“×’×©×ª ×—×•×‘×•×ª ×¤×ª×•×—×™×
			const debtElement = document.getElementById('outstandingDebt');
			if (outstandingDebt > 0) {
				debtElement.style.color = '#e74c3c';
				debtElement.style.fontWeight = 'bold';
			} else {
				debtElement.style.color = '#27ae60';
				debtElement.style.fontWeight = 'bold';
			}
		}

		// ×ª×•×¡×¤×” - ×˜×¢×™× ×” ×¨××©×•× ×™×ª ×©×œ ×”×˜××‘
		function loadVisitsHistory() {
			loadFilterOptions();
			displayFilteredVisits(visits);
			updateVisitsInfo(visits);
		}

		// ×ª×•×¡×¤×” - ×¤×•× ×§×¦×™×•×ª ×¢×¨×™×›×” ×•××—×™×§×”
		function editVisit(visitId) {
			// ×›××Ÿ ×ª×•×›×œ ×œ×”×•×¡×™×£ ××•×“×œ ×¢×¨×™×›×”
			showToast('×¢×¨×™×›×ª ×˜×™×¤×•×œ - ×™×ª×•×•×¡×£ ×‘×”××©×š', 'info');
		}

		function deleteVisit(visitId) {
			if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×˜×™×¤×•×œ?')) {
				visits = visits.filter(visit => visit.ID != visitId);
				applyVisitFilters(); // ×¨×¢× ×Ÿ ×ª×¦×•×’×”
				saveToLocalStorage();
				showToast('×˜×™×¤×•×œ × ××—×§ ×‘×”×¦×œ×—×”!', 'success');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×‘×“×™×§×ª ×¨×©××•×ª
		async function checkPermissions() {
			if (!access_token) {
				showToast('×œ× ××—×•×‘×¨ ×œ×’×•×’×œ - ×”×ª×—×‘×¨ ×§×•×“×', 'warning');
				return false;
			}
			
			try {
				// × ×¡×” ×œ×’×©×ª ×œ×˜×‘×œ×” ×”×¨××©×™×ª
				await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				return true;
			} catch (error) {
				if (error.status === 401) {
					showToast('×”×—×™×‘×•×¨ ×¤×’ - ×”×ª×—×‘×¨ ××—×“×©', 'warning');
					access_token = null;
				} else if (error.status === 403) {
					showToast('××™×Ÿ ×”×¨×©××” ×œ×˜×‘×œ×” - ×‘×“×•×§ ×©×™×ª×•×£', 'error');
				}
				return false;
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×‘×“×™×§×ª ×ª×§×™× ×•×ª ××¡×™××•×Ÿ
		async function validateToken() {
			if (!access_token || !gapi.client) {
				return false;
			}
			
			try {
				// ×‘×“×™×§×” ×¤×©×•×˜×” - × ×¡×” ×œ×§×¨×•× ××”×˜×‘×œ×”
				await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID || 'test'
				});
				return true;
			} catch (error) {
				if (error.status === 401) {
					console.log('Google token expired');
					access_token = null;
					document.getElementById('statusText').textContent = 'ğŸ”“ × ×“×¨×© ×—×™×‘×•×¨ ××—×“×©';
					document.getElementById('statusText').classList.remove('connected');
					showToast('âš ï¸ ×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×”×ª×—×‘×¨ ××—×“×©', 'warning');
					return false;
				}
				return false;
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×‘×“×™×§×” ×ª×§×•×¤×ª×™×ª ×©×œ ×—×™×‘×•×¨
		setInterval(async () => {
			if (access_token) {
				const isValid = await validateToken();
				if (!isValid) {
					console.log('Token expired - disconnected');
				}
			}
		}, 300000); // ×‘×“×™×§×” ×›×œ 5 ×“×§×•×ª
	   
   </script>
</body>
</html>
