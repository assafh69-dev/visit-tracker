<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×˜×™×¤×•×œ×™× ×•×œ×§×•×—×•×ª</title>
	
	<script src="https://apis.google.com/js/api.js"></script>
	<script src="https://accounts.google.com/gsi/client"></script>
	
    <style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			direction: rtl;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}

		/* Header ××¢×•×¦×‘ */
		.header {
			background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
			border-radius: 15px;
			padding: 30px;
			margin-bottom: 20px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.3);
			color: white;
		}

		.header h1 {
			font-size: 2.5em;
			margin-bottom: 10px;
			text-align: center;
			text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
			background: linear-gradient(45deg, #3498db, #2ecc71);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}

		/* Connection Status ××¢×•×¦×‘ */
		.connection-status {
			text-align: center;
			margin: 20px 0;
			padding: 20px;
			background: rgba(255,255,255,0.1);
			border-radius: 15px;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255,255,255,0.2);
		}

		.connect-btn {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 12px 24px;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			margin: 5px;
			transition: all 0.3s ease;
			box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
		}

		.connect-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
		}

		.connect-btn:disabled {
			background: #95a5a6;
			cursor: not-allowed;
			transform: none;
		}

		/* Navigation ××¢×•×¦×‘ */
		.nav-buttons {
			display: flex;
			gap: 15px;
			justify-content: center;
			flex-wrap: wrap;
			margin-top: 20px;
		}

		.nav-btn {
			padding: 15px 25px;
			border: none;
			background: rgba(255,255,255,0.1);
			color: white;
			border-radius: 10px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255,255,255,0.2);
		}

		.nav-btn:hover {
			background: rgba(255,255,255,0.2);
			transform: translateY(-2px);
		}

		.nav-btn.active {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
			transform: translateY(-2px);
		}

		/* Main Content ××¢×•×¦×‘ */
		.main-content {
			background: rgba(255,255,255,0.95);
			border-radius: 15px;
			padding: 30px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.2);
			backdrop-filter: blur(10px);
		}

		.section {
			display: none;
		}

		.section.active {
			display: block;
		}

		.section h2 {
			color: #2c3e50;
			margin-bottom: 30px;
			padding-bottom: 15px;
			border-bottom: 3px solid #3498db;
			font-size: 1.8em;
			position: relative;
		}

		.section h2::before {
			content: '';
			position: absolute;
			bottom: -3px;
			left: 0;
			width: 60px;
			height: 3px;
			background: linear-gradient(45deg, #e74c3c, #f39c12);
			border-radius: 2px;
		}

		/* Forms ××¢×•×¦×‘×™× */
		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			margin-bottom: 8px;
			color: #2c3e50;
			font-weight: bold;
			font-size: 14px;
		}

		.form-group input, .form-group select, .form-group textarea {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #e9ecef;
			border-radius: 8px;
			font-size: 14px;
			transition: all 0.3s ease;
			background: white;
		}

		.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
			transform: translateY(-1px);
		}

		/* Buttons ××¢×•×¦×‘×™× */
		.add-btn {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
			border: none;
			padding: 15px 30px;
			border-radius: 10px;
			cursor: pointer;
			margin-bottom: 20px;
			font-size: 16px;
			font-weight: bold;
			transition: all 0.3s ease;
			box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
		}

		.add-btn:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
		}

		.action-btn {
			padding: 8px 16px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 12px;
			margin: 0 3px;
			transition: all 0.3s ease;
			font-weight: bold;
		}

		.edit-btn {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
		}

		.edit-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
		}

		.delete-btn {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			color: white;
		}

		.delete-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
		}

		/* Tables ××¢×•×¦×‘×•×ª */
		.table-container {
			background: white;
			border-radius: 12px;
			overflow: hidden;
			box-shadow: 0 8px 25px rgba(0,0,0,0.15);
			margin-top: 20px;
		}

		.data-table {
			width: 100%;
			border-collapse: collapse;
			background: white;
		}

		.data-table thead {
			background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
			color: white;
		}

		.data-table th {
			padding: 15px 12px;
			text-align: right;
			font-weight: bold;
			border-bottom: 2px solid #3498db;
		}

		.data-table td {
			padding: 12px;
			border-bottom: 1px solid #ecf0f1;
			transition: background 0.3s ease;
		}

		.data-table tbody tr:hover {
			background: #f8f9fa;
			transform: scale(1.01);
		}

		.data-table tbody tr:nth-child(even) {
			background: #fbfcfd;
		}

		/* Filter Panels ××¢×•×¦×‘×™× */
		.filter-panel, .info-panel {
			background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%);
			border: 2px solid #95a5a6;
			border-radius: 12px;
			margin-bottom: 20px;
			overflow: hidden;
			box-shadow: 0 5px 15px rgba(0,0,0,0.1);
		}

		.filter-header, .info-header {
			background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
			padding: 15px 20px;
			cursor: pointer;
			color: white;
			transition: all 0.3s ease;
			border-bottom: 2px solid #3498db;
		}

		.filter-header:hover, .info-header:hover {
			background: linear-gradient(135deg, #4a6741 0%, #2c3e50 100%);
		}

		.filter-content, .info-content {
			padding: 25px;
			display: block;
			background: white;
		}

		.filter-content.collapsed, .info-content.collapsed {
			display: none;
		}

		/* Submit Button ××¢×•×¦×‘ */
		button[type="submit"] {
			width: 100%;
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 18px;
			border-radius: 10px;
			cursor: pointer;
			font-size: 18px;
			font-weight: bold;
			margin-top: 20px;
			transition: all 0.3s ease;
			box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
		}

		button[type="submit"]:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
		}

		/* Mobile Responsive */
		@media (max-width: 768px) {
			.container {
				padding: 10px;
			}
			
			.header {
				padding: 20px 15px;
			}
			
			.header h1 {
				font-size: 1.8em;
			}
			
			.nav-buttons {
				gap: 8px;
			}
			
			.nav-btn {
				padding: 12px 16px;
				font-size: 12px;
			}
			
			.main-content {
				padding: 20px 15px;
			}
		}

		/* Toast Notifications */
		.toast-container {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 1000;
			max-width: 300px;
		}

		.toast {
			background: linear-gradient(45deg, #2c3e50, #3498db);
			color: white;
			padding: 15px 20px;
			border-radius: 8px;
			margin-bottom: 10px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
			transform: translateX(400px);
			opacity: 0;
			transition: all 0.3s ease;
			border-right: 4px solid #27ae60;
			font-weight: bold;
		}

		.toast.success {
			border-right-color: #27ae60;
			background: linear-gradient(45deg, #27ae60, #2ecc71);
		}

		.toast.error {
			border-right-color: #e74c3c;
			background: linear-gradient(45deg, #e74c3c, #c0392b);
		}

		.toast.warning {
			border-right-color: #f39c12;
			background: linear-gradient(45deg, #f39c12, #e67e22);
		}

		.toast.info {
			border-right-color: #3498db;
			background: linear-gradient(45deg, #3498db, #2980b9);
		}

		.toast.show {
			transform: translateX(0);
			opacity: 1;
		}

		@media (max-width: 768px) {
			.toast-container {
				left: 10px;
				right: 10px;
				top: 10px;
				max-width: none;
			}
			
			.toast {
				transform: translateY(-100px);
			}
			
			.toast.show {
				transform: translateY(0);
			}
		}
		

		/* ×›×¤×ª×•×¨×™× ×›×œ×œ×™×™× */
		.btn {
			padding: 12px 20px;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			box-shadow: 0 3px 10px rgba(0,0,0,0.2);
			min-width: 120px;
		}

		.btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(0,0,0,0.3);
		}

		.btn-primary {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
		}

		.btn-success {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
		}

		.btn-warning {
			background: linear-gradient(45deg, #f39c12, #e67e22);
			color: white;
		}

		.btn-secondary {
			background: linear-gradient(45deg, #95a5a6, #7f8c8d);
			color: white;
		}

		.btn-info {
			background: linear-gradient(45deg, #17a2b8, #138496);
			color: white;
		}

		/* ×›×¤×ª×•×¨×™ ×¤×™×œ×˜×¨ */
		.filter-btn {
			padding: 10px 18px;
			border: 2px solid #3498db;
			background: linear-gradient(45deg, #ecf0f1, #bdc3c7);
			color: #2c3e50;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			min-width: 100px;
		}

		.filter-btn:hover {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
		}

		.filter-btn.active {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
		}

		/* ×¨×©×™××•×ª × ×¤×ª×—×•×ª */
		select, .form-group select {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			cursor: pointer;
			min-height: 45px;
		}

		select:focus, .form-group select:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		select:hover {
			border-color: #7f8c8d;
			background: white;
		}

		/* ×©×“×•×ª ×ª××¨×™×š */
		input[type="date"] {
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			min-height: 45px;
		}

		input[type="date"]:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		/* ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×•×ª ×¤×™×œ×˜×¨ */
		.filter-actions .btn {
			margin: 5px 8px;
			padding: 10px 20px;
			font-size: 14px;
			min-width: 100px;
		}

		/* ×›×¤×ª×•×¨×™ ×™×™×‘×•× ×‘××¢×¨×›×ª */
		.form-section .btn {
			margin: 8px 5px;
			padding: 12px 20px;
			font-size: 14px;
			font-weight: bold;
			min-width: 150px;
		}

		/* ×©×™×¤×•×¨ × ×•×¡×£ ×œ×›×¤×ª×•×¨×™× ×§×˜× ×™× */
		.action-btn {
			padding: 10px 16px;
			font-size: 13px;
			font-weight: bold;
			min-width: 80px;
		}

		/* ×›×¤×ª×•×¨×™× ××•×§×¤×¦×™× (disabled) */
		button:disabled, .btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none !important;
			box-shadow: none !important;
		}

		/* ×©×™×¤×•×¨ ×œ×ª×™×‘×•×ª ×˜×§×¡×˜ */
		input[type="text"], input[type="number"], textarea {
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			min-height: 45px;
		}

		input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		/* ×©×™×¤×•×¨ ×œ×›×•×ª×¨×•×ª ×‘×¤×× ×œ×™× */
		.filter-header h3, .info-header h3 {
			font-size: 16px;
			font-weight: bold;
			margin: 0;
			text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
		}

		/* ××•×‘×™×™×œ - ×”×ª×××•×ª */
		@media (max-width: 768px) {
			.btn {
				padding: 10px 15px;
				font-size: 13px;
				min-width: 100px;
			}
			
			select, input[type="date"], input[type="text"], input[type="number"] {
				padding: 10px 12px;
				font-size: 13px;
				min-height: 40px;
			}
		}
		
		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
		}

		.stat-item {
			background: rgba(255,255,255,0.7);
			padding: 15px;
			border-radius: 8px;
			border-left: 4px solid #27ae60;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			backdrop-filter: blur(5px);
		}

		.stat-label {
			display: block;
			font-weight: bold;
			color: #495057;
			margin-bottom: 5px;
			font-size: 14px;
		}

		.stat-value {
			font-size: 1.4em;
			font-weight: bold;
			color: #2c3e50;
		}

		@media (max-width: 768px) {
			.stats-grid {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		.debt-card .summary-value {
			color: #e74c3c !important;
			font-weight: bold;
		}

		.debts-table tr:hover {
			background-color: #f8f9fa !important;
		}

		.action-btn {
			margin: 1px;
			padding: 4px 8px;
			font-size: 12px;
			border-radius: 3px;
			border: none;
			color: white;
			cursor: pointer;
		}

		.action-btn:hover {
			opacity: 0.8;
		}

		#statusText {
			transition: all 0.3s ease;
			padding: 8px 12px;
			border-radius: 6px;
			font-size: 14px;
		}

		#statusText.connected {
			background: linear-gradient(45deg, #28a745, #20c997);
			color: white;
			box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
		}


		/* ×ª×¦×•×’×ª ×ª×›× ×•×Ÿ - ×©×•×¨×•×ª ×›×¤×•×œ×•×ª */
			.planning-cards-container {
				min-height: 300px;
				border: 2px dashed #ddd;
				border-radius: 10px;
				padding: 15px;
				background: #fafafa;
				margin-bottom: 20px;
			}

			.planning-client-row {
				background: white;
				border-radius: 8px;
				margin-bottom: 12px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
				transition: all 0.3s ease;
			}

			.planning-client-row:hover {
				transform: translateY(-1px);
				box-shadow: 0 4px 8px rgba(0,0,0,0.15);
			}

			/***************************************************************/	
			/* ×¦×‘×¢×™ ×¨××–×•×¨ */
			/* ×¦×‘×¢×™ ×¡×˜×˜×•×¡ ××©×•×¤×¨×™× ×œ×ª×›× ×•×Ÿ */
			.planning-status-green { 
				border-right: 4px solid #27ae60;
				background: linear-gradient(90deg, rgba(39, 174, 96, 0.1), white);
			}

			.planning-status-yellow { 
				border-right: 4px solid #f39c12;
				background: linear-gradient(90deg, rgba(243, 156, 18, 0.1), white);
			}

			.planning-status-orange { 
				border-right: 4px solid #e67e22;
				background: linear-gradient(90deg, rgba(230, 126, 34, 0.1), white);
			}

			.planning-status-red { 
				border-right: 4px solid #e74c3c;
				background: linear-gradient(90deg, rgba(231, 76, 60, 0.1), white);
			}

			.planning-status-gray {
				border-right: 4px solid #95a5a6;
				background: linear-gradient(90deg, rgba(149, 165, 166, 0.1), white);
			}

			/* ×›×¤×ª×•×¨ ×”×ª×—×œ ×˜×™×¤×•×œ ××¢×•×¦×‘ */
			.planning-complete {
				background: linear-gradient(45deg, #27ae60, #2ecc71);
				color: white;
				font-size: 14px;
				font-weight: bold;
				width: 36px;
				height: 36px;
			}

			.planning-complete:hover {
				background: linear-gradient(45deg, #219a52, #27ae60);
				transform: scale(1.05);
			}

			/* ×¢×™×¦×•×‘ ××©×•×¤×¨ ×œ×›×•×ª×¨×•×ª ×™×•× ×‘×©×‘×•×¢ */
			.weekly-day-header {
				background: linear-gradient(45deg, #3498db, #2980b9);
				color: white;
				padding: 12px 15px;
				border-radius: 8px;
				margin-bottom: 12px;
				font-size: 15px;
				font-weight: bold;
				text-align: center;
				box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
			}
			
			
			
			
			/****************************************************************/
			.planning-row-main {
				display: flex;
				align-items: center;
				padding: 12px 15px;
				gap: 15px;
			}

			.planning-client-info {
				flex: 1;
				text-align: right;
			}

			.planning-client-name {
				font-weight: bold;
				font-size: 16px;
				color: #333;
				margin-bottom: 3px;
			}

			.planning-client-address {
				font-size: 12px;
				color: #666;
				margin-bottom: 3px;
			}

			.planning-client-date {
				font-size: 12px;
				color: #555;
				font-weight: 500;
			}

			.planning-client-price {
				font-weight: bold;
				color: #2196F3;
				font-size: 16px;
				min-width: 80px;
				text-align: center;
			}

			.planning-client-actions {
				display: flex;
				gap: 8px;
			}

			.planning-action-btn {
				width: 32px;
				height: 32px;
				border: none;
				border-radius: 50%;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 12px;
				transition: all 0.3s ease;
			}

			
			.planning-postpone {
				background: #FF9800;
				color: white;
			}

			.planning-menu {
				background: #607D8B;
				color: white;
			}

			.planning-action-btn:hover {
				transform: scale(1.1);
			}

			.planning-row-details {
				background: #f8f9fa;
				padding: 8px 15px 12px 15px;
				border-top: 1px solid #e9ecef;
				font-size: 13px;
			}

			.client-requests {
				color: #0066cc;
				margin-bottom: 4px;
				font-weight: 500;
			}

			.client-notes {
				color: #666;
				font-style: italic;
			}

			/* ××•×‘×™×™×œ */
			@media (max-width: 768px) {
				.planning-row-main {
					flex-direction: column;
					align-items: stretch;
					gap: 10px;
				}
				
				.planning-client-info {
					text-align: center;
				}
				
				.planning-client-actions {
					justify-content: center;
				}
				
				.planning-action-btn {
					width: 40px;
					height: 40px;
					font-size: 14px;
				}
			}

			/* ×©××¨ ×”×¡×˜×™×™×œ×™× ×”×§×™×™××™× × ×©××¨×™× */
			.planning-date-header {
				text-align: center;
				background: linear-gradient(45deg, #3498db, #2980b9); /* ×©×™× ×•×™ ××™×¨×•×§ ×œ×›×—×•×œ */
				color: white;
				padding: 15px;
				border-radius: 10px;
				margin-bottom: 20px;
				box-shadow: 0 4px 6px rgba(52, 152, 219, 0.3); /* ×¢×“×›×•×Ÿ ×¦×œ ×œ×›×—×•×œ */
			}

			.planning-tab-btn.active {
				background: #3498db; /* ×©×™× ×•×™ ××™×¨×•×§ ×œ×›×—×•×œ */
				color: white;
				border-color: #3498db;
			}

			.planning-view-tabs {
				display: flex;
				justify-content: center;
				gap: 10px;
				margin-bottom: 20px;
			}

			.planning-tab-btn {
				padding: 10px 20px;
				border: 2px solid #ddd;
				background: white;
				border-radius: 25px;
				cursor: pointer;
				transition: all 0.3s ease;
				font-weight: bold;
			}


		/***************************************/
		/* ×™×™×‘×•× × ×ª×•× ×™× - ×›×¤×ª×•×¨×™× ××—×™×“×™× */
		.import-main-buttons {
			display: flex;
			justify-content: center;
			gap: 15px;
			margin: 15px 0;
			flex-wrap: wrap;
		}

		.import-other-buttons {
			display: flex;
			justify-content: center;
			margin: 15px 0;
		}

		.import-main-buttons button,
		.import-other-buttons button {
			padding: 12px 20px;
			background: #ffc107;
			color: #212529;
			border: 1px solid #ffc107;
			border-radius: 5px;
			font-weight: 500;
			font-size: 14px;
			cursor: pointer;
			transition: all 0.3s ease;
			min-width: 200px;
			white-space: nowrap;
		}

		.import-main-buttons button:hover,
		.import-other-buttons button:hover {
			background: #e0a800;
			border-color: #d39e00;
			transform: translateY(-1px);
			box-shadow: 0 4px 8px rgba(0,0,0,0.15);
		}

		/* ×›×¤×ª×•×¨×™ ×”×™×™×‘×•× ×”×—×œ×§×™ */
		details[open] > div {
			display: flex !important;
			flex-wrap: wrap;
			gap: 8px;
			margin-top: 10px;
			justify-content: center;
		}

		details[open] > div button {
			flex: 1;
			min-width: 120px;
			max-width: 150px;
			font-size: 13px;
			padding: 10px 12px;
		}

		/* ×ª×’×•×‘×” ×œ××•×‘×™×™×œ */
		@media (max-width: 768px) {
			.import-main-buttons {
				flex-direction: column;
				align-items: center;
			}
			
			.import-main-buttons button,
			.import-other-buttons button {
				min-width: 80%;
				max-width: 300px;
				padding: 15px 20px;
				font-size: 16px;
			}
			
			details[open] > div {
				flex-direction: column;
			}
			
			details[open] > div button {
				min-width: 80%;
				max-width: 250px;
				font-size: 14px;
			}
		}
		/***************************************/

		/* ×¡×˜×™×™×œ×™× ×’ ×œ××¦×‘ ×©×‘×•×¢×™ */
		.weekly-day-section {
			margin-bottom: 25px;
		}

		.planning-empty-state {
			text-align: center;
			color: #666;
			padding: 40px 20px;
		}

		.planning-empty-state h3 {
			margin-bottom: 10px;
			color: #4CAF50;
		}


/***************************************/
/***************************************/

		/* ×¢×“×›×•×Ÿ CSS ×œ×›×¨×˜×™×¡×™×•×ª ×ª×›× ×•×Ÿ - ××‘× ×” ×“×•-×©×•×¨×ª×™ */
		.planning-row-details {
			background: #f8f9fa;
			padding: 8px 15px 12px 15px;
			border-top: 1px solid #e9ecef;
			font-size: 13px;
		}

		.client-requests {
			color: #0066cc;
			margin-bottom: 4px;
			font-weight: 500;
		}

		.client-notes {
			color: #666;
			font-style: italic;
		}

		.planning-active-toggle {
			margin-right: 5px;
		}

		.planning-history-btn {
			background: #6c757d;
			color: white;
			border: none;
			padding: 6px 10px;
			border-radius: 4px;
			font-size: 11px;
			cursor: pointer;
		}

		.planning-history-btn:hover {
			background: #5a6268;
		}

/***************************************/

		/* ×ª×™×§×•×Ÿ CSS ×œ×›×¤×ª×•×¨×™ ×”×¤×¢×•×œ×” ×”×—×“×©×™× */
		.planning-client-actions {
			display: flex;
			gap: 5px;
			align-items: center;
			flex-wrap: wrap;
		}

		.planning-date-input {
			padding: 4px 6px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 11px;
			width: 100px;
			background: white;
		}

		.planning-active-toggle {
			padding: 4px 6px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 11px;
			background: white;
			width: 70px;
		}

		.planning-history-btn {
			background: #6c757d;
			color: white;
			border: none;
			padding: 6px 8px;
			border-radius: 4px;
			font-size: 11px;
			cursor: pointer;
			min-width: 35px;
		}

		.planning-history-btn:hover {
			background: #5a6268;
		}

		/* ×ª×’×•×‘×” ×œ××•×‘×™×™×œ */
		@media (max-width: 768px) {
			.planning-client-actions {
				justify-content: center;
				gap: 3px;
			}
			
			.planning-date-input,
			.planning-active-toggle {
				font-size: 10px;
				width: auto;
				min-width: 60px;
			}
		}
		
		/* ×˜××‘×™ ×™××™× */
		.days-tabs-container {
			margin-bottom: 20px;
		}

		.days-tabs {
			display: flex;
			gap: 5px;
			margin-bottom: 15px;
			flex-wrap: wrap;
			justify-content: center;
		}

		.day-tab-btn {
			padding: 10px 15px;
			border: 2px solid #ddd;
			background: white;
			border-radius: 20px;
			cursor: pointer;
			font-size: 13px;
			font-weight: bold;
			transition: all 0.3s ease;
			min-width: 100px;
		}

		.day-tab-btn:hover {
			background: #f8f9fa;
			border-color: #3498db;
		}

		.day-tab-btn.active {
			background: #3498db;
			color: white;
			border-color: #3498db;
		}

		.days-content {
			min-height: 200px;
		}

		.day-content {
			display: none;
		}

		.day-content.active {
			display: block;
		}
		
		
		/* ×ª×’×•×‘×” ×œ××•×‘×™×™×œ ×œ×˜××‘×™ ×™××™× */
		@media (max-width: 768px) {
			.days-tabs {
				flex-direction: column;
				align-items: center;
				gap: 8px;
			}
			
			.day-tab-btn {
				min-width: 80%;
				max-width: 250px;
				padding: 12px 20px;
				font-size: 14px;
			}
			
			.days-content {
				min-height: 150px;
			}
		}

		/* ×× ×™××¦×™×” ×—×œ×§×” ×œ×ª×•×›×Ÿ ×”×™××™× */
		.day-content {
			opacity: 0;
			transition: opacity 0.3s ease;
		}

		.day-content.active {
			display: block;
			opacity: 1;
		}

		/* ×©×™×¤×•×¨ ×œ×›×•×ª×¨×ª ×”××›×™×œ */
		.days-tabs-container {
			background: rgba(255,255,255,0.7);
			border-radius: 12px;
			padding: 15px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
		}

	</style>
   
</head>
<body>
	<!-- Toast Container -->
	<div id="toastContainer" class="toast-container"></div>
    <div class="container">
        <header class="header">
            <h1>×˜×™×¤×•×œ×™×</h1>
			<div id="connectionStatus" class="connection-status">
				<button onclick="connectToGoogleSheets()" id="connectBtn" class="connect-btn">
					×”×ª×—×‘×¨ ×œ-Google Sheets
				</button>
				<button onclick="saveAllToSheets()" id="saveBtn" class="connect-btn" disabled>
					×©××•×¨ ×œ×¢× ×Ÿ
				</button>
				<button onclick="loadAllFromSheets()" id="loadBtn" class="connect-btn" disabled>
					×˜×¢×Ÿ ××”×¢× ×Ÿ
				</button>
				<span id="statusText" style="color: white; font-weight: bold; font-size: 16px;">×œ× ××—×•×‘×¨</span>
				<div id="lastSaved" style="font-size: 12px; color: white; margin-top: 4px;"></div>
			</div>
            <nav class="nav-buttons">
				<button onclick="showSection('planning')" class="nav-btn active">×ª×›× ×•×Ÿ ×™×•××™</button>
				<button onclick="showSection('visit')" class="nav-btn">×˜×™×¤×•×œ ×—×“×©</button>
				<button onclick="showSection('history')" class="nav-btn">×˜×™×¤×•×œ×™×</button> 
				<button onclick="showSection('locations')" class="nav-btn">×œ×§×•×—×•×ª</button>
				<button onclick="showSection('receipts')" class="nav-btn">×§×‘×œ×•×ª</button>
				<button onclick="showSection('debts')" class="nav-btn">ğŸ’° ×—×•×‘×•×ª</button>
				<button onclick="showSection('system')" class="nav-btn">××¢×¨×›×ª v2.1</button>
			</nav>
        </header>

        <main class="main-content">
            <!-- Planning Section -->
			<section id="planning" class="section active">
				<h2>ğŸ“… ×ª×›× ×•×Ÿ ×™×•××™ ×•×©×‘×•×¢×™</h2>
            
            <!-- ×›×•×ª×¨×ª ×ª××¨×™×š -->
            <div class="planning-date-header">
                <h3 id="planningDateTitle">×”×™×•× - ×¨×‘×™×¢×™</h3>
                <p id="planningDateFormatted">28 ×‘× ×•×‘××‘×¨ 2024</p>
            </div>

            <!-- ×˜××‘×™× -->
            <div class="planning-view-tabs">
                <button class="planning-tab-btn active" onclick="switchPlanningView('daily')">×™×•××™</button>
                <button class="planning-tab-btn" onclick="switchPlanningView('weekly')">×©×‘×•×¢×™</button>
                <button class="planning-tab-btn" onclick="switchPlanningView('overdue')">×××•×—×¨×•×ª</button>
            </div>

            <!-- ×›×¨×˜×™×¡×™ ×œ×§×•×—×•×ª -->
            <div class="planning-cards-container" id="planningCardsContainer">
                <!-- ×›×¨×˜×™×¡×™× ×™×˜×¢× ×• ×›××Ÿ ×“×™× ××™×ª -->
            </div>

            <!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª (×©××™×¨×” ×¢×œ ×”×§×™×™×) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                <div style="background: rgba(52, 152, 219, 0.1); border: 2px solid #3498db; border-radius: 8px; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 13px; color: #2c3e50;">×œ×§×•×—×•×ª:</span>
                        <span id="totalLocations" style="font-weight: bold; color: #2c3e50;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 13px; color: #2c3e50;">×¤×¢×™×œ×™×:</span>
                        <span id="activeLocations" style="font-weight: bold; color: #27ae60;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: #2c3e50;">×˜×™×¤×•×œ×™× ×”×©×‘×•×¢:</span>
                        <span id="weeklyVisits" style="font-weight: bold; color: #2c3e50;">0</span>
                    </div>
                </div>
                
                <div style="background: rgba(39, 174, 96, 0.1); border: 2px solid #27ae60; border-radius: 8px; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 13px; color: #2c3e50;">×”×›× ×¡×” ×”×©×‘×•×¢:</span>
                        <span id="weeklyIncome" style="font-weight: bold; color: #27ae60;">â‚ª0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: #2c3e50;">×—×•×‘×•×ª ×¤×ª×•×—×™×:</span>
                        <span id="openDebts" style="font-weight: bold; color: #e74c3c;">â‚ª0</span>
                    </div>
                </div>
            </div>
			</section>

            <!-- VisitSection -->
            <section id="visit" class="section">
                <h2>×˜×™×¤×•×œ ×—×“×©</h2>
                <div class="form-container">
                    <form id="visitForm">
                        <div class="form-group">
							<label for="locationSelect">×‘×—×¨ ×œ×§×•×—:</label>
							<select id="locationSelect" required>
								<option value="">×‘×—×¨ ×œ×§×•×—...</option>
							</select>
						</div>

						<!-- ×”×•×¡×£ ×›××Ÿ -->
						<div class="form-group">
							<label for="visitDate">×ª××¨×™×š ×˜×™×¤×•×œ:</label>
							<input type="date" id="visitDate" required>
						</div>

						<div class="form-group">
							<label for="visitTime">×©×¢×ª ×”×ª×—×œ×”:</label>
							<input type="time" id="visitTime" required>
						</div>
						
						<div class="form-group">
							<label for="endTime">×©×¢×ª ×¡×™×•×:</label>
							<input type="time" id="endTime">
						</div>
						
                        <div class="form-group">
                            <label for="visitType">×¡×•×’ ×˜×™×¤×•×œ:</label>
                            <select id="visitType" required>
                                <option value="××œ×">××œ×</option>
                                <option value="×—×œ×§×™">×—×œ×§×™</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="workDone">××” ×‘×•×¦×¢:</label>
                            <textarea id="workDone" placeholder="×ª×™××•×¨ ×”×¢×‘×•×“×” ×©×‘×•×¦×¢×”"></textarea>
                        </div>
                        <div class="form-group">
							<label for="manualDurationMinutes">××©×š ×”×˜×™×¤×•×œ (×“×§×•×ª):</label>
							<div style="display: flex; gap: 10px; align-items: center;">
								<input type="number" id="manualDurationMinutes" placeholder="90" min="0" onchange="updateHoursDisplay()" style="flex: 1;">
								<span style="color: #666; font-size: 14px;">×©×¢×•×ª:</span>
								<input type="text" id="calculatedHours" readonly style="width: 80px; background: #f8f9fa; color: #666; border: 2px solid #e9ecef; border-radius: 6px; padding: 8px; text-align: center;" placeholder="1.5">
							</div>
						</div>
                        <div class="form-group">
							<label for="numberOfWorkersVisit">××¡×¤×¨ ×¢×•×‘×“×™× ×‘×˜×™×¤×•×œ:</label>
							<div style="display: flex; gap: 10px; align-items: center;">
								<input type="number" id="numberOfWorkersVisit" value="1" min="1" onchange="calculateTreatmentCost()" style="width: 80px;">
								<span style="color: #666; font-size: 14px;">×¢×•×‘×“×™× (×›×•×œ×œ ××•×ª×š)</span>
							</div>
						</div>

						<div class="form-group">
							<label for="amount">×¡×›×•×:</label>
							<div style="display: flex; gap: 10px; align-items: center;">
								<input type="number" id="amount" placeholder="×¡×›×•× ×”×˜×™×¤×•×œ" style="flex: 1;">
								<button type="button" onclick="calculateTreatmentCost()" style="background: #f39c12; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
									ğŸ”„ ×—×©×‘
								</button>
							</div>
							<div id="costBreakdown" style="font-size: 12px; color: #666; margin-top: 5px;">
								<!-- ×›××Ÿ ×™×•×¤×™×¢ ×¤×™×¨×•×˜ ×”×—×™×©×•×‘ -->
							</div>
						</div>
                        <div class="form-group">
							<label for="expense">×”×•×¦××”:</label>
							<input type="number" id="expense" placeholder="×”×•×¦××•×ª × ×™×œ×•×•×ª" onchange="calculateTreatmentCost()">
						</div>
						
						<div class="form-group">
							<label for="paymentStatus">×¡×˜×˜×•×¡ ×ª×©×œ×•×:</label>
							<select id="paymentStatus">
								<option value="0">×œ× ×©×•×œ×</option>
								<option value="1">×©×•×œ×</option>
								<option value="2">×œ×œ× ×ª×©×œ×•×</option>
							</select>
						</div>
						
                        <button type="submit">×©××•×¨ ×˜×™×¤×•×œ</button>
                    </form>
                </div>
            </section>

			<!-- History Section -->
			<section id="history" class="section">
				<h2>ğŸ“‹ ×˜×™×¤×•×œ×™×</h2>
				
				<!-- Filter Panel -->
				<div class="filter-panel">
					<div class="filter-header" onclick="toggleFilterPanel()">
						<h3>ğŸ” ×¡×™× ×•×Ÿ ×˜×™×¤×•×œ×™× <span id="filterIcon">ğŸ”½</span></h3>
					</div>
					<div id="filterContent" class="filter-content">
						<div class="filter-row">
							<div class="filter-group">
								<label>×œ×§×•×—:</label>
								<select id="filterLocation">
									<option value="">×›×œ ×”×œ×§×•×—×•×ª</option>
								</select>
							</div>
							<div class="filter-group">
								<label>×¡×˜×˜×•×¡ ×ª×©×œ×•×:</label>
								<select id="filterPayment">
									<option value="">×”×›×œ</option>
									<option value="×›×Ÿ">×©×•×œ×</option>
									<option value="×œ×">×œ× ×©×•×œ×</option>
									<option value="×œ×œ×">×œ×œ× ×ª×©×œ×•×</option>
								</select>
							</div>
						</div>
						<div class="filter-row">
							<div class="filter-group">
								<label>××ª××¨×™×š:</label>
								<input type="date" id="filterDateFrom">
							</div>
							<div class="filter-group">
								<label>×¢×“ ×ª××¨×™×š:</label>
								<input type="date" id="filterDateTo">
							</div>
						</div>
						<div class="filter-actions">
							<button onclick="applyVisitFilters()" class="btn btn-primary">×¡× ×Ÿ</button>
							<button onclick="clearVisitFilters()" class="btn btn-secondary">× ×§×” ×¡×™× ×•×Ÿ</button>
						</div>
					</div>
				</div>

				<!-- Info Panel -->
				<div class="info-panel">
					<div class="info-header" onclick="toggleInfoPanel()">
						<h3>ğŸ“Š ××™×“×¢ <span id="infoIcon">ğŸ”½</span></h3>
					</div>
					<div id="infoContent" class="info-content">
						<div class="info-grid">
							<div class="info-item">
								<span class="info-label">×˜×™×¤×•×œ×™× ××•×¦×’×™×:</span>
								<span id="visitsCount" class="info-value">0</span>
							</div>
							<div class="info-item">
								<span class="info-label">×¡×”"×› ×©×¢×•×ª:</span>
								<span id="totalHours" class="info-value">0</span>
							</div>
							<div class="info-item">
								<span class="info-label">×¡×”"×› ×”×›× ×¡×•×ª:</span>
								<span id="totalIncome" class="info-value">â‚ª0</span>
							</div>
							<div class="info-item">
								<span class="info-label">×—×•×‘×•×ª ×¤×ª×•×—×™×:</span>
								<span id="outstandingDebt" class="info-value">â‚ª0</span>
							</div>
						</div>
					</div>
				</div>

				<!-- Visits Table -->
				<div class="table-container">
					<table id="visitsHistoryTable" class="data-table">
						<thead>
							<tr>
								<th>×ª××¨×™×š</th>
								<th>×œ×§×•×—</th>
								<th>×¡×•×’ ×˜×™×¤×•×œ</th>
								<th>×¢×‘×•×“×” ×©×‘×•×¦×¢×”</th>
								<th>××©×š (×©×¢×•×ª)</th>
								<th>×¡×›×•×</th>
								<th>×©×•×œ×</th>
								<th>×¤×¢×•×œ×•×ª</th>
							</tr>
						</thead>
						<tbody id="visitsHistoryTableBody">
						</tbody>
					</table>
				</div>
			</section>

            <!-- locations Section -->
            <section id="locations" class="section">
                <h2>× ×™×”×•×œ ×œ×§×•×—×•×ª</h2>
				<button onclick="showAddLocationForm()" class="add-btn">×”×•×¡×£ ×œ×§×•×— ×—×“×©</button>
                <div class="table-container">
                    <table id="locationsTable" class="data-table">
                        <thead>
                            <tr>
                                <th>×©×</th>
                                <th>×›×ª×•×‘×ª</th>
                                <th>××™×© ×§×©×¨</th>
                                <th>×™×•× ××•×ª×¨</th>
                                <th>××¨×•×•×—</th>
                                <th>×¤×¢×™×œ×”</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="locationsTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Receipts Section -->
            <section id="receipts" class="section">
                <h2>× ×™×”×•×œ ×§×‘×œ×•×ª</h2>
                <button onclick="showAddReceiptForm()" class="add-btn">×”×•×¡×£ ×§×‘×œ×” ×—×“×©×”</button>
                <div class="table-container">
                    <table id="receiptsTable" class="data-table">
                        <thead>
							<tr>
								<th>×¤× ×§×¡</th>
								<th>×§×‘×œ×”</th>
								<th>×ª××¨×™×š</th>
								<th>×‘×™× ×”</th>
								<th>×¡×›×•×</th>
								<th>×¡×•×’ ×ª×©×œ×•×</th>
								<th>×§×•×“X</th>  
								<th>×¤×¢×•×œ×•×ª</th>
							</tr>
						</thead>
                        <tbody id="receiptsTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

			<section id="debts" class="section">
				<h2>ğŸ’° × ×™×”×•×œ ×—×•×‘×•×ª</h2>
				
				<!-- ×¡×™×›×•× ×›×œ×œ×™ -->
				<div class="summary-cards">
					<div class="summary-card debt-card">
						<h3>×¡×”"×› ×—×•×‘×•×ª</h3>
						<div id="totalDebt" class="summary-value">â‚ª0</div>
					</div>
					<div class="summary-card">
						<h3>×œ×§×•×—×•×ª ×—×™×™×‘×™×</h3>
						<div id="debtorsCount" class="summary-value">0</div>
					</div>
					<div class="summary-card">
						<h3>×—×•×‘ ×××•×¦×¢</h3>
						<div id="averageDebt" class="summary-value">â‚ª0</div>
					</div>
					<div class="summary-card">
						<h3>×—×•×‘ ×”×›×™ ×™×©×Ÿ</h3>
						<div id="oldestDebt" class="summary-value">-</div>
					</div>
				</div>
				
				<!-- ×¨×©×™××ª ×—×•×‘×•×ª -->
				<div class="filter-panel">
					<div class="filter-header">
						<h3>ğŸ” ×—×•×‘×•×ª ×¤×ª×•×—×™×</h3>
					</div>
					<div class="filter-row">
						<div class="filter-group">
							<label>××™×•×Ÿ ×œ×¤×™:</label>
							<select id="debtSortBy" onchange="displayDebts()">
								<option value="amount_desc">×¡×›×•× (×’×‘×•×” ×œ× ××•×š)</option>
								<option value="amount_asc">×¡×›×•× (× ××•×š ×œ×’×‘×•×”)</option>
								<option value="date_old">×ª××¨×™×š (×”×›×™ ×™×©×Ÿ)</option>
								<option value="date_new">×ª××¨×™×š (×”×›×™ ×—×“×©)</option>
								<option value="location">×œ×§×•×— (×-×‘)</option>
							</select>
						</div>
						<div class="filter-group">
							<label>×¡×›×•× ××™× ×™××œ×™:</label>
							<input type="number" id="minDebtAmount" placeholder="0" onchange="displayDebts()">
						</div>
					</div>
				</div>
				
				<div class="table-container">
					<table id="debtsTable" class="data-table">
						<thead>
							<tr>
								<th>×œ×§×•×—</th>
								<th>×›×ª×•×‘×ª</th>
								<th>×˜×œ×¤×•×Ÿ</th>
								<th>××¡×¤×¨ ×˜×™×¤×•×œ×™×</th>
								<th>×¡×”"×› ×—×•×‘</th>
								<th>×˜×™×¤×•×œ ××—×¨×•×Ÿ</th>
								<th>×™××™×</th>
								<th>×¤×¢×•×œ×•×ª</th>
							</tr>
						</thead>
						<tbody id="debtsTableBody">
						</tbody>
					</table>
				</div>
			</section>

			<!-- System Section -->
			<section id="system" class="section">
				<h2>ğŸ› ï¸ ××¢×¨×›×ª</h2>
				
				<!-- Import Section -->
				<div class="form-section">
					<h3>ğŸ“¥ ×™×™×‘×•× × ×ª×•× ×™×</h3>
					
					<div class="import-main-buttons">
						<button onclick="createImportTable()">ğŸ“— ×¦×•×¨ ×˜×‘×œ×ª ×¢×–×¨ ×œ×™×™×‘×•×</button>
						<button onclick="importFromHelperTableFast()">ğŸš€ ×™×™×‘×•× ××”×™×¨ ×•×›×•×œ×œ</button>
					</div>
					
					<div class="import-other-buttons">
						<button onclick="importFromTelegramToHelper()" class="btn btn-warning">
							ğŸ“± ×™×‘×•× ××˜×œ×’×¨× ×œ×˜×‘×œ×ª ×¢×–×¨
						</button>
						<button onclick="importFromTelegramHelper()" class="btn btn-info">
							â¬‡ï¸ ×™×‘×•× ××˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨×
						</button>
					</div>

					<div style="margin: 25px 0; padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
						<div style="text-align: center;">
							<h3 style="color: white; margin-bottom: 10px; font-size: 1.4em;">ğŸ’° ×™×™×‘×•× ×”×›× ×¡×•×ª ××˜×œ×’×¨×</h3>
							<p style="color: rgba(255,255,255,0.9); margin-bottom: 20px; font-size: 14px;">
								×”×¢×œ×” ×§×•×‘×¥ ×™×™×¦×•× ×”×›× ×¡×•×ª ××˜×œ×’×¨× ×œ×™×™×‘×•× ××•×˜×•××˜×™ ×œ××¢×¨×›×ª
							</p>
							<input type="file" id="telegramIncomeFile" accept=".txt,.json" style="display: none;" onchange="handleTelegramIncomeFileUpload(event)">
							<button class="btn" onclick="document.getElementById('telegramIncomeFile').click()" 
									style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 12px 30px; font-size: 16px; border-radius: 8px; transition: all 0.3s ease; backdrop-filter: blur(10px);">
								ğŸ“ ×‘×—×¨ ×§×•×‘×¥ ×”×›× ×¡×•×ª ××˜×œ×’×¨×
							</button>
						</div>
						<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 12px; text-align: center; color: rgba(255,255,255,0.8);">
							×ª×•××š ×‘×§×‘×¦×™ .txt ×•-.json ××™×™×¦×•× ×˜×œ×’×¨×
						</div>
					</div>


					<!-- ×”×•×¡×£ ×’× ×›×¤×ª×•×¨ ×œ×™×¦×™×¨×ª ×˜×‘×œ×ª ×¢×–×¨ ×—×“×©×”: -->
					<div style="margin-top: 10px;">
						<button onclick="createTelegramHelperTable()" class="btn btn-secondary" style="font-size: 12px;">
							ğŸ—‚ï¸ ×¦×•×¨ ×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨× ×—×“×©×”
						</button>
					</div>
					
					<div id="telegramHelperStatus" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; font-size: 14px;"></div>
					
					<details>
						<summary>âš™ï¸ ×™×™×‘×•× ×—×œ×§×™ (×œ××ª×§×“××™×)</summary>
						<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
							<button class="btn btn-info" onclick="importCustomersFromHelper()">ğŸ‘¥ ×¨×§ ×œ×§×•×—×•×ª</button>
							<button class="btn btn-primary" onclick="importVisitsFromHelper()">ğŸ”§ ×¨×§ ×˜×™×¤×•×œ×™×</button>
							<button class="btn btn-warning" onclick="importReceiptsFromHelper()">ğŸ§¾ ×¨×§ ×§×‘×œ×•×ª</button>
						</div>
						<p style="font-size: 12px; color: #666; margin-top: 8px;">
							×”×©×ª××© ×‘×–×” ×¨×§ ×× ××ª×” ×¦×¨×™×š ×œ×™×™×‘× ×¡×•×’ × ×ª×•× ×™× ×¡×¤×¦×™×¤×™
						</p>
					</details>
					
					<div style="text-align: center; margin: 15px 0;">
						<span style="color: #666;">××•</span>
					</div>
					
					<div style="text-align: center;">
						<button class="btn btn-warning" onclick="document.getElementById('importFileInput').click()">
							ğŸ“ ×™×™×‘×•× ××”×™×¨ ××§×•×‘×¥
						</button>
						<input type="file" id="importFileInput" accept=".csv,.xlsx" style="display: none;" onchange="handleImportFile(event)">
					</div>
					
					<p style="text-align: center; font-size: 12px; color: #666; margin-top: 15px;">
						×™×™×‘×•× ×œ×§×•×—×•×ª, ×‘×™×§×•×¨×™× ×•×§×‘×œ×•×ª ××§×•×‘×¥ Excel ××• Google Sheets
					</p>
				</div>
				
				<!-- × ×™×”×•×œ × ×ª×•× ×™× -->
				<div class="form-section">
					<h3>ğŸ—‚ï¸ × ×™×”×•×œ × ×ª×•× ×™×</h3>
					
					<div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
						<h4 style="color: #856404; margin-bottom: 10px;">âš ï¸ × ×™×§×•×™ × ×ª×•× ×™×</h4>
						<p style="font-size: 14px; color: #856404; margin-bottom: 10px;">
							× ×§×” ××ª ×›×œ ×”× ×ª×•× ×™× ×”××§×•××™×™× ×œ×¤× ×™ ×™×™×‘×•× ×—×“×© (×œ× ××©×¤×™×¢ ×¢×œ ×”×¢× ×Ÿ)
						</p>
						
						<button class="btn" onclick="clearAllDataBeforeImport()" 
								style="background: #dc3545; color: white; border: none;">
							ğŸ—‘ï¸ × ×§×” ××ª ×›×œ ×”× ×ª×•× ×™× ×”××§×•××™×™×
						</button>
					</div>
					
					<!-- ×¡×˜×˜×•×¡ ×˜×‘×œ×ª ×¢×–×¨ -->
					<div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
						<h4 style="color: #495057; margin-bottom: 10px;">ğŸ“Š ×˜×‘×œ×ª ×¢×–×¨ ×œ×™×™×‘×•×</h4>
						<div id="importTableStatus">
							<span style="font-size: 13px; color: #666;">
								×‘×•×“×§ ×¡×˜×˜×•×¡ ×˜×‘×œ×ª ×¢×–×¨...
							</span>
						</div>
					</div>
				</div>
				
				<!-- Additional System Features -->
					<div class="form-section">
						<h3>âš™ï¸ ×”×’×“×¨×•×ª ××¢×¨×›×ª</h3>
						
						<!-- Cost Settings -->
						<div style="background: rgba(39, 174, 96, 0.1); border: 2px solid #27ae60; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
							<h4 style="color: #27ae60; margin-bottom: 10px;">ğŸ’° ×”×’×“×¨×•×ª ×¢×œ×•×ª ×˜×™×¤×•×œ</h4>
							<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
								<div class="form-group">
									<label for="hourlyRate">×©×¢×ª ×¢×‘×•×“×” (â‚ª):</label>
									<input type="number" id="hourlyRate" value="150" min="0" onchange="saveCostSettings()">
								</div>
								<div class="form-group">
									<label for="workerCost">×ª×•×¡×¤×ª ×œ×¤×•×¢×œ (â‚ª):</label>
									<input type="number" id="workerCost" value="50" min="0" onchange="saveCostSettings()">
								</div>
							</div>
						</div>
						
						<p style="color: #666;">×ª×›×•× ×•×ª × ×•×¡×¤×•×ª ×™×ª×•×•×¡×¤×• ×›××Ÿ ×‘×”××©×š...</p>
					</div>
			</section>
			
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <script>
		 // Google Sheets API Configuration
		const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
		const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
		let SPREADSHEET_ID = '1fSD5dh0bXRzFSeOZUwJ2bPjGRLqs2crGXPkebz6MpWc';
		const CLIENT_ID = '1040357646874-4sbkrokgjn4dd7a0e9rkrtjt8d9l3vie.apps.googleusercontent.com';
		const API_KEY = 'AIzaSyB25ms_UzbgfY9FnduMwMhGhlvwfVPaTg8';
		const SPREADSHEET_NAME = 'service_visits_data';

//////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>   ×œ××—×™×§×”
		// ×‘×“×™×§×” ×–×× ×™×ª - ×ª××—×§ ××—×¨×™ ×”×‘×“×™×§×”
		console.log('Spreadsheet ID:', SPREADSHEET_ID);
		console.log('API Key:', API_KEY);
		console.log('Client ID:', CLIENT_ID);
//////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>


		let gapi_loaded = false;
		let google_loaded = false;
		let access_token = null;
		let spreadsheet_id = SPREADSHEET_ID;
        
        // Sheet names
        const SHEETS = {
			LOCATIONS: 'Locations',
			VISITS: 'Visits',
			RECEIPTS: 'Receipts',
			SETTINGS: 'SystemSettings'
		};

        // Global variables
        let locations = [];
        let visits = [];
        let receipts = [];
        let currentFilter = 'today';
		// ×”×’×“×¨×•×ª ×¢×œ×•×ª
		let costSettings = {
			hourlyRate: 150,
			workerCost: 50
		};

		// Initialize Google APIs
		function initializeGoogleAPIs() {
			gapi.load('client', initializeGapiClient);
			google.accounts.id.initialize({
				client_id: CLIENT_ID,
				callback: handleCredentialResponse,
			});
		}
		
		async function initializeGapiClient() {
			try {
				await gapi.client.init({
					apiKey: API_KEY,
					discoveryDocs: [DISCOVERY_DOC],
				});
				gapi_loaded = true;
				console.log('GAPI client initialized successfully');
			} catch (error) {
				console.error('Error initializing GAPI client:', error);
				showToast('×©×’×™××” ×‘××ª×—×•×œ Google API', 'error');
			}
		}

		function handleCredentialResponse(response) {
			access_token = response.credential;
			showSuccess('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×” ×œ-Google!');
		}

		// ×ª×•×¡×¤×” - ×¤×•× ×§×¦×™×” ×©× ×§×¨××ª ××—×¨×™ ×”×”×ª×—×‘×¨×•×ª
		async function loadAllDataFromSheets() {
			if (!await validateToken()) {
				showToast('××™×Ÿ ×—×™×‘×•×¨ ×œ×’×•×’×œ - ×˜×•×¢×Ÿ × ×ª×•× ×™× ××§×•××™×™×', 'warning');
				return;
			}
			
			try {
				showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™× ×-Google Sheets...');
				
				await loadLocationsFromSheets();
				await loadVisitsFromSheets(); 
				await loadReceiptsFromSheets();
				
				// Update UI
				loadLocationsForSelect();
				loadLocationsTable();
				loadReceiptsTable();
				loadPlanningData();
				
				hideLoading();
				showSuccess('× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” ×-Google Sheets!');
				setTimeout(checkCriticalDebts, 2000); // ×”×ª×¨××” ××—×¨×™ 2 ×©× ×™×•×ª
				
			} catch (error) {
				console.error('Error loading data from sheets:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('âš ï¸ ×”×—×™×‘×•×¨ ×¤×’ ×‘××”×œ×š ×˜×¢×™× ×”', 'warning');
				} else {
					showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™× ×-Google Sheets');
				}
				throw error;
			}
		}

		

		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ××™×§×•××™× (×’×™× ×•×ª)
		async function loadLocationsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:P` // ×•×•×“× ×©×§×•×¨××™× ×¢×“ ×¢××•×“×” P
				});
				
				const rows = response.result.values;
				console.log('ğŸ” Raw locations data (first row):', rows ? rows[0] : 'No data');
				console.log('ğŸ” Raw locations data (second row):', rows ? rows[1] : 'No data');
				
				if (rows && rows.length > 1) {
					locations = rows.slice(1).map((row, index) => {
						const location = {
							ID: row[0] || '',
							name: row[1] || '',
							full_address: row[2] || '',
							neighborhood: row[3] || '',
							city: row[4] || '',
							contact_person: row[5] || '',
							phone: row[6] || '',
							allowed_day: row[7] || '',
							interval_weeks: row[8] || '',
							temp_addition: row[9] || 0,
							base_amount: row[10] || '',
							active: row[11] || '',
							notes: row[12] || '',
							last_visit: row[13] || '',
							next_visit: row[14] || '',
							client_requests: row[15] || '' // ×¢××•×“×” P
						};
						
						// ×œ×•×’ ×¨×§ ×œ×©×•×¨×•×ª ×¢× client_requests
						if (row[15]) {
							console.log(`âœ… Row ${index + 1} - ${location.name}: client_requests = "${row[15]}"`);
						}
						
						return location;
					});
				}
				
				console.log('ğŸ“Š Total locations loaded:', locations.length);
				
			} catch (error) {
				console.error('Error loading locations:', error);
			}
		}

		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ×‘×™×§×•×¨×™× (×˜×™×¤×•×œ×™×)
		async function loadVisitsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:N` // â† ×©× ×” ×-A:L ×œ-A:N
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					visits = rows.slice(1).map(row => ({
						ID: row[0] || '',
						date: row[1] || '',
						location_id: row[2] || '',
						location_name: row[3] || '',
						visit_type: row[4] || '',
						work_done: row[5] || '',
						duration_minutes: row[6] || 0,
						num_workers: row[7] || 1,
						start_time: row[8] || '',
						end_time: row[9] || '',
						amount: row[10] || 0,
						expense: row[11] || 0,
						notes: row[12] || ''
					}));
				}
				
			} catch (error) {
				console.error('Error loading visits:', error);
			}
		}

		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ×§×‘×œ×•×ª
		async function loadReceiptsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:I`
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					receipts = rows.slice(1).map(row => ({
						ID: row[0] || '',
						book_number: row[1] || '',
						receipt_number: row[2] || '',
						date: row[3] || '',
						location_id: row[4] || '',
						location_name: row[5] || '',
						amount: row[6] || 0,
						payment_type: row[7] || '',
						notes: row[8] || ''
					}));
				}
				
			} catch (error) {
				console.error('Error loading receipts:', error);
			}
		}
		
		// ×ª×•×¡×¤×” - ×©××™×¨×ª ××™×§×•× ×—×“×© ×œ×©×™×˜×¡
		/* async function saveLocationToSheets(locationData) {
		
			console.log('ğŸ“ saveLocationToSheets started with client_requests:', locationData.client_requests);
			
			if (!await validateToken()) {
				console.log('âŒ Token validation failed');
				showToast('×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×©××™×¨×” ××§×•××™×ª ×‘×œ×‘×“', 'warning');
				return;
			}
    
			console.log('âœ… Token validated, proceeding to save...');
	
			try {
				const values = [[
					locationData.ID,
					locationData.name,
					locationData.full_address,
					locationData.neighborhood,
					locationData.city,
					locationData.contact_person,
					locationData.phone,
					locationData.allowed_day,
					locationData.interval_weeks,
					locationData.temp_addition,
					locationData.base_amount,
					locationData.active,
					locationData.notes || '',
					locationData.last_visit,
					locationData.next_visit,
					locationData.client_requests|| ''
				]];
				
				console.log('ğŸ“¤ About to send to Google Sheets:', values[0][15]); 
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:P`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
				console.log('âœ… Successfully saved to Google Sheets');
				
			} catch (error) {
			
				console.error('âŒ Error in saveLocationToSheets:', error);
			
				console.error('Error saving location to sheets:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('âš ï¸ ×”×—×™×‘×•×¨ ×¤×’ - ×”×ª×—×‘×¨ ××—×“×©', 'warning');
					document.getElementById('statusText').textContent = 'ğŸ”“ × ×•×ª×§';
				} else {
					// ×©×’×™××•×ª ××—×¨×•×ª (×œ× ×§×©×•×¨×•×ª ×œ××¡×™××•×Ÿ)
					showToast('âš ï¸ ×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ', 'error');
				}
				throw error;

			}
		}  */


		async function saveLocationToSheets(locationData) {
		
			if (!await validateToken()) {
				showToast('×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×©××™×¨×” ××§×•××™×ª ×‘×œ×‘×“', 'warning');
				return;
			}
    
			try {
				const values = [[
					locationData.ID,
					locationData.name,
					locationData.full_address,
					locationData.neighborhood,
					locationData.city,
					locationData.contact_person,
					locationData.phone,
					locationData.allowed_day,
					locationData.interval_weeks,
					locationData.temp_addition,
					locationData.base_amount,
					locationData.active,
					locationData.notes || '',
					locationData.last_visit,
					locationData.next_visit,
					locationData.client_requests || ''
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:P`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving location to sheets:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('âš ï¸ ×”×—×™×‘×•×¨ ×¤×’ - ×”×ª×—×‘×¨ ××—×“×©', 'warning');
					document.getElementById('statusText').textContent = 'ğŸ”“ × ×•×ª×§';
				} else {
					// ×©×’×™××•×ª ××—×¨×•×ª (×œ× ×§×©×•×¨×•×ª ×œ××¡×™××•×Ÿ)
					showToast('âš ï¸ ×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ', 'error');
				}
				throw error;

			}
		}


		// ×©××™×¨×ª ×‘×™×§×•×¨ ×—×“×© ×œ×©×™×˜×¡
		async function saveVisitToSheets(visitData) {
			if (!await validateToken()) {
				return;
			}
			
			try {
				const values = [[
					visitData.ID,
					visitData.date,
					visitData.location_id,
					visitData.location_name || '', 
					visitData.visit_type,
					visitData.work_done,
					visitData.duration_minutes,
					visitData.num_workers || 1,
					visitData.start_time,
					visitData.end_time,
					visitData.amount,
					visitData.expense || 0,
					visitData.notes
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:M`, // â† ×—×–×¨× ×• ×œ-M ×›×™ ×”×¡×¨× ×• paid
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving visit to sheets:', error);
				throw error;
			}
		}

		// ×ª×•×¡×¤×” - ×©××™×¨×ª ×§×‘×œ×” ×œ×©×™×˜×¡
		async function saveReceiptToSheets(receiptData) {
			if (!await validateToken()) {
				return;
			}
			
			try {
				const values = [[
					receiptData.ID,
					receiptData.booklet_number || '',
					receiptData.receipt_number || '',
					receiptData.date,
					receiptData.location_id,
					receiptData.location_name || '',
					receiptData.amount,
					receiptData.payment_type || '',
					receiptData.tax_code || '',
					receiptData.notes || ''
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:J`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving receipt to sheets:', error);
				throw error;
			}
		}

		
		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ×›×œ ×”× ×ª×•× ×™× ××”×¢× ×Ÿ
		async function loadAllFromSheets() {
			try {
				showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™× ××”×¢× ×Ÿ...');
				
				await loadLocationsFromSheets();
				await loadVisitsFromSheets(); 
				await loadReceiptsFromSheets();
				await loadPaymentsFromCloud(); 
				
				// ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
				loadLocationsForSelect();
				loadLocationsTable();
				loadReceiptsTable();
				loadPlanningData();
				
				hideLoading();
				showSuccess('× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” ××”×¢× ×Ÿ!');
				
			} catch (error) {
				console.error('Error loading all data:', error);
				hideLoading();
				showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™× ××”×¢× ×Ÿ');
			}
		}


		// Local Storage functions
		function saveToLocalStorage() {
			try {
				localStorage.setItem('locations_data', JSON.stringify(locations));
				localStorage.setItem('visits_data', JSON.stringify(visits));
				localStorage.setItem('receipts_data', JSON.stringify(receipts));
				localStorage.setItem('payments_data', JSON.stringify(payments));
				localStorage.setItem('payment_links_data', JSON.stringify(paymentVisitLinks));
				console.log('Data saved to local storage');
			} catch (error) {
				console.error('Error saving to local storage:', error);
			}
		}

		function loadFromLocalStorage() {
			try {
				const savedLocations = localStorage.getItem('locations_data');
				const savedVisits = localStorage.getItem('visits_data');
				const savedReceipts = localStorage.getItem('receipts_data');
				const savedPayments = localStorage.getItem('payments_data');
				const savedPaymentLinks = localStorage.getItem('payment_links_data');
				const savedCostSettings = localStorage.getItem('cost_settings'); // ×”×•×¡×£ ×–×”
				
				if (savedLocations) {
					locations = JSON.parse(savedLocations);
				}
				if (savedVisits) {
					visits = JSON.parse(savedVisits);
				}
				if (savedReceipts) {
					receipts = JSON.parse(savedReceipts);
				}
				if (savedPayments) {
					payments = JSON.parse(savedPayments);
				}
				if (savedPaymentLinks) {
					paymentVisitLinks = JSON.parse(savedPaymentLinks);
				}
				if (savedCostSettings) { // ×”×•×¡×£ ××ª ×”×‘×œ×•×§ ×”×–×”
					costSettings = JSON.parse(savedCostSettings);
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
				}
				
				if (savedCostSettings) {
					costSettings = JSON.parse(savedCostSettings);
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
				}

				console.log('Data loaded from local storage');
				
			} catch (error) {
				console.error('Error loading from local storage:', error);
			}
		}



        document.addEventListener('DOMContentLoaded', function() {
			console.log('App starting...');
			initializeGoogleAPIs();
			loadAllData(); // ×–×” ×™×˜×¢×Ÿ × ×ª×•× ×™× ××§×•××™×™×
			setupEventListeners();
		});

        // Setup event listeners
        function setupEventListeners() {
            // Visitform submission
            document.getElementById('visitForm').addEventListener('submit', handleVisitSubmit);
        }

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Add active class to clicked button
            if (event && event.target) {
				event.target.classList.add('active');
			}
            
            // Load section-specific data
            switch(sectionName) {
                case 'planning':
                    loadPlanningData();
                    break;
                case 'visit':
                    loadLocationsForSelect();
                    break;
				case 'history':
					loadVisitsHistory();
					break;
                case 'locations':
                    loadLocationsTable();
                    break;
                case 'receipts':
                    loadReceiptsTable();
                    break;
				case 'debts':
                    displayDebts();
                    break;
            }
        }

        // Data loading functions
		async function loadAllData() {
			try {
				showLoading('×˜×•×¢×Ÿ × ×ª×•× ×™×...');
				loadFromLocalStorage();
				hideLoading();
				loadPlanningData();
			} catch (error) {
				console.error('Error loading data:', error);
				showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×');
			}
		}

        async function loadlocations() {
            // For now, we'll use dummy data until we set up the Google Sheets API
            locations = [
                {
                    ID: 1,
                    name: "×’×™× ×ª ×“×•×’××” 1",
                    full_address: "×¨×—×•×‘ ×”×“×•×’××” 1, ×ª×œ ××‘×™×‘",
                    neighborhood: "××¨×›×–",
                    city: "×ª×œ ××‘×™×‘",
                    contact_person: "×™×•×¡×™ ×›×”×Ÿ",
                    phone: "050-1234567",
                    allowed_day: "×'",
                    interval_weeks: 4,
                    temp_addition: 0,
                    base_amount: 300,
                    active: "×›×Ÿ",
                    notes: "",
                    last_visit: "2024-01-15",
                    next_visit: "2024-02-12"
                },
                {
                    ID: 2,
                    name: "×’×™× ×ª ×“×•×’××” 2",
                    full_address: "×¨×—×•×‘ ×”×“×•×’××” 2, ×ª×œ ××‘×™×‘",
                    neighborhood: "×¦×¤×•×Ÿ",
                    city: "×ª×œ ××‘×™×‘",
                    contact_person: "××¨×™× ×œ×•×™",
                    phone: "052-7654321",
                    allowed_day: "×’'",
                    interval_weeks: 6,
                    temp_addition: 0,
                    base_amount: 400,
                    active: "×›×Ÿ",
                    notes: "",
                    last_visit: "2024-01-10",
                    next_visit: "2024-02-21"
                }
            ];
        }

        async function loadVisits() {
            visits = []; // Will be loaded from Google Sheets
        }

        async function loadReceipts() {
            receipts = []; // Will be loaded from Google Sheets
        }

        // Display functions
        function loadPlanningData() {
			// Debug - ×‘×“×™×§×ª × ×ª×•× ×™×
			debugPlanningData();
			
			// ×—×™×©×•×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª
			updatePlanningStats();
			
			// ×¡×™× ×•×Ÿ ×¨×’×™×œ
			filterVisits(currentFilter);
		}

	/////<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
	
	// ========== ××¢×¨×›×ª ×ª×›× ×•×Ÿ ××©×•×“×¨×’×ª ==========

		// ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×œ×ª×›× ×•×Ÿ ××©×•×“×¨×’
		let currentPlanningView = 'daily';
		let planningClients = [];

		// ×–×× ×™ ×¢×‘×•×“×” ×–××™× ×™× (07:00-19:00 ×‘×§×¤×™×¦×•×ª ×©×œ 30 ×“×§×•×ª)
		const timeSlots = [];
		for (let hour = 7; hour <= 19; hour++) {
			timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
			if (hour < 19) timeSlots.push(`${hour.toString().padStart(2, '0')}:30`);
		}

		// ×¤×•× ×§×¦×™×” ×¢×™×§×¨×™×ª ×œ×˜×¢×™× ×ª × ×ª×•× ×™ ×ª×›× ×•×Ÿ - ×’×¨×¡×” ××©×•×“×¨×’×ª
		function loadPlanningDataAdvanced() {
			updatePlanningStats();
			loadPlanningClientsAdvanced();
			updatePlanningDateHeader();
			renderPlanningCards();
		}

		// ×˜×¢×™× ×ª ×œ×§×•×—×•×ª ×œ×ª×›× ×•×Ÿ ×œ×¤×™ ×”×ª×¦×•×’×” ×”× ×•×›×—×™×ª - ×’×¨×¡×” ××ª×•×§× ×ª
		function loadPlanningClientsAdvanced() {
			const today = new Date();
			today.setHours(0, 0, 0, 0);
			
			console.log('ğŸ”„ ×˜×•×¢×Ÿ ×œ×§×•×—×•×ª ×œ×ª×›× ×•×Ÿ - ×ª×¦×•×’×”:', currentPlanningView);
			
			// ×¡×™× ×•×Ÿ ×œ×§×•×—×•×ª ×¤×¢×™×œ×™× ×‘×œ×‘×“
			const activeClients = locations.filter(client => client.active === "1");
			console.log('ğŸ“Š ×œ×§×•×—×•×ª ×¤×¢×™×œ×™×:', activeClients.length);
			
			// ×—×™×©×•×‘ × ×ª×•× ×™× ×œ×›×œ ×œ×§×•×— ×¤×¢×™×œ
			planningClients = activeClients.map(client => {
				const nextVisitDate = new Date(client.next_visit);
				nextVisitDate.setHours(0, 0, 0, 0);
				
				const daysDiff = Math.floor((nextVisitDate - today) / (1000 * 60 * 60 * 24));
				const daysOverdue = daysDiff < 0 ? Math.abs(daysDiff) : 0;
				
				return {
					...client,
					nextVisitDate: nextVisitDate,
					daysDiff: daysDiff,
					daysOverdue: daysOverdue,
					status: calculateClientStatus(daysDiff, daysOverdue)
				};
			});
			
			// ×¡×™× ×•×Ÿ ×œ×¤×™ ×ª×¦×•×’×” × ×•×›×—×™×ª
			planningClients = filterClientsByView(planningClients);
			
			// ××™×•×Ÿ ×”×œ×§×•×—×•×ª
			sortPlanningClients();
			
			console.log('âœ… ×œ×§×•×—×•×ª ×œ×ª×¦×•×’×”:', planningClients.length);
		}
	
		// ×—×™×©×•×‘ ×¡×˜×˜×•×¡ ×œ×§×•×— ×œ×¤×™ ×”×¤×¨×© ×™××™×
		function calculateClientStatus(daysDiff, daysOverdue) {
			if (daysOverdue > 14) return 'red';        // ××™×—×•×¨ ××¢×œ ×©×‘×•×¢×™×™×
			if (daysOverdue > 0) return 'orange';      // ××™×—×•×¨ ×¢×“ ×©×‘×•×¢×™×™×  
			if (daysDiff === 0) return 'green';        // ×”×™×•× ×‘×“×™×•×§
			if (daysDiff <= 7) return 'yellow';        // ×”×©×‘×•×¢ ×”×§×¨×•×‘
			return 'gray';                             // ×¢×ª×™×“×™ ×¨×—×•×§
		}

		// ×¡×™× ×•×Ÿ ×œ×§×•×—×•×ª ×œ×¤×™ ×”×ª×¦×•×’×” ×”× ×‘×—×¨×ª
		function filterClientsByView(clients) {
			const today = new Date();
			const todayDay = today.getDay(); // 0=×¨××©×•×Ÿ, 1=×©× ×™ ×•×›×•'
			const dayNames = ['×™×•× ×¨××©×•×Ÿ', '×™×•× ×©× ×™', '×™×•× ×©×œ×™×©×™', '×™×•× ×¨×‘×™×¢×™', '×™×•× ×—××™×©×™', '×™×•× ×©×™×©×™', '×™×•× ×©×‘×ª'];
			
			switch (currentPlanningView) {
				case 'daily':
					// ×¨×§ ×œ×§×•×—×•×ª ×©×”×™×•× ×‘×“×™×•×§ ×”×ª××¨×™×š ×©×œ×”× (×‘×œ×™ ×××—×¨×™×)
					return clients.filter(client => client.daysDiff === 0);
					
				case 'weekly':
					// ×¨×§ ×ª××¨×™×›×™× ××“×•×™×§×™× (×œ× ×××—×¨×™×) - ××”×©×‘×•×¢ ×”×§×¨×•×‘
					return clients.filter(client => 
						client.daysDiff >= 0 && client.daysDiff <= 7
					);
					
				case 'overdue':
					// ×¨×§ ×××—×¨×™×
					return clients.filter(client => client.daysOverdue > 0);
					
				default:
					return clients;
			}
		}
	
		// ××™×•×Ÿ ×œ×§×•×—×•×ª ×œ×¤×™ ×”×ª×¦×•×’×” ×”× ×•×›×—×™×ª
		function sortPlanningClients() {
			planningClients.sort((a, b) => {
				switch (currentPlanningView) {
					case 'daily':
						// ××™×•×Ÿ ×œ×¤×™ ×©×¢×” ××•×¢×“×¤×ª ×× ×§×™×™××ª, ××—×¨×ª ×œ×¤×™ ×©×
						return (a.name || '').localeCompare(b.name || '');
						
					case 'weekly':
						// ××™×•×Ÿ ×œ×¤×™ ×™×•× ×‘×©×‘×•×¢, ×•××– ×œ×¤×™ ×ª××¨×™×š
						const dayOrder = ['×™×•× ×¨××©×•×Ÿ', '×™×•× ×©× ×™', '×™×•× ×©×œ×™×©×™', '×™×•× ×¨×‘×™×¢×™', '×™×•× ×—××™×©×™', '×™×•× ×©×™×©×™', '×™×•× ×©×‘×ª'];
						const aDay = dayOrder.indexOf(a.allowed_day || '×™×•× ×¨××©×•×Ÿ');
						const bDay = dayOrder.indexOf(b.allowed_day || '×™×•× ×¨××©×•×Ÿ');
						if (aDay !== bDay) return aDay - bDay;
						return a.daysDiff - b.daysDiff;
						
					case 'overdue':
						// ××™×•×Ÿ ×œ×¤×™ ×—×•××¨×ª ×”××™×—×•×¨ (×”×›×™ ×××—×¨ ×¨××©×•×Ÿ)
						return b.daysOverdue - a.daysOverdue;
						
					default:
						return 0;
				}
			});
		}
	
		// ×”×—×œ×¤×ª ×ª×¦×•×’×ª ×ª×›× ×•×Ÿ ×¢× ×œ×•×’×™×§×” ××¢×•×“×›× ×ª
		function switchPlanningView(view) {
			console.log('ğŸ”„ ××—×œ×™×£ ×ª×¦×•×’×ª ×ª×›× ×•×Ÿ ×œ:', view);
			
			// ×¢×“×›×•×Ÿ ××©×ª× ×” ×’×œ×•×‘×œ×™
			currentPlanningView = view;
			
			// ×¢×“×›×•×Ÿ ××¦×‘ ×›×¤×ª×•×¨×™ ×˜××‘
			document.querySelectorAll('.planning-tab-btn').forEach(btn => btn.classList.remove('active'));
			const activeBtn = document.querySelector(`[onclick="switchPlanningView('${view}')"]`);
			if (activeBtn) activeBtn.classList.add('active');
			
			// ×¢×“×›×•×Ÿ ×›×•×ª×¨×ª ×œ×¤×™ ×ª×¦×•×’×”
			updatePlanningDateHeader();
			
			// ×˜×¢×™× ×” ××—×“×© ×¢× ×”×¡×™× ×•×Ÿ ×”×—×“×©
			loadPlanningDataAdvanced();
			
			// ×”×¦×’×ª ××¡×¤×¨ ×ª×•×¦××•×ª
			setTimeout(() => {
				let viewName = '';
				switch(view) {
					case 'daily': viewName = '×™×•××™'; break;
					case 'weekly': viewName = '×©×‘×•×¢×™'; break;  
					case 'overdue': viewName = '×××—×¨×™×'; break;
				}
				
				if (planningClients.length > 0) {
					showToast(`××¦×‘ ${viewName}: ${planningClients.length} ×œ×§×•×—×•×ª`, 'info');
				}
			}, 200);
		}

		// ×¢×“×›×•×Ÿ ×›×•×ª×¨×ª ×ª××¨×™×š ××©×•×¤×¨×ª
		function updatePlanningDateHeader() {
			const today = new Date();
			const dayName = today.toLocaleDateString('he-IL', { weekday: 'long' });
			const dateFormatted = today.toLocaleDateString('he-IL', { 
				day: 'numeric', 
				month: 'long', 
				year: 'numeric' 
			});
			
			let headerTitle = '';
			let headerSubtitle = '';
			
			switch (currentPlanningView) {
				case 'daily':
					headerTitle = `×”×™×•× - ${dayName}`;
					headerSubtitle = '×œ×§×•×—×•×ª ××ª×•×›× × ×™× ×œ×”×™×•×';
					break;
				case 'weekly':
					headerTitle = `×”×©×‘×•×¢ - ${dayName}`;
					headerSubtitle = '×ª×›× ×•×Ÿ ×œ×™××™× ×”×§×¨×•×‘×™×';
					break;
				case 'overdue':
					headerTitle = '×˜×™×¤×•×œ×™× ×××—×¨×™×';
					headerSubtitle = '×“×•×¨×©×™× ×§×‘×™×¢×ª ××•×¢×“ ×—×“×©';
					break;
				default:
					headerTitle = `×ª×›× ×•×Ÿ - ${dayName}`;
					headerSubtitle = dateFormatted;
			}
			
			const titleElement = document.getElementById('planningDateTitle');
			const dateElement = document.getElementById('planningDateFormatted');
			
			if (titleElement) titleElement.textContent = headerTitle;
			if (dateElement) dateElement.textContent = headerSubtitle;
		}

		// ×¨×™× ×“×•×¨ ×›×¨×˜×™×¡×™ ×œ×§×•×—×•×ª ×œ×ª×›× ×•×Ÿ
		function renderPlanningCards() {
			const container = document.getElementById('planningCardsContainer');
			
			if (!container) {
				console.log('âš ï¸ ×œ× × ××¦× container ×œ×›×¨×˜×™×¡×™ ×”×ª×›× ×•×Ÿ');
				return;
			}
			
			if (planningClients.length === 0) {
				let emptyMessage = '';
				switch (currentPlanningView) {
					case 'daily':
						emptyMessage = '<h3>ğŸ˜Š ××™×Ÿ ×œ×§×•×—×•×ª ××ª×•×›× × ×™× ×œ×”×™×•×</h3><p>×›×œ ×”×˜×™×¤×•×œ×™× ××¢×•×“×›× ×™×!</p>';
						break;
					case 'weekly':
						emptyMessage = '<h3>ğŸ“… ××™×Ÿ ×œ×§×•×—×•×ª ××ª×•×›× × ×™× ×”×©×‘×•×¢</h3><p>×ª×›× ×•×Ÿ × ×§×™ ×œ×©×‘×•×¢ ×”×§×¨×•×‘!</p>';
						break;
					case 'overdue':
						emptyMessage = '<h3>âœ… ××™×Ÿ ×œ×§×•×—×•×ª ×××—×¨×™×</h3><p>×›×œ ×”×˜×™×¤×•×œ×™× ×‘××•×¢×“×!</p>';
						break;
				}
				
				container.innerHTML = `
					<div class="planning-empty-state">
						${emptyMessage}
					</div>
				`;
				return;
			}

			// ×‘××¦×‘ ×©×‘×•×¢×™ - ×—×œ×•×§×” ×œ×¤×™ ×™××™×
			if (currentPlanningView === 'weekly' || currentPlanningView === 'overdue') {
				renderWeeklyPlanningByDays();
			} else {
				// ×‘××¦×‘ ×™×•××™ ××• ×××—×¨×•×ª - ×¨×©×™××” ×¨×’×™×œ×”
				renderRegularPlanningList();
			}
		}


		// ×¨×™× ×“×•×¨ ×œ××¦×‘ ×©×‘×•×¢×™ ×•×××—×¨×•×ª ×¢× ×˜××‘×™ ×™××™×
		function renderWeeklyPlanningByDays() {
			const container = document.getElementById('planningCardsContainer');
			const dayNames = ['×™×•× ×¨××©×•×Ÿ', '×™×•× ×©× ×™', '×™×•× ×©×œ×™×©×™', '×™×•× ×¨×‘×™×¢×™', '×™×•× ×—××™×©×™', '×™×•× ×©×™×©×™', '×™×•× ×©×‘×ª'];
			
			// ×™×¦×™×¨×ª ××¢×¨×š ×¢× × ×ª×•× ×™ ×™××™×
			const daysData = dayNames.map(dayName => {
				const dayClients = planningClients.filter(client => 
					(client.allowed_day || '×™×•× ×¨××©×•×Ÿ') === dayName
				);
				// ××™×•×Ÿ ×œ×§×•×—×•×ª ×”×™×•×
				dayClients.sort((a, b) => {
					if (currentPlanningView === 'overdue') {
						return b.daysOverdue - a.daysOverdue; // ×××—×¨×™× - ×œ×¤×™ ×“×—×™×¤×•×ª
					} else {
						return a.daysDiff - b.daysDiff; // ×©×‘×•×¢×™ - ×œ×¤×™ ×ª××¨×™×š
					}
				});
				
				return { dayName, clients: dayClients };
			});
			
			// ×¨×§ ×™××™× ×¢× ×œ×§×•×—×•×ª
			const activeDays = daysData.filter(day => day.clients.length > 0);
			
			if (activeDays.length === 0) {
				container.innerHTML = '<div class="planning-empty-state"><h3>××™×Ÿ ×œ×§×•×—×•×ª ×œ×”×¦×™×’</h3></div>';
				return;
			}
			
			// ×™×¦×™×¨×ª HTML ×¢× ×˜××‘×™×
			let html = `
				<div class="days-tabs-container">
					<div class="days-tabs">
						${activeDays.map((day, index) => 
							`<button class="day-tab-btn ${index === 0 ? 'active' : ''}" 
									 onclick="switchDayTab('${day.dayName}')" 
									 data-day="${day.dayName}">
								${day.dayName} (${day.clients.length})
							</button>`
						).join('')}
					</div>
					<div class="days-content">
						${activeDays.map((day, index) => 
							`<div class="day-content ${index === 0 ? 'active' : ''}" data-day="${day.dayName}">
								${day.clients.map(client => renderClientRow(client)).join('')}
							</div>`
						).join('')}
					</div>
				</div>
			`;
			
			container.innerHTML = html;
		}

		// ×¨×™× ×“×•×¨ ×¨×’×™×œ (×™×•××™/×××—×¨×•×ª)
		function renderRegularPlanningList() {
			const container = document.getElementById('planningCardsContainer');
			container.innerHTML = planningClients.map(client => renderClientRow(client)).join('');
		}

		// ×¨×™× ×“×•×¨ ×©×•×¨×ª ×œ×§×•×— (××©×•×ª×£ ×œ×©× ×™ ×”××¦×‘×™×)
		function renderClientRow(client) {
			const nextVisitFormatted = formatDate(client.next_visit);
			let statusText = '';
			
			// ×˜×§×¡×˜ ×¡×˜×˜×•×¡ ×œ×¤×™ ×ª×¦×•×’×”
			switch (currentPlanningView) {
				case 'daily':
					statusText = '××ª×•×›× ×Ÿ ×œ×”×™×•×';
					break;
				case 'weekly':
					const daysDiffText = client.daysDiff === 0 ? '×”×™×•×' : 
									   client.daysDiff === 1 ? '××—×¨' : 
									   `×‘×¢×•×“ ${client.daysDiff} ×™××™×`;
					statusText = daysDiffText;
					break;
				case 'overdue':
					statusText = client.daysOverdue === 1 ? '××™×—×•×¨ ×™×•× ××—×“' : `××™×—×•×¨ ${client.daysOverdue} ×™××™×`;
					break;
			}
			
			return `
				<div class="planning-client-row planning-status-${client.status}" data-client-id="${client.ID}">
					<div class="planning-row-main">
						<div class="planning-client-info">
							<div class="planning-client-name">${client.name}</div>
							<div class="planning-client-address">${client.full_address}</div>
							<div class="planning-client-date">ğŸ“… ${nextVisitFormatted} (${statusText})</div>
						</div>
						<div class="planning-client-price">â‚ª${client.base_amount || 0}</div>
						<div class="planning-client-actions">
							${currentPlanningView === 'daily' ? 
								`<button class="planning-action-btn planning-complete" title="×”×ª×—×œ ×˜×™×¤×•×œ" onclick="startTreatment('${client.ID}')">â–¶</button>` : 
								''
							}
							<input type="date" class="planning-date-input" value="${client.next_visit}" onchange="updateClientNextVisit('${client.ID}', this.value)" title="×ª××¨×™×š ×˜×™×¤×•×œ ×”×‘×">
							<select class="planning-active-toggle" onchange="toggleClientActive('${client.ID}', this.value)" title="×¡×˜×˜×•×¡ ×œ×§×•×—">
								<option value="1" selected>×¤×¢×™×œ</option>
								<option value="0">×œ× ×¤×¢×™×œ</option>
							</select>
							<button class="planning-history-btn" onclick="showClientHistory('${client.ID}')" title="×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×">ğŸ“‹</button>
						</div>
					</div>
					${(client.notes || client.client_requests) ? `
						<div class="planning-row-details">
							${client.client_requests ? `<div class="client-requests">ğŸ“ ×‘×§×©×•×ª: ${client.client_requests}</div>` : ''}
							${client.notes ? `<div class="client-notes">ğŸ’­ ×”×¢×¨×•×ª: ${client.notes}</div>` : ''}
						</div>
					` : ''}
				</div>
			`;
		}
	
		// ×”×—×œ×¤×ª ×˜××‘ ×™×•×
		function switchDayTab(dayName) {
			// ×”×¡×¨×ª active ××›×œ ×”×›×¤×ª×•×¨×™×
			document.querySelectorAll('.day-tab-btn').forEach(btn => btn.classList.remove('active'));
			document.querySelectorAll('.day-content').forEach(content => content.classList.remove('active'));
			
			// ×”×•×¡×¤×ª active ×œ×›×¤×ª×•×¨ ×•×ª×•×›×Ÿ ×”× ×•×›×—×™×™×
			const activeBtn = document.querySelector(`[data-day="${dayName}"]`);
			const activeContent = document.querySelector(`.day-content[data-day="${dayName}"]`);
			
			if (activeBtn) activeBtn.classList.add('active');
			if (activeContent) activeContent.classList.add('active');
		}
	
		// ×¤×•× ×§×¦×™×” ×—×“×©×”: ×”×ª×—×œ ×˜×™×¤×•×œ (××¢×‘×¨ ×œ×˜×•×¤×¡ ×¢× ×¤×¨×˜×™ ×œ×§×•×— ××•×›× ×™×)
		function startTreatment(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('×œ× × ××¦× ×œ×§×•×—', 'error');
				return;
			}
			
			// ××¢×‘×¨ ×œ×˜××‘ ×˜×™×¤×•×œ ×—×“×©
			showSection('visit');
			
			// ××™×œ×•×™ ×¤×¨×˜×™ ×”×œ×§×•×— ×‘×˜×•×¤×¡
			setTimeout(() => {
				const locationSelect = document.getElementById('visitLocation');
				if (locationSelect) {
					locationSelect.value = clientId;
					// ×”×¤×¢×œ×ª ××™×¨×•×¢ ×©×™× ×•×™ ×œ××™×œ×•×™ ×¤×¨×˜×™× × ×•×¡×¤×™×
					locationSelect.dispatchEvent(new Event('change'));
				}
				
				// ××™×œ×•×™ ×ª××¨×™×š ×”×™×•×
				const dateInput = document.getElementById('visitDate');
				if (dateInput) {
					dateInput.value = new Date().toISOString().split('T')[0];
				}
				
				showToast(`×”×ª×—×™×œ ×˜×™×¤×•×œ ×¢×‘×•×¨ ${client.name}`, 'success');
			}, 100);
		}

		// ×¢×“×›×•×Ÿ ×¤×•× ×§×¦×™×™×ª ×”×—×œ×¤×ª ×¡×˜×˜×•×¡ ×¤×¢×™×œ/×œ× ×¤×¢×™×œ
		function toggleClientActive(clientId, newStatus) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			const oldStatus = client.active;
			client.active = newStatus;
			
			// ×©××™×¨×” ××§×•××™×ª
			saveToLocalStorage();
			
			// ×©××™×¨×” ×‘×¢× ×Ÿ ×× ××—×•×‘×¨
			if (access_token && SPREADSHEET_ID) {
				updateLocationInCloud(client);
			}
			
			const statusText = newStatus === "1" ? "×¤×¢×™×œ" : "×œ× ×¤×¢×™×œ";
			showToast(`${client.name} ×”×•×’×“×¨ ×›${statusText}`, 'info');
			
			// ×¨×¢× ×•×Ÿ ×”×ª×¦×•×’×” ×¨×§ ×× ×”×œ×§×•×— ×”×¤×š ×œ×œ× ×¤×¢×™×œ
			if (newStatus === "0") {
				loadPlanningDataAdvanced();
			}
		}
	
		// ×¢×“×›×•×Ÿ ×©×¢×” ××ª×•×›× × ×ª ×œ×œ×§×•×—
		function updateClientScheduledTime(clientId, newTime) {
			const client = locations.find(loc => loc.ID === clientId);
			if (client) {
				client.scheduled_time = newTime;
				saveToLocalStorage();
				
				// ×©××™×¨×” ×‘×¢× ×Ÿ ×× ××—×•×‘×¨
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`×©×¢×ª ×˜×™×¤×•×œ ×¢×•×“×›× ×” ×œ-${newTime}`, 'success', 2000);
			}
		}

		// ×¡×™×•× ×˜×™×¤×•×œ (××¢×‘×¨ ×œ×˜×•×¤×¡ ×”×•×¡×¤×ª ×‘×™×§×•×¨)
		function completePlanningVisit(clientId) {
			showSection('visit');
			document.getElementById('locationSelect').value = clientId;
			document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
			
			const client = locations.find(loc => loc.ID === clientId);
			if (client && client.scheduled_time) {
				const timeInput = document.getElementById('visitTime');
				if (timeInput) timeInput.value = client.scheduled_time;
			}
		}

		// ×“×—×™×™×ª ×˜×™×¤×•×œ
		function postponePlanningVisit(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			const weeks = prompt(`×›××” ×©×‘×•×¢×•×ª ×œ×“×—×•×ª ××ª ×”×˜×™×¤×•×œ ×¢×‘×•×¨ ${client.name}?`, '1');
			if (weeks && !isNaN(weeks) && parseInt(weeks) > 0) {
				const currentNextVisit = new Date(client.next_visit);
				const postponedDate = new Date(currentNextVisit.getTime() + (parseInt(weeks) * 7 * 24 * 60 * 60 * 1000));
				
				client.next_visit = postponedDate.toISOString().split('T')[0];
				client.temp_addition = 0;
				
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`×˜×™×¤×•×œ × ×“×—×” ×œ-${formatDate(client.next_visit)}`, 'success');
				loadPlanningDataAdvanced();
			}
		}

		// ×ª×¤×¨×™×˜ ×¤×¢×•×œ×•×ª × ×•×¡×¤×•×ª ×œ×œ×§×•×—
		function showPlanningClientMenu(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			const actions = [
				'×¦×¤×™×™×” ×‘×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×',
				'×”×ª×—×œ×ª ×˜×™×¤×•×œ ××™×™×“×™',
				'×§×‘×™×¢×ª ×ª××¨×™×š ×¡×¤×¦×™×¤×™',
				'×¢×¨×™×›×ª ×¤×¨×˜×™ ×œ×§×•×—',
				'×‘×™×˜×•×œ'
			];
			
			const choice = prompt(`×‘×—×¨ ×¤×¢×•×œ×” ×¢×‘×•×¨ ${client.name}:\n\n` + 
				actions.map((action, i) => `${i + 1}. ${action}`).join('\n'));
			
			switch (choice) {
				case '1':
					showClientTreatmentHistory(clientId);
					break;
				case '2':
					startImmediateVisit(clientId);
					break;
				case '3':
					setSpecificVisitDate(clientId);
					break;
				case '4':
					editLocation(clientId);
					break;
			}
		}

		// ×¦×¤×™×™×” ×‘×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×
		function showClientTreatmentHistory(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			const clientVisits = visits.filter(visit => visit.location_id === clientId)
				.sort((a, b) => new Date(b.date) - new Date(a.date))
				.slice(0, 10);
			
			if (clientVisits.length === 0) {
				alert(`${client.name} - ××™×Ÿ ×¢×“×™×™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×`);
				return;
			}
			
			const historyText = clientVisits.map(visit => 
				`${formatDate(visit.date)} - ${visit.work_done || '×˜×™×¤×•×œ'} - â‚ª${visit.amount} (${getPaymentStatusText(visit.paid)})`
			).join('\n');
			
			alert(`×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™× - ${client.name}:\n\n${historyText}`);
		}

		// ×”×ª×—×œ×ª ×˜×™×¤×•×œ ××™×™×“×™
		function startImmediateVisit(clientId) {
			showSection('visit');
			document.getElementById('locationSelect').value = clientId;
			document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
			document.getElementById('visitTime').value = new Date().toTimeString().slice(0,5);
		}

		// ×§×‘×™×¢×ª ×ª××¨×™×š ×¡×¤×¦×™×¤×™ ×œ×˜×™×¤×•×œ
		function setSpecificVisitDate(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			const newDate = prompt(`×”×–×Ÿ ×ª××¨×™×š ×—×“×© ×œ×˜×™×¤×•×œ ×”×‘× ×¢×‘×•×¨ ${client.name}:`, client.next_visit);
			
			if (newDate && !isNaN(new Date(newDate))) {
				client.next_visit = newDate;
				client.temp_addition = 0;
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`×ª××¨×™×š ×”×˜×™×¤×•×œ ×”×‘× ×¢×‘×•×¨ ${client.name} ×¢×•×“×›×Ÿ ×œ-${formatDate(newDate)}`, 'success');
				loadPlanningDataAdvanced();
			}
		}
	
	
	// ×”×•×¡×¤×ª ××™×¨×•×¢×™ ×’×¨×™×¨×” ×œ×›×¨×˜×™×¡×™× (×¨×§ ×‘×ª×¦×•×’×” ×™×•××™×ª)
		let draggedPlanningCard = null;

		function addPlanningDragEvents() {
			const cards = document.querySelectorAll('.planning-client-card');
			
			cards.forEach(card => {
				card.addEventListener('dragstart', handlePlanningDragStart);
				card.addEventListener('dragend', handlePlanningDragEnd);
				card.addEventListener('dragover', handlePlanningDragOver);
				card.addEventListener('drop', handlePlanningDrop);
			});
		}

		function handlePlanningDragStart(e) {
			draggedPlanningCard = this;
			this.classList.add('planning-dragging');
			e.dataTransfer.effectAllowed = 'move';
		}

		function handlePlanningDragEnd(e) {
			this.classList.remove('planning-dragging');
			document.querySelectorAll('.planning-client-card').forEach(card => {
				card.classList.remove('planning-drag-over');
			});
		}

		function handlePlanningDragOver(e) {
			if (e.preventDefault) e.preventDefault();
			this.classList.add('planning-drag-over');
			e.dataTransfer.dropEffect = 'move';
			return false;
		}

		function handlePlanningDrop(e) {
			if (e.stopPropagation) e.stopPropagation();
			
			if (draggedPlanningCard !== this) {
				const draggedIndex = parseInt(draggedPlanningCard.dataset.index);
				const droppedIndex = parseInt(this.dataset.index);
				
				// ×”×—×œ×¤×ª ××§×•××•×ª ×‘××¢×¨×š
				const temp = planningClients[draggedIndex];
				planningClients[draggedIndex] = planningClients[droppedIndex];
				planningClients[droppedIndex] = temp;
				
				// ×¨×™× ×“×•×¨ ××—×“×©
				renderPlanningCards();
				
				showToast('×¡×“×¨ ×”×œ×§×•×—×•×ª ×©×•× ×”', 'info');
			}
			
			this.classList.remove('planning-drag-over');
			return false;
		}

		// ×©××™×¨×ª ×”×¤×•× ×§×¦×™×” ×”××§×•×¨×™×ª ×œ×¤× ×™ ×”×”×—×œ×¤×”
		window.originalLoadPlanningData = window.loadPlanningData;

		// ×”×—×œ×¤×ª ×”×¤×•× ×§×¦×™×” loadPlanningData
		window.loadPlanningData = function() {
			console.log('ğŸ”„ loadPlanningData × ×§×¨××”');
			
			// ×‘×“×™×§×” ×× ×™×© ××ª ×”××œ×× ×˜×™× ×”×—×“×©×™×
			if (document.getElementById('planningCardsContainer')) {
				console.log('ğŸ“Š ××©×ª××© ×‘××¢×¨×›×ª ×—×“×©×”');
				loadPlanningDataAdvanced();
			} else {
				console.log('ğŸ“Š ××©×ª××© ×‘××¢×¨×›×ª ×™×©× ×”');
				updatePlanningStats();
				filterVisits(window.currentFilter || 'today');
			}
		};

		// ×¢×“×›×•×Ÿ ×”×¤×•× ×§×¦×™×” refreshPlanningAfterTreatmentUpdate ×œ×¢×‘×•×“ ×¢× ×©×ª×™ ×”××¢×¨×›×•×ª
		function refreshPlanningAfterTreatmentUpdate() {
			const currentSection = document.querySelector('.section.active');
			if (currentSection && currentSection.id === 'planning') {
				loadPlanningData(); // ×–×” ×™×§×¨× ×œ××¢×¨×›×ª ×”××ª××™××”
			}
			
			loadLocationsForSelect();
		}
	
	/////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>


		// ×ª×•×¡×¤×” - ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
		function updatePlanningStats() {
			// ×œ×§×•×—×•×ª
			const totalLocations = locations.length;
			const activeLocations = locations.filter(loc => loc.active === '×›×Ÿ').length;
			
			// ×˜×™×¤×•×œ×™× ×”×©×‘×•×¢
			const today = new Date();
			const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
			const weeklyVisits = visits.filter(visit => {
				const visitDate = new Date(visit.date);
				return visitDate >= weekAgo && visitDate <= today;
			});
			
			// ×”×›× ×¡×” ×”×©×‘×•×¢
			const weeklyIncome = weeklyVisits.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			// ×—×•×‘×•×ª ×¤×ª×•×—×™×
			const openDebts = visits
				.filter(visit => visit.paid === '0')
				.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			// ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
			document.getElementById('totalLocations').textContent = totalLocations;
			document.getElementById('activeLocations').textContent = `${activeLocations} (${totalLocations > 0 ? Math.round((activeLocations / totalLocations) * 100) : 0}%)`;
			document.getElementById('weeklyVisits').textContent = weeklyVisits.length;
			document.getElementById('weeklyIncome').textContent = `â‚ª${weeklyIncome.toLocaleString()}`;
			document.getElementById('openDebts').textContent = `â‚ª${openDebts.toLocaleString()}`;
		}

        function filterVisits(filter) {
			currentFilter = filter;
			
			// Update filter buttons
			document.querySelectorAll('.filter-btn').forEach(btn => {
				btn.classList.remove('active');
				if ((filter === 'today' && btn.textContent === '×”×™×•×') ||
					(filter === 'week' && btn.textContent === '×”×©×‘×•×¢') ||
					(filter === 'overdue' && btn.textContent === '×××•×—×¨×•×ª')) {
					btn.classList.add('active');
				}
			});
			
			// Filter locations based on next_visit date
			const today = new Date();
			today.setHours(0, 0, 0, 0); // ×ª×—×™×œ×ª ×”×™×•×
			const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
			
			let filteredlocations = locations.filter(location => {
				return location.active === "1" && location.next_visit && location.next_visit.trim() !== '';
			});
			
			switch(filter) {
				case 'today':
					// ×œ×§×•×—×•×ª ×©×”×ª××¨×™×š ×”×‘× ×©×œ×”× ×”×•× ×”×™×•× ××• ×¢×‘×¨ (×¦×¨×™×›×™× ×˜×™×¤×•×œ)
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						nextVisit.setHours(0, 0, 0, 0); // ×ª×—×™×œ×ª ×”×™×•×
						return nextVisit <= today;
					});
					break;
				case 'week':
					// ×œ×§×•×—×•×ª ×©×”×ª××¨×™×š ×”×‘× ×©×œ×”× ×”×•× ×”×©×‘×•×¢ ×”×§×¨×•×‘ ××• ×¢×‘×¨
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						return nextVisit <= weekFromNow;
					});
					break;
				case 'overdue':
					// ×œ×§×•×—×•×ª ×©×”×ª××¨×™×š ×”×‘× ×©×œ×”× ×¢×‘×¨ (×××•×—×¨×™×)
					const yesterday = new Date(today);
					yesterday.setDate(yesterday.getDate() - 1);
					
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						return nextVisit <= yesterday;
					});
					break;
			}
			
			displayPlanningTable(filteredlocations);
		}

        function displayPlanningTable(locationsToShow) {
            const tbody = document.getElementById('planningTableBody');
            tbody.innerHTML = '';
            
            if (locationsToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">××™×Ÿ ×’×™× ×•×ª ×œ×˜×™×¤×•×œ</td></tr>';
                return;
            }
            
            locationsToShow.forEach(location => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${location.name}</td>
                    <td>${location.full_address}</td>
                    <td>${location.allowed_day}</td>
                    <td>${formatDate(location.next_visit)}</td>
                    <td>
                        <button class="action-btn start-visit-btn" onclick="startVisitForlocation(${location.ID})">
                            ×”×ª×—×œ ×˜×™×¤×•×œ
                        </button>
                        <button class="action-btn edit-btn" onclick="postponeVisit(${location.ID})">
                            ×“×—×”
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadLocationsForSelect() {
            const select = document.getElementById('locationSelect');
            select.innerHTML = '<option value="">×‘×—×¨ ×œ×§×•×—...</option>';
            
            locations.filter(location => location.active === "1").forEach(location => {
                const option = document.createElement('option');
                option.value = location.ID;
                option.textContent = `${location.name} - ${location.full_address}`;
                select.appendChild(option);
            });
        }

       function loadLocationsTable() {
			const tbody = document.getElementById('locationsTableBody');
			tbody.innerHTML = '';
			
			locations.forEach(location => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${location.name}</td>
					<td>${location.full_address}</td>
					<td>${location.contact_person}</td>
					<td>${location.allowed_day}</td>
					<td>${location.interval_weeks} ×©×‘×•×¢×•×ª</td>
					<td>${location.active}</td>
					<td>
						<button class="action-btn edit-btn" onclick="editLocation('${location.ID}')">×¢×¨×•×š</button>
						<button class="action-btn delete-btn" onclick="deleteLocation('${location.ID}')">××—×§</button>
					</td>
				`;
				tbody.appendChild(row);
			});
		}

       function loadReceiptsTable() {
			const tbody = document.getElementById('receiptsTableBody');
			tbody.innerHTML = '';
			
			if (receipts.length === 0) {
				tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">××™×Ÿ ×§×‘×œ×•×ª</td></tr>';
				return;
			}

			receipts.forEach(receipt => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${receipt.book_number}</td>
					<td>${receipt.receipt_number}</td>
					<td>${formatDate(receipt.date)}</td>
					<td>${receipt.location_name}</td>
					<td>${receipt.amount}</td>
					<td>${receipt.payment_type}</td>
					<td>${receipt.codeX || ''}</td>
					<td>
						<button class="action-btn edit-btn" onclick="editReceipt('${receipt.ID}')">×¢×¨×•×š</button>
						<button class="action-btn delete-btn" onclick="deleteReceipt('${receipt.ID}')">××—×§</button>
					</td>
				`;
				tbody.appendChild(row);
			});
		}

        // Visithandling
        function startVisitForlocation(locationId) {
            const location = locations.find(g => g.ID === locationId);
            if (location) {
                showSection('visit');
                document.getElementById('locationSelect').value = locationId;
            }
        }

        function handleVisitSubmit(event) {
			event.preventDefault();
			
			const formData = new FormData(event.target);
			const selectedLocationId = document.getElementById('locationSelect').value;
			const visitDate = document.getElementById('visitDate').value; // ×”×ª××¨×™×š ×”× ×•×›×—×™
			const endTime = document.getElementById('endTime').value;
			const paymentStatus = document.getElementById('paymentStatus').value;
			
			// ×‘×“×™×§×•×ª ×‘×¡×™×¡×™×•×ª
			if (!selectedLocationId) {
				showError('×× × ×‘×—×¨ ×œ×§×•×—');
				return;
			}
			
			// ×‘×“×™×§×ª ×›×¤×™×œ×•×ª
			const duplicateVisit = checkDuplicateVisit(selectedLocationId, visitDate);
			if (duplicateVisit) {
				const location = locations.find(loc => loc.ID == selectedLocationId);
				const locationName = location ? location.name : '×œ×§×•×— ×œ× ×™×“×•×¢';
				
				const confirmMessage = `×›×‘×¨ ×§×™×™× ×˜×™×¤×•×œ ×œ×œ×§×•×— "${locationName}" ×”×™×•× (${formatDate(visitDate)}).\n\n×”×× ×œ×”×•×¡×™×£ ×˜×™×¤×•×œ × ×•×¡×£ ×‘×›×œ ×–××ª?`;
				
				if (!confirm(confirmMessage)) {
					return; // ×‘×™×˜×•×œ ×”×•×¡×¤×”
				}
			}

			// ×—×™×©×•×‘ ××•×˜×•××˜×™ ×©×œ ××©×š ×”×–××Ÿ ×× ×™×© ×©×¢×ª ×”×ª×—×œ×” ×•×¡×™×•×
			let calculatedDuration = document.getElementById('duration_minutes').value;
			const startTime = document.getElementById('visitTime').value;
			if (startTime && endTime) {
				const start = new Date(`2000-01-01 ${startTime}`);
				const end = new Date(`2000-01-01 ${endTime}`);
				const diffMs = end - start;
				if (diffMs > 0) {
					calculatedDuration = Math.round(diffMs / (1000 * 60)); // ×”×¤×¨×© ×‘×“×§×•×ª
					document.getElementById('duration_minutes').value = calculatedDuration;
				}
			}


			const visitData = {
				location_id: selectedLocationId,  
				visit_type: document.getElementById('visitType').value,
				work_done: document.getElementById('workDone').value,
				duration_minutes: parseFloat(document.getElementById('manualDurationMinutes').value) || 0,
				workers_count: parseInt(document.getElementById('numberOfWorkersVisit').value) || 1,		
				amount: document.getElementById('amount').value || 0,
				expense: document.getElementById('expense').value || 0,
				date: visitDate,
				start_time: document.getElementById('visitTime').value,
				end_time: endTime,
				paid: paymentStatus,
				notes: document.getElementById('notes') ? document.getElementById('notes').value : ''
			};
			
			console.log('Visitdata:', visitData);
			
			// Here we would save to Google Sheets
			saveVisit(visitData);
		}

		// ×œ×©× ×•×ª ×‘×¤×•× ×§×¦×™×” ×”×§×™×™××ª - ×œ×”×•×¡×™×£ ×©××™×¨×” ×œ×©×™×˜×¡
		async function saveVisit(visitData) {
			try {
				// For now, just add to local array
				const newVisit = {
					ID: generateID(),
					location_name: location ? location.name : '',
					notes: visitData.notes || '',     // ××©×ª××© ×‘×¢×¨×š ××”×˜×•×¤×¡
					...visitData                      // ×©××¨ ×”× ×ª×•× ×™× - ×œ×œ× paid
				};
				
				// ×‘×“×™×§×ª ×ª×§×™× ×•×ª
				const visitErrors = validateVisitData(visitData);
				if (showValidationErrors(visitErrors)) {
					return;
				}
				
				// ×‘×“×™×§×ª ×›×¤×™×œ×•×™×•×ª ×‘×™×§×•×¨
				const existingVisit = visits.find(visit => 
					visit.location_id === visitData.location_id &&
					visit.date === visitData.date &&
					Math.abs(new Date(`${visit.date} ${visit.start_time}`) - new Date(`${visitData.date} ${visitData.start_time}`)) < 60000 // ×¤×—×•×ª ××“×§×” ×”×¤×¨×©
				);

				if (existingVisit) {
					if (!confirm(`×›×‘×¨ ×§×™×™× ×‘×™×§×•×¨ ×‘××•×ª×” ×›×ª×•×‘×ª ×‘××•×ª×• ×ª××¨×™×š ×•×©×¢×” ×“×•××”.\n\n×”×× ×œ×”×•×¡×™×£ ×‘×›×œ ×–××ª?`)) {
						return; // ×‘×™×˜×•×œ ×”×•×¡×¤×”
					}
				}
				
				visits.push(newVisit);

				// ×ª×•×¡×¤×” - ×©××™×¨×” ×œ×’×•×’×œ ×©×™×˜×¡
				if (access_token) {
					await saveVisitToSheets(newVisit);
				}

				// Update next visitdate if it's a full visit
				if (visitData.visit_type === '××œ×') {
				   updateNextVisitDate(visitData.location_id);
				}
		
				showSuccess('×˜×™×¤×•×œ × ×©××¨ ×‘×”×¦×œ×—×”!');
				
				// Reset form
				document.getElementById('visitForm').reset();
			   		   
				// Reload planning data
				loadPlanningData();
				saveToLocalStorage();
				   
			} catch (error) {
				console.error('Error saving visit:', error);
				showError('×©×’×™××” ×‘×©××™×¨×ª ×”×˜×™×¤×•×œ');
			}
		}

		function updateNextVisitDate(locationId) {
			const location = locations.find(g => g.ID == locationId);
			if (location) {
               const lastVisit= new Date();
               const intervalWeeks = parseInt(location.interval_weeks) + parseInt(location.temp_addition || 0);
               const nextVisit= new Date(lastVisit.getTime() + (intervalWeeks * 7 * 24 * 60 * 60 * 1000));
               
               location.last_visit= lastVisit.toISOString().split('T')[0];
               location.next_visit= nextVisit.toISOString().split('T')[0];
               location.temp_addition = 0; // Reset temporary addition
               
               // Here we would update Google Sheets
               console.log(`Updated next visitfor ${location.name}: ${location.next_visit}`);
			}
		}

		function postponeVisit(locationId) {
			const location = locations.find(g => g.ID == locationId);
			if (location) {
				const weeks = prompt('×›××” ×©×‘×•×¢×•×ª ×œ×“×—×•×ª?', '1');
				if (weeks && !isNaN(weeks)) {
					const currentNext = new Date(location.next_visit);
					const newNext = new Date(currentNext.getTime() + (parseInt(weeks) * 7 * 24 * 60 * 60 * 1000));
					location.next_visit= newNext.toISOString().split('T')[0];

					loadPlanningData();
					showSuccess(`×˜×™×¤×•×œ × ×“×—×” ×‘-${weeks} ×©×‘×•×¢×•×ª`);
				}
			}
		}

        // location management
        function showAddLocationForm() {
			const modalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">×”×•×¡×¤×ª ×œ×§×•×— ×—×“×©</h3>
					
					<form id="locationForm" onsubmit="handleLocationSubmit(event)">
						<div class="form-group">
							<label for="locationName">×©× ×œ×§×•×—:</label>
							<input type="text" id="locationName" required>
						</div>
						<div class="form-group">
							<label for="locationAddress">×›×ª×•×‘×ª ××œ××”:</label>
							<input type="text" id="locationAddress" required>
						</div>
						<div class="form-group">
							<label for="locationNeighborhood">×©×›×•× ×”:</label>
							<input type="text" id="locationNeighborhood">
						</div>
						<div class="form-group">
							<label for="locationCity">×¢×™×¨:</label>
							<input type="text" id="locationCity">
						</div>
						<div class="form-group">
							<label for="locationContact">××™×© ×§×©×¨:</label>
							<input type="text" id="locationContact">
						</div>
						<div class="form-group">
							<label for="locationPhone">×˜×œ×¤×•×Ÿ:</label>
							<input type="tel" id="locationPhone">
						</div>
						<div class="form-group">
							<label for="locationDay">×™×•× ××•×¢×“×£:</label>
							<select id="locationDay">
								<option value="×›×œ ×™×•×">×›×œ ×™×•×</option>
								<option value="×™×•× ×¨××©×•×Ÿ">×™×•× ×¨××©×•×Ÿ</option>
								<option value="×™×•× ×©× ×™">×™×•× ×©× ×™</option>
								<option value="×™×•× ×©×œ×™×©×™">×™×•× ×©×œ×™×©×™</option>
								<option value="×™×•× ×¨×‘×™×¢×™">×™×•× ×¨×‘×™×¢×™</option>
								<option value="×™×•× ×—××™×©×™">×™×•× ×—××™×©×™</option>
								<option value="×™×•× ×©×™×©×™">×™×•× ×©×™×©×™</option>
							</select>
						</div>
						<div class="form-group">
							<label for="locationInterval">××¨×•×•×— ×©×‘×•×¢×•×ª:</label>
							<input type="number" id="locationInterval" value="4" min="1">
						</div>
						<div class="form-group">
							<label for="locationAmount">×¡×›×•× ×‘×¡×™×¡×™:</label>
							<input type="number" id="locationAmount">
						</div>
						<div class="form-group">
							<label for="locationActive">×¤×¢×™×œ×•×ª:</label>
							<select id="locationActive" required>
								<option value="1">×¤×¢×™×œ</option>
								<option value="0">×œ× ×¤×¢×™×œ</option>
							</select>
						</div>
						<div class="form-group">
							<label for="locationNextVisit">×ª××¨×™×š ×œ×˜×™×¤×•×œ ×”×‘×:</label>
							<input type="date" id="locationNextVisit" required>
						</div>
						<div class="form-group">
							<label for="locationClientRequests">×‘×§×©×•×ª ×œ×§×•×—:</label>
							<textarea id="locationClientRequests" rows="2"></textarea>
						</div>
						<div class="form-group">
							<label for="locationNotes">×”×¢×¨×•×ª:</label>
							<textarea id="locationNotes" rows="3"></textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="submit" class="btn btn-success">×©××•×¨ ×œ×§×•×—</button>
							<button type="button" onclick="closeEditModal()" class="btn btn-secondary">×‘×™×˜×•×œ</button>
						</div>
					</form>
				</div>
			`;
			
			showEditModal(modalHTML);
			
			// Set default date
			document.getElementById('locationNextVisit').value = new Date().toISOString().split('T')[0];
		}

        async function handleLocationSubmit(event) {
            event.preventDefault();
           
			const locationData = {
				ID: generateID(),
				name: document.getElementById('locationName').value,
				full_address: document.getElementById('locationAddress').value,
				neighborhood: document.getElementById('locationNeighborhood').value,
				city: document.getElementById('locationCity').value,
				contact_person: document.getElementById('locationContact').value,
				phone: document.getElementById('locationPhone').value,
				allowed_day: document.getElementById('locationDay').value,
				interval_weeks: parseInt(document.getElementById('locationInterval').value),
				temp_addition: 0,
				base_amount: parseFloat(document.getElementById('locationAmount').value) || 0,
				active: document.getElementById('locationActive').value,
				notes: document.getElementById('locationNotes').value,
				client_requests: document.getElementById('locationClientRequests').value || '', // ×©×“×” ×—×“×©
				last_visit: '',
				next_visit: document.getElementById('locationNextVisit').value
			};
           
		    // ×‘×“×™×§×ª ×›×¤×™×œ×•×™×•×ª ×’× ×œ×¤×™ ID ×•×’× ×œ×¤×™ ×›×ª×•×‘×ª
			const existingLocation = locations.find(loc => 
				loc.ID === locationData.ID || 
				(loc.full_address && locationData.full_address &&
				 loc.full_address.toLowerCase().trim() === locationData.full_address.toLowerCase().trim())
			);

			if (existingLocation) {
				if (!confirm(`×œ×§×•×— ×¢× ×›×ª×•×‘×ª "${locationData.full_address}" ×›×‘×¨ ×§×™×™×.\n\n×”×× ×œ×”×•×¡×™×£ ×‘×›×œ ×–××ª?`)) {
					return; // ×‘×™×˜×•×œ ×”×•×¡×¤×”
				}
			}
		   
            // ×©××™×¨×” ×œ×–×™×›×¨×•×Ÿ ××§×•××™
			locations.push(locationData);

			// ×©××™×¨×” ××•×˜×•××˜×™×ª ×œ×¢× ×Ÿ
			if (access_token && spreadsheet_id) {
				document.getElementById('statusText').textContent = 'ğŸ”„ ×©×•××¨ ×œ×§×•×—...';
				try {
					await saveLocationToSheets(locationData);
					document.getElementById('statusText').textContent = '××—×•×‘×¨';
					showSuccess('×œ×§×•×— × ×©××¨ ×‘×”×¦×œ×—×” ×œ-Google Sheets!');
				} catch (error) {
					if (error.status === 401) {
						document.getElementById('statusText').textContent = 'ğŸ”“ × ×“×¨×© ×—×™×‘×•×¨ ××—×“×©';
						document.getElementById('statusText').classList.remove('connected');
						showToast('âš ï¸ ×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×”×ª×—×‘×¨ ××—×“×©', 'warning');
						access_token = null;
					} else {
						document.getElementById('statusText').textContent = 'âš ï¸ ×©×’×™××” ×‘×©××™×¨×”';
						showToast('âš ï¸ ×”×œ×§×•×— × ×©××¨ ××§×•××™×ª ×‘×œ×‘×“', 'warning');
					}
				}
			} else {
				showToast('ğŸ”“ ×œ×§×•×— × ×©××¨ ××§×•××™×ª - ×”×ª×—×‘×¨ ×œ×¢× ×Ÿ ×œ×©××™×¨×”', 'warning');
			}

			closeEditModal();
			loadLocationsTable();
			loadLocationsForSelect();
			saveToLocalStorage();
        }

		function editLocation(locationId) {
			console.log(`âœ… editLocation ('${locationId}')`);
			const location = locations.find(g => g.ID == locationId);
			if (!location) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			console.log(`âœ… editLocation second: ('${locationId}')`);
			
			// ×¦×•×¨ ×—×œ×•×Ÿ ×¢×¨×™×›×”
			const editModalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ  ×¢×¨×™×›×ª ×œ×§×•×— - ${location.name}</h3>
					
					<form id="editLocationForm">
						<div class="form-group">
							<label>×©× ×”×œ×§×•×—:</label>
							<input type="text" id="editLocationName" value="${location.name || ''}" required>
						</div>
						
						<div class="form-group">
							<label>×›×ª×•×‘×ª ××œ××”:</label>
							<input type="text" id="editLocationAddress" value="${location.full_address || ''}" required>
						</div>
						
						<div class="form-group">
							<label>×©×›×•× ×”:</label>
							<input type="text" id="editLocationNeighborhood" value="${location.neighborhood || ''}">
						</div>
						
						<div class="form-group">
							<label>×¢×™×¨:</label>
							<input type="text" id="editLocationCity" value="${location.city || ''}">
						</div>
						
						<div class="form-group">
							<label>××™×© ×§×©×¨:</label>
							<input type="text" id="editLocationContact" value="${location.contact_person || ''}">
						</div>
						
						<div class="form-group">
							<label>×˜×œ×¤×•×Ÿ:</label>
							<input type="tel" id="editLocationPhone" value="${location.phone || ''}">
						</div>
						
						<div class="form-group">
							<label>×™×•× ××•×¢×“×£:</label>
							<select id="editLocationDay" value="${location.allowed_day||''}>
								<option value="×›×œ ×™×•×" ${location.allowed_day === '×›×œ ×™×•×' ? 'selected' : ''}>×›×œ ×™×•×</option>
								<option value="×™×•× ×¨××©×•×Ÿ" ${location.allowed_day === '×™×•× ×¨××©×•×Ÿ' ? 'selected' : ''}>×™×•× ×¨××©×•×Ÿ</option>
								<option value="×™×•× ×©× ×™" ${location.allowed_day === '×™×•× ×©× ×™' ? 'selected' : ''}>×™×•× ×©× ×™</option>
								<option value="×™×•× ×©×œ×™×©×™" ${location.allowed_day === '×™×•× ×©×œ×™×©×™' ? 'selected' : ''}>×™×•× ×©×œ×™×©×™</option>
								<option value="×™×•× ×¨×‘×™×¢×™" ${location.allowed_day === '×™×•× ×¨×‘×™×¢×™' ? 'selected' : ''}>×™×•× ×¨×‘×™×¢×™</option>
								<option value="×™×•× ×—××™×©×™" ${location.allowed_day === '×™×•× ×—××™×©×™' ? 'selected' : ''}>×™×•× ×—××™×©×™</option>
								<option value="×™×•× ×©×™×©×™" ${location.allowed_day === '×™×•× ×©×™×©×™' ? 'selected' : ''}>×™×•× ×©×™×©×™</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>××¨×•×•×— ×‘×©×‘×•×¢×•×ª:</label>
							<input type="number" id="editLocationInterval" value="${location.interval_weeks || 4}" min="1" required>
						</div>
						
						<div class="form-group">
							<label>×¡×›×•× ×‘×¡×™×¡ (â‚ª):</label>
							<input type="number" id="editLocationAmount" value="${location.base_amount || 0}" step="0.01">
						</div>
						
						<div class="form-group">
							<label>×¡×˜×˜×•×¡:</label>
							<select id="editLocationActive">
								<option value="1" ${location.active === '1' ? 'selected' : ''}>×¤×¢×™×œ</option>
								<option value="0" ${location.active === '0' ? 'selected' : ''}>×œ× ×¤×¢×™×œ</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>×˜×™×¤×•×œ ×”×‘×:</label>
							<input type="date" id="editLocationNextVisit" value="${location.next_visit || ''}">
						</div>
						
						<div class="form-group">
							<label>×”×¢×¨×•×ª:</label>
							<textarea id="editLocationNotes" rows="3">${location.notes || ''}</textarea>
						</div>
						
						<div class="form-group">
							<label>×‘×§×©×•×ª ×œ×§×•×—:</label>
							<textarea id="editLocationClientRequests" rows="2">${location.client_requests || ''}</textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="button" onclick="saveEditedLocation('${locationId}')" class="btn btn-success">
								ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×
							</button>
							<button type="button" onclick="closeEditModal()" class="btn btn-secondary">
								âŒ ×‘×™×˜×•×œ
							</button>
						</div>
					</form>
				</div>
			`;
			
			// ×”×¦×’ ××ª ×”××•×“×œ
			showEditModal(editModalHTML);
		}

		// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×”×œ×§×•×— ×‘×¢× ×Ÿ (××•×¤×¦×™×•× ×œ×™×ª)
		async function updateLocationInCloud(updatedLocation) {
			if (!await validateToken()) return;
			
			try {
				// ×§×¨×™××ª ×›×œ ×”× ×ª×•× ×™× ××”×¢× ×Ÿ
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:P' // âœ… ×©×•× ×” ×-A:O ×œ-A:P
				});
				
				const rows = response.result.values || [];
				
				// ××¦×™××ª ×”×©×•×¨×” ×œ×¢×“×›×•×Ÿ
				let rowToUpdate = -1;
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] == updatedLocation.ID) {
						rowToUpdate = i + 1; // +1 ×›×™ Google Sheets ××ª×—×™×œ ×-1
						break;
					}
				}
				
				if (rowToUpdate > 0) {
					// ×¢×“×›×•×Ÿ ×”×©×•×¨×”
					const updatedRow = [
						updatedLocation.ID,
						updatedLocation.name,
						updatedLocation.full_address,
						updatedLocation.neighborhood,
						updatedLocation.city,
						updatedLocation.contact_person,
						updatedLocation.phone,
						updatedLocation.allowed_day,
						updatedLocation.interval_weeks,
						updatedLocation.temp_addition || 0,
						updatedLocation.base_amount,
						updatedLocation.active,
						updatedLocation.notes,
						updatedLocation.last_visit || '',
						updatedLocation.next_visit || '',
						updatedLocation.client_requests || '' // âœ… ×”×•×¡×£ ×©×“×” client_requests
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Locations!A${rowToUpdate}:P${rowToUpdate}`, // âœ… ×©×•× ×” ×-O ×œ-P
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [updatedRow]
						}
					});
					
					console.log(`âœ… Updated location ${updatedLocation.ID} in cloud`);
				}
				
			} catch (error) {
				console.error('Error updating location in cloud:', error);
				throw error;
			}
		}
        

       function deleteLocation(locationId) {
           if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×œ×§×•×—?')) {
               locations = locations.filter(g => g.ID != locationId);
               loadLocationsTable();
               loadLocationsForSelect();
               loadPlanningData();
               showSuccess('×œ×§×•×— × ××—×§ ×‘×”×¦×œ×—×”!');
			   saveToLocalStorage();
           }
       }

       // Receipt management
       function showAddReceiptForm() {
           const modalHTML = `
               <div class="modal" id="receiptModal">
                   <div class="modal-content">
                       <div class="modal-header">
                           <h3>×”×•×¡×¤×ª ×§×‘×œ×” ×—×“×©×”</h3>
                           <span class="close" onclick="closeModal('receiptModal')">&times;</span>
                       </div>
                       <form id="receiptForm" onsubmit="handleReceiptSubmit(event)">
                           <div class="form-group">
                               <label for="receiptBook">××¡×¤×¨ ×¤× ×§×¡:</label>
                               <input type="number" id="receiptBook" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptNumber">××¡×¤×¨ ×§×‘×œ×”:</label>
                               <input type="number" id="receiptNumber" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptDate">×ª××¨×™×š:</label>
                               <input type="date" id="receiptDate" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptlocations">×’×™× ×”:</label>
                               <select id="receiptlocations" required>
                                   <option value="">×‘×—×¨ ×’×™× ×”...</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label for="receiptAmount">×¡×›×•×:</label>
                               <input type="number" id="receiptAmount" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptPaymentType">×¡×•×’ ×ª×©×œ×•×:</label>
                               <select id="receiptPaymentType" required>
                                   <option value="">×‘×—×¨ ×¡×•×’...</option>
                                   <option value="××–×•××Ÿ">××–×•××Ÿ</option>
                                   <option value="×¦'×§">×¦'×§</option>
                                   <option value="×”×¢×‘×¨×”">×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
                                   <option value="×‘×™×˜">×‘×™×˜</option>
                                   <option value="×¤×™×™×‘×•×§×¡">×¤×™×™×‘×•×§×¡</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label for="receiptNotes">×”×¢×¨×•×ª:</label>
                               <textarea id="receiptNotes"></textarea>
                           </div>
                           <button type="submit">×©××•×¨ ×§×‘×œ×”</button>
                       </form>
                   </div>
               </div>
           `;
           
           document.getElementById('modalContainer').innerHTML = modalHTML;
           document.getElementById('receiptModal').style.display = 'block';
           
           // Set default date to today
           document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
           
           // Populate locations select
           const select = document.getElementById('receiptlocations');
           locations.forEach(location => {
               const option = document.createElement('option');
               option.value = location.ID;
               option.textContent = `${location.name} - ${location.full_address}`;
               select.appendChild(option);
           });
       }

       async function handleReceiptSubmit(event) {
           event.preventDefault();
           
           const locationId = document.getElementById('receiptlocation').value;
           const location = locations.find(g => g.ID == locationId);
           
           const receiptData = {
				ID: Date.now(),
				book_number: document.getElementById('receiptBook').value,
				receipt_number: document.getElementById('receiptNumber').value,
				date: document.getElementById('receiptDate').value,
				location_id: locationId,        
				location_name: location ? location.name : '',  // ×©×•× ×” ×-location_name
				amount: parseFloat(document.getElementById('receiptAmount').value),
				payment_type: document.getElementById('receiptPaymentType').value,
				notes: document.getElementById('receiptNotes').value
			};
           
		   // ×ª×•×¡×¤×” - ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×œ×¤× ×™ ×©××™×¨×”
			const errors = validateReceiptData(receiptData);
			if (showValidationErrors(errors)) {
				return; // ×™×© ×©×’×™××•×ª - ×¢×¦×•×¨ ×›××Ÿ
			}
		   
		   // ×‘×“×™×§×ª ×›×¤×™×œ×•×™×•×ª ×§×‘×œ×”
			const existingReceipt = receipts.find(receipt => 
				(receipt.book_number === receiptData.book_number && receipt.receipt_number === receiptData.receipt_number) ||
				(receipt.location_id === receiptData.location_id && receipt.date === receiptData.date && receipt.amount === receiptData.amount)
			);

			if (existingReceipt) {
				if (!confirm(`×›×‘×¨ ×§×™×™××ª ×§×‘×œ×” ×¢× ××•×ª×• ××¡×¤×¨ ××• ×‘××•×ª×” ×›×ª×•×‘×ª/×ª××¨×™×š/×¡×›×•×.\n\n×”×× ×œ×”×•×¡×™×£ ×‘×›×œ ×–××ª?`)) {
					return; // ×‘×™×˜×•×œ ×”×•×¡×¤×”
				}
			}
		   
            receipts.push(receiptData);
		   
			if (access_token) {
				await saveReceiptToSheets(receiptData);
				showSuccess('×§×‘×œ×” × ×©××¨×” ×‘×”×¦×œ×—×” ×œ-Google Sheets!');
			} else {
				showSuccess('×§×‘×œ×” × ×©××¨×” ××§×•××™×ª!');
			}

			closeModal('receiptModal');
			loadReceiptsTable();
			saveToLocalStorage();
       }

       // Utility functions
       function closeModal(modalId) {
           document.getElementById(modalId).style.display = 'none';
       }

       function formatDate(dateString) {
           const date = new Date(dateString);
           return date.toLocaleDateString('he-IL');
       }

       function showLoading(message) {
           // Could implement loading spinner
           console.log('Loading:', message);
       }

       function hideLoading() {
           // Hide loading spinner
           console.log('Loading complete');
       }

       
       // Click outside modal to close
       window.onclick = function(event) {
           if (event.target.classList.contains('modal')) {
               event.target.style.display = 'none';
           }
       }
	   
	  function editReceipt(receiptId) {
			console.log(`âœ… editReceipt ('${receiptId}')`);
			const receipt = receipts.find(r => r.ID == receiptId);
			if (!receipt) {
				showToast('×§×‘×œ×” ×œ× × ××¦××”', 'error');
				return;
			}
			
			// ×‘× ×™×™×ª ××¤×©×¨×•×™×•×ª ×”×œ×§×•×—×•×ª
			let locationOptions = '<option value="">×‘×—×¨ ×œ×§×•×—</option>';
			locations.forEach(location => {
				const selected = location.ID == receipt.location_id ? 'selected' : '';
				locationOptions += `<option value="${location.ID}" ${selected}>${location.name} - ${location.full_address}</option>`;
			});
			
			// ×¦×•×¨ ×—×œ×•×Ÿ ×¢×¨×™×›×”
			const editModalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ§¾ ×¢×¨×™×›×ª ×§×‘×œ×”</h3>
					
					<form id="editReceiptForm">
						<div class="form-group">
							<label>××¡×¤×¨ ×¤× ×§×¡:</label>
							<input type="text" id="editReceiptBook" value="${receipt.book_number || ''}" required>
						</div>
						
						<div class="form-group">
							<label>××¡×¤×¨ ×§×‘×œ×”:</label>
							<input type="text" id="editReceiptNumber" value="${receipt.receipt_number || ''}" required>
						</div>
						
						<div class="form-group">
							<label>×ª××¨×™×š:</label>
							<input type="date" id="editReceiptDate" value="${receipt.date}" required>
						</div>
						
						<div class="form-group">
							<label>×œ×§×•×—:</label>
							<select id="editReceiptLocation" required>
								${locationOptions}
							</select>
						</div>
						
						<div class="form-group">
							<label>×¡×›×•× (â‚ª):</label>
							<input type="number" step="0.01" id="editReceiptAmount" value="${receipt.amount || 0}" required>
						</div>
						
						<div class="form-group">
							<label>×¡×•×’ ×ª×©×œ×•×:</label>
							<select id="editReceiptPaymentType">
								<option value="××–×•××Ÿ" ${receipt.payment_type === '××–×•××Ÿ' ? 'selected' : ''}>××–×•××Ÿ</option>
								<option value="×”×¢×‘×¨×”" ${receipt.payment_type === '×”×¢×‘×¨×”' ? 'selected' : ''}>×”×¢×‘×¨×”</option>
								<option value="×¦×³×§" ${receipt.payment_type === '×¦×³×§' ? 'selected' : ''}>×¦×³×§</option>
								<option value="×›×¨×˜×™×¡ ××©×¨××™" ${receipt.payment_type === '×›×¨×˜×™×¡ ××©×¨××™' ? 'selected' : ''}>×›×¨×˜×™×¡ ××©×¨××™</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>×”×¢×¨×•×ª:</label>
							<textarea id="editReceiptNotes" rows="3">${receipt.notes || ''}</textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="button" onclick="saveEditedReceipt('${receiptId}')" class="btn btn-success">
								ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×
							</button>
							<button type="button" onclick="closeEditModal()" class="btn btn-secondary">
								âŒ ×‘×™×˜×•×œ
							</button>
						</div>
					</form>
				</div>
			`;
			
			// ×”×¦×’ ××ª ×”××•×“×œ
			showEditModal(editModalHTML);
		}

		
		// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×”×§×‘×œ×” ×‘×¢× ×Ÿ (××•×¤×¦×™×•× ×œ×™×ª)
		async function updateReceiptInCloud(updatedReceipt) {
			if (!await validateToken()) return;
			
			try {
				// ×§×¨×™××ª ×›×œ ×”× ×ª×•× ×™× ××”×¢× ×Ÿ
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Receipts!A:I'
				});
				
				const rows = response.result.values || [];
				
				// ××¦×™××ª ×”×©×•×¨×” ×œ×¢×“×›×•×Ÿ
				let rowToUpdate = -1;
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] == updatedReceipt.ID) {
						rowToUpdate = i + 1; // +1 ×›×™ Google Sheets ××ª×—×™×œ ×-1
						break;
					}
				}
				
				if (rowToUpdate > 0) {
					// ×¢×“×›×•×Ÿ ×”×©×•×¨×”
					const updatedRow = [
						updatedReceipt.ID,
						updatedReceipt.book_number,
						updatedReceipt.receipt_number,
						updatedReceipt.date,
						updatedReceipt.location_id,
						updatedReceipt.location_name,
						updatedReceipt.amount,
						updatedReceipt.payment_type,
						updatedReceipt.notes
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Receipts!A${rowToUpdate}:I${rowToUpdate}`,
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [updatedRow]
						}
					});
					
					console.log(`âœ… Updated receipt ${updatedReceipt.ID} in cloud`);
				}
				
			} catch (error) {
				console.error('Error updating receipt in cloud:', error);
				throw error;
			}
		}

		
		function deleteReceipt(receiptId) {
			if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×§×‘×œ×”?')) {
				receipts = receipts.filter(r => r.ID != receiptId);
				loadReceiptsTable();
				saveToLocalStorage();
				showSuccess('×§×‘×œ×” × ××—×§×” ×‘×”×¦×œ×—×”!');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×”×•×“×¢×•×ª Toast ××ª×§×“××•×ª
		function showToast(message, type = 'info', duration = 3000) {
			const toastContainer = document.getElementById('toastContainer');
			
			if (!toastContainer) {
				console.error('Toast container not found');
				return;
			}
			
			const toast = document.createElement('div');
			toast.className = `toast ${type}`;
			toast.textContent = message;
			
			toastContainer.appendChild(toast);
			
			// Trigger animation
			setTimeout(() => {
				toast.classList.add('show');
			}, 100);
			
			// Remove toast after specified duration
			setTimeout(() => {
				toast.classList.remove('show');
				setTimeout(() => {
					if (toast.parentNode) {
						toast.parentNode.removeChild(toast);
					}
				}, 300);
			}, duration);
		}
	   
	   // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×”×•×“×¢×•×ª
		function showSuccess(message, duration = 3000) {
			showToast(message, 'success', duration);
		}

		function showError(message, duration = 4000) {
			showToast(message, 'error', duration);
		}

		function showWarning(message, duration = 3500) {
			showToast(message, 'warning', duration);
		}

		function showInfo(message, duration = 3000) {
			showToast(message, 'info', duration);
		}
	   
	   
	    // ×™×¦×™×¨×ª ×˜×‘×œ×ª ×¢×–×¨ ×œ×™×™×‘×•×
		async function clearAllDataBeforeImport() {
			if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×§×™×™××™× ×œ×¤× ×™ ×”×™×™×‘×•× ×”×—×“×©?\n\n×¤×¢×•×œ×” ×–×• ×ª××—×§:\n- ××ª ×›×œ ×”××™×§×•××™×\n- ××ª ×›×œ ×”×‘×™×§×•×¨×™×\n- ××ª ×›×œ ×”×§×‘×œ×•×ª\n\n×”× ×ª×•× ×™× ×‘×’×•×’×œ ×©×™×˜×¡ ×œ× ×™×™××—×§×•.')) {
				locations = [];
				visits = [];
				receipts = [];
				saveToLocalStorage();
				
				// ×¢×“×›×•×Ÿ ×¨×§ ×”×¤×•× ×§×¦×™×•×ª ×©×§×™×™××•×ª
				loadLocationsTable();
				loadReceiptsTable(); 
				loadFilterOptions();
				
				showToast('×›×œ ×”× ×ª×•× ×™× × ×•×§×• ×‘×”×¦×œ×—×”', 'success');
				return true;
			}
			return false;
		}

		// ×©×™×¤×•×¨ ×œ×¤×•× ×§×¦×™×” ×”×§×™×™××ª
		async function createImportTable() {
			if (!await validateToken()) {
				showToast('×”×ª×—×‘×¨ ×œ×’×•×’×œ ×§×•×“×', 'warning');
				return;
			}
			
			try {
				showLoading('×™×•×¦×¨ ×˜×‘×œ×ª ×¢×–×¨ ×œ×™×™×‘×•×...');
				
				const response = await gapi.client.sheets.spreadsheets.create({
					resource: {
						properties: {
							title: `import_table_${new Date().toISOString().split('T')[0]}`
						},
						sheets: [{
							properties: { title: 'Locations' },
						}, {
							properties: { title: 'Visits' },
						}, {
							properties: { title: 'Receipts' }
						}, {
							properties: { title: 'SystemSettings' }
						}]
					}
				});
				
				const newSpreadsheetId = response.result.spreadsheetId;
				
				// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×›×œ ×’×œ×™×•×Ÿ
				await addImportHeaders(newSpreadsheetId);
				
				// ×¤×ª×™×—×ª ×”×˜×‘×œ×”
				window.open(`https://docs.google.com/spreadsheets/d/${newSpreadsheetId}/edit`, '_blank');
				
				// ×©××™×¨×ª ID ×œ×™×™×‘×•× ×××•×—×¨ ×™×•×ª×¨
				localStorage.setItem('importTableId', newSpreadsheetId);
				
				showToast('×˜×‘×œ×ª ×¢×–×¨ × ×•×¦×¨×”! ××œ× ××ª ×”× ×ª×•× ×™× ×•××– ×—×–×•×¨ ×œ×™×™×‘×', 'success');
				
			} catch (error) {
				console.error('Error creating import table:', error);
				showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×‘×œ×ª ×¢×–×¨', 'error');
			} finally {
				hideLoading();
			}
		}

		// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×˜×‘×œ×ª ×¢×–×¨
		async function addImportHeaders(spreadsheetId) {
			if (!await validateToken()) {
				showToast('×‘×¢×™×” ×‘×—×™×‘×•×¨ ×œ×’×•×’×œ ×‘××”×œ×š ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª', 'error');
				return;
			}

			try {
				// ×›×œ ×”×›×•×ª×¨×•×ª ×‘×× ×’×œ×™×ª
				const locationHeaders = [['customer_name', 'street', 'house_number', 'city', 'frequency', 'contact_person', 'base_amount']];
				const visitHeaders = [['year', 'month', 'day', 'customer', 'contact_person', 'treatment', 'date', 'work_done', 'duration', 'amount', 'paid', 'expense', 'notes']];
				const receiptHeaders = [['code_x', 'booklet', 'receipt', 'year', 'month', 'day', 'address', 'amount', 'type', 'notes', 'details']];
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				await Promise.all([
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Locations!A1:G1',
						valueInputOption: 'RAW',
						resource: { values: locationHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Visits!A1:M1',
						valueInputOption: 'RAW', 
						resource: { values: visitHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Receipts!A1:K1',
						valueInputOption: 'RAW',
						resource: { values: receiptHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'SystemSettings!A1:B1',
						valueInputOption: 'RAW',
						resource: { values: [['Setting', 'Value']] }
					})
				]);			
				
				console.log('Headers added successfully to import table');
				
			} catch (error) {
				console.error('Error adding headers:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('âš ï¸ ×”×—×™×‘×•×¨ ×¤×’ ×‘××”×œ×š ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª', 'warning');
				} else {
					showToast('âš ï¸ ×©×’×™××” ×‘×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×˜×‘×œ×”', 'error');
				}
				throw error;
			}
		}
		
		
		// ×ª×•×¡×¤×” - ×¤×™×¢× ×•×— ×›×ª×•×‘×ª ××œ××” ×œ×—×œ×§×™×
		function parseFullAddress(fullAddress) {
			if (!fullAddress) return { street: '', houseNumber: '', city: '' };
			
			const parts = fullAddress.trim().split(' ');
			
			if (parts.length >= 3) {
				// ×”×¢×™×¨ ×”×™× ×”×—×œ×§ ×”××—×¨×•×Ÿ
				const city = parts[parts.length - 1];
				
				// ××¡×¤×¨ ×”×‘×™×ª ×”×•× ×”×—×œ×§ ×”×œ×¤× ×™ ××—×¨×•×Ÿ
				const houseNumber = parts[parts.length - 2];
				
				// ×”×¨×—×•×‘ ×”×•× ×›×œ ×”×©××¨
				const street = parts.slice(0, -2).join(' ');
				
				return { street, houseNumber, city };
			} else if (parts.length === 2) {
				return { street: parts[0], houseNumber: '', city: parts[1] };
			} else {
				return { street: fullAddress, houseNumber: '', city: '' };
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×™×™×‘×•× ×œ×§×•×—×•×ª ××˜×‘×œ×ª ×¢×–×¨
		async function importCustomersFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('×˜×‘×œ×ª ×¢×–×¨ ×œ× × ××¦××” - ×¦×•×¨ ×§×•×“×', 'warning');
					return;
				}
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: importTableId,
					range: 'Locations!A2:G1000' // ×¢×“ G ×‘××§×•× H
				});
				
				const rows = response.result.values || [];
				let importedCount = 0;
				let newLocations = []; // ××¢×¨×š ×œ××™×¡×•×£ ×›×œ ×”×œ×§×•×—×•×ª ×”×—×“×©×™×
				
				for (const row of rows) {
					if (row.length > 0 && row[0]) { // ×™×© ×©× ×œ×§×•×—
						// ××™×¤×•×™ ×œ×¤×™ ×”×›×•×ª×¨×•×ª ×”×—×“×©×•×ª ×‘×× ×’×œ×™×ª:
						const customerName = row[0].trim();  // customer_name
						const street = row[1] || '';         // street  
						const houseNumber = row[2] || '';    // house_number
						const city = row[3] || '';           // city
						const frequency = row[4] || '';      // frequency
						const contactPerson = row[5] || '';  // contact_person
						const baseAmount = row[6] || '';     // base_amount
						
						// ×‘× ×™×™×ª ×›×ª×•×‘×ª ××œ××”
						const fullAddress = `${street} ${houseNumber} ${city}`.trim();
						
						// ×‘×“×•×§ ×× ×œ×§×•×— ×›×‘×¨ ×§×™×™× (×œ×¤×™ ×›×ª×•×‘×ª ××œ××”)
						const existingCustomer = locations.find(loc => 
							loc.full_address && 
							loc.full_address.toLowerCase() === fullAddress.toLowerCase()
						);
						
						if (existingCustomer) {
							console.log(`×œ×§×•×— ${fullAddress} ×›×‘×¨ ×§×™×™× - ×“×•×œ×’`);
							continue;
						}
						
						const locationData = {
							ID: generateID(),
							name: customerName,           // ×©× ×”×œ×§×•×— (×¢×›×©×™×• × ×¤×¨×“ ××”×›×ª×•×‘×ª)
							full_address: fullAddress,   // ×›×ª×•×‘×ª ××œ××” ××•×¨×›×‘×ª
							neighborhood: '',
							city: city,
							contact_person: contactPerson,
							phone: '',
							allowed_day: '×›×œ ×™×•×',
							interval_weeks: parseInt(frequency) || 4,
							temp_addition: 0,
							base_amount: parseFloat(baseAmount) || 0,
							active: "1",
							notes: '×™×•×‘× ××˜×‘×œ×ª ×œ×§×•×—×•×ª',
							last_visit: '',
							next_visit: ''
						};
						
						locations.push(locationData);
						newLocations.push(locationData); // ×”×•×¡×£ ×œ××¢×¨×š ×”×—×“×©
						importedCount++;
					}
				}
				
				// ×©××™×¨×” ××§×‘×¦×™×ª ××—×ª ×‘×¡×•×£:
				if (newLocations.length > 0) {
					showToast(`×©×•××¨ ${newLocations.length} ×œ×§×•×—×•×ª ×‘×‘×ª ××—×ª...`, 'info', 2000);
					const success = await saveLocationsBatch(newLocations);
					
					if (success) {
						showToast(`âœ… ×™×•×‘××• ${importedCount} ×œ×§×•×—×•×ª ×‘××”×™×¨×•×ª!`, 'success');
					} else {
						showToast('âš ï¸ ×‘×¢×™×” ×‘×©××™×¨×” ×œ×¢× ×Ÿ - × ×©××¨ ××§×•××™×ª ×‘×œ×‘×“', 'warning');
					}
				} else {
					showToast('×œ× × ××¦××• ×œ×§×•×—×•×ª ×—×“×©×™× ×œ×™×™×‘×•×', 'info');
				}
				
				// ×¢×“×›×•×Ÿ ×ª×¦×•×’×•×ª
				saveToLocalStorage();
				loadLocationsTable();
				loadLocationsForSelect();
				
			} catch (error) {
				console.error('Error importing customers:', error);
				showToast('×©×’×™××” ×‘×™×™×‘×•× ×œ×§×•×—×•×ª', 'error');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×™×™×‘×•× ×˜×™×¤×•×œ×™× ××˜×‘×œ×ª ×¢×–×¨
		async function importVisitsFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('×˜×‘×œ×ª ×¢×–×¨ ×œ× × ××¦××” - ×¦×•×¨ ×§×•×“×', 'warning');
					return;
				}
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: importTableId,
					range: 'Visits!A2:M1000'
				});
				
				const rows = response.result.values || [];
				let importedCount = 0;
				let notFoundCustomers = [];
				let newVisits = []; // ××¢×¨×š ×œ××™×¡×•×£ ×›×œ ×”×‘×™×§×•×¨×™× ×”×—×“×©×™×
				
				for (const row of rows) {
					if (row.length > 3 && row[3]) { // ×™×© ×œ×§×•×— ×‘×¢××•×“×” 3 (customer)
						// ××™×¤×•×™ ×œ×¤×™ ×”×›×•×ª×¨×•×ª ×”×—×“×©×•×ª ×‘×× ×’×œ×™×ª:
						const year = row[0];                    // year
						const month = row[1];                   // month
						const day = row[2];                     // day
						const customerName = row[3].trim();     // customer
						const contactPerson = row[4] || '';     // contact_person
						const treatment = row[5] || '××œ×';      // treatment
						const dateField = row[6];               // date (×œ× × ×©×ª××© - × ×‘× ×” ××”×¢××•×“×•×ª ×”×¨××©×•× ×•×ª)
						const workDone = row[7] || '';          // work_done
						const duration = row[8] || 0;           // duration
						const amount = row[9] || 0;             // amount
						const paid = row[10] || '';           // paid
						const expense = row[11] || 0;           // expense
						const notes = row[12] || '';            // notes
						
						// ××¦× ×œ×§×•×— ×§×™×™× ×œ×¤×™ ×›×ª×•×‘×ª ××œ××”
						const existingCustomer = locations.find(loc => 
							loc.full_address && 
							loc.full_address.toLowerCase().includes(customerName.toLowerCase())
						);
						
						if (!existingCustomer) {
							if (!notFoundCustomers.includes(customerName)) {
								notFoundCustomers.push(customerName);
							}
							continue;
						}
						
						// ×‘× ×™×™×ª ×ª××¨×™×š × ×›×•×Ÿ ×-3 ×¢××•×“×•×ª
						const visitDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
						
						const visitData = {
							ID: generateID(),
							date: visitDate,
							location_id: existingCustomer.ID,
							location_name: existingCustomer.name,
							visit_type: treatment,
							work_done: workDone,
							duration_minutes: parseFloat(duration) * 60 || 0, // ×©×¢×•×ª â†’ ×“×§×•×ª
							start_time: '',
							end_time: '',
							amount: parseFloat(amount) || 0,
							expense: parseFloat(expense) || 0,
							paid: mapPaymentStatus(paid),
							notes: notes
						};
						
						visits.push(visitData);
						newVisits.push(visitData); // ×”×•×¡×£ ×œ××¢×¨×š ×”×—×“×©
						// ×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×œ××—×¨ ×”×•×¡×¤×ª ×‘×™×§×•×¨ ×—×“×©
						// await updateSingleLocationTreatmentDates(visitData.location_id);
						importedCount++;
					}
				}
				
				// ×©××™×¨×” ××§×‘×¦×™×ª ××—×ª ×‘×¡×•×£:
				if (newVisits.length > 0) {
					showToast(`×©×•××¨ ${newVisits.length} ×‘×™×§×•×¨×™× ×‘×‘×ª ××—×ª...`, 'info', 2000);
					const success = await saveVisitsBatch(newVisits);
					
					if (success) {
						showToast(`âœ… ×™×•×‘××• ${importedCount} ×‘×™×§×•×¨×™× ×‘××”×™×¨×•×ª!`, 'success');
					} else {
						showToast('âš ï¸ ×‘×¢×™×” ×‘×©××™×¨×” ×œ×¢× ×Ÿ - × ×©××¨ ××§×•××™×ª ×‘×œ×‘×“', 'warning');
					}
				} else {
					showToast('×œ× × ××¦××• ×‘×™×§×•×¨×™× ×—×“×©×™× ×œ×™×™×‘×•×', 'info');
				}
				
				// ×¢×“×›×•×Ÿ ×ª×¦×•×’×•×ª
				saveToLocalStorage();
				loadPlanningData();
				
				// ×”×•×“×¢×” ×¢×œ ×œ×§×•×—×•×ª ×©×œ× × ××¦××•
				let message = `×™×•×‘××• ${importedCount} ×‘×™×§×•×¨×™× ×‘×”×¦×œ×—×”!`;
				if (notFoundCustomers.length > 0) {
					message += `\nâš ï¸ ${notFoundCustomers.length} ×œ×§×•×—×•×ª ×œ× × ××¦××•: ${notFoundCustomers.slice(0, 3).join(', ')}${notFoundCustomers.length > 3 ? '...' : ''}`;
					showToast(message, 'warning', 5000);
				}
				
			} catch (error) {
				console.error('Error importing visits:', error);
				showToast('×©×’×™××” ×‘×™×™×‘×•× ×‘×™×§×•×¨×™×', 'error');
			}
		}
	   
	   
	   // ×ª×•×¡×¤×” - ×™×™×‘×•× ×§×‘×œ×•×ª ××˜×‘×œ×ª ×¢×–×¨
		async function importReceiptsFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('×˜×‘×œ×ª ×¢×–×¨ ×œ× × ××¦××” - ×¦×•×¨ ×§×•×“×', 'warning');
					return;
				}
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: importTableId,
					range: 'Receipts!A2:K1000'
				});
				
				const rows = response.result.values || [];
				let importedCount = 0;
				let notFoundCustomers = [];
				
				for (const row of rows) {
					if (row.length > 6 && row[6]) { // ×™×© ×›×ª×•×‘×ª ×‘×¢××•×“×” 6 (G)
						const customerAddress = row[6].trim(); // ×¢××•×“×” "×›×ª×•×‘×ª"
						
						// ××¦× ×œ×§×•×— ×§×™×™× ×œ×¤×™ ×›×ª×•×‘×ª ××œ××”
						const existingCustomer = locations.find(loc => 
							loc.full_address && 
							loc.full_address.toLowerCase().includes(customerAddress.toLowerCase())
						);
						
						if (!existingCustomer) {
							if (!notFoundCustomers.includes(customerAddress)) {
								notFoundCustomers.push(customerAddress);
							}
							continue;
						}
						
						// ×‘× ×™×™×ª ×ª××¨×™×š ×-3 ×¢××•×“×•×ª
						const year = row[3];   // ×©× ×” - ×¢××•×“×” D
						const month = String(row[4]).padStart(2, '0');  // ×—×•×“×© - ×¢××•×“×” E
						const day = String(row[5]).padStart(2, '0');    // ×™×•× - ×¢××•×“×” F
						const receiptDate = `${year}-${month}-${day}`;
						
						const receiptData = {
							ID: generateID(),
							book_number: row[1] || '',      // ×¤× ×§×¡ - ×¢××•×“×” B
							receipt_number: row[2] || '',   // ×§×‘×œ×” - ×¢××•×“×” C
							date: receiptDate,              // ×ª××¨×™×š × ×›×•×Ÿ
							location_id: existingCustomer.ID,
							location_name: customerAddress,
							amount: parseFloat(row[7]) || 0, // ×¡×›×•× - ×¢××•×“×” H
							payment_type: row[8] || '',     // ×¡×•×’ - ×¢××•×“×” I
							codeX: row[0] || '',           // XK - ×¢××•×“×” A
							notes: `${row[9] || ''} ${row[10] || ''}`.trim() // ×”×¢×¨×•×ª + ×¤×™×¨×•×˜
						};
						
						receipts.push(receiptData);
						importedCount++;
					}
				}
				
				// ×©××™×¨×”
				await saveAllToSheets();
				loadReceiptsTable();
				
				let message = `×™×•×‘××• ${importedCount} ×§×‘×œ×•×ª ×‘×”×¦×œ×—×”!`;
				if (notFoundCustomers.length > 0) {
					message += `\nâš ï¸ ${notFoundCustomers.length} ×œ×§×•×—×•×ª ×œ× × ××¦××•: ${notFoundCustomers.slice(0, 3).join(', ')}${notFoundCustomers.length > 3 ? '...' : ''}`;
				}
				
				showToast(message, 'success');
				
			} catch (error) {
				console.error('Error importing receipts:', error);
				showToast('×©×’×™××” ×‘×™×™×‘×•× ×§×‘×œ×•×ª', 'error');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×”××¨×ª ×¤×•×¨××˜ ×ª××¨×™×š ×-DD/MM/YYYY ×œ-YYYY-MM-DD
		function convertDateFormat(dateStr) {
			if (!dateStr) return '';
			
			const parts = dateStr.split('/');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = parts[1].padStart(2, '0');
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			
			return dateStr;
		}
	   
	   
	   // ×ª×•×¡×¤×” - ×™×™×‘×•× ××œ× ××˜×‘×œ×ª ×”×¢×–×¨
		async function importFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('×˜×‘×œ×ª ×¢×–×¨ ×œ× × ××¦××” - ×¦×•×¨ ×§×•×“×', 'warning');
					return;
				}
				
				showToast('××ª×—×™×œ ×™×™×‘×•× ××œ×...', 'info');
				
				// ×™×™×‘×•× ×‘×¡×“×¨: ×œ×§×•×—×•×ª â†’ ×˜×™×¤×•×œ×™× â†’ ×§×‘×œ×•×ª
				await importCustomersFromHelper();
				await new Promise(resolve => setTimeout(resolve, 1000)); // ×”××ª× ×” ×§×¦×¨×”
				
				await importVisitsFromHelper();
				await new Promise(resolve => setTimeout(resolve, 1000)); // ×”××ª× ×” ×§×¦×¨×”
				
				await importReceiptsFromHelper();
				
				showToast('ğŸ‰ ×™×™×‘×•× ××œ× ×”×•×©×œ× ×‘×”×¦×œ×—×”!', 'success', 5000);
				
				setTimeout(() => {
					if (confirm('×™×™×‘×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”!\n\n×”×× ×œ××—×•×§ ××ª ×˜×‘×œ×ª ×”×¢×–×¨ ××”-Google Drive?')) {
						showToast('ğŸ’¡ × ×™×ª×Ÿ ×œ××—×•×§ ××ª ×˜×‘×œ×ª ×”×¢×–×¨ ×™×“× ×™×ª ×‘×’×•×’×œ ×“×¨×™×™×‘', 'info');
						localStorage.removeItem('importTableId');
					}
				}, 2000);
				
			} catch (error) {
				console.error('Error in full import:', error);
				showToast('×©×’×™××” ×‘×™×™×‘×•× ××œ×', 'error');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×‘×“×™×§×ª ×ª×§×™× ×•×ª × ×ª×•× ×™×
		function validateReceiptData(receiptData) {
			const errors = [];
			
			if (!receiptData.location_id) {
				errors.push('×—×•×‘×” ×œ×‘×—×•×¨ ×œ×§×•×—');
			}
			
			if (!receiptData.amount || receiptData.amount <= 0) {
				errors.push('×—×•×‘×” ×œ×”×–×™×Ÿ ×¡×›×•× ×—×™×•×‘×™');
			}
			
			if (!receiptData.date) {
				errors.push('×—×•×‘×” ×œ×”×–×™×Ÿ ×ª××¨×™×š');
			}
			
			return errors;
		}

		function showValidationErrors(errors) {
			if (errors.length > 0) {
				showToast(errors.join('\n'), 'error');
				return true; // ×™×© ×©×’×™××•×ª
			}
			return false; // ××™×Ÿ ×©×’×™××•×ª
		}
	   
	   
	    // ×ª×•×¡×¤×” - × ×™×”×•×œ ×¤×× ×œ×™ ×¡×™× ×•×Ÿ ×•××™×“×¢
		function toggleFilterPanel() {
			const content = document.getElementById('filterContent');
			const icon = document.getElementById('filterIcon');
			
			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				icon.textContent = 'ğŸ”½';
			} else {
				content.classList.add('collapsed');
				icon.textContent = 'ğŸ”¼';
			}
		}

		function toggleInfoPanel() {
			const content = document.getElementById('infoContent');
			const icon = document.getElementById('infoIcon');
			
			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				icon.textContent = 'ğŸ”½';
			} else {
				content.classList.add('collapsed');
				icon.textContent = 'ğŸ”¼';
			}
		}

		// ×ª×•×¡×¤×” - ×˜×¢×™× ×ª ××¤×©×¨×•×™×•×ª ×¡×™× ×•×Ÿ
		function loadFilterOptions() {
			const locationSelect = document.getElementById('filterLocation');
			locationSelect.innerHTML = '<option value="">×›×œ ×”×œ×§×•×—×•×ª</option>';
			
			locations.forEach(location => {
				const option = document.createElement('option');
				option.value = location.ID;
				option.textContent = location.name;
				locationSelect.appendChild(option);
			});
		}
	   
		// ×ª×•×¡×¤×” - ×¡×™× ×•×Ÿ ×•×˜×¢×™× ×ª ×˜×™×¤×•×œ×™×
		function applyVisitFilters() {
			const locationFilter = document.getElementById('filterLocation').value;
			const paymentFilter = document.getElementById('filterPayment').value;
			const dateFromFilter = document.getElementById('filterDateFrom').value;
			const dateToFilter = document.getElementById('filterDateTo').value;
			
			let filteredVisits = visits.filter(visit => {
				// ×¡×™× ×•×Ÿ ×œ×¤×™ ×œ×§×•×—
				if (locationFilter && visit.location_id != locationFilter) {
					return false;
				}
				
				// ×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×˜×˜×•×¡ ×ª×©×œ×•×
				if (paymentFilter && visit.paid !== paymentFilter) {
					return false;
				}
				
				// ×¡×™× ×•×Ÿ ×œ×¤×™ ×ª××¨×™×š
				if (dateFromFilter && visit.date < dateFromFilter) {
					return false;
				}
				
				if (dateToFilter && visit.date > dateToFilter) {
					return false;
				}
				
				return true;
			});
			
			displayFilteredVisits(filteredVisits);
			updateVisitsInfo(filteredVisits);
		}

		function clearVisitFilters() {
			document.getElementById('filterLocation').value = '';
			document.getElementById('filterPayment').value = '';
			document.getElementById('filterDateFrom').value = '';
			document.getElementById('filterDateTo').value = '';
			
			displayFilteredVisits(visits);
			updateVisitsInfo(visits);
		}

		// ×ª×•×¡×¤×” - ×”×¦×’×ª ×˜×™×¤×•×œ×™× ××¡×•× × ×™×
		function displayFilteredVisits(filteredVisits) {
			const tbody = document.getElementById('visitsHistoryTableBody');
			tbody.innerHTML = '';
			
			if (filteredVisits.length === 0) {
				tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">××™×Ÿ ×˜×™×¤×•×œ×™× ×ª×•×××™× ×œ×¡×™× ×•×Ÿ</td></tr>';
				return;
			}
			
			// ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š (×”×—×“×©×™× ×¨××©×•× ×™×)
			filteredVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
			
			filteredVisits.forEach(visit => {
				const location = locations.find(loc => loc.ID == visit.location_id);
				const locationName = visit.location_name || (location ? location.name : `×œ× × ××¦× (ID: ${visit.location_id})`);
				//////////console.log(`Visit location_id: ${visit.location_id}, Found location:`, location);   //////>>>>>>>>>>>>>
				
				const row = document.createElement('tr');
				
				// ×”×“×’×©×ª ×©×•×¨×•×ª ×œ×¤×™ ×¡×˜×˜×•×¡ ×ª×©×œ×•×
				// ×”×“×’×©×ª ×©×•×¨×•×ª ×œ×¤×™ ×¡×˜×˜×•×¡ ×ª×©×œ×•× - × ×‘×“×§ ×‘×˜×‘×œ×ª ×ª×©×œ×•××™×
				const paymentStatus = getVisitPaymentStatus(visit.ID);
				if (paymentStatus === 'unpaid') {
					row.style.backgroundColor = '#fff2cc'; // ×¦×”×•×‘ ×¢×“×™×Ÿ ×œ×—×•×‘×•×ª
				} else if (paymentStatus === 'paid') {
					row.style.backgroundColor = '#d4edda'; // ×™×¨×•×§ ×¢×“×™×Ÿ ×œ×©×•×œ×
				}
				
				row.innerHTML = `
					<td>${formatDate(visit.date)}</td>
					<td>${locationName}</td>
					<td>${visit.visit_type}</td>
					<td>${visit.work_done}</td>
					<td>${(visit.duration_minutes / 60).toFixed(2)}</td>
					<td>
						<div style="display: flex; flex-direction: column; align-items: center;">
							<span style="font-weight: bold; color: #27ae60;">â‚ª${visit.amount}</span>
							${getVisitCostBreakdown(visit)}
						</div>
					</td>
					<td>
						<td>
							<span class="payment-status payment-${paymentStatus}">
								${getPaymentStatusText(paymentStatus)}
							</span>
						</td>
					</td>
					<td>
						<button class="action-btn edit-btn" onclick="editVisit('${visit.ID}')">×¢×¨×•×š</button>
						<button class="action-btn delete-btn" onclick="deleteVisit('${visit.ID}')">××—×§</button>
					</td>
				`;
				tbody.appendChild(row);
			});
		}

		// ×”×•×¡×£ ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×”×¦×’×ª ×¤×™×¨×•×˜ ×¢×œ×•×™×•×ª:
		function getVisitCostBreakdown(visit) {
			if (!visit.duration_minutes) return '<span style="font-size: 11px; color: #999;">×œ×œ× ×¤×™×¨×•×˜</span>';
			
			const hours = (visit.duration_minutes / 60).toFixed(2);
			const workers = visit.num_workers || 1;
			const expense = visit.expense || 0;
			
			let breakdown = `${hours}×©`;
			if (workers > 1) breakdown += ` Ã— ${workers}×¢`;
			if (expense > 0) breakdown += ` + â‚ª${expense}`;
			
			return `<span style="font-size: 11px; color: #666;">${breakdown}</span>`;
		}

		// ×ª×•×¡×¤×” - ×¢×“×›×•×Ÿ ×¤×× ×œ ×”××™×“×¢
		function updateVisitsInfo(filteredVisits) {
			const visitsCount = filteredVisits.length;
			const totalHours = filteredVisits.reduce((sum, visit) => sum + (visit.duration_minutes / 60), 0);
			const totalIncome = filteredVisits.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			const outstandingDebt = filteredVisits
				.reduce((sum, visit) => {
					if (!visit.amount || visit.amount <= 0) return sum;
					const visitAmount = parseFloat(visit.amount);
					const paidAmount = getVisitPaidAmount(visit.ID);
					const debt = visitAmount - paidAmount;
					return sum + (debt > 0 ? debt : 0);
				}, 0);
			
			document.getElementById('visitsCount').textContent = visitsCount;
			document.getElementById('totalHours').textContent = totalHours.toFixed(2);
			document.getElementById('totalIncome').textContent = `â‚ª${totalIncome.toLocaleString()}`;
			document.getElementById('outstandingDebt').textContent = `â‚ª${outstandingDebt.toLocaleString()}`;
			
			// ×”×“×’×©×ª ×—×•×‘×•×ª ×¤×ª×•×—×™×
			const debtElement = document.getElementById('outstandingDebt');
			if (outstandingDebt > 0) {
				debtElement.style.color = '#e74c3c';
				debtElement.style.fontWeight = 'bold';
			} else {
				debtElement.style.color = '#27ae60';
				debtElement.style.fontWeight = 'bold';
			}
			
			// ×—×™×©×•×‘ × ×ª×•× ×™× ××¤×•×¨×˜×™× ×™×•×ª×¨ ×¢×œ ×—×•×‘×•×ª
			const visitsWithDebt = filteredVisits.filter(visit => {
				if (!visit.amount || visit.amount <= 0) return false;
				const visitAmount = parseFloat(visit.amount);
				const paidAmount = getVisitPaidAmount(visit.ID);
				return (visitAmount - paidAmount) > 0;
			});
			const uniqueDebtors = new Set(visitsWithDebt.map(visit => visit.location_id)).size;
			
			// ×”×¦×’×ª ××™×“×¢ × ×•×¡×£ ×‘×›×¨×˜×™×¡×™ ×”×¡×™×›×•×
			if (outstandingDebt > 0) {
				const avgDebtPerClient = uniqueDebtors > 0 ? Math.round(outstandingDebt / uniqueDebtors) : 0;
				document.getElementById('outstandingDebt').title = 
					`${uniqueDebtors} ×œ×§×•×—×•×ª ×—×™×™×‘×™× | ×××•×¦×¢ â‚ª${avgDebtPerClient} ×œ×œ×§×•×—`;
			}
	
		}



		// ×ª×•×¡×¤×” - ×˜×¢×™× ×” ×¨××©×•× ×™×ª ×©×œ ×”×˜××‘
		function loadVisitsHistory() {
			loadFilterOptions();
			displayFilteredVisits(visits);
			updateVisitsInfo(visits);
		}

		async function editVisit(visitId) {
			console.log(`âœ… editVisit ('${visitId}') `);
			const visit = visits.find(v => v.ID == visitId);
			if (!visit) {
				showToast('×‘×™×§×•×¨ ×œ× × ××¦×', 'error');
				return;
			}
			
			console.log(`âœ… editVisit second: ('${visitId}') `);
			
			// ××¦× ××ª ×”×œ×§×•×—
			const location = locations.find(loc => loc.ID == visit.location_id);
			const locationName = location ? location.name : '×œ×§×•×— ×œ× × ××¦×';
			
			// ×¦×•×¨ ×—×œ×•×Ÿ ×¢×¨×™×›×”
			const editModalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">âœï¸ ×¢×¨×™×›×ª ×‘×™×§×•×¨ - ${locationName}</h3>
					
					<form id="editVisitForm">
						<div class="form-group">
							<label>×ª××¨×™×š:</label>
							<input type="date" id="editVisitDate" value="${visit.date}" required>
						</div>
						
						<div class="form-group">
							<label>×¡×•×’ ×˜×™×¤×•×œ:</label>
							<select id="editVisitType">
								<option value="××œ×" ${visit.visit_type === '××œ×' ? 'selected' : ''}>××œ×</option>
								<option value="×—×œ×§×™" ${visit.visit_type === '×—×œ×§×™' ? 'selected' : ''}>×—×œ×§×™</option>
								<option value="×‘×™×§×•×¨×ª" ${visit.visit_type === '×‘×™×§×•×¨×ª' ? 'selected' : ''}>×‘×™×§×•×¨×ª</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>×¢×‘×•×“×” ×©×‘×•×¦×¢×”:</label>
							<textarea id="editWorkDone" rows="3">${visit.work_done || ''}</textarea>
						</div>
						
						<div class="form-group">
							<label>××©×š ×–××Ÿ (×“×§×•×ª):</label>
							<input type="number" id="editDuration" value="${visit.duration_minutes || 0}">
						</div>
						
						<div class="form-group">
							<label>×©×¢×ª ×”×ª×—×œ×”:</label>
							<input type="time" id="editStartTime" value="${visit.start_time || ''}">
						</div>
						
						<div class="form-group">
							<label>×¡×›×•× (â‚ª):</label>
							<input type="number" step="0.01" id="editAmount" value="${visit.amount || 0}">
						</div>
						
						<div class="form-group">
							<label>×”×•×¦××•×ª (â‚ª):</label>
							<input type="number" step="0.01" id="editExpense" value="${visit.expense || 0}">
						</div>
						
						<div class="form-group">
							<label>×¡×˜×˜×•×¡ ×ª×©×œ×•×:</label>
							<select id="editPaid">
								<option value="0" ${visit.paid === '0' ? 'selected' : ''}>×œ× ×©×•×œ×</option>
								<option value="1" ${visit.paid === '1' ? 'selected' : ''}>×©×•×œ×</option>
								<option value="2" ${visit.paid === '2' ? 'selected' : ''}>×œ×œ× ×ª×©×œ×•×</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>×”×¢×¨×•×ª:</label>
							<textarea id="editNotes" rows="3">${visit.notes || ''}</textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="button" onclick="saveEditedVisit('${visitId}')" class="btn btn-success">
								ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×
							</button>
							<button type="button" onclick="closeEditModal()" class="btn btn-secondary">
								âŒ ×‘×™×˜×•×œ
							</button>
						</div>
					</form>
				</div>
			`;
			
			// ×”×¦×’ ××ª ×”××•×“×œ
			showEditModal(editModalHTML);
		}

		// ×”×¦×’×ª ××•×“×œ ×¢×¨×™×›×” (×× ×œ× ×§×™×™××ª)
		function showEditModal(content) {
			// ×”×¡×¨ ××•×“×œ ×§×™×™× ×× ×™×©
			const existingModal = document.getElementById('editModal');
			if (existingModal) {
				existingModal.remove();
			}
			
			// ×¦×•×¨ ××•×“×œ ×—×“×©
			const modal = document.createElement('div');
			modal.id = 'editModal';
			modal.style.cssText = `
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.6);
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 10000;
				backdrop-filter: blur(3px);
			`;
			
			modal.innerHTML = content;
			
			// ×”×•×¡×¤×” ×œ×¢××•×“
			document.body.appendChild(modal);
			
			// ×¡×’×™×¨×” ×‘×œ×—×™×¦×” ×¢×œ ×”×¨×§×¢
			modal.addEventListener('click', function(e) {
				if (e.target === modal) {
					closeEditModal();
				}
			});
		}

		// ×¡×’×™×¨×ª ××•×“×œ ×¢×¨×™×›×”
		function closeEditModal() {
			const modal = document.getElementById('editModal');
			if (modal) {
				modal.remove();
			}
		}


		
		// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×”×‘×™×§×•×¨ ×‘×¢× ×Ÿ
		async function updateVisitInCloud(updatedVisit) {
			if (!await validateToken()) return;
			
			try {
				// ×§×¨×™××ª ×›×œ ×”× ×ª×•× ×™× ××”×¢× ×Ÿ
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Visits!A:N'
				});
				
				const rows = response.result.values || [];
				
				// ××¦×™××ª ×”×©×•×¨×” ×œ×¢×“×›×•×Ÿ
				let rowToUpdate = -1;
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] == updatedVisit.ID) {
						rowToUpdate = i + 1; // +1 ×›×™ Google Sheets ××ª×—×™×œ ×-1
						break;
					}
				}
				
				if (rowToUpdate > 0) {
					// ×¢×“×›×•×Ÿ ×”×©×•×¨×”
					const updatedRow = [
						updatedVisit.ID,
						updatedVisit.date,
						updatedVisit.location_id,
						updatedVisit.location_name || '',
						updatedVisit.visit_type,
						updatedVisit.work_done,
						updatedVisit.duration_minutes,
						updatedVisit.num_workers || 1,
						updatedVisit.start_time,
						updatedVisit.end_time || '',
						updatedVisit.amount,
						updatedVisit.expense,
						updatedVisit.paid,
						updatedVisit.notes
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Visits!A${rowToUpdate}:N${rowToUpdate}`,
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [updatedRow]
						}
					});
					
					console.log(`âœ… Updated visit ${updatedVisit.ID} in cloud`);
				}
				
			} catch (error) {
				console.error('Error updating visit in cloud:', error);
				throw error;
			}
		}

		function deleteVisit(visitId) {
			console.log(`âœ… deleteVisit ('${visitId}') `);
			if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×˜×™×¤×•×œ?')) {
				visits = visits.filter(visit => visit.ID != visitId);
				applyVisitFilters(); // ×¨×¢× ×Ÿ ×ª×¦×•×’×”
				saveToLocalStorage();
				showToast('×˜×™×¤×•×œ × ××—×§ ×‘×”×¦×œ×—×”!', 'success');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×‘×“×™×§×ª ×¨×©××•×ª
		async function checkPermissions() {
			if (!access_token) {
				showToast('×œ× ××—×•×‘×¨ ×œ×’×•×’×œ - ×”×ª×—×‘×¨ ×§×•×“×', 'warning');
				return false;
			}
			
			try {
				// × ×¡×” ×œ×’×©×ª ×œ×˜×‘×œ×” ×”×¨××©×™×ª
				await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				return true;
			} catch (error) {
				if (error.status === 401) {
					showToast('×”×—×™×‘×•×¨ ×¤×’ - ×”×ª×—×‘×¨ ××—×“×©', 'warning');
					access_token = null;
				} else if (error.status === 403) {
					showToast('××™×Ÿ ×”×¨×©××” ×œ×˜×‘×œ×” - ×‘×“×•×§ ×©×™×ª×•×£', 'error');
				}
				return false;
			}
		}
	   
	   
	   // ×ª×•×¡×¤×” - ×‘×“×™×§×” ×ª×§×•×¤×ª×™×ª ×©×œ ×—×™×‘×•×¨
		setInterval(async () => {
			if (access_token) {
				const isValid = await validateToken();
				if (!isValid) {
					console.log('Token expired - disconnected');
				}
			}
		}, 300000); // ×‘×“×™×§×” ×›×œ 5 ×“×§×•×ª
	   
	   // ×ª×•×¡×¤×” - ×—×™×©×•×‘ ×©×¢×•×ª ××“×§×•×ª
		function updateHoursDisplay() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const hours = (minutes / 60).toFixed(2);
			document.getElementById('calculatedHours').value = hours > 0 ? hours : '';
		}
	   
	    // ×—×™×©×•×‘ ×¢×œ×•×ª ×˜×™×¤×•×œ ××¢×•×“×›×Ÿ
		function calculateTreatmentCost() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const workers = parseInt(document.getElementById('numberOfWorkersVisit').value) || 1;
			const expense = parseFloat(document.getElementById('expense').value) || 0;
			
			if (minutes > 0) {
				const hours = minutes / 60;
				const baseCost = costSettings.hourlyRate * hours;
				// ×ª×™×§×•×Ÿ: ×¢×œ×•×ª ×¢×•×‘×“×™× × ×•×¡×¤×™× (×œ× ×›×•×œ×œ ××•×ª×š)
				const workersCost = (workers - 1) * costSettings.workerCost * hours;
				const laborCost = baseCost + workersCost;
				const totalCost = laborCost + expense;
				
				// ×¢×“×›×Ÿ ××ª ×©×“×” ×”×¡×›×•×
				document.getElementById('amount').value = Math.round(totalCost);
				
				// ×”×¦×’ ×¤×™×¨×•×˜ ××¤×•×¨×˜ ×™×•×ª×¨
				let breakdown = `${hours.toFixed(2)} ×©×¢×•×ª Ã— â‚ª${costSettings.hourlyRate} = â‚ª${Math.round(baseCost)}`;
				
				if (workers > 1) {
					breakdown += `\n+ ${workers - 1} ×¢×•×‘×“×™× Ã— â‚ª${costSettings.workerCost}/×©×¢×” = â‚ª${Math.round(workersCost)}`;
				}
				
				if (expense > 0) {
					breakdown += `\n+ ×”×•×¦××•×ª: â‚ª${expense}`;
				}
				
				breakdown += `\n= ×¡×”"×›: â‚ª${Math.round(totalCost)}`;
				
				document.getElementById('costBreakdown').textContent = breakdown;
				document.getElementById('costBreakdown').style.whiteSpace = 'pre-line';
			} else {
				document.getElementById('costBreakdown').textContent = '';
			}
		}

		// ×”×•×¡×£ ×—×™×©×•×‘ ××•×˜×•××˜×™ ×›×©××§×œ×™×“×™× ××©×š ×–××Ÿ
		function updateHoursDisplay() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const hours = minutes > 0 ? (minutes / 60).toFixed(2) : '';
			document.getElementById('calculatedHours').value = hours;
			
			// ×—×©×‘ ×¢×œ×•×™×•×ª ××•×˜×•××˜×™×ª
			calculateTreatmentCost();
		}

		// ×©××™×¨×ª ×”×’×“×¨×•×ª ×¢×œ×•×ª ×¤×©×•×˜×” ×™×•×ª×¨
		function saveCostSettings() {
			costSettings.hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 150;
			costSettings.workerCost = parseFloat(document.getElementById('workerCost').value) || 50;
			
			localStorage.setItem('cost_settings', JSON.stringify(costSettings));
			
			if (access_token) {
				saveSettingsToCloud().then(success => {
					if (success) {
						showToast('×”×’×“×¨×•×ª ×¢×œ×•×ª × ×©××¨×• ×‘×¢× ×Ÿ', 'success');
					} else {
						showToast('×”×’×“×¨×•×ª × ×©××¨×• ××§×•××™×ª ×‘×œ×‘×“', 'warning');
					}
				});
			} else {
				showToast('×”×’×“×¨×•×ª × ×©××¨×• ××§×•××™×ª', 'success');
			}
		}
	   
	   // ×ª×•×¡×¤×” - ×‘×“×™×§×ª ×˜×™×¤×•×œ ×›×¤×•×œ
		function checkDuplicateVisit(locationId, visitDate) {
			const existingVisit = visits.find(visit => 
				visit.location_id == locationId && 
				visit.date === visitDate
			);
			
			return existingVisit;
		}
	   
	   // ×ª×•×¡×¤×” - ××ª×—×•×œ ×ª××¨×™×š ×•×©×¢×” × ×•×›×—×™×™×
		function initializeVisitForm() {
			const now = new Date();
			document.getElementById('visitDate').value = now.toISOString().split('T')[0];
			document.getElementById('visitTime').value = now.toTimeString().split(':').slice(0,2).join(':');
		}

		// ×§×¨×™××” ×œ××ª×—×•×œ ×›×©×”×“×£ × ×˜×¢×Ÿ
		document.addEventListener('DOMContentLoaded', function() {
			initializeVisitForm();
		});
	   
	   // ×¤×•× ×§×¦×™×” ×œ×©××™×¨×ª ×”×’×“×¨×•×ª ×œ×¢× ×Ÿ
		async function saveSettingsToCloud() {
			if (!await validateToken()) {
				return false;
			}
			
			try {
				const settingsData = [
					['Setting', 'Value'],
					['hourly_rate', costSettings.hourlyRate],
					['worker_cost', costSettings.workerCost],
					['last_updated', new Date().toISOString()]
				];
				
				await gapi.client.sheets.spreadsheets.values.clear({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A:B`
				});
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A1:B4`,
					valueInputOption: 'RAW',
					resource: { values: settingsData }
				});
				
				return true;
			} catch (error) {
				console.error('Error saving settings:', error);
				return false;
			}
		}

		// ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ×”×’×“×¨×•×ª ××”×¢× ×Ÿ
		async function loadSettingsFromCloud() {
			if (!await validateToken()) {
				return false;
			}
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A:B`
				});
				
				const rows = response.result.values || [];
				if (rows.length > 1) {
					rows.slice(1).forEach(row => {
						const [setting, value] = row;
						if (setting === 'hourly_rate') {
							costSettings.hourlyRate = parseFloat(value) || 150;
						}
						if (setting === 'worker_cost') {
							costSettings.workerCost = parseFloat(value) || 50;
						}
					});
					
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
					
					return true;
				}
			} catch (error) {
				console.error('Error loading settings:', error);
				return false;
			}
			
			return false;
		}
	   
	   // ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×‘×“×™×§×” ×•×™×¦×™×¨×ª ×”×˜×‘×œ×” ×”×¨××©×™×ª
		async function findOrCreateMainSpreadsheet() {
			try {
				console.log('Searching for existing main spreadsheet...');
				
				// ×—×™×¤×•×© ×˜×‘×œ×” ×§×™×™××ª
				const response = await gapi.client.request({
					path: 'https://www.googleapis.com/drive/v3/files',
					params: {
						q: `name='${SPREADSHEET_NAME}' and mimeType='application/vnd.google-apps.spreadsheet'`,
					}
				});
				
				if (response.result.files.length > 0) {
					console.log('Found existing spreadsheet');
					SPREADSHEET_ID = response.result.files[0].id;
					showToast('× ××¦××” ×˜×‘×œ×” ×§×™×™××ª!', 'success');
					
					// ×‘×“×™×§×” ×•×ª×™×§×•×Ÿ ×©×œ ××‘× ×” ×”×˜×‘×œ×”
					await checkAndFixTableStructure();
				} else {
					console.log('No spreadsheet found, creating new one...');
					await createNewMainSpreadsheet();
				}
				
			} catch (error) {
				console.error('Error in findOrCreateMainSpreadsheet:', error);
				showToast('×©×’×™××” ×‘×—×™×¤×•×© ×˜×‘×œ×”', 'error');
			}
		}

		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×™×¦×™×¨×ª ×˜×‘×œ×” ×¨××©×™×ª ×—×“×©×”
		async function createNewMainSpreadsheet() {
			console.log('Creating new main spreadsheet...');
			try {
				const response = await gapi.client.request({
					path: 'https://sheets.googleapis.com/v4/spreadsheets',
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${access_token}`,
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						properties: {
							title: SPREADSHEET_NAME
						},
						sheets: [
							{ properties: { title: 'Locations' } },
							{ properties: { title: 'Visits' } },
							{ properties: { title: 'Receipts' } },
							{ properties: { title: 'SystemSettings' } }
						]
					})
				});
				
				SPREADSHEET_ID = response.result.spreadsheetId;
				
				// ×”×•×¡×£ ×›×•×ª×¨×•×ª ×œ×›×œ ×”×’×™×œ×™×•× ×•×ª
				await addAllHeaders();
				
				showToast('× ×•×¦×¨×” ×˜×‘×œ×” ×—×“×©×”!', 'success');
				
			} catch (error) {
				console.error('Error creating spreadsheet:', error);
				showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×‘×œ×”', 'error');
			}
		}
		
		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×‘×“×™×§×” ×•×ª×™×§×•×Ÿ ××‘× ×” ×”×˜×‘×œ×”
		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×‘×“×™×§×” ×•×ª×™×§×•×Ÿ ××‘× ×” ×”×˜×‘×œ×”
		async function checkAndFixTableStructure() {
			console.log('Checking and fixing table structure...');
			
			try {
				// ×‘×“×™×§×ª ×›×•×ª×¨×•×ª ×‘×›×œ ×’×™×œ×™×•×Ÿ - ×›×•×œ×œ ×”×—×“×©×™×
				const sheetsToCheck = ['Locations', 'Visits', 'Receipts', 'TelegramVisits', 'TelegramIncomes', 'Payments', 'PaymentVisitLink'];
				
				for (const sheetName of sheetsToCheck) {
					try {
						const response = await gapi.client.sheets.spreadsheets.values.get({
							spreadsheetId: SPREADSHEET_ID,
							range: `${sheetName}!A1:A1`
						});
						
						if (!response.result.values || !response.result.values[0][0]) {
							console.log(`Headers missing in ${sheetName}, adding them...`);
							await addHeadersToSheet(sheetName);
						}
					} catch (error) {
						console.log(`Sheet ${sheetName} missing or error, will add headers:`, error);
						await addHeadersToSheet(sheetName);
					}
				}
				
				console.log('âœ… Table structure verified');
				
			} catch (error) {
				console.log('Headers check failed, will force add them:', error);
				await addAllHeaders();
			}
		}
		
		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×’×™×œ×™×•×Ÿ ×¡×¤×¦×™×¤×™
		async function addHeadersToSheet(sheetName) {
			try {
				let headers = [];
				
				switch (sheetName) {
					case 'Locations':
						headers = [
							'ID', 'name', 'full_address', 'neighborhood', 'city', 'contact_person', 
							'phone', 'allowed_day', 'interval_weeks', 'temp_addition', 
							'base_amount', 'active', 'notes', 'last_visit', 'next_visit', 'client_requests'
						];
						break;
					case 'Visits':
						headers = [
							'ID', 'date', 'location_id', 'location_name', 'visit_type', 'work_done', 
							'duration_minutes', 'num_workers', 'start_time', 'end_time', 
							'amount', 'expense', 'notes'
						];
						break;
					case 'Receipts':
						headers = [
							'ID', 'book_number', 'receipt_number', 'date', 'location_id', 
							'location_name', 'amount', 'payment_type', 'notes'
						];
						break;
					case 'TelegramVisits':
						headers = [
							'ID', 'date', 'time', 'client_name', 'visit_type', 
							'work_done', 'duration_minutes', 'raw_text', 'processed', 'created_at'
						];
						break;
						
					case 'TelegramIncomes':
						headers = [
							'ID', 'date', 'time', 'client_address', 'amount', 'payment_method',
							'notes', 'raw_text', 'matched_to_visit', 'visit_ids', 'processed', 'created_at'
						];
						break;
						
					case 'Payments':
						headers = [
							'ID', 'date', 'time', 'amount', 'payment_method', 'source_type',
							'client_id', 'notes', 'status', 'created_at'
						];
						break;
						
					case 'PaymentVisitLink':
						headers = [
							'ID', 'payment_id', 'visit_id', 'amount_allocated', 'link_type', 'created_at'
						];
						break;
				}
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `${sheetName}!A1:${String.fromCharCode(64 + headers.length)}1`,
					valueInputOption: 'RAW',
					values: [headers]
				});
				
				console.log(`âœ… Added headers to ${sheetName}`);
				
			} catch (error) {
				console.error(`Error adding headers to ${sheetName}:`, error);
			}
		}
		
		// ×¤×•× ×§×¦×™×” ××©×•×¤×¨×ª ×œ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×›×œ ×”×’×™×œ×™×•× ×•×ª
		async function addAllHeaders() {
			try {
				console.log('Adding headers to all sheets...');
				
				await addHeadersToSheet('Locations');
				await addHeadersToSheet('Visits');
				await addHeadersToSheet('Receipts');
				
				// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ-SystemSettings
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'SystemSettings!A1:B1',
					valueInputOption: 'RAW',
					values: [['setting_key', 'setting_value']]
				});
				
				console.log('âœ… All headers added successfully');
				
			} catch (error) {
				console.error('Error adding all headers:', error);
			}
		}  
	   
	   async function importFromHelperTable() {
			if (!await validateToken()) {
				showToast('×”×ª×—×‘×¨ ×œ×’×•×’×œ ×§×•×“×', 'warning');
				return;
			}
			
			const importTableId = localStorage.getItem('importTableId');
			if (!importTableId) {
				showToast('×œ× × ××¦× ID ×©×œ ×˜×‘×œ×ª ×”×¢×–×¨', 'warning');
				return;
			}
			
			console.log('ğŸ” Import Table ID:', importTableId); // ×œ×•×’ ×—×“×©
			
			try {
				showLoading('××™×™×‘× × ×ª×•× ×™× ××˜×‘×œ×ª ×”×¢×–×¨...');
				
				let importedCount = 0;
				
				// ×™×™×‘×•× ××™×§×•××™×
				try {
					console.log('ğŸ“ Starting locations import...'); // ×œ×•×’ ×—×“×©
					
					const locationsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Locations!A2:O1000'
					});
					
					console.log('ğŸ“ Locations response:', locationsResponse.result); // ×œ×•×’ ×—×“×©
					
					if (locationsResponse.result.values && locationsResponse.result.values.length > 0) {
						console.log('ğŸ“ Found', locationsResponse.result.values.length, 'location rows'); // ×œ×•×’ ×—×“×©
						
						for (const row of locationsResponse.result.values) {
							if (row[0] && row[1]) {
								const locationData = parseLocationFromRow(row);
								locations.push(locationData);
								importedCount++;
								
								await new Promise(resolve => setTimeout(resolve, 200));
							}
						}
						showToast(`×™×•×‘××• ${importedCount} ××™×§×•××™×`, 'success');
					} else {
						console.log('ğŸ“ No locations data found'); // ×œ×•×’ ×—×“×©
					}
				} catch (error) {
					console.error('ğŸ“ Locations import error:', error); // ×œ×•×’ ×—×“×©
				}
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				// ×™×™×‘×•× ×‘×™×§×•×¨×™×
				try {
					console.log('ğŸ”§ Starting visits import...');
					
					const visitsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Visits!A2:M1000'
					});
					
					console.log('ğŸ”§ Visits response:', visitsResponse.result);
					
					let visitsCount = 0;
					if (visitsResponse.result.values && visitsResponse.result.values.length > 0) {
						console.log('ğŸ”§ Found', visitsResponse.result.values.length, 'visit rows');
						
						for (let i = 0; i < visitsResponse.result.values.length; i++) {
							const row = visitsResponse.result.values[i];
							if (row[0] && row[1]) {
								const visitData = parseVisitFromRow(row);
								if (!isDuplicateVisit(visitData)) {
									visits.push(visitData);
									// ×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×œ××—×¨ ×”×•×¡×¤×ª ×‘×™×§×•×¨ ×—×“×©
									//await updateSingleLocationTreatmentDates(visitData.location_id);
									visitsCount++;
								} else {
									console.log('âš ï¸ Duplicate visit skipped:', visitData.date, visitData.location_id);
								}
								visitsCount++;
								
								// ×”×¦×’ ×”×ª×§×“××•×ª ×›×œ 50 ×¨×©×•××•×ª
								if (visitsCount % 50 === 0) {
									console.log(`ğŸ”§ Processed ${visitsCount}/${visitsResponse.result.values.length} visits`);
									showToast(`××¢×‘×“ ×‘×™×§×•×¨ ${visitsCount}...`, 'info', 1000);
								}
								
								await new Promise(resolve => setTimeout(resolve, 100)); // ×”××ª× ×” ×§×¦×¨×” ×™×•×ª×¨
							}
						}
						showToast(`×™×•×‘××• ${visitsCount} ×‘×™×§×•×¨×™×`, 'success');
					} else {
						console.log('ğŸ”§ No visits data found');
					}
				} catch (error) {
					console.error('ğŸ”§ Visits import error:', error);
				}
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				// ×™×™×‘×•× ×§×‘×œ×•×ª
				try {
					console.log('ğŸ§¾ Starting receipts import...');
					
					const receiptsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Receipts!A2:J1000'
					});
					
					console.log('ğŸ§¾ Receipts response:', receiptsResponse.result);
					
					let receiptsCount = 0;
					if (receiptsResponse.result.values && receiptsResponse.result.values.length > 0) {
						console.log('ğŸ§¾ Found', receiptsResponse.result.values.length, 'receipt rows');
						
						for (let i = 0; i < receiptsResponse.result.values.length; i++) {
							const row = receiptsResponse.result.values[i];
							if (row[0] && row[3]) { // ID ×•×ª××¨×™×š
								const receiptData = parseReceiptFromRow(row);
								
								
								if (!isDuplicateReceipt(receiptData)) {
									receipts.push(receiptData);
									receiptsCount++;
								} else {
									console.log('âš ï¸ Duplicate receipt skipped:', receiptData.date, receiptData.location_id);
								}
								
								// ×”×¦×’ ×”×ª×§×“××•×ª ×›×œ 25 ×¨×©×•××•×ª (×§×‘×œ×•×ª ×‘×“×¨×š ×›×œ×œ ×¤×—×•×ª)
								if (receiptsCount % 25 === 0) {
									console.log(`ğŸ§¾ Processed ${receiptsCount}/${receiptsResponse.result.values.length} receipts`);
									showToast(`××¢×‘×“ ×§×‘×œ×” ${receiptsCount}...`, 'info', 1000);
								}
								
								await new Promise(resolve => setTimeout(resolve, 100)); // ×”××ª× ×” ×§×¦×¨×” ×™×•×ª×¨
							}
						}
						showToast(`×™×•×‘××• ${receiptsCount} ×§×‘×œ×•×ª`, 'success');
					} else {
						console.log('ğŸ§¾ No receipts data found');
					}
				} catch (error) {
					console.error('ğŸ§¾ Receipts import error:', error);
				}
				
				// ×©××™×¨×” ××§×•××™×ª ×•×¢×“×›×•×Ÿ ×ª×¦×•×’×”
				saveToLocalStorage();
				loadLocationsTable();
				loadReceiptsTable();
				loadFilterOptions();

				// ×‘×“×™×§×” ×©×”× ×ª×•× ×™× × ×˜×¢× ×• × ×›×•×Ÿ
				console.log('ğŸ” ×‘×“×™×§×ª ×™×™×‘×•×:');
				console.log(`×œ×§×•×—×•×ª: ${locations.length}`);
				console.log(`×‘×™×§×•×¨×™×: ${visits.length}`);
				console.log(`×§×‘×œ×•×ª: ${receipts.length}`);

				// ×”×¦×’ ×“×•×’××” ×©×œ ×”×¨×©×•××” ×”×¨××©×•× ×” ××›×œ ×¡×•×’
				if (locations.length > 0) {
					console.log('×“×•×’××” ×œ×§×•×—:', locations[0]);
				}
				if (visits.length > 0) {
					console.log('×“×•×’××” ×‘×™×§×•×¨:', visits[0]);
				}


				// ×ª×•×¡×¤×” ×—×©×•×‘×” - ×©××™×¨×” ×œ×¢× ×Ÿ!
				showToast('×©×•××¨ × ×ª×•× ×™× ×—×“×©×™× ×œ×¢× ×Ÿ...', 'info');

				try {
					/// await saveAllToSheets();
					/// await saveAllToSheetsOptimized();
					
					// ×©××™×¨×” ××”×™×¨×” ×œ×¤×™ ×¡×•×’ × ×ª×•× ×™×
					const locationSuccess = await saveLocationsBatch(newLocations || []);
					const visitSuccess = await saveVisitsBatch(newVisits || []);  
					const receiptSuccess = await saveReceiptsBatch(newReceipts || []);

					if (locationSuccess && visitSuccess && receiptSuccess) {
						showToast('ğŸš€ ×©××™×¨×” ××”×™×¨×” ×”×•×©×œ××” ×‘×”×¦×œ×—×”!', 'success');
					} else {
						showToast('âš ï¸ ×—×œ×§ ××”× ×ª×•× ×™× ×œ× × ×©××¨×• ×œ×¢× ×Ÿ', 'warning');
					}

					showToast(`ğŸ‰ ×™×™×‘×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”!
					ğŸ“ ${locationsCount || 0} ××™×§×•××™×
					ğŸ”§ ${visitsCount || 0} ×‘×™×§×•×¨×™×  
					ğŸ§¾ ${receiptsCount || 0} ×§×‘×œ×•×ª
					âœ… ×”×›×œ × ×©××¨ ×œ×¢× ×Ÿ!`, 'success', 6000);
				} catch (error) {
					console.error('Error saving imported data to cloud:', error);
					showToast('×™×™×‘×•× ×”×•×©×œ× ××§×•××™×ª, ××‘×œ ×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ', 'warning');
				}
				
			} catch (error) {
				console.error('Import error:', error);
				showToast('×©×’×™××” ×‘×™×™×‘×•× × ×ª×•× ×™×', 'error');
			} finally {
				hideLoading();
			}
		}

		// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×¤×¨×¡×•×¨ ×©×•×¨×•×ª
		function parseVisitFromRow(row) {
			return {
				ID: row[0] || generateID(),
				date: row[1] || '',
				location_id: row[2] || '',
				visit_type: row[3] || '',
				work_done: row[4] || '',
				duration_minutes: parseInt(row[5]) || 0,
				num_workers: parseInt(row[6]) || 1,
				start_time: row[7] || '',
				end_time: row[8] || '',
				amount: parseFloat(row[9]) || 0,
				expense: parseFloat(row[10]) || 0,
				paid: row[11] || '×œ×',
				notes: row[12] || ''
			};
		}

		function parseReceiptFromRow(row) {
			return {
				ID: row[0] || generateID(),
				booklet_number: row[1] || '',
				receipt_number: row[2] || '',
				date: row[3] || '',
				location_id: row[4] || '',
				location_name: row[5] || '',
				amount: parseFloat(row[6]) || 0,
				payment_type: row[7] || '',
				tax_code: row[8] || '',
				notes: row[9] || ''
			};
		}
	   
	   // ×”×•×¡×£ ××ª ×–×” ×œ×¡×•×£ ×”×§×•×“
		function updateImportTableStatus() {
			const importTableId = localStorage.getItem('importTableId');
			const statusDiv = document.getElementById('importTableStatus');
			
			if (importTableId && statusDiv) {
				statusDiv.innerHTML = `
					<span style="font-size: 13px; color: #28a745;">
						âœ… ×˜×‘×œ×ª ×¢×–×¨ ×–××™× ×”: 
						<a href="https://docs.google.com/spreadsheets/d/${importTableId}/edit" 
						   target="_blank" style="color: #007bff; text-decoration: underline;">
						   ×¤×ª×— ×˜×‘×œ×”
						</a>
					</span>
					<br>
					<button onclick="localStorage.removeItem('importTableId'); updateImportTableStatus();" 
							style="background: none; border: none; color: #dc3545; font-size: 12px; cursor: pointer; margin-top: 5px;">
						ğŸ—‘ï¸ ××—×§ ×§×™×©×•×¨ ×œ×˜×‘×œ×ª ×¢×–×¨
					</button>
				`;
			} else if (statusDiv) {
				statusDiv.innerHTML = `
					<span style="font-size: 13px; color: #666;">
						âŒ ×œ× × ××¦××” ×˜×‘×œ×ª ×¢×–×¨ ×©××•×¨×”
					</span>
					<br>
					<span style="font-size: 12px; color: #999;">
						×¦×•×¨ ×˜×‘×œ×ª ×¢×–×¨ ×—×“×©×” ×›×“×™ ×œ×™×™×‘× × ×ª×•× ×™×
					</span>
				`;
			}
		}

		// ×”×¨×¥ ××ª ×–×” ×›×©×”×“×£ × ×˜×¢×Ÿ
		document.addEventListener('DOMContentLoaded', function() {
			updateImportTableStatus();
		});

		// ×”×¨×¥ ×’× ×›×©×¢×•×‘×¨×™× ×œ×˜××‘ ×”××¢×¨×›×ª
		function showTab(event, tabName) {
			// ×”×§×•×“ ×”×§×™×™× ×©×œ×š...
			
			// ×”×•×¡×£ ××ª ×–×” ×‘×¡×•×£ ×”×¤×•× ×§×¦×™×”
			if (tabName === 'system') {
				setTimeout(() => {
					updateImportTableStatus();
					updateTelegramHelperStatus(); // ×”×•×¡×£ ×©×•×¨×” ×–×•
				}, 100);
			}
		}
	   
	   


		// ×”×•×¡×£ ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ××™×“×¢ ×¢×œ ×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨×
		function updateTelegramHelperStatus() {
			const telegramTableId = localStorage.getItem('telegramHelperTableId');
			const statusDiv = document.getElementById('telegramHelperStatus');
			
			if (statusDiv) {
				if (telegramTableId) {
					statusDiv.innerHTML = `
						<span style="color: green;">âœ“ ×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨× ××•×›× ×”</span>
						<br>
						<a href="https://docs.google.com/spreadsheets/d/${telegramTableId}" target="_blank" style="font-size: 12px;">
							×¤×ª×— ×‘×’×•×’×œ ×©×™×˜×¡
						</a>
					`;
				} else {
					statusDiv.innerHTML = `
						<span style="color: orange;">âš  ×œ× × ××¦××” ×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨×</span>
						<br>
						<span style="font-size: 12px;">×¦×•×¨ ×˜×‘×œ×” ×—×“×©×” ×ª×—×™×œ×”</span>
					`;
				}
			}
		}

		// ×¤×•× ×§×¦×™×” ×¨××©×™×ª ××©×•×¤×¨×ª ×œ×¤×™×¢× ×•×— ×˜×§×¡×˜ ×˜×œ×’×¨×
		function parseTelegramText(text) {
			const lines = text.split('\n');
			const visits = [];
			
			let currentDate = '';
			let currentTime = '';
			let currentVisit = null;
			let pendingNotes = [];
			
			for (let i = 0; i < lines.length; i++) {
				const line = lines[i].trim();
				if (!line) continue;
				
				// ×–×™×”×•×™ ×ª××¨×™×š
				if (isDateLine(line)) {
					// ×× ×™×© ×‘×™×§×•×¨ ×¤×ª×•×—, ×¡×’×•×¨ ××•×ª×•
					if (currentVisit) {
						visits.push(finalizeVisit(currentVisit, pendingNotes));
						currentVisit = null;
						pendingNotes = [];
					}
					currentDate = parseTelegramDate(line);
					continue;
				}
				
				// ×–×™×”×•×™ ×©×¢×”
				if (isTimeLine(line)) {
					currentTime = line;
					continue;
				}
				
				// ×–×™×”×•×™ ×©×•×¨×” ×©×œ Assaf H
				if (line === 'Assaf H') {
					const nextLine = lines[i + 1];
					if (!nextLine) continue;
					
					// ×‘×“×•×§ ×× ×–×” ×ª×—×™×œ×ª ×‘×™×§×•×¨ ×—×“×©
					if (isNewVisitStart(nextLine, locations)) {
						// ×¡×’×•×¨ ×‘×™×§×•×¨ ×§×•×“× ×× ×§×™×™×
						if (currentVisit) {
							visits.push(finalizeVisit(currentVisit, pendingNotes));
							pendingNotes = [];
						}
						
						// ×”×ª×—×œ ×‘×™×§×•×¨ ×—×“×©
						const client = findClientSmart(nextLine, locations);
						currentVisit = {
							date: currentDate,
							time: currentTime,
							client: client,
							workDescription: [nextLine],
							duration: 0,
							workType: identifyWorkType(nextLine),
							notes: []
						};
					}
					// ×‘×“×•×§ ×× ×–×” ×¡×™×•× ×‘×™×§×•×¨
					else if (currentVisit && isVisitEnd(nextLine)) {
						currentVisit.workDescription.push(nextLine);
						const duration = extractTimeFromText(nextLine);
						if (duration > 0) {
							currentVisit.duration = duration;
						}
						
						// ×‘×“×•×§ ×× ×™×© ×–××Ÿ ×‘×©×•×¨×•×ª ×”×‘××•×ª
						if (currentVisit.duration === 0 && i + 2 < lines.length) {
							const timeInfo = extractTimeFromText(lines[i + 2]);
							if (timeInfo > 0) {
								currentVisit.duration = timeInfo;
							}
						}
						
						visits.push(finalizeVisit(currentVisit, pendingNotes));
						currentVisit = null;
						pendingNotes = [];
					}
					// ××—×¨×ª, ×–×” ×¤×¨×˜ × ×•×¡×£ ×¢×œ ×”×‘×™×§×•×¨ ×”× ×•×›×—×™
					else if (currentVisit) {
						currentVisit.workDescription.push(nextLine);
						
						// ×‘×“×•×§ ×× ×™×© ×–××Ÿ ×‘×©×•×¨×” ×–×•
						const duration = extractTimeFromText(nextLine);
						if (duration > 0 && currentVisit.duration === 0) {
							currentVisit.duration = duration;
						}
						
						// ×¢×“×›×Ÿ ×¡×•×’ ×¢×‘×•×“×” ×× × ××¦× ×¡×•×’ ×—×“×©
						const workType = identifyWorkType(nextLine);
						if (workType !== '×›×œ×œ×™' && currentVisit.workType === '×›×œ×œ×™') {
							currentVisit.workType = workType;
						}
					}
					
					// ××™×¡×•×£ ×”×¢×¨×•×ª
					const notes = extractNotes(nextLine);
					if (notes) {
						if (currentVisit) {
							currentVisit.notes.push(notes);
						} else {
							pendingNotes.push(notes);
						}
					}
					
					i++; // ×“×œ×’ ×¢×œ ×”×©×•×¨×” ×”×‘××” ×›×™ ×›×‘×¨ ×¢×™×‘×“× ×• ××•×ª×”
				}
				// ×©×•×¨×•×ª ××—×¨×•×ª ×©×¢×œ×•×œ×•×ª ×œ×”×›×™×œ ××™×“×¢
				else {
					const notes = extractNotes(line);
					if (notes) {
						if (currentVisit) {
							currentVisit.notes.push(notes);
						} else {
							pendingNotes.push(notes);
						}
					}
					
					// ×‘×“×•×§ ×× ×™×© ×–××Ÿ ×‘×©×•×¨×•×ª ×¢×¦×××™×•×ª
					if (currentVisit && currentVisit.duration === 0) {
						const duration = extractTimeFromText(line);
						if (duration > 0) {
							currentVisit.duration = duration;
						}
					}
				}
			}
			
			// ×¡×’×•×¨ ×‘×™×§×•×¨ ××—×¨×•×Ÿ ×× ×§×™×™×
			if (currentVisit) {
				visits.push(finalizeVisit(currentVisit, pendingNotes));
			}
			
			return visits;
		}

		// ×¤×•× ×§×¦×™×” ×¢×–×¨ ×œ×¡×™×•× ×‘×™×§×•×¨
		function finalizeVisit(visit, pendingNotes) {
			const client = visit.client;
			
			// ×× ×œ× × ××¦× ×–××Ÿ, × ×¡×” ×œ×—×©×‘ ××”×©×¢×•×ª ××• ×§×‘×¢ ×‘×¨×™×¨×ª ××—×“×œ
			if (visit.duration === 0) {
				if (visit.time) {
					// ×›××Ÿ ××¤×©×¨ ×œ×”×•×¡×™×£ ×œ×•×’×™×§×” ×œ×—×™×©×•×‘ ×–××Ÿ ××”×¤×¨×© ×©×¢×•×ª
					visit.duration = 60; // ×‘×¨×™×¨×ª ××—×“×œ ×©×œ ×©×¢×”
				} else {
					visit.duration = 60;
				}
			}
			
			// ×¤×•×¨××˜ ×©××ª××™× ×‘×“×™×•×§ ×œ×§×•×“ ×”×§×™×™× ×©×œ confirmTelegramImport
			return {
				date: visit.date,
				time: visit.time || '',
				client_name: client ? client.name : '×œ× ×–×•×”×”',
				client_id: client ? client.ID : null,
				address: client ? client.full_address : '',
				work_done: visit.workDescription.join(' '),
				duration_minutes: visit.duration,
				raw_text: visit.workDescription.join('\n') + '\n' + [...visit.notes, ...pendingNotes].join('\n')
			};
		}

		// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×–×™×”×•×™ ×“×¤×•×¡×™×
		function isDateLine(line) {
			// ×–×™×”×•×™ ×ª××¨×™×š ×›××• "15 August 2024"
			const dateRegex = /^\d{1,2}\s+[A-Za-z]+\s+\d{4}$/;
			return dateRegex.test(line);
		}

		function isTimeLine(line) {
			// ×–×™×”×•×™ ×©×¢×” ×›××• "13:39"
			const timeRegex = /^\d{1,2}:\d{2}$/;
			return timeRegex.test(line);
		}

		function parseTelegramDate(dateStr) {
			// ×”××¨ "15 August 2024" ×œ-"2024-08-15"
			const months = {
				'January': '01', 'February': '02', 'March': '03', 'April': '04',
				'May': '05', 'June': '06', 'July': '07', 'August': '08',
				'September': '09', 'October': '10', 'November': '11', 'December': '12'
			};
			
			const parts = dateStr.split(' ');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = months[parts[1]] || '01';
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			
			return '';
		}

		// ×™×¦×™×¨×ª ×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨× ×—×“×©×”
		async function createTelegramHelperTable() {
			if (!await validateToken()) {
				showToast('× ×“×¨×© ×—×™×‘×•×¨ ×œ×’×•×’×œ ×ª×—×™×œ×”', 'warning');
				return null;
			}
			
			try {
				showLoading('×™×•×¦×¨ ×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨×...');
				
				const response = await gapi.client.sheets.spreadsheets.create({
					resource: {
						properties: {
							title: `×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨× - ${new Date().toLocaleDateString('he-IL')}`
						},
						sheets: [{
							properties: { title: 'Visits' }
						}]
					}
				});
				
				const spreadsheetId = response.result.spreadsheetId;
				
				// ×”×•×¡×£ ×›×•×ª×¨×•×ª
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: spreadsheetId,
					range: 'Visits!A1:M1',
					valueInputOption: 'RAW',
					resource: {
						values: [[
							'year', 'month', 'day', 'customer', 'contact_person', 
							'treatment', 'date', 'work_done', 'duration', 'amount', 
							'paid', 'expense', 'notes'
						]]
					}
				});
				
				localStorage.setItem('telegramHelperTableId', spreadsheetId);
				
				showToast('âœ… ×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨× × ×•×¦×¨×” ×‘×”×¦×œ×—×”!', 'success');
				
				return spreadsheetId;
				
			} catch (error) {
				console.error('Error creating telegram helper table:', error);
				showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨×', 'error');
				return null;
			} finally {
				hideLoading();
			}
		}


		// ×¤×•× ×§×¦×™×” ×—×“×©×” - ×™×‘×•× ××˜×œ×’×¨× ×œ×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨×
		async function importFromTelegramToHelper() {
			const fileInput = document.createElement('input');
			fileInput.type = 'file';
			fileInput.accept = '.txt';
			fileInput.multiple = true;
			
			fileInput.onchange = async (event) => {
				const files = Array.from(event.target.files);
				if (files.length === 0) return;
				
				try {
					showLoading(`××¤×¨×¡×¨ ${files.length} ×§×‘×¦×™ ×˜×œ×’×¨× ×œ×˜×‘×œ×ª ×¢×–×¨...`);
					
					let allParsedVisits = [];
					
					for (let i = 0; i < files.length; i++) {
						const file = files[i];
						console.log(`ğŸ“„ Processing file ${i+1}/${files.length}: ${file.name}`);
						
						const text = await file.text();
						const parsedVisits = parseTelegramText(text);
						
						console.log(`ğŸ“„ File ${file.name}: found ${parsedVisits.length} visits`);
						allParsedVisits = allParsedVisits.concat(parsedVisits);
						
						if (i < files.length - 1) {
							await new Promise(resolve => setTimeout(resolve, 300));
						}
					}
					
					if (allParsedVisits.length > 0) {
						// ×©×œ×— ×™×©×™×¨×•×ª ×œ×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨×
						await saveTelegramDataToHelper(allParsedVisits);
						showToast(`× ×ª×•× ×™× × ×©××¨×• ×‘×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨×: ${allParsedVisits.length} ×‘×™×§×•×¨×™×`, 'success');
					} else {
						showToast('×œ× × ××¦××• ×‘×™×§×•×¨×™× ×‘×§×‘×¦×™×', 'warning');
					}
					
				} catch (error) {
					console.error('Error parsing telegram files:', error);
					showToast('×©×’×™××” ×‘×¤×¨×¡×•×¨ ×§×‘×¦×™ ×˜×œ×’×¨×', 'error');
				} finally {
					hideLoading();
				}
			};
			
			fileInput.click();
		}

		// ×¤×•× ×§×¦×™×” ×œ×©××™×¨×ª × ×ª×•× ×™× ×‘×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨×
		async function saveTelegramDataToHelper(parsedVisits) {
			if (!await validateToken()) {
				showToast('× ×“×¨×© ×—×™×‘×•×¨ ×œ×’×•×’×œ', 'error');
				return;
			}
			
			try {
				// ×©××•×¨ ×œ×©×ª×™ ×”××¢×¨×›×•×ª: ×”×™×©× ×” ×•×”×—×“×©×”
				
				// 1. ×©××™×¨×” ×œ××¢×¨×›×ª ×”×™×©× ×” (×˜×‘×œ×” × ×¤×¨×“×ª)
				let telegramTableId = localStorage.getItem('telegramHelperTableId');
				
				if (!telegramTableId) {
					telegramTableId = await createTelegramHelperTable();
					if (!telegramTableId) return;
				}
				
				// ×”××¨ ××ª ×”× ×ª×•× ×™× ×œ×¤×•×¨××˜ CSV ×”×™×©×Ÿ
				const csvData = parsedVisits.map(visit => [
					visit.date.split('-')[0], // year
					visit.date.split('-')[1], // month
					visit.date.split('-')[2], // day
					visit.client_name,
					'', // contact_person - ×™××•×œ× ××”××¢×¨×›×ª
					identifyWorkType(visit.work_done),
					visit.date,
					visit.work_done,
					visit.duration_minutes.toString(),
					'0', // amount
					'×œ×', // paid
					'0', // expense
					visit.raw_text || '' // notes
				]);
				
				// ×©××•×¨ ×œ×˜×‘×œ×ª ×¢×–×¨ ×”×™×©× ×”
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: telegramTableId,
					range: 'Visits!A:M',
					valueInputOption: 'USER_ENTERED',
					resource: {
						values: csvData
					}
				});
				
				// 2. ×©××™×¨×” ×œ××¢×¨×›×ª ×”×—×“×©×” (TelegramVisits)
				await saveTelegramVisitsToCloud(parsedVisits);
				
				console.log(`âœ… ×©××¨ ${parsedVisits.length} ×‘×™×§×•×¨×™× ×œ×©×ª×™ ×”××¢×¨×›×•×ª`);
				
			} catch (error) {
				console.error('Error saving to telegram helper table:', error);
				showToast('×©×’×™××” ×‘×©××™×¨×” ×œ×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨×', 'error');
			}
		}

		// ×¤×•× ×§×¦×™×” ×œ×™×‘×•× ××˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨× ×œ××¢×¨×›×ª ×”×¨××©×™×ª
		async function importFromTelegramHelper() {
			if (!await validateToken()) {
				showToast('× ×“×¨×© ×—×™×‘×•×¨ ×œ×’×•×’×œ', 'error');
				return;
			}
			
			const telegramTableId = localStorage.getItem('telegramHelperTableId');
			if (!telegramTableId) {
				showToast('×œ× × ××¦××” ×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨×. ×¦×•×¨ ×˜×‘×œ×” ×—×“×©×” ×ª×—×™×œ×”.', 'warning');
				return;
			}
			
			try {
				showLoading('××™×™×‘× × ×ª×•× ×™× ××˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨×...');
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: telegramTableId,
					range: 'Visits!A2:M1000'
				});
				
				if (!response.result.values || response.result.values.length === 0) {
					showToast('×˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨× ×¨×™×§×”', 'warning');
					return;
				}
				
				let importedCount = 0;
				
				for (const row of response.result.values) {
					if (row[0] && row[3]) { // ×™×© ×©× ×” ×•×©× ×œ×§×•×—
						const visitData = {
							ID: generateID(),
							date: `${row[0]}-${row[1].padStart(2, '0')}-${row[2].padStart(2, '0')}`,
							location_id: findLocationByName(row[3])?.ID || null,
							location_name: row[3] || '',
							visit_type: row[5] || '×›×œ×œ×™',
							work_done: row[7] || '',
							duration_minutes: parseInt(row[8]) || 60,
							num_workers: 1,
							start_time: '',
							end_time: '',
							amount: parseInt(row[9]) || 0,
							expense: parseInt(row[11]) || 0,
							notes: row[12] || ''
						};
						
						visits.push(visitData);
						importedCount++;
					}
				}
				
				// ×©××•×¨ ×”×›×œ
				saveToLocalStorage();
				loadReceiptsTable();
				loadFilterOptions();
				await saveAllToSheetsOptimized();
				
				showToast(`×™×•×‘××• ×‘×”×¦×œ×—×” ${importedCount} ×‘×™×§×•×¨×™× ××˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨×!`, 'success');
				
			} catch (error) {
				console.error('Error importing from telegram helper:', error);
				showToast('×©×’×™××” ×‘×™×‘×•× ××˜×‘×œ×ª ×¢×–×¨ ×˜×œ×’×¨×', 'error');
			} finally {
				hideLoading();
			}
		}

		// ×¤×•× ×§×¦×™×” ×¢×–×¨ ×œ××¦×™××ª ×œ×§×•×— ×œ×¤×™ ×©×
		function findLocationByName(customerName) {
			if (!customerName) return null;
			
			return locations.find(loc => 
				loc.name && loc.name.toLowerCase().includes(customerName.toLowerCase())
			) || null;
		}


		// ×¤×•× ×§×¦×™×” ××©×•×¤×¨×ª ×œ×–×™×”×•×™ ×œ×§×•×—×•×ª - ×ª×—×œ×™×£ ××ª findClientInText ×”×§×™×™××ª
		function findClientSmart(text, locations) {
			if (!text || !locations) return null;
			
			const textLower = text.toLowerCase().trim();
			
			// ×©×œ×‘ 1: ×”×ª×××” ×™×©×™×¨×” ××œ××”
			for (const location of locations) {
				if (location.name && textLower.includes(location.name.toLowerCase())) {
					return location;
				}
				if (location.full_address && textLower.includes(location.full_address.toLowerCase())) {
					return location;
				}
			}
			
			// ×©×œ×‘ 2: ×–×™×”×•×™ ×œ×¤×™ ×¨×—×•×‘ + ××¡×¤×¨ (×¢× ××• ×‘×œ×™ ×¢×™×¨)
			const addressMatch = textLower.match(/([×-×ª\s']+)\s+(\d+)/);
			if (addressMatch) {
				const street = addressMatch[1].trim();
				const number = addressMatch[2];
				
				for (const location of locations) {
					if (location.name) {
						const locationParts = location.name.toLowerCase().split(' ');
						if (locationParts.length >= 2) {
							const locationStreet = locationParts[0];
							const locationNumber = locationParts[1];
							
							if (street.includes(locationStreet) && number === locationNumber) {
								return location;
							}
						}
					}
				}
			}
			
			// ×©×œ×‘ 3: ×–×™×”×•×™ ×©××•×ª ×—×œ×§×™×™× (×›××• "×•×™× ×™×§" ×‘××§×•× "×•×™× ×™×§ 49 ×¨××©×œ×¦")
			const words = textLower.split(/\s+/);
			for (const word of words) {
				if (word.length >= 3) { // ×¨×§ ××™×œ×™× ×©×œ 3 ××•×ª×™×•×ª ××• ×™×•×ª×¨
					for (const location of locations) {
						if (location.name && location.name.toLowerCase().startsWith(word)) {
							// ×•×•×“× ×©×–×” ×”×©× ×”×™×—×™×“ ×©××ª×—×™×œ ×›×š
							const matches = locations.filter(loc => 
								loc.name && loc.name.toLowerCase().startsWith(word)
							);
							if (matches.length === 1) {
								return location;
							}
						}
					}
				}
			}
			
			// ×©×œ×‘ 4: ×–×™×”×•×™ ×œ×¤×™ ×¨×—×•×‘ ×‘×œ×‘×“ (×œ×©××•×ª ×™×“×•×¢×™×)
			for (const word of words) {
				if (word.length >= 4) {
					for (const location of locations) {
						if (location.name) {
							const locationStreet = location.name.toLowerCase().split(' ')[0];
							if (locationStreet === word) {
								return location;
							}
						}
					}
				}
			}
			
			return null;
		}


		// ×¤×•× ×§×¦×™×” ××©×•×¤×¨×ª ×œ×—×™×œ×•×¥ ×–×× ×™× - ×ª×—×œ×™×£ ××ª extractDuration ×”×§×™×™××ª
		function extractTimeFromText(text) {
			if (!text) return 0;
			
			const textLower = text.toLowerCase().trim();
			
			// ×“×¤×•×¡ 1: ××¡×¤×¨ + "×©×¢×•×ª"
			let match = textLower.match(/(\d+(?:\.\d+)?)\s*×©×¢×•×ª/);
			if (match) {
				return Math.round(parseFloat(match[1]) * 60);
			}
			
			// ×“×¤×•×¡ 2: "×©×¢×ª×™×™×" ×¢× ×•×¨×™××¦×™×•×ª
			if (textLower.includes('×©×¢×ª×™×™×')) {
				if (textLower.includes('×•×—×¦×™')) return 150;
				if (textLower.includes('×•×¨×‘×¢')) return 135;
				if (textLower.includes('×•×©×œ×•×©×ª ×¨×‘×¢×™')) return 165;
				return 120;
			}
			
			// ×“×¤×•×¡ 3: "×©×¢×”" ×¢× ×•×¨×™××¦×™×•×ª
			if (textLower.includes('×©×¢×”') && !textLower.includes('×©×¢×•×ª')) {
				if (textLower.includes('×•×—×¦×™')) return 90;
				if (textLower.includes('×•×¨×‘×¢')) return 75;
				if (textLower.includes('×•×©×œ×•×©×ª ×¨×‘×¢×™')) return 105;
				return 60;
			}
			
			// ×“×¤×•×¡ 4: "×—×¦×™ ×©×¢×”", "×¨×‘×¢ ×©×¢×”"
			if (textLower.includes('×—×¦×™ ×©×¢×”')) return 30;
			if (textLower.includes('×¨×‘×¢ ×©×¢×”')) return 15;
			
			// ×“×¤×•×¡ 5: ××¡×¤×¨ ×¢×©×¨×•× ×™ ×¢× ×©×¢×•×ª (×›××• "1.75 ×©×¢×•×ª")
			match = textLower.match(/(\d+\.\d+)\s*×©×¢×”/);
			if (match) {
				return Math.round(parseFloat(match[1]) * 60);
			}
			
			// ×“×¤×•×¡ 6: ×›××•×™×•×ª ××™×œ×•×œ×™×•×ª
			if (textLower.includes('×›×©×¢×ª×™×™×')) return 120;
			if (textLower.includes('×›×©×¢×”')) return 60;
			if (textLower.includes('×›××¢×˜ ×©×¢×ª×™×™×')) return 115;
			if (textLower.includes('×›××¢×˜ ×©×¢×”')) return 55;
			
			// ×“×¤×•×¡ 7: ×“×§×•×ª
			match = textLower.match(/(\d+)\s*×“×§/);
			if (match) {
				return parseInt(match[1]);
			}
			
			// ×“×¤×•×¡ 8: ×‘×™×˜×•×™×™× ××™×•×—×“×™×
			if (textLower.includes('×œ×¤× ×™ ×¨×‘×¢ ×©×¢×”')) return 15;
			if (textLower.includes('×œ×¤× ×™ ×—×¦×™ ×©×¢×”')) return 30;
			if (textLower.includes('×œ×¤× ×™ ×›×©×¢×”')) return 60;
			
			// ×“×¤×•×¡ 9: ××¡×¤×¨×™× ×¢× × ×§×•×“×” (×›××• "2.5" ××• "3.25")
			match = textLower.match(/(\d+)\.(\d+)/);
			if (match) {
				const hours = parseInt(match[1]);
				const fraction = parseInt(match[2]);
				if (fraction === 5) return hours * 60 + 30; // .5 = ×—×¦×™ ×©×¢×”
				if (fraction === 25) return hours * 60 + 15; // .25 = ×¨×‘×¢ ×©×¢×”
				if (fraction === 75) return hours * 60 + 45; // .75 = ×©×œ×•×©×ª ×¨×‘×¢×™ ×©×¢×”
			}
			
			// ×“×¤×•×¡ 10: ×˜×•×•×—×™ ×–××Ÿ (×›××• "2-3 ×©×¢×•×ª")
			match = textLower.match(/(\d+)-(\d+)\s*×©×¢×•×ª/);
			if (match) {
				const avg = (parseInt(match[1]) + parseInt(match[2])) / 2;
				return Math.round(avg * 60);
			}
			
			return 0;
		}


		// ×¤×•× ×§×¦×™×” ××©×•×¤×¨×ª ×œ×–×™×”×•×™ ×¡×•×’×™ ×¢×‘×•×“×” - ×ª×—×œ×™×£ ××ª getWorkType ×”×§×™×™××ª
		function identifyWorkType(text) {
			if (!text) return '×›×œ×œ×™';
			
			const textLower = text.toLowerCase().trim();
			
			// ×¡×•×’×™ ×¢×‘×•×“×” ×¡×¤×¦×™×¤×™×™×
			if (textLower.includes('×—×¨××©')) return '×—×¨××©';
			if (textLower.includes('×’×™×–×•×')) return '×’×™×–×•×';
			if (textLower.includes('×›×™×¡×•×—') || textLower.includes('××›×¡×—×ª')) return '×›×™×¡×•×—';
			if (textLower.includes('××¤×•×—')) return '××¤×•×—';
			if (textLower.includes('×©×ª×™×œ×”') || textLower.includes('×©×ª×œ×ª×™')) return '×©×ª×™×œ×”';
			if (textLower.includes('×¨×™×¡×•×¡') || textLower.includes('×¨×™×¡×¡×ª×™')) return '×¨×™×¡×•×¡';
			
			// ×”×©×§×™×” ×•×ª×™×§×•× ×™×
			if (textLower.includes('×”×©×§×™×”') || textLower.includes('×”×©×§×™×™×”')) return '×”×©×§×™×”';
			if (textLower.includes('×ª×™×§×•× ×™ ×”×©×§×™×”') || textLower.includes('×‘×“×™×§×ª ×”×©×§×™×”')) return '×”×©×§×™×”';
			if (textLower.includes('×”×—×œ×¤×ª ×¡×•×œ×œ×•×ª') || textLower.includes('×”×—×œ×¤×ª ××—×©×‘')) return '×”×©×§×™×”';
			if (textLower.includes('××—×©×‘ ×”×©×§×™×”') || textLower.includes('×‘×¨×– ×—×©××œ×™')) return '×”×©×§×™×”';
			if (textLower.includes('×¦× ×¨×ª') || textLower.includes('×˜×¤×˜×•×£')) return '×”×©×§×™×”';
			if (textLower.includes('×××˜×™×¨×™×') || textLower.includes('××ª×–×™×')) return '×”×©×§×™×”';
			
			// ×¢×‘×•×“×•×ª ×¤×™× ×•×™ ×•× ×™×§×™×•×Ÿ
			if (textLower.includes('×”×•×¦××ª ×’×–×') || textLower.includes('×¤×™× ×•×™ ×’×–×')) return '×”×•×¦××ª ×’×–×';
			if (textLower.includes('×¤×™× ×•×™') && textLower.includes('×’×–×')) return '×”×•×¦××ª ×’×–×';
			if (textLower.includes('××™×¡×•×£') || textLower.includes('×’×™×¨×•×£')) return '× ×™×§×™×•×Ÿ';
			if (textLower.includes('× ×™×§×™×•×Ÿ') || textLower.includes('×œ× ×§×•×ª')) return '× ×™×§×™×•×Ÿ';
			
			// ×¢×‘×•×“×•×ª ××¡×•×¨
			if (textLower.includes('××¡×•×¨') || textLower.includes('×—×™×ª×•×š')) return '×’×™×–×•×';
			if (textLower.includes('×›×¨×™×ª×ª ×¢× ×¤×™×') || textLower.includes('×”×•×¨×“×ª ×¢× ×¤×™×')) return '×’×™×–×•×';
			
			// ×¢×‘×•×“×•×ª ×ª×—×–×•×§×” ××™×•×—×“×•×ª
			if (textLower.includes('×ª×™×§×•×Ÿ') || textLower.includes('×”×—×œ×¤×”')) return '×ª×—×–×•×§×”';
			if (textLower.includes('×”×ª×§× ×”') || textLower.includes('×”×ª×§× ×ª')) return '×ª×—×–×•×§×”';
			
			// ×–×™×”×•×™ ×œ×¤×™ ×›×œ×™× ×©××•×–×›×¨×™×
			if (textLower.includes('××’×–××ª')) return '×’×™×–×•×';
			if (textLower.includes('××¨×¡×¡')) return '×¨×™×¡×•×¡';
			
			// ×× ××•×–×›×¨×™× ××¡×¤×¨ ×¡×•×’×™ ×¢×‘×•×“×” - ×”×—×–×¨ ××ª ×”×¨××©×™
			const workTypes = [];
			if (textLower.includes('×—×¨××©')) workTypes.push('×—×¨××©');
			if (textLower.includes('×’×™×–×•×')) workTypes.push('×’×™×–×•×');
			if (textLower.includes('××¤×•×—')) workTypes.push('××¤×•×—');
			if (textLower.includes('××™×¡×•×£')) workTypes.push('× ×™×§×™×•×Ÿ');
			
			if (workTypes.length > 0) {
				return workTypes[0]; // ×”×—×–×¨ ××ª ×”×¨××©×•×Ÿ ×©× ××¦×
			}
			
			// ×‘×“×™×§×•×ª ××™×•×—×“×•×ª ×œ×¤×™ ×”×§×©×¨
			if (textLower.includes('×‘×“×™×§×”') || textLower.includes('×¡×™×•×¨')) return '×‘×“×™×§×”';
			if (textLower.includes('×˜×™×¤×•×œ ×¨××©×•× ×™') || textLower.includes('×”×¢×¨×›×”')) return '×”×¢×¨×›×”';
			
			return '×›×œ×œ×™';
		}
		
		
		// ×¤×•× ×§×¦×™×” ×œ×–×™×”×•×™ ×”×× ×©×•×¨×” ××¦×™×™× ×ª ×ª×—×™×œ×ª ×‘×™×§×•×¨ ×—×“×©
		function isNewVisitStart(text, locations) {
			if (!text) return false;
			
			const textLower = text.toLowerCase().trim();
			
			// ×–×™×”×•×™ ×™×©×™×¨×•×ª ×©×œ ×œ×§×•×—
			if (findClientSmart(text, locations)) return true;
			
			// ×“×¤×•×¡×™ ×›×ª×•×‘×•×ª ×™×©×¨××œ×™×•×ª
			if (/[×-×ª\s']+\s+\d+/.test(text)) return true;
			
			// ××™×œ×•×ª ××¤×ª×— ×©××¦×™×™× ×•×ª ×”×ª×—×œ×ª ×¢×‘×•×“×”
			const startKeywords = [
				'××ª×—×™×œ', '×”×ª×—×œ×ª×™', '××ª×—×™×œ×™×',
				'×™×¦×™××”', '×”×’×¢×ª×™', '× ×•×¡×¢ ×œ',
				'×‘×“×™×§×ª ×”×©×§×™×”', '×˜×™×¤×•×œ ×¨××©×•× ×™',
				'×”×—×œ×¤×ª', '×”×ª×§× ×ª', '×ª×™×§×•×Ÿ'
			];
			
			for (const keyword of startKeywords) {
				if (textLower.includes(keyword)) return true;
			}
			
			// ×–×™×”×•×™ ×œ×¤×™ ×©××•×ª ×’× ×™×/××–×•×¨×™× ××•×›×¨×™×
			const gardenKeywords = [
				'××‘×¦×¢ × ×—×©×•×Ÿ', '××‘×¦×¢ ××©×”', '×”××¨×’× ×™×ª',
				'××–×¨', '×’×Ÿ ×™×‘× ×”', '×©×™×™× ×§×™×Ÿ'
			];
			
			for (const keyword of gardenKeywords) {
				if (textLower.includes(keyword.toLowerCase())) return true;
			}
			
			return false;
		}

		// ×¤×•× ×§×¦×™×” ×œ×–×™×”×•×™ ×”×× ×©×•×¨×” ××¦×™×™× ×ª ×¡×™×•× ×‘×™×§×•×¨
		function isVisitEnd(text) {
			if (!text) return false;
			
			const textLower = text.toLowerCase().trim();
			
			// ××™×œ×•×ª ×¡×™×•× ××¤×•×¨×©×•×ª
			if (textLower.includes('×¡×™×•×') || textLower.includes('×¡×™×™××ª×™')) return true;
			
			// ×‘×™×˜×•×™×™ ×–××Ÿ ×©××¦×™×™× ×™× ×¡×™×•×
			if (textLower.includes('×©×¢×•×ª') || textLower.includes('×©×¢×”')) {
				// ×× ×™×© ×–××Ÿ + ×‘×™×˜×•×™ ×¡×™×›×•×
				if (textLower.includes('×¡×”×›') || textLower.includes('×¢×“ ×›×”') || 
					textLower.includes('×›×•×œ×œ') || textLower.includes('×œ×§×—')) {
					return true;
				}
			}
			
			// ×‘×™×˜×•×™×™ ××¢×‘×¨ ×œ×‘×™×§×•×¨ ×”×‘×
			if (textLower.includes('× ×•×¡×¢ ×œ') || textLower.includes('×¢×•×‘×¨ ×œ') ||
				textLower.includes('×××©×™×š ×œ') || textLower.includes('×”×‘×™×ª×”')) {
				return true;
			}
			
			// ×”×¤×¡×§×•×ª ×©××¡×™×™××•×ª ×‘×™×§×•×¨
			if (textLower.includes('×”×¤×¡×§×” ×‘×‘×™×ª') || textLower.includes('×‘×‘×™×ª')) {
				return true;
			}
			
			return false;
		}

		// ×¤×•× ×§×¦×™×” ×œ×–×™×”×•×™ ×”×¢×¨×•×ª ×©×›×“××™ ×œ×©××•×¨
		function extractNotes(text) {
			if (!text) return '';
			
			const textLower = text.toLowerCase();
			let notes = [];
			
			// ×”×¢×¨×•×ª ×¢×œ ×ª×©×œ×•×
			if (textLower.includes('×§×™×‘×œ×ª×™') && /\d+/.test(text)) {
				notes.push(text);
			}
			
			// ×”×¢×¨×•×ª ×¢×œ ×”××©×š ×¢×‘×•×“×”
			if (textLower.includes('×œ×—×–×•×¨') || textLower.includes('×œ×”××©×™×š') ||
				textLower.includes('× ×©××¨') || textLower.includes('×¦×¨×™×š')) {
				notes.push(text);
			}
			
			// ×‘×¢×™×•×ª ××• ×ª×§×œ×•×ª
			if (textLower.includes('×‘×¢×™×”') || textLower.includes('×ª×§×œ×”') ||
				textLower.includes('×œ× ×¢×•×‘×“') || textLower.includes('× ×©×‘×¨')) {
				notes.push(text);
			}
			
			// ×”×¢×¨×•×ª ×¢×œ ××–×’ ××•×•×™×¨ ××• ×ª× ××™×
			if (textLower.includes('×’×©×') || textLower.includes('×—×•×') ||
				textLower.includes('×¨×˜×•×‘') || textLower.includes('×™×‘×©')) {
				notes.push(text);
			}
			
			return notes.join(' | ');
		}
		
	

		// ××™×©×•×¨ ×™×™×‘×•× ×”×‘×™×§×•×¨×™× ××˜×œ×’×¨× - ×’×™×¨×¡×” ××¢×•×“×›× ×ª
		async function confirmTelegramImport() {
			if (!window.pendingTelegramVisits || window.pendingTelegramVisits.length === 0) {
				showToast('××™×Ÿ ×‘×™×§×•×¨×™× ×œ×™×™×‘×•×', 'warning');
				return;
			}
			
			try {
				showLoading('××™×™×‘× ×‘×™×§×•×¨×™× ××˜×œ×’×¨×...');
				
				// ×©×œ×‘ 1: ×©××•×¨ ×œ×˜×‘×œ×ª TelegramVisits (×–×× ×™)
				const telegramVisitsWithIds = window.pendingTelegramVisits.map(visit => ({
					...visit,
					ID: generateID()
				}));
				
				await saveTelegramVisitsToCloud(telegramVisitsWithIds);
				
				// ×©×œ×‘ 2: ×”××¨ ×œ×‘×™×§×•×¨×™× ×¨×’×™×œ×™× ×‘××¢×¨×›×ª
				let importedCount = 0;
				
				for (const telegramVisit of telegramVisitsWithIds) {
					// ××¦× ××• ×¦×•×¨ ×œ×§×•×—
					let locationId = null;
					const existingLocation = locations.find(loc => 
						loc.name.toLowerCase() === telegramVisit.client_name.toLowerCase()
					);
					
					if (existingLocation) {
						locationId = existingLocation.ID;
					} else {
						// ×¦×•×¨ ×œ×§×•×— ×—×“×© ×× ×œ× ×§×™×™×
						locationId = generateID();
						const newLocation = {
							ID: locationId,
							name: telegramVisit.client_name,
							full_address: '',
							neighborhood: '',
							city: '',
							contact_person: '',
							phone: '',
							allowed_day: '×™×•× ×¨××©×•×Ÿ',
							interval_weeks: 4,
							temp_addition: false,
							base_amount: 0,
							active: true,
							notes: '× ×•×¦×¨ ××•×˜×•××˜×™×ª ××™×™×‘×•× ×˜×œ×’×¨×',
							last_visit: telegramVisit.date,
							next_visit: '',
							client_requests: ''
						};
						locations.push(newLocation);
					}
					
					// ×¦×•×¨ ×‘×™×§×•×¨ ×‘××¢×¨×›×ª ×”×¨××©×™×ª
					const visitData = {
						ID: generateID(),
						date: telegramVisit.date,
						location_id: telegramVisit.client_id,
						location_name: telegramVisit.client_name,
						visit_type: '×‘×™×•×Ÿ', // ×‘×¨×™×¨×ª ××—×“×œ
						work_done: telegramVisit.work_done,
						duration_minutes: telegramVisit.duration_minutes,
						num_workers: 1,
						start_time: telegramVisit.time || '',
						end_time: '',
						amount: 0, // ×™×—×•×©×‘ ×œ×¤×™ ×–××Ÿ ×•×ª×¢×¨×™×£
						expense: 0,
						notes: `×™×•×‘× ××˜×œ×’×¨×: ${telegramVisit.raw_text}`
					};
					
					visits.push(visitData);
					importedCount++;
				}
				
				// ×©××•×¨ ×”×›×œ
				saveToLocalStorage();
				
				// ×¢×“×›×Ÿ ×ª×¦×•×’×•×ª
				loadLocationsTable();
				loadReceiptsTable();
				loadFilterOptions();
				
				// ×©××•×¨ ×œ×¢×œ× ×Ÿ
				await saveAllToSheetsOptimized();
				
				hideLoading();
				closeModal();
				
				showToast(`ğŸ‰ ×™×™×‘×•× ×˜×œ×’×¨× ×”×•×©×œ×!
		ğŸ“± ${importedCount} ×‘×™×§×•×¨×™× ×™×•×‘××•
		ğŸ’¾ ×”×›×œ × ×©××¨ ×œ×¢×œ× ×Ÿ!`, 'success', 5000);
				
				// × ×§×” ××ª ×”× ×ª×•× ×™× ×”×–×× ×™×™×
				window.pendingTelegramVisits = null;
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×™×™×‘×•× ××˜×œ×’×¨×:', error);
				hideLoading();
				showToast('×©×’×™××” ×‘×™×™×‘×•× ××˜×œ×’×¨×', 'error');
			}
		}

		


		function showModal(content) {
			// ×”×¡×¨ ××•×“×œ ×§×™×™× ×× ×™×©
			const existingModal = document.getElementById('telegramModal');
			if (existingModal) {
				existingModal.remove();
			}
			
			// ×¦×•×¨ ××•×“×œ
			const modal = document.createElement('div');
			modal.id = 'telegramModal';
			modal.style.cssText = `
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.5);
				display: flex;
				justify-content: center;
				align-items: center;
				z-index: 1000;
			`;
			
			modal.innerHTML = content;
			document.body.appendChild(modal);
			
			// ×¡×’×™×¨×” ×‘×œ×—×™×¦×” ×¢×œ ×”×¨×§×¢
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					closeModal();
				}
			});
		}

		function closeModal() {
			const modal = document.getElementById('telegramModal');
			if (modal) {
				modal.remove();
			}
		}
	   
	    function generateID() {
			return Date.now() + Math.random().toString(36).substr(2, 9);
		}
	   
	   
	   async function saveAllToSheetsOptimized() {
			if (!await validateToken()) {
				showToast('×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×©××™×¨×” ××§×•××™×ª ×‘×œ×‘×“', 'warning');
				return;
			}
			
			try {
				showLoading('×©×•××¨ × ×ª×•× ×™× ×œ×¢× ×Ÿ (××¦×‘ ××”×™×¨)...');
				
				// ×©××™×¨×” ××¦×•×•×™×ª - ×›×œ ×”××™×§×•××™× ×‘×‘×ª ××—×ª
				if (locations.length > 0) {
					showToast(`×©×•××¨ ${locations.length} ××™×§×•××™× ×‘×‘×ª ××—×ª...`, 'info', 2000);
					
					const locationValues = locations.map(loc => [
						loc.ID, loc.name, loc.full_address, loc.neighborhood, loc.city,
						loc.contact_person, loc.phone, loc.allowed_day, loc.interval_weeks,
						loc.temporary_addition, loc.base_amount, loc.active, loc.notes,
						loc.last_visit, loc.next_visit
					]);
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Locations!A2:O${locationValues.length + 1}`,
						valueInputOption: 'USER_ENTERED',
						resource: { values: locationValues }
					});
				}
				
				// ×©××™×¨×” ××¦×•×•×™×ª - ×›×œ ×”×‘×™×§×•×¨×™× ×‘×‘×ª ××—×ª
				if (visits.length > 0) {
					showToast(`×©×•××¨ ${visits.length} ×‘×™×§×•×¨×™× ×‘×‘×ª ××—×ª...`, 'info', 2000);
					
					const visitValues = visits.map(visit => [
						visit.ID, visit.date, visit.location_id, visit.location_name, visit.visit_type,
						visit.work_done, visit.duration_minutes, visit.num_workers || 1,
						visit.start_time, visit.end_time, visit.amount, visit.expense || 0,
						visit.notes
					]);

					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Visits!A2:M${visitValues.length + 1}`, // ×—×–×¨× ×• ×œ-M ×›×™ ×”×¡×¨× ×• ×¢××•×“×”
						valueInputOption: 'USER_ENTERED',
						resource: { values: visitValues }
					});
				}
				
				// ×©××™×¨×” ××¦×•×•×™×ª - ×›×œ ×”×§×‘×œ×•×ª ×‘×‘×ª ××—×ª
				if (receipts.length > 0) {
					showToast(`×©×•××¨ ${receipts.length} ×§×‘×œ×•×ª ×‘×‘×ª ××—×ª...`, 'info', 2000);
					
					const receiptValues = receipts.map(receipt => [
						receipt.ID, receipt.book_number, receipt.receipt_number, receipt.date,
						receipt.location_id, receipt.location_name, receipt.amount,
						receipt.payment_type, receipt.notes
					]);
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Receipts!A2:I${receiptValues.length + 1}`,
						valueInputOption: 'USER_ENTERED',
						resource: { values: receiptValues }
					});
				}
				
				showToast(`ğŸš€ ×©××™×¨×” ××”×™×¨×” ×”×•×©×œ××”!
		âœ… ${locations.length + visits.length + receipts.length} ×¨×©×•××•×ª × ×©××¨×•
		âš¡ ×–××Ÿ ×—×™×¡×›×•×Ÿ: ~90%`, 'success', 5000);
				
			} catch (error) {
				console.error('Error in optimized save:', error);
				showToast('×©×’×™××” ×‘×©××™×¨×” ××”×™×¨×” - ×—×•×–×¨ ×œ×©×™×˜×” ×¨×’×™×œ×”', 'warning');
				
				// ×× × ×›×©×œ, ×—×–×•×¨ ×œ×©×™×˜×” ×”×¨×’×™×œ×”
				await saveAllToSheets();
			} finally {
				hideLoading();
			}
		}
	   
	   // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×—×•×‘×•×ª
		function displayDebts() {
			//// console.log('×“×•×’×××•×ª ×¢×¨×›×™ paid:', visits.slice(0, 5).map(v => v.paid));
			const sortBy = document.getElementById('debtSortBy').value;
			const minAmount = parseFloat(document.getElementById('minDebtAmount').value) || 0;
			
			// ×—×™×©×•×‘ ×—×•×‘×•×ª ×œ×›×œ ×œ×§×•×—
			const debtsByLocation = {};
			
			visits.forEach(visit => {
				if (visit.amount > 0) {
					const visitAmount = parseFloat(visit.amount);
					const paidAmount = getVisitPaidAmount(visit.ID);
					const debt = visitAmount - paidAmount;
					
					if (debt > 0) { // ×™×© ×—×•×‘
						if (!debtsByLocation[visit.location_id]) {
							const location = locations.find(loc => loc.ID == visit.location_id);
							debtsByLocation[visit.location_id] = {
								location: location,
								visits: [],
								totalDebt: 0
							};
						}
						debtsByLocation[visit.location_id].visits.push({
							...visit,
							debt: debt,
							paidAmount: paidAmount
						});
						debtsByLocation[visit.location_id].totalDebt += debt;
					}
				}
			});
			
			// ×”××¨×” ×œ××¢×¨×š ×•×¡×™× ×•×Ÿ
			let debtsArray = Object.values(debtsByLocation)
				.filter(debt => debt.totalDebt >= minAmount);
			
			// ××™×•×Ÿ
			debtsArray.sort((a, b) => {
				switch(sortBy) {
					case 'amount_desc':
						return b.totalDebt - a.totalDebt;
					case 'amount_asc':
						return a.totalDebt - b.totalDebt;
					case 'date_old':
						return new Date(a.visits[0].date) - new Date(b.visits[0].date);
					case 'date_new':
						return new Date(b.visits[0].date) - new Date(a.visits[0].date);
					case 'location':
						return a.location?.name.localeCompare(b.location?.name);
					default:
						return b.totalDebt - a.totalDebt;
				}
			});
			
			// ×”×¦×’×” ×‘×˜×‘×œ×”
			const tbody = document.getElementById('debtsTableBody');
			tbody.innerHTML = '';
			
			debtsArray.forEach(debt => {
				const location = debt.location || { name: '×œ× × ××¦×', full_address: '', phone: '' };
				const lastVisit = debt.visits[debt.visits.length - 1];
				const daysSinceLastVisit = Math.floor((new Date() - new Date(lastVisit.date)) / (1000 * 60 * 60 * 24));
				
				const row = document.createElement('tr');
				
				// ×”×“×’×©×ª ×—×•×‘×•×ª ×™×©× ×™×
				if (daysSinceLastVisit > 60) {
					row.style.backgroundColor = '#ffebee'; // ××“×•× ×¢×“×™×Ÿ
				} else if (daysSinceLastVisit > 30) {
					row.style.backgroundColor = '#fff3e0'; // ×›×ª×•× ×¢×“×™×Ÿ  
				}
				
				row.innerHTML = `
					<td>
						<strong>${location.name}</strong>
						<br><small style="color: #666;">${location.contact_person || ''}</small>
					</td>
					<td><small>${location.full_address || ''}</small></td>
					<td>
						${location.phone ? 
							`<a href="tel:${location.phone}" style="color: #007bff; text-decoration: none;">
								ğŸ“ ${location.phone}
							</a>` : 
							'<span style="color: #999;">-</span>'
						}
					</td>
					<td style="text-align: center;">
						<span style="background: #e3f2fd; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
							${debt.visits.length}
						</span>
					</td>
					<td style="text-align: center;">
						<strong style="color: #e74c3c; font-size: 16px;">â‚ª${debt.totalDebt.toLocaleString()}</strong>
					</td>
					<td style="text-align: center;">${formatDate(lastVisit.date)}</td>
					<td style="text-align: center;">
						<span style="color: ${daysSinceLastVisit > 60 ? '#e74c3c' : daysSinceLastVisit > 30 ? '#f39c12' : '#666'}; font-weight: bold;">
							${daysSinceLastVisit}
						</span>
					</td>
					<td style="text-align: center;">
						<button class="action-btn" onclick="showDebtDetails('${location.ID}')" style="background: #007bff; margin: 2px;">
							ğŸ” ×¤×™×¨×•×˜
						</button>
						<button class="action-btn" onclick="markDebtAsPaid('${location.ID}')" style="background: #28a745; margin: 2px;">
							âœ… ×¡×•×œ×§
						</button>
					</td>
				`;
				
				tbody.appendChild(row);
			});
			
			// ×¢×“×›×•×Ÿ ×¡×™×›×•×
			updateDebtsSummary(debtsArray);
		}

		// ×¢×“×›×•×Ÿ ×›×¨×˜×™×¡×™ ×¡×™×›×•×
		function updateDebtsSummary(debtsArray) {
			const totalDebt = debtsArray.reduce((sum, debt) => sum + debt.totalDebt, 0);
			const debtorsCount = debtsArray.length;
			const averageDebt = debtorsCount > 0 ? totalDebt / debtorsCount : 0;
			
			// ××¦×™××ª ×”×—×•×‘ ×”×›×™ ×™×©×Ÿ
			let oldestDebtDays = 0;
			if (debtsArray.length > 0) {
				const oldestVisit = debtsArray
					.flatMap(debt => debt.visits)
					.reduce((oldest, visit) => 
						new Date(visit.date) < new Date(oldest.date) ? visit : oldest
					);
				oldestDebtDays = Math.floor((new Date() - new Date(oldestVisit.date)) / (1000 * 60 * 60 * 24));
			}
			
			document.getElementById('totalDebt').textContent = `â‚ª${totalDebt.toLocaleString()}`;
			document.getElementById('totalDebt').style.color = totalDebt > 0 ? '#e74c3c' : '#27ae60';
			
			document.getElementById('debtorsCount').textContent = debtorsCount;
			document.getElementById('averageDebt').textContent = `â‚ª${Math.round(averageDebt).toLocaleString()}`;
			document.getElementById('oldestDebt').textContent = oldestDebtDays > 0 ? `${oldestDebtDays} ×™××™×` : '-';
			
			if (oldestDebtDays > 90) {
				document.getElementById('oldestDebt').style.color = '#e74c3c';
			} else if (oldestDebtDays > 30) {
				document.getElementById('oldestDebt').style.color = '#f39c12';
			}
		}

		// ×”×¦×’×ª ×¤×™×¨×•×˜ ×—×•×‘ ×œ×œ×§×•×— ×‘××•×“×œ × ×•×—
		function showDebtDetails(locationId) {
			const location = locations.find(loc => loc.ID == locationId);
			const locationVisits = visits.filter(v => v.location_id == locationId && v.paid === '0');
			
			if (!location || locationVisits.length === 0) {
				showToast('×œ× × ××¦××• ×—×•×‘×•×ª ×œ×œ×§×•×— ×–×”', 'info');
				return;
			}
			
			// ××™×•×Ÿ ×‘×™×§×•×¨×™× ×œ×¤×™ ×ª××¨×™×š
			locationVisits.sort((a, b) => new Date(a.date) - new Date(b.date));
			
			const totalDebt = locationVisits.reduce((sum, v) => sum + parseFloat(v.amount), 0);
			
			// ×™×¦×™×¨×ª ×¨×©×™××ª ×”×‘×™×§×•×¨×™×
			let visitsHTML = '';
			locationVisits.forEach(visit => {
				const workDone = visit.work_done || '×œ× ×¦×•×™×Ÿ';
				const notes = visit.notes ? `<div style="color: #888; font-size: 12px; margin-top: 5px;">ğŸ’­ ${visit.notes}</div>` : '';
				
				visitsHTML += `
					<div style="border: 1px solid #e9ecef; border-radius: 6px; padding: 12px; margin-bottom: 10px;">
						<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
							<strong>ğŸ“… ${formatDate(visit.date)}</strong>
							<strong style="color: #e74c3c;">â‚ª${parseFloat(visit.amount).toLocaleString()}</strong>
						</div>
						<div style="color: #666; font-size: 14px;">
							ğŸ”§ ${workDone}
						</div>
						${notes}
					</div>
				`;
			});
			
			// ×ª×•×›×Ÿ ×”××•×“×œ
			const modalContent = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 90vw; max-height: 70vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ’° ×¤×™×¨×•×˜ ×—×•×‘×•×ª - ${location.name}</h3>
					
					<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
						<strong>×¡×”"×› ×—×•×‘: â‚ª${totalDebt.toLocaleString()}</strong><br>
						<span style="color: #666;">××¡×¤×¨ ×˜×™×¤×•×œ×™×: ${locationVisits.length}</span>
					</div>
					
					<div style="max-height: 300px; overflow-y: auto;">
						${visitsHTML}
					</div>
					
					<div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
						<button type="button" onclick="markDebtAsPaid(${locationId}); closeEditModal();" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
							âœ… ×¡××Ÿ ×›××¡×•×œ×§
						</button>
						<button type="button" onclick="closeEditModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
							âŒ ×¡×’×•×¨
						</button>
					</div>
				</div>
			`;
			
			showEditModal(modalContent);
		}  

		// ×¡×™××•×Ÿ ×—×•×‘ ×›××¡×•×œ×§
		function markDebtAsPaid(locationId) {
			const location = locations.find(loc => loc.ID == locationId);
			if (!location) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			const unpaidVisits = visits.filter(v => v.location_id == locationId && v.paid === '0');
			
			if (unpaidVisits.length === 0) {
				showToast('××™×Ÿ ×—×•×‘×•×ª ×¤×ª×•×—×™× ×œ×œ×§×•×— ×–×”', 'info');
				return;
			}
			
			const totalDebt = unpaidVisits.reduce((sum, v) => sum + parseFloat(v.amount), 0);
			
			if (confirm(`×œ×¡××Ÿ ××ª ×›×œ ×”×—×•×‘×•×ª ×©×œ ${location.name} ×›××¡×•×œ×§×™×?\n\n×¡×”"×›: â‚ª${totalDebt.toLocaleString()}\n××¡×¤×¨ ×˜×™×¤×•×œ×™×: ${unpaidVisits.length}`)) {
				// ×¢×“×›×•×Ÿ ×›×œ ×”×‘×™×§×•×¨×™× ×”×—×™×™×‘×™×
				unpaidVisits.forEach(visit => {
					visit.paid = '1';
				});
				
				// ×©××™×¨×” ××§×•××™×ª
				saveToLocalStorage();
				
				// ×©××™×¨×” ×‘×¢× ×Ÿ ×× ××—×•×‘×¨
				if (access_token && SPREADSHEET_ID) {
					saveAllToSheets().then(() => {
						console.log('âœ… ×—×•×‘×•×ª ×¢×•×“×›× ×• ×‘×¢× ×Ÿ');
					}).catch(error => {
						console.error('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¢× ×Ÿ:', error);
						showToast('×”×—×•×‘×•×ª ×¢×•×“×›× ×• ××§×•××™×ª, ××š ×œ× ×‘×¢× ×Ÿ', 'warning');
					});
				}
				
				// ×¨×¢× ×•×Ÿ ×”×ª×¦×•×’×”
				displayDebts();
				
				showToast(`×”×—×•×‘×•×ª ×©×œ ${location.name} ×¡×•×× ×• ×›××¡×•×œ×§×™×! (â‚ª${totalDebt.toLocaleString()})`, 'success');
			}
		}

	   
	    // ×”×ª×¨××” ×¢×œ ×—×•×‘×•×ª ×—××•×¨×™×
		function checkCriticalDebts() {
			const criticalDebts = visits.filter(visit => {
				if (visit.paid !== '0') return false;
				
				const daysSince = Math.floor((new Date() - new Date(visit.date)) / (1000 * 60 * 60 * 24));
				return daysSince > 90 || parseFloat(visit.amount) > 1000;
			});
			
			if (criticalDebts.length > 0) {
				const totalCritical = criticalDebts.reduce((sum, visit) => sum + parseFloat(visit.amount), 0);
				
				showToast(
					`âš ï¸ ×™×© ${criticalDebts.length} ×—×•×‘×•×ª ×“×—×•×¤×™× (â‚ª${totalCritical.toLocaleString()})`, 
					'warning', 
					8000
				);
			}
		}
	   
	   
	    // ×“×•×— ×”×›× ×¡×•×ª ×œ×—×•×“×© × ×•×›×—×™
		function generateMonthlyReport() {
			const currentMonth = new Date().getMonth();
			const currentYear = new Date().getFullYear();
			
			const monthlyVisits = visits.filter(visit => {
				const visitDate = new Date(visit.date);
				return visitDate.getMonth() === currentMonth && 
					   visitDate.getFullYear() === currentYear;
			});
			
			const totalRevenue = monthlyVisits.reduce((sum, visit) => 
				sum + parseFloat(visit.amount || 0), 0);
			
			const paidRevenue = monthlyVisits
				.filter(visit => visit.paid === '1')
				.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			const totalHours = monthlyVisits.reduce((sum, visit) => 
				sum + (visit.duration_minutes || 0) / 60, 0);
			
			const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™',
				'×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
			
			const report = {
				month: monthNames[currentMonth],
				year: currentYear,
				totalVisits: monthlyVisits.length,
				totalRevenue: totalRevenue,
				paidRevenue: paidRevenue,
				pendingRevenue: totalRevenue - paidRevenue,
				totalHours: totalHours.toFixed(1),
				avgPerVisit: monthlyVisits.length > 0 ? Math.round(totalRevenue / monthlyVisits.length) : 0
			};
			
			return report;
		}

		// ×”×¦×’×ª ×“×•×— ×‘××•×“×œ
		function showMonthlyReport() {
			const report = generateMonthlyReport();
			
			const reportHTML = `
				<div style="background: white; padding: 20px; border-radius: 10px; max-width: 500px;">
					<h3>ğŸ“Š ×“×•×— ${report.month} ${report.year}</h3>
					
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
						<div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #1976d2;">${report.totalVisits}</div>
							<div style="color: #666;">×‘×™×§×•×¨×™×</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #2e7d32;">â‚ª${report.totalRevenue.toLocaleString()}</div>
							<div style="color: #666;">×¡×”"×› ×”×›× ×¡×•×ª</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #f3e5f5; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #7b1fa2;">â‚ª${report.paidRevenue.toLocaleString()}</div>
							<div style="color: #666;">× ×’×‘×”</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #fff3e0; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #f57c00;">â‚ª${report.pendingRevenue.toLocaleString()}</div>
							<div style="color: #666;">×‘×”××ª× ×”</div>
						</div>
					</div>
					
					<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
						<div><strong>×©×¢×•×ª ×¢×‘×•×“×”:</strong> ${report.totalHours} ×©×¢×•×ª</div>
						<div><strong>×××•×¦×¢ ×œ×‘×™×§×•×¨:</strong> â‚ª${report.avgPerVisit}</div>
						<div><strong>×××•×¦×¢ ×œ×©×¢×”:</strong> â‚ª${Math.round(report.paidRevenue / parseFloat(report.totalHours) || 0)}</div>
					</div>
					
					<button onclick="closeModal()" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; width: 100%;">
						×¡×’×•×¨
					</button>
				</div>
			`;
			
			showModal(reportHTML);
		}
	   
	    function isDuplicateVisit(newVisit) {
			return visits.some(existing => 
				existing.location_id === newVisit.location_id &&
				existing.date === newVisit.date &&
				existing.work_done === newVisit.work_done &&
				existing.amount === newVisit.amount
			);
		}
	   
	    function isDuplicateReceipt(newReceipt) {
			return receipts.some(existing => 
				existing.receipt_number === newReceipt.receipt_number &&
				existing.booklet_number === newReceipt.booklet_number &&
				existing.date === newReceipt.date
			);
		}
		
		
		function removeDuplicates() {
			const uniqueVisits = [];
			const seen = new Set();
			
			visits.forEach(visit => {
				const key = `${visit.location_id}-${visit.date}-${visit.work_done}-${visit.amount}`;
				if (!seen.has(key)) {
					seen.add(key);
					uniqueVisits.push(visit);
				}
			});
			
			const removedCount = visits.length - uniqueVisits.length;
			visits = uniqueVisits;
			
			console.log(`Removed ${removedCount} duplicate visits`);
			return removedCount;
		}
	   
	   function validateVisitData(visitData) {
			const errors = [];
			
			if (!visitData.location_id) {
				errors.push('×—×¡×¨ ××–×”×” ×œ×§×•×—');
			}
			
			if (!visitData.date) {
				errors.push('×—×¡×¨ ×ª××¨×™×š');
			}
			
			if (!visitData.work_done || visitData.work_done.trim() === '') {
				errors.push('×—×¡×¨ ×ª×™××•×¨ ×¢×‘×•×“×”');
			}
			
			return errors;
		}

		function showValidationErrors(errors) {
			if (errors.length > 0) {
				alert('×‘×¢×™×•×ª ×‘×˜×•×¤×¡:\n' + errors.join('\n'));
				return true; // ×™×© ×©×’×™××•×ª
			}
			return false; // ××™×Ÿ ×©×’×™××•×ª
		}
	   
	   // ×©××™×¨×” ××§×‘×¦×™×ª ×©×œ ×œ×§×•×—×•×ª
		async function saveLocationsBatch(locationsArray) {
			if (!await validateToken() || locationsArray.length === 0) return false;
			
			try {
			
			    // ×§×¨× ××ª ×”× ×ª×•× ×™× ×”×§×™×™××™× ×§×•×“×
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:A'
				});
				
				const existingIDs = new Set(response.result.values?.slice(1).map(row => row[0]) || []);
				
				// ×¡× ×Ÿ ×¨×§ ×¨×©×•××•×ª ×—×“×©×•×ª
				const newLocations = locationsArray.filter(location => !existingIDs.has(location.ID));
				
				if (newLocations.length === 0) {
					console.log('××™×Ÿ ×œ×§×•×—×•×ª ×—×“×©×™× ×œ×©××™×¨×”');
					return true;
				}
			
				const values = newLocations.map(location => [
					location.ID,
					location.name,
					location.full_address,
					location.neighborhood,
					location.city,
					location.contact_person,
					location.phone,
					location.allowed_day,
					location.interval_weeks,
					location.temp_addition,
					location.base_amount,
					location.active,
					location.notes,
					formatDateForSheets(location.last_visit),
					formatDateForSheets(location.next_visit),
					location.client_requests || ''
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:P`, 
					valueInputOption: 'USER_ENTERED',
					resource: { 
						values: values,
						majorDimension: 'ROWS'
					}
				});
				
				console.log(`âœ… Saved ${newLocations.length} locations in batch - from ${locationsArray.length}`);
				return true;
			} catch (error) {
				console.error('Error in batch save locations:', error);
				return false;
			}
		}

		// ×©××™×¨×” ××§×‘×¦×™×ª ×©×œ ×‘×™×§×•×¨×™×
		async function saveVisitsBatch(visitsArray) {
			if (!await validateToken() || visitsArray.length === 0) return false;
			
			try {
				// ×§×¨× ××ª ×”× ×ª×•× ×™× ×”×§×™×™××™× ×§×•×“×
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Visits!A:A'
				});
				
				const existingIDs = new Set(response.result.values?.slice(1).map(row => row[0]) || []);
				
				// ×¡× ×Ÿ ×¨×§ ×¨×©×•××•×ª ×—×“×©×•×ª
				const newVisits = visitsArray.filter(visit => !existingIDs.has(visit.ID));
				
				if (newVisits.length === 0) {
					console.log('âœ… No new visits to save');
					return true;
				}
				
				const values = newVisits.map(visit => [
					visit.ID,
					formatDateForSheets(visit.date),
					visit.location_id,
					visit.location_name,
					visit.visit_type,
					visit.work_done,
					visit.duration_minutes,
					visit.start_time,
					visit.end_time,
					visit.amount,
					visit.expense,
					visit.paid,
					visit.notes
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:M`,
					valueInputOption: 'USER_ENTERED',
					resource: { 
						values: values,
						majorDimension: 'ROWS'
					}
				});
				
				console.log(`âœ… Saved ${newVisits.length} visits in batch - from ${visitsArray.length}`);
				return true;
			} catch (error) {
				console.error('Error in batch save visits:', error);
				return false;
			}
		}

		// ×©××™×¨×” ××§×‘×¦×™×ª ×©×œ ×§×‘×œ×•×ª
		async function saveReceiptsBatch(receiptsArray) {
			if (!await validateToken() || receiptsArray.length === 0) return false;
			
			try {
				// ×§×¨× ××ª ×”× ×ª×•× ×™× ×”×§×™×™××™× ×§×•×“×
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Receipts!A:A'
				});
				
				const existingIDs = new Set(response.result.values?.slice(1).map(row => row[0]) || []);
				
				// ×¡× ×Ÿ ×¨×§ ×¨×©×•××•×ª ×—×“×©×•×ª
				const newReceipts = receiptsArray.filter(receipt => !existingIDs.has(receipt.ID));
				
				if (newReceipts.length === 0) {
					console.log('âœ… No new receipts to save');
					return true;
				}
				
				const values = newReceipts.map(receipt => [
					receipt.ID,
					receipt.book_number,
					receipt.receipt_number,
					formatDateForSheets(receipt.date),
					receipt.location_id,
					receipt.location_name,
					receipt.amount,
					receipt.payment_type,
					receipt.notes
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:I`,
					valueInputOption: 'USER_ENTERED',
					resource: { 
						values: values,
						majorDimension: 'ROWS'
					}
				});
				
				console.log(`âœ… Saved ${newReceipts.length} receipts in batch - from ${receiptsArray.length}`);
				return true;
			} catch (error) {
				console.error('Error in batch save receipts:', error);
				return false;
			}
		}
	   
	   // ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ×•×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ××—×¨×•×Ÿ ×•×˜×™×¤×•×œ ×”×‘×
		// ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ×•×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ××—×¨×•×Ÿ ×•×˜×™×¤×•×œ ×”×‘× - ×’×¨×¡×” ××ª×§× ×ª
		async function calculateTreatmentDates() {
			console.log('ğŸ”„ ××—×©×‘ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ××—×¨×•×Ÿ ×•×˜×™×¤×•×œ ×”×‘×...');
			
			let updatedLocations = [];
			
			for (const location of locations) {
				// ××¦× ××ª ×›×œ ×”×˜×™×¤×•×œ×™× ×©×œ ×”×œ×§×•×— ×”×–×”
				const locationVisits = visits.filter(visit => visit.location_id === location.ID);
				
				if (locationVisits.length > 0) {
					// ××™×™×Ÿ ×œ×¤×™ ×ª××¨×™×š (×”×—×“×© ×‘×™×•×ª×¨ ×¨××©×•×Ÿ)
					locationVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
					
					// ×”×˜×™×¤×•×œ ×”××—×¨×•×Ÿ
					const lastVisit = locationVisits[0];
					const lastVisitDate = lastVisit.date;
					
					// ×—×™×©×•×‘ ×™×•× ××•×¢×“×£ ×œ×¤×™ ×”×‘×™×§×•×¨ ×”××—×¨×•×Ÿ
					if (!location.allowed_day || location.allowed_day === '') {
						const lastDate = new Date(lastVisitDate);
						const dayNames = ['×™×•× ×¨××©×•×Ÿ', '×™×•× ×©× ×™', '×™×•× ×©×œ×™×©×™', '×™×•× ×¨×‘×™×¢×™', '×™×•× ×—××™×©×™', '×™×•× ×©×™×©×™', '×™×•× ×©×‘×ª'];
						location.allowed_day = dayNames[lastDate.getDay()];
						console.log(`ğŸ“… ${location.name}: ×™×•× ××•×¢×“×£ ×—×•×©×‘ ×›-${location.allowed_day} (×œ×¤×™ ×‘×™×§×•×¨ ×-${lastVisitDate})`);
					}
					
					// ×—×™×©×•×‘ ×ª××¨×™×š ×”×˜×™×¤×•×œ ×”×‘×
					const lastDate = new Date(lastVisitDate);
					const intervalDays = (location.interval_weeks || 4) * 7; // ×‘×¨×™×¨×ª ××—×“×œ 4 ×©×‘×•×¢×•×ª
					const nextDate = new Date(lastDate);
					nextDate.setDate(lastDate.getDate() + intervalDays);
					
					// ×¤×•×¨××˜ ×”×ª××¨×™×š ×œ-YYYY-MM-DD
					const nextVisitDate = nextDate.toISOString().split('T')[0];
					
					// ×¢×“×›×•×Ÿ ×”××•×‘×™×™×§×˜ ×”××§×•××™
					location.last_visit = lastVisitDate;
					location.next_visit = nextVisitDate;
					
					updatedLocations.push(location);
					
					console.log(`ğŸ“… ${location.name}: ×˜×™×¤×•×œ ××—×¨×•×Ÿ ${lastVisitDate} â†’ ×˜×™×¤×•×œ ×”×‘× ${nextVisitDate}`);
				}
			}
			
			// ×¢×“×›×•×Ÿ ×‘×’×•×’×œ ×©×™×˜×¡ ×‘××§×‘×™×œ - ×§×¨×™××” ××—×ª ×‘×œ×‘×“ ×¢×‘×•×¨ ×›×œ ×”×œ×§×•×—×•×ª
			if (updatedLocations.length > 0) {
				console.log(`ğŸ”„ ××¢×“×›×Ÿ ${updatedLocations.length} ×œ×§×•×—×•×ª ×‘×’×•×’×œ ×©×™×˜×¡...`);
				await updateTreatmentDatesInSheets(updatedLocations);
				showToast(`ğŸ“… ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×¢×•×“×›× ×• ×¢×‘×•×¨ ${updatedLocations.length} ×œ×§×•×—×•×ª`, 'success', 2000);
			}
			
			// ×¨×¢× ×Ÿ × ×ª×•× ×™ ×ª×›× ×•×Ÿ
			refreshPlanningAfterTreatmentUpdate();
			
			return updatedLocations.length;
		}
	   
	   
	    // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×”×˜×™×¤×•×œ ×‘×’×•×’×œ ×©×™×˜×¡
		async function updateTreatmentDatesInSheets(locationsToUpdate) {
			if (!await validateToken() || locationsToUpdate.length === 0) return false;
			
			console.log(`ğŸ”„ ××¢×“×›×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×¢×‘×•×¨ ${locationsToUpdate.length} ×œ×§×•×—×•×ª ×‘×’×•×’×œ ×©×™×˜×¡...`);
			
			try {
				// ×§×¨× ××ª ×›×œ ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™× ××”×˜×‘×œ×”
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:P'
				});
				
				const allRows = response.result.values || [];
				const updatedRows = [...allRows];
				let updatedCount = 0;
				
				// ×¢×‘×•×¨ ×›×œ ×œ×§×•×— ×©×¦×¨×™×š ×¢×“×›×•×Ÿ
				for (const location of locationsToUpdate) {
					// ××¦× ××ª ×”×©×•×¨×” ×”××ª××™××” ×‘×˜×‘×œ×”
					for (let i = 1; i < allRows.length; i++) { // ××ª×—×™×œ ×-1 ×›×“×™ ×œ×“×œ×’ ×¢×œ ×”×›×•×ª×¨×•×ª
						if (allRows[i][0] === location.ID) {
							// ×¢×“×›×Ÿ ××ª ×¢××•×“×•×ª ×”×ª××¨×™×›×™× ×•×”×™×•× ×”××•×¢×“×£
							updatedRows[i][7] = location.allowed_day;   // allowed_day (×¢××•×“×” 7)
							updatedRows[i][13] = location.last_visit;   // last_visit
							updatedRows[i][14] = location.next_visit;   // next_visit
							updatedCount++;
							break;
						}
					}
				}
				
				// ×©××•×¨ ××ª ×›×œ ×”×˜×‘×œ×” ×”××¢×•×“×›× ×ª ×‘×§×¨×™××” ××—×ª ×‘×œ×‘×“
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:P',
					valueInputOption: 'USER_ENTERED',
					resource: {
						values: updatedRows
					}
				});
				
				console.log(`âœ… ×¢×•×“×›× ×• ${updatedCount} ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×‘×’×•×’×œ ×©×™×˜×¡`);
				return true;
			} catch (error) {
				console.error('Error updating treatment dates in sheets:', error);
				return false;
			}
		}
		
		// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×¢×‘×•×¨ ×œ×§×•×— ××—×“ ×œ××—×¨ ×”×•×¡×¤×ª ×‘×™×§×•×¨
		async function updateSingleLocationTreatmentDates(locationId) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) return;
			
			// ××¦× ××ª ×›×œ ×”×‘×™×§×•×¨×™× ×©×œ ×”×œ×§×•×— ×”×–×”
			const locationVisits = visits.filter(visit => visit.location_id === locationId);
			
			if (locationVisits.length > 0) {
				// ××™×™×Ÿ ×œ×¤×™ ×ª××¨×™×š (×”×—×“×© ×‘×™×•×ª×¨ ×¨××©×•×Ÿ)
				locationVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
				
				// ×”×˜×™×¤×•×œ ×”××—×¨×•×Ÿ
				const lastVisit = locationVisits[0];
				const lastVisitDate = lastVisit.date;
				
				// ×—×™×©×•×‘ ×ª××¨×™×š ×”×˜×™×¤×•×œ ×”×‘×
				const lastDate = new Date(lastVisitDate);
				const intervalDays = (location.interval_weeks || 4) * 7; // ×‘×¨×™×¨×ª ××—×“×œ 4 ×©×‘×•×¢×•×ª
				const nextDate = new Date(lastDate);
				nextDate.setDate(lastDate.getDate() + intervalDays);
				
				// ×¤×•×¨××˜ ×”×ª××¨×™×š ×œ-YYYY-MM-DD
				const nextVisitDate = nextDate.toISOString().split('T')[0];
				
				// ×¢×“×›×•×Ÿ ×”××•×‘×™×™×§×˜ ×”××§×•××™
				location.last_visit = lastVisitDate;
				location.next_visit = nextVisitDate;
				
				// ×¢×“×›×•×Ÿ ×‘×’×•×’×œ ×©×™×˜×¡
				await updateTreatmentDatesInSheets([location]);
				
				console.log(`ğŸ“… ×¢×•×“×›×Ÿ ×œ×§×•×— ${location.name}: ×˜×™×¤×•×œ ××—×¨×•×Ÿ ${lastVisitDate} â†’ ×˜×™×¤×•×œ ×”×‘× ${nextVisitDate}`);
				// ×¨×¢× ×Ÿ × ×ª×•× ×™ ×ª×›× ×•×Ÿ
				refreshPlanningAfterTreatmentUpdate();
			}
		}
	   
	   // ×¤×•× ×§×¦×™×” ×œ×—×™×“×•×© × ×ª×•× ×™ ×”×ª×›× ×•×Ÿ ×œ××—×¨ ×¢×“×›×•×Ÿ ×ª××¨×™×›×™×
		function refreshPlanningAfterTreatmentUpdate() {
			// ×¨×¢× ×Ÿ ××ª × ×ª×•× ×™ ×”×ª×›× ×•×Ÿ ×× ×”×˜××‘ ×¤×ª×•×—
			const currentSection = document.querySelector('.section.active');
			if (currentSection && currentSection.id === 'planning') {
				loadPlanningData();
			}
			
			// ×¨×¢× ×Ÿ ×’× ××ª ×¨×©×™××ª ×”×œ×§×•×—×•×ª ×‘×˜×•×¤×¡ ×”×‘×™×§×•×¨
			loadLocationsForSelect();
		}
	   
	   // ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ××¦×‘ × ×ª×•× ×™ ×”×ª×›× ×•×Ÿ - ×œ×“×™×‘×•×’
		function debugPlanningData() {
			console.log('=== Debug Planning Data ===');
			console.log(`×¡×”"×› ×œ×§×•×—×•×ª: ${locations.length}`);
			
			// ×‘×“×•×§ ××” ×™×© ×‘×©×“×” active
			console.log('×“×•×’×××•×ª ×©×œ ×©×“×” active:', locations.slice(0, 5).map(loc => ({ name: loc.name, active: loc.active, type: typeof loc.active })));

			const activeLocations = locations.filter(loc => loc.active === "×›×Ÿ" || loc.active === true || loc.active === "1");
			console.log(`×œ×§×•×—×•×ª ×¤×¢×™×œ×™×: ${activeLocations.length}`);
			
			const locationsWithDates = activeLocations.filter(loc => loc.next_visit && loc.next_visit.trim() !== '');
			console.log(`×œ×§×•×—×•×ª ×¢× ×ª××¨×™×›×™ ×˜×™×¤×•×œ: ${locationsWithDates.length}`);
			
			// ×”×¦×’ 5 ×œ×§×•×—×•×ª ×¨××©×•× ×™×
			locationsWithDates.slice(0, 5).forEach(loc => {
				console.log(`ğŸ‘¤ ${loc.name}: ××—×¨×•×Ÿ=${loc.last_visit}, ×”×‘×=${loc.next_visit}`);
			});
			
			const today = new Date();
			const todayStr = today.toISOString().split('T')[0];
			console.log(`×ª××¨×™×š ×”×™×•×: ${todayStr}`);
			
			const dueToday = locationsWithDates.filter(loc => {
				return new Date(loc.next_visit) <= today;
			});
			console.log(`×¦×¨×™×›×™× ×˜×™×¤×•×œ ×”×™×•×: ${dueToday.length}`);
			
			console.log('=== ×¡×™×•× Debug ===');
		}
	   
	   
		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×™×™×‘×•× ××”×™×¨ ×•×›×•×œ×œ ×©×œ ×›×œ ×”× ×ª×•× ×™×
		async function importFromHelperTableFast() {
			if (!await validateToken()) {
				showToast('×”×ª×—×‘×¨ ×œ×’×•×’×œ ×§×•×“×', 'warning');
				return;
			}
			
			const importTableId = localStorage.getItem('importTableId');
			if (!importTableId) {
				showToast('×œ× × ××¦× ID ×©×œ ×˜×‘×œ×ª ×”×¢×–×¨', 'warning');
				return;
			}
			
			console.log('ğŸš€ Starting FAST complete import from helper table...');
			
			try {
				showLoading('××™×™×‘× × ×ª×•× ×™× ××”×¨ ××˜×‘×œ×ª ×”×¢×–×¨...');
				
				// ××¢×§×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª
				const stats = {
					locations: { imported: 0, skipped: 0 },
					visits: { imported: 0, skipped: 0 },
					receipts: { imported: 0, skipped: 0 }
				};
				
				// ××¢×¨×›×™× ×œ× ×ª×•× ×™× ×—×“×©×™× ×‘×œ×‘×“
				const newLocations = [];
				const newVisits = [];
				const newReceipts = [];
				
				// ======== ×©×œ×‘ 1: ×§×¨×™××ª × ×ª×•× ×™× ×‘×¨×¦×£ (×›××• ×‘×¤×•× ×§×¦×™×•×ª ×©×¢×•×‘×“×•×ª) ========
				let locationsResponse, visitsResponse, receiptsResponse;
				
				try {
					console.log('ğŸ“Š Loading locations data...');
					locationsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Locations!A2:G1000'
					});
				} catch (error) {
					console.log('ğŸ“Š Locations sheet not found or empty');
					locationsResponse = { result: { values: [] } };
				}
				
				try {
					console.log('ğŸ”§ Loading visits data...');
					visitsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Visits!A2:M1000'
					});
				} catch (error) {
					console.log('ğŸ”§ Visits sheet not found or empty');
					visitsResponse = { result: { values: [] } };
				}
				
				try {
					console.log('ğŸ§¾ Loading receipts data...');
					receiptsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Receipts!A2:K1000'
					});
				} catch (error) {
					console.log('ğŸ§¾ Receipts sheet not found or empty');
					receiptsResponse = { result: { values: [] } };
				}
				
				console.log('ğŸ“Š Raw data loaded:', {
					locations: locationsResponse.result.values?.length || 0,
					visits: visitsResponse.result.values?.length || 0,
					receipts: receiptsResponse.result.values?.length || 0
				});
				
				// ======== ×©×œ×‘ 2: ×¢×™×‘×•×“ ×œ×§×•×—×•×ª ========
				if (locationsResponse.result.values?.length > 0) {
					showToast('××¢×‘×“ ×œ×§×•×—×•×ª...', 'info', 1500);
					
					for (const row of locationsResponse.result.values) {
						if (row.length > 0 && row[0]) { // ×™×© ×©× ×œ×§×•×—
							const customerName = row[0].trim();
							const street = row[1] || '';
							const houseNumber = row[2] || '';
							const city = row[3] || '';
							const fullAddress = `${street} ${houseNumber} ${city}`.trim();
							
							// ×‘×“×™×§×ª ×›×¤×™×œ×•×ª ×œ×¤×™ ×©× ×•/××• ×›×ª×•×‘×ª
							const isDuplicate = locations.some(existing =>
								existing.name.toLowerCase() === customerName.toLowerCase() ||
								(fullAddress && existing.full_address && 
								 existing.full_address.toLowerCase() === fullAddress.toLowerCase())
							);
							
							if (isDuplicate) {
								stats.locations.skipped++;
								console.log(`âš ï¸ Duplicate customer skipped: ${customerName}`);
								continue;
							}
							
							const locationData = {
								ID: generateID(),
								name: customerName,
								full_address: fullAddress || customerName, // â† ×ª×™×§×•×Ÿ: ×’× ×©× ×”×œ×§×•×— ×× ××™×Ÿ ×›×ª×•×‘×ª × ×¤×¨×“×ª
								neighborhood: '',
								city: city,
								contact_person: row[5] || '',
								phone: '',
								allowed_day: '',
								interval_weeks: parseInt(row[4]) || 4,
								temp_addition: 0,
								base_amount: parseFloat(row[6]) || 0,
								active: "1",
								notes: '',
								last_visit: '',
								next_visit: ''
							};
							
							locations.push(locationData);
							newLocations.push(locationData);
							stats.locations.imported++;
						}
					}
				}
				
				// ======== ×©×œ×‘ 3: ×¢×™×‘×•×“ ×‘×™×§×•×¨×™× ========
				if (visitsResponse.result.values?.length > 0) {
					showToast('××¢×‘×“ ×‘×™×§×•×¨×™×...', 'info', 1500);
					
					let notFoundCustomers = [];
					
					for (const row of visitsResponse.result.values) {
						if (row.length > 3 && row[3]) { // ×™×© ×œ×§×•×— ×‘×¢××•×“×” 3
							const customerName = row[3].trim();
							
							// ××¦× ×œ×§×•×— ×§×™×™×
							const existingCustomer = locations.find(loc =>
								loc.name && loc.name.toLowerCase() === customerName.toLowerCase()
							);
							
							if (!existingCustomer) {
								if (!notFoundCustomers.includes(customerName)) {
									notFoundCustomers.push(customerName);
								}
								stats.visits.skipped++;
								continue;
							}
							
							// ×‘× ×™×™×ª ×ª××¨×™×š ×-3 ×¢××•×“×•×ª: year, month, day
							const year = row[0];
							const month = String(row[1]).padStart(2, '0');
							const day = String(row[2]).padStart(2, '0');
							const visitDate = `${year}-${month}-${day}`;
							
							const workDone = row[7] || '';
							const amount = parseFloat(row[9]) || 0;
							
							// ×‘×“×™×§×ª ×›×¤×™×œ×•×ª ×‘×™×§×•×¨
							const isDuplicateVisit = visits.some(existing =>
								existing.location_id === existingCustomer.ID &&
								existing.date === visitDate &&
								existing.work_done === workDone &&
								Math.abs(existing.amount - amount) < 0.01
							);
							
							if (isDuplicateVisit) {
								stats.visits.skipped++;
								console.log(`âš ï¸ Duplicate visit skipped: ${customerName} on ${visitDate}`);
								continue;
							}
							
							const visitData = {
								ID: generateID(),
								date: visitDate,
								location_id: existingCustomer.ID,
								location_name: customerName, // â† ×”×•×¡×¤× ×• ××ª ×”×©×!
								visit_type: row[5] || 'regular',
								work_done: workDone,
								duration_minutes: (parseFloat(row[8]) || 0) * 60,
								num_workers: 1,
								start_time: '',
								end_time: '',
								amount: amount,
								expense: parseFloat(row[11]) || 0,
								paid: mapPaymentStatus(row[10]),
								notes: row[12] || ''
							};
							
							visits.push(visitData);
							newVisits.push(visitData);
							//** ×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×œ××—×¨ ×”×•×¡×¤×ª ×‘×™×§×•×¨ ×—×“×©
							//** await updateSingleLocationTreatmentDates(visitData.location_id);
							stats.visits.imported++;
						}
					}
					
					if (notFoundCustomers.length > 0) {
						console.log(`âš ï¸ ${notFoundCustomers.length} customers not found for visits:`, notFoundCustomers.slice(0, 5));
					}
				}
				
				// ======== ×©×œ×‘ 4: ×¢×™×‘×•×“ ×§×‘×œ×•×ª ========
				if (receiptsResponse.result.values?.length > 0) {
					showToast('××¢×‘×“ ×§×‘×œ×•×ª...', 'info', 1500);
					
					let notFoundAddresses = [];
					
					for (const row of receiptsResponse.result.values) {
						if (row.length > 6 && row[6]) { // ×™×© ×›×ª×•×‘×ª ×‘×¢××•×“×” 6
							const customerAddress = row[6].trim();
							
							// ××¦× ×œ×§×•×— ×œ×¤×™ ×›×ª×•×‘×ª - ×’× ×‘×©× ×•×’× ×‘×›×ª×•×‘×ª ××œ××”
							const existingCustomer = locations.find(loc =>
								(loc.name && loc.name.toLowerCase().includes(customerAddress.toLowerCase())) ||
								(loc.full_address && loc.full_address.toLowerCase().includes(customerAddress.toLowerCase()))
							);
							
							if (!existingCustomer) {
								if (!notFoundAddresses.includes(customerAddress)) {
									notFoundAddresses.push(customerAddress);
								}
								stats.receipts.skipped++;
								continue;
							}
							
							// ×‘× ×™×™×ª ×ª××¨×™×š
							const year = row[3];
							const month = String(row[4]).padStart(2, '0');
							const day = String(row[5]).padStart(2, '0');
							const receiptDate = `${year}-${month}-${day}`;
							
							const bookNumber = row[1] || '';
							const receiptNumber = row[2] || '';
							
							// ×‘×“×™×§×ª ×›×¤×™×œ×•×ª ×§×‘×œ×”
							const isDuplicateReceipt = receipts.some(existing =>
								existing.book_number === bookNumber &&
								existing.receipt_number === receiptNumber &&
								existing.date === receiptDate
							);
							
							if (isDuplicateReceipt) {
								stats.receipts.skipped++;
								console.log(`âš ï¸ Duplicate receipt skipped: ${bookNumber}/${receiptNumber}`);
								continue;
							}
							
							const receiptData = {
								ID: generateID(),
								book_number: bookNumber,
								receipt_number: receiptNumber,
								date: receiptDate,
								location_id: existingCustomer.ID,
								location_name: customerAddress,
								amount: parseFloat(row[7]) || 0,
								payment_type: row[8] || '',
								notes: `${row[9] || ''} ${row[10] || ''}`.trim()
							};
							
							receipts.push(receiptData);
							newReceipts.push(receiptData);
							stats.receipts.imported++;
						}
					}
					
					if (notFoundAddresses.length > 0) {
						console.log(`âš ï¸ ${notFoundAddresses.length} addresses not found for receipts:`, notFoundAddresses.slice(0, 5));
					}
				}
				
				// ======== ×©×œ×‘ 5: ×©××™×¨×” ××§×‘×¦×™×ª ×œ×¢× ×Ÿ ========
				showToast('×©×•××¨ × ×ª×•× ×™× ×—×“×©×™× ×œ×¢× ×Ÿ...', 'info');
				
				const savePromises = [];
				
				if (newLocations.length > 0) {
					savePromises.push(saveLocationsBatchNew(newLocations));
				}
				if (newVisits.length > 0) {
					savePromises.push(saveVisitsBatchNew(newVisits));
				}
				if (newReceipts.length > 0) {
					savePromises.push(saveReceiptsBatchNew(newReceipts));
				}
				
				const saveResults = await Promise.all(savePromises);
				const allSaved = saveResults.every(result => result === true);
				
				// ======== ×©×œ×‘ 6: ×¢×“×›×•×Ÿ ×××©×§ ========
				saveToLocalStorage();
				loadLocationsTable();
				loadReceiptsTable();
				loadLocationsForSelect();
				loadFilterOptions();
				
				hideLoading();
				
				// ======== ×“×™×•×•×— ×¡×•×¤×™ ========
				console.log('ğŸ“Š Import completed:', stats);
				
				const totalImported = stats.locations.imported + stats.visits.imported + stats.receipts.imported;
				const totalSkipped = stats.locations.skipped + stats.visits.skipped + stats.receipts.skipped;
				
				// ×—×™×©×•×‘ ×•×¢×“×›×•×Ÿ ×ª××¨×™×›×™ ×˜×™×¤×•×œ (×”×•×¡×¤×” ×—×“×©×”)
				if (stats.visits.imported > 0) {
					showToast('××—×©×‘ ×ª××¨×™×›×™ ×˜×™×¤×•×œ...', 'info', 2000);
					const updatedCount = await calculateTreatmentDates();
					if (updatedCount > 0) {
						showToast(`âœ… ×¢×•×“×›× ×• ×ª××¨×™×›×™ ×˜×™×¤×•×œ ×¢×‘×•×¨ ${updatedCount} ×œ×§×•×—×•×ª`, 'success', 3000);
					}
				}
				
				if (totalImported > 0) {
					const message = `ğŸ‰ ×™×™×‘×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”!
					
		âœ… ×™×•×‘××•: ${stats.locations.imported} ×œ×§×•×—×•×ª, ${stats.visits.imported} ×‘×™×§×•×¨×™×, ${stats.receipts.imported} ×§×‘×œ×•×ª
		${totalSkipped > 0 ? `âš ï¸ ×“×•×œ×’×• (×›×¤×™×œ×•×™×•×ª): ${totalSkipped} ×¨×©×•××•×ª` : ''}
		${allSaved ? 'â˜ï¸ × ×©××¨ ×œ×¢× ×Ÿ ×‘×”×¦×œ×—×”' : 'âš ï¸ ×—×œ×§ ××”× ×ª×•× ×™× ×œ× × ×©××¨×• ×œ×¢× ×Ÿ'}`;
					
					showToast(message, 'success', 8000);
				} else {
					showToast('×œ× × ××¦××• × ×ª×•× ×™× ×—×“×©×™× ×œ×™×™×‘×•×', 'info');
				}
				
			} catch (error) {
				console.error('Error in fast import:', error);
				hideLoading();
				showToast('×©×’×™××” ×‘×™×™×‘×•× ××”×™×¨', 'error');
			}
		}

		// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×—×“×©×•×ª ×•××¢×•×“×›× ×•×ª ×œ×©××™×¨×” ××§×‘×¦×™×ª
		async function saveLocationsBatchNew(locationsArray) {
			if (!locationsArray.length) return true;
			
			try {
				const values = locationsArray.map(loc => [
					loc.ID, loc.name, loc.full_address, loc.neighborhood, loc.city,
					loc.contact_person, loc.phone, loc.allowed_day, loc.interval_weeks,
					loc.temp_addition, loc.base_amount, loc.active, loc.notes,
					loc.last_visit, loc.next_visit
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A2:O2',
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`âœ… Saved ${locationsArray.length} locations to cloud`);
				return true;
			} catch (error) {
				console.error('Error saving locations batch:', error);
				return false;
			}
		}

		async function saveVisitsBatchNew(visitsArray) {
			if (!visitsArray.length) return true;
			
			try {
				const values = visitsArray.map(visit => [
					visit.ID, visit.date, visit.location_id, visit.location_name, visit.visit_type, visit.work_done,
					visit.duration_minutes, visit.num_workers, visit.start_time, visit.end_time,
					visit.amount, visit.expense, visit.notes
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Visits!A2:M2', // â† ×—×–×¨× ×• ×œ-M ×›×™ ×”×¡×¨× ×• paid
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`âœ… Saved ${visitsArray.length} visits to cloud`);
				return true;
			} catch (error) {
				console.error('Error saving visits batch:', error);
				return false;
			}
		}

		async function saveReceiptsBatchNew(receiptsArray) {
			if (!receiptsArray.length) return true;
			
			try {
				const values = receiptsArray.map(receipt => [
					receipt.ID, receipt.book_number, receipt.receipt_number, receipt.date,
					receipt.location_id, receipt.location_name, receipt.amount,
					receipt.payment_type, receipt.notes
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Receipts!A2:I2',
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`âœ… Saved ${receiptsArray.length} receipts to cloud`);
				return true;
			} catch (error) {
				console.error('Error saving receipts batch:', error);
				return false;
			}
		}

	   
	   ////////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	   
	   // ×”×—×œ×£ ××ª validateToken ×‘×¤×•× ×§×¦×™×” ×–×•:
		async function validateToken() {
			if (!access_token || !gapi.client) {
				updateCloudStatus('ğŸ” ×œ× ××—×•×‘×¨ ×œ×¢× ×Ÿ', '× ×•×ª×§');
				return false;
			}
			
			try {
				// ×‘×“×™×§×” ×¤×©×•×˜×” - × ×¡×” ×œ×§×¨×•× ××”×˜×‘×œ×”
				await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID || 'test'
				});
				return true;
			} catch (error) {
				if (error.status === 401) {
					console.log('Google token expired');
					access_token = null;
					updateCloudStatus('ğŸ” × ×“×¨×© ×—×™×‘×•×¨ ××—×“×©', '× ×•×ª×§');
					document.getElementById('statusText').classList.remove('connected');
					document.getElementById('saveBtn').disabled = true;
					document.getElementById('loadBtn').disabled = true;
					showToast('âš ï¸ ×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×”×ª×—×‘×¨ ××—×“×©', 'warning');
					return false;
				}
				updateCloudStatus('âš ï¸ ×‘×¢×™×™×ª ×—×™×‘×•×¨ ×œ×¢× ×Ÿ', '×©×’×™××”');
				return false;
			}
		}

		// ×”×—×œ×£ ××ª saveEditedLocation ×‘×¤×•× ×§×¦×™×” ×–×•:
		function saveEditedLocation(locationId) {
			console.log(`âœ… saveEditedLocation ('${locationId}')`);
			const locationIndex = locations.findIndex(g => g.ID == locationId);
			if (locationIndex === -1) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			try {
				// ×¢×“×›×Ÿ ××ª ×”×œ×§×•×— ×‘××¢×¨×š ×”××§×•××™
				const updatedLocation = {
					...locations[locationIndex], // ×©××•×¨ × ×ª×•× ×™× ×§×™×™××™×
					name: document.getElementById('editLocationName').value,
					full_address: document.getElementById('editLocationAddress').value,
					neighborhood: document.getElementById('editLocationNeighborhood').value,
					city: document.getElementById('editLocationCity').value,
					contact_person: document.getElementById('editLocationContact').value,
					phone: document.getElementById('editLocationPhone').value,
					allowed_day: document.getElementById('editLocationDay').value,
					interval_weeks: parseInt(document.getElementById('editLocationInterval').value) || 4,
					base_amount: parseFloat(document.getElementById('editLocationAmount').value) || 0,
					active: document.getElementById('editLocationActive').value,
					next_visit: document.getElementById('editLocationNextVisit').value,
					client_requests: document.getElementById('editLocationClientRequests').value,
					notes: document.getElementById('editLocationNotes').value
				};
				
				locations[locationIndex] = updatedLocation;
				
				// ×©××•×¨ ××§×•××™×ª ×ª××™×“
				saveToLocalStorage();
				updateCloudStatus('ğŸ’¾ ×©×•××¨...', '××¢×“×›×Ÿ');
				
				// × ×¡×” ×œ×©××•×¨ ×‘×¢× ×Ÿ
				if (access_token && SPREADSHEET_ID) {
					console.log('ğŸ” About to call updateLocationInCloud with:', updatedLocation.client_requests);
					// ×¢×“×›×•×Ÿ ×‘×¢× ×Ÿ (×œ× ×”×•×¡×¤×” ×—×“×©×”)
					updateLocationInCloud(updatedLocation).then(() => {
						updateCloudStatus('âœ… ××—×•×‘×¨ ×•××¡×•× ×›×¨×Ÿ', '× ×©××¨');
						showToast('×œ×§×•×— ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×” ×‘××¢×¨×›×ª ×•×‘×¢× ×Ÿ!', 'success');
					}).catch(error => {
						console.error('âŒ updateLocationInCloud failed:', error);
						if (error.status === 401) {
							updateCloudStatus('ğŸ” × ×“×¨×© ×—×™×‘×•×¨ ××—×“×©', '× ×•×ª×§');
							showToast('âš ï¸ ×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×”×œ×§×•×— × ×©××¨ ××§×•××™×ª ×‘×œ×‘×“', 'warning');
							access_token = null;
							document.getElementById('saveBtn').disabled = true;
							document.getElementById('loadBtn').disabled = true;
						} else {
							updateCloudStatus('âš ï¸ ×©×’×™××” ×‘×©××™×¨×”', '×©×’×™××”');
							showToast('âš ï¸ ×”×œ×§×•×— × ×©××¨ ××§×•××™×ª, ××‘×œ ×œ× ×”×¦×œ×™×— ×œ×©××•×¨ ×‘×¢× ×Ÿ', 'warning');
						}
					});
				} else {
					updateCloudStatus('ğŸ” ×©×™× ×•×™×™× ×œ× × ×©××¨×• ×‘×¢× ×Ÿ', '××§×•××™');
					showToast('ğŸ” ×œ×§×•×— × ×©××¨ ××§×•××™×ª - ×”×ª×—×‘×¨ ×œ×¢× ×Ÿ ×œ×©××™×¨×” ××œ××”', 'warning');
				}
				
				// ×¢×“×›×Ÿ ×ª×¦×•×’×”
				loadLocationsTable();
				loadLocationsForSelect();
				closeEditModal();
				
			} catch (error) {
				console.error('Error updating location:', error);
				updateCloudStatus('âŒ ×©×’×™××” ×‘××¢×¨×›×ª', '×©×’×™××”');
				showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×œ×§×•×—', 'error');
			}
		}


		// ×”×—×œ×£ ××ª saveEditedReceipt ×‘×¤×•× ×§×¦×™×” ×–×•:
		function saveEditedReceipt(receiptId) {
			console.log(`âœ… saveEditedReceipt ('${receiptId}')`);
			const receiptIndex = receipts.findIndex(r => r.ID == receiptId);
			if (receiptIndex === -1) {
				showToast('×§×‘×œ×” ×œ× × ××¦××”', 'error');
				return;
			}
			
			try {
				const locationId = document.getElementById('editReceiptLocation').value;
				const location = locations.find(g => g.ID == locationId);
				
				// ×¢×“×›×Ÿ ××ª ×”×§×‘×œ×” ×‘××¢×¨×š ×”××§×•××™
				const updatedReceipt = {
					...receipts[receiptIndex], // ×©××•×¨ × ×ª×•× ×™× ×§×™×™××™×
					book_number: document.getElementById('editReceiptBook').value,
					receipt_number: document.getElementById('editReceiptNumber').value,
					date: document.getElementById('editReceiptDate').value,
					location_id: locationId,
					location_name: location ? location.name : '',
					amount: parseFloat(document.getElementById('editReceiptAmount').value) || 0,
					payment_type: document.getElementById('editReceiptPaymentType').value,
					notes: document.getElementById('editReceiptNotes').value
				};
				
				receipts[receiptIndex] = updatedReceipt;
				
				// ×©××•×¨ ××§×•××™×ª ×ª××™×“
				saveToLocalStorage();
				updateCloudStatus('ğŸ’¾ ×©×•××¨ ×§×‘×œ×”...', '××¢×“×›×Ÿ');
				
				// × ×¡×” ×œ×©××•×¨ ×‘×¢× ×Ÿ
				if (access_token && SPREADSHEET_ID) {
					updateReceiptInCloud(updatedReceipt).then(() => {
						updateCloudStatus('âœ… ××—×•×‘×¨ ×•××¡×•× ×›×¨×Ÿ', '× ×©××¨');
						showToast('×§×‘×œ×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×” ×‘××¢×¨×›×ª ×•×‘×¢× ×Ÿ!', 'success');
					}).catch(error => {
						if (error.status === 401) {
							updateCloudStatus('ğŸ” × ×“×¨×© ×—×™×‘×•×¨ ××—×“×©', '× ×•×ª×§');
							showToast('âš ï¸ ×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×”×§×‘×œ×” × ×©××¨×” ××§×•××™×ª ×‘×œ×‘×“', 'warning');
							access_token = null;
						} else {
							updateCloudStatus('âš ï¸ ×©×’×™××” ×‘×©××™×¨×”', '×©×’×™××”');
							showToast('âš ï¸ ×”×§×‘×œ×” × ×©××¨×” ××§×•××™×ª, ××‘×œ ×œ× ×”×¦×œ×™×—×” ×œ×©××•×¨ ×‘×¢× ×Ÿ', 'warning');
						}
					});
				} else {
					updateCloudStatus('ğŸ” ×©×™× ×•×™×™× ×œ× × ×©××¨×• ×‘×¢× ×Ÿ', '××§×•××™');
					showToast('ğŸ” ×§×‘×œ×” × ×©××¨×” ××§×•××™×ª - ×”×ª×—×‘×¨ ×œ×¢× ×Ÿ ×œ×©××™×¨×” ××œ××”', 'warning');
				}
				
				// ×¢×“×›×Ÿ ×ª×¦×•×’×”
				loadReceiptsTable();
				closeEditModal();
				
			} catch (error) {
				console.error('Error updating receipt:', error);
				updateCloudStatus('âŒ ×©×’×™××” ×‘××¢×¨×›×ª', '×©×’×™××”');
				showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×§×‘×œ×”', 'error');
			}
		}

		// ×”×—×œ×£ ××ª saveEditedVisit ×‘×¤×•× ×§×¦×™×” ×–×•:
		async function saveEditedVisit(visitId) {
			console.log(`âœ… saveEditedVisit ('${visitId}')`);
			const visitIndex = visits.findIndex(v => v.ID == visitId);
			if (visitIndex === -1) {
				showToast('×‘×™×§×•×¨ ×œ× × ××¦×', 'error');
				return;
			}
			
			try {
				// ×¢×“×›×Ÿ ××ª ×”×‘×™×§×•×¨ ×‘××¢×¨×š ×”××§×•××™
				const updatedVisit = {
					...visits[visitIndex], // ×©××•×¨ × ×ª×•× ×™× ×§×™×™××™×
					date: document.getElementById('editVisitDate').value,
					visit_type: document.getElementById('editVisitType').value,
					work_done: document.getElementById('editWorkDone').value,
					duration_minutes: parseInt(document.getElementById('editDuration').value) || 0,
					start_time: document.getElementById('editStartTime').value,
					amount: parseFloat(document.getElementById('editAmount').value) || 0,
					expense: parseFloat(document.getElementById('editExpense').value) || 0,
					paid: document.getElementById('editPaid').value,
					notes: document.getElementById('editNotes').value
				};
				
				visits[visitIndex] = updatedVisit;
				
				// ×©××•×¨ ××§×•××™×ª ×ª××™×“
				saveToLocalStorage();
				updateCloudStatus('ğŸ’¾ ×©×•××¨ ×‘×™×§×•×¨...', '××¢×“×›×Ÿ');
				
				// × ×¡×” ×œ×©××•×¨ ×‘×¢× ×Ÿ
				if (access_token && SPREADSHEET_ID) {
					try {
						await updateVisitInCloud(updatedVisit);
						updateCloudStatus('âœ… ××—×•×‘×¨ ×•××¡×•× ×›×¨×Ÿ', '× ×©××¨');
						showToast('×‘×™×§×•×¨ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×” ×‘××¢×¨×›×ª ×•×‘×¢× ×Ÿ!', 'success');
					} catch (error) {
						if (error.status === 401) {
							updateCloudStatus('ğŸ” × ×“×¨×© ×—×™×‘×•×¨ ××—×“×©', '× ×•×ª×§');
							showToast('âš ï¸ ×”×—×™×‘×•×¨ ×œ×’×•×’×œ ×¤×’ - ×”×‘×™×§×•×¨ × ×©××¨ ××§×•××™×ª ×‘×œ×‘×“', 'warning');
							access_token = null;
						} else {
							updateCloudStatus('âš ï¸ ×©×’×™××” ×‘×©××™×¨×”', '×©×’×™××”');
							showToast('âš ï¸ ×”×‘×™×§×•×¨ × ×©××¨ ××§×•××™×ª, ××‘×œ ×œ× ×”×¦×œ×™×— ×œ×©××•×¨ ×‘×¢× ×Ÿ', 'warning');
						}
					}
				} else {
					updateCloudStatus('ğŸ” ×©×™× ×•×™×™× ×œ× × ×©××¨×• ×‘×¢× ×Ÿ', '××§×•××™');
					showToast('ğŸ” ×‘×™×§×•×¨ × ×©××¨ ××§×•××™×ª - ×”×ª×—×‘×¨ ×œ×¢× ×Ÿ ×œ×©××™×¨×” ××œ××”', 'warning');
				}
				
				// ×¢×“×›×Ÿ ×ª×¦×•×’×”
				applyVisitFilters();
				closeEditModal();
				
			} catch (error) {
				console.error('Error updating visit:', error);
				updateCloudStatus('âŒ ×©×’×™××” ×‘××¢×¨×›×ª', '×©×’×™××”');
				showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×‘×™×§×•×¨', 'error');
			}
		}

		// ×”×—×œ×£ ××ª connectToGoogleSheets ×‘×¤×•× ×§×¦×™×” ×–×•:
		async function connectToGoogleSheets() {
			try {
				console.log('Connecting to Google Sheets...');
				updateCloudStatus('ğŸ”— ××ª×—×‘×¨...', '××ª×—×‘×¨');
				showToast('××ª×—×‘×¨ ×œ-Google Sheets...', 'info');
				
				const tokenClient = google.accounts.oauth2.initTokenClient({
					client_id: CLIENT_ID,
					scope: SCOPES,
					callback: async (response) => {
						access_token = response.access_token;
						
						// ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡
						updateCloudStatus('âœ… ××—×•×‘×¨ ×•××¡×•× ×›×¨×Ÿ', '×”×ª×—×‘×¨');
						document.getElementById('statusText').classList.add('connected');
						document.getElementById('saveBtn').disabled = false;
						document.getElementById('loadBtn').disabled = false;
						
						showToast('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×” ×œ-Google Sheets!', 'success');
						
						// ××¦×™××” ××• ×™×¦×™×¨×ª ×”×˜×‘×œ×” ×”×¨××©×™×ª
						await findOrCreateMainSpreadsheet();

						// ×•×“× ×©×›×œ ×”×˜×‘×œ××•×ª ×”×—×“×©×•×ª ×§×™×™××•×ª
						await ensureNewTablesExist();

						// ×˜×¢×™× ×” ××•×˜×•××˜×™×ª ×©×œ × ×ª×•× ×™× ×× ×§×™×™××™×
						if (SPREADSHEET_ID) {
							try {
								await loadAllDataFromSheets();
							} catch (error) {
								console.log('Could not auto-load data:', error);
							}
						}
					},
				});
				
				tokenClient.requestAccessToken();
				
			} catch (error) {
				console.error('Error connecting to Google Sheets:', error);
				updateCloudStatus('âŒ ×©×’×™××” ×‘×—×™×‘×•×¨', '×©×’×™××”');
				showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ-Google Sheets', 'error');
			}
		}

		// ×”×—×œ×£ ××ª saveAllToSheets ×‘×¤×•× ×§×¦×™×” ×–×•:
		async function saveAllToSheets() {
			if (!await validateToken()) {
				showToast('××™×Ÿ ×—×™×‘×•×¨ ×œ×’×•×’×œ - ×©××™×¨×” ××§×•××™×ª ×‘×œ×‘×“', 'warning');
				return;
			}
			
			try {
				updateCloudStatus('×©×•××¨ × ×ª×•× ×™× ×œ×¢× ×Ÿ...', '××¢×“×›×Ÿ');
				
				// ×©××™×¨×” ×‘×‘××¦'×™× (×œ× ×œ×•×œ××•×ª!)
				const savePromises = [];
				
				if (locations.length > 0) {
					showToast(`×©×•××¨ ${locations.length} ×œ×§×•×—×•×ª ×‘×‘×ª ××—×ª...`, 'info', 2000);
					savePromises.push(saveLocationsBatch(locations));
				}
				
				if (visits.length > 0) {
					showToast(`×©×•××¨ ${visits.length} ×‘×™×§×•×¨×™× ×‘×‘×ª ××—×ª...`, 'info', 2000);
					savePromises.push(saveVisitsBatch(visits));
				}
				
				if (receipts.length > 0) {
					showToast(`×©×•××¨ ${receipts.length} ×§×‘×œ×•×ª ×‘×‘×ª ××—×ª...`, 'info', 2000);
					savePromises.push(saveReceiptsBatch(receipts));
				}
				
				// ×”××ª×Ÿ ×œ×›×œ ×”×©××™×¨×•×ª ×‘××§×‘×™×œ
				await Promise.all(savePromises);
				
				updateCloudStatus('××—×•×‘×¨ ×•××¡×•× ×›×¨×Ÿ', '× ×©××¨');
				showToast(`×›×œ ×”× ×ª×•× ×™× × ×©××¨×• ×‘×¢× ×Ÿ ×‘×”×¦×œ×—×”!`, 'success', 3000);
				
			} catch (error) {
				console.error('Error saving all data to cloud:', error);
				updateCloudStatus('×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ', '×©×’×™××”');
				showToast('×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ - ×”× ×ª×•× ×™× × ×©××¨×• ××§×•××™×ª', 'error');
			}
		}

		// ×”×•×¡×£ ××ª ×¤×•× ×§×¦×™×™×ª updateCloudStatus ×”×—×“×©×”:
		function updateCloudStatus(status, lastAction) {
			const statusElement = document.getElementById('statusText');
			const lastSavedElement = document.getElementById('lastSaved');
			
			if (statusElement) {
				statusElement.textContent = status;
				
				// ×¢×“×›×•×Ÿ ×¦×‘×¢×™× ×œ×¤×™ ×¡×˜×˜×•×¡
				if (status.includes('××—×•×‘×¨') || status.includes('××¡×•× ×›×¨×Ÿ')) {
					statusElement.style.color = '#28a745'; // ×™×¨×•×§
					statusElement.style.fontWeight = 'bold';
					statusElement.style.background = 'transparent'; // ×”×¡×¨ ×¨×§×¢
					statusElement.classList.add('connected');
				} else if (status.includes('×©×•××¨') || status.includes('××¢×“×›×Ÿ')) {
					statusElement.style.color = '#ffc107'; // ×¦×”×•×‘
					statusElement.style.fontWeight = 'bold';
				} else if (status.includes('×©×’×™××”')) {
					statusElement.style.color = '#dc3545'; // ××“×•×
					statusElement.style.fontWeight = 'bold';
					statusElement.classList.remove('connected');
				} else if (status.includes('× ×“×¨×© ×—×™×‘×•×¨')) {
					statusElement.style.color = '#fd7e14'; // ×›×ª×•×
					statusElement.style.fontWeight = 'bold';
					statusElement.classList.remove('connected');
				}
			}
			
			// ×¢×“×›×•×Ÿ ×–××Ÿ ×¤×¢×•×œ×” ××—×¨×•× ×”
			if (lastSavedElement && lastAction) {
				lastSavedElement.textContent = `${lastAction}: ${new Date().toLocaleTimeString('he-IL')}`;
				//lastSavedElement.style.color = //'#333'; // ×¦×‘×¢ ×›×”×” ×™×•×ª×¨
			}
		}
	   
	   
	   
	   //////////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	   
	   
	   function formatDateForSheets(dateString) {
			if (!dateString) return '';
			const date = new Date(dateString);
			const day = String(date.getDate()).padStart(2, '0');
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const year = date.getFullYear();
			return `${day}/${month}/${year}`;
		}
	   
	   
	   // ×¤×•× ×§×¦×™×” ×œ×”××¨×ª ×¡×˜×˜×•×¡ ×ª×©×œ×•× ×œ×§×™×“×•×“ ××¡×¤×¨×™
		function mapPaymentStatus(value) {
			if (!value || value.trim() === '') return "0";
			const normalized = value.toString().toLowerCase().trim();
			
			// ×”××¨×” ×¤×©×•×˜×” ×œ×¤×™ ×”×¢×¨×›×™× ×©×™×›×•×œ×™× ×œ×”×’×™×¢ ××”×™×™×‘×•×
			if (normalized === "×›×Ÿ" || normalized === "true" || normalized === "1") return "1";
			if (normalized === "×œ×œ× ×ª×©×œ×•×" || normalized === "×œ×œ×") return "2";
			return "0"; // ×›×œ ×”×©××¨ = ×œ× ×©×•×œ×
		}

		// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×˜×§×¡×˜ ×™×“×™×“×•×ª×™
		function getPaymentStatusText(status) {
			switch(status) {
				case "0": return "×œ× ×©×•×œ×";
				case "1": return "×©×•×œ×"; 
				case "2": return "×œ×œ× ×ª×©×œ×•×";
				default: return "×œ× ×©×•×œ×";
			}
		}
	   
	   
	   function parseAddressForImport(customerName) {
			if (!customerName) return { name: '', fullAddress: '', neighborhood: '', city: '' };
			
			const originalAddress = customerName.trim();
			const parts = originalAddress.split(' ');
			let city = '';
			
			if (parts.length >= 3) {
				// ×—×™×¤×•×© ××¡×¤×¨ ×‘×™×ª (××¡×¤×¨ + ××•×œ×™ ××•×ª ×/×‘)
				let houseNumberIndex = -1;
				for (let i = 0; i < parts.length; i++) {
					if (/^\d+[×-×‘]?$/.test(parts[i])) {
						houseNumberIndex = i;
						break; // ×œ×•×§×— ××ª ×”××¡×¤×¨ ×”×¨××©×•×Ÿ ×©× ××¦×
					}
				}
				
				if (houseNumberIndex !== -1 && houseNumberIndex < parts.length - 1) {
					// ×™×© ××¡×¤×¨ ×‘×™×ª - ×›×œ ××” ×©××—×¨×™×• ×”×•× ×¢×™×¨
					city = parts.slice(houseNumberIndex + 1).join(' ');
				} else {
					// ××™×Ÿ ××¡×¤×¨ ×‘×™×ª - ×›×œ ×”×›×ª×•×‘×ª ×”×™× ×¢×™×¨
					city = originalAddress;
				}
			} else {
				// ×¤×—×•×ª ×-3 ××™×œ×™× - ×›×œ ×”×›×ª×•×‘×ª ×”×™× ×¢×™×¨
				city = originalAddress;
			}
			
			// âœ… ×”××¨×ª ×”×§×™×¦×•×¨ ××—×¨×™ ×©×§×‘×¢× ×• ××ª ×”×¢×™×¨
			if (city === '×¨××©×œ×¦') {
				city = '×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ';
			}
			
			return {
				name: originalAddress, // ×”×©× ×”××§×•×¨×™ ×œ×œ× ×©×™× ×•×™
				fullAddress: originalAddress,
				neighborhood: '', // ×¨×™×§ ×œ××™×œ×•×™ ×™×“× ×™
				city: city
			};
		}
		
		
		// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×ª××¨×™×š ×˜×™×¤×•×œ ×”×‘×
		// ×¢×“×›×•×Ÿ ×ª××¨×™×š ×˜×™×¤×•×œ ×”×‘× ×œ×œ×§×•×—
		function updateClientNextVisit(clientId, newDate) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('×œ× × ××¦× ×œ×§×•×—', 'error');
				return;
			}
			
			// ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×”×ª××¨×™×š
			if (!newDate || isNaN(new Date(newDate))) {
				showToast('×ª××¨×™×š ×œ× ×ª×§×™×Ÿ', 'error');
				return;
			}
			
			const oldDate = client.next_visit;
			client.next_visit = newDate;
			
			// ××™×¤×•×¡ ×”×•×¡×¤×•×ª ×–×× ×™×•×ª
			if (client.temp_addition) {
				client.temp_addition = 0;
			}
			
			// ×©××™×¨×” ××§×•××™×ª
			saveToLocalStorage();
			
			// ×©××™×¨×” ×‘×¢× ×Ÿ ×× ××—×•×‘×¨
			if (access_token && SPREADSHEET_ID) {
				updateLocationInCloud(client).then(() => {
					console.log('âœ… ×ª××¨×™×š ×¢×•×“×›×Ÿ ×‘×¢× ×Ÿ');
				}).catch(error => {
					console.error('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¢× ×Ÿ:', error);
					showToast('×”×ª××¨×™×š ×¢×•×“×›×Ÿ ××§×•××™×ª, ××š ×œ× ×‘×¢× ×Ÿ', 'warning');
				});
			}
			
			const formattedDate = formatDate(newDate);
			showToast(`×ª××¨×™×š ×”×˜×™×¤×•×œ ×”×‘× ×¢×‘×•×¨ ${client.name} ×¢×•×“×›×Ÿ ×œ-${formattedDate}`, 'success');
			
			// ×¨×¢× ×•×Ÿ ×”×ª×¦×•×’×”
			setTimeout(() => {
				loadPlanningDataAdvanced();
			}, 300);
		}

		// ×¤×•× ×§×¦×™×” ×œ×”×¤×™×›×ª ×œ×§×•×— ×œ×¤×¢×™×œ/×œ× ×¤×¢×™×œ
		function toggleClientActive(clientId, activeValue) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			client.active = activeValue;
			
			// ×©××™×¨×”
			saveToLocalStorage();
			
			// ×¢×“×›×•×Ÿ ×‘×¢× ×Ÿ ×× ××—×•×‘×¨
			if (access_token && SPREADSHEET_ID) {
				updateLocationInCloud(client);
			}
			
			const statusText = activeValue === "1" ? "×¤×¢×™×œ" : "×œ× ×¤×¢×™×œ";
			showToast(`${client.name} ×”×•×’×“×¨ ×›-${statusText}`, 'success');
			
			// ×¨×¢× ×•×Ÿ ×”×ª×¦×•×’×” (×”×œ×§×•×— ×™×™×¢×œ× ×× ×œ× ×¤×¢×™×œ)
			loadPlanningDataAdvanced();
		}

		// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×
		function showClientHistory(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			// ××¦×™××ª 3 ×”×˜×™×¤×•×œ×™× ×”××—×¨×•× ×™×
			const clientVisits = visits
				.filter(visit => visit.location_id === clientId)
				.sort((a, b) => new Date(b.date) - new Date(a.date))
				.slice(0, 3);
			
			if (clientVisits.length === 0) {
				alert(`${client.name}\n××™×Ÿ ×¢×“×™×™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×`);
				return;
			}
			
			// ×‘× ×™×™×ª ×ª×•×›×Ÿ ×”×—×œ×•× ×™×ª
			let historyHtml = `
				<div style="background: white; padding: 20px; border-radius: 10px; max-width: 500px; max-height: 400px; overflow-y: auto;">
					<h3 style="margin-bottom: 15px; color: #333;">ğŸ“‹ ×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™× - ${client.name}</h3>
					<div style="margin-bottom: 20px; font-size: 12px; color: #666;">
						×›×ª×•×‘×ª: ${client.full_address}
					</div>
					<div style="space-y: 10px;">
			`;
			
			clientVisits.forEach((visit, index) => {
				const visitDate = formatDate(visit.date);
				const amount = visit.amount || 0;
				const workDone = visit.work_done || '×˜×™×¤×•×œ';
				const paidStatus = visit.paid === '×›×Ÿ' ? 'âœ… ×©×•×œ×' : 'âŒ ×œ× ×©×•×œ×';
				const paidColor = visit.paid === '×›×Ÿ' ? '#28a745' : '#dc3545';
				
				historyHtml += `
					<div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 10px; background: ${index === 0 ? '#f8f9ff' : '#fafafa'};">
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
							<strong style="color: #2c3e50;">ğŸ“… ${visitDate}</strong>
							<span style="font-weight: bold; color: ${paidColor};">${paidStatus}</span>
						</div>
						<div style="margin-bottom: 5px; color: #666;">
							ğŸ› ï¸ ×¢×‘×•×“×”: ${workDone}
						</div>
						<div style="display: flex; justify-content: space-between; font-size: 14px;">
							<span>ğŸ’° â‚ª${amount}</span>
							${visit.duration_minutes ? `<span>â±ï¸ ${visit.duration_minutes} ×“×§'</span>` : ''}
						</div>
						${visit.notes ? `<div style="margin-top: 8px; font-size: 12px; color: #666; font-style: italic;">ğŸ“ ${visit.notes}</div>` : ''}
					</div>
				`;
			});
			
			historyHtml += `
					</div>
					<div style="text-align: center; margin-top: 20px;">
						<button onclick="closeModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
							×¡×’×•×¨
						</button>
					</div>
				</div>
			`;
			
			// ×”×¦×’×ª ×”×—×œ×•× ×™×ª
			showModal(historyHtml);
		}
		
	   
	   // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×œ×§×•×— ×¡×¤×¦×™×¤×™ ×‘×¢× ×Ÿ
		async function updateLocationInCloud(client) {
			if (!await validateToken()) return;
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:A'
				});
				
				const rows = response.result.values || [];
				const rowIndex = rows.findIndex(row => row[0] === client.ID);
				
				if (rowIndex > 0) {
					const rowNumber = rowIndex + 1;
					const clientRow = [
						client.ID, client.name, client.full_address, client.neighborhood, client.city,
						client.contact_person, client.phone, client.allowed_day, client.interval_weeks,
						client.temp_addition || 0, // âœ… ×”×•×¡×£ ×‘×“×™×§×”
						client.base_amount, client.active, client.notes,
						client.last_visit, client.next_visit, client.client_requests || ''
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Locations!A${rowNumber}:P${rowNumber}`,
						valueInputOption: 'USER_ENTERED',
						resource: { values: [clientRow] }
					});
					
					console.log('âœ… Successfully updated client in cloud'); // ×œ×•×’ ×œ×”×¦×œ×—×”
				} else {
					throw new Error(`Client with ID ${client.ID} not found in spreadsheet`);
				}
			} catch (error) {
				console.error('Error updating client in cloud:', error);
				throw error; // âœ… ×—×©×•×‘ - ×”×¢×‘×¨ ××ª ×”×©×’×™××” ×”×œ××”
			}
		}
	   
	   
	   // ===== ×¤×•× ×§×¦×™×•×ª ×¤×¢× ×•×— ×”×›× ×¡×•×ª ××˜×œ×’×¨× =====

		// ×”××¨×ª ×ª××¨×™×š ××¤×•×¨××˜ ×˜×œ×’×¨× ×œ-ISO
		function parseTelegramDateToISO(dateStr) {
			const months = {
				'January': '01', 'February': '02', 'March': '03', 'April': '04',
				'May': '05', 'June': '06', 'July': '07', 'August': '08',
				'September': '09', 'October': '10', 'November': '11', 'December': '12'
			};
			
			const parts = dateStr.split(' ');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = months[parts[1]] || '01';
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			return dateStr;
		}

		// ×¤×¢× ×•×— ×©×•×¨×ª ×”×›× ×¡×” ×‘×•×“×“×ª
		function parseIncomeLineFromTelegram(line, date, time) {
			try {
				// ×—×™×œ×•×¥ ×›×ª×•×‘×ª ×œ×§×•×—
				let clientAddress = '';
				const dotIndex = line.indexOf('.');
				if (dotIndex > 0) {
					clientAddress = line.substring(0, dotIndex).trim();
				} else {
					const beforeReceived = line.split('×§×™×‘×œ×ª×™')[0].trim();
					clientAddress = beforeReceived.replace(/[.,]$/, '');
				}

				// ×—×™×œ×•×¥ ×¡×›×•× - ×’×¨×¡×” ××©×•×¤×¨×ª
				let amount = 0;
				const amountPatterns = [
					/×§×™×‘×œ×ª×™\s+×ª×©×œ×•×\s+(\d+)/,     
					/×§×™×‘×œ×ª×™\s+(\d+)/,              
					/×§×™×‘×œ×ª×™\s+×¦'×§\s+(\d+)/,        
					/×§×™×‘×œ×ª×™\s+×¢×•×“\s+(\d+)/,        
					/(\d+)\s+××–×•××Ÿ/,               
					/(\d+)\s+×‘×™×˜/,                 
					/(\d+)\s+×”×¢×‘×¨×”/,               
					/(\d+)\s+×¤×™×™×‘×•×§×¡/,
					/(\d+)\s+×¦'×§/
				];
				
				for (const pattern of amountPatterns) {
					const match = line.match(pattern);
					if (match) {
						amount = parseInt(match[1]);
						break;
					}
				}
				
				// ×× ×¢×“×™×™×Ÿ ×œ× ××¦×× ×•, ×—×¤×© ××¡×¤×¨×™× ×’×“×•×œ×™×
				if (amount === 0) {
					const allNumbers = line.match(/\d+/g);
					if (allNumbers && allNumbers.length > 0) {
						const numbers = allNumbers.map(n => parseInt(n)).filter(n => n >= 50);
						if (numbers.length > 0) {
							amount = Math.max(...numbers);
						}
					}
				}

				// ×–×™×”×•×™ ×××¦×¢×™ ×ª×©×œ×•× - ×¢× ×ª×™×§×•×Ÿ "×œ× ×¦×•×™×Ÿ" = ××–×•××Ÿ
				let paymentMethod = '××–×•××Ÿ'; // ×‘×¨×™×¨×ª ××—×“×œ ×‘××§×•× "×œ× ×¦×•×™×Ÿ"
				if (line.includes('×”×¢×‘×¨×” ×œ×—×©×‘×•×Ÿ') || line.includes('×”×¢×‘×¨×”')) {
					paymentMethod = '×”×¢×‘×¨×” ×‘× ×§××™×ª';
				} else if (line.includes('×¦\'×§')) {
					paymentMethod = '×¦\'×§';
				} else if (line.includes('×‘×™×˜')) {
					paymentMethod = '×‘×™×˜';
				} else if (line.includes('××–×•××Ÿ')) {
					paymentMethod = '××–×•××Ÿ';
				} else if (line.includes('×¤×™×™×‘×•×§×¡')) {
					paymentMethod = '×¤×™×™×‘×•×§×¡';
				}

				// ×—×™×œ×•×¥ ×”×¢×¨×•×ª
				let notes = '';
				if (line.includes('×¢×‘×•×¨')) {
					const match = line.match(/×¢×‘×•×¨[^.]+/);
					if (match) notes += match[0] + ' ';
				}
				if (line.includes('×©×›×—×ª×™') || line.includes('×œ× ×¨×©××ª×™') || line.includes('×œ× ×¢×“×›× ×ª×™')) {
					notes += '×œ× ×ª×•×¢×“ ××™×“ ';
				}
				if (line.includes('×¢×œ ×”×—×©×‘×•×Ÿ') || line.includes('×—×•×‘')) {
					notes += '×ª×©×œ×•× ×¢×œ ×—×©×‘×•×Ÿ ';
				}

				return {
					date: date,
					time: time,
					client_address: clientAddress,
					amount: amount,
					payment_method: paymentMethod,
					notes: notes.trim(),
					raw_text: line
				};
			} catch (error) {
				console.error('×©×’×™××” ×‘×¤×¢× ×•×— ×©×•×¨×ª ×”×›× ×¡×”:', line, error);
				return null;
			}
		}

		// ×¤×¢× ×•×— ××œ× ×©×œ × ×ª×•× ×™ ×”×›× ×¡×•×ª ××˜×œ×’×¨×
		function parseIncomesFromTelegramText(telegramText) {
			const lines = telegramText.split('\n').map(line => line.replace(/\r$/, '').trim());
			const incomes = [];
			let currentDate = '';
			let currentTime = '';
			
			for (let i = 0; i < lines.length; i++) {
				const line = lines[i];
				
				// ×–×™×”×•×™ ×ª××¨×™×š (15 August 2024)
				if (/^\d{1,2} \w+ \d{4}$/.test(line)) {
					currentDate = parseTelegramDateToISO(line);
					continue;
				}
				
				// ×–×™×”×•×™ ×©×¢×” (20:04)
				if (/^\d{1,2}:\d{2}$/.test(line)) {
					currentTime = line;
					continue;
				}
				
				// ×–×™×”×•×™ ×”×•×“×¢×ª ×”×›× ×¡×” (××›×™×œ×” "×§×™×‘×œ×ª×™" ×•××¡×¤×¨)
				if (line.includes('×§×™×‘×œ×ª×™') && /\d+/.test(line)) {
					const income = parseIncomeLineFromTelegram(line, currentDate, currentTime);
					if (income && income.amount > 0) {
						incomes.push(income);
					}
				}
			}
			
			return incomes;
		}
	   
	   
	   // ===== ×¤×•× ×§×¦×™×•×ª ×”×¢×œ××” ×•×˜×™×¤×•×œ ×‘×§×•×‘×¥ ×”×›× ×¡×•×ª ×˜×œ×’×¨× =====

		// ××¢×¨×š ×’×œ×•×‘×œ×™ ×œ××—×¡×•×Ÿ ×”×›× ×¡×•×ª ××˜×œ×’×¨×
		let telegramIncomes = [];

		// ×¤×•× ×§×¦×™×” ×œ×˜×™×¤×•×œ ×‘×”×¢×œ××ª ×§×•×‘×¥ ×”×›× ×¡×•×ª ××˜×œ×’×¨×
		async function handleTelegramIncomeFileUpload(event) {
			const file = event.target.files[0];
			if (!file) {
				showToast('×œ× × ×‘×—×¨ ×§×•×‘×¥', 'warning');
				return;
			}

			console.log('âœ… ××¢×¨×›×ª ×™×™×‘×•× ×”×›× ×¡×•×ª ××˜×œ×’×¨× ××•×¤×¢×œ×ª');

			try {
				showLoading('×§×•×¨× ×§×•×‘×¥ ×”×›× ×¡×•×ª ××˜×œ×’×¨×...');
				
				const text = await file.text();
				console.log('ğŸ“„ ×§×•×‘×¥ × ×§×¨×:', file.name, '×’×•×“×œ:', text.length, '×ª×•×•×™×');
				
				// ×¤×¢× ×•×— ×”× ×ª×•× ×™×
				const parsedIncomes = parseIncomesFromTelegramText(text);
				
				if (parsedIncomes.length === 0) {
					hideLoading();
					showToast('×œ× × ××¦××• ×”×›× ×¡×•×ª ×‘×§×•×‘×¥', 'warning');
					return;
				}
				
				// ×©××™×¨×” ×‘××¢×¨×š ×”×’×œ×•×‘×œ×™
				telegramIncomes = parsedIncomes;
				
				hideLoading();
				
				// ×”×¦×’×ª ×ª×•×¦××•×ª
				const totalAmount = parsedIncomes.reduce((sum, income) => sum + income.amount, 0);
				showToast(`ğŸ‰ × ××¦××• ${parsedIncomes.length} ×”×›× ×¡×•×ª, ×¡×š ${totalAmount.toLocaleString()} ×©"×—`, 'success', 4000);
				
				// ×”×¦×’×ª ×ª×¦×•×’×” ××§×“×™××”
				showTelegramIncomesPreview(parsedIncomes);
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×§×¨×™××ª ×§×•×‘×¥ ×”×›× ×¡×•×ª:', error);
				hideLoading();
				showToast('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥', 'error');
			}
		}

		// ×”×¦×’×ª ×ª×¦×•×’×” ××§×“×™××” ×©×œ ×”×”×›× ×¡×•×ª ×©× ××¦××•
		function showTelegramIncomesPreview(incomes) {
			const totalAmount = incomes.reduce((sum, income) => sum + income.amount, 0);
			
			// ×”×ª×¤×œ×’×•×ª ×××¦×¢×™ ×ª×©×œ×•×
			const paymentMethods = {};
			incomes.forEach(income => {
				paymentMethods[income.payment_method] = (paymentMethods[income.payment_method] || 0) + 1;
			});
			
			let previewHTML = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 900px; max-height: 70vh; overflow-y: auto; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ’° ×ª×¦×•×’×” ××§×“×™××” - ×”×›× ×¡×•×ª ××˜×œ×’×¨×</h3>
					
					<div style="margin-bottom: 25px; padding: 18px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #27ae60;">
						<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
							<div>
								<strong style="font-size: 20px; color: #27ae60;">${incomes.length}</strong><br>
								<span style="color: #666;">×”×›× ×¡×•×ª × ××¦××•</span>
							</div>
							<div>
								<strong style="font-size: 20px; color: #27ae60;">${totalAmount.toLocaleString()}</strong><br>
								<span style="color: #666;">×©"×— ×¡×”"×›</span>
							</div>
							<div>
								<strong style="font-size: 20px; color: #27ae60;">${Object.keys(paymentMethods).length}</strong><br>
								<span style="color: #666;">×××¦×¢×™ ×ª×©×œ×•×</span>
							</div>
						</div>
					</div>
					
					<div style="margin-bottom: 20px;">
						<h4 style="color: #34495e; margin-bottom: 10px;">ğŸ“Š ×¤×™×œ×•×— ×××¦×¢×™ ×ª×©×œ×•×:</h4>
						<div style="display: flex; flex-wrap: wrap; gap: 10px;">
							${Object.entries(paymentMethods).map(([method, count]) => 
								`<span style="background: #3498db; color: white; padding: 5px 12px; border-radius: 15px; font-size: 13px;">
									${method}: ${count}
								</span>`
							).join('')}
						</div>
					</div>
					
					<div style="margin-bottom: 20px;">
						<h4 style="color: #34495e; margin-bottom: 15px;">ğŸ“‹ ×“×•×’×××•×ª (10 ×¨××©×•× ×•×ª):</h4>
						<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px;">
							<table style="width: 100%; border-collapse: collapse; font-size: 13px;">
								<thead style="background: #f8f9fa; position: sticky; top: 0;">
									<tr>
										<th style="padding: 10px; border: 1px solid #ddd; text-align: right;">×ª××¨×™×š</th>
										<th style="padding: 10px; border: 1px solid #ddd; text-align: right;">×œ×§×•×—</th>
										<th style="padding: 10px; border: 1px solid #ddd; text-align: right;">×¡×›×•×</th>
										<th style="padding: 10px; border: 1px solid #ddd; text-align: right;">×ª×©×œ×•×</th>
										<th style="padding: 10px; border: 1px solid #ddd; text-align: right;">×”×¢×¨×•×ª</th>
									</tr>
								</thead>
								<tbody>
									${incomes.slice(0, 10).map((income, index) => `
										<tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
											<td style="padding: 8px; border: 1px solid #ddd;">${income.date}</td>
											<td style="padding: 8px; border: 1px solid #ddd; max-width: 150px; word-wrap: break-word;">${income.client_address}</td>
											<td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #27ae60;">${income.amount}</td>
											<td style="padding: 8px; border: 1px solid #ddd;">${income.payment_method}</td>
											<td style="padding: 8px; border: 1px solid #ddd; font-size: 11px; color: #666;">${income.notes || '-'}</td>
										</tr>
									`).join('')}
								</tbody>
							</table>
						</div>
						${incomes.length > 10 ? `<p style="text-align: center; color: #666; margin-top: 10px;">×•×¢×•×“ ${incomes.length - 10} ×”×›× ×¡×•×ª...</p>` : ''}
					</div>
					
					<div style="text-align: center; gap: 15px; display: flex; justify-content: center;">
						<button class="btn btn-success" onclick="confirmTelegramIncomesImport()" style="padding: 12px 25px; font-size: 16px;">
							âœ… ×™×™×‘× ${incomes.length} ×”×›× ×¡×•×ª ×œ××¢×¨×›×ª
						</button>
						<button class="btn btn-secondary" onclick="cancelTelegramIncomesImport()" style="padding: 12px 25px; font-size: 16px;">
							âŒ ×‘×™×˜×•×œ
						</button>
					</div>
				</div>
			`;
			
			showModal(previewHTML);
		}

		// ×‘×™×˜×•×œ ×™×™×‘×•× ×”×›× ×¡×•×ª
		function cancelTelegramIncomesImport() {
			telegramIncomes = [];
			closeModal();
			showToast('×™×™×‘×•× ×”×›× ×¡×•×ª ×‘×•×˜×œ', 'info');
		}


		// ===== ×¤×•× ×§×¦×™×•×ª ××™×©×•×¨ ×™×™×‘×•× ×”×›× ×¡×•×ª =====

		// ===== ×¤×•× ×§×¦×™×•×ª ×•×™×“×•× ×§×™×•× ×’×™×œ×™×•× ×•×ª × ×“×¨×©×™× =====

		// ×•×™×“×•× ×§×™×•× ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª ×‘××¢×¨×›×ª ×”×¨××©×™×ª
		async function ensureIncomesSheetExists() {
			if (!await validateToken()) return false;
			
			try {
				const response = await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				
				const existingSheets = response.result.sheets.map(sheet => sheet.properties.title);
				
				if (!existingSheets.includes('Incomes')) {
					console.log('×™×•×¦×¨ ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª...');
					
					await gapi.client.sheets.spreadsheets.batchUpdate({
						spreadsheetId: SPREADSHEET_ID,
						resource: {
							requests: [{
								addSheet: {
									properties: {
										title: 'Incomes',
										gridProperties: {
											rowCount: 1000,
											columnCount: 12
										}
									}
								}
							}]
						}
					});
					
					// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª
					const headers = [
						'ID', '×ª××¨×™×š', '×©×¢×”', '×›×ª×•×‘×ª_×œ×§×•×—', '××–×”×”_×œ×§×•×—', 
						'×¡×›×•×', '×××¦×¢×™_×ª×©×œ×•×', '×”×¢×¨×•×ª', '×˜×§×¡×˜_××§×•×¨×™', 
						'××§×•×¨_×™×™×‘×•×', '×ª××¨×™×š_×™×™×‘×•×', '×¡×˜×˜×•×¡'
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: 'Incomes!A1:L1',
						valueInputOption: 'RAW',
						resource: { values: [headers] }
					});
					
					console.log('âœ… ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª × ×•×¦×¨');
				}
				
				return true;
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×•×™×“×•× ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª:', error);
				return false;
			}
		}

	

		// ××™×©×•×¨ ×™×™×‘×•× ×”×”×›× ×¡×•×ª ××˜×œ×’×¨× - ×’×™×¨×¡×” ××¢×•×“×›× ×ª
		async function confirmTelegramIncomesImport() {
			if (!telegramIncomes || telegramIncomes.length === 0) {
				showToast('××™×Ÿ ×”×›× ×¡×•×ª ×œ×™×™×‘×•×', 'warning');
				return;
			}
			
			try {
				showLoading('××›×™×Ÿ ××¢×¨×›×ª ×œ×™×™×‘×•× ×”×›× ×¡×•×ª...');
				
				// ×•×“× ×©×”×˜×‘×œ×•×ª ×§×™×™××•×ª
				await ensureNewTablesExist();
				
				showLoading('××™×™×‘× ×”×›× ×¡×•×ª ×œ××¢×¨×›×ª...');
				
				// ×”×•×¡×£ ID ×œ×›×œ ×”×›× ×¡×”
				const incomesWithIds = telegramIncomes.map(income => ({
					...income,
					ID: generateID(),
					import_date: new Date().toISOString().split('T')[0],
					matched_to_visit: false,
					visit_ids: [],
					processed: false
				}));
				
				// ×©××•×¨ ×œ×˜×‘×œ×ª TelegramIncomes
				await saveTelegramIncomesToCloud(incomesWithIds);
				
				let importedCount = 0;
				let skippedCount = 0;
				
				// ×™×¦×™×¨×ª ××¢×¨×š incomes ×× ×œ× ×§×™×™×
				if (typeof incomes === 'undefined') {
					window.incomes = [];
				}
				
				for (const telegramIncome of incomesWithIds) {
					// ×‘×“×™×§×ª ×›×¤×™×œ×•×ª (×ª××¨×™×š + ×¡×›×•× + ×˜×§×¡×˜ ×—×œ×§×™)
					const isDuplicate = incomes.some(existing => 
						existing.date === telegramIncome.date &&
						existing.amount === telegramIncome.amount &&
						existing.raw_text && 
						existing.raw_text.includes(telegramIncome.client_address.substring(0, 10))
					);
					
					if (isDuplicate) {
						skippedCount++;
						console.log('âš ï¸ ×“×•×œ×’ ×¢×œ ×”×›× ×¡×” ×›×¤×•×œ×”:', telegramIncome.client_address, telegramIncome.amount);
						continue;
					}
					
					// ×™×¦×™×¨×ª ×¨×©×•××ª ×”×›× ×¡×” ×—×“×©×” ×‘××¢×¨×›×ª ×”×™×©× ×” (×œ×ª××™××•×ª ×œ××—×•×¨)
					const newIncome = {
						ID: telegramIncome.ID,
						date: telegramIncome.date,
						time: telegramIncome.time || '',
						client_address: telegramIncome.client_address,
						client_id: null, // ×™×§×•×©×¨ ×××•×—×¨ ×™×•×ª×¨
						amount: telegramIncome.amount,
						payment_method: telegramIncome.payment_method,
						notes: telegramIncome.notes,
						raw_text: telegramIncome.raw_text,
						matched_to_visit: false,
						visit_ids: [],
						imported_from: 'telegram',
						import_date: telegramIncome.import_date
					};
					
					incomes.push(newIncome);
					importedCount++;
				}
				
				// ×©××™×¨×” ××§×•××™×ª
				saveToLocalStorage();
				
				hideLoading();
				closeModal();
				
				// ×”×•×“×¢×ª ×”×¦×œ×—×”
				let message = `ğŸ‰ ×™×™×‘×•× ×”×›× ×¡×•×ª ×”×•×©×œ×!\nğŸ’° ${importedCount} ×”×›× ×¡×•×ª ×™×•×‘××•`;
				if (skippedCount > 0) {
					message += `\nâš ï¸ ${skippedCount} ×”×›× ×¡×•×ª ×“×•×œ×’×• (×›×¤×™×œ×•×ª)`;
				}
				
				showToast(message, 'success', 5000);
				
				// ×¨×¢× ×•×Ÿ ×”×ª×¦×•×’×” ×× × ××¦××™× ×‘×¢××•×“ ×”×›× ×¡×•×ª
				if (typeof loadIncomesTable === 'function') {
					loadIncomesTable();
				}
				
				// ××™×¤×•×¡ ×”××¢×¨×š ×”×–×× ×™
				telegramIncomes = [];
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×™×™×‘×•× ×”×›× ×¡×•×ª:', error);
				hideLoading();
				showToast('×©×’×™××” ×‘×™×™×‘×•× ×”×›× ×¡×•×ª', 'error');
			}
		}

		// ×¤×•× ×§×¦×™×” × ×•×¡×¤×ª - ×©××™×¨×ª ×”×›× ×¡×•×ª ××˜×œ×’×¨× ×œ×˜×‘×œ×” ×”×—×“×©×”
		async function saveTelegramIncomesToCloud(telegramIncomes) {
			if (!access_token || !SPREADSHEET_ID || !telegramIncomes || telegramIncomes.length === 0) {
				return false;
			}
			
			try {
				console.log('ğŸ’¾ ×©×•××¨ ×”×›× ×¡×•×ª ×˜×œ×’×¨×...');
				
				// ×”×›×Ÿ × ×ª×•× ×™× ×œ×©××™×¨×”
				const rows = telegramIncomes.map(income => [
					income.ID,
					income.date,
					income.time || '',
					income.client_address,
					income.amount,
					income.payment_method,
					income.notes || '',
					income.raw_text || '',
					income.matched_to_visit || false,
					income.visit_ids ? income.visit_ids.join(',') : '',
					income.processed || false,
					income.import_date || new Date().toISOString().split('T')[0]
				]);
				
				// ×©××•×¨ ×œ×˜×‘×œ×”
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'TelegramIncomes!A:L',
					valueInputOption: 'USER_ENTERED',
					resource: { values: rows }
				});
				
				console.log(`âœ… × ×©××¨×• ${telegramIncomes.length} ×”×›× ×¡×•×ª ×˜×œ×’×¨×`);
				return true;
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×©××™×¨×ª ×”×›× ×¡×•×ª ×˜×œ×’×¨×:', error);
				return false;
			}
		}
		
		
		// ×”×•×¡×¤×ª ×›×¤×ª×•×¨ ×”×¢×œ××” ×œ×××©×§ (×œ×”×•×¡×™×£ ×œ××§×•× ×”××ª××™× ×‘×××©×§)
		function addTelegramIncomeUploadButton() {
			const uploadHTML = `
				<div class="upload-section" style="margin: 20px 0; padding: 20px; border: 2px dashed #3498db; border-radius: 10px; text-align: center;">
					<h3 style="color: #3498db; margin-bottom: 15px;">ğŸ“¤ ×™×™×‘×•× ×”×›× ×¡×•×ª ××˜×œ×’×¨×</h3>
					<p style="color: #666; margin-bottom: 20px;">×‘×—×¨ ×§×•×‘×¥ ×˜×§×¡×˜ ×¢× ×™×™×¦×•× ×”×›× ×¡×•×ª ××˜×œ×’×¨×</p>
					<input type="file" id="telegramIncomeFile" accept=".txt,.json" style="display: none;" onchange="handleTelegramIncomeFileUpload(event)">
					<button class="btn btn-primary" onclick="document.getElementById('telegramIncomeFile').click()" style="padding: 12px 25px; font-size: 16px;">
						ğŸ“ ×‘×—×¨ ×§×•×‘×¥ ×”×›× ×¡×•×ª ××˜×œ×’×¨×
					</button>
				</div>
			`;
			
			return uploadHTML;
		}


		// ===== ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ × ×•×¡×¤×•×ª ×œ××¢×¨×›×ª ×”×›× ×¡×•×ª =====

		// ×™×¦×™×¨×ª ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ×¨×©×™××ª ×”×›× ×¡×•×ª (×× ×œ× ×§×™×™××ª)
		function loadIncomesTable() {
			if (typeof incomes === 'undefined' || !incomes.length) {
				console.log('ğŸ“Š ××™×Ÿ ×”×›× ×¡×•×ª ×œ×”×¦×’×”');
				return;
			}
			
			console.log(`ğŸ“Š ×˜×•×¢×Ÿ ${incomes.length} ×”×›× ×¡×•×ª ×œ×ª×¦×•×’×”`);
			// ×›××Ÿ ×ª×•×¡×™×£ ××ª ×”×œ×•×’×™×§×” ×œ×”×¦×’×ª ×”×›× ×¡×•×ª ×‘×××©×§ ×‘×¢×ª×™×“
		}

		// ××ª×—×•×œ ××¢×¨×š ×”×›× ×¡×•×ª ×× ×œ× ×§×™×™×
		if (typeof incomes === 'undefined') {
			window.incomes = [];
		}

		// ×”×•×¡×¤×” ×œ×¤×•× ×§×¦×™×™×ª ×©××™×¨×” ××§×•××™×ª ×”×§×™×™××ª
		function saveIncomesToLocalStorage() {
			if (typeof incomes !== 'undefined' && incomes.length > 0) {
				localStorage.setItem('incomes', JSON.stringify(incomes));
				console.log('ğŸ’¾ ×©××¨', incomes.length, '×”×›× ×¡×•×ª ××§×•××™×ª');
			}
		}

		// ×”×•×¡×¤×” ×œ×¤×•× ×§×¦×™×™×ª ×˜×¢×™× ×” ××§×•××™×ª ×”×§×™×™××ª  
		function loadIncomesFromLocalStorage() {
			const savedIncomes = localStorage.getItem('incomes');
			if (savedIncomes) {
				try {
					window.incomes = JSON.parse(savedIncomes);
					console.log('ğŸ“‚ ×˜×¢×Ÿ', incomes.length, '×”×›× ×¡×•×ª ××”×–×™×›×¨×•×Ÿ ×”××§×•××™');
				} catch (error) {
					console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×›× ×¡×•×ª:', error);
					window.incomes = [];
				}
			} else {
				window.incomes = [];
			}
		}

		// ×©××™×¨×ª ×”×›× ×¡×•×ª ×‘×¢× × ×” (×™×© ×œ×”×ª××™× ×œ×¤×™ ×”××‘× ×” ×”×§×™×™×)
		async function saveIncomesToCloud() {
			if (!access_token || !SPREADSHEET_ID) {
				throw new Error('×œ× ××—×•×‘×¨ ×œ×¢× × ×”');
			}
			
			console.log('ğŸ’¾ ×©×•××¨ ×”×›× ×¡×•×ª ×‘×¢× × ×”...');
			// ×›××Ÿ ×ª×•×¡×™×£ ××ª ×”×œ×•×’×™×§×” ×œ×©××™×¨×” ×‘×’×•×’×œ ×©×™×˜×¡ ×‘×¢×ª×™×“
		}


		// ===== ×¤×•× ×§×¦×™×•×ª ×™×¦×™×¨×ª ×’×™×œ×™×•× ×•×ª × ×•×¡×¤×™× ×‘××¢×¨×›×ª =====

		// ×™×¦×™×¨×ª ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª ×‘×§×•×‘×¥ ×”×¨××©×™
		async function createIncomesSheet() {
			if (!await validateToken()) {
				showToast('×”×ª×—×‘×¨ ×œ×’×•×’×œ ×§×•×“×', 'warning');
				return false;
			}
			
			try {
				showLoading('×™×•×¦×¨ ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª...');
				
				// ×‘×“×™×§×” ×× ×”×’×™×œ×™×•×Ÿ ×›×‘×¨ ×§×™×™×
				const sheetsResponse = await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				
				const existingSheet = sheetsResponse.result.sheets.find(sheet => 
					sheet.properties.title === 'Incomes'
				);
				
				if (existingSheet) {
					hideLoading();
					showToast('×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª ×›×‘×¨ ×§×™×™×', 'info');
					return true;
				}
				
				// ×™×¦×™×¨×ª ×”×’×™×œ×™×•×Ÿ ×”×—×“×©
				await gapi.client.sheets.spreadsheets.batchUpdate({
					spreadsheetId: SPREADSHEET_ID,
					resource: {
						requests: [{
							addSheet: {
								properties: {
									title: 'Incomes',
									gridProperties: {
										rowCount: 1000,
										columnCount: 10
									}
								}
							}
						}]
					}
				});
				
				// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª
				const headers = [
					'ID', '×ª××¨×™×š', '×©×¢×”', '×›×ª×•×‘×ª_×œ×§×•×—', '××–×”×”_×œ×§×•×—', 
					'×¡×›×•×', '×××¦×¢×™_×ª×©×œ×•×', '×”×¢×¨×•×ª', '×˜×§×¡×˜_××§×•×¨×™', '××§×•×¨_×™×™×‘×•×'
				];
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Incomes!A1:J1',
					valueInputOption: 'RAW',
					resource: { values: [headers] }
				});
				
				hideLoading();
				showToast('âœ… ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª × ×•×¦×¨ ×‘×”×¦×œ×—×”!', 'success');
				return true;
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×™×¦×™×¨×ª ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª:', error);
				hideLoading();
				showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×’×™×œ×™×•×Ÿ ×”×›× ×¡×•×ª', 'error');
				return false;
			}
		}

		

		// ===== ××¢×¨×›×ª ×˜×‘×œ××•×ª ×—×“×©×” ×œ×˜×œ×’×¨× ×•×ª×©×œ×•××™× =====

		// ×¤×•× ×§×¦×™×” ××¨×›×–×™×ª ×œ×™×¦×™×¨×ª ×›×œ ×”×˜×‘×œ××•×ª ×”×—×“×©×•×ª ×”× ×“×¨×©×•×ª
		async function ensureNewTablesExist() {
			if (!await validateToken()) {
				showToast('× ×“×¨×© ×—×™×‘×•×¨ ×œ×’×•×’×œ', 'warning');
				return false;
			}
			
			try {
				console.log('ğŸ” ×‘×•×“×§ ×§×™×•× ×˜×‘×œ××•×ª ×—×“×©×•×ª...');
				
				// ×¨×©×™××ª ×”×˜×‘×œ××•×ª ×”×—×“×©×•×ª ×”× ×“×¨×©×•×ª
				const requiredTables = [
					{ name: 'TelegramVisits', columns: 10 },
					{ name: 'TelegramIncomes', columns: 12 },
					{ name: 'Payments', columns: 10 },
					{ name: 'PaymentVisitLink', columns: 6 }
				];
				
				// ×‘×“×™×§×ª ×§×™×•× ×”×˜×‘×œ××•×ª ×”× ×•×›×—×™×•×ª
				const response = await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				
				const existingSheets = response.result.sheets.map(sheet => sheet.properties.title);
				console.log('ğŸ“‹ ×’×™×œ×™×•× ×•×ª ×§×™×™××™×:', existingSheets);
				
				// ×™×¦×™×¨×ª ×”×˜×‘×œ××•×ª ×”×—×¡×¨×•×ª
				let createdCount = 0;
				
				for (const table of requiredTables) {
					if (!existingSheets.includes(table.name)) {
						console.log(`ğŸ”¨ ×™×•×¦×¨ ×˜×‘×œ×”: ${table.name}`);
						
						// ×™×¦×™×¨×ª ×”×’×™×œ×™×•×Ÿ
						await gapi.client.sheets.spreadsheets.batchUpdate({
							spreadsheetId: SPREADSHEET_ID,
							resource: {
								requests: [{
									addSheet: {
										properties: {
											title: table.name,
											gridProperties: {
												rowCount: 1000,
												columnCount: table.columns
											}
										}
									}
								}]
							}
						});
						
						// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª
						await addHeadersToNewTable(table.name);
						createdCount++;
						
						console.log(`âœ… × ×•×¦×¨ ×‘×”×¦×œ×—×”: ${table.name}`);
					} else {
						console.log(`â„¹ï¸ ×§×™×™× ×›×‘×¨: ${table.name}`);
					}
				}
				
				if (createdCount > 0) {
					showToast(`âœ… × ×•×¦×¨×• ${createdCount} ×˜×‘×œ××•×ª ×—×“×©×•×ª!`, 'success');
				} else {
					console.log('âœ… ×›×œ ×”×˜×‘×œ××•×ª ×›×‘×¨ ×§×™×™××•×ª');
				}
				
				return true;
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×˜×‘×œ××•×ª ×”×—×“×©×•×ª:', error);
				showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×‘×œ××•×ª ×—×“×©×•×ª', 'error');
				return false;
			}
		}

		// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×œ×˜×‘×œ××•×ª ×”×—×“×©×•×ª
		async function addHeadersToNewTable(tableName) {
			let headers = [];
			
			switch (tableName) {
				case 'TelegramVisits':
					headers = [
						'ID', 'date', 'time', 'client_name', 'visit_type', 
						'work_done', 'duration_minutes', 'raw_text', 'processed', 'created_at'
					];
					break;
					
				case 'TelegramIncomes':
					headers = [
						'ID', 'date', 'time', 'client_address', 'amount', 'payment_method',
						'notes', 'raw_text', 'matched_to_visit', 'visit_ids', 'processed', 'created_at'
					];
					break;
					
				case 'Payments':
					headers = [
						'ID', 'date', 'time', 'amount', 'payment_method', 'source_type',
						'client_id', 'notes', 'status', 'created_at'
					];
					break;
					
				case 'PaymentVisitLink':
					headers = [
						'ID', 'payment_id', 'visit_id', 'amount_allocated', 'link_type', 'created_at'
					];
					break;
			}
			
			if (headers.length > 0) {
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `${tableName}!A1:${String.fromCharCode(64 + headers.length)}1`,
					valueInputOption: 'RAW',
					resource: { values: [headers] }
				});
			}
		}

		// ===== ×¤×•× ×§×¦×™×•×ª ×©××™×¨×” ×œ×˜×‘×œ××•×ª ×”×—×“×©×•×ª =====

		// ×©××™×¨×ª ×‘×™×§×•×¨×™× ××˜×œ×’×¨× ×œ×˜×‘×œ×ª TelegramVisits
		async function saveTelegramVisitsToCloud(telegramVisits) {
			if (!access_token || !SPREADSHEET_ID || !telegramVisits || telegramVisits.length === 0) {
				return false;
			}
			
			try {
				console.log('ğŸ’¾ ×©×•××¨ ×‘×™×§×•×¨×™ ×˜×œ×’×¨×...');
				
				// ×•×“× ×©×”×˜×‘×œ×” ×§×™×™××ª
				await ensureNewTablesExist();
				
				// ×”×›×Ÿ × ×ª×•× ×™× ×œ×©××™×¨×”
				const rows = telegramVisits.map(visit => [
					visit.ID || generateID(),
					visit.date,
					visit.time || '',
					visit.client_name,
					visit.visit_type || 'general',
					visit.work_done,
					visit.duration_minutes || 60,
					visit.raw_text || '',
					false, // processed
					new Date().toISOString()
				]);
				
				// ×©××•×¨ ×œ×˜×‘×œ×”
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'TelegramVisits!A:J',
					valueInputOption: 'USER_ENTERED',
					resource: { values: rows }
				});
				
				console.log(`âœ… × ×©××¨×• ${telegramVisits.length} ×‘×™×§×•×¨×™ ×˜×œ×’×¨×`);
				return true;
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×©××™×¨×ª ×‘×™×§×•×¨×™ ×˜×œ×’×¨×:', error);
				return false;
			}
		}

		// ×˜×¢×™× ×ª ×‘×™×§×•×¨×™× ××˜×œ×’×¨× ××”×¢×œ× ×Ÿ
		async function loadTelegramVisitsFromCloud() {
			if (!access_token || !SPREADSHEET_ID) {
				return [];
			}
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'TelegramVisits!A2:J1000'
				});
				
				if (!response.result.values) {
					return [];
				}
				
				return response.result.values.map(row => ({
					ID: row[0] || '',
					date: row[1] || '',
					time: row[2] || '',
					client_name: row[3] || '',
					visit_type: row[4] || '',
					work_done: row[5] || '',
					duration_minutes: parseInt(row[6]) || 60,
					raw_text: row[7] || '',
					processed: row[8] === 'true' || row[8] === true,
					created_at: row[9] || ''
				}));
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×‘×™×§×•×¨×™ ×˜×œ×’×¨×:', error);
				return [];
			}
		}

		// ×˜×¢×™× ×ª ×”×›× ×¡×•×ª ××˜×œ×’×¨× ××”×¢×œ× ×Ÿ
		async function loadTelegramIncomesFromCloud() {
			if (!access_token || !SPREADSHEET_ID) {
				return [];
			}
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'TelegramIncomes!A2:L1000'
				});
				
				if (!response.result.values) {
					return [];
				}
				
				return response.result.values.map(row => ({
					ID: row[0] || '',
					date: row[1] || '',
					time: row[2] || '',
					client_address: row[3] || '',
					amount: parseFloat(row[4]) || 0,
					payment_method: row[5] || '',
					notes: row[6] || '',
					raw_text: row[7] || '',
					matched_to_visit: row[8] === 'true' || row[8] === true,
					visit_ids: row[9] ? row[9].split(',') : [],
					processed: row[10] === 'true' || row[10] === true,
					created_at: row[11] || ''
				}));
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×›× ×¡×•×ª ××˜×œ×’×¨×:', error);
				return [];
			}
		}

		// ===== ×¤×•× ×§×¦×™×•×ª ×œ×•×’×™×§×ª ×ª×©×œ×•××™× ×—×“×©×” =====

		// ××©×ª× ×™ ×’×œ×•×‘×œ×™×™× ×œ×ª×©×œ×•××™×
		let payments = [];
		let paymentVisitLinks = [];

		// ×‘×“×™×§×ª ×¡×˜×˜×•×¡ ×ª×©×œ×•× ×©×œ ×‘×™×§×•×¨
		function getVisitPaymentStatus(visitId) {
			if (!visitId) return 'unpaid';
			
			// ×—×¤×© ×§×™×©×•×¨×™× ×œ×‘×™×§×•×¨ ×”×–×”
			const visitLinks = paymentVisitLinks.filter(link => link.visit_id === visitId);
			
			if (visitLinks.length === 0) {
				return 'unpaid';
			}
			
			// ×‘×“×•×§ ×× ×™×© ×ª×©×œ×•××™× ××•×©×œ××™×
			const hasCompletedPayments = visitLinks.some(link => {
				const payment = payments.find(p => p.ID === link.payment_id);
				return payment && payment.status === 'completed';
			});
			
			return hasCompletedPayments ? 'paid' : 'unpaid';
		}

		// ×˜×§×¡×˜ ×¡×˜×˜×•×¡ ×ª×©×œ×•× ××¢×•×“×›×Ÿ
		function getPaymentStatusText(status) {
			switch (status) {
				case 'paid': return '×©×•×œ×';
				case 'unpaid': return '×œ× ×©×•×œ×';
				case 'partial': return '×©×•×œ× ×—×œ×§×™×ª';
				default: return '×œ× ×™×“×•×¢';
			}
		}

		// ×—×™×©×•×‘ ×¡×›×•× ×©×•×œ× ×¢×‘×•×¨ ×‘×™×§×•×¨
		function getVisitPaidAmount(visitId) {
			const visitLinks = paymentVisitLinks.filter(link => link.visit_id === visitId);
			
			let totalPaid = 0;
			visitLinks.forEach(link => {
				const payment = payments.find(p => p.ID === link.payment_id);
				if (payment && payment.status === 'completed') {
					totalPaid += parseFloat(link.amount_allocated) || 0;
				}
			});
			
			return totalPaid;
		}

		// ×¢×“×›×•×Ÿ ×¤×•× ×§×¦×™×™×ª ×—×™×©×•×‘ ×—×•×‘×•×ª
		function displayDebts() {
			const sortBy = document.getElementById('debtSortBy').value;
			const minAmount = parseFloat(document.getElementById('minDebtAmount').value) || 0;
			
			// ×—×™×©×•×‘ ×—×•×‘×•×ª ×œ×›×œ ×œ×§×•×— - ×¢×œ ×‘×¡×™×¡ ×”×¤×¨×© ×‘×™×Ÿ amount ×œ×ª×©×œ×•××™×
			const debtsByLocation = {};
			
			visits.forEach(visit => {
				if (visit.amount > 0) {
					const visitAmount = parseFloat(visit.amount) || 0;
					const paidAmount = getVisitPaidAmount(visit.ID);
					const debt = visitAmount - paidAmount;
					
					if (debt > 0) { // ×™×© ×—×•×‘
						if (!debtsByLocation[visit.location_id]) {
							const location = locations.find(loc => loc.ID === visit.location_id);
							debtsByLocation[visit.location_id] = {
								location: location,
								totalDebt: 0,
								visits: []
							};
						}
						
						debtsByLocation[visit.location_id].totalDebt += debt;
						debtsByLocation[visit.location_id].visits.push({
							...visit,
							debt: debt,
							paidAmount: paidAmount
						});
					}
				}
			});
			
			// ×”××©×š ×”×¤×•× ×§×¦×™×” ×›××• ×§×•×“×...
			const debtsArray = Object.values(debtsByLocation)
				.filter(debt => debt.totalDebt >= minAmount);
			
			// ××™×•×Ÿ
			debtsArray.sort((a, b) => {
				switch (sortBy) {
					case 'amount_desc': return b.totalDebt - a.totalDebt;
					case 'amount_asc': return a.totalDebt - b.totalDebt;
					case 'name': return a.location.name.localeCompare(b.location.name);
					default: return b.totalDebt - a.totalDebt;
				}
			});
			
			// ×”×¦×’×”...
			const tbody = document.getElementById('debtsTableBody');
			tbody.innerHTML = '';
			
			debtsArray.forEach(debt => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${debt.location.name}</td>
					<td>${debt.location.full_address}</td>
					<td>â‚ª${debt.totalDebt.toLocaleString()}</td>
					<td>${debt.visits.length}</td>
					<td>
						<button onclick="markAllDebtsPaid('${debt.location.ID}')" class="btn btn-success btn-sm">
							×¡××Ÿ ×›×©×•×œ×
						</button>
					</td>
				`;
				tbody.appendChild(row);
			});
		}

		// ×˜×¢×™× ×ª ×ª×©×œ×•××™× ×•×§×™×©×•×¨×™× ××”×¢× ×Ÿ
		async function loadPaymentsFromCloud() {
			if (!access_token || !SPREADSHEET_ID) {
				return;
			}
			
			try {
				// ×˜×¢×Ÿ ×ª×©×œ×•××™×
				const paymentsResponse = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Payments!A2:J1000'
				});
				
				if (paymentsResponse.result.values) {
					payments = paymentsResponse.result.values.map(row => ({
						ID: row[0] || '',
						date: row[1] || '',
						time: row[2] || '',
						amount: parseFloat(row[3]) || 0,
						payment_method: row[4] || '',
						source_type: row[5] || '',
						client_id: row[6] || '',
						notes: row[7] || '',
						status: row[8] || 'completed',
						created_at: row[9] || ''
					}));
				}
				
				// ×˜×¢×Ÿ ×§×™×©×•×¨×™×
				const linksResponse = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'PaymentVisitLink!A2:F1000'
				});
				
				if (linksResponse.result.values) {
					paymentVisitLinks = linksResponse.result.values.map(row => ({
						ID: row[0] || '',
						payment_id: row[1] || '',
						visit_id: row[2] || '',
						amount_allocated: parseFloat(row[3]) || 0,
						link_type: row[4] || '',
						created_at: row[5] || ''
					}));
				}
				
				console.log(`âœ… × ×˜×¢× ×• ${payments.length} ×ª×©×œ×•××™× ×•-${paymentVisitLinks.length} ×§×™×©×•×¨×™×`);
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×©×œ×•××™×:', error);
			}
		}


		// ===== ×¤×•× ×§×¦×™×•×ª ×˜×™×¤×•×œ ×‘×ª×©×œ×•××™× ===== 

		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×¡×™××•×Ÿ ×—×•×‘×•×ª ×›×©×•×œ××™×
		async function markAllDebtsPaid(locationId) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) {
				showToast('×œ×§×•×— ×œ× × ××¦×', 'error');
				return;
			}
			
			// ××¦× ×›×œ ×”×‘×™×§×•×¨×™× ×”×œ× ×©×•×œ××™× ×©×œ ×”×œ×§×•×—
			const unpaidVisits = visits.filter(visit => {
				if (visit.location_id !== locationId || !visit.amount || visit.amount <= 0) {
					return false;
				}
				
				const paidAmount = getVisitPaidAmount(visit.ID);
				const debt = parseFloat(visit.amount) - paidAmount;
				return debt > 0;
			});
			
			if (unpaidVisits.length === 0) {
				showToast('××™×Ÿ ×—×•×‘×•×ª ×¤×ª×•×—×™× ×œ×œ×§×•×— ×–×”', 'info');
				return;
			}
			
			const totalDebt = unpaidVisits.reduce((sum, visit) => {
				const paidAmount = getVisitPaidAmount(visit.ID);
				return sum + (parseFloat(visit.amount) - paidAmount);
			}, 0);
			
			if (confirm(`×œ×¡××Ÿ ××ª ×›×œ ×”×—×•×‘×•×ª ×©×œ ${location.name} ×›××¡×•×œ×§×™×?\n\n×¡×”"×›: â‚ª${totalDebt.toLocaleString()}\n××¡×¤×¨ ×˜×™×¤×•×œ×™×: ${unpaidVisits.length}`)) {
				
				try {
					showLoading('×™×•×¦×¨ ×ª×©×œ×•× ×•××¢×“×›×Ÿ ××¢×¨×›×ª...');
					
					// ×¦×•×¨ ×ª×©×œ×•× ××—×“ ×¢×‘×•×¨ ×›×œ ×”×—×•×‘×•×ª
					const payment = {
						ID: generateID(),
						date: new Date().toISOString().split('T')[0],
						time: new Date().toTimeString().substr(0, 5),
						amount: totalDebt,
						payment_method: 'cash',
						source_type: 'debt_settlement',
						client_id: locationId,
						notes: `×¡×™×œ×•×§ ×—×•×‘×•×ª - ${unpaidVisits.length} ×˜×™×¤×•×œ×™×`,
						status: 'completed',
						created_at: new Date().toISOString()
					};
					
					// ×”×•×¡×£ ×ª×©×œ×•× ×œ××¢×¨×›×ª
					payments.push(payment);
					
					// ×¦×•×¨ ×§×™×©×•×¨×™× ×œ×›×œ ×”×‘×™×§×•×¨×™×
					for (const visit of unpaidVisits) {
						const paidAmount = getVisitPaidAmount(visit.ID);
						const debtAmount = parseFloat(visit.amount) - paidAmount;
						
						if (debtAmount > 0) {
							const link = {
								ID: generateID(),
								payment_id: payment.ID,
								visit_id: visit.ID,
								amount_allocated: debtAmount,
								link_type: 'debt_settlement',
								created_at: new Date().toISOString()
							};
							
							paymentVisitLinks.push(link);
						}
					}
					
					// ×©××™×¨×” ××§×•××™×ª
					saveToLocalStorage();
					
					// ×©××™×¨×” ×‘×¢× ×Ÿ
					if (access_token && SPREADSHEET_ID) {
						await savePaymentToCloud(payment);
						
						// ×©××•×¨ ××ª ×›×œ ×”×§×™×©×•×¨×™×
						for (const link of paymentVisitLinks.filter(l => l.payment_id === payment.ID)) {
							await savePaymentVisitLinkToCloud(link);
						}
					}
					
					hideLoading();
					
					// ×¨×¢× ×•×Ÿ ×”×ª×¦×•×’×”
					displayDebts();
					
					showToast(`×”×—×•×‘×•×ª ×©×œ ${location.name} ×¡×•×× ×• ×›××¡×•×œ×§×™×!
		ğŸ’° â‚ª${totalDebt.toLocaleString()} ×¡×•×œ×§×•
		ğŸ“‹ ${unpaidVisits.length} ×˜×™×¤×•×œ×™× ×¢×•×“×›× ×•`, 'success', 5000);
					
				} catch (error) {
					hideLoading();
					console.error('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×ª×©×œ×•××™×:', error);
					showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×ª×©×œ×•××™×', 'error');
				}
			}
		}

		// ×©××™×¨×ª ×ª×©×œ×•× ×œ×¢× ×Ÿ
		async function savePaymentToCloud(payment) {
			if (!access_token || !SPREADSHEET_ID) {
				return false;
			}
			
			try {
				await ensureNewTablesExist();
				
				const row = [
					payment.ID,
					payment.date,
					payment.time,
					payment.amount,
					payment.payment_method,
					payment.source_type,
					payment.client_id,
					payment.notes,
					payment.status,
					payment.created_at
				];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Payments!A:J',
					valueInputOption: 'USER_ENTERED',
					resource: { values: [row] }
				});
				
				console.log(`âœ… ×©××¨ ×ª×©×œ×•× ${payment.ID} ×‘×¢× ×Ÿ`);
				return true;
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×©××™×¨×ª ×ª×©×œ×•×:', error);
				return false;
			}
		}

		// ×©××™×¨×ª ×§×™×©×•×¨ ×ª×©×œ×•×-×‘×™×§×•×¨ ×œ×¢× ×Ÿ
		async function savePaymentVisitLinkToCloud(link) {
			if (!access_token || !SPREADSHEET_ID) {
				return false;
			}
			
			try {
				const row = [
					link.ID,
					link.payment_id,
					link.visit_id,
					link.amount_allocated,
					link.link_type,
					link.created_at
				];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'PaymentVisitLink!A:F',
					valueInputOption: 'USER_ENTERED',
					resource: { values: [row] }
				});
				
				console.log(`âœ… ×©××¨ ×§×™×©×•×¨ ×ª×©×œ×•×-×‘×™×§×•×¨ ${link.ID}`);
				return true;
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×©××™×¨×ª ×§×™×©×•×¨:', error);
				return false;
			}
		}

   </script>
</body>
</html>
