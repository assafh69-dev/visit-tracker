<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול טיפולים ולקוחות</title>
	
	<script src="https://apis.google.com/js/api.js"></script>
	<script src="https://accounts.google.com/gsi/client"></script>
	
    <style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			direction: rtl;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}

		/* Header מעוצב */
		.header {
			background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
			border-radius: 15px;
			padding: 30px;
			margin-bottom: 20px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.3);
			color: white;
		}

		.header h1 {
			font-size: 2.5em;
			margin-bottom: 10px;
			text-align: center;
			text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
			background: linear-gradient(45deg, #3498db, #2ecc71);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}

		/* Connection Status מעוצב */
		.connection-status {
			text-align: center;
			margin: 20px 0;
			padding: 20px;
			background: rgba(255,255,255,0.1);
			border-radius: 15px;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255,255,255,0.2);
		}

		.connect-btn {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 12px 24px;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			margin: 5px;
			transition: all 0.3s ease;
			box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
		}

		.connect-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
		}

		.connect-btn:disabled {
			background: #95a5a6;
			cursor: not-allowed;
			transform: none;
		}

		/* Navigation מעוצב */
		.nav-buttons {
			display: flex;
			gap: 15px;
			justify-content: center;
			flex-wrap: wrap;
			margin-top: 20px;
		}

		.nav-btn {
			padding: 15px 25px;
			border: none;
			background: rgba(255,255,255,0.1);
			color: white;
			border-radius: 10px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255,255,255,0.2);
		}

		.nav-btn:hover {
			background: rgba(255,255,255,0.2);
			transform: translateY(-2px);
		}

		.nav-btn.active {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
			transform: translateY(-2px);
		}

		/* Main Content מעוצב */
		.main-content {
			background: rgba(255,255,255,0.95);
			border-radius: 15px;
			padding: 30px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.2);
			backdrop-filter: blur(10px);
		}

		.section {
			display: none;
		}

		.section.active {
			display: block;
		}

		.section h2 {
			color: #2c3e50;
			margin-bottom: 30px;
			padding-bottom: 15px;
			border-bottom: 3px solid #3498db;
			font-size: 1.8em;
			position: relative;
		}

		.section h2::before {
			content: '';
			position: absolute;
			bottom: -3px;
			left: 0;
			width: 60px;
			height: 3px;
			background: linear-gradient(45deg, #e74c3c, #f39c12);
			border-radius: 2px;
		}

		/* Forms מעוצבים */
		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			margin-bottom: 8px;
			color: #2c3e50;
			font-weight: bold;
			font-size: 14px;
		}

		.form-group input, .form-group select, .form-group textarea {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #e9ecef;
			border-radius: 8px;
			font-size: 14px;
			transition: all 0.3s ease;
			background: white;
		}

		.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
			transform: translateY(-1px);
		}

		/* Buttons מעוצבים */
		.add-btn {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
			border: none;
			padding: 15px 30px;
			border-radius: 10px;
			cursor: pointer;
			margin-bottom: 20px;
			font-size: 16px;
			font-weight: bold;
			transition: all 0.3s ease;
			box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
		}

		.add-btn:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
		}

		.action-btn {
			padding: 8px 16px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 12px;
			margin: 0 3px;
			transition: all 0.3s ease;
			font-weight: bold;
		}

		.edit-btn {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
		}

		.edit-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
		}

		.delete-btn {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			color: white;
		}

		.delete-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
		}

		/* Tables מעוצבות */
		.table-container {
			background: white;
			border-radius: 12px;
			overflow: hidden;
			box-shadow: 0 8px 25px rgba(0,0,0,0.15);
			margin-top: 20px;
		}

		.data-table {
			width: 100%;
			border-collapse: collapse;
			background: white;
		}

		.data-table thead {
			background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
			color: white;
		}

		.data-table th {
			padding: 15px 12px;
			text-align: right;
			font-weight: bold;
			border-bottom: 2px solid #3498db;
		}

		.data-table td {
			padding: 12px;
			border-bottom: 1px solid #ecf0f1;
			transition: background 0.3s ease;
		}

		.data-table tbody tr:hover {
			background: #f8f9fa;
			transform: scale(1.01);
		}

		.data-table tbody tr:nth-child(even) {
			background: #fbfcfd;
		}

		/* Filter Panels מעוצבים */
		.filter-panel, .info-panel {
			background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%);
			border: 2px solid #95a5a6;
			border-radius: 12px;
			margin-bottom: 20px;
			overflow: hidden;
			box-shadow: 0 5px 15px rgba(0,0,0,0.1);
		}

		.filter-header, .info-header {
			background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
			padding: 15px 20px;
			cursor: pointer;
			color: white;
			transition: all 0.3s ease;
			border-bottom: 2px solid #3498db;
		}

		.filter-header:hover, .info-header:hover {
			background: linear-gradient(135deg, #4a6741 0%, #2c3e50 100%);
		}

		.filter-content, .info-content {
			padding: 25px;
			display: block;
			background: white;
		}

		.filter-content.collapsed, .info-content.collapsed {
			display: none;
		}

		/* Submit Button מעוצב */
		button[type="submit"] {
			width: 100%;
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 18px;
			border-radius: 10px;
			cursor: pointer;
			font-size: 18px;
			font-weight: bold;
			margin-top: 20px;
			transition: all 0.3s ease;
			box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
		}

		button[type="submit"]:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
		}

		/* Mobile Responsive */
		@media (max-width: 768px) {
			.container {
				padding: 10px;
			}
			
			.header {
				padding: 20px 15px;
			}
			
			.header h1 {
				font-size: 1.8em;
			}
			
			.nav-buttons {
				gap: 8px;
			}
			
			.nav-btn {
				padding: 12px 16px;
				font-size: 12px;
			}
			
			.main-content {
				padding: 20px 15px;
			}
		}

		/* Toast Notifications */
		.toast-container {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 1000;
			max-width: 300px;
		}

		.toast {
			background: linear-gradient(45deg, #2c3e50, #3498db);
			color: white;
			padding: 15px 20px;
			border-radius: 8px;
			margin-bottom: 10px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
			transform: translateX(400px);
			opacity: 0;
			transition: all 0.3s ease;
			border-right: 4px solid #27ae60;
			font-weight: bold;
		}

		.toast.success {
			border-right-color: #27ae60;
			background: linear-gradient(45deg, #27ae60, #2ecc71);
		}

		.toast.error {
			border-right-color: #e74c3c;
			background: linear-gradient(45deg, #e74c3c, #c0392b);
		}

		.toast.warning {
			border-right-color: #f39c12;
			background: linear-gradient(45deg, #f39c12, #e67e22);
		}

		.toast.info {
			border-right-color: #3498db;
			background: linear-gradient(45deg, #3498db, #2980b9);
		}

		.toast.show {
			transform: translateX(0);
			opacity: 1;
		}

		@media (max-width: 768px) {
			.toast-container {
				left: 10px;
				right: 10px;
				top: 10px;
				max-width: none;
			}
			
			.toast {
				transform: translateY(-100px);
			}
			
			.toast.show {
				transform: translateY(0);
			}
		}
		

		/* כפתורים כלליים */
		.btn {
			padding: 12px 20px;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			box-shadow: 0 3px 10px rgba(0,0,0,0.2);
			min-width: 120px;
		}

		.btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(0,0,0,0.3);
		}

		.btn-primary {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
		}

		.btn-success {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
		}

		.btn-warning {
			background: linear-gradient(45deg, #f39c12, #e67e22);
			color: white;
		}

		.btn-secondary {
			background: linear-gradient(45deg, #95a5a6, #7f8c8d);
			color: white;
		}

		.btn-info {
			background: linear-gradient(45deg, #17a2b8, #138496);
			color: white;
		}

		/* כפתורי פילטר */
		.filter-btn {
			padding: 10px 18px;
			border: 2px solid #3498db;
			background: linear-gradient(45deg, #ecf0f1, #bdc3c7);
			color: #2c3e50;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			min-width: 100px;
		}

		.filter-btn:hover {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
		}

		.filter-btn.active {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
		}

		/* רשימות נפתחות */
		select, .form-group select {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			cursor: pointer;
			min-height: 45px;
		}

		select:focus, .form-group select:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		select:hover {
			border-color: #7f8c8d;
			background: white;
		}

		/* שדות תאריך */
		input[type="date"] {
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			min-height: 45px;
		}

		input[type="date"]:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		/* כפתורי פעולות פילטר */
		.filter-actions .btn {
			margin: 5px 8px;
			padding: 10px 20px;
			font-size: 14px;
			min-width: 100px;
		}

		/* כפתורי ייבוא במערכת */
		.form-section .btn {
			margin: 8px 5px;
			padding: 12px 20px;
			font-size: 14px;
			font-weight: bold;
			min-width: 150px;
		}

		/* שיפור נוסף לכפתורים קטנים */
		.action-btn {
			padding: 10px 16px;
			font-size: 13px;
			font-weight: bold;
			min-width: 80px;
		}

		/* כפתורים מוקפצים (disabled) */
		button:disabled, .btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none !important;
			box-shadow: none !important;
		}

		/* שיפור לתיבות טקסט */
		input[type="text"], input[type="number"], textarea {
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			min-height: 45px;
		}

		input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		/* שיפור לכותרות בפאנלים */
		.filter-header h3, .info-header h3 {
			font-size: 16px;
			font-weight: bold;
			margin: 0;
			text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
		}

		/* מובייל - התאמות */
		@media (max-width: 768px) {
			.btn {
				padding: 10px 15px;
				font-size: 13px;
				min-width: 100px;
			}
			
			select, input[type="date"], input[type="text"], input[type="number"] {
				padding: 10px 12px;
				font-size: 13px;
				min-height: 40px;
			}
		}
		
		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
		}

		.stat-item {
			background: rgba(255,255,255,0.7);
			padding: 15px;
			border-radius: 8px;
			border-left: 4px solid #27ae60;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			backdrop-filter: blur(5px);
		}

		.stat-label {
			display: block;
			font-weight: bold;
			color: #495057;
			margin-bottom: 5px;
			font-size: 14px;
		}

		.stat-value {
			font-size: 1.4em;
			font-weight: bold;
			color: #2c3e50;
		}

		@media (max-width: 768px) {
			.stats-grid {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		.debt-card .summary-value {
			color: #e74c3c !important;
			font-weight: bold;
		}

		.debts-table tr:hover {
			background-color: #f8f9fa !important;
		}

		.action-btn {
			margin: 1px;
			padding: 4px 8px;
			font-size: 12px;
			border-radius: 3px;
			border: none;
			color: white;
			cursor: pointer;
		}

		.action-btn:hover {
			opacity: 0.8;
		}

		#statusText {
			transition: all 0.3s ease;
			padding: 8px 12px;
			border-radius: 6px;
			font-size: 14px;
		}

		#statusText.connected {
			background: linear-gradient(45deg, #28a745, #20c997);
			color: white;
			box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
		}


		/* תצוגת תכנון - שורות כפולות */
			.planning-cards-container {
				min-height: 300px;
				border: 2px dashed #ddd;
				border-radius: 10px;
				padding: 15px;
				background: #fafafa;
				margin-bottom: 20px;
			}

			.planning-client-row {
				background: white;
				border-radius: 8px;
				margin-bottom: 12px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
				transition: all 0.3s ease;
			}

			.planning-client-row:hover {
				transform: translateY(-1px);
				box-shadow: 0 4px 8px rgba(0,0,0,0.15);
			}

			/***************************************************************/	
			/* צבעי רמזור */
			/* צבעי סטטוס משופרים לתכנון */
			.planning-status-green { 
				border-right: 4px solid #27ae60;
				background: linear-gradient(90deg, rgba(39, 174, 96, 0.1), white);
			}

			.planning-status-yellow { 
				border-right: 4px solid #f39c12;
				background: linear-gradient(90deg, rgba(243, 156, 18, 0.1), white);
			}

			.planning-status-orange { 
				border-right: 4px solid #e67e22;
				background: linear-gradient(90deg, rgba(230, 126, 34, 0.1), white);
			}

			.planning-status-red { 
				border-right: 4px solid #e74c3c;
				background: linear-gradient(90deg, rgba(231, 76, 60, 0.1), white);
			}

			.planning-status-gray {
				border-right: 4px solid #95a5a6;
				background: linear-gradient(90deg, rgba(149, 165, 166, 0.1), white);
			}

			/* כפתור התחל טיפול מעוצב */
			.planning-complete {
				background: linear-gradient(45deg, #27ae60, #2ecc71);
				color: white;
				font-size: 14px;
				font-weight: bold;
				width: 36px;
				height: 36px;
			}

			.planning-complete:hover {
				background: linear-gradient(45deg, #219a52, #27ae60);
				transform: scale(1.05);
			}

			/* עיצוב משופר לכותרות יום בשבוע */
			.weekly-day-header {
				background: linear-gradient(45deg, #3498db, #2980b9);
				color: white;
				padding: 12px 15px;
				border-radius: 8px;
				margin-bottom: 12px;
				font-size: 15px;
				font-weight: bold;
				text-align: center;
				box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
			}
			
			
			
			
			/****************************************************************/
			.planning-row-main {
				display: flex;
				align-items: center;
				padding: 12px 15px;
				gap: 15px;
			}

			.planning-client-info {
				flex: 1;
				text-align: right;
			}

			.planning-client-name {
				font-weight: bold;
				font-size: 16px;
				color: #333;
				margin-bottom: 3px;
			}

			.planning-client-address {
				font-size: 12px;
				color: #666;
				margin-bottom: 3px;
			}

			.planning-client-date {
				font-size: 12px;
				color: #555;
				font-weight: 500;
			}

			.planning-client-price {
				font-weight: bold;
				color: #2196F3;
				font-size: 16px;
				min-width: 80px;
				text-align: center;
			}

			.planning-client-actions {
				display: flex;
				gap: 8px;
			}

			.planning-action-btn {
				width: 32px;
				height: 32px;
				border: none;
				border-radius: 50%;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 12px;
				transition: all 0.3s ease;
			}

			
			.planning-postpone {
				background: #FF9800;
				color: white;
			}

			.planning-menu {
				background: #607D8B;
				color: white;
			}

			.planning-action-btn:hover {
				transform: scale(1.1);
			}

			.planning-row-details {
				background: #f8f9fa;
				padding: 8px 15px 12px 15px;
				border-top: 1px solid #e9ecef;
				font-size: 13px;
			}

			.client-requests {
				color: #0066cc;
				margin-bottom: 4px;
				font-weight: 500;
			}

			.client-notes {
				color: #666;
				font-style: italic;
			}

			/* מובייל */
			@media (max-width: 768px) {
				.planning-row-main {
					flex-direction: column;
					align-items: stretch;
					gap: 10px;
				}
				
				.planning-client-info {
					text-align: center;
				}
				
				.planning-client-actions {
					justify-content: center;
				}
				
				.planning-action-btn {
					width: 40px;
					height: 40px;
					font-size: 14px;
				}
			}

			/* שאר הסטיילים הקיימים נשארים */
			.planning-date-header {
				text-align: center;
				background: linear-gradient(45deg, #3498db, #2980b9); /* שינוי מירוק לכחול */
				color: white;
				padding: 15px;
				border-radius: 10px;
				margin-bottom: 20px;
				box-shadow: 0 4px 6px rgba(52, 152, 219, 0.3); /* עדכון צל לכחול */
			}

			.planning-tab-btn.active {
				background: #3498db; /* שינוי מירוק לכחול */
				color: white;
				border-color: #3498db;
			}

			.planning-view-tabs {
				display: flex;
				justify-content: center;
				gap: 10px;
				margin-bottom: 20px;
			}

			.planning-tab-btn {
				padding: 10px 20px;
				border: 2px solid #ddd;
				background: white;
				border-radius: 25px;
				cursor: pointer;
				transition: all 0.3s ease;
				font-weight: bold;
			}


		/***************************************/
		/* ייבוא נתונים - כפתורים אחידים */
		.import-main-buttons {
			display: flex;
			justify-content: center;
			gap: 15px;
			margin: 15px 0;
			flex-wrap: wrap;
		}

		.import-other-buttons {
			display: flex;
			justify-content: center;
			margin: 15px 0;
		}

		.import-main-buttons button,
		.import-other-buttons button {
			padding: 12px 20px;
			background: #ffc107;
			color: #212529;
			border: 1px solid #ffc107;
			border-radius: 5px;
			font-weight: 500;
			font-size: 14px;
			cursor: pointer;
			transition: all 0.3s ease;
			min-width: 200px;
			white-space: nowrap;
		}

		.import-main-buttons button:hover,
		.import-other-buttons button:hover {
			background: #e0a800;
			border-color: #d39e00;
			transform: translateY(-1px);
			box-shadow: 0 4px 8px rgba(0,0,0,0.15);
		}

		/* כפתורי הייבוא החלקי */
		details[open] > div {
			display: flex !important;
			flex-wrap: wrap;
			gap: 8px;
			margin-top: 10px;
			justify-content: center;
		}

		details[open] > div button {
			flex: 1;
			min-width: 120px;
			max-width: 150px;
			font-size: 13px;
			padding: 10px 12px;
		}

		/* תגובה למובייל */
		@media (max-width: 768px) {
			.import-main-buttons {
				flex-direction: column;
				align-items: center;
			}
			
			.import-main-buttons button,
			.import-other-buttons button {
				min-width: 80%;
				max-width: 300px;
				padding: 15px 20px;
				font-size: 16px;
			}
			
			details[open] > div {
				flex-direction: column;
			}
			
			details[open] > div button {
				min-width: 80%;
				max-width: 250px;
				font-size: 14px;
			}
		}
		/***************************************/

		/* סטיילינג למצב שבועי */
		.weekly-day-section {
			margin-bottom: 25px;
		}

		.planning-empty-state {
			text-align: center;
			color: #666;
			padding: 40px 20px;
		}

		.planning-empty-state h3 {
			margin-bottom: 10px;
			color: #4CAF50;
		}


/***************************************/
/***************************************/

		/* עדכון CSS לכרטיסיות תכנון - מבנה דו-שורתי */
		.planning-row-details {
			background: #f8f9fa;
			padding: 8px 15px 12px 15px;
			border-top: 1px solid #e9ecef;
			font-size: 13px;
		}

		.client-requests {
			color: #0066cc;
			margin-bottom: 4px;
			font-weight: 500;
		}

		.client-notes {
			color: #666;
			font-style: italic;
		}

		.planning-active-toggle {
			margin-right: 5px;
		}

		.planning-history-btn {
			background: #6c757d;
			color: white;
			border: none;
			padding: 6px 10px;
			border-radius: 4px;
			font-size: 11px;
			cursor: pointer;
		}

		.planning-history-btn:hover {
			background: #5a6268;
		}

/***************************************/

		/* תיקון CSS לכפתורי הפעולה החדשים */
		.planning-client-actions {
			display: flex;
			gap: 5px;
			align-items: center;
			flex-wrap: wrap;
		}

		.planning-date-input {
			padding: 4px 6px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 11px;
			width: 100px;
			background: white;
		}

		.planning-active-toggle {
			padding: 4px 6px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 11px;
			background: white;
			width: 70px;
		}

		.planning-history-btn {
			background: #6c757d;
			color: white;
			border: none;
			padding: 6px 8px;
			border-radius: 4px;
			font-size: 11px;
			cursor: pointer;
			min-width: 35px;
		}

		.planning-history-btn:hover {
			background: #5a6268;
		}

		/* תגובה למובייל */
		@media (max-width: 768px) {
			.planning-client-actions {
				justify-content: center;
				gap: 3px;
			}
			
			.planning-date-input,
			.planning-active-toggle {
				font-size: 10px;
				width: auto;
				min-width: 60px;
			}
		}
		
		/* טאבי ימים */
		.days-tabs-container {
			margin-bottom: 20px;
		}

		.days-tabs {
			display: flex;
			gap: 5px;
			margin-bottom: 15px;
			flex-wrap: wrap;
			justify-content: center;
		}

		.day-tab-btn {
			padding: 10px 15px;
			border: 2px solid #ddd;
			background: white;
			border-radius: 20px;
			cursor: pointer;
			font-size: 13px;
			font-weight: bold;
			transition: all 0.3s ease;
			min-width: 100px;
		}

		.day-tab-btn:hover {
			background: #f8f9fa;
			border-color: #3498db;
		}

		.day-tab-btn.active {
			background: #3498db;
			color: white;
			border-color: #3498db;
		}

		.days-content {
			min-height: 200px;
		}

		.day-content {
			display: none;
		}

		.day-content.active {
			display: block;
		}
		
		
		/* תגובה למובייל לטאבי ימים */
		@media (max-width: 768px) {
			.days-tabs {
				flex-direction: column;
				align-items: center;
				gap: 8px;
			}
			
			.day-tab-btn {
				min-width: 80%;
				max-width: 250px;
				padding: 12px 20px;
				font-size: 14px;
			}
			
			.days-content {
				min-height: 150px;
			}
		}

		/* אנימציה חלקה לתוכן הימים */
		.day-content {
			opacity: 0;
			transition: opacity 0.3s ease;
		}

		.day-content.active {
			display: block;
			opacity: 1;
		}

		/* שיפור לכותרת המכיל */
		.days-tabs-container {
			background: rgba(255,255,255,0.7);
			border-radius: 12px;
			padding: 15px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
		}

	</style>
   
</head>
<body>
	<!-- Toast Container -->
	<div id="toastContainer" class="toast-container"></div>
    <div class="container">
        <header class="header">
            <h1>טיפולים</h1>
			<div id="connectionStatus" class="connection-status">
				<button onclick="connectToGoogleSheets()" id="connectBtn" class="connect-btn">
					התחבר ל-Google Sheets
				</button>
				<button onclick="saveAllToSheets()" id="saveBtn" class="connect-btn" disabled>
					שמור לענן
				</button>
				<button onclick="loadAllFromSheets()" id="loadBtn" class="connect-btn" disabled>
					טען מהענן
				</button>
				<span id="statusText" style="color: white; font-weight: bold; font-size: 16px;">לא מחובר</span>
				<div id="lastSaved" style="font-size: 12px; color: white; margin-top: 4px;"></div>
			</div>
            <nav class="nav-buttons">
				<button onclick="showSection('planning')" class="nav-btn active">תכנון יומי</button>
				<button onclick="showSection('visit')" class="nav-btn">טיפול חדש</button>
				<button onclick="showSection('history')" class="nav-btn">טיפולים</button> 
				<button onclick="showSection('locations')" class="nav-btn">לקוחות</button>
				<button onclick="showSection('receipts')" class="nav-btn">קבלות</button>
				<button onclick="showSection('debts')" class="nav-btn">💰 חובות</button>
				<button onclick="showSection('system')" class="nav-btn">מערכת v2.1</button>
			</nav>
        </header>

        <main class="main-content">
            <!-- Planning Section -->
			<section id="planning" class="section active">
				<h2>📅 תכנון יומי ושבועי</h2>
            
            <!-- כותרת תאריך -->
            <div class="planning-date-header">
                <h3 id="planningDateTitle">היום - רביעי</h3>
                <p id="planningDateFormatted">28 בנובמבר 2024</p>
            </div>

            <!-- טאבים -->
            <div class="planning-view-tabs">
                <button class="planning-tab-btn active" onclick="switchPlanningView('daily')">יומי</button>
                <button class="planning-tab-btn" onclick="switchPlanningView('weekly')">שבועי</button>
                <button class="planning-tab-btn" onclick="switchPlanningView('overdue')">מאוחרות</button>
            </div>

            <!-- כרטיסי לקוחות -->
            <div class="planning-cards-container" id="planningCardsContainer">
                <!-- כרטיסים יטענו כאן דינמית -->
            </div>

            <!-- סטטיסטיקות (שמירה על הקיים) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                <div style="background: rgba(52, 152, 219, 0.1); border: 2px solid #3498db; border-radius: 8px; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 13px; color: #2c3e50;">לקוחות:</span>
                        <span id="totalLocations" style="font-weight: bold; color: #2c3e50;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 13px; color: #2c3e50;">פעילים:</span>
                        <span id="activeLocations" style="font-weight: bold; color: #27ae60;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: #2c3e50;">טיפולים השבוע:</span>
                        <span id="weeklyVisits" style="font-weight: bold; color: #2c3e50;">0</span>
                    </div>
                </div>
                
                <div style="background: rgba(39, 174, 96, 0.1); border: 2px solid #27ae60; border-radius: 8px; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 13px; color: #2c3e50;">הכנסה השבוע:</span>
                        <span id="weeklyIncome" style="font-weight: bold; color: #27ae60;">₪0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: #2c3e50;">חובות פתוחים:</span>
                        <span id="openDebts" style="font-weight: bold; color: #e74c3c;">₪0</span>
                    </div>
                </div>
            </div>
			</section>

            <!-- VisitSection -->
            <section id="visit" class="section">
                <h2>טיפול חדש</h2>
                <div class="form-container">
                    <form id="visitForm">
                        <div class="form-group">
							<label for="locationSelect">בחר לקוח:</label>
							<select id="locationSelect" required>
								<option value="">בחר לקוח...</option>
							</select>
						</div>

						<!-- הוסף כאן -->
						<div class="form-group">
							<label for="visitDate">תאריך טיפול:</label>
							<input type="date" id="visitDate" required>
						</div>

						<div class="form-group">
							<label for="visitTime">שעת התחלה:</label>
							<input type="time" id="visitTime" required>
						</div>
						
						<div class="form-group">
							<label for="endTime">שעת סיום:</label>
							<input type="time" id="endTime">
						</div>
						
                        <div class="form-group">
                            <label for="visitType">סוג טיפול:</label>
                            <select id="visitType" required>
                                <option value="מלא">מלא</option>
                                <option value="חלקי">חלקי</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="workDone">מה בוצע:</label>
                            <textarea id="workDone" placeholder="תיאור העבודה שבוצעה"></textarea>
                        </div>
                        <div class="form-group">
							<label for="manualDurationMinutes">משך הטיפול (דקות):</label>
							<div style="display: flex; gap: 10px; align-items: center;">
								<input type="number" id="manualDurationMinutes" placeholder="90" min="0" onchange="updateHoursDisplay()" style="flex: 1;">
								<span style="color: #666; font-size: 14px;">שעות:</span>
								<input type="text" id="calculatedHours" readonly style="width: 80px; background: #f8f9fa; color: #666; border: 2px solid #e9ecef; border-radius: 6px; padding: 8px; text-align: center;" placeholder="1.5">
							</div>
						</div>
                        <div class="form-group">
							<label for="numberOfWorkersVisit">מספר עובדים בטיפול:</label>
							<div style="display: flex; gap: 10px; align-items: center;">
								<input type="number" id="numberOfWorkersVisit" value="1" min="1" onchange="calculateTreatmentCost()" style="width: 80px;">
								<span style="color: #666; font-size: 14px;">עובדים (כולל אותך)</span>
							</div>
						</div>

						<div class="form-group">
							<label for="amount">סכום:</label>
							<div style="display: flex; gap: 10px; align-items: center;">
								<input type="number" id="amount" placeholder="סכום הטיפול" style="flex: 1;">
								<button type="button" onclick="calculateTreatmentCost()" style="background: #f39c12; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
									🔄 חשב
								</button>
							</div>
							<div id="costBreakdown" style="font-size: 12px; color: #666; margin-top: 5px;">
								<!-- כאן יופיע פירוט החישוב -->
							</div>
						</div>
                        <div class="form-group">
							<label for="expense">הוצאה:</label>
							<input type="number" id="expense" placeholder="הוצאות נילוות" onchange="calculateTreatmentCost()">
						</div>
						
						<div class="form-group">
							<label for="paymentStatus">סטטוס תשלום:</label>
							<select id="paymentStatus">
								<option value="0">לא שולם</option>
								<option value="1">שולם</option>
								<option value="2">ללא תשלום</option>
							</select>
						</div>
						
                        <button type="submit">שמור טיפול</button>
                    </form>
                </div>
            </section>

			<!-- History Section -->
			<section id="history" class="section">
				<h2>📋 טיפולים</h2>
				
				<!-- Filter Panel -->
				<div class="filter-panel">
					<div class="filter-header" onclick="toggleFilterPanel()">
						<h3>🔍 סינון טיפולים <span id="filterIcon">🔽</span></h3>
					</div>
					<div id="filterContent" class="filter-content">
						<div class="filter-row">
							<div class="filter-group">
								<label>לקוח:</label>
								<select id="filterLocation">
									<option value="">כל הלקוחות</option>
								</select>
							</div>
							<div class="filter-group">
								<label>סטטוס תשלום:</label>
								<select id="filterPayment">
									<option value="">הכל</option>
									<option value="כן">שולם</option>
									<option value="לא">לא שולם</option>
									<option value="ללא">ללא תשלום</option>
								</select>
							</div>
						</div>
						<div class="filter-row">
							<div class="filter-group">
								<label>מתאריך:</label>
								<input type="date" id="filterDateFrom">
							</div>
							<div class="filter-group">
								<label>עד תאריך:</label>
								<input type="date" id="filterDateTo">
							</div>
						</div>
						<div class="filter-actions">
							<button onclick="applyVisitFilters()" class="btn btn-primary">סנן</button>
							<button onclick="clearVisitFilters()" class="btn btn-secondary">נקה סינון</button>
						</div>
					</div>
				</div>

				<!-- Info Panel -->
				<div class="info-panel">
					<div class="info-header" onclick="toggleInfoPanel()">
						<h3>📊 מידע <span id="infoIcon">🔽</span></h3>
					</div>
					<div id="infoContent" class="info-content">
						<div class="info-grid">
							<div class="info-item">
								<span class="info-label">טיפולים מוצגים:</span>
								<span id="visitsCount" class="info-value">0</span>
							</div>
							<div class="info-item">
								<span class="info-label">סה"כ שעות:</span>
								<span id="totalHours" class="info-value">0</span>
							</div>
							<div class="info-item">
								<span class="info-label">סה"כ הכנסות:</span>
								<span id="totalIncome" class="info-value">₪0</span>
							</div>
							<div class="info-item">
								<span class="info-label">חובות פתוחים:</span>
								<span id="outstandingDebt" class="info-value">₪0</span>
							</div>
						</div>
					</div>
				</div>

				<!-- Visits Table -->
				<div class="table-container">
					<table id="visitsHistoryTable" class="data-table">
						<thead>
							<tr>
								<th>תאריך</th>
								<th>לקוח</th>
								<th>סוג טיפול</th>
								<th>עבודה שבוצעה</th>
								<th>משך (שעות)</th>
								<th>סכום</th>
								<th>שולם</th>
								<th>פעולות</th>
							</tr>
						</thead>
						<tbody id="visitsHistoryTableBody">
						</tbody>
					</table>
				</div>
			</section>

            <!-- locations Section -->
            <section id="locations" class="section">
                <h2>ניהול לקוחות</h2>
				<button onclick="showAddLocationForm()" class="add-btn">הוסף לקוח חדש</button>
                <div class="table-container">
                    <table id="locationsTable" class="data-table">
                        <thead>
                            <tr>
                                <th>שם</th>
                                <th>כתובת</th>
                                <th>איש קשר</th>
                                <th>יום מותר</th>
                                <th>מרווח</th>
                                <th>פעילה</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody id="locationsTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Receipts Section -->
            <section id="receipts" class="section">
                <h2>ניהול קבלות</h2>
                <button onclick="showAddReceiptForm()" class="add-btn">הוסף קבלה חדשה</button>
                <div class="table-container">
                    <table id="receiptsTable" class="data-table">
                        <thead>
							<tr>
								<th>פנקס</th>
								<th>קבלה</th>
								<th>תאריך</th>
								<th>בינה</th>
								<th>סכום</th>
								<th>סוג תשלום</th>
								<th>קודX</th>  
								<th>פעולות</th>
							</tr>
						</thead>
                        <tbody id="receiptsTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

			<section id="debts" class="section">
				<h2>💰 ניהול חובות</h2>
				
				<!-- סיכום כללי -->
				<div class="summary-cards">
					<div class="summary-card debt-card">
						<h3>סה"כ חובות</h3>
						<div id="totalDebt" class="summary-value">₪0</div>
					</div>
					<div class="summary-card">
						<h3>לקוחות חייבים</h3>
						<div id="debtorsCount" class="summary-value">0</div>
					</div>
					<div class="summary-card">
						<h3>חוב ממוצע</h3>
						<div id="averageDebt" class="summary-value">₪0</div>
					</div>
					<div class="summary-card">
						<h3>חוב הכי ישן</h3>
						<div id="oldestDebt" class="summary-value">-</div>
					</div>
				</div>
				
				<!-- רשימת חובות -->
				<div class="filter-panel">
					<div class="filter-header">
						<h3>🔍 חובות פתוחים</h3>
					</div>
					<div class="filter-row">
						<div class="filter-group">
							<label>מיון לפי:</label>
							<select id="debtSortBy" onchange="displayDebts()">
								<option value="amount_desc">סכום (גבוה לנמוך)</option>
								<option value="amount_asc">סכום (נמוך לגבוה)</option>
								<option value="date_old">תאריך (הכי ישן)</option>
								<option value="date_new">תאריך (הכי חדש)</option>
								<option value="location">לקוח (א-ב)</option>
							</select>
						</div>
						<div class="filter-group">
							<label>סכום מינימלי:</label>
							<input type="number" id="minDebtAmount" placeholder="0" onchange="displayDebts()">
						</div>
					</div>
				</div>
				
				<div class="table-container">
					<table id="debtsTable" class="data-table">
						<thead>
							<tr>
								<th>לקוח</th>
								<th>כתובת</th>
								<th>טלפון</th>
								<th>מספר טיפולים</th>
								<th>סה"כ חוב</th>
								<th>טיפול אחרון</th>
								<th>ימים</th>
								<th>פעולות</th>
							</tr>
						</thead>
						<tbody id="debtsTableBody">
						</tbody>
					</table>
				</div>
			</section>

			<!-- System Section -->
			<section id="system" class="section">
				<h2>🛠️ מערכת</h2>
				
				<!-- Import Section -->
				<div class="form-section">
					<h3>📥 ייבוא נתונים</h3>
					
					<div class="import-main-buttons">
						<button onclick="createImportTable()">📗 צור טבלת עזר לייבוא</button>
						<button onclick="importFromHelperTableFast()">🚀 ייבוא מהיר וכולל</button>
					</div>
					
					<div class="import-other-buttons">
						<button onclick="importFromTelegramToHelper()" class="btn btn-warning">
							📱 יבוא מטלגרם לטבלת עזר
						</button>
						<button onclick="importFromTelegramHelper()" class="btn btn-info">
							⬇️ יבוא מטבלת עזר טלגרם
						</button>
					</div>

					<div style="margin: 25px 0; padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
						<div style="text-align: center;">
							<h3 style="color: white; margin-bottom: 10px; font-size: 1.4em;">💰 ייבוא הכנסות מטלגרם</h3>
							<p style="color: rgba(255,255,255,0.9); margin-bottom: 20px; font-size: 14px;">
								העלה קובץ ייצוא הכנסות מטלגרם לייבוא אוטומטי למערכת
							</p>
							<input type="file" id="telegramIncomeFile" accept=".txt,.json" style="display: none;" onchange="handleTelegramIncomeFileUpload(event)">
							<button class="btn" onclick="document.getElementById('telegramIncomeFile').click()" 
									style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 12px 30px; font-size: 16px; border-radius: 8px; transition: all 0.3s ease; backdrop-filter: blur(10px);">
								📁 בחר קובץ הכנסות מטלגרם
							</button>
						</div>
						<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 12px; text-align: center; color: rgba(255,255,255,0.8);">
							תומך בקבצי .txt ו-.json מייצוא טלגרם
						</div>
					</div>


					<!-- הוסף גם כפתור ליצירת טבלת עזר חדשה: -->
					<div style="margin-top: 10px;">
						<button onclick="createTelegramHelperTable()" class="btn btn-secondary" style="font-size: 12px;">
							🗂️ צור טבלת עזר טלגרם חדשה
						</button>
					</div>
					
					<div id="telegramHelperStatus" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; font-size: 14px;"></div>
					
					<details>
						<summary>⚙️ ייבוא חלקי (למתקדמים)</summary>
						<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
							<button class="btn btn-info" onclick="importCustomersFromHelper()">👥 רק לקוחות</button>
							<button class="btn btn-primary" onclick="importVisitsFromHelper()">🔧 רק טיפולים</button>
							<button class="btn btn-warning" onclick="importReceiptsFromHelper()">🧾 רק קבלות</button>
						</div>
						<p style="font-size: 12px; color: #666; margin-top: 8px;">
							השתמש בזה רק אם אתה צריך לייבא סוג נתונים ספציפי
						</p>
					</details>
					
					<div style="text-align: center; margin: 15px 0;">
						<span style="color: #666;">או</span>
					</div>
					
					<div style="text-align: center;">
						<button class="btn btn-warning" onclick="document.getElementById('importFileInput').click()">
							📁 ייבוא מהיר מקובץ
						</button>
						<input type="file" id="importFileInput" accept=".csv,.xlsx" style="display: none;" onchange="handleImportFile(event)">
					</div>
					
					<p style="text-align: center; font-size: 12px; color: #666; margin-top: 15px;">
						ייבוא לקוחות, ביקורים וקבלות מקובץ Excel או Google Sheets
					</p>
				</div>
				
				<!-- ניהול נתונים -->
				<div class="form-section">
					<h3>🗂️ ניהול נתונים</h3>
					
					<div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
						<h4 style="color: #856404; margin-bottom: 10px;">⚠️ ניקוי נתונים</h4>
						<p style="font-size: 14px; color: #856404; margin-bottom: 10px;">
							נקה את כל הנתונים המקומיים לפני ייבוא חדש (לא משפיע על הענן)
						</p>
						
						<button class="btn" onclick="clearAllDataBeforeImport()" 
								style="background: #dc3545; color: white; border: none;">
							🗑️ נקה את כל הנתונים המקומיים
						</button>
					</div>
					
					<!-- סטטוס טבלת עזר -->
					<div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
						<h4 style="color: #495057; margin-bottom: 10px;">📊 טבלת עזר לייבוא</h4>
						<div id="importTableStatus">
							<span style="font-size: 13px; color: #666;">
								בודק סטטוס טבלת עזר...
							</span>
						</div>
					</div>
				</div>
				
				<!-- Additional System Features -->
					<div class="form-section">
						<h3>⚙️ הגדרות מערכת</h3>
						
						<!-- Cost Settings -->
						<div style="background: rgba(39, 174, 96, 0.1); border: 2px solid #27ae60; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
							<h4 style="color: #27ae60; margin-bottom: 10px;">💰 הגדרות עלות טיפול</h4>
							<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
								<div class="form-group">
									<label for="hourlyRate">שעת עבודה (₪):</label>
									<input type="number" id="hourlyRate" value="150" min="0" onchange="saveCostSettings()">
								</div>
								<div class="form-group">
									<label for="workerCost">תוספת לפועל (₪):</label>
									<input type="number" id="workerCost" value="50" min="0" onchange="saveCostSettings()">
								</div>
							</div>
						</div>
						
						<p style="color: #666;">תכונות נוספות יתווספו כאן בהמשך...</p>
					</div>
			</section>
			
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <script>
		 // Google Sheets API Configuration
		const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
		const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
		let SPREADSHEET_ID = '1fSD5dh0bXRzFSeOZUwJ2bPjGRLqs2crGXPkebz6MpWc';
		const CLIENT_ID = '1040357646874-4sbkrokgjn4dd7a0e9rkrtjt8d9l3vie.apps.googleusercontent.com';
		const API_KEY = 'AIzaSyB25ms_UzbgfY9FnduMwMhGhlvwfVPaTg8';
		const SPREADSHEET_NAME = 'service_visits_data';

//////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>   למחיקה
		// בדיקה זמנית - תמחק אחרי הבדיקה
		console.log('Spreadsheet ID:', SPREADSHEET_ID);
		console.log('API Key:', API_KEY);
		console.log('Client ID:', CLIENT_ID);
//////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>


		let gapi_loaded = false;
		let google_loaded = false;
		let access_token = null;
		let spreadsheet_id = SPREADSHEET_ID;
        
        // Sheet names
        const SHEETS = {
			LOCATIONS: 'Locations',
			VISITS: 'Visits',
			RECEIPTS: 'Receipts',
			SETTINGS: 'SystemSettings'
		};

        // Global variables
        let locations = [];
        let visits = [];
        let receipts = [];
        let currentFilter = 'today';
		// הגדרות עלות
		let costSettings = {
			hourlyRate: 150,
			workerCost: 50
		};

		// Initialize Google APIs
		function initializeGoogleAPIs() {
			gapi.load('client', initializeGapiClient);
			google.accounts.id.initialize({
				client_id: CLIENT_ID,
				callback: handleCredentialResponse,
			});
		}
		
		async function initializeGapiClient() {
			try {
				await gapi.client.init({
					apiKey: API_KEY,
					discoveryDocs: [DISCOVERY_DOC],
				});
				gapi_loaded = true;
				console.log('GAPI client initialized successfully');
			} catch (error) {
				console.error('Error initializing GAPI client:', error);
				showToast('שגיאה באתחול Google API', 'error');
			}
		}

		function handleCredentialResponse(response) {
			access_token = response.credential;
			showSuccess('התחברת בהצלחה ל-Google!');
		}

		// תוספה - פונקציה שנקראת אחרי ההתחברות
		async function loadAllDataFromSheets() {
			if (!await validateToken()) {
				showToast('אין חיבור לגוגל - טוען נתונים מקומיים', 'warning');
				return;
			}
			
			try {
				showLoading('טוען נתונים מ-Google Sheets...');
				
				await loadLocationsFromSheets();
				await loadVisitsFromSheets(); 
				await loadReceiptsFromSheets();
				
				// Update UI
				loadLocationsForSelect();
				loadLocationsTable();
				loadReceiptsTable();
				loadPlanningData();
				
				hideLoading();
				showSuccess('נתונים נטענו בהצלחה מ-Google Sheets!');
				setTimeout(checkCriticalDebts, 2000); // התראה אחרי 2 שניות
				
			} catch (error) {
				console.error('Error loading data from sheets:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('⚠️ החיבור פג במהלך טעינה', 'warning');
				} else {
					showError('שגיאה בטעינת נתונים מ-Google Sheets');
				}
				throw error;
			}
		}

		

		// תוספה - טעינת מיקומים (גינות)
		async function loadLocationsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:P` // וודא שקוראים עד עמודה P
				});
				
				const rows = response.result.values;
				console.log('🔍 Raw locations data (first row):', rows ? rows[0] : 'No data');
				console.log('🔍 Raw locations data (second row):', rows ? rows[1] : 'No data');
				
				if (rows && rows.length > 1) {
					locations = rows.slice(1).map((row, index) => {
						const location = {
							ID: row[0] || '',
							name: row[1] || '',
							full_address: row[2] || '',
							neighborhood: row[3] || '',
							city: row[4] || '',
							contact_person: row[5] || '',
							phone: row[6] || '',
							allowed_day: row[7] || '',
							interval_weeks: row[8] || '',
							temp_addition: row[9] || 0,
							base_amount: row[10] || '',
							active: row[11] || '',
							notes: row[12] || '',
							last_visit: row[13] || '',
							next_visit: row[14] || '',
							client_requests: row[15] || '' // עמודה P
						};
						
						// לוג רק לשורות עם client_requests
						if (row[15]) {
							console.log(`✅ Row ${index + 1} - ${location.name}: client_requests = "${row[15]}"`);
						}
						
						return location;
					});
				}
				
				console.log('📊 Total locations loaded:', locations.length);
				
			} catch (error) {
				console.error('Error loading locations:', error);
			}
		}

		// תוספה - טעינת ביקורים (טיפולים)
		async function loadVisitsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:N` // ← שנה מ-A:L ל-A:N
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					visits = rows.slice(1).map(row => ({
						ID: row[0] || '',
						date: row[1] || '',
						location_id: row[2] || '',
						location_name: row[3] || '',
						visit_type: row[4] || '',
						work_done: row[5] || '',
						duration_minutes: row[6] || 0,
						num_workers: row[7] || 1,
						start_time: row[8] || '',
						end_time: row[9] || '',
						amount: row[10] || 0,
						expense: row[11] || 0,
						notes: row[12] || ''
					}));
				}
				
			} catch (error) {
				console.error('Error loading visits:', error);
			}
		}

		// תוספה - טעינת קבלות
		async function loadReceiptsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:I`
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					receipts = rows.slice(1).map(row => ({
						ID: row[0] || '',
						book_number: row[1] || '',
						receipt_number: row[2] || '',
						date: row[3] || '',
						location_id: row[4] || '',
						location_name: row[5] || '',
						amount: row[6] || 0,
						payment_type: row[7] || '',
						notes: row[8] || ''
					}));
				}
				
			} catch (error) {
				console.error('Error loading receipts:', error);
			}
		}
		
		// תוספה - שמירת מיקום חדש לשיטס
		/* async function saveLocationToSheets(locationData) {
		
			console.log('📝 saveLocationToSheets started with client_requests:', locationData.client_requests);
			
			if (!await validateToken()) {
				console.log('❌ Token validation failed');
				showToast('החיבור לגוגל פג - שמירה מקומית בלבד', 'warning');
				return;
			}
    
			console.log('✅ Token validated, proceeding to save...');
	
			try {
				const values = [[
					locationData.ID,
					locationData.name,
					locationData.full_address,
					locationData.neighborhood,
					locationData.city,
					locationData.contact_person,
					locationData.phone,
					locationData.allowed_day,
					locationData.interval_weeks,
					locationData.temp_addition,
					locationData.base_amount,
					locationData.active,
					locationData.notes || '',
					locationData.last_visit,
					locationData.next_visit,
					locationData.client_requests|| ''
				]];
				
				console.log('📤 About to send to Google Sheets:', values[0][15]); 
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:P`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
				console.log('✅ Successfully saved to Google Sheets');
				
			} catch (error) {
			
				console.error('❌ Error in saveLocationToSheets:', error);
			
				console.error('Error saving location to sheets:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('⚠️ החיבור פג - התחבר מחדש', 'warning');
					document.getElementById('statusText').textContent = '🔓 נותק';
				} else {
					// שגיאות אחרות (לא קשורות לאסימון)
					showToast('⚠️ שגיאה בשמירה לענן', 'error');
				}
				throw error;

			}
		}  */


		async function saveLocationToSheets(locationData) {
		
			if (!await validateToken()) {
				showToast('החיבור לגוגל פג - שמירה מקומית בלבד', 'warning');
				return;
			}
    
			try {
				const values = [[
					locationData.ID,
					locationData.name,
					locationData.full_address,
					locationData.neighborhood,
					locationData.city,
					locationData.contact_person,
					locationData.phone,
					locationData.allowed_day,
					locationData.interval_weeks,
					locationData.temp_addition,
					locationData.base_amount,
					locationData.active,
					locationData.notes || '',
					locationData.last_visit,
					locationData.next_visit,
					locationData.client_requests || ''
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:P`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving location to sheets:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('⚠️ החיבור פג - התחבר מחדש', 'warning');
					document.getElementById('statusText').textContent = '🔓 נותק';
				} else {
					// שגיאות אחרות (לא קשורות לאסימון)
					showToast('⚠️ שגיאה בשמירה לענן', 'error');
				}
				throw error;

			}
		}


		// שמירת ביקור חדש לשיטס
		async function saveVisitToSheets(visitData) {
			if (!await validateToken()) {
				return;
			}
			
			try {
				const values = [[
					visitData.ID,
					visitData.date,
					visitData.location_id,
					visitData.location_name || '', 
					visitData.visit_type,
					visitData.work_done,
					visitData.duration_minutes,
					visitData.num_workers || 1,
					visitData.start_time,
					visitData.end_time,
					visitData.amount,
					visitData.expense || 0,
					visitData.notes
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:M`, // ← חזרנו ל-M כי הסרנו paid
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving visit to sheets:', error);
				throw error;
			}
		}

		// תוספה - שמירת קבלה לשיטס
		async function saveReceiptToSheets(receiptData) {
			if (!await validateToken()) {
				return;
			}
			
			try {
				const values = [[
					receiptData.ID,
					receiptData.booklet_number || '',
					receiptData.receipt_number || '',
					receiptData.date,
					receiptData.location_id,
					receiptData.location_name || '',
					receiptData.amount,
					receiptData.payment_type || '',
					receiptData.tax_code || '',
					receiptData.notes || ''
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:J`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving receipt to sheets:', error);
				throw error;
			}
		}

		
		// תוספה - טעינת כל הנתונים מהענן
		async function loadAllFromSheets() {
			try {
				showLoading('טוען נתונים מהענן...');
				
				await loadLocationsFromSheets();
				await loadVisitsFromSheets(); 
				await loadReceiptsFromSheets();
				await loadPaymentsFromCloud(); 
				
				// עדכון התצוגה
				loadLocationsForSelect();
				loadLocationsTable();
				loadReceiptsTable();
				loadPlanningData();
				
				hideLoading();
				showSuccess('נתונים נטענו בהצלחה מהענן!');
				
			} catch (error) {
				console.error('Error loading all data:', error);
				hideLoading();
				showError('שגיאה בטעינת הנתונים מהענן');
			}
		}


		// Local Storage functions
		function saveToLocalStorage() {
			try {
				localStorage.setItem('locations_data', JSON.stringify(locations));
				localStorage.setItem('visits_data', JSON.stringify(visits));
				localStorage.setItem('receipts_data', JSON.stringify(receipts));
				localStorage.setItem('payments_data', JSON.stringify(payments));
				localStorage.setItem('payment_links_data', JSON.stringify(paymentVisitLinks));
				console.log('Data saved to local storage');
			} catch (error) {
				console.error('Error saving to local storage:', error);
			}
		}

		function loadFromLocalStorage() {
			try {
				const savedLocations = localStorage.getItem('locations_data');
				const savedVisits = localStorage.getItem('visits_data');
				const savedReceipts = localStorage.getItem('receipts_data');
				const savedPayments = localStorage.getItem('payments_data');
				const savedPaymentLinks = localStorage.getItem('payment_links_data');
				const savedCostSettings = localStorage.getItem('cost_settings'); // הוסף זה
				
				if (savedLocations) {
					locations = JSON.parse(savedLocations);
				}
				if (savedVisits) {
					visits = JSON.parse(savedVisits);
				}
				if (savedReceipts) {
					receipts = JSON.parse(savedReceipts);
				}
				if (savedPayments) {
					payments = JSON.parse(savedPayments);
				}
				if (savedPaymentLinks) {
					paymentVisitLinks = JSON.parse(savedPaymentLinks);
				}
				if (savedCostSettings) { // הוסף את הבלוק הזה
					costSettings = JSON.parse(savedCostSettings);
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
				}
				
				if (savedCostSettings) {
					costSettings = JSON.parse(savedCostSettings);
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
				}

				console.log('Data loaded from local storage');
				
			} catch (error) {
				console.error('Error loading from local storage:', error);
			}
		}



        document.addEventListener('DOMContentLoaded', function() {
			console.log('App starting...');
			initializeGoogleAPIs();
			loadAllData(); // זה יטען נתונים מקומיים
			setupEventListeners();
		});

        // Setup event listeners
        function setupEventListeners() {
            // Visitform submission
            document.getElementById('visitForm').addEventListener('submit', handleVisitSubmit);
        }

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Add active class to clicked button
            if (event && event.target) {
				event.target.classList.add('active');
			}
            
            // Load section-specific data
            switch(sectionName) {
                case 'planning':
                    loadPlanningData();
                    break;
                case 'visit':
                    loadLocationsForSelect();
                    break;
				case 'history':
					loadVisitsHistory();
					break;
                case 'locations':
                    loadLocationsTable();
                    break;
                case 'receipts':
                    loadReceiptsTable();
                    break;
				case 'debts':
                    displayDebts();
                    break;
            }
        }

        // Data loading functions
		async function loadAllData() {
			try {
				showLoading('טוען נתונים...');
				loadFromLocalStorage();
				hideLoading();
				loadPlanningData();
			} catch (error) {
				console.error('Error loading data:', error);
				showError('שגיאה בטעינת הנתונים');
			}
		}

        async function loadlocations() {
            // For now, we'll use dummy data until we set up the Google Sheets API
            locations = [
                {
                    ID: 1,
                    name: "גינת דוגמה 1",
                    full_address: "רחוב הדוגמה 1, תל אביב",
                    neighborhood: "מרכז",
                    city: "תל אביב",
                    contact_person: "יוסי כהן",
                    phone: "050-1234567",
                    allowed_day: "א'",
                    interval_weeks: 4,
                    temp_addition: 0,
                    base_amount: 300,
                    active: "כן",
                    notes: "",
                    last_visit: "2024-01-15",
                    next_visit: "2024-02-12"
                },
                {
                    ID: 2,
                    name: "גינת דוגמה 2",
                    full_address: "רחוב הדוגמה 2, תל אביב",
                    neighborhood: "צפון",
                    city: "תל אביב",
                    contact_person: "מרים לוי",
                    phone: "052-7654321",
                    allowed_day: "ג'",
                    interval_weeks: 6,
                    temp_addition: 0,
                    base_amount: 400,
                    active: "כן",
                    notes: "",
                    last_visit: "2024-01-10",
                    next_visit: "2024-02-21"
                }
            ];
        }

        async function loadVisits() {
            visits = []; // Will be loaded from Google Sheets
        }

        async function loadReceipts() {
            receipts = []; // Will be loaded from Google Sheets
        }

        // Display functions
        function loadPlanningData() {
			// Debug - בדיקת נתונים
			debugPlanningData();
			
			// חישוב סטטיסטיקות
			updatePlanningStats();
			
			// סינון רגיל
			filterVisits(currentFilter);
		}

	/////<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
	
	// ========== מערכת תכנון משודרגת ==========

		// משתנים גלובליים לתכנון משודרג
		let currentPlanningView = 'daily';
		let planningClients = [];

		// זמני עבודה זמינים (07:00-19:00 בקפיצות של 30 דקות)
		const timeSlots = [];
		for (let hour = 7; hour <= 19; hour++) {
			timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
			if (hour < 19) timeSlots.push(`${hour.toString().padStart(2, '0')}:30`);
		}

		// פונקציה עיקרית לטעינת נתוני תכנון - גרסה משודרגת
		function loadPlanningDataAdvanced() {
			updatePlanningStats();
			loadPlanningClientsAdvanced();
			updatePlanningDateHeader();
			renderPlanningCards();
		}

		// טעינת לקוחות לתכנון לפי התצוגה הנוכחית - גרסה מתוקנת
		function loadPlanningClientsAdvanced() {
			const today = new Date();
			today.setHours(0, 0, 0, 0);
			
			console.log('🔄 טוען לקוחות לתכנון - תצוגה:', currentPlanningView);
			
			// סינון לקוחות פעילים בלבד
			const activeClients = locations.filter(client => client.active === "1");
			console.log('📊 לקוחות פעילים:', activeClients.length);
			
			// חישוב נתונים לכל לקוח פעיל
			planningClients = activeClients.map(client => {
				const nextVisitDate = new Date(client.next_visit);
				nextVisitDate.setHours(0, 0, 0, 0);
				
				const daysDiff = Math.floor((nextVisitDate - today) / (1000 * 60 * 60 * 24));
				const daysOverdue = daysDiff < 0 ? Math.abs(daysDiff) : 0;
				
				return {
					...client,
					nextVisitDate: nextVisitDate,
					daysDiff: daysDiff,
					daysOverdue: daysOverdue,
					status: calculateClientStatus(daysDiff, daysOverdue)
				};
			});
			
			// סינון לפי תצוגה נוכחית
			planningClients = filterClientsByView(planningClients);
			
			// מיון הלקוחות
			sortPlanningClients();
			
			console.log('✅ לקוחות לתצוגה:', planningClients.length);
		}
	
		// חישוב סטטוס לקוח לפי הפרש ימים
		function calculateClientStatus(daysDiff, daysOverdue) {
			if (daysOverdue > 14) return 'red';        // איחור מעל שבועיים
			if (daysOverdue > 0) return 'orange';      // איחור עד שבועיים  
			if (daysDiff === 0) return 'green';        // היום בדיוק
			if (daysDiff <= 7) return 'yellow';        // השבוע הקרוב
			return 'gray';                             // עתידי רחוק
		}

		// סינון לקוחות לפי התצוגה הנבחרת
		function filterClientsByView(clients) {
			const today = new Date();
			const todayDay = today.getDay(); // 0=ראשון, 1=שני וכו'
			const dayNames = ['יום ראשון', 'יום שני', 'יום שלישי', 'יום רביעי', 'יום חמישי', 'יום שישי', 'יום שבת'];
			
			switch (currentPlanningView) {
				case 'daily':
					// רק לקוחות שהיום בדיוק התאריך שלהם (בלי מאחרים)
					return clients.filter(client => client.daysDiff === 0);
					
				case 'weekly':
					// רק תאריכים מדויקים (לא מאחרים) - מהשבוע הקרוב
					return clients.filter(client => 
						client.daysDiff >= 0 && client.daysDiff <= 7
					);
					
				case 'overdue':
					// רק מאחרים
					return clients.filter(client => client.daysOverdue > 0);
					
				default:
					return clients;
			}
		}
	
		// מיון לקוחות לפי התצוגה הנוכחית
		function sortPlanningClients() {
			planningClients.sort((a, b) => {
				switch (currentPlanningView) {
					case 'daily':
						// מיון לפי שעה מועדפת אם קיימת, אחרת לפי שם
						return (a.name || '').localeCompare(b.name || '');
						
					case 'weekly':
						// מיון לפי יום בשבוע, ואז לפי תאריך
						const dayOrder = ['יום ראשון', 'יום שני', 'יום שלישי', 'יום רביעי', 'יום חמישי', 'יום שישי', 'יום שבת'];
						const aDay = dayOrder.indexOf(a.allowed_day || 'יום ראשון');
						const bDay = dayOrder.indexOf(b.allowed_day || 'יום ראשון');
						if (aDay !== bDay) return aDay - bDay;
						return a.daysDiff - b.daysDiff;
						
					case 'overdue':
						// מיון לפי חומרת האיחור (הכי מאחר ראשון)
						return b.daysOverdue - a.daysOverdue;
						
					default:
						return 0;
				}
			});
		}
	
		// החלפת תצוגת תכנון עם לוגיקה מעודכנת
		function switchPlanningView(view) {
			console.log('🔄 מחליף תצוגת תכנון ל:', view);
			
			// עדכון משתנה גלובלי
			currentPlanningView = view;
			
			// עדכון מצב כפתורי טאב
			document.querySelectorAll('.planning-tab-btn').forEach(btn => btn.classList.remove('active'));
			const activeBtn = document.querySelector(`[onclick="switchPlanningView('${view}')"]`);
			if (activeBtn) activeBtn.classList.add('active');
			
			// עדכון כותרת לפי תצוגה
			updatePlanningDateHeader();
			
			// טעינה מחדש עם הסינון החדש
			loadPlanningDataAdvanced();
			
			// הצגת מספר תוצאות
			setTimeout(() => {
				let viewName = '';
				switch(view) {
					case 'daily': viewName = 'יומי'; break;
					case 'weekly': viewName = 'שבועי'; break;  
					case 'overdue': viewName = 'מאחרים'; break;
				}
				
				if (planningClients.length > 0) {
					showToast(`מצב ${viewName}: ${planningClients.length} לקוחות`, 'info');
				}
			}, 200);
		}

		// עדכון כותרת תאריך משופרת
		function updatePlanningDateHeader() {
			const today = new Date();
			const dayName = today.toLocaleDateString('he-IL', { weekday: 'long' });
			const dateFormatted = today.toLocaleDateString('he-IL', { 
				day: 'numeric', 
				month: 'long', 
				year: 'numeric' 
			});
			
			let headerTitle = '';
			let headerSubtitle = '';
			
			switch (currentPlanningView) {
				case 'daily':
					headerTitle = `היום - ${dayName}`;
					headerSubtitle = 'לקוחות מתוכננים להיום';
					break;
				case 'weekly':
					headerTitle = `השבוע - ${dayName}`;
					headerSubtitle = 'תכנון לימים הקרובים';
					break;
				case 'overdue':
					headerTitle = 'טיפולים מאחרים';
					headerSubtitle = 'דורשים קביעת מועד חדש';
					break;
				default:
					headerTitle = `תכנון - ${dayName}`;
					headerSubtitle = dateFormatted;
			}
			
			const titleElement = document.getElementById('planningDateTitle');
			const dateElement = document.getElementById('planningDateFormatted');
			
			if (titleElement) titleElement.textContent = headerTitle;
			if (dateElement) dateElement.textContent = headerSubtitle;
		}

		// רינדור כרטיסי לקוחות לתכנון
		function renderPlanningCards() {
			const container = document.getElementById('planningCardsContainer');
			
			if (!container) {
				console.log('⚠️ לא נמצא container לכרטיסי התכנון');
				return;
			}
			
			if (planningClients.length === 0) {
				let emptyMessage = '';
				switch (currentPlanningView) {
					case 'daily':
						emptyMessage = '<h3>😊 אין לקוחות מתוכננים להיום</h3><p>כל הטיפולים מעודכנים!</p>';
						break;
					case 'weekly':
						emptyMessage = '<h3>📅 אין לקוחות מתוכננים השבוע</h3><p>תכנון נקי לשבוע הקרוב!</p>';
						break;
					case 'overdue':
						emptyMessage = '<h3>✅ אין לקוחות מאחרים</h3><p>כל הטיפולים במועדם!</p>';
						break;
				}
				
				container.innerHTML = `
					<div class="planning-empty-state">
						${emptyMessage}
					</div>
				`;
				return;
			}

			// במצב שבועי - חלוקה לפי ימים
			if (currentPlanningView === 'weekly' || currentPlanningView === 'overdue') {
				renderWeeklyPlanningByDays();
			} else {
				// במצב יומי או מאחרות - רשימה רגילה
				renderRegularPlanningList();
			}
		}


		// רינדור למצב שבועי ומאחרות עם טאבי ימים
		function renderWeeklyPlanningByDays() {
			const container = document.getElementById('planningCardsContainer');
			const dayNames = ['יום ראשון', 'יום שני', 'יום שלישי', 'יום רביעי', 'יום חמישי', 'יום שישי', 'יום שבת'];
			
			// יצירת מערך עם נתוני ימים
			const daysData = dayNames.map(dayName => {
				const dayClients = planningClients.filter(client => 
					(client.allowed_day || 'יום ראשון') === dayName
				);
				// מיון לקוחות היום
				dayClients.sort((a, b) => {
					if (currentPlanningView === 'overdue') {
						return b.daysOverdue - a.daysOverdue; // מאחרים - לפי דחיפות
					} else {
						return a.daysDiff - b.daysDiff; // שבועי - לפי תאריך
					}
				});
				
				return { dayName, clients: dayClients };
			});
			
			// רק ימים עם לקוחות
			const activeDays = daysData.filter(day => day.clients.length > 0);
			
			if (activeDays.length === 0) {
				container.innerHTML = '<div class="planning-empty-state"><h3>אין לקוחות להציג</h3></div>';
				return;
			}
			
			// יצירת HTML עם טאבים
			let html = `
				<div class="days-tabs-container">
					<div class="days-tabs">
						${activeDays.map((day, index) => 
							`<button class="day-tab-btn ${index === 0 ? 'active' : ''}" 
									 onclick="switchDayTab('${day.dayName}')" 
									 data-day="${day.dayName}">
								${day.dayName} (${day.clients.length})
							</button>`
						).join('')}
					</div>
					<div class="days-content">
						${activeDays.map((day, index) => 
							`<div class="day-content ${index === 0 ? 'active' : ''}" data-day="${day.dayName}">
								${day.clients.map(client => renderClientRow(client)).join('')}
							</div>`
						).join('')}
					</div>
				</div>
			`;
			
			container.innerHTML = html;
		}

		// רינדור רגיל (יומי/מאחרות)
		function renderRegularPlanningList() {
			const container = document.getElementById('planningCardsContainer');
			container.innerHTML = planningClients.map(client => renderClientRow(client)).join('');
		}

		// רינדור שורת לקוח (משותף לשני המצבים)
		function renderClientRow(client) {
			const nextVisitFormatted = formatDate(client.next_visit);
			let statusText = '';
			
			// טקסט סטטוס לפי תצוגה
			switch (currentPlanningView) {
				case 'daily':
					statusText = 'מתוכנן להיום';
					break;
				case 'weekly':
					const daysDiffText = client.daysDiff === 0 ? 'היום' : 
									   client.daysDiff === 1 ? 'מחר' : 
									   `בעוד ${client.daysDiff} ימים`;
					statusText = daysDiffText;
					break;
				case 'overdue':
					statusText = client.daysOverdue === 1 ? 'איחור יום אחד' : `איחור ${client.daysOverdue} ימים`;
					break;
			}
			
			return `
				<div class="planning-client-row planning-status-${client.status}" data-client-id="${client.ID}">
					<div class="planning-row-main">
						<div class="planning-client-info">
							<div class="planning-client-name">${client.name}</div>
							<div class="planning-client-address">${client.full_address}</div>
							<div class="planning-client-date">📅 ${nextVisitFormatted} (${statusText})</div>
						</div>
						<div class="planning-client-price">₪${client.base_amount || 0}</div>
						<div class="planning-client-actions">
							${currentPlanningView === 'daily' ? 
								`<button class="planning-action-btn planning-complete" title="התחל טיפול" onclick="startTreatment('${client.ID}')">▶</button>` : 
								''
							}
							<input type="date" class="planning-date-input" value="${client.next_visit}" onchange="updateClientNextVisit('${client.ID}', this.value)" title="תאריך טיפול הבא">
							<select class="planning-active-toggle" onchange="toggleClientActive('${client.ID}', this.value)" title="סטטוס לקוח">
								<option value="1" selected>פעיל</option>
								<option value="0">לא פעיל</option>
							</select>
							<button class="planning-history-btn" onclick="showClientHistory('${client.ID}')" title="היסטוריית טיפולים">📋</button>
						</div>
					</div>
					${(client.notes || client.client_requests) ? `
						<div class="planning-row-details">
							${client.client_requests ? `<div class="client-requests">📝 בקשות: ${client.client_requests}</div>` : ''}
							${client.notes ? `<div class="client-notes">💭 הערות: ${client.notes}</div>` : ''}
						</div>
					` : ''}
				</div>
			`;
		}
	
		// החלפת טאב יום
		function switchDayTab(dayName) {
			// הסרת active מכל הכפתורים
			document.querySelectorAll('.day-tab-btn').forEach(btn => btn.classList.remove('active'));
			document.querySelectorAll('.day-content').forEach(content => content.classList.remove('active'));
			
			// הוספת active לכפתור ותוכן הנוכחיים
			const activeBtn = document.querySelector(`[data-day="${dayName}"]`);
			const activeContent = document.querySelector(`.day-content[data-day="${dayName}"]`);
			
			if (activeBtn) activeBtn.classList.add('active');
			if (activeContent) activeContent.classList.add('active');
		}
	
		// פונקציה חדשה: התחל טיפול (מעבר לטופס עם פרטי לקוח מוכנים)
		function startTreatment(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לא נמצא לקוח', 'error');
				return;
			}
			
			// מעבר לטאב טיפול חדש
			showSection('visit');
			
			// מילוי פרטי הלקוח בטופס
			setTimeout(() => {
				const locationSelect = document.getElementById('visitLocation');
				if (locationSelect) {
					locationSelect.value = clientId;
					// הפעלת אירוע שינוי למילוי פרטים נוספים
					locationSelect.dispatchEvent(new Event('change'));
				}
				
				// מילוי תאריך היום
				const dateInput = document.getElementById('visitDate');
				if (dateInput) {
					dateInput.value = new Date().toISOString().split('T')[0];
				}
				
				showToast(`התחיל טיפול עבור ${client.name}`, 'success');
			}, 100);
		}

		// עדכון פונקציית החלפת סטטוס פעיל/לא פעיל
		function toggleClientActive(clientId, newStatus) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			const oldStatus = client.active;
			client.active = newStatus;
			
			// שמירה מקומית
			saveToLocalStorage();
			
			// שמירה בענן אם מחובר
			if (access_token && SPREADSHEET_ID) {
				updateLocationInCloud(client);
			}
			
			const statusText = newStatus === "1" ? "פעיל" : "לא פעיל";
			showToast(`${client.name} הוגדר כ${statusText}`, 'info');
			
			// רענון התצוגה רק אם הלקוח הפך ללא פעיל
			if (newStatus === "0") {
				loadPlanningDataAdvanced();
			}
		}
	
		// עדכון שעה מתוכננת ללקוח
		function updateClientScheduledTime(clientId, newTime) {
			const client = locations.find(loc => loc.ID === clientId);
			if (client) {
				client.scheduled_time = newTime;
				saveToLocalStorage();
				
				// שמירה בענן אם מחובר
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`שעת טיפול עודכנה ל-${newTime}`, 'success', 2000);
			}
		}

		// סיום טיפול (מעבר לטופס הוספת ביקור)
		function completePlanningVisit(clientId) {
			showSection('visit');
			document.getElementById('locationSelect').value = clientId;
			document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
			
			const client = locations.find(loc => loc.ID === clientId);
			if (client && client.scheduled_time) {
				const timeInput = document.getElementById('visitTime');
				if (timeInput) timeInput.value = client.scheduled_time;
			}
		}

		// דחיית טיפול
		function postponePlanningVisit(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			const weeks = prompt(`כמה שבועות לדחות את הטיפול עבור ${client.name}?`, '1');
			if (weeks && !isNaN(weeks) && parseInt(weeks) > 0) {
				const currentNextVisit = new Date(client.next_visit);
				const postponedDate = new Date(currentNextVisit.getTime() + (parseInt(weeks) * 7 * 24 * 60 * 60 * 1000));
				
				client.next_visit = postponedDate.toISOString().split('T')[0];
				client.temp_addition = 0;
				
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`טיפול נדחה ל-${formatDate(client.next_visit)}`, 'success');
				loadPlanningDataAdvanced();
			}
		}

		// תפריט פעולות נוספות ללקוח
		function showPlanningClientMenu(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			const actions = [
				'צפייה בהיסטוריית טיפולים',
				'התחלת טיפול מיידי',
				'קביעת תאריך ספציפי',
				'עריכת פרטי לקוח',
				'ביטול'
			];
			
			const choice = prompt(`בחר פעולה עבור ${client.name}:\n\n` + 
				actions.map((action, i) => `${i + 1}. ${action}`).join('\n'));
			
			switch (choice) {
				case '1':
					showClientTreatmentHistory(clientId);
					break;
				case '2':
					startImmediateVisit(clientId);
					break;
				case '3':
					setSpecificVisitDate(clientId);
					break;
				case '4':
					editLocation(clientId);
					break;
			}
		}

		// צפייה בהיסטוריית טיפולים
		function showClientTreatmentHistory(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			const clientVisits = visits.filter(visit => visit.location_id === clientId)
				.sort((a, b) => new Date(b.date) - new Date(a.date))
				.slice(0, 10);
			
			if (clientVisits.length === 0) {
				alert(`${client.name} - אין עדיין היסטוריית טיפולים`);
				return;
			}
			
			const historyText = clientVisits.map(visit => 
				`${formatDate(visit.date)} - ${visit.work_done || 'טיפול'} - ₪${visit.amount} (${getPaymentStatusText(visit.paid)})`
			).join('\n');
			
			alert(`היסטוריית טיפולים - ${client.name}:\n\n${historyText}`);
		}

		// התחלת טיפול מיידי
		function startImmediateVisit(clientId) {
			showSection('visit');
			document.getElementById('locationSelect').value = clientId;
			document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
			document.getElementById('visitTime').value = new Date().toTimeString().slice(0,5);
		}

		// קביעת תאריך ספציפי לטיפול
		function setSpecificVisitDate(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			const newDate = prompt(`הזן תאריך חדש לטיפול הבא עבור ${client.name}:`, client.next_visit);
			
			if (newDate && !isNaN(new Date(newDate))) {
				client.next_visit = newDate;
				client.temp_addition = 0;
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`תאריך הטיפול הבא עבור ${client.name} עודכן ל-${formatDate(newDate)}`, 'success');
				loadPlanningDataAdvanced();
			}
		}
	
	
	// הוספת אירועי גרירה לכרטיסים (רק בתצוגה יומית)
		let draggedPlanningCard = null;

		function addPlanningDragEvents() {
			const cards = document.querySelectorAll('.planning-client-card');
			
			cards.forEach(card => {
				card.addEventListener('dragstart', handlePlanningDragStart);
				card.addEventListener('dragend', handlePlanningDragEnd);
				card.addEventListener('dragover', handlePlanningDragOver);
				card.addEventListener('drop', handlePlanningDrop);
			});
		}

		function handlePlanningDragStart(e) {
			draggedPlanningCard = this;
			this.classList.add('planning-dragging');
			e.dataTransfer.effectAllowed = 'move';
		}

		function handlePlanningDragEnd(e) {
			this.classList.remove('planning-dragging');
			document.querySelectorAll('.planning-client-card').forEach(card => {
				card.classList.remove('planning-drag-over');
			});
		}

		function handlePlanningDragOver(e) {
			if (e.preventDefault) e.preventDefault();
			this.classList.add('planning-drag-over');
			e.dataTransfer.dropEffect = 'move';
			return false;
		}

		function handlePlanningDrop(e) {
			if (e.stopPropagation) e.stopPropagation();
			
			if (draggedPlanningCard !== this) {
				const draggedIndex = parseInt(draggedPlanningCard.dataset.index);
				const droppedIndex = parseInt(this.dataset.index);
				
				// החלפת מקומות במערך
				const temp = planningClients[draggedIndex];
				planningClients[draggedIndex] = planningClients[droppedIndex];
				planningClients[droppedIndex] = temp;
				
				// רינדור מחדש
				renderPlanningCards();
				
				showToast('סדר הלקוחות שונה', 'info');
			}
			
			this.classList.remove('planning-drag-over');
			return false;
		}

		// שמירת הפונקציה המקורית לפני ההחלפה
		window.originalLoadPlanningData = window.loadPlanningData;

		// החלפת הפונקציה loadPlanningData
		window.loadPlanningData = function() {
			console.log('🔄 loadPlanningData נקראה');
			
			// בדיקה אם יש את האלמנטים החדשים
			if (document.getElementById('planningCardsContainer')) {
				console.log('📊 משתמש במערכת חדשה');
				loadPlanningDataAdvanced();
			} else {
				console.log('📊 משתמש במערכת ישנה');
				updatePlanningStats();
				filterVisits(window.currentFilter || 'today');
			}
		};

		// עדכון הפונקציה refreshPlanningAfterTreatmentUpdate לעבוד עם שתי המערכות
		function refreshPlanningAfterTreatmentUpdate() {
			const currentSection = document.querySelector('.section.active');
			if (currentSection && currentSection.id === 'planning') {
				loadPlanningData(); // זה יקרא למערכת המתאימה
			}
			
			loadLocationsForSelect();
		}
	
	/////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>


		// תוספה - עדכון סטטיסטיקות
		function updatePlanningStats() {
			// לקוחות
			const totalLocations = locations.length;
			const activeLocations = locations.filter(loc => loc.active === 'כן').length;
			
			// טיפולים השבוע
			const today = new Date();
			const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
			const weeklyVisits = visits.filter(visit => {
				const visitDate = new Date(visit.date);
				return visitDate >= weekAgo && visitDate <= today;
			});
			
			// הכנסה השבוע
			const weeklyIncome = weeklyVisits.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			// חובות פתוחים
			const openDebts = visits
				.filter(visit => visit.paid === '0')
				.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			// עדכון התצוגה
			document.getElementById('totalLocations').textContent = totalLocations;
			document.getElementById('activeLocations').textContent = `${activeLocations} (${totalLocations > 0 ? Math.round((activeLocations / totalLocations) * 100) : 0}%)`;
			document.getElementById('weeklyVisits').textContent = weeklyVisits.length;
			document.getElementById('weeklyIncome').textContent = `₪${weeklyIncome.toLocaleString()}`;
			document.getElementById('openDebts').textContent = `₪${openDebts.toLocaleString()}`;
		}

        function filterVisits(filter) {
			currentFilter = filter;
			
			// Update filter buttons
			document.querySelectorAll('.filter-btn').forEach(btn => {
				btn.classList.remove('active');
				if ((filter === 'today' && btn.textContent === 'היום') ||
					(filter === 'week' && btn.textContent === 'השבוע') ||
					(filter === 'overdue' && btn.textContent === 'מאוחרות')) {
					btn.classList.add('active');
				}
			});
			
			// Filter locations based on next_visit date
			const today = new Date();
			today.setHours(0, 0, 0, 0); // תחילת היום
			const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
			
			let filteredlocations = locations.filter(location => {
				return location.active === "1" && location.next_visit && location.next_visit.trim() !== '';
			});
			
			switch(filter) {
				case 'today':
					// לקוחות שהתאריך הבא שלהם הוא היום או עבר (צריכים טיפול)
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						nextVisit.setHours(0, 0, 0, 0); // תחילת היום
						return nextVisit <= today;
					});
					break;
				case 'week':
					// לקוחות שהתאריך הבא שלהם הוא השבוע הקרוב או עבר
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						return nextVisit <= weekFromNow;
					});
					break;
				case 'overdue':
					// לקוחות שהתאריך הבא שלהם עבר (מאוחרים)
					const yesterday = new Date(today);
					yesterday.setDate(yesterday.getDate() - 1);
					
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						return nextVisit <= yesterday;
					});
					break;
			}
			
			displayPlanningTable(filteredlocations);
		}

        function displayPlanningTable(locationsToShow) {
            const tbody = document.getElementById('planningTableBody');
            tbody.innerHTML = '';
            
            if (locationsToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">אין גינות לטיפול</td></tr>';
                return;
            }
            
            locationsToShow.forEach(location => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${location.name}</td>
                    <td>${location.full_address}</td>
                    <td>${location.allowed_day}</td>
                    <td>${formatDate(location.next_visit)}</td>
                    <td>
                        <button class="action-btn start-visit-btn" onclick="startVisitForlocation(${location.ID})">
                            התחל טיפול
                        </button>
                        <button class="action-btn edit-btn" onclick="postponeVisit(${location.ID})">
                            דחה
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadLocationsForSelect() {
            const select = document.getElementById('locationSelect');
            select.innerHTML = '<option value="">בחר לקוח...</option>';
            
            locations.filter(location => location.active === "1").forEach(location => {
                const option = document.createElement('option');
                option.value = location.ID;
                option.textContent = `${location.name} - ${location.full_address}`;
                select.appendChild(option);
            });
        }

       function loadLocationsTable() {
			const tbody = document.getElementById('locationsTableBody');
			tbody.innerHTML = '';
			
			locations.forEach(location => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${location.name}</td>
					<td>${location.full_address}</td>
					<td>${location.contact_person}</td>
					<td>${location.allowed_day}</td>
					<td>${location.interval_weeks} שבועות</td>
					<td>${location.active}</td>
					<td>
						<button class="action-btn edit-btn" onclick="editLocation('${location.ID}')">ערוך</button>
						<button class="action-btn delete-btn" onclick="deleteLocation('${location.ID}')">מחק</button>
					</td>
				`;
				tbody.appendChild(row);
			});
		}

       function loadReceiptsTable() {
			const tbody = document.getElementById('receiptsTableBody');
			tbody.innerHTML = '';
			
			if (receipts.length === 0) {
				tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">אין קבלות</td></tr>';
				return;
			}

			receipts.forEach(receipt => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${receipt.book_number}</td>
					<td>${receipt.receipt_number}</td>
					<td>${formatDate(receipt.date)}</td>
					<td>${receipt.location_name}</td>
					<td>${receipt.amount}</td>
					<td>${receipt.payment_type}</td>
					<td>${receipt.codeX || ''}</td>
					<td>
						<button class="action-btn edit-btn" onclick="editReceipt('${receipt.ID}')">ערוך</button>
						<button class="action-btn delete-btn" onclick="deleteReceipt('${receipt.ID}')">מחק</button>
					</td>
				`;
				tbody.appendChild(row);
			});
		}

        // Visithandling
        function startVisitForlocation(locationId) {
            const location = locations.find(g => g.ID === locationId);
            if (location) {
                showSection('visit');
                document.getElementById('locationSelect').value = locationId;
            }
        }

        function handleVisitSubmit(event) {
			event.preventDefault();
			
			const formData = new FormData(event.target);
			const selectedLocationId = document.getElementById('locationSelect').value;
			const visitDate = document.getElementById('visitDate').value; // התאריך הנוכחי
			const endTime = document.getElementById('endTime').value;
			const paymentStatus = document.getElementById('paymentStatus').value;
			
			// בדיקות בסיסיות
			if (!selectedLocationId) {
				showError('אנא בחר לקוח');
				return;
			}
			
			// בדיקת כפילות
			const duplicateVisit = checkDuplicateVisit(selectedLocationId, visitDate);
			if (duplicateVisit) {
				const location = locations.find(loc => loc.ID == selectedLocationId);
				const locationName = location ? location.name : 'לקוח לא ידוע';
				
				const confirmMessage = `כבר קיים טיפול ללקוח "${locationName}" היום (${formatDate(visitDate)}).\n\nהאם להוסיף טיפול נוסף בכל זאת?`;
				
				if (!confirm(confirmMessage)) {
					return; // ביטול הוספה
				}
			}

			// חישוב אוטומטי של משך הזמן אם יש שעת התחלה וסיום
			let calculatedDuration = document.getElementById('duration_minutes').value;
			const startTime = document.getElementById('visitTime').value;
			if (startTime && endTime) {
				const start = new Date(`2000-01-01 ${startTime}`);
				const end = new Date(`2000-01-01 ${endTime}`);
				const diffMs = end - start;
				if (diffMs > 0) {
					calculatedDuration = Math.round(diffMs / (1000 * 60)); // הפרש בדקות
					document.getElementById('duration_minutes').value = calculatedDuration;
				}
			}


			const visitData = {
				location_id: selectedLocationId,  
				visit_type: document.getElementById('visitType').value,
				work_done: document.getElementById('workDone').value,
				duration_minutes: parseFloat(document.getElementById('manualDurationMinutes').value) || 0,
				workers_count: parseInt(document.getElementById('numberOfWorkersVisit').value) || 1,		
				amount: document.getElementById('amount').value || 0,
				expense: document.getElementById('expense').value || 0,
				date: visitDate,
				start_time: document.getElementById('visitTime').value,
				end_time: endTime,
				paid: paymentStatus,
				notes: document.getElementById('notes') ? document.getElementById('notes').value : ''
			};
			
			console.log('Visitdata:', visitData);
			
			// Here we would save to Google Sheets
			saveVisit(visitData);
		}

		// לשנות בפונקציה הקיימת - להוסיף שמירה לשיטס
		async function saveVisit(visitData) {
			try {
				// For now, just add to local array
				const newVisit = {
					ID: generateID(),
					location_name: location ? location.name : '',
					notes: visitData.notes || '',     // משתמש בערך מהטופס
					...visitData                      // שאר הנתונים - ללא paid
				};
				
				// בדיקת תקינות
				const visitErrors = validateVisitData(visitData);
				if (showValidationErrors(visitErrors)) {
					return;
				}
				
				// בדיקת כפילויות ביקור
				const existingVisit = visits.find(visit => 
					visit.location_id === visitData.location_id &&
					visit.date === visitData.date &&
					Math.abs(new Date(`${visit.date} ${visit.start_time}`) - new Date(`${visitData.date} ${visitData.start_time}`)) < 60000 // פחות מדקה הפרש
				);

				if (existingVisit) {
					if (!confirm(`כבר קיים ביקור באותה כתובת באותו תאריך ושעה דומה.\n\nהאם להוסיף בכל זאת?`)) {
						return; // ביטול הוספה
					}
				}
				
				visits.push(newVisit);

				// תוספה - שמירה לגוגל שיטס
				if (access_token) {
					await saveVisitToSheets(newVisit);
				}

				// Update next visitdate if it's a full visit
				if (visitData.visit_type === 'מלא') {
				   updateNextVisitDate(visitData.location_id);
				}
		
				showSuccess('טיפול נשמר בהצלחה!');
				
				// Reset form
				document.getElementById('visitForm').reset();
			   		   
				// Reload planning data
				loadPlanningData();
				saveToLocalStorage();
				   
			} catch (error) {
				console.error('Error saving visit:', error);
				showError('שגיאה בשמירת הטיפול');
			}
		}

		function updateNextVisitDate(locationId) {
			const location = locations.find(g => g.ID == locationId);
			if (location) {
               const lastVisit= new Date();
               const intervalWeeks = parseInt(location.interval_weeks) + parseInt(location.temp_addition || 0);
               const nextVisit= new Date(lastVisit.getTime() + (intervalWeeks * 7 * 24 * 60 * 60 * 1000));
               
               location.last_visit= lastVisit.toISOString().split('T')[0];
               location.next_visit= nextVisit.toISOString().split('T')[0];
               location.temp_addition = 0; // Reset temporary addition
               
               // Here we would update Google Sheets
               console.log(`Updated next visitfor ${location.name}: ${location.next_visit}`);
			}
		}

		function postponeVisit(locationId) {
			const location = locations.find(g => g.ID == locationId);
			if (location) {
				const weeks = prompt('כמה שבועות לדחות?', '1');
				if (weeks && !isNaN(weeks)) {
					const currentNext = new Date(location.next_visit);
					const newNext = new Date(currentNext.getTime() + (parseInt(weeks) * 7 * 24 * 60 * 60 * 1000));
					location.next_visit= newNext.toISOString().split('T')[0];

					loadPlanningData();
					showSuccess(`טיפול נדחה ב-${weeks} שבועות`);
				}
			}
		}

        // location management
        function showAddLocationForm() {
			const modalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">הוספת לקוח חדש</h3>
					
					<form id="locationForm" onsubmit="handleLocationSubmit(event)">
						<div class="form-group">
							<label for="locationName">שם לקוח:</label>
							<input type="text" id="locationName" required>
						</div>
						<div class="form-group">
							<label for="locationAddress">כתובת מלאה:</label>
							<input type="text" id="locationAddress" required>
						</div>
						<div class="form-group">
							<label for="locationNeighborhood">שכונה:</label>
							<input type="text" id="locationNeighborhood">
						</div>
						<div class="form-group">
							<label for="locationCity">עיר:</label>
							<input type="text" id="locationCity">
						</div>
						<div class="form-group">
							<label for="locationContact">איש קשר:</label>
							<input type="text" id="locationContact">
						</div>
						<div class="form-group">
							<label for="locationPhone">טלפון:</label>
							<input type="tel" id="locationPhone">
						</div>
						<div class="form-group">
							<label for="locationDay">יום מועדף:</label>
							<select id="locationDay">
								<option value="כל יום">כל יום</option>
								<option value="יום ראשון">יום ראשון</option>
								<option value="יום שני">יום שני</option>
								<option value="יום שלישי">יום שלישי</option>
								<option value="יום רביעי">יום רביעי</option>
								<option value="יום חמישי">יום חמישי</option>
								<option value="יום שישי">יום שישי</option>
							</select>
						</div>
						<div class="form-group">
							<label for="locationInterval">מרווח שבועות:</label>
							<input type="number" id="locationInterval" value="4" min="1">
						</div>
						<div class="form-group">
							<label for="locationAmount">סכום בסיסי:</label>
							<input type="number" id="locationAmount">
						</div>
						<div class="form-group">
							<label for="locationActive">פעילות:</label>
							<select id="locationActive" required>
								<option value="1">פעיל</option>
								<option value="0">לא פעיל</option>
							</select>
						</div>
						<div class="form-group">
							<label for="locationNextVisit">תאריך לטיפול הבא:</label>
							<input type="date" id="locationNextVisit" required>
						</div>
						<div class="form-group">
							<label for="locationClientRequests">בקשות לקוח:</label>
							<textarea id="locationClientRequests" rows="2"></textarea>
						</div>
						<div class="form-group">
							<label for="locationNotes">הערות:</label>
							<textarea id="locationNotes" rows="3"></textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="submit" class="btn btn-success">שמור לקוח</button>
							<button type="button" onclick="closeEditModal()" class="btn btn-secondary">ביטול</button>
						</div>
					</form>
				</div>
			`;
			
			showEditModal(modalHTML);
			
			// Set default date
			document.getElementById('locationNextVisit').value = new Date().toISOString().split('T')[0];
		}

        async function handleLocationSubmit(event) {
            event.preventDefault();
           
			const locationData = {
				ID: generateID(),
				name: document.getElementById('locationName').value,
				full_address: document.getElementById('locationAddress').value,
				neighborhood: document.getElementById('locationNeighborhood').value,
				city: document.getElementById('locationCity').value,
				contact_person: document.getElementById('locationContact').value,
				phone: document.getElementById('locationPhone').value,
				allowed_day: document.getElementById('locationDay').value,
				interval_weeks: parseInt(document.getElementById('locationInterval').value),
				temp_addition: 0,
				base_amount: parseFloat(document.getElementById('locationAmount').value) || 0,
				active: document.getElementById('locationActive').value,
				notes: document.getElementById('locationNotes').value,
				client_requests: document.getElementById('locationClientRequests').value || '', // שדה חדש
				last_visit: '',
				next_visit: document.getElementById('locationNextVisit').value
			};
           
		    // בדיקת כפילויות גם לפי ID וגם לפי כתובת
			const existingLocation = locations.find(loc => 
				loc.ID === locationData.ID || 
				(loc.full_address && locationData.full_address &&
				 loc.full_address.toLowerCase().trim() === locationData.full_address.toLowerCase().trim())
			);

			if (existingLocation) {
				if (!confirm(`לקוח עם כתובת "${locationData.full_address}" כבר קיים.\n\nהאם להוסיף בכל זאת?`)) {
					return; // ביטול הוספה
				}
			}
		   
            // שמירה לזיכרון מקומי
			locations.push(locationData);

			// שמירה אוטומטית לענן
			if (access_token && spreadsheet_id) {
				document.getElementById('statusText').textContent = '🔄 שומר לקוח...';
				try {
					await saveLocationToSheets(locationData);
					document.getElementById('statusText').textContent = 'מחובר';
					showSuccess('לקוח נשמר בהצלחה ל-Google Sheets!');
				} catch (error) {
					if (error.status === 401) {
						document.getElementById('statusText').textContent = '🔓 נדרש חיבור מחדש';
						document.getElementById('statusText').classList.remove('connected');
						showToast('⚠️ החיבור לגוגל פג - התחבר מחדש', 'warning');
						access_token = null;
					} else {
						document.getElementById('statusText').textContent = '⚠️ שגיאה בשמירה';
						showToast('⚠️ הלקוח נשמר מקומית בלבד', 'warning');
					}
				}
			} else {
				showToast('🔓 לקוח נשמר מקומית - התחבר לענן לשמירה', 'warning');
			}

			closeEditModal();
			loadLocationsTable();
			loadLocationsForSelect();
			saveToLocalStorage();
        }

		function editLocation(locationId) {
			console.log(`✅ editLocation ('${locationId}')`);
			const location = locations.find(g => g.ID == locationId);
			if (!location) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			console.log(`✅ editLocation second: ('${locationId}')`);
			
			// צור חלון עריכה
			const editModalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">🏠 עריכת לקוח - ${location.name}</h3>
					
					<form id="editLocationForm">
						<div class="form-group">
							<label>שם הלקוח:</label>
							<input type="text" id="editLocationName" value="${location.name || ''}" required>
						</div>
						
						<div class="form-group">
							<label>כתובת מלאה:</label>
							<input type="text" id="editLocationAddress" value="${location.full_address || ''}" required>
						</div>
						
						<div class="form-group">
							<label>שכונה:</label>
							<input type="text" id="editLocationNeighborhood" value="${location.neighborhood || ''}">
						</div>
						
						<div class="form-group">
							<label>עיר:</label>
							<input type="text" id="editLocationCity" value="${location.city || ''}">
						</div>
						
						<div class="form-group">
							<label>איש קשר:</label>
							<input type="text" id="editLocationContact" value="${location.contact_person || ''}">
						</div>
						
						<div class="form-group">
							<label>טלפון:</label>
							<input type="tel" id="editLocationPhone" value="${location.phone || ''}">
						</div>
						
						<div class="form-group">
							<label>יום מועדף:</label>
							<select id="editLocationDay" value="${location.allowed_day||''}>
								<option value="כל יום" ${location.allowed_day === 'כל יום' ? 'selected' : ''}>כל יום</option>
								<option value="יום ראשון" ${location.allowed_day === 'יום ראשון' ? 'selected' : ''}>יום ראשון</option>
								<option value="יום שני" ${location.allowed_day === 'יום שני' ? 'selected' : ''}>יום שני</option>
								<option value="יום שלישי" ${location.allowed_day === 'יום שלישי' ? 'selected' : ''}>יום שלישי</option>
								<option value="יום רביעי" ${location.allowed_day === 'יום רביעי' ? 'selected' : ''}>יום רביעי</option>
								<option value="יום חמישי" ${location.allowed_day === 'יום חמישי' ? 'selected' : ''}>יום חמישי</option>
								<option value="יום שישי" ${location.allowed_day === 'יום שישי' ? 'selected' : ''}>יום שישי</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>מרווח בשבועות:</label>
							<input type="number" id="editLocationInterval" value="${location.interval_weeks || 4}" min="1" required>
						</div>
						
						<div class="form-group">
							<label>סכום בסיס (₪):</label>
							<input type="number" id="editLocationAmount" value="${location.base_amount || 0}" step="0.01">
						</div>
						
						<div class="form-group">
							<label>סטטוס:</label>
							<select id="editLocationActive">
								<option value="1" ${location.active === '1' ? 'selected' : ''}>פעיל</option>
								<option value="0" ${location.active === '0' ? 'selected' : ''}>לא פעיל</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>טיפול הבא:</label>
							<input type="date" id="editLocationNextVisit" value="${location.next_visit || ''}">
						</div>
						
						<div class="form-group">
							<label>הערות:</label>
							<textarea id="editLocationNotes" rows="3">${location.notes || ''}</textarea>
						</div>
						
						<div class="form-group">
							<label>בקשות לקוח:</label>
							<textarea id="editLocationClientRequests" rows="2">${location.client_requests || ''}</textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="button" onclick="saveEditedLocation('${locationId}')" class="btn btn-success">
								💾 שמור שינויים
							</button>
							<button type="button" onclick="closeEditModal()" class="btn btn-secondary">
								❌ ביטול
							</button>
						</div>
					</form>
				</div>
			`;
			
			// הצג את המודל
			showEditModal(editModalHTML);
		}

		// פונקציה לעדכון הלקוח בענן (אופציונלית)
		async function updateLocationInCloud(updatedLocation) {
			if (!await validateToken()) return;
			
			try {
				// קריאת כל הנתונים מהענן
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:P' // ✅ שונה מ-A:O ל-A:P
				});
				
				const rows = response.result.values || [];
				
				// מציאת השורה לעדכון
				let rowToUpdate = -1;
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] == updatedLocation.ID) {
						rowToUpdate = i + 1; // +1 כי Google Sheets מתחיל מ-1
						break;
					}
				}
				
				if (rowToUpdate > 0) {
					// עדכון השורה
					const updatedRow = [
						updatedLocation.ID,
						updatedLocation.name,
						updatedLocation.full_address,
						updatedLocation.neighborhood,
						updatedLocation.city,
						updatedLocation.contact_person,
						updatedLocation.phone,
						updatedLocation.allowed_day,
						updatedLocation.interval_weeks,
						updatedLocation.temp_addition || 0,
						updatedLocation.base_amount,
						updatedLocation.active,
						updatedLocation.notes,
						updatedLocation.last_visit || '',
						updatedLocation.next_visit || '',
						updatedLocation.client_requests || '' // ✅ הוסף שדה client_requests
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Locations!A${rowToUpdate}:P${rowToUpdate}`, // ✅ שונה מ-O ל-P
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [updatedRow]
						}
					});
					
					console.log(`✅ Updated location ${updatedLocation.ID} in cloud`);
				}
				
			} catch (error) {
				console.error('Error updating location in cloud:', error);
				throw error;
			}
		}
        

       function deleteLocation(locationId) {
           if (confirm('האם אתה בטוח שברצונך למחוק את הלקוח?')) {
               locations = locations.filter(g => g.ID != locationId);
               loadLocationsTable();
               loadLocationsForSelect();
               loadPlanningData();
               showSuccess('לקוח נמחק בהצלחה!');
			   saveToLocalStorage();
           }
       }

       // Receipt management
       function showAddReceiptForm() {
           const modalHTML = `
               <div class="modal" id="receiptModal">
                   <div class="modal-content">
                       <div class="modal-header">
                           <h3>הוספת קבלה חדשה</h3>
                           <span class="close" onclick="closeModal('receiptModal')">&times;</span>
                       </div>
                       <form id="receiptForm" onsubmit="handleReceiptSubmit(event)">
                           <div class="form-group">
                               <label for="receiptBook">מספר פנקס:</label>
                               <input type="number" id="receiptBook" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptNumber">מספר קבלה:</label>
                               <input type="number" id="receiptNumber" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptDate">תאריך:</label>
                               <input type="date" id="receiptDate" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptlocations">גינה:</label>
                               <select id="receiptlocations" required>
                                   <option value="">בחר גינה...</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label for="receiptAmount">סכום:</label>
                               <input type="number" id="receiptAmount" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptPaymentType">סוג תשלום:</label>
                               <select id="receiptPaymentType" required>
                                   <option value="">בחר סוג...</option>
                                   <option value="מזומן">מזומן</option>
                                   <option value="צ'ק">צ'ק</option>
                                   <option value="העברה">העברה בנקאית</option>
                                   <option value="ביט">ביט</option>
                                   <option value="פייבוקס">פייבוקס</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label for="receiptNotes">הערות:</label>
                               <textarea id="receiptNotes"></textarea>
                           </div>
                           <button type="submit">שמור קבלה</button>
                       </form>
                   </div>
               </div>
           `;
           
           document.getElementById('modalContainer').innerHTML = modalHTML;
           document.getElementById('receiptModal').style.display = 'block';
           
           // Set default date to today
           document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
           
           // Populate locations select
           const select = document.getElementById('receiptlocations');
           locations.forEach(location => {
               const option = document.createElement('option');
               option.value = location.ID;
               option.textContent = `${location.name} - ${location.full_address}`;
               select.appendChild(option);
           });
       }

       async function handleReceiptSubmit(event) {
           event.preventDefault();
           
           const locationId = document.getElementById('receiptlocation').value;
           const location = locations.find(g => g.ID == locationId);
           
           const receiptData = {
				ID: Date.now(),
				book_number: document.getElementById('receiptBook').value,
				receipt_number: document.getElementById('receiptNumber').value,
				date: document.getElementById('receiptDate').value,
				location_id: locationId,        
				location_name: location ? location.name : '',  // שונה מ-location_name
				amount: parseFloat(document.getElementById('receiptAmount').value),
				payment_type: document.getElementById('receiptPaymentType').value,
				notes: document.getElementById('receiptNotes').value
			};
           
		   // תוספה - בדיקת תקינות לפני שמירה
			const errors = validateReceiptData(receiptData);
			if (showValidationErrors(errors)) {
				return; // יש שגיאות - עצור כאן
			}
		   
		   // בדיקת כפילויות קבלה
			const existingReceipt = receipts.find(receipt => 
				(receipt.book_number === receiptData.book_number && receipt.receipt_number === receiptData.receipt_number) ||
				(receipt.location_id === receiptData.location_id && receipt.date === receiptData.date && receipt.amount === receiptData.amount)
			);

			if (existingReceipt) {
				if (!confirm(`כבר קיימת קבלה עם אותו מספר או באותה כתובת/תאריך/סכום.\n\nהאם להוסיף בכל זאת?`)) {
					return; // ביטול הוספה
				}
			}
		   
            receipts.push(receiptData);
		   
			if (access_token) {
				await saveReceiptToSheets(receiptData);
				showSuccess('קבלה נשמרה בהצלחה ל-Google Sheets!');
			} else {
				showSuccess('קבלה נשמרה מקומית!');
			}

			closeModal('receiptModal');
			loadReceiptsTable();
			saveToLocalStorage();
       }

       // Utility functions
       function closeModal(modalId) {
           document.getElementById(modalId).style.display = 'none';
       }

       function formatDate(dateString) {
           const date = new Date(dateString);
           return date.toLocaleDateString('he-IL');
       }

       function showLoading(message) {
           // Could implement loading spinner
           console.log('Loading:', message);
       }

       function hideLoading() {
           // Hide loading spinner
           console.log('Loading complete');
       }

       
       // Click outside modal to close
       window.onclick = function(event) {
           if (event.target.classList.contains('modal')) {
               event.target.style.display = 'none';
           }
       }
	   
	  function editReceipt(receiptId) {
			console.log(`✅ editReceipt ('${receiptId}')`);
			const receipt = receipts.find(r => r.ID == receiptId);
			if (!receipt) {
				showToast('קבלה לא נמצאה', 'error');
				return;
			}
			
			// בניית אפשרויות הלקוחות
			let locationOptions = '<option value="">בחר לקוח</option>';
			locations.forEach(location => {
				const selected = location.ID == receipt.location_id ? 'selected' : '';
				locationOptions += `<option value="${location.ID}" ${selected}>${location.name} - ${location.full_address}</option>`;
			});
			
			// צור חלון עריכה
			const editModalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">🧾 עריכת קבלה</h3>
					
					<form id="editReceiptForm">
						<div class="form-group">
							<label>מספר פנקס:</label>
							<input type="text" id="editReceiptBook" value="${receipt.book_number || ''}" required>
						</div>
						
						<div class="form-group">
							<label>מספר קבלה:</label>
							<input type="text" id="editReceiptNumber" value="${receipt.receipt_number || ''}" required>
						</div>
						
						<div class="form-group">
							<label>תאריך:</label>
							<input type="date" id="editReceiptDate" value="${receipt.date}" required>
						</div>
						
						<div class="form-group">
							<label>לקוח:</label>
							<select id="editReceiptLocation" required>
								${locationOptions}
							</select>
						</div>
						
						<div class="form-group">
							<label>סכום (₪):</label>
							<input type="number" step="0.01" id="editReceiptAmount" value="${receipt.amount || 0}" required>
						</div>
						
						<div class="form-group">
							<label>סוג תשלום:</label>
							<select id="editReceiptPaymentType">
								<option value="מזומן" ${receipt.payment_type === 'מזומן' ? 'selected' : ''}>מזומן</option>
								<option value="העברה" ${receipt.payment_type === 'העברה' ? 'selected' : ''}>העברה</option>
								<option value="צ׳ק" ${receipt.payment_type === 'צ׳ק' ? 'selected' : ''}>צ׳ק</option>
								<option value="כרטיס אשראי" ${receipt.payment_type === 'כרטיס אשראי' ? 'selected' : ''}>כרטיס אשראי</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>הערות:</label>
							<textarea id="editReceiptNotes" rows="3">${receipt.notes || ''}</textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="button" onclick="saveEditedReceipt('${receiptId}')" class="btn btn-success">
								💾 שמור שינויים
							</button>
							<button type="button" onclick="closeEditModal()" class="btn btn-secondary">
								❌ ביטול
							</button>
						</div>
					</form>
				</div>
			`;
			
			// הצג את המודל
			showEditModal(editModalHTML);
		}

		
		// פונקציה לעדכון הקבלה בענן (אופציונלית)
		async function updateReceiptInCloud(updatedReceipt) {
			if (!await validateToken()) return;
			
			try {
				// קריאת כל הנתונים מהענן
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Receipts!A:I'
				});
				
				const rows = response.result.values || [];
				
				// מציאת השורה לעדכון
				let rowToUpdate = -1;
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] == updatedReceipt.ID) {
						rowToUpdate = i + 1; // +1 כי Google Sheets מתחיל מ-1
						break;
					}
				}
				
				if (rowToUpdate > 0) {
					// עדכון השורה
					const updatedRow = [
						updatedReceipt.ID,
						updatedReceipt.book_number,
						updatedReceipt.receipt_number,
						updatedReceipt.date,
						updatedReceipt.location_id,
						updatedReceipt.location_name,
						updatedReceipt.amount,
						updatedReceipt.payment_type,
						updatedReceipt.notes
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Receipts!A${rowToUpdate}:I${rowToUpdate}`,
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [updatedRow]
						}
					});
					
					console.log(`✅ Updated receipt ${updatedReceipt.ID} in cloud`);
				}
				
			} catch (error) {
				console.error('Error updating receipt in cloud:', error);
				throw error;
			}
		}

		
		function deleteReceipt(receiptId) {
			if (confirm('האם אתה בטוח שברצונך למחוק את הקבלה?')) {
				receipts = receipts.filter(r => r.ID != receiptId);
				loadReceiptsTable();
				saveToLocalStorage();
				showSuccess('קבלה נמחקה בהצלחה!');
			}
		}
	   
	   // תוספה - הודעות Toast מתקדמות
		function showToast(message, type = 'info', duration = 3000) {
			const toastContainer = document.getElementById('toastContainer');
			
			if (!toastContainer) {
				console.error('Toast container not found');
				return;
			}
			
			const toast = document.createElement('div');
			toast.className = `toast ${type}`;
			toast.textContent = message;
			
			toastContainer.appendChild(toast);
			
			// Trigger animation
			setTimeout(() => {
				toast.classList.add('show');
			}, 100);
			
			// Remove toast after specified duration
			setTimeout(() => {
				toast.classList.remove('show');
				setTimeout(() => {
					if (toast.parentNode) {
						toast.parentNode.removeChild(toast);
					}
				}, 300);
			}, duration);
		}
	   
	   // פונקציות עזר להודעות
		function showSuccess(message, duration = 3000) {
			showToast(message, 'success', duration);
		}

		function showError(message, duration = 4000) {
			showToast(message, 'error', duration);
		}

		function showWarning(message, duration = 3500) {
			showToast(message, 'warning', duration);
		}

		function showInfo(message, duration = 3000) {
			showToast(message, 'info', duration);
		}
	   
	   
	    // יצירת טבלת עזר לייבוא
		async function clearAllDataBeforeImport() {
			if (confirm('האם אתה בטוח שברצונך למחוק את כל הנתונים הקיימים לפני הייבוא החדש?\n\nפעולה זו תמחק:\n- את כל המיקומים\n- את כל הביקורים\n- את כל הקבלות\n\nהנתונים בגוגל שיטס לא יימחקו.')) {
				locations = [];
				visits = [];
				receipts = [];
				saveToLocalStorage();
				
				// עדכון רק הפונקציות שקיימות
				loadLocationsTable();
				loadReceiptsTable(); 
				loadFilterOptions();
				
				showToast('כל הנתונים נוקו בהצלחה', 'success');
				return true;
			}
			return false;
		}

		// שיפור לפונקציה הקיימת
		async function createImportTable() {
			if (!await validateToken()) {
				showToast('התחבר לגוגל קודם', 'warning');
				return;
			}
			
			try {
				showLoading('יוצר טבלת עזר לייבוא...');
				
				const response = await gapi.client.sheets.spreadsheets.create({
					resource: {
						properties: {
							title: `import_table_${new Date().toISOString().split('T')[0]}`
						},
						sheets: [{
							properties: { title: 'Locations' },
						}, {
							properties: { title: 'Visits' },
						}, {
							properties: { title: 'Receipts' }
						}, {
							properties: { title: 'SystemSettings' }
						}]
					}
				});
				
				const newSpreadsheetId = response.result.spreadsheetId;
				
				// הוספת כותרות לכל גליון
				await addImportHeaders(newSpreadsheetId);
				
				// פתיחת הטבלה
				window.open(`https://docs.google.com/spreadsheets/d/${newSpreadsheetId}/edit`, '_blank');
				
				// שמירת ID לייבוא מאוחר יותר
				localStorage.setItem('importTableId', newSpreadsheetId);
				
				showToast('טבלת עזר נוצרה! מלא את הנתונים ואז חזור לייבא', 'success');
				
			} catch (error) {
				console.error('Error creating import table:', error);
				showToast('שגיאה ביצירת טבלת עזר', 'error');
			} finally {
				hideLoading();
			}
		}

		// הוספת כותרות לטבלת עזר
		async function addImportHeaders(spreadsheetId) {
			if (!await validateToken()) {
				showToast('בעיה בחיבור לגוגל במהלך הוספת כותרות', 'error');
				return;
			}

			try {
				// כל הכותרות באנגלית
				const locationHeaders = [['customer_name', 'street', 'house_number', 'city', 'frequency', 'contact_person', 'base_amount']];
				const visitHeaders = [['year', 'month', 'day', 'customer', 'contact_person', 'treatment', 'date', 'work_done', 'duration', 'amount', 'paid', 'expense', 'notes']];
				const receiptHeaders = [['code_x', 'booklet', 'receipt', 'year', 'month', 'day', 'address', 'amount', 'type', 'notes', 'details']];
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				await Promise.all([
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Locations!A1:G1',
						valueInputOption: 'RAW',
						resource: { values: locationHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Visits!A1:M1',
						valueInputOption: 'RAW', 
						resource: { values: visitHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Receipts!A1:K1',
						valueInputOption: 'RAW',
						resource: { values: receiptHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'SystemSettings!A1:B1',
						valueInputOption: 'RAW',
						resource: { values: [['Setting', 'Value']] }
					})
				]);			
				
				console.log('Headers added successfully to import table');
				
			} catch (error) {
				console.error('Error adding headers:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('⚠️ החיבור פג במהלך הוספת כותרות', 'warning');
				} else {
					showToast('⚠️ שגיאה בהוספת כותרות לטבלה', 'error');
				}
				throw error;
			}
		}
		
		
		// תוספה - פיענוח כתובת מלאה לחלקים
		function parseFullAddress(fullAddress) {
			if (!fullAddress) return { street: '', houseNumber: '', city: '' };
			
			const parts = fullAddress.trim().split(' ');
			
			if (parts.length >= 3) {
				// העיר היא החלק האחרון
				const city = parts[parts.length - 1];
				
				// מספר הבית הוא החלק הלפני אחרון
				const houseNumber = parts[parts.length - 2];
				
				// הרחוב הוא כל השאר
				const street = parts.slice(0, -2).join(' ');
				
				return { street, houseNumber, city };
			} else if (parts.length === 2) {
				return { street: parts[0], houseNumber: '', city: parts[1] };
			} else {
				return { street: fullAddress, houseNumber: '', city: '' };
			}
		}
	   
	   // תוספה - ייבוא לקוחות מטבלת עזר
		async function importCustomersFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('טבלת עזר לא נמצאה - צור קודם', 'warning');
					return;
				}
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: importTableId,
					range: 'Locations!A2:G1000' // עד G במקום H
				});
				
				const rows = response.result.values || [];
				let importedCount = 0;
				let newLocations = []; // מערך לאיסוף כל הלקוחות החדשים
				
				for (const row of rows) {
					if (row.length > 0 && row[0]) { // יש שם לקוח
						// מיפוי לפי הכותרות החדשות באנגלית:
						const customerName = row[0].trim();  // customer_name
						const street = row[1] || '';         // street  
						const houseNumber = row[2] || '';    // house_number
						const city = row[3] || '';           // city
						const frequency = row[4] || '';      // frequency
						const contactPerson = row[5] || '';  // contact_person
						const baseAmount = row[6] || '';     // base_amount
						
						// בניית כתובת מלאה
						const fullAddress = `${street} ${houseNumber} ${city}`.trim();
						
						// בדוק אם לקוח כבר קיים (לפי כתובת מלאה)
						const existingCustomer = locations.find(loc => 
							loc.full_address && 
							loc.full_address.toLowerCase() === fullAddress.toLowerCase()
						);
						
						if (existingCustomer) {
							console.log(`לקוח ${fullAddress} כבר קיים - דולג`);
							continue;
						}
						
						const locationData = {
							ID: generateID(),
							name: customerName,           // שם הלקוח (עכשיו נפרד מהכתובת)
							full_address: fullAddress,   // כתובת מלאה מורכבת
							neighborhood: '',
							city: city,
							contact_person: contactPerson,
							phone: '',
							allowed_day: 'כל יום',
							interval_weeks: parseInt(frequency) || 4,
							temp_addition: 0,
							base_amount: parseFloat(baseAmount) || 0,
							active: "1",
							notes: 'יובא מטבלת לקוחות',
							last_visit: '',
							next_visit: ''
						};
						
						locations.push(locationData);
						newLocations.push(locationData); // הוסף למערך החדש
						importedCount++;
					}
				}
				
				// שמירה מקבצית אחת בסוף:
				if (newLocations.length > 0) {
					showToast(`שומר ${newLocations.length} לקוחות בבת אחת...`, 'info', 2000);
					const success = await saveLocationsBatch(newLocations);
					
					if (success) {
						showToast(`✅ יובאו ${importedCount} לקוחות במהירות!`, 'success');
					} else {
						showToast('⚠️ בעיה בשמירה לענן - נשמר מקומית בלבד', 'warning');
					}
				} else {
					showToast('לא נמצאו לקוחות חדשים לייבוא', 'info');
				}
				
				// עדכון תצוגות
				saveToLocalStorage();
				loadLocationsTable();
				loadLocationsForSelect();
				
			} catch (error) {
				console.error('Error importing customers:', error);
				showToast('שגיאה בייבוא לקוחות', 'error');
			}
		}
	   
	   // תוספה - ייבוא טיפולים מטבלת עזר
		async function importVisitsFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('טבלת עזר לא נמצאה - צור קודם', 'warning');
					return;
				}
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: importTableId,
					range: 'Visits!A2:M1000'
				});
				
				const rows = response.result.values || [];
				let importedCount = 0;
				let notFoundCustomers = [];
				let newVisits = []; // מערך לאיסוף כל הביקורים החדשים
				
				for (const row of rows) {
					if (row.length > 3 && row[3]) { // יש לקוח בעמודה 3 (customer)
						// מיפוי לפי הכותרות החדשות באנגלית:
						const year = row[0];                    // year
						const month = row[1];                   // month
						const day = row[2];                     // day
						const customerName = row[3].trim();     // customer
						const contactPerson = row[4] || '';     // contact_person
						const treatment = row[5] || 'מלא';      // treatment
						const dateField = row[6];               // date (לא נשתמש - נבנה מהעמודות הראשונות)
						const workDone = row[7] || '';          // work_done
						const duration = row[8] || 0;           // duration
						const amount = row[9] || 0;             // amount
						const paid = row[10] || '';           // paid
						const expense = row[11] || 0;           // expense
						const notes = row[12] || '';            // notes
						
						// מצא לקוח קיים לפי כתובת מלאה
						const existingCustomer = locations.find(loc => 
							loc.full_address && 
							loc.full_address.toLowerCase().includes(customerName.toLowerCase())
						);
						
						if (!existingCustomer) {
							if (!notFoundCustomers.includes(customerName)) {
								notFoundCustomers.push(customerName);
							}
							continue;
						}
						
						// בניית תאריך נכון מ-3 עמודות
						const visitDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
						
						const visitData = {
							ID: generateID(),
							date: visitDate,
							location_id: existingCustomer.ID,
							location_name: existingCustomer.name,
							visit_type: treatment,
							work_done: workDone,
							duration_minutes: parseFloat(duration) * 60 || 0, // שעות → דקות
							start_time: '',
							end_time: '',
							amount: parseFloat(amount) || 0,
							expense: parseFloat(expense) || 0,
							paid: mapPaymentStatus(paid),
							notes: notes
						};
						
						visits.push(visitData);
						newVisits.push(visitData); // הוסף למערך החדש
						// עדכון תאריכי טיפול לאחר הוספת ביקור חדש
						// await updateSingleLocationTreatmentDates(visitData.location_id);
						importedCount++;
					}
				}
				
				// שמירה מקבצית אחת בסוף:
				if (newVisits.length > 0) {
					showToast(`שומר ${newVisits.length} ביקורים בבת אחת...`, 'info', 2000);
					const success = await saveVisitsBatch(newVisits);
					
					if (success) {
						showToast(`✅ יובאו ${importedCount} ביקורים במהירות!`, 'success');
					} else {
						showToast('⚠️ בעיה בשמירה לענן - נשמר מקומית בלבד', 'warning');
					}
				} else {
					showToast('לא נמצאו ביקורים חדשים לייבוא', 'info');
				}
				
				// עדכון תצוגות
				saveToLocalStorage();
				loadPlanningData();
				
				// הודעה על לקוחות שלא נמצאו
				let message = `יובאו ${importedCount} ביקורים בהצלחה!`;
				if (notFoundCustomers.length > 0) {
					message += `\n⚠️ ${notFoundCustomers.length} לקוחות לא נמצאו: ${notFoundCustomers.slice(0, 3).join(', ')}${notFoundCustomers.length > 3 ? '...' : ''}`;
					showToast(message, 'warning', 5000);
				}
				
			} catch (error) {
				console.error('Error importing visits:', error);
				showToast('שגיאה בייבוא ביקורים', 'error');
			}
		}
	   
	   
	   // תוספה - ייבוא קבלות מטבלת עזר
		async function importReceiptsFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('טבלת עזר לא נמצאה - צור קודם', 'warning');
					return;
				}
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: importTableId,
					range: 'Receipts!A2:K1000'
				});
				
				const rows = response.result.values || [];
				let importedCount = 0;
				let notFoundCustomers = [];
				
				for (const row of rows) {
					if (row.length > 6 && row[6]) { // יש כתובת בעמודה 6 (G)
						const customerAddress = row[6].trim(); // עמודה "כתובת"
						
						// מצא לקוח קיים לפי כתובת מלאה
						const existingCustomer = locations.find(loc => 
							loc.full_address && 
							loc.full_address.toLowerCase().includes(customerAddress.toLowerCase())
						);
						
						if (!existingCustomer) {
							if (!notFoundCustomers.includes(customerAddress)) {
								notFoundCustomers.push(customerAddress);
							}
							continue;
						}
						
						// בניית תאריך מ-3 עמודות
						const year = row[3];   // שנה - עמודה D
						const month = String(row[4]).padStart(2, '0');  // חודש - עמודה E
						const day = String(row[5]).padStart(2, '0');    // יום - עמודה F
						const receiptDate = `${year}-${month}-${day}`;
						
						const receiptData = {
							ID: generateID(),
							book_number: row[1] || '',      // פנקס - עמודה B
							receipt_number: row[2] || '',   // קבלה - עמודה C
							date: receiptDate,              // תאריך נכון
							location_id: existingCustomer.ID,
							location_name: customerAddress,
							amount: parseFloat(row[7]) || 0, // סכום - עמודה H
							payment_type: row[8] || '',     // סוג - עמודה I
							codeX: row[0] || '',           // XK - עמודה A
							notes: `${row[9] || ''} ${row[10] || ''}`.trim() // הערות + פירוט
						};
						
						receipts.push(receiptData);
						importedCount++;
					}
				}
				
				// שמירה
				await saveAllToSheets();
				loadReceiptsTable();
				
				let message = `יובאו ${importedCount} קבלות בהצלחה!`;
				if (notFoundCustomers.length > 0) {
					message += `\n⚠️ ${notFoundCustomers.length} לקוחות לא נמצאו: ${notFoundCustomers.slice(0, 3).join(', ')}${notFoundCustomers.length > 3 ? '...' : ''}`;
				}
				
				showToast(message, 'success');
				
			} catch (error) {
				console.error('Error importing receipts:', error);
				showToast('שגיאה בייבוא קבלות', 'error');
			}
		}
	   
	   // תוספה - המרת פורמט תאריך מ-DD/MM/YYYY ל-YYYY-MM-DD
		function convertDateFormat(dateStr) {
			if (!dateStr) return '';
			
			const parts = dateStr.split('/');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = parts[1].padStart(2, '0');
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			
			return dateStr;
		}
	   
	   
	   // תוספה - ייבוא מלא מטבלת העזר
		async function importFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('טבלת עזר לא נמצאה - צור קודם', 'warning');
					return;
				}
				
				showToast('מתחיל ייבוא מלא...', 'info');
				
				// ייבוא בסדר: לקוחות → טיפולים → קבלות
				await importCustomersFromHelper();
				await new Promise(resolve => setTimeout(resolve, 1000)); // המתנה קצרה
				
				await importVisitsFromHelper();
				await new Promise(resolve => setTimeout(resolve, 1000)); // המתנה קצרה
				
				await importReceiptsFromHelper();
				
				showToast('🎉 ייבוא מלא הושלם בהצלחה!', 'success', 5000);
				
				setTimeout(() => {
					if (confirm('ייבוא הושלם בהצלחה!\n\nהאם למחוק את טבלת העזר מה-Google Drive?')) {
						showToast('💡 ניתן למחוק את טבלת העזר ידנית בגוגל דרייב', 'info');
						localStorage.removeItem('importTableId');
					}
				}, 2000);
				
			} catch (error) {
				console.error('Error in full import:', error);
				showToast('שגיאה בייבוא מלא', 'error');
			}
		}
	   
	   // תוספה - בדיקת תקינות נתונים
		function validateReceiptData(receiptData) {
			const errors = [];
			
			if (!receiptData.location_id) {
				errors.push('חובה לבחור לקוח');
			}
			
			if (!receiptData.amount || receiptData.amount <= 0) {
				errors.push('חובה להזין סכום חיובי');
			}
			
			if (!receiptData.date) {
				errors.push('חובה להזין תאריך');
			}
			
			return errors;
		}

		function showValidationErrors(errors) {
			if (errors.length > 0) {
				showToast(errors.join('\n'), 'error');
				return true; // יש שגיאות
			}
			return false; // אין שגיאות
		}
	   
	   
	    // תוספה - ניהול פאנלי סינון ומידע
		function toggleFilterPanel() {
			const content = document.getElementById('filterContent');
			const icon = document.getElementById('filterIcon');
			
			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				icon.textContent = '🔽';
			} else {
				content.classList.add('collapsed');
				icon.textContent = '🔼';
			}
		}

		function toggleInfoPanel() {
			const content = document.getElementById('infoContent');
			const icon = document.getElementById('infoIcon');
			
			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				icon.textContent = '🔽';
			} else {
				content.classList.add('collapsed');
				icon.textContent = '🔼';
			}
		}

		// תוספה - טעינת אפשרויות סינון
		function loadFilterOptions() {
			const locationSelect = document.getElementById('filterLocation');
			locationSelect.innerHTML = '<option value="">כל הלקוחות</option>';
			
			locations.forEach(location => {
				const option = document.createElement('option');
				option.value = location.ID;
				option.textContent = location.name;
				locationSelect.appendChild(option);
			});
		}
	   
		// תוספה - סינון וטעינת טיפולים
		function applyVisitFilters() {
			const locationFilter = document.getElementById('filterLocation').value;
			const paymentFilter = document.getElementById('filterPayment').value;
			const dateFromFilter = document.getElementById('filterDateFrom').value;
			const dateToFilter = document.getElementById('filterDateTo').value;
			
			let filteredVisits = visits.filter(visit => {
				// סינון לפי לקוח
				if (locationFilter && visit.location_id != locationFilter) {
					return false;
				}
				
				// סינון לפי סטטוס תשלום
				if (paymentFilter && visit.paid !== paymentFilter) {
					return false;
				}
				
				// סינון לפי תאריך
				if (dateFromFilter && visit.date < dateFromFilter) {
					return false;
				}
				
				if (dateToFilter && visit.date > dateToFilter) {
					return false;
				}
				
				return true;
			});
			
			displayFilteredVisits(filteredVisits);
			updateVisitsInfo(filteredVisits);
		}

		function clearVisitFilters() {
			document.getElementById('filterLocation').value = '';
			document.getElementById('filterPayment').value = '';
			document.getElementById('filterDateFrom').value = '';
			document.getElementById('filterDateTo').value = '';
			
			displayFilteredVisits(visits);
			updateVisitsInfo(visits);
		}

		// תוספה - הצגת טיפולים מסוננים
		function displayFilteredVisits(filteredVisits) {
			const tbody = document.getElementById('visitsHistoryTableBody');
			tbody.innerHTML = '';
			
			if (filteredVisits.length === 0) {
				tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">אין טיפולים תואמים לסינון</td></tr>';
				return;
			}
			
			// מיון לפי תאריך (החדשים ראשונים)
			filteredVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
			
			filteredVisits.forEach(visit => {
				const location = locations.find(loc => loc.ID == visit.location_id);
				const locationName = visit.location_name || (location ? location.name : `לא נמצא (ID: ${visit.location_id})`);
				//////////console.log(`Visit location_id: ${visit.location_id}, Found location:`, location);   //////>>>>>>>>>>>>>
				
				const row = document.createElement('tr');
				
				// הדגשת שורות לפי סטטוס תשלום
				// הדגשת שורות לפי סטטוס תשלום - נבדק בטבלת תשלומים
				const paymentStatus = getVisitPaymentStatus(visit.ID);
				if (paymentStatus === 'unpaid') {
					row.style.backgroundColor = '#fff2cc'; // צהוב עדין לחובות
				} else if (paymentStatus === 'paid') {
					row.style.backgroundColor = '#d4edda'; // ירוק עדין לשולם
				}
				
				row.innerHTML = `
					<td>${formatDate(visit.date)}</td>
					<td>${locationName}</td>
					<td>${visit.visit_type}</td>
					<td>${visit.work_done}</td>
					<td>${(visit.duration_minutes / 60).toFixed(2)}</td>
					<td>
						<div style="display: flex; flex-direction: column; align-items: center;">
							<span style="font-weight: bold; color: #27ae60;">₪${visit.amount}</span>
							${getVisitCostBreakdown(visit)}
						</div>
					</td>
					<td>
						<td>
							<span class="payment-status payment-${paymentStatus}">
								${getPaymentStatusText(paymentStatus)}
							</span>
						</td>
					</td>
					<td>
						<button class="action-btn edit-btn" onclick="editVisit('${visit.ID}')">ערוך</button>
						<button class="action-btn delete-btn" onclick="deleteVisit('${visit.ID}')">מחק</button>
					</td>
				`;
				tbody.appendChild(row);
			});
		}

		// הוסף פונקציה חדשה להצגת פירוט עלויות:
		function getVisitCostBreakdown(visit) {
			if (!visit.duration_minutes) return '<span style="font-size: 11px; color: #999;">ללא פירוט</span>';
			
			const hours = (visit.duration_minutes / 60).toFixed(2);
			const workers = visit.num_workers || 1;
			const expense = visit.expense || 0;
			
			let breakdown = `${hours}ש`;
			if (workers > 1) breakdown += ` × ${workers}ע`;
			if (expense > 0) breakdown += ` + ₪${expense}`;
			
			return `<span style="font-size: 11px; color: #666;">${breakdown}</span>`;
		}

		// תוספה - עדכון פאנל המידע
		function updateVisitsInfo(filteredVisits) {
			const visitsCount = filteredVisits.length;
			const totalHours = filteredVisits.reduce((sum, visit) => sum + (visit.duration_minutes / 60), 0);
			const totalIncome = filteredVisits.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			const outstandingDebt = filteredVisits
				.reduce((sum, visit) => {
					if (!visit.amount || visit.amount <= 0) return sum;
					const visitAmount = parseFloat(visit.amount);
					const paidAmount = getVisitPaidAmount(visit.ID);
					const debt = visitAmount - paidAmount;
					return sum + (debt > 0 ? debt : 0);
				}, 0);
			
			document.getElementById('visitsCount').textContent = visitsCount;
			document.getElementById('totalHours').textContent = totalHours.toFixed(2);
			document.getElementById('totalIncome').textContent = `₪${totalIncome.toLocaleString()}`;
			document.getElementById('outstandingDebt').textContent = `₪${outstandingDebt.toLocaleString()}`;
			
			// הדגשת חובות פתוחים
			const debtElement = document.getElementById('outstandingDebt');
			if (outstandingDebt > 0) {
				debtElement.style.color = '#e74c3c';
				debtElement.style.fontWeight = 'bold';
			} else {
				debtElement.style.color = '#27ae60';
				debtElement.style.fontWeight = 'bold';
			}
			
			// חישוב נתונים מפורטים יותר על חובות
			const visitsWithDebt = filteredVisits.filter(visit => {
				if (!visit.amount || visit.amount <= 0) return false;
				const visitAmount = parseFloat(visit.amount);
				const paidAmount = getVisitPaidAmount(visit.ID);
				return (visitAmount - paidAmount) > 0;
			});
			const uniqueDebtors = new Set(visitsWithDebt.map(visit => visit.location_id)).size;
			
			// הצגת מידע נוסף בכרטיסי הסיכום
			if (outstandingDebt > 0) {
				const avgDebtPerClient = uniqueDebtors > 0 ? Math.round(outstandingDebt / uniqueDebtors) : 0;
				document.getElementById('outstandingDebt').title = 
					`${uniqueDebtors} לקוחות חייבים | ממוצע ₪${avgDebtPerClient} ללקוח`;
			}
	
		}



		// תוספה - טעינה ראשונית של הטאב
		function loadVisitsHistory() {
			loadFilterOptions();
			displayFilteredVisits(visits);
			updateVisitsInfo(visits);
		}

		async function editVisit(visitId) {
			console.log(`✅ editVisit ('${visitId}') `);
			const visit = visits.find(v => v.ID == visitId);
			if (!visit) {
				showToast('ביקור לא נמצא', 'error');
				return;
			}
			
			console.log(`✅ editVisit second: ('${visitId}') `);
			
			// מצא את הלקוח
			const location = locations.find(loc => loc.ID == visit.location_id);
			const locationName = location ? location.name : 'לקוח לא נמצא';
			
			// צור חלון עריכה
			const editModalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">✏️ עריכת ביקור - ${locationName}</h3>
					
					<form id="editVisitForm">
						<div class="form-group">
							<label>תאריך:</label>
							<input type="date" id="editVisitDate" value="${visit.date}" required>
						</div>
						
						<div class="form-group">
							<label>סוג טיפול:</label>
							<select id="editVisitType">
								<option value="מלא" ${visit.visit_type === 'מלא' ? 'selected' : ''}>מלא</option>
								<option value="חלקי" ${visit.visit_type === 'חלקי' ? 'selected' : ''}>חלקי</option>
								<option value="ביקורת" ${visit.visit_type === 'ביקורת' ? 'selected' : ''}>ביקורת</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>עבודה שבוצעה:</label>
							<textarea id="editWorkDone" rows="3">${visit.work_done || ''}</textarea>
						</div>
						
						<div class="form-group">
							<label>משך זמן (דקות):</label>
							<input type="number" id="editDuration" value="${visit.duration_minutes || 0}">
						</div>
						
						<div class="form-group">
							<label>שעת התחלה:</label>
							<input type="time" id="editStartTime" value="${visit.start_time || ''}">
						</div>
						
						<div class="form-group">
							<label>סכום (₪):</label>
							<input type="number" step="0.01" id="editAmount" value="${visit.amount || 0}">
						</div>
						
						<div class="form-group">
							<label>הוצאות (₪):</label>
							<input type="number" step="0.01" id="editExpense" value="${visit.expense || 0}">
						</div>
						
						<div class="form-group">
							<label>סטטוס תשלום:</label>
							<select id="editPaid">
								<option value="0" ${visit.paid === '0' ? 'selected' : ''}>לא שולם</option>
								<option value="1" ${visit.paid === '1' ? 'selected' : ''}>שולם</option>
								<option value="2" ${visit.paid === '2' ? 'selected' : ''}>ללא תשלום</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>הערות:</label>
							<textarea id="editNotes" rows="3">${visit.notes || ''}</textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="button" onclick="saveEditedVisit('${visitId}')" class="btn btn-success">
								💾 שמור שינויים
							</button>
							<button type="button" onclick="closeEditModal()" class="btn btn-secondary">
								❌ ביטול
							</button>
						</div>
					</form>
				</div>
			`;
			
			// הצג את המודל
			showEditModal(editModalHTML);
		}

		// הצגת מודל עריכה (אם לא קיימת)
		function showEditModal(content) {
			// הסר מודל קיים אם יש
			const existingModal = document.getElementById('editModal');
			if (existingModal) {
				existingModal.remove();
			}
			
			// צור מודל חדש
			const modal = document.createElement('div');
			modal.id = 'editModal';
			modal.style.cssText = `
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.6);
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 10000;
				backdrop-filter: blur(3px);
			`;
			
			modal.innerHTML = content;
			
			// הוספה לעמוד
			document.body.appendChild(modal);
			
			// סגירה בלחיצה על הרקע
			modal.addEventListener('click', function(e) {
				if (e.target === modal) {
					closeEditModal();
				}
			});
		}

		// סגירת מודל עריכה
		function closeEditModal() {
			const modal = document.getElementById('editModal');
			if (modal) {
				modal.remove();
			}
		}


		
		// פונקציה לעדכון הביקור בענן
		async function updateVisitInCloud(updatedVisit) {
			if (!await validateToken()) return;
			
			try {
				// קריאת כל הנתונים מהענן
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Visits!A:N'
				});
				
				const rows = response.result.values || [];
				
				// מציאת השורה לעדכון
				let rowToUpdate = -1;
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] == updatedVisit.ID) {
						rowToUpdate = i + 1; // +1 כי Google Sheets מתחיל מ-1
						break;
					}
				}
				
				if (rowToUpdate > 0) {
					// עדכון השורה
					const updatedRow = [
						updatedVisit.ID,
						updatedVisit.date,
						updatedVisit.location_id,
						updatedVisit.location_name || '',
						updatedVisit.visit_type,
						updatedVisit.work_done,
						updatedVisit.duration_minutes,
						updatedVisit.num_workers || 1,
						updatedVisit.start_time,
						updatedVisit.end_time || '',
						updatedVisit.amount,
						updatedVisit.expense,
						updatedVisit.paid,
						updatedVisit.notes
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Visits!A${rowToUpdate}:N${rowToUpdate}`,
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [updatedRow]
						}
					});
					
					console.log(`✅ Updated visit ${updatedVisit.ID} in cloud`);
				}
				
			} catch (error) {
				console.error('Error updating visit in cloud:', error);
				throw error;
			}
		}

		function deleteVisit(visitId) {
			console.log(`✅ deleteVisit ('${visitId}') `);
			if (confirm('האם אתה בטוח שברצונך למחוק את הטיפול?')) {
				visits = visits.filter(visit => visit.ID != visitId);
				applyVisitFilters(); // רענן תצוגה
				saveToLocalStorage();
				showToast('טיפול נמחק בהצלחה!', 'success');
			}
		}
	   
	   // תוספה - בדיקת רשאות
		async function checkPermissions() {
			if (!access_token) {
				showToast('לא מחובר לגוגל - התחבר קודם', 'warning');
				return false;
			}
			
			try {
				// נסה לגשת לטבלה הראשית
				await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				return true;
			} catch (error) {
				if (error.status === 401) {
					showToast('החיבור פג - התחבר מחדש', 'warning');
					access_token = null;
				} else if (error.status === 403) {
					showToast('אין הרשאה לטבלה - בדוק שיתוף', 'error');
				}
				return false;
			}
		}
	   
	   
	   // תוספה - בדיקה תקופתית של חיבור
		setInterval(async () => {
			if (access_token) {
				const isValid = await validateToken();
				if (!isValid) {
					console.log('Token expired - disconnected');
				}
			}
		}, 300000); // בדיקה כל 5 דקות
	   
	   // תוספה - חישוב שעות מדקות
		function updateHoursDisplay() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const hours = (minutes / 60).toFixed(2);
			document.getElementById('calculatedHours').value = hours > 0 ? hours : '';
		}
	   
	    // חישוב עלות טיפול מעודכן
		function calculateTreatmentCost() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const workers = parseInt(document.getElementById('numberOfWorkersVisit').value) || 1;
			const expense = parseFloat(document.getElementById('expense').value) || 0;
			
			if (minutes > 0) {
				const hours = minutes / 60;
				const baseCost = costSettings.hourlyRate * hours;
				// תיקון: עלות עובדים נוספים (לא כולל אותך)
				const workersCost = (workers - 1) * costSettings.workerCost * hours;
				const laborCost = baseCost + workersCost;
				const totalCost = laborCost + expense;
				
				// עדכן את שדה הסכום
				document.getElementById('amount').value = Math.round(totalCost);
				
				// הצג פירוט מפורט יותר
				let breakdown = `${hours.toFixed(2)} שעות × ₪${costSettings.hourlyRate} = ₪${Math.round(baseCost)}`;
				
				if (workers > 1) {
					breakdown += `\n+ ${workers - 1} עובדים × ₪${costSettings.workerCost}/שעה = ₪${Math.round(workersCost)}`;
				}
				
				if (expense > 0) {
					breakdown += `\n+ הוצאות: ₪${expense}`;
				}
				
				breakdown += `\n= סה"כ: ₪${Math.round(totalCost)}`;
				
				document.getElementById('costBreakdown').textContent = breakdown;
				document.getElementById('costBreakdown').style.whiteSpace = 'pre-line';
			} else {
				document.getElementById('costBreakdown').textContent = '';
			}
		}

		// הוסף חישוב אוטומטי כשמקלידים משך זמן
		function updateHoursDisplay() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const hours = minutes > 0 ? (minutes / 60).toFixed(2) : '';
			document.getElementById('calculatedHours').value = hours;
			
			// חשב עלויות אוטומטית
			calculateTreatmentCost();
		}

		// שמירת הגדרות עלות פשוטה יותר
		function saveCostSettings() {
			costSettings.hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 150;
			costSettings.workerCost = parseFloat(document.getElementById('workerCost').value) || 50;
			
			localStorage.setItem('cost_settings', JSON.stringify(costSettings));
			
			if (access_token) {
				saveSettingsToCloud().then(success => {
					if (success) {
						showToast('הגדרות עלות נשמרו בענן', 'success');
					} else {
						showToast('הגדרות נשמרו מקומית בלבד', 'warning');
					}
				});
			} else {
				showToast('הגדרות נשמרו מקומית', 'success');
			}
		}
	   
	   // תוספה - בדיקת טיפול כפול
		function checkDuplicateVisit(locationId, visitDate) {
			const existingVisit = visits.find(visit => 
				visit.location_id == locationId && 
				visit.date === visitDate
			);
			
			return existingVisit;
		}
	   
	   // תוספה - אתחול תאריך ושעה נוכחיים
		function initializeVisitForm() {
			const now = new Date();
			document.getElementById('visitDate').value = now.toISOString().split('T')[0];
			document.getElementById('visitTime').value = now.toTimeString().split(':').slice(0,2).join(':');
		}

		// קריאה לאתחול כשהדף נטען
		document.addEventListener('DOMContentLoaded', function() {
			initializeVisitForm();
		});
	   
	   // פונקציה לשמירת הגדרות לענן
		async function saveSettingsToCloud() {
			if (!await validateToken()) {
				return false;
			}
			
			try {
				const settingsData = [
					['Setting', 'Value'],
					['hourly_rate', costSettings.hourlyRate],
					['worker_cost', costSettings.workerCost],
					['last_updated', new Date().toISOString()]
				];
				
				await gapi.client.sheets.spreadsheets.values.clear({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A:B`
				});
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A1:B4`,
					valueInputOption: 'RAW',
					resource: { values: settingsData }
				});
				
				return true;
			} catch (error) {
				console.error('Error saving settings:', error);
				return false;
			}
		}

		// פונקציה לטעינת הגדרות מהענן
		async function loadSettingsFromCloud() {
			if (!await validateToken()) {
				return false;
			}
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A:B`
				});
				
				const rows = response.result.values || [];
				if (rows.length > 1) {
					rows.slice(1).forEach(row => {
						const [setting, value] = row;
						if (setting === 'hourly_rate') {
							costSettings.hourlyRate = parseFloat(value) || 150;
						}
						if (setting === 'worker_cost') {
							costSettings.workerCost = parseFloat(value) || 50;
						}
					});
					
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
					
					return true;
				}
			} catch (error) {
				console.error('Error loading settings:', error);
				return false;
			}
			
			return false;
		}
	   
	   // פונקציה חדשה לבדיקה ויצירת הטבלה הראשית
		async function findOrCreateMainSpreadsheet() {
			try {
				console.log('Searching for existing main spreadsheet...');
				
				// חיפוש טבלה קיימת
				const response = await gapi.client.request({
					path: 'https://www.googleapis.com/drive/v3/files',
					params: {
						q: `name='${SPREADSHEET_NAME}' and mimeType='application/vnd.google-apps.spreadsheet'`,
					}
				});
				
				if (response.result.files.length > 0) {
					console.log('Found existing spreadsheet');
					SPREADSHEET_ID = response.result.files[0].id;
					showToast('נמצאה טבלה קיימת!', 'success');
					
					// בדיקה ותיקון של מבנה הטבלה
					await checkAndFixTableStructure();
				} else {
					console.log('No spreadsheet found, creating new one...');
					await createNewMainSpreadsheet();
				}
				
			} catch (error) {
				console.error('Error in findOrCreateMainSpreadsheet:', error);
				showToast('שגיאה בחיפוש טבלה', 'error');
			}
		}

		// פונקציה חדשה ליצירת טבלה ראשית חדשה
		async function createNewMainSpreadsheet() {
			console.log('Creating new main spreadsheet...');
			try {
				const response = await gapi.client.request({
					path: 'https://sheets.googleapis.com/v4/spreadsheets',
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${access_token}`,
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						properties: {
							title: SPREADSHEET_NAME
						},
						sheets: [
							{ properties: { title: 'Locations' } },
							{ properties: { title: 'Visits' } },
							{ properties: { title: 'Receipts' } },
							{ properties: { title: 'SystemSettings' } }
						]
					})
				});
				
				SPREADSHEET_ID = response.result.spreadsheetId;
				
				// הוסף כותרות לכל הגיליונות
				await addAllHeaders();
				
				showToast('נוצרה טבלה חדשה!', 'success');
				
			} catch (error) {
				console.error('Error creating spreadsheet:', error);
				showToast('שגיאה ביצירת טבלה', 'error');
			}
		}
		
		// פונקציה חדשה לבדיקה ותיקון מבנה הטבלה
		// פונקציה חדשה לבדיקה ותיקון מבנה הטבלה
		async function checkAndFixTableStructure() {
			console.log('Checking and fixing table structure...');
			
			try {
				// בדיקת כותרות בכל גיליון - כולל החדשים
				const sheetsToCheck = ['Locations', 'Visits', 'Receipts', 'TelegramVisits', 'TelegramIncomes', 'Payments', 'PaymentVisitLink'];
				
				for (const sheetName of sheetsToCheck) {
					try {
						const response = await gapi.client.sheets.spreadsheets.values.get({
							spreadsheetId: SPREADSHEET_ID,
							range: `${sheetName}!A1:A1`
						});
						
						if (!response.result.values || !response.result.values[0][0]) {
							console.log(`Headers missing in ${sheetName}, adding them...`);
							await addHeadersToSheet(sheetName);
						}
					} catch (error) {
						console.log(`Sheet ${sheetName} missing or error, will add headers:`, error);
						await addHeadersToSheet(sheetName);
					}
				}
				
				console.log('✅ Table structure verified');
				
			} catch (error) {
				console.log('Headers check failed, will force add them:', error);
				await addAllHeaders();
			}
		}
		
		// פונקציה חדשה להוספת כותרות לגיליון ספציפי
		async function addHeadersToSheet(sheetName) {
			try {
				let headers = [];
				
				switch (sheetName) {
					case 'Locations':
						headers = [
							'ID', 'name', 'full_address', 'neighborhood', 'city', 'contact_person', 
							'phone', 'allowed_day', 'interval_weeks', 'temp_addition', 
							'base_amount', 'active', 'notes', 'last_visit', 'next_visit', 'client_requests'
						];
						break;
					case 'Visits':
						headers = [
							'ID', 'date', 'location_id', 'location_name', 'visit_type', 'work_done', 
							'duration_minutes', 'num_workers', 'start_time', 'end_time', 
							'amount', 'expense', 'notes'
						];
						break;
					case 'Receipts':
						headers = [
							'ID', 'book_number', 'receipt_number', 'date', 'location_id', 
							'location_name', 'amount', 'payment_type', 'notes'
						];
						break;
					case 'TelegramVisits':
						headers = [
							'ID', 'date', 'time', 'client_name', 'visit_type', 
							'work_done', 'duration_minutes', 'raw_text', 'processed', 'created_at'
						];
						break;
						
					case 'TelegramIncomes':
						headers = [
							'ID', 'date', 'time', 'client_address', 'amount', 'payment_method',
							'notes', 'raw_text', 'matched_to_visit', 'visit_ids', 'processed', 'created_at'
						];
						break;
						
					case 'Payments':
						headers = [
							'ID', 'date', 'time', 'amount', 'payment_method', 'source_type',
							'client_id', 'notes', 'status', 'created_at'
						];
						break;
						
					case 'PaymentVisitLink':
						headers = [
							'ID', 'payment_id', 'visit_id', 'amount_allocated', 'link_type', 'created_at'
						];
						break;
				}
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `${sheetName}!A1:${String.fromCharCode(64 + headers.length)}1`,
					valueInputOption: 'RAW',
					values: [headers]
				});
				
				console.log(`✅ Added headers to ${sheetName}`);
				
			} catch (error) {
				console.error(`Error adding headers to ${sheetName}:`, error);
			}
		}
		
		// פונקציה משופרת להוספת כותרות לכל הגיליונות
		async function addAllHeaders() {
			try {
				console.log('Adding headers to all sheets...');
				
				await addHeadersToSheet('Locations');
				await addHeadersToSheet('Visits');
				await addHeadersToSheet('Receipts');
				
				// הוספת כותרות ל-SystemSettings
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'SystemSettings!A1:B1',
					valueInputOption: 'RAW',
					values: [['setting_key', 'setting_value']]
				});
				
				console.log('✅ All headers added successfully');
				
			} catch (error) {
				console.error('Error adding all headers:', error);
			}
		}  
	   
	   async function importFromHelperTable() {
			if (!await validateToken()) {
				showToast('התחבר לגוגל קודם', 'warning');
				return;
			}
			
			const importTableId = localStorage.getItem('importTableId');
			if (!importTableId) {
				showToast('לא נמצא ID של טבלת העזר', 'warning');
				return;
			}
			
			console.log('🔍 Import Table ID:', importTableId); // לוג חדש
			
			try {
				showLoading('מייבא נתונים מטבלת העזר...');
				
				let importedCount = 0;
				
				// ייבוא מיקומים
				try {
					console.log('📍 Starting locations import...'); // לוג חדש
					
					const locationsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Locations!A2:O1000'
					});
					
					console.log('📍 Locations response:', locationsResponse.result); // לוג חדש
					
					if (locationsResponse.result.values && locationsResponse.result.values.length > 0) {
						console.log('📍 Found', locationsResponse.result.values.length, 'location rows'); // לוג חדש
						
						for (const row of locationsResponse.result.values) {
							if (row[0] && row[1]) {
								const locationData = parseLocationFromRow(row);
								locations.push(locationData);
								importedCount++;
								
								await new Promise(resolve => setTimeout(resolve, 200));
							}
						}
						showToast(`יובאו ${importedCount} מיקומים`, 'success');
					} else {
						console.log('📍 No locations data found'); // לוג חדש
					}
				} catch (error) {
					console.error('📍 Locations import error:', error); // לוג חדש
				}
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				// ייבוא ביקורים
				try {
					console.log('🔧 Starting visits import...');
					
					const visitsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Visits!A2:M1000'
					});
					
					console.log('🔧 Visits response:', visitsResponse.result);
					
					let visitsCount = 0;
					if (visitsResponse.result.values && visitsResponse.result.values.length > 0) {
						console.log('🔧 Found', visitsResponse.result.values.length, 'visit rows');
						
						for (let i = 0; i < visitsResponse.result.values.length; i++) {
							const row = visitsResponse.result.values[i];
							if (row[0] && row[1]) {
								const visitData = parseVisitFromRow(row);
								if (!isDuplicateVisit(visitData)) {
									visits.push(visitData);
									// עדכון תאריכי טיפול לאחר הוספת ביקור חדש
									//await updateSingleLocationTreatmentDates(visitData.location_id);
									visitsCount++;
								} else {
									console.log('⚠️ Duplicate visit skipped:', visitData.date, visitData.location_id);
								}
								visitsCount++;
								
								// הצג התקדמות כל 50 רשומות
								if (visitsCount % 50 === 0) {
									console.log(`🔧 Processed ${visitsCount}/${visitsResponse.result.values.length} visits`);
									showToast(`מעבד ביקור ${visitsCount}...`, 'info', 1000);
								}
								
								await new Promise(resolve => setTimeout(resolve, 100)); // המתנה קצרה יותר
							}
						}
						showToast(`יובאו ${visitsCount} ביקורים`, 'success');
					} else {
						console.log('🔧 No visits data found');
					}
				} catch (error) {
					console.error('🔧 Visits import error:', error);
				}
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				// ייבוא קבלות
				try {
					console.log('🧾 Starting receipts import...');
					
					const receiptsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Receipts!A2:J1000'
					});
					
					console.log('🧾 Receipts response:', receiptsResponse.result);
					
					let receiptsCount = 0;
					if (receiptsResponse.result.values && receiptsResponse.result.values.length > 0) {
						console.log('🧾 Found', receiptsResponse.result.values.length, 'receipt rows');
						
						for (let i = 0; i < receiptsResponse.result.values.length; i++) {
							const row = receiptsResponse.result.values[i];
							if (row[0] && row[3]) { // ID ותאריך
								const receiptData = parseReceiptFromRow(row);
								
								
								if (!isDuplicateReceipt(receiptData)) {
									receipts.push(receiptData);
									receiptsCount++;
								} else {
									console.log('⚠️ Duplicate receipt skipped:', receiptData.date, receiptData.location_id);
								}
								
								// הצג התקדמות כל 25 רשומות (קבלות בדרך כלל פחות)
								if (receiptsCount % 25 === 0) {
									console.log(`🧾 Processed ${receiptsCount}/${receiptsResponse.result.values.length} receipts`);
									showToast(`מעבד קבלה ${receiptsCount}...`, 'info', 1000);
								}
								
								await new Promise(resolve => setTimeout(resolve, 100)); // המתנה קצרה יותר
							}
						}
						showToast(`יובאו ${receiptsCount} קבלות`, 'success');
					} else {
						console.log('🧾 No receipts data found');
					}
				} catch (error) {
					console.error('🧾 Receipts import error:', error);
				}
				
				// שמירה מקומית ועדכון תצוגה
				saveToLocalStorage();
				loadLocationsTable();
				loadReceiptsTable();
				loadFilterOptions();

				// בדיקה שהנתונים נטענו נכון
				console.log('🔍 בדיקת ייבוא:');
				console.log(`לקוחות: ${locations.length}`);
				console.log(`ביקורים: ${visits.length}`);
				console.log(`קבלות: ${receipts.length}`);

				// הצג דוגמה של הרשומה הראשונה מכל סוג
				if (locations.length > 0) {
					console.log('דוגמה לקוח:', locations[0]);
				}
				if (visits.length > 0) {
					console.log('דוגמה ביקור:', visits[0]);
				}


				// תוספה חשובה - שמירה לענן!
				showToast('שומר נתונים חדשים לענן...', 'info');

				try {
					/// await saveAllToSheets();
					/// await saveAllToSheetsOptimized();
					
					// שמירה מהירה לפי סוג נתונים
					const locationSuccess = await saveLocationsBatch(newLocations || []);
					const visitSuccess = await saveVisitsBatch(newVisits || []);  
					const receiptSuccess = await saveReceiptsBatch(newReceipts || []);

					if (locationSuccess && visitSuccess && receiptSuccess) {
						showToast('🚀 שמירה מהירה הושלמה בהצלחה!', 'success');
					} else {
						showToast('⚠️ חלק מהנתונים לא נשמרו לענן', 'warning');
					}

					showToast(`🎉 ייבוא הושלם בהצלחה!
					📍 ${locationsCount || 0} מיקומים
					🔧 ${visitsCount || 0} ביקורים  
					🧾 ${receiptsCount || 0} קבלות
					✅ הכל נשמר לענן!`, 'success', 6000);
				} catch (error) {
					console.error('Error saving imported data to cloud:', error);
					showToast('ייבוא הושלם מקומית, אבל שגיאה בשמירה לענן', 'warning');
				}
				
			} catch (error) {
				console.error('Import error:', error);
				showToast('שגיאה בייבוא נתונים', 'error');
			} finally {
				hideLoading();
			}
		}

		// פונקציות עזר לפרסור שורות
		function parseVisitFromRow(row) {
			return {
				ID: row[0] || generateID(),
				date: row[1] || '',
				location_id: row[2] || '',
				visit_type: row[3] || '',
				work_done: row[4] || '',
				duration_minutes: parseInt(row[5]) || 0,
				num_workers: parseInt(row[6]) || 1,
				start_time: row[7] || '',
				end_time: row[8] || '',
				amount: parseFloat(row[9]) || 0,
				expense: parseFloat(row[10]) || 0,
				paid: row[11] || 'לא',
				notes: row[12] || ''
			};
		}

		function parseReceiptFromRow(row) {
			return {
				ID: row[0] || generateID(),
				booklet_number: row[1] || '',
				receipt_number: row[2] || '',
				date: row[3] || '',
				location_id: row[4] || '',
				location_name: row[5] || '',
				amount: parseFloat(row[6]) || 0,
				payment_type: row[7] || '',
				tax_code: row[8] || '',
				notes: row[9] || ''
			};
		}
	   
	   // הוסף את זה לסוף הקוד
		function updateImportTableStatus() {
			const importTableId = localStorage.getItem('importTableId');
			const statusDiv = document.getElementById('importTableStatus');
			
			if (importTableId && statusDiv) {
				statusDiv.innerHTML = `
					<span style="font-size: 13px; color: #28a745;">
						✅ טבלת עזר זמינה: 
						<a href="https://docs.google.com/spreadsheets/d/${importTableId}/edit" 
						   target="_blank" style="color: #007bff; text-decoration: underline;">
						   פתח טבלה
						</a>
					</span>
					<br>
					<button onclick="localStorage.removeItem('importTableId'); updateImportTableStatus();" 
							style="background: none; border: none; color: #dc3545; font-size: 12px; cursor: pointer; margin-top: 5px;">
						🗑️ מחק קישור לטבלת עזר
					</button>
				`;
			} else if (statusDiv) {
				statusDiv.innerHTML = `
					<span style="font-size: 13px; color: #666;">
						❌ לא נמצאה טבלת עזר שמורה
					</span>
					<br>
					<span style="font-size: 12px; color: #999;">
						צור טבלת עזר חדשה כדי לייבא נתונים
					</span>
				`;
			}
		}

		// הרץ את זה כשהדף נטען
		document.addEventListener('DOMContentLoaded', function() {
			updateImportTableStatus();
		});

		// הרץ גם כשעוברים לטאב המערכת
		function showTab(event, tabName) {
			// הקוד הקיים שלך...
			
			// הוסף את זה בסוף הפונקציה
			if (tabName === 'system') {
				setTimeout(() => {
					updateImportTableStatus();
					updateTelegramHelperStatus(); // הוסף שורה זו
				}, 100);
			}
		}
	   
	   


		// הוסף פונקציה להצגת מידע על טבלת עזר טלגרם
		function updateTelegramHelperStatus() {
			const telegramTableId = localStorage.getItem('telegramHelperTableId');
			const statusDiv = document.getElementById('telegramHelperStatus');
			
			if (statusDiv) {
				if (telegramTableId) {
					statusDiv.innerHTML = `
						<span style="color: green;">✓ טבלת עזר טלגרם מוכנה</span>
						<br>
						<a href="https://docs.google.com/spreadsheets/d/${telegramTableId}" target="_blank" style="font-size: 12px;">
							פתח בגוגל שיטס
						</a>
					`;
				} else {
					statusDiv.innerHTML = `
						<span style="color: orange;">⚠ לא נמצאה טבלת עזר טלגרם</span>
						<br>
						<span style="font-size: 12px;">צור טבלה חדשה תחילה</span>
					`;
				}
			}
		}

		// פונקציה ראשית משופרת לפיענוח טקסט טלגרם
		function parseTelegramText(text) {
			const lines = text.split('\n');
			const visits = [];
			
			let currentDate = '';
			let currentTime = '';
			let currentVisit = null;
			let pendingNotes = [];
			
			for (let i = 0; i < lines.length; i++) {
				const line = lines[i].trim();
				if (!line) continue;
				
				// זיהוי תאריך
				if (isDateLine(line)) {
					// אם יש ביקור פתוח, סגור אותו
					if (currentVisit) {
						visits.push(finalizeVisit(currentVisit, pendingNotes));
						currentVisit = null;
						pendingNotes = [];
					}
					currentDate = parseTelegramDate(line);
					continue;
				}
				
				// זיהוי שעה
				if (isTimeLine(line)) {
					currentTime = line;
					continue;
				}
				
				// זיהוי שורה של Assaf H
				if (line === 'Assaf H') {
					const nextLine = lines[i + 1];
					if (!nextLine) continue;
					
					// בדוק אם זה תחילת ביקור חדש
					if (isNewVisitStart(nextLine, locations)) {
						// סגור ביקור קודם אם קיים
						if (currentVisit) {
							visits.push(finalizeVisit(currentVisit, pendingNotes));
							pendingNotes = [];
						}
						
						// התחל ביקור חדש
						const client = findClientSmart(nextLine, locations);
						currentVisit = {
							date: currentDate,
							time: currentTime,
							client: client,
							workDescription: [nextLine],
							duration: 0,
							workType: identifyWorkType(nextLine),
							notes: []
						};
					}
					// בדוק אם זה סיום ביקור
					else if (currentVisit && isVisitEnd(nextLine)) {
						currentVisit.workDescription.push(nextLine);
						const duration = extractTimeFromText(nextLine);
						if (duration > 0) {
							currentVisit.duration = duration;
						}
						
						// בדוק אם יש זמן בשורות הבאות
						if (currentVisit.duration === 0 && i + 2 < lines.length) {
							const timeInfo = extractTimeFromText(lines[i + 2]);
							if (timeInfo > 0) {
								currentVisit.duration = timeInfo;
							}
						}
						
						visits.push(finalizeVisit(currentVisit, pendingNotes));
						currentVisit = null;
						pendingNotes = [];
					}
					// אחרת, זה פרט נוסף על הביקור הנוכחי
					else if (currentVisit) {
						currentVisit.workDescription.push(nextLine);
						
						// בדוק אם יש זמן בשורה זו
						const duration = extractTimeFromText(nextLine);
						if (duration > 0 && currentVisit.duration === 0) {
							currentVisit.duration = duration;
						}
						
						// עדכן סוג עבודה אם נמצא סוג חדש
						const workType = identifyWorkType(nextLine);
						if (workType !== 'כללי' && currentVisit.workType === 'כללי') {
							currentVisit.workType = workType;
						}
					}
					
					// איסוף הערות
					const notes = extractNotes(nextLine);
					if (notes) {
						if (currentVisit) {
							currentVisit.notes.push(notes);
						} else {
							pendingNotes.push(notes);
						}
					}
					
					i++; // דלג על השורה הבאה כי כבר עיבדנו אותה
				}
				// שורות אחרות שעלולות להכיל מידע
				else {
					const notes = extractNotes(line);
					if (notes) {
						if (currentVisit) {
							currentVisit.notes.push(notes);
						} else {
							pendingNotes.push(notes);
						}
					}
					
					// בדוק אם יש זמן בשורות עצמאיות
					if (currentVisit && currentVisit.duration === 0) {
						const duration = extractTimeFromText(line);
						if (duration > 0) {
							currentVisit.duration = duration;
						}
					}
				}
			}
			
			// סגור ביקור אחרון אם קיים
			if (currentVisit) {
				visits.push(finalizeVisit(currentVisit, pendingNotes));
			}
			
			return visits;
		}

		// פונקציה עזר לסיום ביקור
		function finalizeVisit(visit, pendingNotes) {
			const client = visit.client;
			
			// אם לא נמצא זמן, נסה לחשב מהשעות או קבע ברירת מחדל
			if (visit.duration === 0) {
				if (visit.time) {
					// כאן אפשר להוסיף לוגיקה לחישוב זמן מהפרש שעות
					visit.duration = 60; // ברירת מחדל של שעה
				} else {
					visit.duration = 60;
				}
			}
			
			// פורמט שמתאים בדיוק לקוד הקיים של confirmTelegramImport
			return {
				date: visit.date,
				time: visit.time || '',
				client_name: client ? client.name : 'לא זוהה',
				client_id: client ? client.ID : null,
				address: client ? client.full_address : '',
				work_done: visit.workDescription.join(' '),
				duration_minutes: visit.duration,
				raw_text: visit.workDescription.join('\n') + '\n' + [...visit.notes, ...pendingNotes].join('\n')
			};
		}

		// פונקציות עזר לזיהוי דפוסים
		function isDateLine(line) {
			// זיהוי תאריך כמו "15 August 2024"
			const dateRegex = /^\d{1,2}\s+[A-Za-z]+\s+\d{4}$/;
			return dateRegex.test(line);
		}

		function isTimeLine(line) {
			// זיהוי שעה כמו "13:39"
			const timeRegex = /^\d{1,2}:\d{2}$/;
			return timeRegex.test(line);
		}

		function parseTelegramDate(dateStr) {
			// המר "15 August 2024" ל-"2024-08-15"
			const months = {
				'January': '01', 'February': '02', 'March': '03', 'April': '04',
				'May': '05', 'June': '06', 'July': '07', 'August': '08',
				'September': '09', 'October': '10', 'November': '11', 'December': '12'
			};
			
			const parts = dateStr.split(' ');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = months[parts[1]] || '01';
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			
			return '';
		}

		// יצירת טבלת עזר טלגרם חדשה
		async function createTelegramHelperTable() {
			if (!await validateToken()) {
				showToast('נדרש חיבור לגוגל תחילה', 'warning');
				return null;
			}
			
			try {
				showLoading('יוצר טבלת עזר טלגרם...');
				
				const response = await gapi.client.sheets.spreadsheets.create({
					resource: {
						properties: {
							title: `טבלת עזר טלגרם - ${new Date().toLocaleDateString('he-IL')}`
						},
						sheets: [{
							properties: { title: 'Visits' }
						}]
					}
				});
				
				const spreadsheetId = response.result.spreadsheetId;
				
				// הוסף כותרות
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: spreadsheetId,
					range: 'Visits!A1:M1',
					valueInputOption: 'RAW',
					resource: {
						values: [[
							'year', 'month', 'day', 'customer', 'contact_person', 
							'treatment', 'date', 'work_done', 'duration', 'amount', 
							'paid', 'expense', 'notes'
						]]
					}
				});
				
				localStorage.setItem('telegramHelperTableId', spreadsheetId);
				
				showToast('✅ טבלת עזר טלגרם נוצרה בהצלחה!', 'success');
				
				return spreadsheetId;
				
			} catch (error) {
				console.error('Error creating telegram helper table:', error);
				showToast('שגיאה ביצירת טבלת עזר טלגרם', 'error');
				return null;
			} finally {
				hideLoading();
			}
		}


		// פונקציה חדשה - יבוא מטלגרם לטבלת עזר טלגרם
		async function importFromTelegramToHelper() {
			const fileInput = document.createElement('input');
			fileInput.type = 'file';
			fileInput.accept = '.txt';
			fileInput.multiple = true;
			
			fileInput.onchange = async (event) => {
				const files = Array.from(event.target.files);
				if (files.length === 0) return;
				
				try {
					showLoading(`מפרסר ${files.length} קבצי טלגרם לטבלת עזר...`);
					
					let allParsedVisits = [];
					
					for (let i = 0; i < files.length; i++) {
						const file = files[i];
						console.log(`📄 Processing file ${i+1}/${files.length}: ${file.name}`);
						
						const text = await file.text();
						const parsedVisits = parseTelegramText(text);
						
						console.log(`📄 File ${file.name}: found ${parsedVisits.length} visits`);
						allParsedVisits = allParsedVisits.concat(parsedVisits);
						
						if (i < files.length - 1) {
							await new Promise(resolve => setTimeout(resolve, 300));
						}
					}
					
					if (allParsedVisits.length > 0) {
						// שלח ישירות לטבלת עזר טלגרם
						await saveTelegramDataToHelper(allParsedVisits);
						showToast(`נתונים נשמרו בטבלת עזר טלגרם: ${allParsedVisits.length} ביקורים`, 'success');
					} else {
						showToast('לא נמצאו ביקורים בקבצים', 'warning');
					}
					
				} catch (error) {
					console.error('Error parsing telegram files:', error);
					showToast('שגיאה בפרסור קבצי טלגרם', 'error');
				} finally {
					hideLoading();
				}
			};
			
			fileInput.click();
		}

		// פונקציה לשמירת נתונים בטבלת עזר טלגרם
		async function saveTelegramDataToHelper(parsedVisits) {
			if (!await validateToken()) {
				showToast('נדרש חיבור לגוגל', 'error');
				return;
			}
			
			try {
				// שמור לשתי המערכות: הישנה והחדשה
				
				// 1. שמירה למערכת הישנה (טבלה נפרדת)
				let telegramTableId = localStorage.getItem('telegramHelperTableId');
				
				if (!telegramTableId) {
					telegramTableId = await createTelegramHelperTable();
					if (!telegramTableId) return;
				}
				
				// המר את הנתונים לפורמט CSV הישן
				const csvData = parsedVisits.map(visit => [
					visit.date.split('-')[0], // year
					visit.date.split('-')[1], // month
					visit.date.split('-')[2], // day
					visit.client_name,
					'', // contact_person - ימולא מהמערכת
					identifyWorkType(visit.work_done),
					visit.date,
					visit.work_done,
					visit.duration_minutes.toString(),
					'0', // amount
					'לא', // paid
					'0', // expense
					visit.raw_text || '' // notes
				]);
				
				// שמור לטבלת עזר הישנה
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: telegramTableId,
					range: 'Visits!A:M',
					valueInputOption: 'USER_ENTERED',
					resource: {
						values: csvData
					}
				});
				
				// 2. שמירה למערכת החדשה (TelegramVisits)
				await saveTelegramVisitsToCloud(parsedVisits);
				
				console.log(`✅ שמר ${parsedVisits.length} ביקורים לשתי המערכות`);
				
			} catch (error) {
				console.error('Error saving to telegram helper table:', error);
				showToast('שגיאה בשמירה לטבלת עזר טלגרם', 'error');
			}
		}

		// פונקציה ליבוא מטבלת עזר טלגרם למערכת הראשית
		async function importFromTelegramHelper() {
			if (!await validateToken()) {
				showToast('נדרש חיבור לגוגל', 'error');
				return;
			}
			
			const telegramTableId = localStorage.getItem('telegramHelperTableId');
			if (!telegramTableId) {
				showToast('לא נמצאה טבלת עזר טלגרם. צור טבלה חדשה תחילה.', 'warning');
				return;
			}
			
			try {
				showLoading('מייבא נתונים מטבלת עזר טלגרם...');
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: telegramTableId,
					range: 'Visits!A2:M1000'
				});
				
				if (!response.result.values || response.result.values.length === 0) {
					showToast('טבלת עזר טלגרם ריקה', 'warning');
					return;
				}
				
				let importedCount = 0;
				
				for (const row of response.result.values) {
					if (row[0] && row[3]) { // יש שנה ושם לקוח
						const visitData = {
							ID: generateID(),
							date: `${row[0]}-${row[1].padStart(2, '0')}-${row[2].padStart(2, '0')}`,
							location_id: findLocationByName(row[3])?.ID || null,
							location_name: row[3] || '',
							visit_type: row[5] || 'כללי',
							work_done: row[7] || '',
							duration_minutes: parseInt(row[8]) || 60,
							num_workers: 1,
							start_time: '',
							end_time: '',
							amount: parseInt(row[9]) || 0,
							expense: parseInt(row[11]) || 0,
							notes: row[12] || ''
						};
						
						visits.push(visitData);
						importedCount++;
					}
				}
				
				// שמור הכל
				saveToLocalStorage();
				loadReceiptsTable();
				loadFilterOptions();
				await saveAllToSheetsOptimized();
				
				showToast(`יובאו בהצלחה ${importedCount} ביקורים מטבלת עזר טלגרם!`, 'success');
				
			} catch (error) {
				console.error('Error importing from telegram helper:', error);
				showToast('שגיאה ביבוא מטבלת עזר טלגרם', 'error');
			} finally {
				hideLoading();
			}
		}

		// פונקציה עזר למציאת לקוח לפי שם
		function findLocationByName(customerName) {
			if (!customerName) return null;
			
			return locations.find(loc => 
				loc.name && loc.name.toLowerCase().includes(customerName.toLowerCase())
			) || null;
		}


		// פונקציה משופרת לזיהוי לקוחות - תחליף את findClientInText הקיימת
		function findClientSmart(text, locations) {
			if (!text || !locations) return null;
			
			const textLower = text.toLowerCase().trim();
			
			// שלב 1: התאמה ישירה מלאה
			for (const location of locations) {
				if (location.name && textLower.includes(location.name.toLowerCase())) {
					return location;
				}
				if (location.full_address && textLower.includes(location.full_address.toLowerCase())) {
					return location;
				}
			}
			
			// שלב 2: זיהוי לפי רחוב + מספר (עם או בלי עיר)
			const addressMatch = textLower.match(/([א-ת\s']+)\s+(\d+)/);
			if (addressMatch) {
				const street = addressMatch[1].trim();
				const number = addressMatch[2];
				
				for (const location of locations) {
					if (location.name) {
						const locationParts = location.name.toLowerCase().split(' ');
						if (locationParts.length >= 2) {
							const locationStreet = locationParts[0];
							const locationNumber = locationParts[1];
							
							if (street.includes(locationStreet) && number === locationNumber) {
								return location;
							}
						}
					}
				}
			}
			
			// שלב 3: זיהוי שמות חלקיים (כמו "ויניק" במקום "ויניק 49 ראשלצ")
			const words = textLower.split(/\s+/);
			for (const word of words) {
				if (word.length >= 3) { // רק מילים של 3 אותיות או יותר
					for (const location of locations) {
						if (location.name && location.name.toLowerCase().startsWith(word)) {
							// וודא שזה השם היחיד שמתחיל כך
							const matches = locations.filter(loc => 
								loc.name && loc.name.toLowerCase().startsWith(word)
							);
							if (matches.length === 1) {
								return location;
							}
						}
					}
				}
			}
			
			// שלב 4: זיהוי לפי רחוב בלבד (לשמות ידועים)
			for (const word of words) {
				if (word.length >= 4) {
					for (const location of locations) {
						if (location.name) {
							const locationStreet = location.name.toLowerCase().split(' ')[0];
							if (locationStreet === word) {
								return location;
							}
						}
					}
				}
			}
			
			return null;
		}


		// פונקציה משופרת לחילוץ זמנים - תחליף את extractDuration הקיימת
		function extractTimeFromText(text) {
			if (!text) return 0;
			
			const textLower = text.toLowerCase().trim();
			
			// דפוס 1: מספר + "שעות"
			let match = textLower.match(/(\d+(?:\.\d+)?)\s*שעות/);
			if (match) {
				return Math.round(parseFloat(match[1]) * 60);
			}
			
			// דפוס 2: "שעתיים" עם וריאציות
			if (textLower.includes('שעתיים')) {
				if (textLower.includes('וחצי')) return 150;
				if (textLower.includes('ורבע')) return 135;
				if (textLower.includes('ושלושת רבעי')) return 165;
				return 120;
			}
			
			// דפוס 3: "שעה" עם וריאציות
			if (textLower.includes('שעה') && !textLower.includes('שעות')) {
				if (textLower.includes('וחצי')) return 90;
				if (textLower.includes('ורבע')) return 75;
				if (textLower.includes('ושלושת רבעי')) return 105;
				return 60;
			}
			
			// דפוס 4: "חצי שעה", "רבע שעה"
			if (textLower.includes('חצי שעה')) return 30;
			if (textLower.includes('רבע שעה')) return 15;
			
			// דפוס 5: מספר עשרוני עם שעות (כמו "1.75 שעות")
			match = textLower.match(/(\d+\.\d+)\s*שעה/);
			if (match) {
				return Math.round(parseFloat(match[1]) * 60);
			}
			
			// דפוס 6: כמויות מילוליות
			if (textLower.includes('כשעתיים')) return 120;
			if (textLower.includes('כשעה')) return 60;
			if (textLower.includes('כמעט שעתיים')) return 115;
			if (textLower.includes('כמעט שעה')) return 55;
			
			// דפוס 7: דקות
			match = textLower.match(/(\d+)\s*דק/);
			if (match) {
				return parseInt(match[1]);
			}
			
			// דפוס 8: ביטויים מיוחדים
			if (textLower.includes('לפני רבע שעה')) return 15;
			if (textLower.includes('לפני חצי שעה')) return 30;
			if (textLower.includes('לפני כשעה')) return 60;
			
			// דפוס 9: מספרים עם נקודה (כמו "2.5" או "3.25")
			match = textLower.match(/(\d+)\.(\d+)/);
			if (match) {
				const hours = parseInt(match[1]);
				const fraction = parseInt(match[2]);
				if (fraction === 5) return hours * 60 + 30; // .5 = חצי שעה
				if (fraction === 25) return hours * 60 + 15; // .25 = רבע שעה
				if (fraction === 75) return hours * 60 + 45; // .75 = שלושת רבעי שעה
			}
			
			// דפוס 10: טווחי זמן (כמו "2-3 שעות")
			match = textLower.match(/(\d+)-(\d+)\s*שעות/);
			if (match) {
				const avg = (parseInt(match[1]) + parseInt(match[2])) / 2;
				return Math.round(avg * 60);
			}
			
			return 0;
		}


		// פונקציה משופרת לזיהוי סוגי עבודה - תחליף את getWorkType הקיימת
		function identifyWorkType(text) {
			if (!text) return 'כללי';
			
			const textLower = text.toLowerCase().trim();
			
			// סוגי עבודה ספציפיים
			if (textLower.includes('חרמש')) return 'חרמש';
			if (textLower.includes('גיזום')) return 'גיזום';
			if (textLower.includes('כיסוח') || textLower.includes('מכסחת')) return 'כיסוח';
			if (textLower.includes('מפוח')) return 'מפוח';
			if (textLower.includes('שתילה') || textLower.includes('שתלתי')) return 'שתילה';
			if (textLower.includes('ריסוס') || textLower.includes('ריססתי')) return 'ריסוס';
			
			// השקיה ותיקונים
			if (textLower.includes('השקיה') || textLower.includes('השקייה')) return 'השקיה';
			if (textLower.includes('תיקוני השקיה') || textLower.includes('בדיקת השקיה')) return 'השקיה';
			if (textLower.includes('החלפת סוללות') || textLower.includes('החלפת מחשב')) return 'השקיה';
			if (textLower.includes('מחשב השקיה') || textLower.includes('ברז חשמלי')) return 'השקיה';
			if (textLower.includes('צנרת') || textLower.includes('טפטוף')) return 'השקיה';
			if (textLower.includes('ממטירים') || textLower.includes('מתזים')) return 'השקיה';
			
			// עבודות פינוי וניקיון
			if (textLower.includes('הוצאת גזם') || textLower.includes('פינוי גזם')) return 'הוצאת גזם';
			if (textLower.includes('פינוי') && textLower.includes('גזם')) return 'הוצאת גזם';
			if (textLower.includes('איסוף') || textLower.includes('גירוף')) return 'ניקיון';
			if (textLower.includes('ניקיון') || textLower.includes('לנקות')) return 'ניקיון';
			
			// עבודות מסור
			if (textLower.includes('מסור') || textLower.includes('חיתוך')) return 'גיזום';
			if (textLower.includes('כריתת ענפים') || textLower.includes('הורדת ענפים')) return 'גיזום';
			
			// עבודות תחזוקה מיוחדות
			if (textLower.includes('תיקון') || textLower.includes('החלפה')) return 'תחזוקה';
			if (textLower.includes('התקנה') || textLower.includes('התקנת')) return 'תחזוקה';
			
			// זיהוי לפי כלים שמוזכרים
			if (textLower.includes('מגזמת')) return 'גיזום';
			if (textLower.includes('מרסס')) return 'ריסוס';
			
			// אם מוזכרים מספר סוגי עבודה - החזר את הראשי
			const workTypes = [];
			if (textLower.includes('חרמש')) workTypes.push('חרמש');
			if (textLower.includes('גיזום')) workTypes.push('גיזום');
			if (textLower.includes('מפוח')) workTypes.push('מפוח');
			if (textLower.includes('איסוף')) workTypes.push('ניקיון');
			
			if (workTypes.length > 0) {
				return workTypes[0]; // החזר את הראשון שנמצא
			}
			
			// בדיקות מיוחדות לפי הקשר
			if (textLower.includes('בדיקה') || textLower.includes('סיור')) return 'בדיקה';
			if (textLower.includes('טיפול ראשוני') || textLower.includes('הערכה')) return 'הערכה';
			
			return 'כללי';
		}
		
		
		// פונקציה לזיהוי האם שורה מציינת תחילת ביקור חדש
		function isNewVisitStart(text, locations) {
			if (!text) return false;
			
			const textLower = text.toLowerCase().trim();
			
			// זיהוי ישירות של לקוח
			if (findClientSmart(text, locations)) return true;
			
			// דפוסי כתובות ישראליות
			if (/[א-ת\s']+\s+\d+/.test(text)) return true;
			
			// מילות מפתח שמציינות התחלת עבודה
			const startKeywords = [
				'מתחיל', 'התחלתי', 'מתחילים',
				'יציאה', 'הגעתי', 'נוסע ל',
				'בדיקת השקיה', 'טיפול ראשוני',
				'החלפת', 'התקנת', 'תיקון'
			];
			
			for (const keyword of startKeywords) {
				if (textLower.includes(keyword)) return true;
			}
			
			// זיהוי לפי שמות גנים/אזורים מוכרים
			const gardenKeywords = [
				'מבצע נחשון', 'מבצע משה', 'המרגנית',
				'אזר', 'גן יבנה', 'שיינקין'
			];
			
			for (const keyword of gardenKeywords) {
				if (textLower.includes(keyword.toLowerCase())) return true;
			}
			
			return false;
		}

		// פונקציה לזיהוי האם שורה מציינת סיום ביקור
		function isVisitEnd(text) {
			if (!text) return false;
			
			const textLower = text.toLowerCase().trim();
			
			// מילות סיום מפורשות
			if (textLower.includes('סיום') || textLower.includes('סיימתי')) return true;
			
			// ביטויי זמן שמציינים סיום
			if (textLower.includes('שעות') || textLower.includes('שעה')) {
				// אם יש זמן + ביטוי סיכום
				if (textLower.includes('סהכ') || textLower.includes('עד כה') || 
					textLower.includes('כולל') || textLower.includes('לקח')) {
					return true;
				}
			}
			
			// ביטויי מעבר לביקור הבא
			if (textLower.includes('נוסע ל') || textLower.includes('עובר ל') ||
				textLower.includes('ממשיך ל') || textLower.includes('הביתה')) {
				return true;
			}
			
			// הפסקות שמסיימות ביקור
			if (textLower.includes('הפסקה בבית') || textLower.includes('בבית')) {
				return true;
			}
			
			return false;
		}

		// פונקציה לזיהוי הערות שכדאי לשמור
		function extractNotes(text) {
			if (!text) return '';
			
			const textLower = text.toLowerCase();
			let notes = [];
			
			// הערות על תשלום
			if (textLower.includes('קיבלתי') && /\d+/.test(text)) {
				notes.push(text);
			}
			
			// הערות על המשך עבודה
			if (textLower.includes('לחזור') || textLower.includes('להמשיך') ||
				textLower.includes('נשאר') || textLower.includes('צריך')) {
				notes.push(text);
			}
			
			// בעיות או תקלות
			if (textLower.includes('בעיה') || textLower.includes('תקלה') ||
				textLower.includes('לא עובד') || textLower.includes('נשבר')) {
				notes.push(text);
			}
			
			// הערות על מזג אוויר או תנאים
			if (textLower.includes('גשם') || textLower.includes('חום') ||
				textLower.includes('רטוב') || textLower.includes('יבש')) {
				notes.push(text);
			}
			
			return notes.join(' | ');
		}
		
	

		// אישור ייבוא הביקורים מטלגרם - גירסה מעודכנת
		async function confirmTelegramImport() {
			if (!window.pendingTelegramVisits || window.pendingTelegramVisits.length === 0) {
				showToast('אין ביקורים לייבוא', 'warning');
				return;
			}
			
			try {
				showLoading('מייבא ביקורים מטלגרם...');
				
				// שלב 1: שמור לטבלת TelegramVisits (זמני)
				const telegramVisitsWithIds = window.pendingTelegramVisits.map(visit => ({
					...visit,
					ID: generateID()
				}));
				
				await saveTelegramVisitsToCloud(telegramVisitsWithIds);
				
				// שלב 2: המר לביקורים רגילים במערכת
				let importedCount = 0;
				
				for (const telegramVisit of telegramVisitsWithIds) {
					// מצא או צור לקוח
					let locationId = null;
					const existingLocation = locations.find(loc => 
						loc.name.toLowerCase() === telegramVisit.client_name.toLowerCase()
					);
					
					if (existingLocation) {
						locationId = existingLocation.ID;
					} else {
						// צור לקוח חדש אם לא קיים
						locationId = generateID();
						const newLocation = {
							ID: locationId,
							name: telegramVisit.client_name,
							full_address: '',
							neighborhood: '',
							city: '',
							contact_person: '',
							phone: '',
							allowed_day: 'יום ראשון',
							interval_weeks: 4,
							temp_addition: false,
							base_amount: 0,
							active: true,
							notes: 'נוצר אוטומטית מייבוא טלגרם',
							last_visit: telegramVisit.date,
							next_visit: '',
							client_requests: ''
						};
						locations.push(newLocation);
					}
					
					// צור ביקור במערכת הראשית
					const visitData = {
						ID: generateID(),
						date: telegramVisit.date,
						location_id: telegramVisit.client_id,
						location_name: telegramVisit.client_name,
						visit_type: 'ביון', // ברירת מחדל
						work_done: telegramVisit.work_done,
						duration_minutes: telegramVisit.duration_minutes,
						num_workers: 1,
						start_time: telegramVisit.time || '',
						end_time: '',
						amount: 0, // יחושב לפי זמן ותעריף
						expense: 0,
						notes: `יובא מטלגרם: ${telegramVisit.raw_text}`
					};
					
					visits.push(visitData);
					importedCount++;
				}
				
				// שמור הכל
				saveToLocalStorage();
				
				// עדכן תצוגות
				loadLocationsTable();
				loadReceiptsTable();
				loadFilterOptions();
				
				// שמור לעלנן
				await saveAllToSheetsOptimized();
				
				hideLoading();
				closeModal();
				
				showToast(`🎉 ייבוא טלגרם הושלם!
		📱 ${importedCount} ביקורים יובאו
		💾 הכל נשמר לעלנן!`, 'success', 5000);
				
				// נקה את הנתונים הזמניים
				window.pendingTelegramVisits = null;
				
			} catch (error) {
				console.error('שגיאה בייבוא מטלגרם:', error);
				hideLoading();
				showToast('שגיאה בייבוא מטלגרם', 'error');
			}
		}

		


		function showModal(content) {
			// הסר מודל קיים אם יש
			const existingModal = document.getElementById('telegramModal');
			if (existingModal) {
				existingModal.remove();
			}
			
			// צור מודל
			const modal = document.createElement('div');
			modal.id = 'telegramModal';
			modal.style.cssText = `
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.5);
				display: flex;
				justify-content: center;
				align-items: center;
				z-index: 1000;
			`;
			
			modal.innerHTML = content;
			document.body.appendChild(modal);
			
			// סגירה בלחיצה על הרקע
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					closeModal();
				}
			});
		}

		function closeModal() {
			const modal = document.getElementById('telegramModal');
			if (modal) {
				modal.remove();
			}
		}
	   
	    function generateID() {
			return Date.now() + Math.random().toString(36).substr(2, 9);
		}
	   
	   
	   async function saveAllToSheetsOptimized() {
			if (!await validateToken()) {
				showToast('חיבור לגוגל פג - שמירה מקומית בלבד', 'warning');
				return;
			}
			
			try {
				showLoading('שומר נתונים לענן (מצב מהיר)...');
				
				// שמירה אצווית - כל המיקומים בבת אחת
				if (locations.length > 0) {
					showToast(`שומר ${locations.length} מיקומים בבת אחת...`, 'info', 2000);
					
					const locationValues = locations.map(loc => [
						loc.ID, loc.name, loc.full_address, loc.neighborhood, loc.city,
						loc.contact_person, loc.phone, loc.allowed_day, loc.interval_weeks,
						loc.temporary_addition, loc.base_amount, loc.active, loc.notes,
						loc.last_visit, loc.next_visit
					]);
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Locations!A2:O${locationValues.length + 1}`,
						valueInputOption: 'USER_ENTERED',
						resource: { values: locationValues }
					});
				}
				
				// שמירה אצווית - כל הביקורים בבת אחת
				if (visits.length > 0) {
					showToast(`שומר ${visits.length} ביקורים בבת אחת...`, 'info', 2000);
					
					const visitValues = visits.map(visit => [
						visit.ID, visit.date, visit.location_id, visit.location_name, visit.visit_type,
						visit.work_done, visit.duration_minutes, visit.num_workers || 1,
						visit.start_time, visit.end_time, visit.amount, visit.expense || 0,
						visit.notes
					]);

					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Visits!A2:M${visitValues.length + 1}`, // חזרנו ל-M כי הסרנו עמודה
						valueInputOption: 'USER_ENTERED',
						resource: { values: visitValues }
					});
				}
				
				// שמירה אצווית - כל הקבלות בבת אחת
				if (receipts.length > 0) {
					showToast(`שומר ${receipts.length} קבלות בבת אחת...`, 'info', 2000);
					
					const receiptValues = receipts.map(receipt => [
						receipt.ID, receipt.book_number, receipt.receipt_number, receipt.date,
						receipt.location_id, receipt.location_name, receipt.amount,
						receipt.payment_type, receipt.notes
					]);
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Receipts!A2:I${receiptValues.length + 1}`,
						valueInputOption: 'USER_ENTERED',
						resource: { values: receiptValues }
					});
				}
				
				showToast(`🚀 שמירה מהירה הושלמה!
		✅ ${locations.length + visits.length + receipts.length} רשומות נשמרו
		⚡ זמן חיסכון: ~90%`, 'success', 5000);
				
			} catch (error) {
				console.error('Error in optimized save:', error);
				showToast('שגיאה בשמירה מהירה - חוזר לשיטה רגילה', 'warning');
				
				// אם נכשל, חזור לשיטה הרגילה
				await saveAllToSheets();
			} finally {
				hideLoading();
			}
		}
	   
	   // פונקציה להצגת חובות
		function displayDebts() {
			//// console.log('דוגמאות ערכי paid:', visits.slice(0, 5).map(v => v.paid));
			const sortBy = document.getElementById('debtSortBy').value;
			const minAmount = parseFloat(document.getElementById('minDebtAmount').value) || 0;
			
			// חישוב חובות לכל לקוח
			const debtsByLocation = {};
			
			visits.forEach(visit => {
				if (visit.amount > 0) {
					const visitAmount = parseFloat(visit.amount);
					const paidAmount = getVisitPaidAmount(visit.ID);
					const debt = visitAmount - paidAmount;
					
					if (debt > 0) { // יש חוב
						if (!debtsByLocation[visit.location_id]) {
							const location = locations.find(loc => loc.ID == visit.location_id);
							debtsByLocation[visit.location_id] = {
								location: location,
								visits: [],
								totalDebt: 0
							};
						}
						debtsByLocation[visit.location_id].visits.push({
							...visit,
							debt: debt,
							paidAmount: paidAmount
						});
						debtsByLocation[visit.location_id].totalDebt += debt;
					}
				}
			});
			
			// המרה למערך וסינון
			let debtsArray = Object.values(debtsByLocation)
				.filter(debt => debt.totalDebt >= minAmount);
			
			// מיון
			debtsArray.sort((a, b) => {
				switch(sortBy) {
					case 'amount_desc':
						return b.totalDebt - a.totalDebt;
					case 'amount_asc':
						return a.totalDebt - b.totalDebt;
					case 'date_old':
						return new Date(a.visits[0].date) - new Date(b.visits[0].date);
					case 'date_new':
						return new Date(b.visits[0].date) - new Date(a.visits[0].date);
					case 'location':
						return a.location?.name.localeCompare(b.location?.name);
					default:
						return b.totalDebt - a.totalDebt;
				}
			});
			
			// הצגה בטבלה
			const tbody = document.getElementById('debtsTableBody');
			tbody.innerHTML = '';
			
			debtsArray.forEach(debt => {
				const location = debt.location || { name: 'לא נמצא', full_address: '', phone: '' };
				const lastVisit = debt.visits[debt.visits.length - 1];
				const daysSinceLastVisit = Math.floor((new Date() - new Date(lastVisit.date)) / (1000 * 60 * 60 * 24));
				
				const row = document.createElement('tr');
				
				// הדגשת חובות ישנים
				if (daysSinceLastVisit > 60) {
					row.style.backgroundColor = '#ffebee'; // אדום עדין
				} else if (daysSinceLastVisit > 30) {
					row.style.backgroundColor = '#fff3e0'; // כתום עדין  
				}
				
				row.innerHTML = `
					<td>
						<strong>${location.name}</strong>
						<br><small style="color: #666;">${location.contact_person || ''}</small>
					</td>
					<td><small>${location.full_address || ''}</small></td>
					<td>
						${location.phone ? 
							`<a href="tel:${location.phone}" style="color: #007bff; text-decoration: none;">
								📞 ${location.phone}
							</a>` : 
							'<span style="color: #999;">-</span>'
						}
					</td>
					<td style="text-align: center;">
						<span style="background: #e3f2fd; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
							${debt.visits.length}
						</span>
					</td>
					<td style="text-align: center;">
						<strong style="color: #e74c3c; font-size: 16px;">₪${debt.totalDebt.toLocaleString()}</strong>
					</td>
					<td style="text-align: center;">${formatDate(lastVisit.date)}</td>
					<td style="text-align: center;">
						<span style="color: ${daysSinceLastVisit > 60 ? '#e74c3c' : daysSinceLastVisit > 30 ? '#f39c12' : '#666'}; font-weight: bold;">
							${daysSinceLastVisit}
						</span>
					</td>
					<td style="text-align: center;">
						<button class="action-btn" onclick="showDebtDetails('${location.ID}')" style="background: #007bff; margin: 2px;">
							🔍 פירוט
						</button>
						<button class="action-btn" onclick="markDebtAsPaid('${location.ID}')" style="background: #28a745; margin: 2px;">
							✅ סולק
						</button>
					</td>
				`;
				
				tbody.appendChild(row);
			});
			
			// עדכון סיכום
			updateDebtsSummary(debtsArray);
		}

		// עדכון כרטיסי סיכום
		function updateDebtsSummary(debtsArray) {
			const totalDebt = debtsArray.reduce((sum, debt) => sum + debt.totalDebt, 0);
			const debtorsCount = debtsArray.length;
			const averageDebt = debtorsCount > 0 ? totalDebt / debtorsCount : 0;
			
			// מציאת החוב הכי ישן
			let oldestDebtDays = 0;
			if (debtsArray.length > 0) {
				const oldestVisit = debtsArray
					.flatMap(debt => debt.visits)
					.reduce((oldest, visit) => 
						new Date(visit.date) < new Date(oldest.date) ? visit : oldest
					);
				oldestDebtDays = Math.floor((new Date() - new Date(oldestVisit.date)) / (1000 * 60 * 60 * 24));
			}
			
			document.getElementById('totalDebt').textContent = `₪${totalDebt.toLocaleString()}`;
			document.getElementById('totalDebt').style.color = totalDebt > 0 ? '#e74c3c' : '#27ae60';
			
			document.getElementById('debtorsCount').textContent = debtorsCount;
			document.getElementById('averageDebt').textContent = `₪${Math.round(averageDebt).toLocaleString()}`;
			document.getElementById('oldestDebt').textContent = oldestDebtDays > 0 ? `${oldestDebtDays} ימים` : '-';
			
			if (oldestDebtDays > 90) {
				document.getElementById('oldestDebt').style.color = '#e74c3c';
			} else if (oldestDebtDays > 30) {
				document.getElementById('oldestDebt').style.color = '#f39c12';
			}
		}

		// הצגת פירוט חוב ללקוח במודל נוח
		function showDebtDetails(locationId) {
			const location = locations.find(loc => loc.ID == locationId);
			const locationVisits = visits.filter(v => v.location_id == locationId && v.paid === '0');
			
			if (!location || locationVisits.length === 0) {
				showToast('לא נמצאו חובות ללקוח זה', 'info');
				return;
			}
			
			// מיון ביקורים לפי תאריך
			locationVisits.sort((a, b) => new Date(a.date) - new Date(b.date));
			
			const totalDebt = locationVisits.reduce((sum, v) => sum + parseFloat(v.amount), 0);
			
			// יצירת רשימת הביקורים
			let visitsHTML = '';
			locationVisits.forEach(visit => {
				const workDone = visit.work_done || 'לא צוין';
				const notes = visit.notes ? `<div style="color: #888; font-size: 12px; margin-top: 5px;">💭 ${visit.notes}</div>` : '';
				
				visitsHTML += `
					<div style="border: 1px solid #e9ecef; border-radius: 6px; padding: 12px; margin-bottom: 10px;">
						<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
							<strong>📅 ${formatDate(visit.date)}</strong>
							<strong style="color: #e74c3c;">₪${parseFloat(visit.amount).toLocaleString()}</strong>
						</div>
						<div style="color: #666; font-size: 14px;">
							🔧 ${workDone}
						</div>
						${notes}
					</div>
				`;
			});
			
			// תוכן המודל
			const modalContent = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 90vw; max-height: 70vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">💰 פירוט חובות - ${location.name}</h3>
					
					<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
						<strong>סה"כ חוב: ₪${totalDebt.toLocaleString()}</strong><br>
						<span style="color: #666;">מספר טיפולים: ${locationVisits.length}</span>
					</div>
					
					<div style="max-height: 300px; overflow-y: auto;">
						${visitsHTML}
					</div>
					
					<div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
						<button type="button" onclick="markDebtAsPaid(${locationId}); closeEditModal();" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
							✅ סמן כמסולק
						</button>
						<button type="button" onclick="closeEditModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
							❌ סגור
						</button>
					</div>
				</div>
			`;
			
			showEditModal(modalContent);
		}  

		// סימון חוב כמסולק
		function markDebtAsPaid(locationId) {
			const location = locations.find(loc => loc.ID == locationId);
			if (!location) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			const unpaidVisits = visits.filter(v => v.location_id == locationId && v.paid === '0');
			
			if (unpaidVisits.length === 0) {
				showToast('אין חובות פתוחים ללקוח זה', 'info');
				return;
			}
			
			const totalDebt = unpaidVisits.reduce((sum, v) => sum + parseFloat(v.amount), 0);
			
			if (confirm(`לסמן את כל החובות של ${location.name} כמסולקים?\n\nסה"כ: ₪${totalDebt.toLocaleString()}\nמספר טיפולים: ${unpaidVisits.length}`)) {
				// עדכון כל הביקורים החייבים
				unpaidVisits.forEach(visit => {
					visit.paid = '1';
				});
				
				// שמירה מקומית
				saveToLocalStorage();
				
				// שמירה בענן אם מחובר
				if (access_token && SPREADSHEET_ID) {
					saveAllToSheets().then(() => {
						console.log('✅ חובות עודכנו בענן');
					}).catch(error => {
						console.error('❌ שגיאה בעדכון ענן:', error);
						showToast('החובות עודכנו מקומית, אך לא בענן', 'warning');
					});
				}
				
				// רענון התצוגה
				displayDebts();
				
				showToast(`החובות של ${location.name} סומנו כמסולקים! (₪${totalDebt.toLocaleString()})`, 'success');
			}
		}

	   
	    // התראה על חובות חמורים
		function checkCriticalDebts() {
			const criticalDebts = visits.filter(visit => {
				if (visit.paid !== '0') return false;
				
				const daysSince = Math.floor((new Date() - new Date(visit.date)) / (1000 * 60 * 60 * 24));
				return daysSince > 90 || parseFloat(visit.amount) > 1000;
			});
			
			if (criticalDebts.length > 0) {
				const totalCritical = criticalDebts.reduce((sum, visit) => sum + parseFloat(visit.amount), 0);
				
				showToast(
					`⚠️ יש ${criticalDebts.length} חובות דחופים (₪${totalCritical.toLocaleString()})`, 
					'warning', 
					8000
				);
			}
		}
	   
	   
	    // דוח הכנסות לחודש נוכחי
		function generateMonthlyReport() {
			const currentMonth = new Date().getMonth();
			const currentYear = new Date().getFullYear();
			
			const monthlyVisits = visits.filter(visit => {
				const visitDate = new Date(visit.date);
				return visitDate.getMonth() === currentMonth && 
					   visitDate.getFullYear() === currentYear;
			});
			
			const totalRevenue = monthlyVisits.reduce((sum, visit) => 
				sum + parseFloat(visit.amount || 0), 0);
			
			const paidRevenue = monthlyVisits
				.filter(visit => visit.paid === '1')
				.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			const totalHours = monthlyVisits.reduce((sum, visit) => 
				sum + (visit.duration_minutes || 0) / 60, 0);
			
			const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני',
				'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
			
			const report = {
				month: monthNames[currentMonth],
				year: currentYear,
				totalVisits: monthlyVisits.length,
				totalRevenue: totalRevenue,
				paidRevenue: paidRevenue,
				pendingRevenue: totalRevenue - paidRevenue,
				totalHours: totalHours.toFixed(1),
				avgPerVisit: monthlyVisits.length > 0 ? Math.round(totalRevenue / monthlyVisits.length) : 0
			};
			
			return report;
		}

		// הצגת דוח במודל
		function showMonthlyReport() {
			const report = generateMonthlyReport();
			
			const reportHTML = `
				<div style="background: white; padding: 20px; border-radius: 10px; max-width: 500px;">
					<h3>📊 דוח ${report.month} ${report.year}</h3>
					
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
						<div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #1976d2;">${report.totalVisits}</div>
							<div style="color: #666;">ביקורים</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #2e7d32;">₪${report.totalRevenue.toLocaleString()}</div>
							<div style="color: #666;">סה"כ הכנסות</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #f3e5f5; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #7b1fa2;">₪${report.paidRevenue.toLocaleString()}</div>
							<div style="color: #666;">נגבה</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #fff3e0; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #f57c00;">₪${report.pendingRevenue.toLocaleString()}</div>
							<div style="color: #666;">בהמתנה</div>
						</div>
					</div>
					
					<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
						<div><strong>שעות עבודה:</strong> ${report.totalHours} שעות</div>
						<div><strong>ממוצע לביקור:</strong> ₪${report.avgPerVisit}</div>
						<div><strong>ממוצע לשעה:</strong> ₪${Math.round(report.paidRevenue / parseFloat(report.totalHours) || 0)}</div>
					</div>
					
					<button onclick="closeModal()" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; width: 100%;">
						סגור
					</button>
				</div>
			`;
			
			showModal(reportHTML);
		}
	   
	    function isDuplicateVisit(newVisit) {
			return visits.some(existing => 
				existing.location_id === newVisit.location_id &&
				existing.date === newVisit.date &&
				existing.work_done === newVisit.work_done &&
				existing.amount === newVisit.amount
			);
		}
	   
	    function isDuplicateReceipt(newReceipt) {
			return receipts.some(existing => 
				existing.receipt_number === newReceipt.receipt_number &&
				existing.booklet_number === newReceipt.booklet_number &&
				existing.date === newReceipt.date
			);
		}
		
		
		function removeDuplicates() {
			const uniqueVisits = [];
			const seen = new Set();
			
			visits.forEach(visit => {
				const key = `${visit.location_id}-${visit.date}-${visit.work_done}-${visit.amount}`;
				if (!seen.has(key)) {
					seen.add(key);
					uniqueVisits.push(visit);
				}
			});
			
			const removedCount = visits.length - uniqueVisits.length;
			visits = uniqueVisits;
			
			console.log(`Removed ${removedCount} duplicate visits`);
			return removedCount;
		}
	   
	   function validateVisitData(visitData) {
			const errors = [];
			
			if (!visitData.location_id) {
				errors.push('חסר מזהה לקוח');
			}
			
			if (!visitData.date) {
				errors.push('חסר תאריך');
			}
			
			if (!visitData.work_done || visitData.work_done.trim() === '') {
				errors.push('חסר תיאור עבודה');
			}
			
			return errors;
		}

		function showValidationErrors(errors) {
			if (errors.length > 0) {
				alert('בעיות בטופס:\n' + errors.join('\n'));
				return true; // יש שגיאות
			}
			return false; // אין שגיאות
		}
	   
	   // שמירה מקבצית של לקוחות
		async function saveLocationsBatch(locationsArray) {
			if (!await validateToken() || locationsArray.length === 0) return false;
			
			try {
			
			    // קרא את הנתונים הקיימים קודם
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:A'
				});
				
				const existingIDs = new Set(response.result.values?.slice(1).map(row => row[0]) || []);
				
				// סנן רק רשומות חדשות
				const newLocations = locationsArray.filter(location => !existingIDs.has(location.ID));
				
				if (newLocations.length === 0) {
					console.log('אין לקוחות חדשים לשמירה');
					return true;
				}
			
				const values = newLocations.map(location => [
					location.ID,
					location.name,
					location.full_address,
					location.neighborhood,
					location.city,
					location.contact_person,
					location.phone,
					location.allowed_day,
					location.interval_weeks,
					location.temp_addition,
					location.base_amount,
					location.active,
					location.notes,
					formatDateForSheets(location.last_visit),
					formatDateForSheets(location.next_visit),
					location.client_requests || ''
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:P`, 
					valueInputOption: 'USER_ENTERED',
					resource: { 
						values: values,
						majorDimension: 'ROWS'
					}
				});
				
				console.log(`✅ Saved ${newLocations.length} locations in batch - from ${locationsArray.length}`);
				return true;
			} catch (error) {
				console.error('Error in batch save locations:', error);
				return false;
			}
		}

		// שמירה מקבצית של ביקורים
		async function saveVisitsBatch(visitsArray) {
			if (!await validateToken() || visitsArray.length === 0) return false;
			
			try {
				// קרא את הנתונים הקיימים קודם
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Visits!A:A'
				});
				
				const existingIDs = new Set(response.result.values?.slice(1).map(row => row[0]) || []);
				
				// סנן רק רשומות חדשות
				const newVisits = visitsArray.filter(visit => !existingIDs.has(visit.ID));
				
				if (newVisits.length === 0) {
					console.log('✅ No new visits to save');
					return true;
				}
				
				const values = newVisits.map(visit => [
					visit.ID,
					formatDateForSheets(visit.date),
					visit.location_id,
					visit.location_name,
					visit.visit_type,
					visit.work_done,
					visit.duration_minutes,
					visit.start_time,
					visit.end_time,
					visit.amount,
					visit.expense,
					visit.paid,
					visit.notes
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:M`,
					valueInputOption: 'USER_ENTERED',
					resource: { 
						values: values,
						majorDimension: 'ROWS'
					}
				});
				
				console.log(`✅ Saved ${newVisits.length} visits in batch - from ${visitsArray.length}`);
				return true;
			} catch (error) {
				console.error('Error in batch save visits:', error);
				return false;
			}
		}

		// שמירה מקבצית של קבלות
		async function saveReceiptsBatch(receiptsArray) {
			if (!await validateToken() || receiptsArray.length === 0) return false;
			
			try {
				// קרא את הנתונים הקיימים קודם
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Receipts!A:A'
				});
				
				const existingIDs = new Set(response.result.values?.slice(1).map(row => row[0]) || []);
				
				// סנן רק רשומות חדשות
				const newReceipts = receiptsArray.filter(receipt => !existingIDs.has(receipt.ID));
				
				if (newReceipts.length === 0) {
					console.log('✅ No new receipts to save');
					return true;
				}
				
				const values = newReceipts.map(receipt => [
					receipt.ID,
					receipt.book_number,
					receipt.receipt_number,
					formatDateForSheets(receipt.date),
					receipt.location_id,
					receipt.location_name,
					receipt.amount,
					receipt.payment_type,
					receipt.notes
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:I`,
					valueInputOption: 'USER_ENTERED',
					resource: { 
						values: values,
						majorDimension: 'ROWS'
					}
				});
				
				console.log(`✅ Saved ${newReceipts.length} receipts in batch - from ${receiptsArray.length}`);
				return true;
			} catch (error) {
				console.error('Error in batch save receipts:', error);
				return false;
			}
		}
	   
	   // פונקציה לחישוב ועדכון תאריכי טיפול אחרון וטיפול הבא
		// פונקציה לחישוב ועדכון תאריכי טיפול אחרון וטיפול הבא - גרסה מתקנת
		async function calculateTreatmentDates() {
			console.log('🔄 מחשב תאריכי טיפול אחרון וטיפול הבא...');
			
			let updatedLocations = [];
			
			for (const location of locations) {
				// מצא את כל הטיפולים של הלקוח הזה
				const locationVisits = visits.filter(visit => visit.location_id === location.ID);
				
				if (locationVisits.length > 0) {
					// מיין לפי תאריך (החדש ביותר ראשון)
					locationVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
					
					// הטיפול האחרון
					const lastVisit = locationVisits[0];
					const lastVisitDate = lastVisit.date;
					
					// חישוב יום מועדף לפי הביקור האחרון
					if (!location.allowed_day || location.allowed_day === '') {
						const lastDate = new Date(lastVisitDate);
						const dayNames = ['יום ראשון', 'יום שני', 'יום שלישי', 'יום רביעי', 'יום חמישי', 'יום שישי', 'יום שבת'];
						location.allowed_day = dayNames[lastDate.getDay()];
						console.log(`📅 ${location.name}: יום מועדף חושב כ-${location.allowed_day} (לפי ביקור מ-${lastVisitDate})`);
					}
					
					// חישוב תאריך הטיפול הבא
					const lastDate = new Date(lastVisitDate);
					const intervalDays = (location.interval_weeks || 4) * 7; // ברירת מחדל 4 שבועות
					const nextDate = new Date(lastDate);
					nextDate.setDate(lastDate.getDate() + intervalDays);
					
					// פורמט התאריך ל-YYYY-MM-DD
					const nextVisitDate = nextDate.toISOString().split('T')[0];
					
					// עדכון האובייקט המקומי
					location.last_visit = lastVisitDate;
					location.next_visit = nextVisitDate;
					
					updatedLocations.push(location);
					
					console.log(`📅 ${location.name}: טיפול אחרון ${lastVisitDate} → טיפול הבא ${nextVisitDate}`);
				}
			}
			
			// עדכון בגוגל שיטס במקביל - קריאה אחת בלבד עבור כל הלקוחות
			if (updatedLocations.length > 0) {
				console.log(`🔄 מעדכן ${updatedLocations.length} לקוחות בגוגל שיטס...`);
				await updateTreatmentDatesInSheets(updatedLocations);
				showToast(`📅 תאריכי טיפול עודכנו עבור ${updatedLocations.length} לקוחות`, 'success', 2000);
			}
			
			// רענן נתוני תכנון
			refreshPlanningAfterTreatmentUpdate();
			
			return updatedLocations.length;
		}
	   
	   
	    // פונקציה לעדכון תאריכי הטיפול בגוגל שיטס
		async function updateTreatmentDatesInSheets(locationsToUpdate) {
			if (!await validateToken() || locationsToUpdate.length === 0) return false;
			
			console.log(`🔄 מעדכן תאריכי טיפול עבור ${locationsToUpdate.length} לקוחות בגוגל שיטס...`);
			
			try {
				// קרא את כל הנתונים הנוכחיים מהטבלה
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:P'
				});
				
				const allRows = response.result.values || [];
				const updatedRows = [...allRows];
				let updatedCount = 0;
				
				// עבור כל לקוח שצריך עדכון
				for (const location of locationsToUpdate) {
					// מצא את השורה המתאימה בטבלה
					for (let i = 1; i < allRows.length; i++) { // מתחיל מ-1 כדי לדלג על הכותרות
						if (allRows[i][0] === location.ID) {
							// עדכן את עמודות התאריכים והיום המועדף
							updatedRows[i][7] = location.allowed_day;   // allowed_day (עמודה 7)
							updatedRows[i][13] = location.last_visit;   // last_visit
							updatedRows[i][14] = location.next_visit;   // next_visit
							updatedCount++;
							break;
						}
					}
				}
				
				// שמור את כל הטבלה המעודכנת בקריאה אחת בלבד
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:P',
					valueInputOption: 'USER_ENTERED',
					resource: {
						values: updatedRows
					}
				});
				
				console.log(`✅ עודכנו ${updatedCount} תאריכי טיפול בגוגל שיטס`);
				return true;
			} catch (error) {
				console.error('Error updating treatment dates in sheets:', error);
				return false;
			}
		}
		
		// פונקציה לעדכון תאריכי טיפול עבור לקוח אחד לאחר הוספת ביקור
		async function updateSingleLocationTreatmentDates(locationId) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) return;
			
			// מצא את כל הביקורים של הלקוח הזה
			const locationVisits = visits.filter(visit => visit.location_id === locationId);
			
			if (locationVisits.length > 0) {
				// מיין לפי תאריך (החדש ביותר ראשון)
				locationVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
				
				// הטיפול האחרון
				const lastVisit = locationVisits[0];
				const lastVisitDate = lastVisit.date;
				
				// חישוב תאריך הטיפול הבא
				const lastDate = new Date(lastVisitDate);
				const intervalDays = (location.interval_weeks || 4) * 7; // ברירת מחדל 4 שבועות
				const nextDate = new Date(lastDate);
				nextDate.setDate(lastDate.getDate() + intervalDays);
				
				// פורמט התאריך ל-YYYY-MM-DD
				const nextVisitDate = nextDate.toISOString().split('T')[0];
				
				// עדכון האובייקט המקומי
				location.last_visit = lastVisitDate;
				location.next_visit = nextVisitDate;
				
				// עדכון בגוגל שיטס
				await updateTreatmentDatesInSheets([location]);
				
				console.log(`📅 עודכן לקוח ${location.name}: טיפול אחרון ${lastVisitDate} → טיפול הבא ${nextVisitDate}`);
				// רענן נתוני תכנון
				refreshPlanningAfterTreatmentUpdate();
			}
		}
	   
	   // פונקציה לחידוש נתוני התכנון לאחר עדכון תאריכים
		function refreshPlanningAfterTreatmentUpdate() {
			// רענן את נתוני התכנון אם הטאב פתוח
			const currentSection = document.querySelector('.section.active');
			if (currentSection && currentSection.id === 'planning') {
				loadPlanningData();
			}
			
			// רענן גם את רשימת הלקוחות בטופס הביקור
			loadLocationsForSelect();
		}
	   
	   // פונקציה לבדיקת מצב נתוני התכנון - לדיבוג
		function debugPlanningData() {
			console.log('=== Debug Planning Data ===');
			console.log(`סה"כ לקוחות: ${locations.length}`);
			
			// בדוק מה יש בשדה active
			console.log('דוגמאות של שדה active:', locations.slice(0, 5).map(loc => ({ name: loc.name, active: loc.active, type: typeof loc.active })));

			const activeLocations = locations.filter(loc => loc.active === "כן" || loc.active === true || loc.active === "1");
			console.log(`לקוחות פעילים: ${activeLocations.length}`);
			
			const locationsWithDates = activeLocations.filter(loc => loc.next_visit && loc.next_visit.trim() !== '');
			console.log(`לקוחות עם תאריכי טיפול: ${locationsWithDates.length}`);
			
			// הצג 5 לקוחות ראשונים
			locationsWithDates.slice(0, 5).forEach(loc => {
				console.log(`👤 ${loc.name}: אחרון=${loc.last_visit}, הבא=${loc.next_visit}`);
			});
			
			const today = new Date();
			const todayStr = today.toISOString().split('T')[0];
			console.log(`תאריך היום: ${todayStr}`);
			
			const dueToday = locationsWithDates.filter(loc => {
				return new Date(loc.next_visit) <= today;
			});
			console.log(`צריכים טיפול היום: ${dueToday.length}`);
			
			console.log('=== סיום Debug ===');
		}
	   
	   
		// פונקציה חדשה לייבוא מהיר וכולל של כל הנתונים
		async function importFromHelperTableFast() {
			if (!await validateToken()) {
				showToast('התחבר לגוגל קודם', 'warning');
				return;
			}
			
			const importTableId = localStorage.getItem('importTableId');
			if (!importTableId) {
				showToast('לא נמצא ID של טבלת העזר', 'warning');
				return;
			}
			
			console.log('🚀 Starting FAST complete import from helper table...');
			
			try {
				showLoading('מייבא נתונים מהר מטבלת העזר...');
				
				// מעקב סטטיסטיקות
				const stats = {
					locations: { imported: 0, skipped: 0 },
					visits: { imported: 0, skipped: 0 },
					receipts: { imported: 0, skipped: 0 }
				};
				
				// מערכים לנתונים חדשים בלבד
				const newLocations = [];
				const newVisits = [];
				const newReceipts = [];
				
				// ======== שלב 1: קריאת נתונים ברצף (כמו בפונקציות שעובדות) ========
				let locationsResponse, visitsResponse, receiptsResponse;
				
				try {
					console.log('📊 Loading locations data...');
					locationsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Locations!A2:G1000'
					});
				} catch (error) {
					console.log('📊 Locations sheet not found or empty');
					locationsResponse = { result: { values: [] } };
				}
				
				try {
					console.log('🔧 Loading visits data...');
					visitsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Visits!A2:M1000'
					});
				} catch (error) {
					console.log('🔧 Visits sheet not found or empty');
					visitsResponse = { result: { values: [] } };
				}
				
				try {
					console.log('🧾 Loading receipts data...');
					receiptsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Receipts!A2:K1000'
					});
				} catch (error) {
					console.log('🧾 Receipts sheet not found or empty');
					receiptsResponse = { result: { values: [] } };
				}
				
				console.log('📊 Raw data loaded:', {
					locations: locationsResponse.result.values?.length || 0,
					visits: visitsResponse.result.values?.length || 0,
					receipts: receiptsResponse.result.values?.length || 0
				});
				
				// ======== שלב 2: עיבוד לקוחות ========
				if (locationsResponse.result.values?.length > 0) {
					showToast('מעבד לקוחות...', 'info', 1500);
					
					for (const row of locationsResponse.result.values) {
						if (row.length > 0 && row[0]) { // יש שם לקוח
							const customerName = row[0].trim();
							const street = row[1] || '';
							const houseNumber = row[2] || '';
							const city = row[3] || '';
							const fullAddress = `${street} ${houseNumber} ${city}`.trim();
							
							// בדיקת כפילות לפי שם ו/או כתובת
							const isDuplicate = locations.some(existing =>
								existing.name.toLowerCase() === customerName.toLowerCase() ||
								(fullAddress && existing.full_address && 
								 existing.full_address.toLowerCase() === fullAddress.toLowerCase())
							);
							
							if (isDuplicate) {
								stats.locations.skipped++;
								console.log(`⚠️ Duplicate customer skipped: ${customerName}`);
								continue;
							}
							
							const locationData = {
								ID: generateID(),
								name: customerName,
								full_address: fullAddress || customerName, // ← תיקון: גם שם הלקוח אם אין כתובת נפרדת
								neighborhood: '',
								city: city,
								contact_person: row[5] || '',
								phone: '',
								allowed_day: '',
								interval_weeks: parseInt(row[4]) || 4,
								temp_addition: 0,
								base_amount: parseFloat(row[6]) || 0,
								active: "1",
								notes: '',
								last_visit: '',
								next_visit: ''
							};
							
							locations.push(locationData);
							newLocations.push(locationData);
							stats.locations.imported++;
						}
					}
				}
				
				// ======== שלב 3: עיבוד ביקורים ========
				if (visitsResponse.result.values?.length > 0) {
					showToast('מעבד ביקורים...', 'info', 1500);
					
					let notFoundCustomers = [];
					
					for (const row of visitsResponse.result.values) {
						if (row.length > 3 && row[3]) { // יש לקוח בעמודה 3
							const customerName = row[3].trim();
							
							// מצא לקוח קיים
							const existingCustomer = locations.find(loc =>
								loc.name && loc.name.toLowerCase() === customerName.toLowerCase()
							);
							
							if (!existingCustomer) {
								if (!notFoundCustomers.includes(customerName)) {
									notFoundCustomers.push(customerName);
								}
								stats.visits.skipped++;
								continue;
							}
							
							// בניית תאריך מ-3 עמודות: year, month, day
							const year = row[0];
							const month = String(row[1]).padStart(2, '0');
							const day = String(row[2]).padStart(2, '0');
							const visitDate = `${year}-${month}-${day}`;
							
							const workDone = row[7] || '';
							const amount = parseFloat(row[9]) || 0;
							
							// בדיקת כפילות ביקור
							const isDuplicateVisit = visits.some(existing =>
								existing.location_id === existingCustomer.ID &&
								existing.date === visitDate &&
								existing.work_done === workDone &&
								Math.abs(existing.amount - amount) < 0.01
							);
							
							if (isDuplicateVisit) {
								stats.visits.skipped++;
								console.log(`⚠️ Duplicate visit skipped: ${customerName} on ${visitDate}`);
								continue;
							}
							
							const visitData = {
								ID: generateID(),
								date: visitDate,
								location_id: existingCustomer.ID,
								location_name: customerName, // ← הוספנו את השם!
								visit_type: row[5] || 'regular',
								work_done: workDone,
								duration_minutes: (parseFloat(row[8]) || 0) * 60,
								num_workers: 1,
								start_time: '',
								end_time: '',
								amount: amount,
								expense: parseFloat(row[11]) || 0,
								paid: mapPaymentStatus(row[10]),
								notes: row[12] || ''
							};
							
							visits.push(visitData);
							newVisits.push(visitData);
							//** עדכון תאריכי טיפול לאחר הוספת ביקור חדש
							//** await updateSingleLocationTreatmentDates(visitData.location_id);
							stats.visits.imported++;
						}
					}
					
					if (notFoundCustomers.length > 0) {
						console.log(`⚠️ ${notFoundCustomers.length} customers not found for visits:`, notFoundCustomers.slice(0, 5));
					}
				}
				
				// ======== שלב 4: עיבוד קבלות ========
				if (receiptsResponse.result.values?.length > 0) {
					showToast('מעבד קבלות...', 'info', 1500);
					
					let notFoundAddresses = [];
					
					for (const row of receiptsResponse.result.values) {
						if (row.length > 6 && row[6]) { // יש כתובת בעמודה 6
							const customerAddress = row[6].trim();
							
							// מצא לקוח לפי כתובת - גם בשם וגם בכתובת מלאה
							const existingCustomer = locations.find(loc =>
								(loc.name && loc.name.toLowerCase().includes(customerAddress.toLowerCase())) ||
								(loc.full_address && loc.full_address.toLowerCase().includes(customerAddress.toLowerCase()))
							);
							
							if (!existingCustomer) {
								if (!notFoundAddresses.includes(customerAddress)) {
									notFoundAddresses.push(customerAddress);
								}
								stats.receipts.skipped++;
								continue;
							}
							
							// בניית תאריך
							const year = row[3];
							const month = String(row[4]).padStart(2, '0');
							const day = String(row[5]).padStart(2, '0');
							const receiptDate = `${year}-${month}-${day}`;
							
							const bookNumber = row[1] || '';
							const receiptNumber = row[2] || '';
							
							// בדיקת כפילות קבלה
							const isDuplicateReceipt = receipts.some(existing =>
								existing.book_number === bookNumber &&
								existing.receipt_number === receiptNumber &&
								existing.date === receiptDate
							);
							
							if (isDuplicateReceipt) {
								stats.receipts.skipped++;
								console.log(`⚠️ Duplicate receipt skipped: ${bookNumber}/${receiptNumber}`);
								continue;
							}
							
							const receiptData = {
								ID: generateID(),
								book_number: bookNumber,
								receipt_number: receiptNumber,
								date: receiptDate,
								location_id: existingCustomer.ID,
								location_name: customerAddress,
								amount: parseFloat(row[7]) || 0,
								payment_type: row[8] || '',
								notes: `${row[9] || ''} ${row[10] || ''}`.trim()
							};
							
							receipts.push(receiptData);
							newReceipts.push(receiptData);
							stats.receipts.imported++;
						}
					}
					
					if (notFoundAddresses.length > 0) {
						console.log(`⚠️ ${notFoundAddresses.length} addresses not found for receipts:`, notFoundAddresses.slice(0, 5));
					}
				}
				
				// ======== שלב 5: שמירה מקבצית לענן ========
				showToast('שומר נתונים חדשים לענן...', 'info');
				
				const savePromises = [];
				
				if (newLocations.length > 0) {
					savePromises.push(saveLocationsBatchNew(newLocations));
				}
				if (newVisits.length > 0) {
					savePromises.push(saveVisitsBatchNew(newVisits));
				}
				if (newReceipts.length > 0) {
					savePromises.push(saveReceiptsBatchNew(newReceipts));
				}
				
				const saveResults = await Promise.all(savePromises);
				const allSaved = saveResults.every(result => result === true);
				
				// ======== שלב 6: עדכון ממשק ========
				saveToLocalStorage();
				loadLocationsTable();
				loadReceiptsTable();
				loadLocationsForSelect();
				loadFilterOptions();
				
				hideLoading();
				
				// ======== דיווח סופי ========
				console.log('📊 Import completed:', stats);
				
				const totalImported = stats.locations.imported + stats.visits.imported + stats.receipts.imported;
				const totalSkipped = stats.locations.skipped + stats.visits.skipped + stats.receipts.skipped;
				
				// חישוב ועדכון תאריכי טיפול (הוספה חדשה)
				if (stats.visits.imported > 0) {
					showToast('מחשב תאריכי טיפול...', 'info', 2000);
					const updatedCount = await calculateTreatmentDates();
					if (updatedCount > 0) {
						showToast(`✅ עודכנו תאריכי טיפול עבור ${updatedCount} לקוחות`, 'success', 3000);
					}
				}
				
				if (totalImported > 0) {
					const message = `🎉 ייבוא הושלם בהצלחה!
					
		✅ יובאו: ${stats.locations.imported} לקוחות, ${stats.visits.imported} ביקורים, ${stats.receipts.imported} קבלות
		${totalSkipped > 0 ? `⚠️ דולגו (כפילויות): ${totalSkipped} רשומות` : ''}
		${allSaved ? '☁️ נשמר לענן בהצלחה' : '⚠️ חלק מהנתונים לא נשמרו לענן'}`;
					
					showToast(message, 'success', 8000);
				} else {
					showToast('לא נמצאו נתונים חדשים לייבוא', 'info');
				}
				
			} catch (error) {
				console.error('Error in fast import:', error);
				hideLoading();
				showToast('שגיאה בייבוא מהיר', 'error');
			}
		}

		// פונקציות עזר חדשות ומעודכנות לשמירה מקבצית
		async function saveLocationsBatchNew(locationsArray) {
			if (!locationsArray.length) return true;
			
			try {
				const values = locationsArray.map(loc => [
					loc.ID, loc.name, loc.full_address, loc.neighborhood, loc.city,
					loc.contact_person, loc.phone, loc.allowed_day, loc.interval_weeks,
					loc.temp_addition, loc.base_amount, loc.active, loc.notes,
					loc.last_visit, loc.next_visit
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A2:O2',
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`✅ Saved ${locationsArray.length} locations to cloud`);
				return true;
			} catch (error) {
				console.error('Error saving locations batch:', error);
				return false;
			}
		}

		async function saveVisitsBatchNew(visitsArray) {
			if (!visitsArray.length) return true;
			
			try {
				const values = visitsArray.map(visit => [
					visit.ID, visit.date, visit.location_id, visit.location_name, visit.visit_type, visit.work_done,
					visit.duration_minutes, visit.num_workers, visit.start_time, visit.end_time,
					visit.amount, visit.expense, visit.notes
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Visits!A2:M2', // ← חזרנו ל-M כי הסרנו paid
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`✅ Saved ${visitsArray.length} visits to cloud`);
				return true;
			} catch (error) {
				console.error('Error saving visits batch:', error);
				return false;
			}
		}

		async function saveReceiptsBatchNew(receiptsArray) {
			if (!receiptsArray.length) return true;
			
			try {
				const values = receiptsArray.map(receipt => [
					receipt.ID, receipt.book_number, receipt.receipt_number, receipt.date,
					receipt.location_id, receipt.location_name, receipt.amount,
					receipt.payment_type, receipt.notes
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Receipts!A2:I2',
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`✅ Saved ${receiptsArray.length} receipts to cloud`);
				return true;
			} catch (error) {
				console.error('Error saving receipts batch:', error);
				return false;
			}
		}

	   
	   ////////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	   
	   // החלף את validateToken בפונקציה זו:
		async function validateToken() {
			if (!access_token || !gapi.client) {
				updateCloudStatus('🔐 לא מחובר לענן', 'נותק');
				return false;
			}
			
			try {
				// בדיקה פשוטה - נסה לקרוא מהטבלה
				await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID || 'test'
				});
				return true;
			} catch (error) {
				if (error.status === 401) {
					console.log('Google token expired');
					access_token = null;
					updateCloudStatus('🔐 נדרש חיבור מחדש', 'נותק');
					document.getElementById('statusText').classList.remove('connected');
					document.getElementById('saveBtn').disabled = true;
					document.getElementById('loadBtn').disabled = true;
					showToast('⚠️ החיבור לגוגל פג - התחבר מחדש', 'warning');
					return false;
				}
				updateCloudStatus('⚠️ בעיית חיבור לענן', 'שגיאה');
				return false;
			}
		}

		// החלף את saveEditedLocation בפונקציה זו:
		function saveEditedLocation(locationId) {
			console.log(`✅ saveEditedLocation ('${locationId}')`);
			const locationIndex = locations.findIndex(g => g.ID == locationId);
			if (locationIndex === -1) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			try {
				// עדכן את הלקוח במערך המקומי
				const updatedLocation = {
					...locations[locationIndex], // שמור נתונים קיימים
					name: document.getElementById('editLocationName').value,
					full_address: document.getElementById('editLocationAddress').value,
					neighborhood: document.getElementById('editLocationNeighborhood').value,
					city: document.getElementById('editLocationCity').value,
					contact_person: document.getElementById('editLocationContact').value,
					phone: document.getElementById('editLocationPhone').value,
					allowed_day: document.getElementById('editLocationDay').value,
					interval_weeks: parseInt(document.getElementById('editLocationInterval').value) || 4,
					base_amount: parseFloat(document.getElementById('editLocationAmount').value) || 0,
					active: document.getElementById('editLocationActive').value,
					next_visit: document.getElementById('editLocationNextVisit').value,
					client_requests: document.getElementById('editLocationClientRequests').value,
					notes: document.getElementById('editLocationNotes').value
				};
				
				locations[locationIndex] = updatedLocation;
				
				// שמור מקומית תמיד
				saveToLocalStorage();
				updateCloudStatus('💾 שומר...', 'מעדכן');
				
				// נסה לשמור בענן
				if (access_token && SPREADSHEET_ID) {
					console.log('🔍 About to call updateLocationInCloud with:', updatedLocation.client_requests);
					// עדכון בענן (לא הוספה חדשה)
					updateLocationInCloud(updatedLocation).then(() => {
						updateCloudStatus('✅ מחובר ומסונכרן', 'נשמר');
						showToast('לקוח עודכן בהצלחה במערכת ובענן!', 'success');
					}).catch(error => {
						console.error('❌ updateLocationInCloud failed:', error);
						if (error.status === 401) {
							updateCloudStatus('🔐 נדרש חיבור מחדש', 'נותק');
							showToast('⚠️ החיבור לגוגל פג - הלקוח נשמר מקומית בלבד', 'warning');
							access_token = null;
							document.getElementById('saveBtn').disabled = true;
							document.getElementById('loadBtn').disabled = true;
						} else {
							updateCloudStatus('⚠️ שגיאה בשמירה', 'שגיאה');
							showToast('⚠️ הלקוח נשמר מקומית, אבל לא הצליח לשמור בענן', 'warning');
						}
					});
				} else {
					updateCloudStatus('🔐 שינויים לא נשמרו בענן', 'מקומי');
					showToast('🔐 לקוח נשמר מקומית - התחבר לענן לשמירה מלאה', 'warning');
				}
				
				// עדכן תצוגה
				loadLocationsTable();
				loadLocationsForSelect();
				closeEditModal();
				
			} catch (error) {
				console.error('Error updating location:', error);
				updateCloudStatus('❌ שגיאה במערכת', 'שגיאה');
				showToast('שגיאה בעדכון הלקוח', 'error');
			}
		}


		// החלף את saveEditedReceipt בפונקציה זו:
		function saveEditedReceipt(receiptId) {
			console.log(`✅ saveEditedReceipt ('${receiptId}')`);
			const receiptIndex = receipts.findIndex(r => r.ID == receiptId);
			if (receiptIndex === -1) {
				showToast('קבלה לא נמצאה', 'error');
				return;
			}
			
			try {
				const locationId = document.getElementById('editReceiptLocation').value;
				const location = locations.find(g => g.ID == locationId);
				
				// עדכן את הקבלה במערך המקומי
				const updatedReceipt = {
					...receipts[receiptIndex], // שמור נתונים קיימים
					book_number: document.getElementById('editReceiptBook').value,
					receipt_number: document.getElementById('editReceiptNumber').value,
					date: document.getElementById('editReceiptDate').value,
					location_id: locationId,
					location_name: location ? location.name : '',
					amount: parseFloat(document.getElementById('editReceiptAmount').value) || 0,
					payment_type: document.getElementById('editReceiptPaymentType').value,
					notes: document.getElementById('editReceiptNotes').value
				};
				
				receipts[receiptIndex] = updatedReceipt;
				
				// שמור מקומית תמיד
				saveToLocalStorage();
				updateCloudStatus('💾 שומר קבלה...', 'מעדכן');
				
				// נסה לשמור בענן
				if (access_token && SPREADSHEET_ID) {
					updateReceiptInCloud(updatedReceipt).then(() => {
						updateCloudStatus('✅ מחובר ומסונכרן', 'נשמר');
						showToast('קבלה עודכנה בהצלחה במערכת ובענן!', 'success');
					}).catch(error => {
						if (error.status === 401) {
							updateCloudStatus('🔐 נדרש חיבור מחדש', 'נותק');
							showToast('⚠️ החיבור לגוגל פג - הקבלה נשמרה מקומית בלבד', 'warning');
							access_token = null;
						} else {
							updateCloudStatus('⚠️ שגיאה בשמירה', 'שגיאה');
							showToast('⚠️ הקבלה נשמרה מקומית, אבל לא הצליחה לשמור בענן', 'warning');
						}
					});
				} else {
					updateCloudStatus('🔐 שינויים לא נשמרו בענן', 'מקומי');
					showToast('🔐 קבלה נשמרה מקומית - התחבר לענן לשמירה מלאה', 'warning');
				}
				
				// עדכן תצוגה
				loadReceiptsTable();
				closeEditModal();
				
			} catch (error) {
				console.error('Error updating receipt:', error);
				updateCloudStatus('❌ שגיאה במערכת', 'שגיאה');
				showToast('שגיאה בעדכון הקבלה', 'error');
			}
		}

		// החלף את saveEditedVisit בפונקציה זו:
		async function saveEditedVisit(visitId) {
			console.log(`✅ saveEditedVisit ('${visitId}')`);
			const visitIndex = visits.findIndex(v => v.ID == visitId);
			if (visitIndex === -1) {
				showToast('ביקור לא נמצא', 'error');
				return;
			}
			
			try {
				// עדכן את הביקור במערך המקומי
				const updatedVisit = {
					...visits[visitIndex], // שמור נתונים קיימים
					date: document.getElementById('editVisitDate').value,
					visit_type: document.getElementById('editVisitType').value,
					work_done: document.getElementById('editWorkDone').value,
					duration_minutes: parseInt(document.getElementById('editDuration').value) || 0,
					start_time: document.getElementById('editStartTime').value,
					amount: parseFloat(document.getElementById('editAmount').value) || 0,
					expense: parseFloat(document.getElementById('editExpense').value) || 0,
					paid: document.getElementById('editPaid').value,
					notes: document.getElementById('editNotes').value
				};
				
				visits[visitIndex] = updatedVisit;
				
				// שמור מקומית תמיד
				saveToLocalStorage();
				updateCloudStatus('💾 שומר ביקור...', 'מעדכן');
				
				// נסה לשמור בענן
				if (access_token && SPREADSHEET_ID) {
					try {
						await updateVisitInCloud(updatedVisit);
						updateCloudStatus('✅ מחובר ומסונכרן', 'נשמר');
						showToast('ביקור עודכן בהצלחה במערכת ובענן!', 'success');
					} catch (error) {
						if (error.status === 401) {
							updateCloudStatus('🔐 נדרש חיבור מחדש', 'נותק');
							showToast('⚠️ החיבור לגוגל פג - הביקור נשמר מקומית בלבד', 'warning');
							access_token = null;
						} else {
							updateCloudStatus('⚠️ שגיאה בשמירה', 'שגיאה');
							showToast('⚠️ הביקור נשמר מקומית, אבל לא הצליח לשמור בענן', 'warning');
						}
					}
				} else {
					updateCloudStatus('🔐 שינויים לא נשמרו בענן', 'מקומי');
					showToast('🔐 ביקור נשמר מקומית - התחבר לענן לשמירה מלאה', 'warning');
				}
				
				// עדכן תצוגה
				applyVisitFilters();
				closeEditModal();
				
			} catch (error) {
				console.error('Error updating visit:', error);
				updateCloudStatus('❌ שגיאה במערכת', 'שגיאה');
				showToast('שגיאה בעדכון הביקור', 'error');
			}
		}

		// החלף את connectToGoogleSheets בפונקציה זו:
		async function connectToGoogleSheets() {
			try {
				console.log('Connecting to Google Sheets...');
				updateCloudStatus('🔗 מתחבר...', 'מתחבר');
				showToast('מתחבר ל-Google Sheets...', 'info');
				
				const tokenClient = google.accounts.oauth2.initTokenClient({
					client_id: CLIENT_ID,
					scope: SCOPES,
					callback: async (response) => {
						access_token = response.access_token;
						
						// עדכון סטטוס
						updateCloudStatus('✅ מחובר ומסונכרן', 'התחבר');
						document.getElementById('statusText').classList.add('connected');
						document.getElementById('saveBtn').disabled = false;
						document.getElementById('loadBtn').disabled = false;
						
						showToast('התחברת בהצלחה ל-Google Sheets!', 'success');
						
						// מציאה או יצירת הטבלה הראשית
						await findOrCreateMainSpreadsheet();

						// ודא שכל הטבלאות החדשות קיימות
						await ensureNewTablesExist();

						// טעינה אוטומטית של נתונים אם קיימים
						if (SPREADSHEET_ID) {
							try {
								await loadAllDataFromSheets();
							} catch (error) {
								console.log('Could not auto-load data:', error);
							}
						}
					},
				});
				
				tokenClient.requestAccessToken();
				
			} catch (error) {
				console.error('Error connecting to Google Sheets:', error);
				updateCloudStatus('❌ שגיאה בחיבור', 'שגיאה');
				showToast('שגיאה בחיבור ל-Google Sheets', 'error');
			}
		}

		// החלף את saveAllToSheets בפונקציה זו:
		async function saveAllToSheets() {
			if (!await validateToken()) {
				showToast('אין חיבור לגוגל - שמירה מקומית בלבד', 'warning');
				return;
			}
			
			try {
				updateCloudStatus('שומר נתונים לענן...', 'מעדכן');
				
				// שמירה בבאצ'ים (לא לולאות!)
				const savePromises = [];
				
				if (locations.length > 0) {
					showToast(`שומר ${locations.length} לקוחות בבת אחת...`, 'info', 2000);
					savePromises.push(saveLocationsBatch(locations));
				}
				
				if (visits.length > 0) {
					showToast(`שומר ${visits.length} ביקורים בבת אחת...`, 'info', 2000);
					savePromises.push(saveVisitsBatch(visits));
				}
				
				if (receipts.length > 0) {
					showToast(`שומר ${receipts.length} קבלות בבת אחת...`, 'info', 2000);
					savePromises.push(saveReceiptsBatch(receipts));
				}
				
				// המתן לכל השמירות במקביל
				await Promise.all(savePromises);
				
				updateCloudStatus('מחובר ומסונכרן', 'נשמר');
				showToast(`כל הנתונים נשמרו בענן בהצלחה!`, 'success', 3000);
				
			} catch (error) {
				console.error('Error saving all data to cloud:', error);
				updateCloudStatus('שגיאה בשמירה לענן', 'שגיאה');
				showToast('שגיאה בשמירה לענן - הנתונים נשמרו מקומית', 'error');
			}
		}

		// הוסף את פונקציית updateCloudStatus החדשה:
		function updateCloudStatus(status, lastAction) {
			const statusElement = document.getElementById('statusText');
			const lastSavedElement = document.getElementById('lastSaved');
			
			if (statusElement) {
				statusElement.textContent = status;
				
				// עדכון צבעים לפי סטטוס
				if (status.includes('מחובר') || status.includes('מסונכרן')) {
					statusElement.style.color = '#28a745'; // ירוק
					statusElement.style.fontWeight = 'bold';
					statusElement.style.background = 'transparent'; // הסר רקע
					statusElement.classList.add('connected');
				} else if (status.includes('שומר') || status.includes('מעדכן')) {
					statusElement.style.color = '#ffc107'; // צהוב
					statusElement.style.fontWeight = 'bold';
				} else if (status.includes('שגיאה')) {
					statusElement.style.color = '#dc3545'; // אדום
					statusElement.style.fontWeight = 'bold';
					statusElement.classList.remove('connected');
				} else if (status.includes('נדרש חיבור')) {
					statusElement.style.color = '#fd7e14'; // כתום
					statusElement.style.fontWeight = 'bold';
					statusElement.classList.remove('connected');
				}
			}
			
			// עדכון זמן פעולה אחרונה
			if (lastSavedElement && lastAction) {
				lastSavedElement.textContent = `${lastAction}: ${new Date().toLocaleTimeString('he-IL')}`;
				//lastSavedElement.style.color = //'#333'; // צבע כהה יותר
			}
		}
	   
	   
	   
	   //////////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	   
	   
	   function formatDateForSheets(dateString) {
			if (!dateString) return '';
			const date = new Date(dateString);
			const day = String(date.getDate()).padStart(2, '0');
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const year = date.getFullYear();
			return `${day}/${month}/${year}`;
		}
	   
	   
	   // פונקציה להמרת סטטוס תשלום לקידוד מספרי
		function mapPaymentStatus(value) {
			if (!value || value.trim() === '') return "0";
			const normalized = value.toString().toLowerCase().trim();
			
			// המרה פשוטה לפי הערכים שיכולים להגיע מהייבוא
			if (normalized === "כן" || normalized === "true" || normalized === "1") return "1";
			if (normalized === "ללא תשלום" || normalized === "ללא") return "2";
			return "0"; // כל השאר = לא שולם
		}

		// פונקציה להצגת טקסט ידידותי
		function getPaymentStatusText(status) {
			switch(status) {
				case "0": return "לא שולם";
				case "1": return "שולם"; 
				case "2": return "ללא תשלום";
				default: return "לא שולם";
			}
		}
	   
	   
	   function parseAddressForImport(customerName) {
			if (!customerName) return { name: '', fullAddress: '', neighborhood: '', city: '' };
			
			const originalAddress = customerName.trim();
			const parts = originalAddress.split(' ');
			let city = '';
			
			if (parts.length >= 3) {
				// חיפוש מספר בית (מספר + אולי אות א/ב)
				let houseNumberIndex = -1;
				for (let i = 0; i < parts.length; i++) {
					if (/^\d+[א-ב]?$/.test(parts[i])) {
						houseNumberIndex = i;
						break; // לוקח את המספר הראשון שנמצא
					}
				}
				
				if (houseNumberIndex !== -1 && houseNumberIndex < parts.length - 1) {
					// יש מספר בית - כל מה שאחריו הוא עיר
					city = parts.slice(houseNumberIndex + 1).join(' ');
				} else {
					// אין מספר בית - כל הכתובת היא עיר
					city = originalAddress;
				}
			} else {
				// פחות מ-3 מילים - כל הכתובת היא עיר
				city = originalAddress;
			}
			
			// ✅ המרת הקיצור אחרי שקבענו את העיר
			if (city === 'ראשלצ') {
				city = 'ראשון לציון';
			}
			
			return {
				name: originalAddress, // השם המקורי ללא שינוי
				fullAddress: originalAddress,
				neighborhood: '', // ריק למילוי ידני
				city: city
			};
		}
		
		
		// פונקציה לעדכון תאריך טיפול הבא
		// עדכון תאריך טיפול הבא ללקוח
		function updateClientNextVisit(clientId, newDate) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לא נמצא לקוח', 'error');
				return;
			}
			
			// בדיקת תקינות התאריך
			if (!newDate || isNaN(new Date(newDate))) {
				showToast('תאריך לא תקין', 'error');
				return;
			}
			
			const oldDate = client.next_visit;
			client.next_visit = newDate;
			
			// איפוס הוספות זמניות
			if (client.temp_addition) {
				client.temp_addition = 0;
			}
			
			// שמירה מקומית
			saveToLocalStorage();
			
			// שמירה בענן אם מחובר
			if (access_token && SPREADSHEET_ID) {
				updateLocationInCloud(client).then(() => {
					console.log('✅ תאריך עודכן בענן');
				}).catch(error => {
					console.error('❌ שגיאה בעדכון ענן:', error);
					showToast('התאריך עודכן מקומית, אך לא בענן', 'warning');
				});
			}
			
			const formattedDate = formatDate(newDate);
			showToast(`תאריך הטיפול הבא עבור ${client.name} עודכן ל-${formattedDate}`, 'success');
			
			// רענון התצוגה
			setTimeout(() => {
				loadPlanningDataAdvanced();
			}, 300);
		}

		// פונקציה להפיכת לקוח לפעיל/לא פעיל
		function toggleClientActive(clientId, activeValue) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			client.active = activeValue;
			
			// שמירה
			saveToLocalStorage();
			
			// עדכון בענן אם מחובר
			if (access_token && SPREADSHEET_ID) {
				updateLocationInCloud(client);
			}
			
			const statusText = activeValue === "1" ? "פעיל" : "לא פעיל";
			showToast(`${client.name} הוגדר כ-${statusText}`, 'success');
			
			// רענון התצוגה (הלקוח ייעלם אם לא פעיל)
			loadPlanningDataAdvanced();
		}

		// פונקציה להצגת היסטוריית טיפולים
		function showClientHistory(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			// מציאת 3 הטיפולים האחרונים
			const clientVisits = visits
				.filter(visit => visit.location_id === clientId)
				.sort((a, b) => new Date(b.date) - new Date(a.date))
				.slice(0, 3);
			
			if (clientVisits.length === 0) {
				alert(`${client.name}\nאין עדיין היסטוריית טיפולים`);
				return;
			}
			
			// בניית תוכן החלונית
			let historyHtml = `
				<div style="background: white; padding: 20px; border-radius: 10px; max-width: 500px; max-height: 400px; overflow-y: auto;">
					<h3 style="margin-bottom: 15px; color: #333;">📋 היסטוריית טיפולים - ${client.name}</h3>
					<div style="margin-bottom: 20px; font-size: 12px; color: #666;">
						כתובת: ${client.full_address}
					</div>
					<div style="space-y: 10px;">
			`;
			
			clientVisits.forEach((visit, index) => {
				const visitDate = formatDate(visit.date);
				const amount = visit.amount || 0;
				const workDone = visit.work_done || 'טיפול';
				const paidStatus = visit.paid === 'כן' ? '✅ שולם' : '❌ לא שולם';
				const paidColor = visit.paid === 'כן' ? '#28a745' : '#dc3545';
				
				historyHtml += `
					<div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 10px; background: ${index === 0 ? '#f8f9ff' : '#fafafa'};">
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
							<strong style="color: #2c3e50;">📅 ${visitDate}</strong>
							<span style="font-weight: bold; color: ${paidColor};">${paidStatus}</span>
						</div>
						<div style="margin-bottom: 5px; color: #666;">
							🛠️ עבודה: ${workDone}
						</div>
						<div style="display: flex; justify-content: space-between; font-size: 14px;">
							<span>💰 ₪${amount}</span>
							${visit.duration_minutes ? `<span>⏱️ ${visit.duration_minutes} דק'</span>` : ''}
						</div>
						${visit.notes ? `<div style="margin-top: 8px; font-size: 12px; color: #666; font-style: italic;">📝 ${visit.notes}</div>` : ''}
					</div>
				`;
			});
			
			historyHtml += `
					</div>
					<div style="text-align: center; margin-top: 20px;">
						<button onclick="closeModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
							סגור
						</button>
					</div>
				</div>
			`;
			
			// הצגת החלונית
			showModal(historyHtml);
		}
		
	   
	   // פונקציה לעדכון לקוח ספציפי בענן
		async function updateLocationInCloud(client) {
			if (!await validateToken()) return;
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:A'
				});
				
				const rows = response.result.values || [];
				const rowIndex = rows.findIndex(row => row[0] === client.ID);
				
				if (rowIndex > 0) {
					const rowNumber = rowIndex + 1;
					const clientRow = [
						client.ID, client.name, client.full_address, client.neighborhood, client.city,
						client.contact_person, client.phone, client.allowed_day, client.interval_weeks,
						client.temp_addition || 0, // ✅ הוסף בדיקה
						client.base_amount, client.active, client.notes,
						client.last_visit, client.next_visit, client.client_requests || ''
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Locations!A${rowNumber}:P${rowNumber}`,
						valueInputOption: 'USER_ENTERED',
						resource: { values: [clientRow] }
					});
					
					console.log('✅ Successfully updated client in cloud'); // לוג להצלחה
				} else {
					throw new Error(`Client with ID ${client.ID} not found in spreadsheet`);
				}
			} catch (error) {
				console.error('Error updating client in cloud:', error);
				throw error; // ✅ חשוב - העבר את השגיאה הלאה
			}
		}
	   
	   
	   // ===== פונקציות פענוח הכנסות מטלגרם =====

		// המרת תאריך מפורמט טלגרם ל-ISO
		function parseTelegramDateToISO(dateStr) {
			const months = {
				'January': '01', 'February': '02', 'March': '03', 'April': '04',
				'May': '05', 'June': '06', 'July': '07', 'August': '08',
				'September': '09', 'October': '10', 'November': '11', 'December': '12'
			};
			
			const parts = dateStr.split(' ');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = months[parts[1]] || '01';
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			return dateStr;
		}

		// פענוח שורת הכנסה בודדת
		function parseIncomeLineFromTelegram(line, date, time) {
			try {
				// חילוץ כתובת לקוח
				let clientAddress = '';
				const dotIndex = line.indexOf('.');
				if (dotIndex > 0) {
					clientAddress = line.substring(0, dotIndex).trim();
				} else {
					const beforeReceived = line.split('קיבלתי')[0].trim();
					clientAddress = beforeReceived.replace(/[.,]$/, '');
				}

				// חילוץ סכום - גרסה משופרת
				let amount = 0;
				const amountPatterns = [
					/קיבלתי\s+תשלום\s+(\d+)/,     
					/קיבלתי\s+(\d+)/,              
					/קיבלתי\s+צ'ק\s+(\d+)/,        
					/קיבלתי\s+עוד\s+(\d+)/,        
					/(\d+)\s+מזומן/,               
					/(\d+)\s+ביט/,                 
					/(\d+)\s+העברה/,               
					/(\d+)\s+פייבוקס/,
					/(\d+)\s+צ'ק/
				];
				
				for (const pattern of amountPatterns) {
					const match = line.match(pattern);
					if (match) {
						amount = parseInt(match[1]);
						break;
					}
				}
				
				// אם עדיין לא מצאנו, חפש מספרים גדולים
				if (amount === 0) {
					const allNumbers = line.match(/\d+/g);
					if (allNumbers && allNumbers.length > 0) {
						const numbers = allNumbers.map(n => parseInt(n)).filter(n => n >= 50);
						if (numbers.length > 0) {
							amount = Math.max(...numbers);
						}
					}
				}

				// זיהוי אמצעי תשלום - עם תיקון "לא צוין" = מזומן
				let paymentMethod = 'מזומן'; // ברירת מחדל במקום "לא צוין"
				if (line.includes('העברה לחשבון') || line.includes('העברה')) {
					paymentMethod = 'העברה בנקאית';
				} else if (line.includes('צ\'ק')) {
					paymentMethod = 'צ\'ק';
				} else if (line.includes('ביט')) {
					paymentMethod = 'ביט';
				} else if (line.includes('מזומן')) {
					paymentMethod = 'מזומן';
				} else if (line.includes('פייבוקס')) {
					paymentMethod = 'פייבוקס';
				}

				// חילוץ הערות
				let notes = '';
				if (line.includes('עבור')) {
					const match = line.match(/עבור[^.]+/);
					if (match) notes += match[0] + ' ';
				}
				if (line.includes('שכחתי') || line.includes('לא רשמתי') || line.includes('לא עדכנתי')) {
					notes += 'לא תועד מיד ';
				}
				if (line.includes('על החשבון') || line.includes('חוב')) {
					notes += 'תשלום על חשבון ';
				}

				return {
					date: date,
					time: time,
					client_address: clientAddress,
					amount: amount,
					payment_method: paymentMethod,
					notes: notes.trim(),
					raw_text: line
				};
			} catch (error) {
				console.error('שגיאה בפענוח שורת הכנסה:', line, error);
				return null;
			}
		}

		// פענוח מלא של נתוני הכנסות מטלגרם
		function parseIncomesFromTelegramText(telegramText) {
			const lines = telegramText.split('\n').map(line => line.replace(/\r$/, '').trim());
			const incomes = [];
			let currentDate = '';
			let currentTime = '';
			
			for (let i = 0; i < lines.length; i++) {
				const line = lines[i];
				
				// זיהוי תאריך (15 August 2024)
				if (/^\d{1,2} \w+ \d{4}$/.test(line)) {
					currentDate = parseTelegramDateToISO(line);
					continue;
				}
				
				// זיהוי שעה (20:04)
				if (/^\d{1,2}:\d{2}$/.test(line)) {
					currentTime = line;
					continue;
				}
				
				// זיהוי הודעת הכנסה (מכילה "קיבלתי" ומספר)
				if (line.includes('קיבלתי') && /\d+/.test(line)) {
					const income = parseIncomeLineFromTelegram(line, currentDate, currentTime);
					if (income && income.amount > 0) {
						incomes.push(income);
					}
				}
			}
			
			return incomes;
		}
	   
	   
	   // ===== פונקציות העלאה וטיפול בקובץ הכנסות טלגרם =====

		// מערך גלובלי לאחסון הכנסות מטלגרם
		let telegramIncomes = [];

		// פונקציה לטיפול בהעלאת קובץ הכנסות מטלגרם
		async function handleTelegramIncomeFileUpload(event) {
			const file = event.target.files[0];
			if (!file) {
				showToast('לא נבחר קובץ', 'warning');
				return;
			}

			console.log('✅ מערכת ייבוא הכנסות מטלגרם מופעלת');

			try {
				showLoading('קורא קובץ הכנסות מטלגרם...');
				
				const text = await file.text();
				console.log('📄 קובץ נקרא:', file.name, 'גודל:', text.length, 'תווים');
				
				// פענוח הנתונים
				const parsedIncomes = parseIncomesFromTelegramText(text);
				
				if (parsedIncomes.length === 0) {
					hideLoading();
					showToast('לא נמצאו הכנסות בקובץ', 'warning');
					return;
				}
				
				// שמירה במערך הגלובלי
				telegramIncomes = parsedIncomes;
				
				hideLoading();
				
				// הצגת תוצאות
				const totalAmount = parsedIncomes.reduce((sum, income) => sum + income.amount, 0);
				showToast(`🎉 נמצאו ${parsedIncomes.length} הכנסות, סך ${totalAmount.toLocaleString()} ש"ח`, 'success', 4000);
				
				// הצגת תצוגה מקדימה
				showTelegramIncomesPreview(parsedIncomes);
				
			} catch (error) {
				console.error('שגיאה בקריאת קובץ הכנסות:', error);
				hideLoading();
				showToast('שגיאה בקריאת הקובץ', 'error');
			}
		}

		// הצגת תצוגה מקדימה של ההכנסות שנמצאו
		function showTelegramIncomesPreview(incomes) {
			const totalAmount = incomes.reduce((sum, income) => sum + income.amount, 0);
			
			// התפלגות אמצעי תשלום
			const paymentMethods = {};
			incomes.forEach(income => {
				paymentMethods[income.payment_method] = (paymentMethods[income.payment_method] || 0) + 1;
			});
			
			let previewHTML = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 900px; max-height: 70vh; overflow-y: auto; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">💰 תצוגה מקדימה - הכנסות מטלגרם</h3>
					
					<div style="margin-bottom: 25px; padding: 18px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #27ae60;">
						<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
							<div>
								<strong style="font-size: 20px; color: #27ae60;">${incomes.length}</strong><br>
								<span style="color: #666;">הכנסות נמצאו</span>
							</div>
							<div>
								<strong style="font-size: 20px; color: #27ae60;">${totalAmount.toLocaleString()}</strong><br>
								<span style="color: #666;">ש"ח סה"כ</span>
							</div>
							<div>
								<strong style="font-size: 20px; color: #27ae60;">${Object.keys(paymentMethods).length}</strong><br>
								<span style="color: #666;">אמצעי תשלום</span>
							</div>
						</div>
					</div>
					
					<div style="margin-bottom: 20px;">
						<h4 style="color: #34495e; margin-bottom: 10px;">📊 פילוח אמצעי תשלום:</h4>
						<div style="display: flex; flex-wrap: wrap; gap: 10px;">
							${Object.entries(paymentMethods).map(([method, count]) => 
								`<span style="background: #3498db; color: white; padding: 5px 12px; border-radius: 15px; font-size: 13px;">
									${method}: ${count}
								</span>`
							).join('')}
						</div>
					</div>
					
					<div style="margin-bottom: 20px;">
						<h4 style="color: #34495e; margin-bottom: 15px;">📋 דוגמאות (10 ראשונות):</h4>
						<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px;">
							<table style="width: 100%; border-collapse: collapse; font-size: 13px;">
								<thead style="background: #f8f9fa; position: sticky; top: 0;">
									<tr>
										<th style="padding: 10px; border: 1px solid #ddd; text-align: right;">תאריך</th>
										<th style="padding: 10px; border: 1px solid #ddd; text-align: right;">לקוח</th>
										<th style="padding: 10px; border: 1px solid #ddd; text-align: right;">סכום</th>
										<th style="padding: 10px; border: 1px solid #ddd; text-align: right;">תשלום</th>
										<th style="padding: 10px; border: 1px solid #ddd; text-align: right;">הערות</th>
									</tr>
								</thead>
								<tbody>
									${incomes.slice(0, 10).map((income, index) => `
										<tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
											<td style="padding: 8px; border: 1px solid #ddd;">${income.date}</td>
											<td style="padding: 8px; border: 1px solid #ddd; max-width: 150px; word-wrap: break-word;">${income.client_address}</td>
											<td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #27ae60;">${income.amount}</td>
											<td style="padding: 8px; border: 1px solid #ddd;">${income.payment_method}</td>
											<td style="padding: 8px; border: 1px solid #ddd; font-size: 11px; color: #666;">${income.notes || '-'}</td>
										</tr>
									`).join('')}
								</tbody>
							</table>
						</div>
						${incomes.length > 10 ? `<p style="text-align: center; color: #666; margin-top: 10px;">ועוד ${incomes.length - 10} הכנסות...</p>` : ''}
					</div>
					
					<div style="text-align: center; gap: 15px; display: flex; justify-content: center;">
						<button class="btn btn-success" onclick="confirmTelegramIncomesImport()" style="padding: 12px 25px; font-size: 16px;">
							✅ ייבא ${incomes.length} הכנסות למערכת
						</button>
						<button class="btn btn-secondary" onclick="cancelTelegramIncomesImport()" style="padding: 12px 25px; font-size: 16px;">
							❌ ביטול
						</button>
					</div>
				</div>
			`;
			
			showModal(previewHTML);
		}

		// ביטול ייבוא הכנסות
		function cancelTelegramIncomesImport() {
			telegramIncomes = [];
			closeModal();
			showToast('ייבוא הכנסות בוטל', 'info');
		}


		// ===== פונקציות אישור ייבוא הכנסות =====

		// ===== פונקציות וידוא קיום גיליונות נדרשים =====

		// וידוא קיום גיליון הכנסות במערכת הראשית
		async function ensureIncomesSheetExists() {
			if (!await validateToken()) return false;
			
			try {
				const response = await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				
				const existingSheets = response.result.sheets.map(sheet => sheet.properties.title);
				
				if (!existingSheets.includes('Incomes')) {
					console.log('יוצר גיליון הכנסות...');
					
					await gapi.client.sheets.spreadsheets.batchUpdate({
						spreadsheetId: SPREADSHEET_ID,
						resource: {
							requests: [{
								addSheet: {
									properties: {
										title: 'Incomes',
										gridProperties: {
											rowCount: 1000,
											columnCount: 12
										}
									}
								}
							}]
						}
					});
					
					// הוספת כותרות
					const headers = [
						'ID', 'תאריך', 'שעה', 'כתובת_לקוח', 'מזהה_לקוח', 
						'סכום', 'אמצעי_תשלום', 'הערות', 'טקסט_מקורי', 
						'מקור_ייבוא', 'תאריך_ייבוא', 'סטטוס'
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: 'Incomes!A1:L1',
						valueInputOption: 'RAW',
						resource: { values: [headers] }
					});
					
					console.log('✅ גיליון הכנסות נוצר');
				}
				
				return true;
				
			} catch (error) {
				console.error('שגיאה בוידוא גיליון הכנסות:', error);
				return false;
			}
		}

	

		// אישור ייבוא ההכנסות מטלגרם - גירסה מעודכנת
		async function confirmTelegramIncomesImport() {
			if (!telegramIncomes || telegramIncomes.length === 0) {
				showToast('אין הכנסות לייבוא', 'warning');
				return;
			}
			
			try {
				showLoading('מכין מערכת לייבוא הכנסות...');
				
				// ודא שהטבלות קיימות
				await ensureNewTablesExist();
				
				showLoading('מייבא הכנסות למערכת...');
				
				// הוסף ID לכל הכנסה
				const incomesWithIds = telegramIncomes.map(income => ({
					...income,
					ID: generateID(),
					import_date: new Date().toISOString().split('T')[0],
					matched_to_visit: false,
					visit_ids: [],
					processed: false
				}));
				
				// שמור לטבלת TelegramIncomes
				await saveTelegramIncomesToCloud(incomesWithIds);
				
				let importedCount = 0;
				let skippedCount = 0;
				
				// יצירת מערך incomes אם לא קיים
				if (typeof incomes === 'undefined') {
					window.incomes = [];
				}
				
				for (const telegramIncome of incomesWithIds) {
					// בדיקת כפילות (תאריך + סכום + טקסט חלקי)
					const isDuplicate = incomes.some(existing => 
						existing.date === telegramIncome.date &&
						existing.amount === telegramIncome.amount &&
						existing.raw_text && 
						existing.raw_text.includes(telegramIncome.client_address.substring(0, 10))
					);
					
					if (isDuplicate) {
						skippedCount++;
						console.log('⚠️ דולג על הכנסה כפולה:', telegramIncome.client_address, telegramIncome.amount);
						continue;
					}
					
					// יצירת רשומת הכנסה חדשה במערכת הישנה (לתאימות לאחור)
					const newIncome = {
						ID: telegramIncome.ID,
						date: telegramIncome.date,
						time: telegramIncome.time || '',
						client_address: telegramIncome.client_address,
						client_id: null, // יקושר מאוחר יותר
						amount: telegramIncome.amount,
						payment_method: telegramIncome.payment_method,
						notes: telegramIncome.notes,
						raw_text: telegramIncome.raw_text,
						matched_to_visit: false,
						visit_ids: [],
						imported_from: 'telegram',
						import_date: telegramIncome.import_date
					};
					
					incomes.push(newIncome);
					importedCount++;
				}
				
				// שמירה מקומית
				saveToLocalStorage();
				
				hideLoading();
				closeModal();
				
				// הודעת הצלחה
				let message = `🎉 ייבוא הכנסות הושלם!\n💰 ${importedCount} הכנסות יובאו`;
				if (skippedCount > 0) {
					message += `\n⚠️ ${skippedCount} הכנסות דולגו (כפילות)`;
				}
				
				showToast(message, 'success', 5000);
				
				// רענון התצוגה אם נמצאים בעמוד הכנסות
				if (typeof loadIncomesTable === 'function') {
					loadIncomesTable();
				}
				
				// איפוס המערך הזמני
				telegramIncomes = [];
				
			} catch (error) {
				console.error('שגיאה בייבוא הכנסות:', error);
				hideLoading();
				showToast('שגיאה בייבוא הכנסות', 'error');
			}
		}

		// פונקציה נוספת - שמירת הכנסות מטלגרם לטבלה החדשה
		async function saveTelegramIncomesToCloud(telegramIncomes) {
			if (!access_token || !SPREADSHEET_ID || !telegramIncomes || telegramIncomes.length === 0) {
				return false;
			}
			
			try {
				console.log('💾 שומר הכנסות טלגרם...');
				
				// הכן נתונים לשמירה
				const rows = telegramIncomes.map(income => [
					income.ID,
					income.date,
					income.time || '',
					income.client_address,
					income.amount,
					income.payment_method,
					income.notes || '',
					income.raw_text || '',
					income.matched_to_visit || false,
					income.visit_ids ? income.visit_ids.join(',') : '',
					income.processed || false,
					income.import_date || new Date().toISOString().split('T')[0]
				]);
				
				// שמור לטבלה
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'TelegramIncomes!A:L',
					valueInputOption: 'USER_ENTERED',
					resource: { values: rows }
				});
				
				console.log(`✅ נשמרו ${telegramIncomes.length} הכנסות טלגרם`);
				return true;
				
			} catch (error) {
				console.error('שגיאה בשמירת הכנסות טלגרם:', error);
				return false;
			}
		}
		
		
		// הוספת כפתור העלאה לממשק (להוסיף למקום המתאים בממשק)
		function addTelegramIncomeUploadButton() {
			const uploadHTML = `
				<div class="upload-section" style="margin: 20px 0; padding: 20px; border: 2px dashed #3498db; border-radius: 10px; text-align: center;">
					<h3 style="color: #3498db; margin-bottom: 15px;">📤 ייבוא הכנסות מטלגרם</h3>
					<p style="color: #666; margin-bottom: 20px;">בחר קובץ טקסט עם ייצוא הכנסות מטלגרם</p>
					<input type="file" id="telegramIncomeFile" accept=".txt,.json" style="display: none;" onchange="handleTelegramIncomeFileUpload(event)">
					<button class="btn btn-primary" onclick="document.getElementById('telegramIncomeFile').click()" style="padding: 12px 25px; font-size: 16px;">
						📁 בחר קובץ הכנסות מטלגרם
					</button>
				</div>
			`;
			
			return uploadHTML;
		}


		// ===== פונקציות עזר נוספות למערכת הכנסות =====

		// יצירת פונקציה לטעינת רשימת הכנסות (אם לא קיימת)
		function loadIncomesTable() {
			if (typeof incomes === 'undefined' || !incomes.length) {
				console.log('📊 אין הכנסות להצגה');
				return;
			}
			
			console.log(`📊 טוען ${incomes.length} הכנסות לתצוגה`);
			// כאן תוסיף את הלוגיקה להצגת הכנסות בממשק בעתיד
		}

		// אתחול מערך הכנסות אם לא קיים
		if (typeof incomes === 'undefined') {
			window.incomes = [];
		}

		// הוספה לפונקציית שמירה מקומית הקיימת
		function saveIncomesToLocalStorage() {
			if (typeof incomes !== 'undefined' && incomes.length > 0) {
				localStorage.setItem('incomes', JSON.stringify(incomes));
				console.log('💾 שמר', incomes.length, 'הכנסות מקומית');
			}
		}

		// הוספה לפונקציית טעינה מקומית הקיימת  
		function loadIncomesFromLocalStorage() {
			const savedIncomes = localStorage.getItem('incomes');
			if (savedIncomes) {
				try {
					window.incomes = JSON.parse(savedIncomes);
					console.log('📂 טען', incomes.length, 'הכנסות מהזיכרון המקומי');
				} catch (error) {
					console.error('שגיאה בטעינת הכנסות:', error);
					window.incomes = [];
				}
			} else {
				window.incomes = [];
			}
		}

		// שמירת הכנסות בעננה (יש להתאים לפי המבנה הקיים)
		async function saveIncomesToCloud() {
			if (!access_token || !SPREADSHEET_ID) {
				throw new Error('לא מחובר לעננה');
			}
			
			console.log('💾 שומר הכנסות בעננה...');
			// כאן תוסיף את הלוגיקה לשמירה בגוגל שיטס בעתיד
		}


		// ===== פונקציות יצירת גיליונות נוספים במערכת =====

		// יצירת גיליון הכנסות בקובץ הראשי
		async function createIncomesSheet() {
			if (!await validateToken()) {
				showToast('התחבר לגוגל קודם', 'warning');
				return false;
			}
			
			try {
				showLoading('יוצר גיליון הכנסות...');
				
				// בדיקה אם הגיליון כבר קיים
				const sheetsResponse = await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				
				const existingSheet = sheetsResponse.result.sheets.find(sheet => 
					sheet.properties.title === 'Incomes'
				);
				
				if (existingSheet) {
					hideLoading();
					showToast('גיליון הכנסות כבר קיים', 'info');
					return true;
				}
				
				// יצירת הגיליון החדש
				await gapi.client.sheets.spreadsheets.batchUpdate({
					spreadsheetId: SPREADSHEET_ID,
					resource: {
						requests: [{
							addSheet: {
								properties: {
									title: 'Incomes',
									gridProperties: {
										rowCount: 1000,
										columnCount: 10
									}
								}
							}
						}]
					}
				});
				
				// הוספת כותרות
				const headers = [
					'ID', 'תאריך', 'שעה', 'כתובת_לקוח', 'מזהה_לקוח', 
					'סכום', 'אמצעי_תשלום', 'הערות', 'טקסט_מקורי', 'מקור_ייבוא'
				];
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Incomes!A1:J1',
					valueInputOption: 'RAW',
					resource: { values: [headers] }
				});
				
				hideLoading();
				showToast('✅ גיליון הכנסות נוצר בהצלחה!', 'success');
				return true;
				
			} catch (error) {
				console.error('שגיאה ביצירת גיליון הכנסות:', error);
				hideLoading();
				showToast('שגיאה ביצירת גיליון הכנסות', 'error');
				return false;
			}
		}

		

		// ===== מערכת טבלאות חדשה לטלגרם ותשלומים =====

		// פונקציה מרכזית ליצירת כל הטבלאות החדשות הנדרשות
		async function ensureNewTablesExist() {
			if (!await validateToken()) {
				showToast('נדרש חיבור לגוגל', 'warning');
				return false;
			}
			
			try {
				console.log('🔍 בודק קיום טבלאות חדשות...');
				
				// רשימת הטבלאות החדשות הנדרשות
				const requiredTables = [
					{ name: 'TelegramVisits', columns: 10 },
					{ name: 'TelegramIncomes', columns: 12 },
					{ name: 'Payments', columns: 10 },
					{ name: 'PaymentVisitLink', columns: 6 }
				];
				
				// בדיקת קיום הטבלאות הנוכחיות
				const response = await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				
				const existingSheets = response.result.sheets.map(sheet => sheet.properties.title);
				console.log('📋 גיליונות קיימים:', existingSheets);
				
				// יצירת הטבלאות החסרות
				let createdCount = 0;
				
				for (const table of requiredTables) {
					if (!existingSheets.includes(table.name)) {
						console.log(`🔨 יוצר טבלה: ${table.name}`);
						
						// יצירת הגיליון
						await gapi.client.sheets.spreadsheets.batchUpdate({
							spreadsheetId: SPREADSHEET_ID,
							resource: {
								requests: [{
									addSheet: {
										properties: {
											title: table.name,
											gridProperties: {
												rowCount: 1000,
												columnCount: table.columns
											}
										}
									}
								}]
							}
						});
						
						// הוספת כותרות
						await addHeadersToNewTable(table.name);
						createdCount++;
						
						console.log(`✅ נוצר בהצלחה: ${table.name}`);
					} else {
						console.log(`ℹ️ קיים כבר: ${table.name}`);
					}
				}
				
				if (createdCount > 0) {
					showToast(`✅ נוצרו ${createdCount} טבלאות חדשות!`, 'success');
				} else {
					console.log('✅ כל הטבלאות כבר קיימות');
				}
				
				return true;
				
			} catch (error) {
				console.error('שגיאה ביצירת הטבלאות החדשות:', error);
				showToast('שגיאה ביצירת טבלאות חדשות', 'error');
				return false;
			}
		}

		// הוספת כותרות לטבלאות החדשות
		async function addHeadersToNewTable(tableName) {
			let headers = [];
			
			switch (tableName) {
				case 'TelegramVisits':
					headers = [
						'ID', 'date', 'time', 'client_name', 'visit_type', 
						'work_done', 'duration_minutes', 'raw_text', 'processed', 'created_at'
					];
					break;
					
				case 'TelegramIncomes':
					headers = [
						'ID', 'date', 'time', 'client_address', 'amount', 'payment_method',
						'notes', 'raw_text', 'matched_to_visit', 'visit_ids', 'processed', 'created_at'
					];
					break;
					
				case 'Payments':
					headers = [
						'ID', 'date', 'time', 'amount', 'payment_method', 'source_type',
						'client_id', 'notes', 'status', 'created_at'
					];
					break;
					
				case 'PaymentVisitLink':
					headers = [
						'ID', 'payment_id', 'visit_id', 'amount_allocated', 'link_type', 'created_at'
					];
					break;
			}
			
			if (headers.length > 0) {
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `${tableName}!A1:${String.fromCharCode(64 + headers.length)}1`,
					valueInputOption: 'RAW',
					resource: { values: [headers] }
				});
			}
		}

		// ===== פונקציות שמירה לטבלאות החדשות =====

		// שמירת ביקורים מטלגרם לטבלת TelegramVisits
		async function saveTelegramVisitsToCloud(telegramVisits) {
			if (!access_token || !SPREADSHEET_ID || !telegramVisits || telegramVisits.length === 0) {
				return false;
			}
			
			try {
				console.log('💾 שומר ביקורי טלגרם...');
				
				// ודא שהטבלה קיימת
				await ensureNewTablesExist();
				
				// הכן נתונים לשמירה
				const rows = telegramVisits.map(visit => [
					visit.ID || generateID(),
					visit.date,
					visit.time || '',
					visit.client_name,
					visit.visit_type || 'general',
					visit.work_done,
					visit.duration_minutes || 60,
					visit.raw_text || '',
					false, // processed
					new Date().toISOString()
				]);
				
				// שמור לטבלה
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'TelegramVisits!A:J',
					valueInputOption: 'USER_ENTERED',
					resource: { values: rows }
				});
				
				console.log(`✅ נשמרו ${telegramVisits.length} ביקורי טלגרם`);
				return true;
				
			} catch (error) {
				console.error('שגיאה בשמירת ביקורי טלגרם:', error);
				return false;
			}
		}

		// טעינת ביקורים מטלגרם מהעלנן
		async function loadTelegramVisitsFromCloud() {
			if (!access_token || !SPREADSHEET_ID) {
				return [];
			}
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'TelegramVisits!A2:J1000'
				});
				
				if (!response.result.values) {
					return [];
				}
				
				return response.result.values.map(row => ({
					ID: row[0] || '',
					date: row[1] || '',
					time: row[2] || '',
					client_name: row[3] || '',
					visit_type: row[4] || '',
					work_done: row[5] || '',
					duration_minutes: parseInt(row[6]) || 60,
					raw_text: row[7] || '',
					processed: row[8] === 'true' || row[8] === true,
					created_at: row[9] || ''
				}));
				
			} catch (error) {
				console.error('שגיאה בטעינת ביקורי טלגרם:', error);
				return [];
			}
		}

		// טעינת הכנסות מטלגרם מהעלנן
		async function loadTelegramIncomesFromCloud() {
			if (!access_token || !SPREADSHEET_ID) {
				return [];
			}
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'TelegramIncomes!A2:L1000'
				});
				
				if (!response.result.values) {
					return [];
				}
				
				return response.result.values.map(row => ({
					ID: row[0] || '',
					date: row[1] || '',
					time: row[2] || '',
					client_address: row[3] || '',
					amount: parseFloat(row[4]) || 0,
					payment_method: row[5] || '',
					notes: row[6] || '',
					raw_text: row[7] || '',
					matched_to_visit: row[8] === 'true' || row[8] === true,
					visit_ids: row[9] ? row[9].split(',') : [],
					processed: row[10] === 'true' || row[10] === true,
					created_at: row[11] || ''
				}));
				
			} catch (error) {
				console.error('שגיאה בטעינת הכנסות מטלגרם:', error);
				return [];
			}
		}

		// ===== פונקציות לוגיקת תשלומים חדשה =====

		// משתני גלובליים לתשלומים
		let payments = [];
		let paymentVisitLinks = [];

		// בדיקת סטטוס תשלום של ביקור
		function getVisitPaymentStatus(visitId) {
			if (!visitId) return 'unpaid';
			
			// חפש קישורים לביקור הזה
			const visitLinks = paymentVisitLinks.filter(link => link.visit_id === visitId);
			
			if (visitLinks.length === 0) {
				return 'unpaid';
			}
			
			// בדוק אם יש תשלומים מושלמים
			const hasCompletedPayments = visitLinks.some(link => {
				const payment = payments.find(p => p.ID === link.payment_id);
				return payment && payment.status === 'completed';
			});
			
			return hasCompletedPayments ? 'paid' : 'unpaid';
		}

		// טקסט סטטוס תשלום מעודכן
		function getPaymentStatusText(status) {
			switch (status) {
				case 'paid': return 'שולם';
				case 'unpaid': return 'לא שולם';
				case 'partial': return 'שולם חלקית';
				default: return 'לא ידוע';
			}
		}

		// חישוב סכום שולם עבור ביקור
		function getVisitPaidAmount(visitId) {
			const visitLinks = paymentVisitLinks.filter(link => link.visit_id === visitId);
			
			let totalPaid = 0;
			visitLinks.forEach(link => {
				const payment = payments.find(p => p.ID === link.payment_id);
				if (payment && payment.status === 'completed') {
					totalPaid += parseFloat(link.amount_allocated) || 0;
				}
			});
			
			return totalPaid;
		}

		// עדכון פונקציית חישוב חובות
		function displayDebts() {
			const sortBy = document.getElementById('debtSortBy').value;
			const minAmount = parseFloat(document.getElementById('minDebtAmount').value) || 0;
			
			// חישוב חובות לכל לקוח - על בסיס הפרש בין amount לתשלומים
			const debtsByLocation = {};
			
			visits.forEach(visit => {
				if (visit.amount > 0) {
					const visitAmount = parseFloat(visit.amount) || 0;
					const paidAmount = getVisitPaidAmount(visit.ID);
					const debt = visitAmount - paidAmount;
					
					if (debt > 0) { // יש חוב
						if (!debtsByLocation[visit.location_id]) {
							const location = locations.find(loc => loc.ID === visit.location_id);
							debtsByLocation[visit.location_id] = {
								location: location,
								totalDebt: 0,
								visits: []
							};
						}
						
						debtsByLocation[visit.location_id].totalDebt += debt;
						debtsByLocation[visit.location_id].visits.push({
							...visit,
							debt: debt,
							paidAmount: paidAmount
						});
					}
				}
			});
			
			// המשך הפונקציה כמו קודם...
			const debtsArray = Object.values(debtsByLocation)
				.filter(debt => debt.totalDebt >= minAmount);
			
			// מיון
			debtsArray.sort((a, b) => {
				switch (sortBy) {
					case 'amount_desc': return b.totalDebt - a.totalDebt;
					case 'amount_asc': return a.totalDebt - b.totalDebt;
					case 'name': return a.location.name.localeCompare(b.location.name);
					default: return b.totalDebt - a.totalDebt;
				}
			});
			
			// הצגה...
			const tbody = document.getElementById('debtsTableBody');
			tbody.innerHTML = '';
			
			debtsArray.forEach(debt => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${debt.location.name}</td>
					<td>${debt.location.full_address}</td>
					<td>₪${debt.totalDebt.toLocaleString()}</td>
					<td>${debt.visits.length}</td>
					<td>
						<button onclick="markAllDebtsPaid('${debt.location.ID}')" class="btn btn-success btn-sm">
							סמן כשולם
						</button>
					</td>
				`;
				tbody.appendChild(row);
			});
		}

		// טעינת תשלומים וקישורים מהענן
		async function loadPaymentsFromCloud() {
			if (!access_token || !SPREADSHEET_ID) {
				return;
			}
			
			try {
				// טען תשלומים
				const paymentsResponse = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Payments!A2:J1000'
				});
				
				if (paymentsResponse.result.values) {
					payments = paymentsResponse.result.values.map(row => ({
						ID: row[0] || '',
						date: row[1] || '',
						time: row[2] || '',
						amount: parseFloat(row[3]) || 0,
						payment_method: row[4] || '',
						source_type: row[5] || '',
						client_id: row[6] || '',
						notes: row[7] || '',
						status: row[8] || 'completed',
						created_at: row[9] || ''
					}));
				}
				
				// טען קישורים
				const linksResponse = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'PaymentVisitLink!A2:F1000'
				});
				
				if (linksResponse.result.values) {
					paymentVisitLinks = linksResponse.result.values.map(row => ({
						ID: row[0] || '',
						payment_id: row[1] || '',
						visit_id: row[2] || '',
						amount_allocated: parseFloat(row[3]) || 0,
						link_type: row[4] || '',
						created_at: row[5] || ''
					}));
				}
				
				console.log(`✅ נטענו ${payments.length} תשלומים ו-${paymentVisitLinks.length} קישורים`);
				
			} catch (error) {
				console.error('שגיאה בטעינת תשלומים:', error);
			}
		}


		// ===== פונקציות טיפול בתשלומים ===== 

		// פונקציה חדשה לסימון חובות כשולמים
		async function markAllDebtsPaid(locationId) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// מצא כל הביקורים הלא שולמים של הלקוח
			const unpaidVisits = visits.filter(visit => {
				if (visit.location_id !== locationId || !visit.amount || visit.amount <= 0) {
					return false;
				}
				
				const paidAmount = getVisitPaidAmount(visit.ID);
				const debt = parseFloat(visit.amount) - paidAmount;
				return debt > 0;
			});
			
			if (unpaidVisits.length === 0) {
				showToast('אין חובות פתוחים ללקוח זה', 'info');
				return;
			}
			
			const totalDebt = unpaidVisits.reduce((sum, visit) => {
				const paidAmount = getVisitPaidAmount(visit.ID);
				return sum + (parseFloat(visit.amount) - paidAmount);
			}, 0);
			
			if (confirm(`לסמן את כל החובות של ${location.name} כמסולקים?\n\nסה"כ: ₪${totalDebt.toLocaleString()}\nמספר טיפולים: ${unpaidVisits.length}`)) {
				
				try {
					showLoading('יוצר תשלום ומעדכן מערכת...');
					
					// צור תשלום אחד עבור כל החובות
					const payment = {
						ID: generateID(),
						date: new Date().toISOString().split('T')[0],
						time: new Date().toTimeString().substr(0, 5),
						amount: totalDebt,
						payment_method: 'cash',
						source_type: 'debt_settlement',
						client_id: locationId,
						notes: `סילוק חובות - ${unpaidVisits.length} טיפולים`,
						status: 'completed',
						created_at: new Date().toISOString()
					};
					
					// הוסף תשלום למערכת
					payments.push(payment);
					
					// צור קישורים לכל הביקורים
					for (const visit of unpaidVisits) {
						const paidAmount = getVisitPaidAmount(visit.ID);
						const debtAmount = parseFloat(visit.amount) - paidAmount;
						
						if (debtAmount > 0) {
							const link = {
								ID: generateID(),
								payment_id: payment.ID,
								visit_id: visit.ID,
								amount_allocated: debtAmount,
								link_type: 'debt_settlement',
								created_at: new Date().toISOString()
							};
							
							paymentVisitLinks.push(link);
						}
					}
					
					// שמירה מקומית
					saveToLocalStorage();
					
					// שמירה בענן
					if (access_token && SPREADSHEET_ID) {
						await savePaymentToCloud(payment);
						
						// שמור את כל הקישורים
						for (const link of paymentVisitLinks.filter(l => l.payment_id === payment.ID)) {
							await savePaymentVisitLinkToCloud(link);
						}
					}
					
					hideLoading();
					
					// רענון התצוגה
					displayDebts();
					
					showToast(`החובות של ${location.name} סומנו כמסולקים!
		💰 ₪${totalDebt.toLocaleString()} סולקו
		📋 ${unpaidVisits.length} טיפולים עודכנו`, 'success', 5000);
					
				} catch (error) {
					hideLoading();
					console.error('שגיאה בעדכון תשלומים:', error);
					showToast('שגיאה בעדכון התשלומים', 'error');
				}
			}
		}

		// שמירת תשלום לענן
		async function savePaymentToCloud(payment) {
			if (!access_token || !SPREADSHEET_ID) {
				return false;
			}
			
			try {
				await ensureNewTablesExist();
				
				const row = [
					payment.ID,
					payment.date,
					payment.time,
					payment.amount,
					payment.payment_method,
					payment.source_type,
					payment.client_id,
					payment.notes,
					payment.status,
					payment.created_at
				];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Payments!A:J',
					valueInputOption: 'USER_ENTERED',
					resource: { values: [row] }
				});
				
				console.log(`✅ שמר תשלום ${payment.ID} בענן`);
				return true;
				
			} catch (error) {
				console.error('שגיאה בשמירת תשלום:', error);
				return false;
			}
		}

		// שמירת קישור תשלום-ביקור לענן
		async function savePaymentVisitLinkToCloud(link) {
			if (!access_token || !SPREADSHEET_ID) {
				return false;
			}
			
			try {
				const row = [
					link.ID,
					link.payment_id,
					link.visit_id,
					link.amount_allocated,
					link.link_type,
					link.created_at
				];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'PaymentVisitLink!A:F',
					valueInputOption: 'USER_ENTERED',
					resource: { values: [row] }
				});
				
				console.log(`✅ שמר קישור תשלום-ביקור ${link.ID}`);
				return true;
				
			} catch (error) {
				console.error('שגיאה בשמירת קישור:', error);
				return false;
			}
		}

   </script>
</body>
</html>
