<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול טיפולים ולקוחות</title>
	
	<script src="https://apis.google.com/js/api.js"></script>
	<script src="https://accounts.google.com/gsi/client"></script>
	
    <style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			direction: rtl;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}

		/* Header מעוצב */
		.header {
			background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
			border-radius: 15px;
			padding: 30px;
			margin-bottom: 20px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.3);
			color: white;
		}

		.header h1 {
			font-size: 2.5em;
			margin-bottom: 10px;
			text-align: center;
			text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
			background: linear-gradient(45deg, #3498db, #2ecc71);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}

		/* Connection Status מעוצב */
		.connection-status {
			text-align: center;
			margin: 20px 0;
			padding: 20px;
			background: rgba(255,255,255,0.1);
			border-radius: 15px;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255,255,255,0.2);
		}

		.connect-btn {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 12px 24px;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			margin: 5px;
			transition: all 0.3s ease;
			box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
		}

		.connect-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
		}

		.connect-btn:disabled {
			background: #95a5a6;
			cursor: not-allowed;
			transform: none;
		}

		/* Navigation מעוצב */
		.nav-buttons {
			display: flex;
			gap: 15px;
			justify-content: center;
			flex-wrap: wrap;
			margin-top: 20px;
		}

		.nav-btn {
			padding: 15px 25px;
			border: none;
			background: rgba(255,255,255,0.1);
			color: white;
			border-radius: 10px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255,255,255,0.2);
		}

		.nav-btn:hover {
			background: rgba(255,255,255,0.2);
			transform: translateY(-2px);
		}

		.nav-btn.active {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
			transform: translateY(-2px);
		}

		/* Main Content מעוצב */
		.main-content {
			background: rgba(255,255,255,0.95);
			border-radius: 15px;
			padding: 30px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.2);
			backdrop-filter: blur(10px);
		}

		.section {
			display: none;
		}

		.section.active {
			display: block;
		}

		.section h2 {
			color: #2c3e50;
			margin-bottom: 30px;
			padding-bottom: 15px;
			border-bottom: 3px solid #3498db;
			font-size: 1.8em;
			position: relative;
		}

		.section h2::before {
			content: '';
			position: absolute;
			bottom: -3px;
			left: 0;
			width: 60px;
			height: 3px;
			background: linear-gradient(45deg, #e74c3c, #f39c12);
			border-radius: 2px;
		}

		/* Forms מעוצבים */
		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			margin-bottom: 8px;
			color: #2c3e50;
			font-weight: bold;
			font-size: 14px;
		}

		.form-group input, .form-group select, .form-group textarea {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #e9ecef;
			border-radius: 8px;
			font-size: 14px;
			transition: all 0.3s ease;
			background: white;
		}

		.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
			transform: translateY(-1px);
		}

		/* Buttons מעוצבים */
		.add-btn {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
			border: none;
			padding: 15px 30px;
			border-radius: 10px;
			cursor: pointer;
			margin-bottom: 20px;
			font-size: 16px;
			font-weight: bold;
			transition: all 0.3s ease;
			box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
		}

		.add-btn:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
		}

		.action-btn {
			padding: 8px 16px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 12px;
			margin: 0 3px;
			transition: all 0.3s ease;
			font-weight: bold;
		}

		.edit-btn {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
		}

		.edit-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
		}

		.delete-btn {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			color: white;
		}

		.delete-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
		}

		/* Tables מעוצבות */
		.table-container {
			background: white;
			border-radius: 12px;
			overflow: hidden;
			box-shadow: 0 8px 25px rgba(0,0,0,0.15);
			margin-top: 20px;
		}

		.data-table {
			width: 100%;
			border-collapse: collapse;
			background: white;
		}

		.data-table thead {
			background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
			color: white;
		}

		.data-table th {
			padding: 15px 12px;
			text-align: right;
			font-weight: bold;
			border-bottom: 2px solid #3498db;
		}

		.data-table td {
			padding: 12px;
			border-bottom: 1px solid #ecf0f1;
			transition: background 0.3s ease;
		}

		.data-table tbody tr:hover {
			background: #f8f9fa;
			transform: scale(1.01);
		}

		.data-table tbody tr:nth-child(even) {
			background: #fbfcfd;
		}

		/*************************/
		/* Filter Panels מעוצבים */
		
		.filter-panel-unified {
			background: #f8f9fa;
			padding: 15px;
			border-radius: 8px;
			margin-bottom: 20px;
			border: 1px solid #e9ecef;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}

		.filter-panel-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 15px;
			padding-bottom: 10px;
			border-bottom: 1px solid #dee2e6;
		}

		.filter-panel-title {
			font-size: 14px;
			font-weight: bold;
			color: #2c3e50;
			margin: 0;
		}

		.filter-row-unified {
			display: flex;
			gap: 15px;
			align-items: center;
			flex-wrap: wrap;
			margin-bottom: 10px;
		}

		.filter-row-unified:last-child {
			margin-bottom: 0;
		}

		.filter-group-unified {
			flex: 1;
			min-width: 150px;
		}

		.filter-group-unified.compact {
			flex: 0 0 120px;
		}

		.filter-group-unified.small {
			flex: 0 0 100px;
		}

		.filter-group-unified.medium {
			flex: 0 0 140px;
		}

		.filter-group-unified label {
			font-size: 12px;
			font-weight: bold;
			margin-bottom: 5px;
			display: block;
			color: #495057;
		}

		.filter-group-unified input,
		.filter-group-unified select {
			width: 100%;
			padding: 8px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 13px;
			background: white;
			transition: border-color 0.3s ease;
		}

		.filter-group-unified input:focus,
		.filter-group-unified select:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
		}

		.filter-clear-btn {
			background: #e74c3c;
			color: white;
			border: none;
			padding: 8px 12px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 12px;
			font-weight: bold;
			transition: all 0.3s ease;
		}

		.filter-clear-btn:hover {
			background: #c0392b;
			transform: translateY(-1px);
		}

		/* Mobile responsiveness */
		@media (max-width: 768px) {
			.filter-row-unified {
				flex-direction: column;
				gap: 10px;
			}
			
			.filter-group-unified,
			.filter-group-unified.compact,
			.filter-group-unified.small,
			.filter-group-unified.medium {
				flex: none;
				min-width: auto;
				width: 100%;
			}
			
			.filter-panel-header {
				flex-direction: column;
				gap: 10px;
				text-align: center;
			}
		}
		/***********************/

		/* Submit Button מעוצב */
		button[type="submit"] {
			width: 100%;
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 18px;
			border-radius: 10px;
			cursor: pointer;
			font-size: 18px;
			font-weight: bold;
			margin-top: 20px;
			transition: all 0.3s ease;
			box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
		}

		button[type="submit"]:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
		}

		/* Mobile Responsive */
		@media (max-width: 768px) {
			.container {
				padding: 10px;
			}
			
			.header {
				padding: 20px 15px;
			}
			
			.header h1 {
				font-size: 1.8em;
			}
			
			.nav-buttons {
				gap: 8px;
			}
			
			.nav-btn {
				padding: 12px 16px;
				font-size: 12px;
			}
			
			.main-content {
				padding: 20px 15px;
			}
		}

		/* Toast Notifications */
		.toast-container {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 1000;
			max-width: 300px;
		}

		.toast {
			background: linear-gradient(45deg, #2c3e50, #3498db);
			color: white;
			padding: 15px 20px;
			border-radius: 8px;
			margin-bottom: 10px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
			transform: translateX(400px);
			opacity: 0;
			transition: all 0.3s ease;
			border-right: 4px solid #27ae60;
			font-weight: bold;
		}

		.toast.success {
			border-right-color: #27ae60;
			background: linear-gradient(45deg, #27ae60, #2ecc71);
		}

		.toast.error {
			border-right-color: #e74c3c;
			background: linear-gradient(45deg, #e74c3c, #c0392b);
		}

		.toast.warning {
			border-right-color: #f39c12;
			background: linear-gradient(45deg, #f39c12, #e67e22);
		}

		.toast.info {
			border-right-color: #3498db;
			background: linear-gradient(45deg, #3498db, #2980b9);
		}

		.toast.show {
			transform: translateX(0);
			opacity: 1;
		}

		@media (max-width: 768px) {
			.toast-container {
				left: 10px;
				right: 10px;
				top: 10px;
				max-width: none;
			}
			
			.toast {
				transform: translateY(-100px);
			}
			
			.toast.show {
				transform: translateY(0);
			}
		}
		

		/* כפתורים כלליים */
		.btn {
			padding: 12px 20px;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			box-shadow: 0 3px 10px rgba(0,0,0,0.2);
			min-width: 120px;
		}

		.btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(0,0,0,0.3);
		}

		.btn-primary {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
		}

		.btn-success {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
		}

		.btn-warning {
			background: linear-gradient(45deg, #f39c12, #e67e22);
			color: white;
		}

		.btn-secondary {
			background: linear-gradient(45deg, #95a5a6, #7f8c8d);
			color: white;
		}

		.btn-info {
			background: linear-gradient(45deg, #17a2b8, #138496);
			color: white;
		}


		/* רשימות נפתחות */
		select, .form-group select {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			cursor: pointer;
			min-height: 45px;
		}

		select:focus, .form-group select:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		select:hover {
			border-color: #7f8c8d;
			background: white;
		}

		/* שדות תאריך */
		input[type="date"] {
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			min-height: 45px;
		}

		input[type="date"]:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		
		/* כפתורי ייבוא במערכת */
		.form-section .btn {
			margin: 8px 5px;
			padding: 12px 20px;
			font-size: 14px;
			font-weight: bold;
			min-width: 150px;
		}

		/* שיפור נוסף לכפתורים קטנים */
		.action-btn {
			padding: 10px 16px;
			font-size: 13px;
			font-weight: bold;
			min-width: 80px;
		}

		/* כפתורים מוקפצים (disabled) */
		button:disabled, .btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none !important;
			box-shadow: none !important;
		}

		/* שיפור לתיבות טקסט */
		input[type="text"], input[type="number"], textarea {
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			min-height: 45px;
		}

		input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		/* שיפור לכותרות בפאנלים */
		.filter-header h3, .info-header h3 {
			font-size: 16px;
			font-weight: bold;
			margin: 0;
			text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
		}

		/* מובייל - התאמות */
		@media (max-width: 768px) {
			.btn {
				padding: 10px 15px;
				font-size: 13px;
				min-width: 100px;
			}
			
			select, input[type="date"], input[type="text"], input[type="number"] {
				padding: 10px 12px;
				font-size: 13px;
				min-height: 40px;
			}
		}
		
		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
		}

		.stat-item {
			background: rgba(255,255,255,0.7);
			padding: 15px;
			border-radius: 8px;
			border-left: 4px solid #27ae60;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			backdrop-filter: blur(5px);
		}

		.stat-label {
			display: block;
			font-weight: bold;
			color: #495057;
			margin-bottom: 5px;
			font-size: 14px;
		}

		.stat-value {
			font-size: 1.4em;
			font-weight: bold;
			color: #2c3e50;
		}

		@media (max-width: 768px) {
			.stats-grid {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		.debt-card .summary-value {
			color: #e74c3c !important;
			font-weight: bold;
		}

		.debts-table tr:hover {
			background-color: #f8f9fa !important;
		}

		.action-btn {
			margin: 1px;
			padding: 4px 8px;
			font-size: 12px;
			border-radius: 3px;
			border: none;
			color: white;
			cursor: pointer;
		}

		.action-btn:hover {
			opacity: 0.8;
		}

		#statusText {
			transition: all 0.3s ease;
			padding: 8px 12px;
			border-radius: 6px;
			font-size: 14px;
		}

		#statusText.connected {
			background: linear-gradient(45deg, #28a745, #20c997);
			color: white;
			box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
		}


		/* תצוגת תכנון - שורות כפולות */
			.planning-cards-container {
				min-height: 300px;
				border: 2px dashed #ddd;
				border-radius: 10px;
				padding: 15px;
				background: #fafafa;
				margin-bottom: 20px;
			}

			.planning-client-row {
				background: white;
				border-radius: 8px;
				margin-bottom: 12px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
				transition: all 0.3s ease;
			}

			.planning-client-row:hover {
				transform: translateY(-1px);
				box-shadow: 0 4px 8px rgba(0,0,0,0.15);
			}

			/***************************************************************/	
			/* צבעי רמזור */
			/* צבעי סטטוס משופרים לתכנון */
			.planning-status-green { 
				border-right: 4px solid #27ae60;
				background: linear-gradient(90deg, rgba(39, 174, 96, 0.1), white);
			}

			.planning-status-yellow { 
				border-right: 4px solid #f39c12;
				background: linear-gradient(90deg, rgba(243, 156, 18, 0.1), white);
			}

			.planning-status-orange { 
				border-right: 4px solid #e67e22;
				background: linear-gradient(90deg, rgba(230, 126, 34, 0.1), white);
			}

			.planning-status-red { 
				border-right: 4px solid #e74c3c;
				background: linear-gradient(90deg, rgba(231, 76, 60, 0.1), white);
			}

			.planning-status-gray {
				border-right: 4px solid #95a5a6;
				background: linear-gradient(90deg, rgba(149, 165, 166, 0.1), white);
			}

			/* כפתור התחל טיפול מעוצב */
			.planning-complete {
				background: linear-gradient(45deg, #27ae60, #2ecc71);
				color: white;
				font-size: 14px;
				font-weight: bold;
				width: 36px;
				height: 36px;
			}

			.planning-complete:hover {
				background: linear-gradient(45deg, #219a52, #27ae60);
				transform: scale(1.05);
			}

			/* עיצוב משופר לכותרות יום בשבוע */
			.weekly-day-header {
				background: linear-gradient(45deg, #3498db, #2980b9);
				color: white;
				padding: 12px 15px;
				border-radius: 8px;
				margin-bottom: 12px;
				font-size: 15px;
				font-weight: bold;
				text-align: center;
				box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
			}
			
			
			
			
			/****************************************************************/
			.planning-row-main {
				display: flex;
				align-items: center;
				padding: 12px 15px;
				gap: 15px;
			}

			.planning-client-info {
				flex: 1;
				text-align: right;
			}

			.planning-client-name {
				font-weight: bold;
				font-size: 16px;
				color: #333;
				margin-bottom: 3px;
			}

			.planning-client-address {
				font-size: 12px;
				color: #666;
				margin-bottom: 3px;
			}

			.planning-client-date {
				font-size: 12px;
				color: #555;
				font-weight: 500;
			}

			.planning-client-price {
				font-weight: bold;
				color: #2196F3;
				font-size: 16px;
				min-width: 80px;
				text-align: center;
			}

			.planning-client-actions {
				display: flex;
				gap: 8px;
			}

			.planning-action-btn {
				width: 32px;
				height: 32px;
				border: none;
				border-radius: 50%;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 12px;
				transition: all 0.3s ease;
			}

			
			.planning-postpone {
				background: #FF9800;
				color: white;
			}

			.planning-menu {
				background: #607D8B;
				color: white;
			}

			.planning-action-btn:hover {
				transform: scale(1.1);
			}

			.planning-row-details {
				background: #f8f9fa;
				padding: 8px 15px 12px 15px;
				border-top: 1px solid #e9ecef;
				font-size: 13px;
			}

			.client-requests {
				color: #0066cc;
				margin-bottom: 4px;
				font-weight: 500;
			}

			.client-notes {
				color: #666;
				font-style: italic;
			}

			/* מובייל */
			@media (max-width: 768px) {
				.planning-row-main {
					flex-direction: column;
					align-items: stretch;
					gap: 10px;
				}
				
				.planning-client-info {
					text-align: center;
				}
				
				.planning-client-actions {
					justify-content: center;
				}
				
				.planning-action-btn {
					width: 40px;
					height: 40px;
					font-size: 14px;
				}
			}

			/* שאר הסטיילים הקיימים נשארים */
			
			.planning-tab-btn.active {
				background: #3498db; /* שינוי מירוק לכחול */
				color: white;
				border-color: #3498db;
			}

			.planning-view-tabs {
				display: flex;
				justify-content: center;
				gap: 10px;
				margin-bottom: 20px;
			}

			.planning-tab-btn {
				padding: 10px 20px;
				border: 2px solid #ddd;
				background: white;
				border-radius: 25px;
				cursor: pointer;
				transition: all 0.3s ease;
				font-weight: bold;
			}


		/***************************************/
		/* ייבוא נתונים - כפתורים אחידים */
		.import-main-buttons {
			display: flex;
			justify-content: center;
			gap: 15px;
			margin: 15px 0;
			flex-wrap: wrap;
		}

		.import-other-buttons {
			display: flex;
			justify-content: center;
			margin: 15px 0;
		}

		.import-main-buttons button,
		.import-other-buttons button {
			padding: 12px 20px;
			background: #ffc107;
			color: #212529;
			border: 1px solid #ffc107;
			border-radius: 5px;
			font-weight: 500;
			font-size: 14px;
			cursor: pointer;
			transition: all 0.3s ease;
			min-width: 200px;
			white-space: nowrap;
		}

		.import-main-buttons button:hover,
		.import-other-buttons button:hover {
			background: #e0a800;
			border-color: #d39e00;
			transform: translateY(-1px);
			box-shadow: 0 4px 8px rgba(0,0,0,0.15);
		}

		/* כפתורי הייבוא החלקי */
		details[open] > div {
			display: flex !important;
			flex-wrap: wrap;
			gap: 8px;
			margin-top: 10px;
			justify-content: center;
		}

		details[open] > div button {
			flex: 1;
			min-width: 120px;
			max-width: 150px;
			font-size: 13px;
			padding: 10px 12px;
		}

		/* תגובה למובייל */
		@media (max-width: 768px) {
			.import-main-buttons {
				flex-direction: column;
				align-items: center;
			}
			
			.import-main-buttons button,
			.import-other-buttons button {
				min-width: 80%;
				max-width: 300px;
				padding: 15px 20px;
				font-size: 16px;
			}
			
			details[open] > div {
				flex-direction: column;
			}
			
			details[open] > div button {
				min-width: 80%;
				max-width: 250px;
				font-size: 14px;
			}
		}
		/***************************************/

		/* סטיילינג למצב שבועי */
		.weekly-day-section {
			margin-bottom: 25px;
		}

		.planning-empty-state {
			text-align: center;
			color: #666;
			padding: 40px 20px;
		}

		.planning-empty-state h3 {
			margin-bottom: 10px;
			color: #4CAF50;
		}


/***************************************/
/***************************************/

		/* עדכון CSS לכרטיסיות תכנון - מבנה דו-שורתי */
		.planning-row-details {
			background: #f8f9fa;
			padding: 8px 15px 12px 15px;
			border-top: 1px solid #e9ecef;
			font-size: 13px;
		}

		.client-requests {
			color: #0066cc;
			margin-bottom: 4px;
			font-weight: 500;
		}

		.client-notes {
			color: #666;
			font-style: italic;
		}

		.planning-active-toggle {
			margin-right: 5px;
		}

		.planning-history-btn {
			background: #6c757d;
			color: white;
			border: none;
			padding: 6px 10px;
			border-radius: 4px;
			font-size: 11px;
			cursor: pointer;
		}

		.planning-history-btn:hover {
			background: #5a6268;
		}

/***************************************/

		/* תיקון CSS לכפתורי הפעולה החדשים */
		.planning-client-actions {
			display: flex;
			gap: 5px;
			align-items: center;
			flex-wrap: wrap;
		}

		.planning-date-input {
			padding: 4px 6px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 11px;
			width: 100px;
			background: white;
		}

		.planning-active-toggle {
			padding: 4px 6px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 11px;
			background: white;
			width: 70px;
		}

		.planning-history-btn {
			background: #6c757d;
			color: white;
			border: none;
			padding: 6px 8px;
			border-radius: 4px;
			font-size: 11px;
			cursor: pointer;
			min-width: 35px;
		}

		.planning-history-btn:hover {
			background: #5a6268;
		}

		/* תגובה למובייל */
		@media (max-width: 768px) {
			.planning-client-actions {
				justify-content: center;
				gap: 3px;
			}
			
			.planning-date-input,
			.planning-active-toggle {
				font-size: 10px;
				width: auto;
				min-width: 60px;
			}
		}
		
		/* טאבי ימים */
		.days-tabs-container {
			margin-bottom: 20px;
		}

		.days-tabs {
			display: flex;
			gap: 5px;
			margin-bottom: 15px;
			flex-wrap: wrap;
			justify-content: center;
		}

		.day-tab-btn {
			padding: 10px 15px;
			border: 2px solid #ddd;
			background: white;
			border-radius: 20px;
			cursor: pointer;
			font-size: 13px;
			font-weight: bold;
			transition: all 0.3s ease;
			min-width: 100px;
		}

		.day-tab-btn:hover {
			background: #f8f9fa;
			border-color: #3498db;
		}

		.day-tab-btn.active {
			background: #3498db;
			color: white;
			border-color: #3498db;
		}

		.days-content {
			min-height: 200px;
		}

		.day-content {
			display: none;
		}

		.day-content.active {
			display: block;
		}
		
		
		/* תגובה למובייל לטאבי ימים */
		@media (max-width: 768px) {
			.days-tabs {
				flex-direction: column;
				align-items: center;
				gap: 8px;
			}
			
			.day-tab-btn {
				min-width: 80%;
				max-width: 250px;
				padding: 12px 20px;
				font-size: 14px;
			}
			
			.days-content {
				min-height: 150px;
			}
		}

		/* אנימציה חלקה לתוכן הימים */
		.day-content {
			opacity: 0;
			transition: opacity 0.3s ease;
		}

		.day-content.active {
			display: block;
			opacity: 1;
		}

		/* שיפור לכותרת המכיל */
		.days-tabs-container {
			background: rgba(255,255,255,0.7);
			border-radius: 12px;
			padding: 15px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
		}

		.week-btn {
			background: #28a745;
			color: white;
			border: none;
			padding: 4px 6px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 10px;
			margin-left: 2px;
		}

		.week-btn:hover {
			background: #218838;
			transform: scale(1.05);
		}

		.week-btn-double {
			background: #17a2b8;
		}

		.week-btn-double:hover {
			background: #138496;
		}


		/* Notes row styles */
		.notes-row {
			background-color: #f8f9fa;
			border-top: none !important;
		}

		.notes-cell {
			padding: 8px 15px !important;
			border-top: 1px dashed #dee2e6 !important;
		}

		.notes-content {
			font-size: 13px;
			color: #495057;
			font-style: italic;
			background: #e9ecef;
			padding: 8px 12px;
			border-radius: 6px;
			border-left: 4px solid #6c757d;
		}

		/* Button styles */
		.btn {
			padding: 8px 16px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 12px;
			font-weight: bold;
			transition: all 0.3s ease;
		}

		.btn-secondary {
			background: #6c757d;
			color: white;
		}

		.btn-secondary:hover {
			background: #5a6268;
			transform: translateY(-1px);
		}

		/****************************/
		
		/* Payment status indicators */
		.payment-status-1 {
			color: #27ae60;
			font-weight: bold;
			background: #d5f4e6;
			padding: 2px 6px;
			border-radius: 4px;
			font-size: 12px;
		}

		.payment-status-0 {
			color: #e74c3c;
			font-weight: bold;
			background: #fadbd8;
			padding: 2px 6px;
			border-radius: 4px;
			font-size: 12px;
		}

		.payment-status-2 {
			color: #f39c12;
			font-weight: bold;
			background: #fef5e7;
			padding: 2px 6px;
			border-radius: 4px;
			font-size: 12px;
		}

		/* Performance optimization - reduce animations on large tables */
		.data-table tbody tr {
			transition: none; /* הסר אנימציות בטבלאות גדולות */
		}

		.data-table tbody tr:hover {
			background: #f8f9fa;
			transform: none; /* הסר scale effect שגורם לאיטיות */
		}

		/* Loading indicator */
		.loading-indicator {
			text-align: center;
			padding: 20px;
			color: #666;
			font-style: italic;
		}

		.loading-indicator::before {
			content: "⏳ ";
		}

		/* Quick filter buttons */
		.filter-quick-btn {
			background: #3498db;
			color: white;
			border: none;
			padding: 6px 10px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 11px;
			font-weight: bold;
			transition: all 0.3s ease;
			margin-right: 4px;
		}

		.filter-quick-btn:hover {
			background: #2980b9;
			transform: translateY(-1px);
		}

		.filter-quick-btn.active {
			background: #27ae60;
		}

		.filter-quick-btn.active:hover {
			background: #219a52;
		}


		.payment-btn {
			background: #28a745;
			color: white;
			border: none;
			padding: 4px 8px;
			border-radius: 3px;
			cursor: pointer;
			margin-right: 5px;
			font-size: 14px;
		}

		.payment-btn:hover {
			background: #218838;
		}

		/* עיצוב חלונית תשלום */
			
		.visits-list {
			max-height: 250px;
			overflow-y: auto;
			border: 2px solid #ddd;
			border-radius: 8px;
			padding: 0; /* ✅ הסרת padding מהמכיל */
			margin: 10px 0;
			background: #f9f9f9;
		}

		.visit-item {
			display: grid; /* ✅ שינוי מ-flex לגריד */
			grid-template-columns: 40px 1fr 80px; /* ✅ רוחבים קבועים */
			align-items: center;
			padding: 12px;
			border-bottom: 1px solid #eee;
			cursor: pointer;
			transition: background-color 0.2s;
			border-radius: 0; /* ✅ ביטול border-radius פנימי */
			margin-bottom: 0; /* ✅ ביטול margin */
			gap: 10px; /* ✅ רווח קבוע בין העמודות */
		}

		.visit-item:hover {
			background: #f0f0f0;
		}

		.visit-item:last-child {
			border-bottom: none;
		}

		.visit-checkbox {
			width: 18px; /* ✅ רוחב קבוע */
			height: 18px; /* ✅ גובה קבוע */
			margin: 0; /* ✅ ביטול margin */
			cursor: pointer;
			justify-self: center; /* ✅ מרכז בתא הגריד */
		}

		.visit-details {
			line-height: 1.4;
			min-width: 0; /* ✅ מאפשר word-wrap */
		}

		.visit-details div:first-child {
			font-weight: bold;
			color: #2c3e50;
			margin-bottom: 2px;
		}

		.visit-details div:last-child {
			font-size: 12px;
			color: #666;
			white-space: nowrap; /* ✅ מונע שבירת שורה */
			overflow: hidden;
			text-overflow: ellipsis; /* ✅ נקודות אם הטקסט ארוך מדי */
		}

		.visit-amount {
			font-weight: bold;
			color: #27ae60;
			text-align: left;
			font-size: 15px;
			justify-self: start; /* ✅ יישור לשמאל בתא הגריד */
		}

		/* תגובה למובייל */
		@media (max-width: 600px) {
			.visit-item {
				grid-template-columns: 35px 1fr 70px; /* ✅ קצת יותר קטן במובייל */
				padding: 10px;
				gap: 8px;
			}
			
			.visit-checkbox {
				width: 16px;
				height: 16px;
			}
			
			.visit-amount {
				font-size: 14px;
			}
			
			.visit-details div:first-child {
				font-size: 13px;
			}
			
			.visit-details div:last-child {
				font-size: 11px;
			}
		}

		.form-row {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 15px;
			margin-bottom: 15px;
		}

		.form-group {
			display: flex;
			flex-direction: column;
		}

		.form-group label {
			margin-bottom: 5px;
			font-weight: bold;
			color: #333;
		}

		#paymentDetailsSection {
			background: #f8f9fa;
			padding: 15px;
			border-radius: 8px;
			margin-top: 15px;
		}

		.payment-status-select {
			padding: 4px 8px;
			border: 1px solid #ddd;
			border-radius: 3px;
			font-size: 12px;
			background: white;
			cursor: pointer;
			min-width: 100px;
		}

		.payment-status-select:focus {
			outline: none;
			border-color: #007bff;
			box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
		}



		.client-option {
			padding: 10px;
			cursor: pointer;
			border-bottom: 1px solid #eee;
		}

		.client-option:hover {
			background-color: #f8f9fa;
		}

		.client-option:last-child {
			border-bottom: none;
		}

		/* עיצוב שורות פרטים */
		.details-row {
			background-color: #f8f9fa !important;
			border-top: none !important;
		}

		.details-row:hover {
			background-color: #f1f3f4 !important;
		}

		.details-cell {
			padding: 10px 15px !important;
			border-top: 1px dashed #dee2e6 !important;
		}

		.details-content {
			font-size: 13px;
			color: #495057;
			line-height: 1.4;
		}

		.work-done-section {
			background: #e3f2fd;
			padding: 8px 12px;
			border-radius: 6px;
			border-left: 4px solid #2196f3;
			margin-bottom: 8px;
		}

		.notes-section {
			background: #fff3e0;
			padding: 8px 12px;
			border-radius: 6px;
			border-left: 4px solid #ff9800;
			font-style: italic;
		}

		.work-done-section strong,
		.notes-section strong {
			color: #2c3e50;
			font-size: 12px;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		/* שיפור לטבלה הראשית */
		.data-table tbody tr.main-row {
			border-bottom: 1px solid #e9ecef;
		}

		.data-table tbody tr.details-row {
			border-bottom: 2px solid #dee2e6;
		}

		/* אופטימיזציה למובייל */
		@media (max-width: 768px) {
			.details-content {
				font-size: 12px;
			}
			
			.work-done-section,
			.notes-section {
				padding: 6px 8px;
				margin-bottom: 6px;
			}
		}

		/* תיקון z-index לחלונית התשלום */
		#paymentModal {
			position: fixed !important;
			top: 0 !important;
			left: 0 !important;
			width: 100% !important;
			height: 100% !important;
			background: rgba(0,0,0,0.7) !important;
			display: flex !important;
			justify-content: center !important;
			align-items: center !important;
			z-index: 99999 !important; /* גבוה מאוד! */
			backdrop-filter: blur(3px);
		}

		#paymentModal .modal-content {
			background: white !important;
			border-radius: 12px !important;
			max-width: 600px !important;
			width: 90vw !important;
			max-height: 85vh !important;
			overflow-y: auto !important;
			position: relative !important;
			z-index: 100000 !important; /* עוד יותר גבוה! */
			box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important;
		}

		/* וידוא שגם החלוניות האחרות יעבדו */
		#editModal {
			z-index: 99998 !important;
		}

		#telegramModal {
			z-index: 99997 !important;
		}

		/* הסתרת scroll של הגוף כשחלונית פתוחה */
		body.modal-open {
			overflow: hidden;
		}

		/* עיצוב שורות פרטים בטבלת הטיפולים */
		.data-table tbody tr.main-row {
			border-bottom: 1px solid #e9ecef;
		}

		.data-table tbody tr.details-row {
			background-color: #f8f9fa !important;
			border-top: none !important;
			border-bottom: 2px solid #dee2e6;
		}

		.data-table tbody tr.details-row:hover {
			background-color: #f1f3f4 !important;
		}

		.details-cell {
			padding: 10px 15px !important;
			border-top: 1px dashed #dee2e6 !important;
		}

		.details-content {
			font-size: 13px;
			color: #495057;
			line-height: 1.4;
		}

		.work-done-section {
			background: #e3f2fd;
			padding: 8px 12px;
			border-radius: 6px;
			border-left: 4px solid #2196f3;
			margin-bottom: 8px;
		}

		.notes-section {
			background: #fff3e0;
			padding: 8px 12px;
			border-radius: 6px;
			border-left: 4px solid #ff9800;
			font-style: italic;
		}

		.work-done-section strong,
		.notes-section strong {
			color: #2c3e50;
			font-size: 12px;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		/* Badges לסוגי טיפול */
		.visit-type-badge {
			padding: 4px 8px;
			border-radius: 12px;
			font-size: 11px;
			font-weight: bold;
			text-transform: uppercase;
		}

		.visit-type-מלא {
			background: #d4edda;
			color: #155724;
		}

		.visit-type-חלקי {
			background: #fff3cd;
			color: #856404;
		}

		.visit-type-ביקורת {
			background: #d1ecf1;
			color: #0c5460;
		}

		.visit-type-other {
			background: #f8d7da;
			color: #721c24;
		}

		.duration-badge {
			background: #e7f3ff;
			color: #0366d6;
			padding: 2px 6px;
			border-radius: 8px;
			font-size: 11px;
			font-weight: bold;
		}

		/* אופטימיזציה למובייל */
		@media (max-width: 768px) {
			.details-content {
				font-size: 12px;
			}
			
			.work-done-section,
			.notes-section {
				padding: 6px 8px;
				margin-bottom: 6px;
			}
			
			.visit-type-badge,
			.duration-badge {
				font-size: 10px;
				padding: 2px 4px;
			}
		}

		/* תיקון חיוני - החלונית צריכה להיות מוסתרת כברירת מחדל */
		#paymentModal {
			position: fixed !important;
			top: 0 !important;
			left: 0 !important;
			width: 100% !important;
			height: 100% !important;
			background: rgba(0,0,0,0.7) !important;
			display: none !important; /* ✅ שינוי קריטי - none במקום flex! */
			justify-content: center !important;
			align-items: center !important;
			z-index: 99999 !important;
			backdrop-filter: blur(3px);
		}

		/* כשהחלונית פתוחה - אז תהיה flex */
		#paymentModal.show {
			display: flex !important;
		}


		/* שיפורים נוספים לחלונית התשלום */
		.payment-summary {
			background: #e8f5e8;
			border: 2px solid #27ae60;
			border-radius: 8px;
			padding: 15px;
			margin: 15px 0;
			text-align: center;
			font-size: 16px;
			color: #155724;
		}

		.visits-list {
			max-height: 250px;
			overflow-y: auto;
			border: 2px solid #ddd;
			border-radius: 8px;
			padding: 10px;
			margin: 10px 0;
			background: #f9f9f9;
		}

		.visit-item {
			display: flex;
			align-items: center;
			padding: 10px;
			border-bottom: 1px solid #eee;
			cursor: pointer;
			transition: background-color 0.2s;
			border-radius: 6px;
			margin-bottom: 5px;
		}

		.visit-item:hover {
			background: #f0f0f0;
		}

		.visit-item:last-child {
			border-bottom: none;
			margin-bottom: 0;
		}

		.visit-checkbox {
			margin-left: 10px;
			transform: scale(1.3);
			cursor: pointer;
		}

		.visit-details {
			flex: 1;
			margin: 0 15px;
			line-height: 1.4;
		}

		.visit-amount {
			font-weight: bold;
			color: #27ae60;
			min-width: 80px;
			text-align: left;
			font-size: 15px;
		}

		.client-dropdown {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			background: white;
			border: 2px solid #3498db;
			border-top: none;
			max-height: 200px;
			overflow-y: auto;
			z-index: 1000;
			border-radius: 0 0 8px 8px;
			box-shadow: 0 4px 8px rgba(0,0,0,0.1);
		}

		.client-option {
			padding: 12px;
			cursor: pointer;
			border-bottom: 1px solid #eee;
			transition: background-color 0.2s;
		}

		.client-option:hover {
			background: #f8f9fa;
		}

		.client-option:last-child {
			border-bottom: none;
		}

		/* שיפור כפתורים */
		.btn:hover {
			transform: translateY(-1px);
			box-shadow: 0 4px 8px rgba(0,0,0,0.2);
		}

		.btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none !important;
			box-shadow: none !important;
		}

	
		

	</style>
   
</head>
<body>
	<!-- Toast Container -->
	<div id="toastContainer" class="toast-container"></div>
    <div class="container">
        <header class="header">
            <h1>טיפולים</h1>
			<div id="connectionStatus" class="connection-status">
				<button onclick="connectToGoogleSheets()" id="connectBtn" class="connect-btn">
					התחבר ל-Google Sheets
				</button>
				<button onclick="saveAllToSheets()" id="saveBtn" class="connect-btn" disabled>
					שמור לענן
				</button>
				<button onclick="loadAllFromSheets()" id="loadBtn" class="connect-btn" disabled>
					טען מהענן
				</button>
				<span id="statusText" style="color: white; font-weight: bold; font-size: 16px;">לא מחובר</span>
				<div id="lastSaved" style="font-size: 12px; color: white; margin-top: 4px;"></div>
			</div>
           <nav class="nav-buttons">
				<button onclick="showSection('planning')" class="nav-btn active">תכנון</button>
				<button onclick="showSection('history')" class="nav-btn">טיפולים</button> 
				<button onclick="showSection('locations')" class="nav-btn">לקוחות</button>
				<button onclick="showSection('receipts')" class="nav-btn">קבלות</button>
				<button onclick="showSection('debts')" class="nav-btn">💰 חובות</button>
				<button onclick="showSection('payments')" class="nav-btn">💳 תשלומים</button>
				<button onclick="showSection('system')" class="nav-btn">מערכת v3.5</button>
				
				<!-- Client selector - only visible when locked -->
				<button onclick="toggleClientLock()" class="nav-btn lock-btn" id="lockBtn" title="נעילת סינכרון לקוחות">
					🔓
				</button>
				<select id="lockClientSelector" onchange="selectClientForLock(this.value)" style="display: none; padding: 8px; border: 2px solid #28a745; border-radius: 5px; background: #d4edda; color: #155724; font-size: 13px; min-width: 150px;">
					<option value="">בחר לקוח...</option>
				</select>
			</nav>
        </header>

        <main class="main-content">
            <!-- Planning Section -->
			<section id="planning" class="section active">
				<h2>📅 תכנון יומי ושבועי</h2>
				
           <!-- מצב יום עבודה -->
			<div class="work-day-section" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #28a745; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
				<h3 style="margin: 0 0 15px 0; color: #28a745; font-size: 18px; display: flex; align-items: center; gap: 8px;">
					🏃‍♂️ הטיפולים שלי היום
					<span id="todayWorkStatus" style="font-size: 14px; color: #666; font-weight: normal;"></span>
				</h3>
				
				<div id="todayTreatmentsContainer">
					<!-- הטיפולים של היום יוכנסו כאן דינמית -->
				</div>
				
				<div style="text-align: center; margin-top: 15px;">
					<button onclick="refreshTodayTreatments()" class="btn" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
						🔄 רענן
					</button>
				</div>
			</div>
			
            <!-- טאבים -->
            <div class="planning-view-tabs">
				<button class="planning-tab-btn active" onclick="switchPlanningView('daily')">יומי</button>
				<button class="planning-tab-btn" onclick="switchPlanningView('weekly')">שבועי</button>
				<button class="planning-tab-btn" onclick="switchPlanningView('overdue')">מאחרות</button>
				<button class="planning-tab-btn" onclick="switchPlanningView('future')">עתידיים</button>
			</div>

            <!-- כרטיסי לקוחות -->
            <div class="planning-cards-container" id="planningCardsContainer">
                <!-- כרטיסים יטענו כאן דינמית -->
            </div>

            <!-- סטטיסטיקות (שמירה על הקיים) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                <div style="background: rgba(52, 152, 219, 0.1); border: 2px solid #3498db; border-radius: 8px; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 13px; color: #2c3e50;">לקוחות:</span>
                        <span id="totalLocations" style="font-weight: bold; color: #2c3e50;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 13px; color: #2c3e50;">פעילים:</span>
                        <span id="activeLocations" style="font-weight: bold; color: #27ae60;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: #2c3e50;">טיפולים השבוע:</span>
                        <span id="weeklyVisits" style="font-weight: bold; color: #2c3e50;">0</span>
                    </div>
                </div>
                
                <div style="background: rgba(39, 174, 96, 0.1); border: 2px solid #27ae60; border-radius: 8px; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 13px; color: #2c3e50;">הכנסה השבוע:</span>
                        <span id="weeklyIncome" style="font-weight: bold; color: #27ae60;">₪0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: #2c3e50;">חובות פתוחים:</span>
                        <span id="openDebts" style="font-weight: bold; color: #e74c3c;">₪0</span>
                    </div>
                </div>
            </div>
			</section>

			<!-- History Section -->
			<section id="history" class="section">
				<h2>📋 טיפולים</h2>
					<div style="display: flex; gap: 10px; margin-bottom: 20px;">
						<button onclick="showAddTreatmentForm()" class="add-btn">➕ הוסף טיפול חדש</button>
						<button onclick="showAddPaymentModal()" class="add-btn" style="background: linear-gradient(45deg, #f39c12, #e67e22);">💰 תשלום חדש</button>
					</div>
				<!-- Filter Panel -->
				<div class="filter-panel-unified">
					<div class="filter-panel-header">
						<h4 class="filter-panel-title">🔍 סינון טיפולים</h4>
						<div style="display: flex; gap: 8px;">
							<button onclick="setQuickDateFilter('today')" class="filter-quick-btn">היום</button>
							<button onclick="setQuickDateFilter('week')" class="filter-quick-btn">השבוע</button>
							<button onclick="setQuickDateFilter('month')" class="filter-quick-btn active">החודש</button>
							<button onclick="clearVisitFilters()" class="filter-clear-btn">נקה סינון</button>
						</div>
					</div>
					
					<div class="filter-row-unified">
						<div class="filter-group-unified">
							<label>חיפוש חכם:</label>
							<input type="text" id="visitSmartSearch" placeholder="חפש לקוח לפי שם, כתובת, עיר..." 
								   oninput="handleVisitSmartSearch(this.value)">
						</div>
						<div class="filter-group-unified small">
							<button type="button" onclick="clearVisitSmartSearch()" class="filter-clear-btn">נקה חיפוש</button>
						</div>
						<div class="filter-group-unified medium">
							<label>סטטוס תשלום:</label>
							<select id="filterPayment">
								<option value="">הכל</option>
								<option value="כן">שולם</option>
								<option value="לא">לא שולם</option>
								<option value="ללא">ללא תשלום</option>
							</select>
						</div>
						<div class="filter-group-unified small">
							<label>מקסימום תוצאות:</label>
							<select id="maxResults" onchange="applyVisitFilters()">
								<option value="50">50</option>
								<option value="100">100</option>
								<option value="200" selected>200</option>
								<option value="500">500</option>
							</select>
						</div>
					</div>
					
					<div class="filter-row-unified">
						<div class="filter-group-unified compact">
							<label>מתאריך:</label>
							<input type="date" id="filterDateFrom" onchange="applyVisitFilters()">
						</div>
						<div class="filter-group-unified compact">
							<label>עד תאריך:</label>
							<input type="date" id="filterDateTo" onchange="applyVisitFilters()">
						</div>
						<div class="filter-group-unified small">
							<label>הצג לקוחות:</label>
							<select id="filterActiveClients" onchange="applyVisitFilters()">
								<option value="1" selected>פעילים בלבד</option>
								<option value="">כל הלקוחות</option>
								<option value="0">לא פעילים</option>
							</select>
						</div>
					</div>
				</div>

				<!-- Treatments Stats Box -->
				<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
					<div id="treatmentsStatsBox" style="background: #e8f5e8; border: 1px solid #27ae60; border-radius: 6px; padding: 8px 12px; font-size: 13px; color: #2c3e50;">
						<span id="treatmentsCount">0</span> טיפולים מוצגים
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #27ae60; font-weight: bold;" id="treatmentsTotal">₪0</span> סה"כ הכנסות
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #3498db; font-weight: bold;" id="treatmentsPaid">0</span> שולמו
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #e74c3c; font-weight: bold;" id="treatmentsUnpaid">0</span> לא שולמו
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #ff6b35; font-weight: bold;" id="treatmentsDebts">₪0</span> חובות פתוחים
					</div>
				</div>

				<!-- Visits Table -->
				<div class="table-container">
					<table id="visitsHistoryTable" class="data-table">
						<thead>
							<tr>
								<th>תאריך</th>
								<th>לקוח</th>
								<th>סוג טיפול</th>
								<!-- ✅ הסר את <th>עבודה שבוצעה</th> -->
								<th>משך (שעות)</th>
								<th>סכום</th>
								<th>שולם</th>
								<th>פעולות</th>
							</tr>
						</thead>
						<tbody id="visitsHistoryTableBody">
						</tbody>
					</table>
				</div>
			</section>

            <!-- locations Section -->
            <section id="locations" class="section">
                <h2>ניהול לקוחות</h2>
				<!-- פאנל סינון -->
				<div class="filter-panel-compact" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
					<div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
						<div style="flex: 1; min-width: 150px;">
							<label style="font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block;">שם לקוח:</label>
							<input type="text" id="filterClientName" placeholder="חפש לקוח..." onkeyup="filterLocationsTable()" 
								   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
						</div>
						
						<div style="flex: 0 0 120px;">
							<label style="font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block;">יום מועדף:</label>
							<select id="filterDay" onchange="filterLocationsTable()" 
									style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
								<option value="">כל הימים</option>
								<option value="כל יום">כל יום</option>
								<option value="א">א (ראשון)</option>
								<option value="ב">ב (שני)</option>
								<option value="ג">ג (שלישי)</option>
								<option value="ד">ד (רביעי)</option>
								<option value="ה">ה (חמישי)</option>
								<option value="ו">ו (שישי)</option>
								<option value="ש">ש (שבת)</option>
							</select>
						</div>
						
						<div style="flex: 0 0 100px;">
							<label style="font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block;">מרווח שבועות:</label>
							<select id="filterInterval" onchange="filterLocationsTable()" 
									style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
								<option value="">הכל</option>
								<option value="1">1</option>
								<option value="2">2</option>
								<option value="4">4</option>
								<option value="8">8</option>
								<option value="12">12</option>
								<option value="52">52</option>
							</select>
						</div>
						
						<div style="flex: 0 0 100px;">
							<label style="font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block;">סטטוס:</label>
							<select id="filterActive" onchange="filterLocationsTable()" 
									style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
								<option value="">הכל</option>
								<option value="1" selected>פעיל</option>
								<option value="0">לא פעיל</option>
							</select>
						</div>
						
						<div style="flex: 0 0 80px;">
							<button onclick="clearLocationFilters()" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 20px;">
								נקה סינון
							</button>
						</div>
					</div>
				</div>
				<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
					<button onclick="showAddLocationForm()" class="add-btn">הוסף לקוח חדש</button>
					
					<div id="locationsStatsBox" style="background: #e8f4fd; border: 1px solid #3498db; border-radius: 6px; padding: 8px 12px; font-size: 13px; color: #2c3e50;">
						<span id="locationsCount">0</span> לקוחות מוצגים
						<span style="margin-right: 10px; color: #666;">|</span>
						<span style="color: #27ae60; font-weight: bold;" id="activeCount">0</span> פעילים
						<span style="margin-right: 10px; color: #666;">|</span>
						<span style="color: #e74c3c; font-weight: bold;" id="inactiveCount">0</span> לא פעילים
					</div>
				</div>
                <div class="table-container">
                    <table id="locationsTable" class="data-table">
                        <thead>
							<tr>
								<th>שם</th>
								<th>כתובת</th>
								<th>איש קשר</th>
								<th>יום מותר</th>
								<th>מרווח</th>
								<th>פעיל</th>
								<th>טיפול קודם</th>
								<th>טיפול הבא</th>
								<th>הערות</th>
								<th>פעולות</th>
							</tr>
						</thead>
                        <tbody id="locationsTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Receipts Section -->
            <section id="receipts" class="section">
                <h2>ניהול קבלות</h2>
                <button onclick="showAddReceiptForm()" class="add-btn">הוסף קבלה חדשה</button>
				<!-- Filter Panel for Receipts -->
				<!-- Unified Filter Panel for Receipts -->
				<div class="filter-panel-unified">
					<div class="filter-panel-header">
						<h4 class="filter-panel-title">🔍 סינון קבלות</h4>
						<button onclick="clearReceiptFilters()" class="filter-clear-btn">נקה סינון</button>
					</div>
					
					<div class="filter-row-unified">
						<div class="filter-group-unified">
							<label>חיפוש חכם:</label>
							<input type="text" id="receiptSmartSearch" placeholder="חפש לקוח לפי שם, כתובת, עיר..." 
								   oninput="handleReceiptSmartSearch(this.value)">
						</div>
						<div class="filter-group-unified small">
							<button type="button" onclick="clearReceiptSmartSearch()" class="filter-clear-btn">נקה חיפוש</button>
						</div>
					</div>

					<div class="filter-row-unified">
						<div class="filter-group-unified medium">
							<label>פנקס קבלות:</label>
							<select id="filterReceiptBook" onchange="applyReceiptFilters()">
								<option value="">כל הפנקסים</option>
							</select>
						</div>
						<div class="filter-group-unified medium">
							<label>סוג תשלום:</label>
							<select id="filterPaymentType" onchange="applyReceiptFilters()">
								<option value="">כל הסוגים</option>
								<option value="מזומן">מזומן</option>
								<option value="העברה">העברה</option>
								<option value="צ'ק">צ'ק</option>
								<option value="כרטיס אשראי">כרטיס אשראי</option>
							</select>
						</div>
					</div>
					
					<div class="filter-row-unified">
						<div class="filter-group-unified compact">
							<label>מתאריך:</label>
							<input type="date" id="filterReceiptDateFrom" onchange="applyReceiptFilters()">
						</div>
						<div class="filter-group-unified compact">
							<label>עד תאריך:</label>
							<input type="date" id="filterReceiptDateTo" onchange="applyReceiptFilters()">
						</div>
						<div class="filter-group-unified medium">
							<label>מיון:</label>
							<select id="receiptSortBy" onchange="applyReceiptFilters()">
								<option value="date_desc">תאריך (חדש לישן)</option>
								<option value="date_asc">תאריך (ישן לחדש)</option>
								<option value="amount_desc">סכום (גבוה לנמוך)</option>
								<option value="amount_asc">סכום (נמוך לגבוה)</option>
								<option value="book_asc">פנקס (לפי סדר)</option>
							</select>
						</div>
					</div>
				</div>
				<!-- Receipt Stats Box -->
				<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
					<div id="receiptsStatsBox" style="background: #e8f4fd; border: 1px solid #3498db; border-radius: 6px; padding: 8px 12px; font-size: 13px; color: #2c3e50;">
						<span id="receiptsCount">0</span> קבלות מוצגות
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #27ae60; font-weight: bold;" id="receiptsTotal">₪0</span> סה"כ
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #3498db; font-weight: bold;" id="receiptsAverage">₪0</span> ממוצע
					</div>
				</div>
                <div class="table-container">
                    <table id="receiptsTable" class="data-table">
						<thead>
							<tr>
								<th>פנקס</th>
								<th>קבלה</th>
								<th>תאריך</th>
								<th>לקוח</th>
								<th>סכום</th>
								<th>סוג תשלום</th>
								<th>קודX</th>
								<th>פעולות</th>
							</tr>
						</thead>
						<tbody id="receiptsTableBody">
						</tbody>
					</table>
                </div>
            </section>

			<section id="debts" class="section">
				<h2>💰 ניהול חובות</h2>
				
				<!-- רשימת חובות -->
				<div class="filter-panel-unified">
					<div class="filter-panel-header">
						<h4 class="filter-panel-title">🔍 חובות פתוחים</h4>
						<button onclick="clearDebtFilters()" class="filter-clear-btn">נקה סינון</button>
					</div>
					
					<div class="filter-row-unified">
						<div class="filter-group-unified medium">
							<label>מיון לפי:</label>
							<select id="debtSortBy" onchange="displayDebts()">
								<option value="amount_desc">סכום (גבוה לנמוך)</option>
								<option value="amount_asc">סכום (נמוך לגבוה)</option>
								<option value="date_old">תאריך (הכי ישן)</option>
								<option value="date_new">תאריך (הכי חדש)</option>
								<option value="location">לקוח (א-ת)</option>
							</select>
						</div>
						<div class="filter-group-unified compact">
							<label>סכום מינימלי:</label>
							<input type="number" id="minDebtAmount" placeholder="0" onchange="displayDebts()">
						</div>
					</div>
					
					<div class="filter-row-unified">
						<div class="filter-group-unified">
							<label>חיפוש/בחירת לקוח:</label>
							<input type="text" 
								   id="debtClientSearch" 
								   list="debtClientOptions"
								   placeholder="הקלד שם לקוח או בחר מהרשימה..."
								   onchange="handleDebtClientSelection(this.value)"
								   oninput="filterDebtClientOptions(this.value)"
								   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
							<datalist id="debtClientOptions">
								<!-- Options will be populated by JavaScript -->
							</datalist>
							<button type="button" 
									onclick="clearDebtClientSearch()" 
									style="margin-top: 5px; padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer;">
								נקה בחירה
							</button>
						</div>
						
						<div class="filter-group-unified compact">
							<label>יום מועדף:</label>
							<select id="debtDayFilter" onchange="displayDebts()">
								<option value="">כל הימים</option>
								<option value="כל יום">כל יום</option>
								<option value="א">א (ראשון)</option>
								<option value="ב">ב (שני)</option>
								<option value="ג">ג (שלישי)</option>
								<option value="ד">ד (רביעי)</option>
								<option value="ה">ה (חמישי)</option>
								<option value="ו">ו (שישי)</option>
								<option value="ש">ש (שבת)</option>
							</select>
						</div>
					</div>
				</div>
				
				<!-- Debts Stats Box -->
				<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
					<div id="debtsStatsBox" style="background: #fdf2e8; border: 1px solid #f39c12; border-radius: 6px; padding: 8px 12px; font-size: 13px; color: #2c3e50;">
						<span id="debtsCount">0</span> חייבים מוצגים
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #e74c3c; font-weight: bold;" id="debtsTotal">₪0</span> סה"כ חוב
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #f39c12; font-weight: bold;" id="debtsAverage">₪0</span> ממוצע
					</div>
				</div>
				
				<div class="table-container">
					<table id="debtsTable" class="data-table">
						<thead>
							<tr>
								<th>לקוח</th>
								<th>יום מועדף</th>
								<th>סה"כ חוב</th>
								<th>מס' טיפולים</th>
								<th>הערות חוב</th>
								<th>פעולות</th>
							</tr>
						</thead>
						<tbody id="debtsTableBody">
						</tbody>
					</table>
				</div>
			</section>

			<section id="payments" class="section">
				<h2>💳 ניהול תשלומים</h2>
				
				<div class="section-actions" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
					<button onclick="showAddPaymentModal()" class="btn" style="background: #27ae60; color: white; padding: 12px 25px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);">
						➕ הוסף תשלום חדש
					</button>
					<button onclick="showSection('debts')" class="btn" style="background: #e74c3c; color: white; padding: 12px 25px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer;">
						💰 עבור לחובות
					</button>
					<p style="color: #666; font-size: 13px; margin: 0; flex: 1; min-width: 200px;">
						💡 הוסף תשלום חדש או עבור לחובות לניהול
					</p>
				</div>
				
				<!-- פאנל סינון -->
				<!-- שורה 1: חיפוש -->
				<div class="filter-row-unified">
					<div class="filter-group-unified">
						<label>חיפוש חכם:</label>
						<input type="text" 
							   id="paymentSmartSearch" 
							   placeholder="הקלד שם לקוח לחיפוש..."
							   oninput="handlePaymentSmartSearch(this.value)"
							   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
					</div>
					<div class="filter-group-unified small">
						<button type="button" 
								onclick="clearPaymentSmartSearch()" 
								class="filter-clear-btn">
							נקה חיפוש
						</button>
					</div>
				</div>

				<!-- שורה 2: תאריכים -->
				<div class="filter-row-unified">
					<div class="filter-group-unified compact">
						<label>מתאריך:</label>
						<input type="date" id="filterPaymentDateFrom"...>
					</div>
					<div class="filter-group-unified compact">
						<label>עד תאריך:</label>
						<input type="date" id="filterPaymentDateTo"...>
					</div>
				</div>
				
				<!-- סטטיסטיקות -->
				<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
					<div id="paymentsStatsBox" style="background: #e8f5e8; border: 1px solid #27ae60; border-radius: 6px; padding: 8px 12px; font-size: 13px; color: #2c3e50;">
						<span id="paymentsCount">0</span> תשלומים מוצגים
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #27ae60; font-weight: bold;" id="paymentsTotal">₪0</span> סה"כ
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #3498db; font-weight: bold;" id="paymentsAverage">₪0</span> ממוצע
					</div>
				</div>
				
				<!-- טבלת תשלומים -->
				<div class="table-container">
					<table id="paymentsTable" class="data-table">
						<thead>
							<tr>
								<th>תאריך</th>
								<th>לקוח</th>
								<th>סכום</th>
								<th>אמצעי תשלום</th>
								<th>הערות</th>
								<th>פעולות</th>
							</tr>
						</thead>
						<tbody id="paymentsTableBody">
						</tbody>
					</table>
				</div>
			</section>

			<!-- System Section -->
			<section id="system" class="section">
				<h2>🛠️ מערכת</h2>
				
				<!-- Import Section -->
				<div class="form-section">
					<h3>📥 ייבוא נתונים</h3>
					
					<div class="import-main-buttons" style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
						<button onclick="createImportTable()" class="btn">
							📗 צור טבלת עזר לייבוא
						</button>
						<button onclick="importFromHelperTableFast()" class="btn" style="background: #27ae60; color: white;">
							🚀 ייבוא מהיר וכולל
						</button>
					</div>
					
					<div style="text-align: center; margin: 15px 0;">
						<span style="color: #666;">או</span>
					</div>
					
					<div style="text-align: center;">
						<button class="btn btn-warning" onclick="document.getElementById('importFileInput').click()">
							📁 ייבוא מהיר מקובץ
						</button>
						<input type="file" id="importFileInput" accept=".csv,.xlsx" style="display: none;" onchange="handleImportFile(event)">
					</div>
					
					<p style="text-align: center; font-size: 12px; color: #666; margin-top: 15px;">
						ייבוא לקוחות, ביקורים וקבלות מקובץ Excel או Google Sheets
					</p>
				</div>
				
				<!-- ניהול נתונים -->
				<div class="form-section">
					<h3>🗂️ ניהול נתונים</h3>
					
					<div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
						<h4 style="color: #856404; margin-bottom: 10px;">⚠️ ניקוי נתונים</h4>
						<p style="font-size: 14px; color: #856404; margin-bottom: 10px;">
							נקה את כל הנתונים המקומיים לפני ייבוא חדש (לא משפיע על הענן)
						</p>
						
						<button class="btn" onclick="clearAllDataBeforeImport()" 
								style="background: #dc3545; color: white; border: none;">
							🗑️ נקה את כל הנתונים המקומיים
						</button>
					</div>
					
					<!-- סטטוס טבלת עזר -->
					<div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
						<h4 style="color: #495057; margin-bottom: 10px;">📊 טבלת עזר לייבוא</h4>
						<div id="importTableStatus">
							<span style="font-size: 13px; color: #666;">
								בודק סטטוס טבלת עזר...
							</span>
						</div>
					</div>
				</div>
				
				<!-- Additional System Features -->
				<div class="form-section">
					<h3>⚙️ הגדרות מערכת</h3>
					
					<!-- Cost Settings -->
					<div style="background: rgba(39, 174, 96, 0.1); border: 2px solid #27ae60; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
						<h4 style="color: #27ae60; margin-bottom: 10px;">💰 הגדרות עלות טיפול</h4>
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
							<div class="form-group">
								<label for="hourlyRate">שעת עבודה (₪):</label>
								<input type="number" id="hourlyRate" value="150" min="0" onchange="saveCostSettings()">
							</div>
							<div class="form-group">
								<label for="workerCost">תוספת לפועל (₪):</label>
								<input type="number" id="workerCost" value="50" min="0" onchange="saveCostSettings()">
							</div>
						</div>
					</div>
				</div>
			</section>
			
        </main>
    </div>

	<!-- חלונית תשלום -->

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <script>
		// Google Sheets API Configuration
		const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
		const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
		//let SPREADSHEET_ID = prompt('Enter Spreadsheet ID:') || localStorage.getItem('SPREADSHEET_ID') || '';  // Changed to let
		//let CLIENT_ID = prompt('Enter Client ID:') || localStorage.getItem('CLIENT_ID') || '';  // Changed to let
		//let API_KEY = prompt('Enter API Key:') || localStorage.getItem('API_KEY') || '';  // Changed to let
		let SPREADSHEET_ID = '1fSD5dh0bXRzFSeOZUwJ2bPjGRLqs2crGXPkebz6MpWc';
		let  CLIENT_ID = '1040357646874-4sbkrokgjn4dd7a0e9rkrtjt8d9l3vie.apps.googleusercontent.com';
		let  API_KEY = 'AIzaSyB25ms_UzbgfY9FnduMwMhGhlvwfVPaTg8';
		const SPREADSHEET_NAME = 'service_visits_data';

		// Save for next time
		if (SPREADSHEET_ID) localStorage.setItem('SPREADSHEET_ID', SPREADSHEET_ID);
		if (CLIENT_ID) localStorage.setItem('CLIENT_ID', CLIENT_ID);
		if (API_KEY) localStorage.setItem('API_KEY', API_KEY);

		let gapi_loaded = false;
		let google_loaded = false;
		let access_token = null;
		let spreadsheet_id = SPREADSHEET_ID;
        
        // Sheet names
        const SHEETS = {
			LOCATIONS: 'Locations',
			VISITS: 'Visits',
			RECEIPTS: 'Receipts',
			SETTINGS: 'SystemSettings'
		};

        // Global variables
        let locations = [];
        let visits = [];
        let receipts = [];
        let currentFilter = 'today';
		// הגדרות עלות
		let costSettings = {
			hourlyRate: 150,
			workerCost: 50
		};


		// Initialize Google APIs
		function initializeGoogleAPIs() {
			gapi.load('client', initializeGapiClient);
			google.accounts.id.initialize({
				client_id: CLIENT_ID,
				callback: handleCredentialResponse,
			});
		}
		
		async function initializeGapiClient() {
			try {
				await gapi.client.init({
					apiKey: API_KEY,
					discoveryDocs: [DISCOVERY_DOC],
				});
				gapi_loaded = true;
				console.log('GAPI client initialized successfully');
			} catch (error) {
				console.error('Error initializing GAPI client:', error);
				showToast('שגיאה באתחול Google API', 'error');
			}
		}

		function handleCredentialResponse(response) {
			access_token = response.credential;
			showSuccess('התחברת בהצלחה ל-Google!');
		}


		// Add this function if it's missing or not accessible:
		async function connectToGoogleSheets() {
			try {
				console.log('Connecting to Google Sheets...');
				updateCloudStatus('🔗 מתחבר...', 'מתחבר');
				showToast('מתחבר ל-Google Sheets...', 'info');
				
				const tokenClient = google.accounts.oauth2.initTokenClient({
					client_id: CLIENT_ID,
					scope: SCOPES,
					callback: async (response) => {
						access_token = response.access_token;
						
						// עדכון סטטוס
						updateCloudStatus('✅ מחובר ומסונכרן', 'התחבר');
						document.getElementById('statusText').classList.add('connected');
						document.getElementById('saveBtn').disabled = false;
						document.getElementById('loadBtn').disabled = false;
						
						showToast('התחברת בהצלחה ל-Google Sheets!', 'success');
						
						// מציאה או יצירת הטבלה הראשית
						await findOrCreateMainSpreadsheet();

						// ודא שכל הטבלאות החדשות קיימות
						await checkAndFixTableStructure();

						// טעינה אוטומטית של נתונים אם קיימים
						if (SPREADSHEET_ID) {
							try {
								await loadAllFromSheets();
							} catch (error) {
								console.log('Could not auto-load data:', error);
							}
						}
					},
				});
				
				tokenClient.requestAccessToken();
				
			} catch (error) {
				console.error('Error connecting to Google Sheets:', error);
				updateCloudStatus('❌ שגיאה בחיבור', 'שגיאה');
				showToast('שגיאה בחיבור ל-Google Sheets', 'error');
			}
		}


		// Single comprehensive loading function
		async function loadAllFromSheets() {
			// Validate connection first
			if (!await validateToken()) {
				showToast('אין חיבור לגוגל - טוען נתונים מקומיים', 'warning');
				return false;
			}
			
			showLoading('טוען נתונים מ-Google Sheets...');
			
			try {
				// Core data loading (required)
				await loadCoreData();
				
				// Optional data loading (non-critical)
				await loadOptionalData();
				
				// Update all UI components
				updateAllUIComponents();
				
				// Success feedback
				hideLoading();
				showSuccess('נתונים נטענו בהצלחה מהענן!');
				
				// Schedule post-load tasks
				schedulePostLoadTasks();
				
				return true;
				
			} catch (error) {
				return handleLoadingError(error);
			}
		}

		// Helper functions for better organization:
		async function loadCoreData() {
			await loadLocationsFromSheets();
			await loadVisitsFromSheets(); 
			await loadReceiptsFromSheets();
		}

		async function loadOptionalData() {
			const optionalTasks = [
				{ fn: ensureClientNameInPayments, name: 'client name column' },
				{ fn: loadPaymentsFromCloud, name: 'payments' }
			];
			
			for (const task of optionalTasks) {
				try {
					await task.fn();
				} catch (error) {
					console.warn(`Could not load ${task.name}:`, error.message);
				}
			}
		}

		function updateAllUIComponents() {
			const uiUpdaters = [
				loadLocationsForSelect,
				loadLocationsTable,
				loadReceiptsTable,
				loadReceiptFilterOptions,
				loadFilterOptions,
				loadPaymentFilterOptions,
				loadPlanningData
			];
			
			uiUpdaters.forEach(updater => updater());
		}

		function schedulePostLoadTasks() {
			setTimeout(() => {
				if (typeof checkCriticalDebts === 'function') {
					checkCriticalDebts();
				}
			}, 2000);
		}

		function handleLoadingError(error) {
			console.error('Error loading data from sheets:', error);
			hideLoading();
			
			if (error.status === 401) {
				access_token = null;
				showToast('החיבור פג במהלך טעינה', 'warning');
			} else {
				showError('שגיאה בטעינת נתונים מהענן');
			}
			
			return false;
		}


		// תוספה - טעינת מיקומים (גינות)
		async function loadLocationsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:P` // וודא שקוראים עד עמודה P
				});
				
				const rows = response.result.values;
				console.log('🔍 Raw locations data (first row):', rows ? rows[0] : 'No data');
				console.log('🔍 Raw locations data (second row):', rows ? rows[1] : 'No data');
				
				if (rows && rows.length > 1) {
					locations = rows.slice(1).map((row, index) => {
						const location = {
							ID: row[0] || '',
							name: row[1] || '',
							full_address: row[2] || '',
							neighborhood: row[3] || '',
							city: row[4] || '',
							contact_person: row[5] || '',
							phone: row[6] || '',
							allowed_day: row[7] || '',
							interval_weeks: row[8] || '',
							temp_addition: row[9] || 0,
							base_amount: row[10] || '',
							active: row[11] || '',
							notes: row[12] || '',
							last_visit: row[13] || '',
							next_visit: row[14] || '',
							client_requests: row[15] || '' // עמודה P
						};
						
						// לוג רק לשורות עם client_requests
						if (row[15]) {
							console.log(`✅ Row ${index + 1} - ${location.name}: client_requests = "${row[15]}"`);
						}
						
						return location;
					});
				}
				
				console.log('📊 Total locations loaded:', locations.length);
				
			} catch (error) {
				console.error('Error loading locations:', error);
			}
		}

		// תוספה - טעינת ביקורים (טיפולים)
		async function loadVisitsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:N` // ← שנה מ-A:L ל-A:N
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					visits = rows.slice(1).map(row => ({
						ID: row[0] || '',
						date: row[1] || '',
						location_id: row[2] || '',
						location_name: row[3] || '',
						visit_type: row[4] || '',
						work_done: row[5] || '',
						duration_minutes: row[6] || 0,
						num_workers: row[7] || 1,
						start_time: row[8] || '',
						end_time: row[9] || '',
						amount: row[10] || 0,
						expense: row[11] || 0,
						notes: row[12] || ''
					}));
				}
				
			} catch (error) {
				console.error('Error loading visits:', error);
			}
		}

		// תוספה - טעינת קבלות
		async function loadReceiptsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:I`
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					receipts = rows.slice(1).map(row => ({
						ID: row[0] || '',
						book_number: row[1] || '',
						receipt_number: row[2] || '',
						date: row[3] || '',
						location_id: row[4] || '',
						location_name: row[5] || '',
						amount: row[6] || 0,
						payment_type: row[7] || '',
						notes: row[8] || ''
					}));
				}
				
			} catch (error) {
				console.error('Error loading receipts:', error);
			}
		}
	
		// טעינת תשלומים וקישורים מהענן
		async function loadPaymentsFromCloud() {
			if (!access_token || !SPREADSHEET_ID) {
				return;
			}
			
			try {
				// טען תשלומים
				const paymentsResponse = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Payments!A2:I1000'
				});
				
				if (paymentsResponse.result.values) {
					payments = paymentsResponse.result.values.map(row => ({
						ID: row[0] || '',
						date: row[1] || '',
						client_id: row[2] || '',
						client_name: row[3] || '',
						amount: parseFloat(row[4]) || 0,
						payment_method: row[5] || '',
						notes: row[6] || '',
						reference: row[7] || '',
						check_date: row[8] || ''
					}));
				}
				
				// טען קישורים
				const linksResponse = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'PaymentVisitLink!A2:D1000'
				});
				
				if (linksResponse.result.values) {
					paymentVisitLinks = linksResponse.result.values.map(row => ({
						ID: row[0] || '',
						payment_id: row[1] || '',
						visit_id: row[2] || '',
						amount_allocated: parseFloat(row[3]) || 0
					}));
				}
				
				console.log(`✅ נטענו ${payments.length} תשלומים ו-${paymentVisitLinks.length} קישורים`);
				
			} catch (error) {
				console.error('שגיאה בטעינת תשלומים:', error);
			}
		}
	
		// פונקציה לוידוא שיש עמודת client_name בטבלת Payments
		async function ensureClientNameInPayments() {
			if (!access_token || !SPREADSHEET_ID) return;
			
			try {
				// קריאת הכותרות הנוכחיות
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Payments!1:1'
				});
				
				const headers = response.result.values ? response.result.values[0] : [];
				
				// בדיקה אם client_name קיים
				if (!headers.includes('client_name')) {
					console.log('Adding client_name column to Payments sheet...');
					
					// הוספת העמודה החדשה
					const newHeaders = [...headers, 'client_name'];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Payments!A1:${String.fromCharCode(64 + newHeaders.length)}1`,
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [newHeaders]
						}
					});
					
					console.log('✅ client_name column added to Payments sheet');
				}
			} catch (error) {
				console.error('Error ensuring client_name column:', error);
			}
		}


		async function saveAllToSheets() {
			if (!await validateToken()) {
				showToast('אין חיבור לגוגל - שמירה מקומית בלבד', 'warning');
				return;
			}
			
			try {
				updateCloudStatus('שומר נתונים לענן...', 'מעדכן');
				
				// שמירה בבאצ'ים (לא לולאות!)
				const savePromises = [];
				
				if (locations.length > 0) {
					showToast(`שומר ${locations.length} לקוחות בבת אחת...`, 'info', 2000);
					savePromises.push(saveLocationsBatch(locations));
				}
				
				if (visits.length > 0) {
					showToast(`שומר ${visits.length} ביקורים בבת אחת...`, 'info', 2000);
					savePromises.push(saveVisitsBatch(visits));
				}
				
				if (receipts.length > 0) {
					showToast(`שומר ${receipts.length} קבלות בבת אחת...`, 'info', 2000);
					savePromises.push(saveReceiptsBatch(receipts));
				}
				
				// המתן לכל השמירות במקביל
				await Promise.all(savePromises);
				
				updateCloudStatus('מחובר ומסונכרן', 'נשמר');
				showToast(`כל הנתונים נשמרו בענן בהצלחה!`, 'success', 3000);
				
			} catch (error) {
				console.error('Error saving all data to cloud:', error);
				updateCloudStatus('שגיאה בשמירה לענן', 'שגיאה');
				showToast('שגיאה בשמירה לענן - הנתונים נשמרו מקומית', 'error');
			}
		}


		async function saveLocationToSheets(locationData) {
		
			if (!await validateToken()) {
				showToast('החיבור לגוגל פג - שמירה מקומית בלבד', 'warning');
				return;
			}
    
			try {
				const values = [[
					locationData.ID,
					locationData.name,
					locationData.full_address,
					locationData.neighborhood,
					locationData.city,
					locationData.contact_person,
					locationData.phone,
					locationData.allowed_day,
					locationData.interval_weeks,
					locationData.temp_addition,
					locationData.base_amount,
					locationData.active,
					locationData.notes || '',
					locationData.last_visit,
					locationData.next_visit,
					locationData.client_requests || ''
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:P`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving location to sheets:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('⚠️ החיבור פג - התחבר מחדש', 'warning');
					document.getElementById('statusText').textContent = '🔓 נותק';
				} else {
					// שגיאות אחרות (לא קשורות לאסימון)
					showToast('⚠️ שגיאה בשמירה לענן', 'error');
				}
				throw error;

			}
		}


		// שמירת ביקור חדש לשיטס
		async function saveVisitToSheets(visitData) {
			if (!await validateToken()) {
				return;
			}
			
			try {
				const values = [[
					visitData.ID,                       // A: ID
					visitData.date,                     // B: date  
					visitData.location_id,              // C: location_id
					visitData.location_name || '',      // D: location_name
					visitData.visit_type,               // E: visit_type
					visitData.work_done,                // F: work_done
					visitData.duration_minutes,         // G: duration_minutes
					visitData.num_workers || 1,         // H: num_workers (THIS WAS MISSING!)
					visitData.start_time,               // I: start_time
					visitData.end_time,                 // J: end_time
					visitData.amount,                   // K: amount
					visitData.expense || 0,             // L: expense
					visitData.notes                     // M: notes
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:M`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving visit to sheets:', error);
				throw error;
			}
		}

		// תוספה - שמירת קבלה לשיטס
		async function saveReceiptToSheets(receiptData) {
			if (!await validateToken()) {
				return;
			}
			
			try {
				const values = [[
					receiptData.ID,
					receiptData.booklet_number || '',
					receiptData.receipt_number || '',
					receiptData.date,
					receiptData.location_id,
					receiptData.location_name || '',
					receiptData.amount,
					receiptData.payment_type || '',
					receiptData.tax_code || '',
					receiptData.notes || ''
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:J`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving receipt to sheets:', error);
				throw error;
			}
		}

		
		// Local Storage functions
		function saveToLocalStorage() {
			try {
				localStorage.setItem('locations_data', JSON.stringify(locations));
				localStorage.setItem('visits_data', JSON.stringify(visits));
				localStorage.setItem('receipts_data', JSON.stringify(receipts));
				localStorage.setItem('payments_data', JSON.stringify(payments));
				localStorage.setItem('payment_links_data', JSON.stringify(paymentVisitLinks));
				localStorage.setItem('incomes_data', JSON.stringify(incomes));
				
				console.log('Data saved to local storage');
			} catch (error) {
				console.error('Error saving to local storage:', error);
			}
		}

		function loadFromLocalStorage() {
			try {
				const savedLocations = localStorage.getItem('locations_data');
				const savedVisits = localStorage.getItem('visits_data');
				const savedReceipts = localStorage.getItem('receipts_data');
				const savedPayments = localStorage.getItem('payments_data');
				const savedPaymentLinks = localStorage.getItem('payment_links_data');
				const savedIncomes = localStorage.getItem('incomes_data');
				const savedCostSettings = localStorage.getItem('cost_settings');
				
				if (savedLocations) {
					locations = JSON.parse(savedLocations);
				}
				if (savedVisits) {
					visits = JSON.parse(savedVisits);
				}
				if (savedReceipts) {
					receipts = JSON.parse(savedReceipts);
				}
				if (savedPayments) {
					payments = JSON.parse(savedPayments);
				}
				if (savedPaymentLinks) {
					paymentVisitLinks = JSON.parse(savedPaymentLinks);
				}
				if (savedIncomes) {
					incomes = JSON.parse(savedIncomes);
				}
				if (savedCostSettings) {
					costSettings = JSON.parse(savedCostSettings);
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
				}
				
				console.log('Data loaded from local storage');
				
			} catch (error) {
				console.error('Error loading from local storage:', error);
			}
		}


      
        // Navigation
        function showSection(sectionName) {
			// Hide all sections
			document.querySelectorAll('.section').forEach(section => {
				section.classList.remove('active');
			});
			
			// Show selected section
			const targetSection = document.getElementById(sectionName);
			if (!targetSection) {
				console.warn(`Section ${sectionName} not found`);
				return;
			}
			
			targetSection.classList.add('active');
			
			// Update navigation buttons
			document.querySelectorAll('.nav-btn').forEach(btn => {
				btn.classList.remove('active');
			});
			
			// Set active nav button
			const navButtons = document.querySelectorAll('.nav-btn');
			const buttonTexts = {
				'planning': 'תכנון',
				'history': 'טיפולים',
				'locations': 'לקוחות',
				'receipts': 'קבלות',
				'debts': '💰 חובות',
				'payments': '💳 תשלומים',
				'system': 'מערכת v3.0'
			};
			
			navButtons.forEach(btn => {
				if (btn.textContent.includes(buttonTexts[sectionName])) {
					btn.classList.add('active');
				}
			});
			
			// Load section-specific data
			switch(sectionName) {
				case 'planning':
					loadPlanningData();
					break;
				case 'history':
					loadFilterOptions();
					applyVisitFilters();
					break;
				case 'locations':
					loadLocationsTable();
					break;
				case 'receipts':
					loadReceiptFilterOptions(); // Only load filter options, don't reset filters
					// Don't call displayFilteredReceipts(receipts) - keep existing filters
					if (isClientLocked && lockedClientId) {
						// If locked, apply the locked client filter
						const receiptSearch = document.getElementById('receiptSmartSearch');
						if (receiptSearch) {
							receiptSearch.value = lockedClientName;
							handleReceiptSmartSearch(lockedClientName);
						}
					} else {
						// Only apply filters if no smart search is active
						const smartSearch = document.getElementById('receiptSmartSearch');
						if (!smartSearch || !smartSearch.value.trim()) {
							applyReceiptFilters();
						}
					}
					break;
				case 'debts':
					loadDebtClientOptions(); // Load client options first
					if (typeof displayDebts === 'function') {
						displayDebts();
					}
					break;
				case 'payments':
					if (typeof loadPaymentFilterOptions === 'function') {
						loadPaymentFilterOptions();
					}
					if (typeof applyPaymentFilters === 'function') {
						applyPaymentFilters();
					}
					break;
			}
		}

        // Data loading functions
		async function loadAllData() {
			try {
				showLoading('טוען נתונים...');
				loadFromLocalStorage();
				hideLoading();
				loadPlanningData();
			} catch (error) {
				console.error('Error loading data:', error);
				showError('שגיאה בטעינת הנתונים');
			}
		}

        async function loadlocations() {
            // For now, we'll use dummy data until we set up the Google Sheets API
            locations = [
                {
                    ID: 1,
                    name: "גינת דוגמה 1",
                    full_address: "רחוב הדוגמה 1, תל אביב",
                    neighborhood: "מרכז",
                    city: "תל אביב",
                    contact_person: "יוסי כהן",
                    phone: "050-1234567",
                    allowed_day: "א'",
                    interval_weeks: 4,
                    temp_addition: 0,
                    base_amount: 300,
                    active: "כן",
                    notes: "",
                    last_visit: "2024-01-15",
                    next_visit: "2024-02-12"
                },
                {
                    ID: 2,
                    name: "גינת דוגמה 2",
                    full_address: "רחוב הדוגמה 2, תל אביב",
                    neighborhood: "צפון",
                    city: "תל אביב",
                    contact_person: "מרים לוי",
                    phone: "052-7654321",
                    allowed_day: "ג'",
                    interval_weeks: 6,
                    temp_addition: 0,
                    base_amount: 400,
                    active: "כן",
                    notes: "",
                    last_visit: "2024-01-10",
                    next_visit: "2024-02-21"
                }
            ];
        }

        async function loadVisits() {
            visits = []; // Will be loaded from Google Sheets
        }

        async function loadReceipts() {
            receipts = []; // Will be loaded from Google Sheets
        }

        // Display functions
        function loadPlanningData() {
			// Debug - בדיקת נתונים
			debugPlanningData();
			
			// חישוב סטטיסטיקות
			updatePlanningStats();
			
			// סינון רגיל
			filterVisits(currentFilter);
			loadTodayTreatments(); 
		}

	/////<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
	
	// ========== מערכת תכנון משודרגת ==========

		// משתנים גלובליים לתכנון משודרג
		let currentPlanningView = 'daily';
		let planningClients = [];

		// זמני עבודה זמינים (07:00-19:00 בקפיצות של 30 דקות)
		const timeSlots = [];
		for (let hour = 7; hour <= 19; hour++) {
			timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
			if (hour < 19) timeSlots.push(`${hour.toString().padStart(2, '0')}:30`);
		}

		// פונקציה עיקרית לטעינת נתוני תכנון - גרסה משודרגת
		function loadPlanningDataAdvanced() {
			updatePlanningStats();
			loadPlanningClientsAdvanced();
			// updatePlanningDateHeader();
			renderPlanningCards();
		}

		// טעינת לקוחות לתכנון לפי התצוגה הנוכחית - גרסה מתוקנת
		function loadPlanningClientsAdvanced() {
			const today = new Date();
			today.setHours(0, 0, 0, 0);
			
			console.log('🔄 טוען לקוחות לתכנון - תצוגה:', currentPlanningView);
			
			// סינון לקוחות פעילים בלבד
			const activeClients = locations.filter(client => client.active === "1");
			console.log('📊 לקוחות פעילים:', activeClients.length);
			
			// חישוב נתונים לכל לקוח פעיל
			planningClients = activeClients.map(client => {
				const nextVisitDate = new Date(client.next_visit);
				nextVisitDate.setHours(0, 0, 0, 0);
				
				const daysDiff = Math.floor((nextVisitDate - today) / (1000 * 60 * 60 * 24));
				const daysOverdue = daysDiff < 0 ? Math.abs(daysDiff) : 0;
				
				return {
					...client,
					nextVisitDate: nextVisitDate,
					daysDiff: daysDiff,
					daysOverdue: daysOverdue,
					status: calculateClientStatus(daysDiff, daysOverdue)
				};
			});
			
			// סינון לפי תצוגה נוכחית
			planningClients = filterClientsByView(planningClients);
			
			// מיון הלקוחות
			sortPlanningClients();
			
			console.log('✅ לקוחות לתצוגה:', planningClients.length);
		}
	
		// חישוב סטטוס לקוח לפי הפרש ימים
		function calculateClientStatus(daysDiff, daysOverdue) {
			if (daysOverdue > 14) return 'red';        // איחור מעל שבועיים
			if (daysOverdue > 0) return 'orange';      // איחור עד שבועיים  
			if (daysDiff === 0) return 'green';        // היום בדיוק
			if (daysDiff <= 7) return 'yellow';        // השבוע הקרוב
			return 'gray';                             // עתידי רחוק
		}

		// סינון לקוחות לפי התצוגה הנבחרת
		function filterClientsByView(clients) {
			const today = new Date();
			const todayDay = today.getDay(); // 0=ראשון, 1=שני וכו'
			const dayNames = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];
			
			switch (currentPlanningView) {
				case 'daily':
					// רק לקוחות שהיום בדיוק התאריך שלהם (בלי מאחרים)
					return clients.filter(client => client.daysDiff === 0);
					
				case 'weekly':
					// רק תאריכים מדויקים (לא מאחרים) - מהשבוע הקרוב
					return clients.filter(client => 
						client.daysDiff >= 0 && client.daysDiff <= 7
					);
					
				case 'overdue':
					// רק מאחרים
					return clients.filter(client => client.daysOverdue > 0);
					
				case 'future':
					// רק לקוחות עם טיפול בעוד יותר משבוע
					return clients.filter(client => client.daysDiff > 7);
					
				default:
					return clients;
			}
		}
	
		// מיון לקוחות לפי התצוגה הנוכחית
		function sortPlanningClients() {
			planningClients.sort((a, b) => {
				// הגדרת dayOrder פעם אחת בתחילת הפונקציה
				const dayOrder = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];
				
				switch (currentPlanningView) {
					case 'daily':
						// מיון לפי שעה מועדפת אם קיימת, אחרת לפי שם
						return (a.name || '').localeCompare(b.name || '');
						
					case 'weekly':
						// מיון לפי יום בשבוע, ואז לפי תאריך
						const aDay = dayOrder.indexOf(a.allowed_day || 'א');
						const bDay = dayOrder.indexOf(b.allowed_day || 'א');
						if (aDay !== bDay) return aDay - bDay;
						return a.daysDiff - b.daysDiff;
						
					case 'overdue':
						// מיון לפי חומרת האיחור (הכי מאחר ראשון)
						return b.daysOverdue - a.daysOverdue;
						
					case 'future':
						// מיון לפי יום בשבוע, ואז לפי תאריך (כמו שבועי)
						const aDayFuture = dayOrder.indexOf(a.allowed_day || 'א');
						const bDayFuture = dayOrder.indexOf(b.allowed_day || 'א');
						if (aDayFuture !== bDayFuture) return aDayFuture - bDayFuture;
						// בתוך אותו יום - לפי תאריך ואז לפי שם
						if (a.daysDiff !== b.daysDiff) return a.daysDiff - b.daysDiff;
						return (a.name || '').localeCompare(b.name || '');   
						
					default:
						return 0;
				}
			});
		}
	
		// החלפת תצוגת תכנון עם לוגיקה מעודכנת
		function switchPlanningView(view) {
			// Update tab buttons
			document.querySelectorAll('.planning-tab-btn').forEach(btn => {
				btn.classList.remove('active');
			});
			
			// Set active button
			const buttonTexts = {
				'daily': 'יומי',
				'weekly': 'שבועי', 
				'overdue': 'מאחרות',
				'future': 'עתידיים'
			};
			
			document.querySelectorAll('.planning-tab-btn').forEach(btn => {
				if (btn.textContent === buttonTexts[view]) {
					btn.classList.add('active');
				}
			});
			
			currentPlanningView = view;
			loadPlanningClientsAdvanced();  // Changed from loadPlanningClients(view)
			renderPlanningCards();  // Also need to render the cards after loading
		}

		
		// רינדור כרטיסי לקוחות לתכנון
		function renderPlanningCards() {
			const container = document.getElementById('planningCardsContainer');
			
			if (!container) {
				console.log('⚠️ לא נמצא container לכרטיסי התכנון');
				return;
			}
			
			if (planningClients.length === 0) {
				let emptyMessage = '';
				switch (currentPlanningView) {
					case 'daily':
						emptyMessage = '<h3>😊 אין לקוחות מתוכננים להיום</h3><p>כל הטיפולים מעודכנים!</p>';
						break;
					case 'weekly':
						emptyMessage = '<h3>📅 אין לקוחות מתוכננים השבוע</h3><p>תכנון נקי לשבוע הקרוב!</p>';
						break;
					case 'overdue':
						emptyMessage = '<h3>✅ אין לקוחות מאחרים</h3><p>כל הטיפולים במועדם!</p>';
						break;
					case 'future':
						emptyMessage = '<h3>🔮 אין טיפולים עתידיים</h3><p>כל הטיפולים מתוכננים לשבוע הקרוב!</p>';
						break;	
				}
				
				container.innerHTML = `
					<div class="planning-empty-state">
						${emptyMessage}
					</div>
				`;
				return;
			}

			// במצב שבועי - חלוקה לפי ימים
			if (currentPlanningView === 'weekly' || currentPlanningView === 'overdue' || currentPlanningView === 'future') {
				renderWeeklyPlanningByDays();
			} else {
				// במצב יומי או מאחרות - רשימה רגילה
				renderRegularPlanningList();
			}
			
			setTimeout(setTodayAsDefault, 100);
		}


		// רינדור למצב שבועי ומאחרות עם טאבי ימים
		function renderWeeklyPlanningByDays() {
			const container = document.getElementById('planningCardsContainer');
			const dayNames = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];
			
			// יצירת מערך עם נתוני ימים
			const daysData = dayNames.map(dayName => {
				const dayClients = planningClients.filter(client => 
					(client.allowed_day || 'א') === dayName
				);
				// מיון לקוחות היום
				dayClients.sort((a, b) => {
					if (currentPlanningView === 'overdue') {
						return b.daysOverdue - a.daysOverdue; // מאחרים - לפי דחיפות
					} else {
						return a.daysDiff - b.daysDiff; // שבועי - לפי תאריך
					}
				});
				
				return { dayName, clients: dayClients };
			});
			
			// רק ימים עם לקוחות
			const activeDays = daysData.filter(day => day.clients.length > 0);
			
			if (activeDays.length === 0) {
				container.innerHTML = '<div class="planning-empty-state"><h3>אין לקוחות להציג</h3></div>';
				return;
			}
			
			// יצירת HTML עם טאבים
			let html = `
				<div class="days-tabs-container">
					<div class="days-tabs">
						${activeDays.map((day, index) => 
							`<button class="day-tab-btn ${index === 0 ? 'active' : ''}" 
									 onclick="switchDayTab('${day.dayName}')" 
									 data-day="${day.dayName}">
								${day.dayName} (${day.clients.length})
							</button>`
						).join('')}
					</div>
					<div class="days-content">
						${activeDays.map((day, index) => 
							`<div class="day-content ${index === 0 ? 'active' : ''}" data-day="${day.dayName}">
								${day.clients.map(client => renderClientRow(client)).join('')}
							</div>`
						).join('')}
					</div>
				</div>
			`;
			
			container.innerHTML = html;
		}

		// רינדור רגיל (יומי/מאחרות)
		function renderRegularPlanningList() {
			const container = document.getElementById('planningCardsContainer');
			container.innerHTML = planningClients.map(client => renderClientRow(client)).join('');
			setTimeout(setTodayAsDefault, 100);
		}

		// רינדור שורת לקוח (משותף לשני המצבים)
		// Update the renderClientRow function to show last treatment date
		function renderClientRow(client) {
			const nextVisitFormatted = formatDate(client.next_visit);
			
			// Find last treatment date for this client
			const clientVisits = visits.filter(visit => visit.location_id === client.ID);
			const lastTreatmentDate = clientVisits.length > 0 
				? clientVisits.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date
				: '';
			
			let statusText = '';
			
			// טקסט סטטוס לפי תצוגה
			switch (currentPlanningView) {
				case 'daily':
					statusText = 'מתוכנן להיום';
					break;
				case 'weekly':
					statusText = client.daysDiff === 0 ? 'היום' : 
								client.daysDiff === 1 ? 'מחר' : 
								`בעוד ${client.daysDiff} ימים`;
					break;
				case 'overdue':
					statusText = client.daysOverdue === 1 ? 'איחור יום אחד' : `איחור ${client.daysOverdue} ימים`;
					break;
				case 'future':
					statusText = `בעוד ${client.daysDiff} ימים`;
					break;	
			}
			
			return `
				<div class="planning-client-row planning-status-${client.status}" data-client-id="${client.ID}">
					<div class="planning-row-main">
						<div class="planning-client-info">
							<div class="planning-client-name">${client.name}</div>
							<div class="planning-client-address">${client.full_address}</div>
							<div class="planning-client-date">
								📅 הבא: ${nextVisitFormatted} (${statusText})
								${lastTreatmentDate ? `<br><small style="color: #666;">📋 אחרון: ${formatDate(lastTreatmentDate)}</small>` : '<br><small style="color: #999;">📋 ללא טיפולים קודמים</small>'}
							</div>
						</div>
						<div class="planning-client-price">₪${client.base_amount || 0}</div>
						<div class="planning-client-actions">
							<button class="planning-action-btn planning-complete" title="התחל טיפול" onclick="startTreatment('${client.ID}')">
								▶
							</button>
							<input type="date" class="planning-date-input" value="" onchange="updateClientNextVisit('${client.ID}', this.value)" title="תאריך טיפול הבא" id="dateInput_${client.ID}">
							<button class="week-btn" onclick="setNextAllowedDay('${client.ID}', '${client.allowed_day}', 1)" title="שבוע קרוב">
								+1W
							</button>
							<button class="week-btn week-btn-double" onclick="setNextAllowedDay('${client.ID}', '${client.allowed_day}', 2)" title="שבועיים">
								+2W
							</button>
							<select class="planning-active-toggle" onchange="toggleClientActive('${client.ID}', this.value)" title="סטטוס לקוח">
								<option value="1" selected>פעיל</option>
								<option value="0">לא פעיל</option>
							</select>
							<button class="planning-history-btn" onclick="showClientProfile('${client.ID}')" title="פרופיל לקוח מלא">👤</button>
						</div>
					</div>
					${(client.notes || client.client_requests) ? `
						<div class="planning-row-details">
							${client.client_requests ? `<div class="client-requests">🔔 בקשות: ${client.client_requests}</div>` : ''}
							${client.notes ? `<div class="client-notes">💭 הערות: ${client.notes}</div>` : ''}
						</div>
					` : ''}
				</div>
			`;
		}
	
		// החלפת טאב יום
		function switchDayTab(dayName) {
			// הסרת active מכל הכפתורים
			document.querySelectorAll('.day-tab-btn').forEach(btn => btn.classList.remove('active'));
			document.querySelectorAll('.day-content').forEach(content => content.classList.remove('active'));
			
			// הוספת active לכפתור ותוכן הנוכחיים
			const activeBtn = document.querySelector(`[data-day="${dayName}"]`);
			const activeContent = document.querySelector(`.day-content[data-day="${dayName}"]`);
			
			if (activeBtn) activeBtn.classList.add('active');
			if (activeContent) activeContent.classList.add('active');
		}
	
		
		// עדכון פונקציית החלפת סטטוס פעיל/לא פעיל
		function toggleClientActive(clientId, newStatus) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			const oldStatus = client.active;
			client.active = newStatus;
			
			// שמירה מקומית
			saveToLocalStorage();
			
			// שמירה בענן אם מחובר
			if (access_token && SPREADSHEET_ID) {
				updateLocationInCloud(client);
			}
			
			const statusText = newStatus === "1" ? "פעיל" : "לא פעיל";
			showToast(`${client.name} הוגדר כ${statusText}`, 'info');
			
			// רענון התצוגה רק אם הלקוח הפך ללא פעיל
			if (newStatus === "0") {
				loadPlanningDataAdvanced();
			}
		}
	
		// עדכון שעה מתוכננת ללקוח
		function updateClientScheduledTime(clientId, newTime) {
			const client = locations.find(loc => loc.ID === clientId);
			if (client) {
				client.scheduled_time = newTime;
				saveToLocalStorage();
				
				// שמירה בענן אם מחובר
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`שעת טיפול עודכנה ל-${newTime}`, 'success', 2000);
			}
		}

		// סיום טיפול (מעבר לטופס הוספת ביקור)
		function completePlanningVisit(clientId) {
			showSection('visit');
			document.getElementById('locationSelect').value = clientId;
			document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
			
			const client = locations.find(loc => loc.ID === clientId);
			if (client && client.scheduled_time) {
				const timeInput = document.getElementById('visitTime');
				if (timeInput) timeInput.value = client.scheduled_time;
			}
		}

		// דחיית טיפול
		function postponePlanningVisit(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			const weeks = prompt(`כמה שבועות לדחות את הטיפול עבור ${client.name}?`, '1');
			if (weeks && !isNaN(weeks) && parseInt(weeks) > 0) {
				const currentNextVisit = new Date(client.next_visit);
				const postponedDate = new Date(currentNextVisit.getTime() + (parseInt(weeks) * 7 * 24 * 60 * 60 * 1000));
				
				client.next_visit = postponedDate.toISOString().split('T')[0];
				client.temp_addition = 0;
				
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`טיפול נדחה ל-${formatDate(client.next_visit)}`, 'success');
				loadPlanningDataAdvanced();
			}
		}

		// תפריט פעולות נוספות ללקוח
		function showPlanningClientMenu(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			const actions = [
				'צפייה בהיסטוריית טיפולים',
				'התחלת טיפול מיידי',
				'קביעת תאריך ספציפי',
				'עריכת פרטי לקוח',
				'ביטול'
			];
			
			const choice = prompt(`בחר פעולה עבור ${client.name}:\n\n` + 
				actions.map((action, i) => `${i + 1}. ${action}`).join('\n'));
			
			switch (choice) {
				case '1':
					showClientTreatmentHistory(clientId);
					break;
				case '2':
					startImmediateVisit(clientId);
					break;
				case '3':
					setSpecificVisitDate(clientId);
					break;
				case '4':
					editLocation(clientId);
					break;
			}
		}

		// צפייה בהיסטוריית טיפולים
		function showClientTreatmentHistory(clientId) {
			// Use the existing working showClientHistory function instead of alert
			showClientHistory(clientId);
		}

		// התחלת טיפול מיידי
		function startImmediateVisit(clientId) {
			showSection('visit');
			document.getElementById('locationSelect').value = clientId;
			document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
			document.getElementById('visitTime').value = new Date().toTimeString().slice(0,5);
		}

		// קביעת תאריך ספציפי לטיפול
		function setSpecificVisitDate(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			const newDate = prompt(`הזן תאריך חדש לטיפול הבא עבור ${client.name}:`, client.next_visit);
			
			if (newDate && !isNaN(new Date(newDate))) {
				client.next_visit = newDate;
				client.temp_addition = 0;
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`תאריך הטיפול הבא עבור ${client.name} עודכן ל-${formatDate(newDate)}`, 'success');
				loadPlanningDataAdvanced();
			}
		}
	
	
	// הוספת אירועי גרירה לכרטיסים (רק בתצוגה יומית)
		let draggedPlanningCard = null;

		function addPlanningDragEvents() {
			const cards = document.querySelectorAll('.planning-client-card');
			
			cards.forEach(card => {
				card.addEventListener('dragstart', handlePlanningDragStart);
				card.addEventListener('dragend', handlePlanningDragEnd);
				card.addEventListener('dragover', handlePlanningDragOver);
				card.addEventListener('drop', handlePlanningDrop);
			});
		}

		function handlePlanningDragStart(e) {
			draggedPlanningCard = this;
			this.classList.add('planning-dragging');
			e.dataTransfer.effectAllowed = 'move';
		}

		function handlePlanningDragEnd(e) {
			this.classList.remove('planning-dragging');
			document.querySelectorAll('.planning-client-card').forEach(card => {
				card.classList.remove('planning-drag-over');
			});
		}

		function handlePlanningDragOver(e) {
			if (e.preventDefault) e.preventDefault();
			this.classList.add('planning-drag-over');
			e.dataTransfer.dropEffect = 'move';
			return false;
		}

		function handlePlanningDrop(e) {
			if (e.stopPropagation) e.stopPropagation();
			
			if (draggedPlanningCard !== this) {
				const draggedIndex = parseInt(draggedPlanningCard.dataset.index);
				const droppedIndex = parseInt(this.dataset.index);
				
				// החלפת מקומות במערך
				const temp = planningClients[draggedIndex];
				planningClients[draggedIndex] = planningClients[droppedIndex];
				planningClients[droppedIndex] = temp;
				
				// רינדור מחדש
				renderPlanningCards();
				
				showToast('סדר הלקוחות שונה', 'info');
			}
			
			this.classList.remove('planning-drag-over');
			return false;
		}

		// שמירת הפונקציה המקורית לפני ההחלפה
		window.originalLoadPlanningData = window.loadPlanningData;

		// החלפת הפונקציה loadPlanningData
		window.loadPlanningData = function() {
			console.log('🔄 loadPlanningData נקראה');
			
			// בדיקה אם יש את האלמנטים החדשים
			if (document.getElementById('planningCardsContainer')) {
				console.log('📊 משתמש במערכת חדשה');
				loadPlanningDataAdvanced();
			} else {
				console.log('📊 משתמש במערכת ישנה');
				updatePlanningStats();
				filterVisits(window.currentFilter || 'today');
			}
		};

		// עדכון הפונקציה refreshPlanningAfterTreatmentUpdate לעבוד עם שתי המערכות
		// Make sure this function exists and gets called after dates update
		
		function refreshPlanningAfterTreatmentUpdate() {
			// רענן את נתוני התכנון אם הטאב פתוח
			const currentSection = document.querySelector('.section.active');
			if (currentSection && currentSection.id === 'planning') {
				loadPlanningData();
			}
			
			// רענן גם את רשימת הלקוחות בטופס הביקור
			loadLocationsForSelect();
			
			// ✅ הוסף: רענן את טבלת הטיפולים אם פתוחה
			const historySection = document.getElementById('history');
			if (historySection && historySection.classList.contains('active')) {
				applyVisitFilters();
			}
			
			// רענן את הטיפולים של היום
			loadTodayTreatments();
		}
	
	/////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>


		// תוספה - עדכון סטטיסטיקות
		function updatePlanningStats() {
			// לקוחות
			const totalLocations = locations.length;
			const activeLocations = locations.filter(loc => loc.active === 'כן').length;
			
			// טיפולים השבוע
			const today = new Date();
			const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
			const weeklyVisits = visits.filter(visit => {
				const visitDate = new Date(visit.date);
				return visitDate >= weekAgo && visitDate <= today;
			});
			
			// הכנסה השבוע
			const weeklyIncome = weeklyVisits.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			// חובות פתוחים
			const openDebts = visits
				.filter(visit => visit.paid === '0')
				.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			// עדכון התצוגה
			document.getElementById('totalLocations').textContent = totalLocations;
			document.getElementById('activeLocations').textContent = `${activeLocations} (${totalLocations > 0 ? Math.round((activeLocations / totalLocations) * 100) : 0}%)`;
			document.getElementById('weeklyVisits').textContent = weeklyVisits.length;
			document.getElementById('weeklyIncome').textContent = `₪${weeklyIncome.toLocaleString()}`;
			document.getElementById('openDebts').textContent = `₪${openDebts.toLocaleString()}`;
		}

        function filterVisits(filter) {
			currentFilter = filter;
			
			// Update filter buttons
			document.querySelectorAll('.filter-btn').forEach(btn => {
				btn.classList.remove('active');
				if ((filter === 'today' && btn.textContent === 'היום') ||
					(filter === 'week' && btn.textContent === 'השבוע') ||
					(filter === 'overdue' && btn.textContent === 'מאוחרות')) {
					btn.classList.add('active');
				}
			});
			
			// Filter locations based on next_visit date
			const today = new Date();
			today.setHours(0, 0, 0, 0); // תחילת היום
			const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
			
			let filteredlocations = locations.filter(location => {
				return location.active === "1" && location.next_visit && location.next_visit.trim() !== '';
			});
			
			switch(filter) {
				case 'today':
					// לקוחות שהתאריך הבא שלהם הוא היום או עבר (צריכים טיפול)
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						nextVisit.setHours(0, 0, 0, 0); // תחילת היום
						return nextVisit <= today;
					});
					break;
				case 'week':
					// לקוחות שהתאריך הבא שלהם הוא השבוע הקרוב או עבר
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						return nextVisit <= weekFromNow;
					});
					break;
				case 'overdue':
					// לקוחות שהתאריך הבא שלהם עבר (מאוחרים)
					const yesterday = new Date(today);
					yesterday.setDate(yesterday.getDate() - 1);
					
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						return nextVisit <= yesterday;
					});
					break;
			}
			
			displayPlanningTable(filteredlocations);
			updateTreatmentsStats(filteredVisits);
		}

        function displayPlanningTable(locationsToShow) {
            const tbody = document.getElementById('planningTableBody');
            tbody.innerHTML = '';
            
            if (locationsToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">אין גינות לטיפול</td></tr>';
                return;
            }
            
            locationsToShow.forEach(location => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${location.name}</td>
                    <td>${location.full_address}</td>
                    <td>${location.allowed_day}</td>
                    <td>${formatDate(location.next_visit)}</td>
                    <td>
                        <button class="action-btn start-visit-btn" onclick="startVisitForlocation(${location.ID})">
                            התחל טיפול
                        </button>
                        <button class="action-btn edit-btn" onclick="postponeVisit(${location.ID})">
                            דחה
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

       function calculateDurationFromTimes() {
			const startTime = document.getElementById('visitTime').value;
			const endTime = document.getElementById('endTime').value;
			
			if (!startTime || !endTime) return;
			
			const start = new Date(`2000-01-01T${startTime}`);
			const end = new Date(`2000-01-01T${endTime}`);
			
			if (end <= start) {
				showToast('שעת סיום חייבת להיות אחרי שעת התחלה', 'warning');
				return;
			}
			
			const diffMs = end - start;
			const totalMinutes = Math.round(diffMs / (1000 * 60));
			const hours = Math.floor(totalMinutes / 60);
			const minutes = totalMinutes % 60;
			const decimalHours = (totalMinutes / 60).toFixed(1);
			
			// בדיקה שהאלמנטים קיימים לפני עדכון
			const durationHoursEl = document.getElementById('durationHours');
			const durationMinutesEl = document.getElementById('durationMinutes');
			const manualDurationEl = document.getElementById('manualDurationMinutes');
			const calculatedHoursEl = document.getElementById('calculatedHours');
			
			if (durationHoursEl) durationHoursEl.value = hours;
			if (durationMinutesEl) durationMinutesEl.value = minutes;
			if (manualDurationEl) manualDurationEl.value = totalMinutes;
			if (calculatedHoursEl) calculatedHoursEl.value = decimalHours;
			
			// עדכון המחיר אוטומטית
			if (typeof calculateTreatmentCost === 'function') {
				calculateTreatmentCost();
			}
		}


	   function loadLocationsTable() {
			const filteredData = getFilteredLocations();
			
			const tbody = document.getElementById('locationsTableBody');
			tbody.innerHTML = '';
			
			if (filteredData.length === 0) {
				tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px; color: #666;">אין לקוחות תואמים לסינון</td></tr>';
				updateLocationsStats(filteredData);
				return;
			}
			
			filteredData.forEach(location => {
				const row = document.createElement('tr');
				
				// Find last treatment date for this client
				const clientVisits = visits.filter(visit => String(visit.location_id) === String(location.ID));
				const lastTreatmentDate = clientVisits.length > 0 
					? clientVisits.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date
					: '';
				
				row.innerHTML = `
					<td>
						<strong>${location.name}</strong>
						${location.contact_person ? `<br><small style="color: #666;">${location.contact_person}</small>` : ''}
					</td>
					<td>${location.full_address}</td>
					<td>${location.contact_person || ''}</td>
					<td>${location.allowed_day}</td>
					<td style="text-align: center;">
						<span class="interval-badge">${location.interval_weeks || 4} שבועות</span>
					</td>
					<td style="text-align: center;">
						<input type="checkbox" 
							   ${location.active === '1' ? 'checked' : ''} 
							   onchange="toggleLocationStatus('${location.ID}', this.checked ? '1' : '0')"
							   style="transform: scale(1.2); cursor: pointer;">
					</td>
					<td style="text-align: center; font-size: 12px; color: ${lastTreatmentDate ? '#2c3e50' : '#999'};">
						${lastTreatmentDate ? formatDate(lastTreatmentDate) : '-'}
					</td>
					<td style="text-align: center; font-size: 12px; color: ${location.next_visit ? '#e74c3c' : '#999'};">
						${location.next_visit ? formatDate(location.next_visit) : '-'}
					</td>
					<td>
						<input type="text" 
							   value="${location.notes || ''}" 
							   placeholder="הערות..."
							   style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"
							   onchange="updateLocationNotes('${location.ID}', this.value)">
					</td>
					<td>
						<button class="action-btn profile-btn" onclick="showClientProfile('${location.ID}')" title="פרופיל לקוח מלא" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">👤 פרופיל</button>
						<button class="action-btn edit-btn" onclick="editLocation('${location.ID}')">עריכה</button>
						<button class="action-btn delete-btn" onclick="deleteLocation('${location.ID}')">מחיקה</button>
					</td>
				`;
				tbody.appendChild(row);
			});
			
			updateLocationsStats(filteredData);
		}

		// עדכון סטטיסטיקות הלקוחות
		function updateLocationsStats(filteredData) {
			const activeClients = filteredData.filter(loc => loc.active === "1").length;
			const inactiveClients = filteredData.filter(loc => loc.active === "0").length;
			
			document.getElementById('locationsCount').textContent = filteredData.length;
			document.getElementById('activeCount').textContent = activeClients;
			document.getElementById('inactiveCount').textContent = inactiveClients;
		}

        function loadReceiptsTable() {
			// טען אפשרויות סינון
			loadReceiptFilterOptions();
			
			// אל תציג את כל הקבלות אוטומטית - שמור על הסינון הקיים
			// displayFilteredReceipts(receipts); // <- מחק את השורה הזו
			
			// במקום זה, בדוק אם יש סינון פעיל
			const smartSearch = document.getElementById('receiptSmartSearch');
			if (smartSearch && smartSearch.value.trim()) {
				// יש חיפוש פעיל - השתמש בו
				handleReceiptSmartSearch(smartSearch.value);
			} else {
				// אין חיפוש - הצג הכל
				applyReceiptFilters();
			}
		}

        // Visithandling
        function startVisitForlocation(locationId) {
            const location = locations.find(g => g.ID === locationId);
            if (location) {
                showSection('visit');
                document.getElementById('locationSelect').value = locationId;
            }
        }

        function handleVisitSubmit(event) {
			event.preventDefault();
			
			// בדיקות בטיחות לכל האלמנטים
			const clientSearchInput = document.getElementById('clientSearchInput');
			const selectedClientIdInput = document.getElementById('selectedClientId');

			let selectedLocationId = '';
			if (selectedClientIdInput && selectedClientIdInput.value) {
				selectedLocationId = selectedClientIdInput.value;
			} else if (clientSearchInput && clientSearchInput.value) {
				// אם אין ID נבחר, נסה למצוא לפי הטקסט
				const searchValue = clientSearchInput.value;
				const matchingClient = locations.find(loc => 
					`${loc.name} - ${loc.full_address}` === searchValue ||
					loc.name === searchValue
				);
				if (matchingClient) {
					selectedLocationId = matchingClient.ID;
				}
			}

			const visitDateElement = document.getElementById('visitDate');
			const visitDate = visitDateElement ? visitDateElement.value : '';

			const endTimeElement = document.getElementById('endTime');
			const endTime = endTimeElement ? endTimeElement.value : '';

			const paymentStatusElement = document.getElementById('paymentStatus');
			const paymentStatus = paymentStatusElement ? paymentStatusElement.value : '0';

			const visitTypeElement = document.getElementById('visitType');
			const visitType = visitTypeElement ? visitTypeElement.value : 'מלא';

			const workDoneElement = document.getElementById('workDone');
			const workDone = workDoneElement ? workDoneElement.value : '';

			const amountElement = document.getElementById('amount');
			const amount = amountElement ? amountElement.value : '0';

			const notesElement = document.getElementById('notes');
			const notes = notesElement ? notesElement.value : '';

			const manualDurationElement = document.getElementById('manualDurationMinutes');
			const durationMinutes = manualDurationElement ? parseFloat(manualDurationElement.value) || 0 : 0;

			const numberOfWorkersElement = document.getElementById('numberOfWorkersVisit');
			const numberOfWorkers = numberOfWorkersElement ? parseInt(numberOfWorkersElement.value) || 1 : 1;

			const expenseElement = document.getElementById('expense');
			const expense = expenseElement ? expenseElement.value : '0';

			const visitTimeElement = document.getElementById('visitTime');
			const startTime = visitTimeElement ? visitTimeElement.value : '';
			
			// בדיקות בסיסיות
			if (!selectedLocationId) {
				showToast('אנא בחר לקוח', 'error');
				return;
			}
			
			if (!visitDate) {
				showToast('נדרש תאריך טיפול', 'error');
				return;
			}
			
			// בדיקת כפילות
			const duplicateVisit = checkDuplicateVisit(selectedLocationId, visitDate);
			if (duplicateVisit) {
				const location = locations.find(loc => loc.ID == selectedLocationId);
				const locationName = location ? location.name : 'לקוח לא ידוע';
				
				const confirmMessage = `כבר קיים טיפול ללקוח "${locationName}" היום (${formatDate(visitDate)}).\n\nהאם להוסיף טיפול נוסף בכל זאת?`;
				
				if (!confirm(confirmMessage)) {
					return; // ביטול הוספה
				}
			}

			// חישוב אוטומטי של משך הזמן אם יש שעת התחלה וסיום
			let calculatedDuration = durationMinutes;
			if (startTime && endTime) {
				const start = new Date(`2000-01-01 ${startTime}`);
				const end = new Date(`2000-01-01 ${endTime}`);
				const diffMs = end - start;
				if (diffMs > 0) {
					calculatedDuration = Math.round(diffMs / (1000 * 60)); // הפרש בדקות
					if (manualDurationElement) {
						manualDurationElement.value = calculatedDuration;
					}
				}
			}

			const visitData = {
				location_id: selectedLocationId,  
				visit_type: visitType,
				work_done: workDone,
				duration_minutes: calculatedDuration,
				workers_count: numberOfWorkers,		
				amount: parseFloat(amount) || 0,
				expense: parseFloat(expense) || 0,
				date: visitDate,
				start_time: startTime,
				end_time: endTime,
				paid: paymentStatus,
				notes: notes
			};
			
			console.log('Visit data:', visitData);
			
			// שמירת הטיפול
			saveVisit(visitData);
		}


		// Fixed saveVisit - proper mapping for workers_count to num_workers
		async function saveVisit(visitData) {
			try {
				// Find the client
				const location = locations.find(loc => loc.ID === visitData.location_id);
				
				// Create the correct visit object structure
				const newVisit = {
					ID: generateID(),
					date: visitData.date,
					location_id: visitData.location_id,
					location_name: location ? location.name : 'לקוח לא ידוע',
					visit_type: visitData.visit_type,
					work_done: visitData.work_done,
					duration_minutes: visitData.duration_minutes,
					num_workers: visitData.workers_count || 1,    // ✅ CORRECT mapping!
					start_time: visitData.start_time,
					end_time: visitData.end_time,
					amount: visitData.amount,
					expense: visitData.expense || 0,
					notes: visitData.notes
					// ✅ REMOVED: no 'paid' field - this caused the column shift problem
				};

				// Add to visits array
				visits.push(newVisit);
				
				// Save locally (always succeeds)
				saveToLocalStorage();
				
				// Try to save to cloud
				let cloudSaved = false;
				if (access_token && SPREADSHEET_ID) {
					try {
						await saveVisitToSheets(newVisit);
						cloudSaved = true;
					} catch (error) {
						console.error('Cloud save failed:', error);
						cloudSaved = false;
					}
				}
				
				// Update treatment dates
				await updateSingleLocationTreatmentDates(newVisit.location_id);
				
				// Refresh display
				document.getElementById('visitForm')?.reset();
				loadPlanningData();
				
				// Success message based on actual result
				if (access_token && SPREADSHEET_ID) {
					if (cloudSaved) {
						showToast('✅ הטיפול נשמר בהצלחה במערכת ובענן!', 'success');
					} else {
						showToast('⚠️ הטיפול נשמר מקומית בלבד - בעיה בחיבור לענן', 'warning');
					}
				} else {
					showToast('💾 הטיפול נשמר מקומית - התחבר לענן לשמירה מלאה', 'info');
				}
				
			} catch (error) {
				console.error('Error saving visit:', error);
				showToast('❌ שגיאה בשמירת הטיפול - נסה שנית', 'error');
			}
		}
		
		
		function postponeVisit(locationId) {
			const location = locations.find(g => g.ID == locationId);
			if (location) {
				const weeks = prompt('כמה שבועות לדחות?', '1');
				if (weeks && !isNaN(weeks)) {
					const currentNext = new Date(location.next_visit);
					const newNext = new Date(currentNext.getTime() + (parseInt(weeks) * 7 * 24 * 60 * 60 * 1000));
					location.next_visit= newNext.toISOString().split('T')[0];

					loadPlanningData();
					showSuccess(`טיפול נדחה ב-${weeks} שבועות`);
				}
			}
		}

        // location management
        function showAddLocationForm() {
			const modalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">הוספת לקוח חדש</h3>
					
					<form id="locationForm" onsubmit="handleLocationSubmit(event)">
						<div class="form-group">
							<label for="locationName">שם לקוח:</label>
							<input type="text" id="locationName" required>
						</div>
						<div class="form-group">
							<label for="locationAddress">כתובת מלאה:</label>
							<input type="text" id="locationAddress" required>
						</div>
						<div class="form-group">
							<label for="locationNeighborhood">שכונה:</label>
							<input type="text" id="locationNeighborhood">
						</div>
						<div class="form-group">
							<label for="locationCity">עיר:</label>
							<input type="text" id="locationCity">
						</div>
						<div class="form-group">
							<label for="locationContact">איש קשר:</label>
							<input type="text" id="locationContact">
						</div>
						<div class="form-group">
							<label for="locationPhone">טלפון:</label>
							<input type="tel" id="locationPhone">
						</div>
						<div class="form-group">
							<label for="locationDay">יום מועדף:</label>
							<select id="locationDay">
								<option value="כל יום">כל יום</option>
								<option value="א">א (ראשון)</option>
								<option value="ב">ב (שני)</option>
								<option value="ג">ג (שלישי)</option>
								<option value="ד">ד (רביעי)</option>
								<option value="ה">ה (חמישי)</option>
								<option value="ו">ו (שישי)</option>
								<option value="ש">ש (שבת)</option>
							</select>
						</div>
						<div class="form-group">
							<label for="locationInterval">מרווח שבועות:</label>
							<input type="number" id="locationInterval" value="4" min="1">
						</div>
						<div class="form-group">
							<label for="locationAmount">סכום בסיסי:</label>
							<input type="number" id="locationAmount">
						</div>
						<div class="form-group">
							<label for="locationActive">פעילות:</label>
							<select id="locationActive" required>
								<option value="1">פעיל</option>
								<option value="0">לא פעיל</option>
							</select>
						</div>
						<div class="form-group">
							<label for="locationNextVisit">תאריך לטיפול הבא:</label>
							<input type="date" id="locationNextVisit" required>
						</div>
						<div class="form-group">
							<label for="locationClientRequests">בקשות לקוח:</label>
							<textarea id="locationClientRequests" rows="2"></textarea>
						</div>
						<div class="form-group">
							<label for="locationNotes">הערות:</label>
							<textarea id="locationNotes" rows="3"></textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="submit" class="btn btn-success">שמור לקוח</button>
							<button type="button" onclick="closeEditModal()" class="btn btn-secondary">ביטול</button>
						</div>
					</form>
				</div>
			`;
			
			showEditModal(modalHTML);
			
			// Set default date
			document.getElementById('locationNextVisit').value = new Date().toISOString().split('T')[0];
		}

        async function handleLocationSubmit(event) {
            event.preventDefault();
           
			const locationData = {
				ID: generateID(),
				name: document.getElementById('locationName').value,
				full_address: document.getElementById('locationAddress').value,
				neighborhood: document.getElementById('locationNeighborhood').value,
				city: document.getElementById('locationCity').value,
				contact_person: document.getElementById('locationContact').value,
				phone: document.getElementById('locationPhone').value,
				allowed_day: document.getElementById('locationDay').value,
				interval_weeks: parseInt(document.getElementById('locationInterval').value),
				temp_addition: 0,
				base_amount: parseFloat(document.getElementById('locationAmount').value) || 0,
				active: document.getElementById('locationActive').value,
				notes: document.getElementById('locationNotes').value,
				client_requests: document.getElementById('locationClientRequests').value || '', // שדה חדש
				last_visit: '',
				next_visit: document.getElementById('locationNextVisit').value
			};
           
		    // בדיקת כפילויות גם לפי ID וגם לפי כתובת
			const existingLocation = locations.find(loc => 
				loc.ID === locationData.ID || 
				(loc.full_address && locationData.full_address &&
				 loc.full_address.toLowerCase().trim() === locationData.full_address.toLowerCase().trim())
			);

			if (existingLocation) {
				if (!confirm(`לקוח עם כתובת "${locationData.full_address}" כבר קיים.\n\nהאם להוסיף בכל זאת?`)) {
					return; // ביטול הוספה
				}
			}
		   
            // שמירה לזיכרון מקומי
			locations.push(locationData);

			// שמירה אוטומטית לענן
			if (access_token && spreadsheet_id) {
				document.getElementById('statusText').textContent = '🔄 שומר לקוח...';
				try {
					await saveLocationToSheets(locationData);
					document.getElementById('statusText').textContent = 'מחובר';
					showSuccess('לקוח נשמר בהצלחה ל-Google Sheets!');
				} catch (error) {
					if (error.status === 401) {
						document.getElementById('statusText').textContent = '🔓 נדרש חיבור מחדש';
						document.getElementById('statusText').classList.remove('connected');
						showToast('⚠️ החיבור לגוגל פג - התחבר מחדש', 'warning');
						access_token = null;
					} else {
						document.getElementById('statusText').textContent = '⚠️ שגיאה בשמירה';
						showToast('⚠️ הלקוח נשמר מקומית בלבד', 'warning');
					}
				}
			} else {
				showToast('🔓 לקוח נשמר מקומית - התחבר לענן לשמירה', 'warning');
			}

			closeEditModal();
			loadLocationsTable();
			loadLocationsForSelect();
			saveToLocalStorage();
        }


		// ✅ NEW: Show comprehensive client profile modal
		function showClientProfile(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// Get client's visits
			const clientVisits = visits
				.filter(v => v.location_id === clientId)
				.sort((a, b) => b.date.localeCompare(a.date));
			
			// Calculate statistics
			const totalVisits = clientVisits.length;
			const totalIncome = clientVisits.reduce((sum, v) => sum + (parseFloat(v.amount) || 0), 0);
			const totalPaid = clientVisits.reduce((sum, v) => sum + getVisitPaidAmount(v.ID), 0);
			const totalDebt = totalIncome - totalPaid;
			
			// Last visit date
			const lastVisit = clientVisits.length > 0 ? clientVisits[0].date : 'אין';
			
			// Build modal HTML
			const modalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 900px; width: 95vw; max-height: 90vh; overflow-y: auto;">
					<!-- Header -->
					<div style="border-bottom: 3px solid #3498db; padding-bottom: 15px; margin-bottom: 20px;">
						<h2 style="margin: 0; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
							👤 ${client.name}
							<span style="font-size: 14px; color: #666; font-weight: normal;">${client.full_address}</span>
						</h2>
					</div>
					
					<!-- Statistics Cards -->
					<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
						<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white;">
							<div style="font-size: 13px; opacity: 0.9;">סה"כ טיפולים</div>
							<div style="font-size: 28px; font-weight: bold;">${totalVisits}</div>
						</div>
						<div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 15px; border-radius: 10px; color: white;">
							<div style="font-size: 13px; opacity: 0.9;">סה"כ הכנסות</div>
							<div style="font-size: 28px; font-weight: bold;">₪${totalIncome.toFixed(0)}</div>
						</div>
						<div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 15px; border-radius: 10px; color: white;">
							<div style="font-size: 13px; opacity: 0.9;">שולם</div>
							<div style="font-size: 28px; font-weight: bold;">₪${totalPaid.toFixed(0)}</div>
						</div>
						<div style="background: ${totalDebt > 0 ? 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' : 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)'}; padding: 15px; border-radius: 10px; color: white;">
							<div style="font-size: 13px; opacity: 0.9;">${totalDebt > 0 ? 'חוב' : 'ללא חובות'}</div>
							<div style="font-size: 28px; font-weight: bold;">₪${Math.abs(totalDebt).toFixed(0)}</div>
						</div>
					</div>
					
					<!-- Next Treatment Info -->
					<div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
						<div style="display: flex; justify-content: space-between; align-items: center;">
							<div>
								<div style="font-size: 14px; color: #2e7d32; margin-bottom: 5px;">📅 טיפול הבא מתוכנן ל:</div>
								<div style="font-size: 20px; font-weight: bold; color: #1b5e20;">${formatDate(client.next_visit)}</div>
								<div style="font-size: 12px; color: #666; margin-top: 3px;">טיפול אחרון: ${lastVisit !== 'אין' ? formatDate(lastVisit) : 'אין'}</div>
							</div>
							<button onclick="startTreatment('${clientId}')" 
									style="padding: 12px 24px; background: #4caf50; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold;">
								🚀 התחל טיפול עכשיו
							</button>
						</div>
					</div>
					
					<!-- Tabs -->
					<div style="border-bottom: 2px solid #e0e0e0; margin-bottom: 20px;">
						<button onclick="switchClientProfileTab('treatments')" 
								class="client-profile-tab active" 
								data-tab="treatments"
								style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid #3498db; cursor: pointer; font-size: 15px; font-weight: bold; color: #3498db;">
							🔧 טיפולים (${totalVisits})
						</button>
						<button onclick="switchClientProfileTab('payments')" 
								class="client-profile-tab" 
								data-tab="payments"
								style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 15px; color: #666;">
							💰 תשלומים
						</button>
						<button onclick="switchClientProfileTab('info')" 
								class="client-profile-tab" 
								data-tab="info"
								style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 15px; color: #666;">
							ℹ️ פרטים
						</button>
					</div>
					
					<!-- Tab Content -->
					<div id="clientProfileTabContent">
						<!-- Will be populated by switchClientProfileTab -->
					</div>
					
					<!-- Close Button -->
					<div style="text-align: center; margin-top: 20px;">
						<button onclick="closeEditModal()" 
								style="padding: 10px 30px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
							סגור
						</button>
					</div>
				</div>
			`;
			
			showEditModal(modalHTML);
			
			// Show treatments tab by default
			setTimeout(() => switchClientProfileTab('treatments', clientId), 100);
		}


		// ✅ NEW: Start treatment from client profile
		function startTreatment(clientId) {
			// Close the profile modal
			closeEditModal();
			
			// Switch to visits tab
			showSection('visit');
			
			// Pre-select the client in the visit form
			const clientSearchInput = document.getElementById('clientSearchInput');
			const selectedClientIdInput = document.getElementById('selectedClientId');
			
			if (selectedClientIdInput) {
				selectedClientIdInput.value = clientId;
			}
			
			// Find the client and set the search input display
			const client = locations.find(loc => loc.ID === clientId);
			if (client && clientSearchInput) {
				clientSearchInput.value = `${client.name} - ${client.full_address}`;
			}
			
			// Set today's date
			const visitDateInput = document.getElementById('visitDate');
			if (visitDateInput) {
				visitDateInput.value = new Date().toISOString().split('T')[0];
			}
			
			// Focus on work done field
			setTimeout(() => {
				const workDoneInput = document.getElementById('workDone');
				if (workDoneInput) {
					workDoneInput.focus();
				}
			}, 100);
			
			showToast(`מוכן לתעד טיפול עבור ${client.name}`, 'success');
		}


		// ✅ NEW: Switch between tabs in client profile
		function switchClientProfileTab(tabName, clientId) {
			// If clientId not provided, try to get it from the modal
			if (!clientId) {
				const modal = document.getElementById('editModal');
				if (!modal) return;
				// Try to extract clientId from the modal content
				const startButton = modal.querySelector('[onclick*="startTreatment"]');
				if (startButton) {
					const match = startButton.getAttribute('onclick').match(/'([^']+)'/);
					clientId = match ? match[1] : null;
				}
			}
			
			if (!clientId) {
				console.error('Client ID not found');
				return;
			}
			
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			// Update tab buttons
			document.querySelectorAll('.client-profile-tab').forEach(btn => {
				if (btn.dataset.tab === tabName) {
					btn.style.borderBottom = '3px solid #3498db';
					btn.style.color = '#3498db';
					btn.style.fontWeight = 'bold';
				} else {
					btn.style.borderBottom = '3px solid transparent';
					btn.style.color = '#666';
					btn.style.fontWeight = 'normal';
				}
			});
			
			const contentDiv = document.getElementById('clientProfileTabContent');
			if (!contentDiv) return;
			
			// Generate content based on tab
			let html = '';
			
			if (tabName === 'treatments') {
				// Treatments tab
				const clientVisits = visits
					.filter(v => v.location_id === clientId)
					.sort((a, b) => b.date.localeCompare(a.date));
				
				if (clientVisits.length === 0) {
					html = '<div style="text-align: center; padding: 40px; color: #666;">עדיין אין טיפולים ללקוח זה</div>';
				} else {
					html = `
						<div style="max-height: 400px; overflow-y: auto;">
							<table style="width: 100%; border-collapse: collapse;">
								<thead style="position: sticky; top: 0; background: #f8f9fa;">
									<tr style="border-bottom: 2px solid #dee2e6;">
										<th style="padding: 10px; text-align: right;">תאריך</th>
										<th style="padding: 10px; text-align: right;">עבודה</th>
										<th style="padding: 10px; text-align: right;">זמן</th>
										<th style="padding: 10px; text-align: right;">סכום</th>
										<th style="padding: 10px; text-align: right;">תשלום</th>
									</tr>
								</thead>
								<tbody>
									${clientVisits.map(visit => {
										const paidInfo = parsePaidField(visit.paid);
										let paymentBadge = '';
										
										if (paidInfo.status === 'paid') {
											paymentBadge = `<span style="background: #d4edda; color: #155724; padding: 3px 8px; border-radius: 4px; font-size: 12px;">✓ שולם</span>`;
										} else if (paidInfo.status === 'partial') {
											paymentBadge = `<span style="background: #fff3cd; color: #856404; padding: 3px 8px; border-radius: 4px; font-size: 12px;">⚠ חלקי</span>`;
										} else if (paidInfo.status === 'no_payment') {
											paymentBadge = `<span style="background: #e2e3e5; color: #383d41; padding: 3px 8px; border-radius: 4px; font-size: 12px;">🚫 ללא</span>`;
										} else {
											paymentBadge = `<span style="background: #f8d7da; color: #721c24; padding: 3px 8px; border-radius: 4px; font-size: 12px;">✗ לא שולם</span>`;
										}
										
										const duration = visit.duration_minutes ? `${(visit.duration_minutes / 60).toFixed(1)}ש` : '-';
										
										return `
											<tr style="border-bottom: 1px solid #dee2e6;">
												<td style="padding: 10px;">${formatDate(visit.date)}</td>
												<td style="padding: 10px; font-size: 13px; color: #666;">${visit.work_done || '-'}</td>
												<td style="padding: 10px;">${duration}</td>
												<td style="padding: 10px; font-weight: bold; color: #27ae60;">${visit.amount || 0}₪</td>
												<td style="padding: 10px;">${paymentBadge}</td>
											</tr>
										`;
									}).join('')}
								</tbody>
							</table>
						</div>
					`;
				}
				
			} else if (tabName === 'payments') {
				// Payments tab - show actual payments from payments array
				const clientPayments = payments
					.filter(p => p.client_id === clientId)
					.sort((a, b) => b.date.localeCompare(a.date));
				
				html = `
					<div style="margin-bottom: 15px; text-align: center;">
						<button onclick="showAddPaymentModal('${clientId}')" 
								style="padding: 12px 24px; background: #27ae60; color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);">
							➕ הוסף תשלום
						</button>
					</div>
				`;
				
				if (clientPayments.length === 0) {
					html += '<div style="text-align: center; padding: 40px; color: #666;">עדיין אין תשלומים ללקוח זה</div>';
				} else {
					const totalPaid = clientPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
					
					html += `
						<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #27ae60;">
							<div style="display: flex; justify-content: space-between; align-items: center;">
								<span style="font-size: 14px; color: #27ae60; font-weight: bold;">סך הכל תשלומים:</span>
								<span style="font-size: 24px; font-weight: bold; color: #27ae60;">₪${totalPaid.toFixed(2)}</span>
							</div>
						</div>
						
						<div style="max-height: 400px; overflow-y: auto;">
							${clientPayments.map(payment => {
								// מצא טיפולים מקושרים
								const relatedLinks = paymentVisitLinks.filter(link => link.payment_id === payment.ID);
								const linkedVisitsCount = relatedLinks.length;
								const totalLinked = relatedLinks.reduce((sum, link) => sum + (link.amount_allocated || 0), 0);
								
								// טקסט אמצעי תשלום
								let methodText = '';
								switch(payment.payment_method) {
									case 'cash': methodText = '💵 מזומן'; break;
									case 'check': methodText = '📝 צ\'ק'; break;
									case 'transfer': methodText = '🏦 העברה'; break;
									case 'app': methodText = '📱 אפליקציה'; break;
									default: methodText = payment.payment_method || '';
								}
								
								return `
									<div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 12px; background: white;">
										<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
											<div>
												<div style="font-size: 16px; font-weight: bold; color: #2c3e50;">${formatDate(payment.date)}</div>
												<div style="font-size: 13px; color: #666; margin-top: 3px;">${methodText}</div>
											</div>
											<div style="text-align: left;">
												<div style="font-size: 24px; font-weight: bold; color: #27ae60;">₪${payment.amount.toFixed(2)}</div>
												${linkedVisitsCount > 0 ? 
													`<div style="font-size: 11px; color: #666; margin-top: 2px;">מקושר: ₪${totalLinked.toFixed(2)}</div>` 
													: ''}
											</div>
										</div>
										
										${payment.reference ? 
											`<div style="font-size: 12px; color: #666; margin-bottom: 5px;">
												<strong>אסמכתא:</strong> ${payment.reference}
											</div>` 
											: ''}
										
										${payment.check_date ? 
											`<div style="font-size: 12px; color: #666; margin-bottom: 5px;">
												<strong>תאריך פירעון:</strong> ${formatDate(payment.check_date)}
											</div>` 
											: ''}
										
										${payment.notes ? 
											`<div style="font-size: 13px; color: #555; background: #f8f9fa; padding: 8px; border-radius: 4px; margin-top: 8px;">
												💬 ${payment.notes}
											</div>` 
											: ''}
										
										${linkedVisitsCount > 0 ? 
											`<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6;">
												<div style="font-size: 12px; color: #666; font-weight: bold; margin-bottom: 5px;">
													🔗 מקושר ל-${linkedVisitsCount} טיפולים
												</div>
											</div>` 
											: `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6; font-size: 12px; color: #f39c12;">
												⚠️ לא מקושר לטיפולים
											</div>`}
										
										<div style="text-align: center; margin-top: 10px;">
											<button onclick="showPaymentDetails('${payment.ID}')" 
													style="padding: 6px 16px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">
												🔍 פרטים מלאים
											</button>
										</div>
									</div>
								`;
							}).join('')}
						</div>
					`;
				}
				
			} else if (tabName === 'info') {
				// Info tab
				html = `
					<div style="display: grid; gap: 15px;">
						<div>
							<strong style="color: #666;">כתובת מלאה:</strong>
							<div style="margin-top: 5px;">${client.full_address}</div>
						</div>
						<div>
							<strong style="color: #666;">איש קשר:</strong>
							<div style="margin-top: 5px;">${client.contact_person || 'לא צוין'}</div>
						</div>
						<div>
							<strong style="color: #666;">טלפון:</strong>
							<div style="margin-top: 5px;">${client.phone || 'לא צוין'}</div>
						</div>
						<div>
							<strong style="color: #666;">יום מועדף:</strong>
							<div style="margin-top: 5px;">${client.allowed_day || 'לא צוין'}</div>
						</div>
						<div>
							<strong style="color: #666;">תדירות (שבועות):</strong>
							<div style="margin-top: 5px;">${client.interval_weeks || 4} שבועות</div>
						</div>
						<div>
							<strong style="color: #666;">מחיר בסיס:</strong>
							<div style="margin-top: 5px;">${client.base_amount || 0}₪</div>
						</div>
						<div>
							<strong style="color: #666;">הערות:</strong>
							<div style="margin-top: 5px; background: #f8f9fa; padding: 10px; border-radius: 5px; min-height: 60px;">
								${client.notes || 'אין הערות'}
							</div>
						</div>
						<div style="text-align: center; margin-top: 10px;">
							<button onclick="editLocation('${clientId}')" 
									style="padding: 8px 20px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">
								✏️ ערוך פרטי לקוח
							</button>
						</div>
					</div>
				`;
			}
			
			contentDiv.innerHTML = html;
		}


		function editLocation(locationId) {
			console.log(`✅ editLocation ('${locationId}')`);
			const location = locations.find(g => g.ID == locationId);
			if (!location) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			console.log(`✅ editLocation second: ('${locationId}')`);
			
			// צור חלון עריכה
			const editModalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">🏠 עריכת לקוח - ${location.name}</h3>
					
					<form id="editLocationForm">
						<div class="form-group">
							<label>שם הלקוח:</label>
							<input type="text" id="editLocationName" value="${location.name || ''}" required>
						</div>
						
						<div class="form-group">
							<label>כתובת מלאה:</label>
							<input type="text" id="editLocationAddress" value="${location.full_address || ''}" required>
						</div>
						
						<div class="form-group">
							<label>שכונה:</label>
							<input type="text" id="editLocationNeighborhood" value="${location.neighborhood || ''}">
						</div>
						
						<div class="form-group">
							<label>עיר:</label>
							<input type="text" id="editLocationCity" value="${location.city || ''}">
						</div>
						
						<div class="form-group">
							<label>איש קשר:</label>
							<input type="text" id="editLocationContact" value="${location.contact_person || ''}">
						</div>
						
						<div class="form-group">
							<label>טלפון:</label>
							<input type="tel" id="editLocationPhone" value="${location.phone || ''}">
						</div>
						
						<div class="form-group">
							<label>יום מועדף:</label>
							<select id="editLocationDay" value="${location.allowed_day||''}">
								<option value="כל יום" ${location.allowed_day === 'כל יום' ? 'selected' : ''}>כל יום</option>
								<option value="א" ${location.allowed_day === 'א' ? 'selected' : ''}>א (ראשון)</option>
								<option value="ב" ${location.allowed_day === 'ב' ? 'selected' : ''}>ב (שני)</option>
								<option value="ג" ${location.allowed_day === 'ג' ? 'selected' : ''}>ג (שלישי)</option>
								<option value="ד" ${location.allowed_day === 'ד' ? 'selected' : ''}>ד (רביעי)</option>
								<option value="ה" ${location.allowed_day === 'ה' ? 'selected' : ''}>ה (חמישי)</option>
								<option value="ו" ${location.allowed_day === 'ו' ? 'selected' : ''}>ו (שישי)</option>
								<option value="ש" ${location.allowed_day === 'ש' ? 'selected' : ''}>ש (שבת)</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>מרווח בשבועות:</label>
							<input type="number" id="editLocationInterval" value="${location.interval_weeks || 4}" min="1" required>
						</div>
						
						<div class="form-group">
							<label>סכום בסיס (₪):</label>
							<input type="number" id="editLocationAmount" value="${location.base_amount || 0}" step="0.01">
						</div>
						
						<div class="form-group">
							<label>סטטוס:</label>
							<select id="editLocationActive">
								<option value="1" ${location.active === '1' ? 'selected' : ''}>פעיל</option>
								<option value="0" ${location.active === '0' ? 'selected' : ''}>לא פעיל</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>טיפול הבא:</label>
							<input type="date" id="editLocationNextVisit" value="${location.next_visit || ''}">
						</div>
						
						<div class="form-group">
							<label>הערות:</label>
							<textarea id="editLocationNotes" rows="3">${location.notes || ''}</textarea>
						</div>
						
						<div class="form-group">
							<label>בקשות לקוח:</label>
							<textarea id="editLocationClientRequests" rows="2">${location.client_requests || ''}</textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="button" onclick="saveEditedLocation('${locationId}')" class="btn btn-success">
								💾 שמור שינויים
							</button>
							<button type="button" onclick="closeEditModal()" class="btn btn-secondary">
								❌ ביטול
							</button>
						</div>
					</form>
				</div>
			`;
			
			// הצג את המודל
			showEditModal(editModalHTML);
		}

		// פונקציה לעדכון הלקוח בענן (אופציונלית)
		async function updateLocationInCloud(updatedLocation) {
			if (!await validateToken()) return;
			
			try {
				// קריאת כל הנתונים מהענן
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:P' // ✅ שונה מ-A:O ל-A:P
				});
				
				const rows = response.result.values || [];
				
				// מציאת השורה לעדכון
				let rowToUpdate = -1;
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] == updatedLocation.ID) {
						rowToUpdate = i + 1; // +1 כי Google Sheets מתחיל מ-1
						break;
					}
				}
				
				if (rowToUpdate > 0) {
					// עדכון השורה
					const updatedRow = [
						updatedLocation.ID,
						updatedLocation.name,
						updatedLocation.full_address,
						updatedLocation.neighborhood,
						updatedLocation.city,
						updatedLocation.contact_person,
						updatedLocation.phone,
						updatedLocation.allowed_day,
						updatedLocation.interval_weeks,
						updatedLocation.temp_addition || 0,
						updatedLocation.base_amount,
						updatedLocation.active,
						updatedLocation.notes,
						updatedLocation.last_visit || '',
						updatedLocation.next_visit || '',
						updatedLocation.client_requests || '' // ✅ הוסף שדה client_requests
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Locations!A${rowToUpdate}:P${rowToUpdate}`, // ✅ שונה מ-O ל-P
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [updatedRow]
						}
					});
					
					console.log(`✅ Updated location ${updatedLocation.ID} in cloud`);
				}
				
			} catch (error) {
				console.error('Error updating location in cloud:', error);
				throw error;
			}
		}
        

       function deleteLocation(locationId) {
           if (confirm('האם אתה בטוח שברצונך למחוק את הלקוח?')) {
               locations = locations.filter(g => g.ID != locationId);
               loadLocationsTable();
               loadLocationsForSelect();
               loadPlanningData();
               showSuccess('לקוח נמחק בהצלחה!');
			   saveToLocalStorage();
           }
       }

       // Receipt management
       function showAddReceiptForm() {
			const modalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">🧾 הוספת קבלה חדשה</h3>
					
					<form id="receiptForm" onsubmit="handleReceiptSubmit(event)">
						<div class="form-group">
							<label for="receiptBook">מספר פנקס:</label>
							<input type="text" id="receiptBook" required>
						</div>
						
						<div class="form-group">
							<label for="receiptNumber">מספר קבלה:</label>
							<input type="text" id="receiptNumber" required>
						</div>
						
						<div class="form-group">
							<label for="receiptDate">תאריך:</label>
							<input type="date" id="receiptDate" required>
						</div>
						
						<div class="form-group">
							<label for="receiptLocation">לקוח:</label>
							<select id="receiptLocation" required>
								<option value="">בחר לקוח</option>
							</select>
						</div>
						
						<div class="form-group">
							<label for="receiptAmount">סכום (₪):</label>
							<input type="number" step="0.01" id="receiptAmount" required>
						</div>
						
						<div class="form-group">
							<label for="receiptPaymentType">סוג תשלום:</label>
							<select id="receiptPaymentType">
								<option value="מזומן">מזומן</option>
								<option value="העברה">העברה</option>
								<option value="צ'ק">צ'ק</option>
								<option value="כרטיס אשראי">כרטיס אשראי</option>
							</select>
						</div>
						
						<div class="form-group">
							<label for="receiptNotes">הערות:</label>
							<textarea id="receiptNotes" rows="3"></textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="submit" class="btn btn-success">
								💾 שמור קבלה
							</button>
							<button type="button" onclick="closeEditModal()" class="btn btn-secondary">
								❌ ביטול
							</button>
						</div>
					</form>
				</div>
			`;
			
			showEditModal(modalHTML);
			
			// הגדרות ראשוניות
			setTimeout(() => {
				// הגדרת תאריך היום
				document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
				
				// טעינת לקוחות לבחירה
				const receiptLocation = document.getElementById('receiptLocation');
				locations.forEach(location => {
					const option = document.createElement('option');
					option.value = location.ID;
					option.textContent = `${location.name} - ${location.full_address}`;
					receiptLocation.appendChild(option);
				});
			}, 100);
		}

		async function handleReceiptSubmit(event) {
			event.preventDefault();
			
			try {
				// מצא את הלקוח הנבחר
				const selectedLocationId = document.getElementById('receiptLocation').value;
				const location = locations.find(loc => loc.ID === selectedLocationId);
				
				if (!selectedLocationId || !location) {
					showToast('חובה לבחור לקוח', 'error');
					return;
				}
				
				const receiptData = {
					ID: generateID(),
					book_number: document.getElementById('receiptBook').value,
					receipt_number: document.getElementById('receiptNumber').value,
					date: document.getElementById('receiptDate').value,
					location_id: selectedLocationId,
					location_name: location.name,
					amount: parseFloat(document.getElementById('receiptAmount').value),
					payment_type: document.getElementById('receiptPaymentType').value,
					notes: document.getElementById('receiptNotes').value || ''
				};
				
				// בדיקת תקינות
				const errors = validateReceiptData(receiptData);
				if (showValidationErrors(errors)) {
					return;
				}
				
				// בדיקת כפילויות קבלה
				const existingReceipt = receipts.find(receipt => 
					(receipt.book_number === receiptData.book_number && receipt.receipt_number === receiptData.receipt_number) ||
					(receipt.location_id === receiptData.location_id && receipt.date === receiptData.date && receipt.amount === receiptData.amount)
				);

				if (existingReceipt) {
					if (!confirm(`כבר קיימת קבלה עם אותו מספר או באותה כתובת/תאריך/סכום.\n\nהאם להוסיף בכל זאת?`)) {
						return;
					}
				}
				
				// הוספה למערך
				receipts.push(receiptData);
				
				// שמירה מקומית
				saveToLocalStorage();
				
				// שמירה בענן
				if (access_token) {
					try {
						await saveReceiptToSheets(receiptData);
						showToast('קבלה נשמרה בהצלחה במערכת ובענן!', 'success');
					} catch (error) {
						showToast('קבלה נשמרה מקומית, אך נכשלה בשמירה לענן', 'warning');
					}
				} else {
					showToast('קבלה נשמרה מקומית - התחבר לענן לשמירה מלאה', 'info');
				}

				// סגירת המודל ורענון
				closeEditModal();
				loadReceiptsTable();
				loadReceiptFilterOptions();
				
			} catch (error) {
				console.error('Error saving receipt:', error);
				showToast('שגיאה בשמירת הקבלה', 'error');
			}
		}

       // Utility functions
       function closeModal(modalId) {
           document.getElementById(modalId).style.display = 'none';
       }

       function formatDate(dateString) {
           const date = new Date(dateString);
           return date.toLocaleDateString('he-IL');
       }

       function showLoading(message) {
           // Could implement loading spinner
           console.log('Loading:', message);
       }

       function hideLoading() {
           // Hide loading spinner
           console.log('Loading complete');
       }

       
       // Click outside modal to close
       window.onclick = function(event) {
           if (event.target.classList.contains('modal')) {
               event.target.style.display = 'none';
           }
       }
	   
	  function editReceipt(receiptId) {
			console.log(`✅ editReceipt ('${receiptId}')`);
			const receipt = receipts.find(r => r.ID == receiptId);
			if (!receipt) {
				showToast('קבלה לא נמצאה', 'error');
				return;
			}
			
			// בניית אפשרויות הלקוחות
			let locationOptions = '<option value="">בחר לקוח</option>';
			locations.forEach(location => {
				const selected = location.ID == receipt.location_id ? 'selected' : '';
				locationOptions += `<option value="${location.ID}" ${selected}>${location.name} - ${location.full_address}</option>`;
			});
			
			// צור חלון עריכה
			const editModalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">🧾 עריכת קבלה</h3>
					
					<form id="editReceiptForm">
						<div class="form-group">
							<label>מספר פנקס:</label>
							<input type="text" id="editReceiptBook" value="${receipt.book_number || ''}" required>
						</div>
						
						<div class="form-group">
							<label>מספר קבלה:</label>
							<input type="text" id="editReceiptNumber" value="${receipt.receipt_number || ''}" required>
						</div>
						
						<div class="form-group">
							<label>תאריך:</label>
							<input type="date" id="editReceiptDate" value="${receipt.date}" required>
						</div>
						
						<div class="form-group">
							<label>לקוח:</label>
							<select id="editReceiptLocation" required>
								${locationOptions}
							</select>
						</div>
						
						<div class="form-group">
							<label>סכום (₪):</label>
							<input type="number" step="0.01" id="editReceiptAmount" value="${receipt.amount || 0}" required>
						</div>
						
						<div class="form-group">
							<label>סוג תשלום:</label>
							<select id="editReceiptPaymentType">
								<option value="מזומן" ${receipt.payment_type === 'מזומן' ? 'selected' : ''}>מזומן</option>
								<option value="העברה" ${receipt.payment_type === 'העברה' ? 'selected' : ''}>העברה</option>
								<option value="צ׳ק" ${receipt.payment_type === 'צ׳ק' ? 'selected' : ''}>צ׳ק</option>
								<option value="כרטיס אשראי" ${receipt.payment_type === 'כרטיס אשראי' ? 'selected' : ''}>כרטיס אשראי</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>הערות:</label>
							<textarea id="editReceiptNotes" rows="3">${receipt.notes || ''}</textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="button" onclick="saveEditedReceipt('${receiptId}')" class="btn btn-success">
								💾 שמור שינויים
							</button>
							<button type="button" onclick="closeEditModal()" class="btn btn-secondary">
								❌ ביטול
							</button>
						</div>
					</form>
				</div>
			`;
			
			// הצג את המודל
			showEditModal(editModalHTML);
		}

		
		// פונקציה לעדכון הקבלה בענן (אופציונלית)
		async function updateReceiptInCloud(updatedReceipt) {
			if (!await validateToken()) return;
			
			try {
				// קריאת כל הנתונים מהענן
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Receipts!A:I'
				});
				
				const rows = response.result.values || [];
				
				// מציאת השורה לעדכון
				let rowToUpdate = -1;
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] == updatedReceipt.ID) {
						rowToUpdate = i + 1; // +1 כי Google Sheets מתחיל מ-1
						break;
					}
				}
				
				if (rowToUpdate > 0) {
					// עדכון השורה
					const updatedRow = [
						updatedReceipt.ID,
						updatedReceipt.book_number,
						updatedReceipt.receipt_number,
						updatedReceipt.date,
						updatedReceipt.location_id,
						updatedReceipt.location_name,
						updatedReceipt.amount,
						updatedReceipt.payment_type,
						updatedReceipt.notes
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Receipts!A${rowToUpdate}:I${rowToUpdate}`,
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [updatedRow]
						}
					});
					
					console.log(`✅ Updated receipt ${updatedReceipt.ID} in cloud`);
				}
				
			} catch (error) {
				console.error('Error updating receipt in cloud:', error);
				throw error;
			}
		}

		
		function deleteReceipt(receiptId) {
			if (confirm('האם אתה בטוח שברצונך למחוק את הקבלה?')) {
				receipts = receipts.filter(r => r.ID != receiptId);
				loadReceiptsTable();
				loadReceiptFilterOptions();
				saveToLocalStorage();
				showSuccess('קבלה נמחקה בהצלחה!');
			}
		}
	   
	   // תוספה - הודעות Toast מתקדמות
		function showToast(message, type = 'info', duration = 3000) {
			const toastContainer = document.getElementById('toastContainer');
			
			if (!toastContainer) {
				console.error('Toast container not found');
				return;
			}
			
			const toast = document.createElement('div');
			toast.className = `toast ${type}`;
			toast.textContent = message;
			
			toastContainer.appendChild(toast);
			
			// Trigger animation
			setTimeout(() => {
				toast.classList.add('show');
			}, 100);
			
			// Remove toast after specified duration
			setTimeout(() => {
				toast.classList.remove('show');
				setTimeout(() => {
					if (toast.parentNode) {
						toast.parentNode.removeChild(toast);
					}
				}, 300);
			}, duration);
		}
	   
	   // פונקציות עזר להודעות
		function showSuccess(message, duration = 3000) {
			showToast(message, 'success', duration);
		}

		function showError(message, duration = 4000) {
			showToast(message, 'error', duration);
		}

		function showWarning(message, duration = 3500) {
			showToast(message, 'warning', duration);
		}

		function showInfo(message, duration = 3000) {
			showToast(message, 'info', duration);
		}
	   
	   
		// יצירת טבלת עזר לייבוא
		async function clearAllDataBeforeImport() {
			if (!confirm('האם אתה בטוח שברצונך למחוק את כל הנתונים הקיימים לפני הייבוא החדש?\n\nפעולה זו תמחק:\n- את כל המיקומים\n- את כל הביקורים\n- את כל הקבלות\n- את כל התשלומים\n- את כל הקישורים בין תשלומים לביקורים\n- את כל ההכנסות\n\nהנתונים בגוגל שיטס לא יימחקו.')) {
				return false;
			}
			
			try {
				console.log('🗑️ Starting complete data cleanup...');
				
				// Clear all arrays
				locations = [];
				visits = [];
				receipts = [];
				payments = [];
				paymentVisitLinks = [];
				incomes = [];  // ✅ ADDED: Clear incomes too
				
				console.log('✅ All arrays cleared');
				
				// Save empty arrays to localStorage
				saveToLocalStorage();
				console.log('✅ Empty data saved to localStorage');
				
				// Clear localStorage keys explicitly (belt and suspenders approach)
				localStorage.removeItem('locations_data');
				localStorage.removeItem('visits_data');
				localStorage.removeItem('receipts_data');
				localStorage.removeItem('payments_data');
				localStorage.removeItem('payment_links_data');
				localStorage.removeItem('incomes_data');
				console.log('✅ localStorage keys removed');
				
				// Update UI displays
				if (typeof loadLocationsTable === 'function') {
					loadLocationsTable();
					console.log('✅ Locations table refreshed');
				}
				if (typeof loadLocationsForSelect === 'function') {
					loadLocationsForSelect();
					console.log('✅ Location selectors refreshed');
				}
				
				showToast('✅ כל הנתונים המקומיים נוקו בהצלחה', 'success');
				console.log('✅ Complete cleanup finished successfully');
				return true;
				
			} catch (error) {
				console.error('❌ Error during cleanup:', error);
				showToast('❌ שגיאה בניקוי נתונים', 'error');
				return false;
			}
		}
		
		
		// שיפור לפונקציה הקיימת
		async function createImportTable() {
			if (!await validateToken()) {
				showToast('התחבר לגוגל קודם', 'warning');
				return;
			}
			
			try {
				showLoading('יוצר טבלת עזר לייבוא...');
				
				const response = await gapi.client.sheets.spreadsheets.create({
					resource: {
						properties: {
							title: `import_table_${new Date().toISOString().split('T')[0]}`
						},
						sheets: [{
							properties: { title: 'Locations' },
						}, {
							properties: { title: 'Visits' },
						}, {
							properties: { title: 'Receipts' }
						}, {
							properties: { title: 'SystemSettings' }
						}]
					}
				});
				
				const newSpreadsheetId = response.result.spreadsheetId;
				
				// הוספת כותרות לכל גליון
				await addImportHeaders(newSpreadsheetId);
				
				// פתיחת הטבלה
				window.open(`https://docs.google.com/spreadsheets/d/${newSpreadsheetId}/edit`, '_blank');
				
				// שמירת ID לייבוא מאוחר יותר
				localStorage.setItem('importTableId', newSpreadsheetId);
				
				showToast('טבלת עזר נוצרה! מלא את הנתונים ואז חזור לייבא', 'success');
				
			} catch (error) {
				console.error('Error creating import table:', error);
				showToast('שגיאה ביצירת טבלת עזר', 'error');
			} finally {
				hideLoading();
			}
		}

		// הוספת כותרות לטבלת עזר
		async function addImportHeaders(spreadsheetId) {
			if (!await validateToken()) {
				showToast('בעיה בחיבור לגוגל במהלך הוספת כותרות', 'error');
				return;
			}

			try {
				// כל הכותרות באנגלית
				const locationHeaders = [['customer_name', 'street', 'house_number', 'city', 'frequency', 'contact_person', 'base_amount', 'allowed_day', 'active']];
				const visitHeaders = [['year', 'month', 'day', 'customer', 'contact_person', 'treatment', 'date', 'work_done', 'duration', 'amount', 'paid', 'expense', 'notes']];
				const receiptHeaders = [['code_x', 'booklet', 'receipt', 'year', 'month', 'day', 'address', 'amount', 'type', 'notes', 'details']];
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				await Promise.all([
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Locations!A1:G1',
						valueInputOption: 'RAW',
						resource: { values: locationHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Visits!A1:M1',
						valueInputOption: 'RAW', 
						resource: { values: visitHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Receipts!A1:K1',
						valueInputOption: 'RAW',
						resource: { values: receiptHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'SystemSettings!A1:B1',
						valueInputOption: 'RAW',
						resource: { values: [['Setting', 'Value']] }
					})
				]);			
				
				console.log('Headers added successfully to import table');
				
			} catch (error) {
				console.error('Error adding headers:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('⚠️ החיבור פג במהלך הוספת כותרות', 'warning');
				} else {
					showToast('⚠️ שגיאה בהוספת כותרות לטבלה', 'error');
				}
				throw error;
			}
		}
		
		
		// תוספה - פיענוח כתובת מלאה לחלקים
		function parseFullAddress(fullAddress) {
			if (!fullAddress) return { street: '', houseNumber: '', city: '' };
			
			const parts = fullAddress.trim().split(' ');
			
			if (parts.length >= 3) {
				// העיר היא החלק האחרון
				const city = parts[parts.length - 1];
				
				// מספר הבית הוא החלק הלפני אחרון
				const houseNumber = parts[parts.length - 2];
				
				// הרחוב הוא כל השאר
				const street = parts.slice(0, -2).join(' ');
				
				return { street, houseNumber, city };
			} else if (parts.length === 2) {
				return { street: parts[0], houseNumber: '', city: parts[1] };
			} else {
				return { street: fullAddress, houseNumber: '', city: '' };
			}
		}
	   
	      
	   
	   
	   // תוספה - המרת פורמט תאריך מ-DD/MM/YYYY ל-YYYY-MM-DD
		function convertDateFormat(dateStr) {
			if (!dateStr) return '';
			
			const parts = dateStr.split('/');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = parts[1].padStart(2, '0');
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			
			return dateStr;
		}
	   
	   
	  	   
	   // תוספה - בדיקת תקינות נתונים
		function validateReceiptData(receiptData) {
			const errors = [];
			
			if (!receiptData.location_id) {
				errors.push('חובה לבחור לקוח');
			}
			
			if (!receiptData.amount || receiptData.amount <= 0) {
				errors.push('חובה להזין סכום חיובי');
			}
			
			if (!receiptData.date) {
				errors.push('חובה להזין תאריך');
			}
			
			return errors;
		}

		function showValidationErrors(errors) {
			if (errors.length > 0) {
				showToast(errors.join('\n'), 'error');
				return true; // יש שגיאות
			}
			return false; // אין שגיאות
		}
	   
	   
	    // תוספה - ניהול פאנלי סינון ומידע
		function toggleFilterPanel() {
			const content = document.getElementById('filterContent');
			const icon = document.getElementById('filterIcon');
			
			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				icon.textContent = '🔽';
			} else {
				content.classList.add('collapsed');
				icon.textContent = '🔼';
			}
		}

		function toggleInfoPanel() {
			const content = document.getElementById('infoContent');
			const icon = document.getElementById('infoIcon');
			
			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				icon.textContent = '🔽';
			} else {
				content.classList.add('collapsed');
				icon.textContent = '🔼';
			}
		}

		// תוספה - טעינת אפשרויות סינון
		function loadFilterOptions() {
			const locationSelect = document.getElementById('filterLocation');
			
			if (locationSelect) {
				locationSelect.innerHTML = '<option value="">כל הלקוחות</option>';
				
				locations.forEach(location => {
					const option = document.createElement('option');
					option.value = location.ID;
					option.textContent = location.name;
					locationSelect.appendChild(option);
				});
			}
		}
	   
		// תוספה - סינון וטעינת טיפולים
		function applyVisitFilters() {
			console.log('🔍 מסנן טיפולים...');
			
			// Check for smart search first
			const smartSearch = document.getElementById('visitSmartSearch')?.value;
			if (smartSearch && smartSearch.trim()) {
				handleVisitSmartSearch(smartSearch);
				return;
			}
			
			let filteredVisits = [...visits];
			
			// Filter by active status with null safety
			const activeFilter = document.getElementById('filterActiveClients')?.value || '1';
			if (activeFilter !== '') {
				const activeStatus = activeFilter === '1';
				const activeLocationIds = locations
					.filter(loc => (activeStatus ? loc.active === "1" : loc.active !== "1"))
					.map(loc => loc.ID);
				filteredVisits = filteredVisits.filter(visit => 
					activeLocationIds.includes(visit.location_id)
				);
			}
			
			// Filter by payment status with null safety
			const paymentFilter = document.getElementById('filterPayment')?.value || '';
			if (paymentFilter) {
				filteredVisits = filteredVisits.filter(visit => {
					const paymentStatus = getVisitPaymentStatus(visit.ID);
					switch(paymentFilter) {
						case 'כן': return paymentStatus === 'paid';
						case 'לא': return paymentStatus === 'unpaid';
						case 'ללא': return paymentStatus === 'no_payment';
						default: return true;
					}
				});
			}
			
			// Filter by date range with null safety
			const dateFrom = document.getElementById('filterDateFrom')?.value || '';
			const dateTo = document.getElementById('filterDateTo')?.value || '';
			
			if (dateFrom) {
				filteredVisits = filteredVisits.filter(visit => visit.date >= dateFrom);
			}
			if (dateTo) {
				filteredVisits = filteredVisits.filter(visit => visit.date <= dateTo);
			}
			
			// Limit results with null safety
			const maxResults = parseInt(document.getElementById('maxResults')?.value) || 200;
			
			// Sort by date (newest first)
			filteredVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
			
			// Limit number of results
			if (filteredVisits.length > maxResults) {
				filteredVisits = filteredVisits.slice(0, maxResults);
			}
			
			console.log(`✅ נמצאו ${filteredVisits.length} טיפולים מתוך ${visits.length}`);
			
			displayFilteredVisits(filteredVisits);
			updateTreatmentsStats(filteredVisits);
		}

		function clearVisitFilters() {
			document.getElementById('filterLocation').value = '';
			document.getElementById('filterPayment').value = '';
			document.getElementById('filterDateFrom').value = '';
			document.getElementById('filterDateTo').value = '';
			document.getElementById('maxResults').value = '200';
			document.getElementById('filterActiveClients').value = '1'; // Reset to active only
			
			// ניקוי החיפוש החכם
			if (document.getElementById('visitSmartSearch')) {
				document.getElementById('visitSmartSearch').value = '';
			}
			
			// הסרת active מכפתורים מהירים
			document.querySelectorAll('.filter-quick-btn').forEach(btn => btn.classList.remove('active'));
			
			displayFilteredVisits(visits);
			updateTreatmentsStats(visits);
		}

		// תוספה - הצגת טיפולים מסוננים
		function displayFilteredVisits(filteredVisits) {
			const tbody = document.getElementById('visitsHistoryTableBody');
			
			// Clear quickly
			tbody.innerHTML = '';
			
			if (filteredVisits.length === 0) {
				tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #666;">אין טיפולים תואמים לסינון</td></tr>';
				return;
			}
			
			// Sort by date descending
			filteredVisits.sort((a, b) => b.date.localeCompare(a.date));
			
			const fragment = document.createDocumentFragment();
			const locationMap = new Map();
			locations.forEach(loc => locationMap.set(loc.ID, loc));
			
			filteredVisits.forEach(visit => {
				const location = locationMap.get(visit.location_id);
				const locationName = visit.location_name || location?.name || 'לקוח לא ידוע';
				
				// Main row
				const mainRow = document.createElement('tr');
				mainRow.className = 'main-row';
				const hours = visit.duration_minutes ? (visit.duration_minutes / 60).toFixed(1) : '0';
				
				// ✅ NEW: Parse paid field for better display
				const paidInfo = parsePaidField(visit.paid);
				let paymentDisplay = '';
				
				if (paidInfo.status === 'paid') {
					paymentDisplay = `
						<div style="color: #27ae60; font-weight: bold;">
							✅ שולם
							${paidInfo.date ? `<div style="font-size: 11px; color: #666;">${formatDate(paidInfo.date)}</div>` : ''}
						</div>
					`;
				} else if (paidInfo.status === 'partial') {
					const debt = (parseFloat(visit.amount) || 0) - paidInfo.amount;
					paymentDisplay = `
						<div style="color: #f39c12; font-weight: bold;">
							⚠️ חלקי: ${paidInfo.amount}₪
							<div style="font-size: 11px; color: #666;">חוב: ${debt}₪</div>
						</div>
					`;
				} else if (paidInfo.status === 'no_payment') {
					paymentDisplay = `<div style="color: #95a5a6;">🚫 ללא תשלום</div>`;
				} else {
					paymentDisplay = `<div style="color: #e74c3c; font-weight: bold;">❌ לא שולם</div>`;
				}
				
				mainRow.innerHTML = `
					<td>${formatDate(visit.date)}</td>
					<td><strong>${locationName}</strong></td>
					<td><span class="visit-type-badge visit-type-${visit.visit_type || 'other'}">${visit.visit_type || '-'}</span></td>
					<td style="color: #666;">-</td>
					<td><span class="duration-badge">${hours}ש</span></td>
					<td style="font-weight: bold; color: #27ae60; font-size: 15px;">${visit.amount || 0} ₪</td>
					<td>
						${paymentDisplay}
						<select class="payment-status-select" onchange="updatePaymentStatus('${visit.ID}', this.value)" style="margin-top: 5px; font-size: 12px;">
							<option value="">-- שנה סטטוס --</option>
							<option value="paid">✅ סמן כשולם</option>
							<option value="partial">⚠️ תשלום חלקי</option>
							<option value="unpaid">❌ לא שולם</option>
							<option value="no_payment">🚫 ללא תשלום</option>
						</select>
					</td>
					<td>
						<button onclick="addPaymentForVisit('${visit.ID}')" class="icon-btn" title="הוסף תשלום" style="background: #27ae60; color: white;">💰</button>
						<button onclick="editVisit('${visit.ID}')" class="icon-btn" title="ערוך">✏️</button>
						<button onclick="deleteVisit('${visit.ID}')" class="icon-btn" title="מחק">🗑️</button>
						<button onclick="toggleVisitDetails('${visit.ID}')" class="icon-btn" title="פרטים">ℹ️</button>
					</td>
				`;
				fragment.appendChild(mainRow);
				
				// Details row (collapsed by default)
				const detailsRow = document.createElement('tr');
				detailsRow.id = `details-${visit.ID}`;
				detailsRow.className = 'details-row';
				detailsRow.style.display = 'none';
				detailsRow.innerHTML = `
					<td colspan="8">
						<div class="visit-details-content">
							<div><strong>עבודה שבוצעה:</strong> ${visit.work_done || 'לא צוין'}</div>
							<div><strong>שעת התחלה:</strong> ${visit.start_time || '-'} | <strong>שעת סיום:</strong> ${visit.end_time || '-'}</div>
							<div><strong>עובדים:</strong> ${visit.num_workers || 1}</div>
							<div><strong>הוצאה:</strong> ${visit.expense || 0} ₪</div>
							<div><strong>הערות:</strong> ${visit.notes || 'אין'}</div>
						</div>
					</td>
				`;
				fragment.appendChild(detailsRow);
			});
			
			tbody.appendChild(fragment);
			console.log(`📊 הוצגו ${filteredVisits.length} טיפולים`);
		}

		// הוסף פונקציה חדשה להצגת פירוט עלויות:
		function getVisitCostBreakdown(visit) {
			if (!visit.duration_minutes) return '<span style="font-size: 11px; color: #999;">ללא פירוט</span>';
			
			const hours = (visit.duration_minutes / 60).toFixed(2);
			const workers = visit.num_workers || 1;
			const expense = visit.expense || 0;
			
			let breakdown = `${hours}ש`;
			if (workers > 1) breakdown += ` × ${workers}ע`;
			if (expense > 0) breakdown += ` + ₪${expense}`;
			
			return `<span style="font-size: 11px; color: #666;">${breakdown}</span>`;
		}

		

		// טעינה ראשונית של הטאב
		function loadVisitsHistory() {
			loadFilterOptions();
			
			// הגדרת סינון ברירת מחדל - חודש אחרון
			setDefaultDateFilter();
			
			// טעינה עם סינון מהחודש האחרון
			applyVisitFilters();
		}

		// פונקציה חדשה להגדרת תאריכי ברירת מחדל
		function setDefaultDateFilter() {
			const today = new Date();
			const lastMonth = new Date();
			lastMonth.setMonth(today.getMonth() - 1);
			
			// הגדרת תאריכים בשדות הסינון
			const dateFromInput = document.getElementById('filterDateFrom');
			const dateToInput = document.getElementById('filterDateTo');
			
			if (dateFromInput && dateToInput) {
				dateFromInput.value = lastMonth.toISOString().split('T')[0];
				dateToInput.value = today.toISOString().split('T')[0];
			}
		}

		async function editVisit(visitId) {
			console.log(`✅ editVisit ('${visitId}') `);
			const visit = visits.find(v => v.ID == visitId);
			if (!visit) {
				showToast('ביקור לא נמצא', 'error');
				return;
			}
			
			console.log(`✅ editVisit second: ('${visitId}') `);
			
			// מצא את הלקוח
			const location = locations.find(loc => loc.ID == visit.location_id);
			const locationName = location ? location.name : 'לקוח לא נמצא';
			
			// צור חלון עריכה
			const editModalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">✏️ עריכת ביקור - ${locationName}</h3>
					
					<form id="editVisitForm">
						<div class="form-group">
							<label>תאריך:</label>
							<input type="date" id="editVisitDate" value="${visit.date}" required>
						</div>
						
						<div class="form-group">
							<label>סוג טיפול:</label>
							<select id="editVisitType">
								<option value="מלא" ${visit.visit_type === 'מלא' ? 'selected' : ''}>מלא</option>
								<option value="חלקי" ${visit.visit_type === 'חלקי' ? 'selected' : ''}>חלקי</option>
								<option value="ביקורת" ${visit.visit_type === 'ביקורת' ? 'selected' : ''}>ביקורת</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>עבודה שבוצעה:</label>
							<textarea id="editWorkDone" rows="3">${visit.work_done || ''}</textarea>
						</div>
						
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
							<div class="form-group">
								<label>שעת התחלה:</label>
								<div style="display: flex; gap: 5px; align-items: center;">
									<input type="time" id="editStartTime" value="${visit.start_time || ''}" style="flex: 1;" onchange="calculateEditDuration()">
									<button type="button" onclick="setCurrentTime('editStartTime')" title="קבע שעה נוכחית"
											style="background: #007bff; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; width: 36px; height: 36px;">🕐</button>
								</div>
							</div>
							
							<div class="form-group">
								<label>שעת סיום:</label>
								<div style="display: flex; gap: 5px; align-items: center;">
									<input type="time" id="editEndTime" value="${visit.end_time || ''}" style="flex: 1;" onchange="calculateEditDuration()">
									<button type="button" onclick="setCurrentTime('editEndTime')" title="קבע שעה נוכחית"
											style="background: #007bff; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; width: 36px; height: 36px;">🕐</button>
								</div>
							</div>
						</div>
						
						<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
							<div class="form-group">
								<label>שעות:</label>
								<input type="number" id="editDurationHours" min="0" max="24" value="${Math.floor((visit.duration_minutes || 0) / 60)}" onchange="updateEditManualDuration()">
							</div>
							
							<div class="form-group">
								<label>דקות:</label>
								<input type="number" id="editDurationMinutes" min="0" max="59" value="${(visit.duration_minutes || 0) % 60}" onchange="updateEditManualDuration()">
							</div>
							
							<div class="form-group">
								<label>סה"כ דקות:</label>
								<input type="number" id="editDuration" min="0" value="${visit.duration_minutes || 0}" onchange="updateEditFromTotalMinutes()">
							</div>
						</div>
						
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
							<div class="form-group">
								<label>שעות עשרוניות:</label>
								<input type="number" id="editCalculatedHours" step="0.1" value="${((visit.duration_minutes || 0) / 60).toFixed(1)}" readonly style="background: #f8f9fa;">
							</div>
							
							<div class="form-group">
								<label>מספר עובדים:</label>
								<input type="number" id="editNumWorkers" min="1" value="${visit.num_workers || 1}" onchange="calculateEditTreatmentCost()">
							</div>
						</div>
						
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
							<div class="form-group">
								<label>סכום (₪):</label>
								<input type="number" step="0.01" id="editAmount" value="${visit.amount || 0}">
							</div>

							<div class="form-group">
								<label>הוצאות (₪):</label>
								<input type="number" step="0.01" id="editExpense" value="${visit.expense || 0}" onchange="calculateEditTreatmentCost()">
							</div>
						</div>
						
						<div class="form-group">
							<label>סטטוס תשלום:</label>
							<select id="editPaid">
								<option value="לא שולם" ${(visit.paid === 'לא שולם' || visit.paid === '0') ? 'selected' : ''}>לא שולם</option>
								<option value="שולם" ${(visit.paid === 'שולם' || visit.paid === '1') ? 'selected' : ''}>שולם</option>
								<option value="שולם חלקית" ${(visit.paid === 'שולם חלקית' || visit.paid === '2') ? 'selected' : ''}>שולם חלקית</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>הערות:</label>
							<textarea id="editNotes" rows="3">${visit.notes || ''}</textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="button" onclick="saveEditedVisit('${visitId}')" class="btn btn-success">
								💾 שמור שינויים
							</button>
							<button type="button" onclick="closeEditModal()" class="btn btn-secondary">
								❌ ביטול
							</button>
						</div>
					</form>
				</div>
			`;
			
			// הצג את המודל
			showEditModal(editModalHTML);
			
			// ✅ אתחול ערכים מחושבים אחרי יצירת הטופס

			setTimeout(() => {
				// חישוב ערכים ראשוניים
				updateEditFromTotalMinutes();
				calculateEditTreatmentCost();
				
				// אם יש שעות התחלה וסיום, חשב את הזמן
				const startTime = document.getElementById('editStartTime').value;
				const endTime = document.getElementById('editEndTime').value;
				if (startTime && endTime) {
					calculateEditDuration();
				}
			}, 100);
		}

		// הצגת מודל עריכה (אם לא קיימת)
		function showEditModal(content) {
			// הסר מודל קיים אם יש
			const existingModal = document.getElementById('editModal');
			if (existingModal) {
				existingModal.remove();
			}
			
			// צור מודל חדש
			const modal = document.createElement('div');
			modal.id = 'editModal';
			modal.style.cssText = `
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.6);
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 10000;
				backdrop-filter: blur(3px);
			`;
			
			modal.innerHTML = content;
			
			// הוספה לעמוד
			document.body.appendChild(modal);
			
			// סגירה בלחיצה על הרקע
			modal.addEventListener('click', function(e) {
				if (e.target === modal) {
					closeEditModal();
				}
			});
			
			// ✅ תיקון הטעינה של זמנים - נוודא שלא נטען ערך לא תקין
			setTimeout(() => {
				const startTimeInput = document.getElementById('editStartTime');
				const endTimeInput = document.getElementById('editEndTime');
				
				if (startTimeInput && startTimeInput.value === '00:00') {
					startTimeInput.value = '';
				}
				
				if (endTimeInput && endTimeInput.value === '00:00') {
					endTimeInput.value = '';
				}
			}, 50);
		}

		// סגירת מודל עריכה
		function closeEditModal() {
			const modal = document.getElementById('editModal');
			if (modal) {
				modal.remove();
			}
		}

		// Add these functions after the editVisit function

		function calculateEditDuration() {
			const startTime = document.getElementById('editStartTime').value;
			const endTime = document.getElementById('editEndTime').value;
			
			// ✅ בדיקה משופרת לערכים תקינים
			if (!startTime || !endTime || startTime === '00:00' || endTime === '00:00') {
				return;
			}
			
			try {
				const start = new Date(`2000-01-01T${startTime}`);
				const end = new Date(`2000-01-01T${endTime}`);
				
				// בדיקה שהזמנים תקינים
				if (isNaN(start.getTime()) || isNaN(end.getTime())) {
					console.warn('Invalid time values detected');
					return;
				}
				
				if (end <= start) {
					showToast('שעת סיום חייבת להיות אחרי שעת התחלה', 'warning');
					return;
				}
				
				const diffMs = end - start;
				const totalMinutes = Math.round(diffMs / (1000 * 60));
				const hours = Math.floor(totalMinutes / 60);
				const minutes = totalMinutes % 60;
				const decimalHours = (totalMinutes / 60).toFixed(1);
				
				// עדכון השדות
				const durationHoursEl = document.getElementById('editDurationHours');
				const durationMinutesEl = document.getElementById('editDurationMinutes');
				const durationEl = document.getElementById('editDuration');
				const calculatedHoursEl = document.getElementById('editCalculatedHours');
				
				if (durationHoursEl) durationHoursEl.value = hours;
				if (durationMinutesEl) durationMinutesEl.value = minutes;
				if (durationEl) durationEl.value = totalMinutes;
				if (calculatedHoursEl) calculatedHoursEl.value = decimalHours;
				
				// חישוב עלות אוטומטי
				calculateEditTreatmentCost();
				
			} catch (error) {
				console.error('Error calculating duration:', error);
			}
		}

		function updateEditManualDuration() {
			const hours = parseInt(document.getElementById('editDurationHours').value) || 0;
			const minutes = parseInt(document.getElementById('editDurationMinutes').value) || 0;
			const totalMinutes = hours * 60 + minutes;
			const decimalHours = (totalMinutes / 60).toFixed(1);
			
			document.getElementById('editDuration').value = totalMinutes;
			document.getElementById('editCalculatedHours').value = decimalHours;
			
			calculateEditTreatmentCost();
		}

		function updateEditFromTotalMinutes() {
			const totalMinutes = parseInt(document.getElementById('editDuration').value) || 0;
			const hours = Math.floor(totalMinutes / 60);
			const minutes = totalMinutes % 60;
			const decimalHours = (totalMinutes / 60).toFixed(1);
			
			document.getElementById('editDurationHours').value = hours;
			document.getElementById('editDurationMinutes').value = minutes;
			document.getElementById('editCalculatedHours').value = decimalHours;
			
			calculateEditTreatmentCost();
		}

		function calculateEditTreatmentCost() {
			const totalMinutes = parseInt(document.getElementById('editDuration').value) || 0;
			const numWorkers = parseInt(document.getElementById('editNumWorkers').value) || 1;
			const expense = parseFloat(document.getElementById('editExpense').value) || 0;
			
			if (totalMinutes > 0 && costSettings && costSettings.hourlyRate) {
				const hours = totalMinutes / 60;
				const baseCost = costSettings.hourlyRate * hours;
				const workersCost = (numWorkers - 1) * costSettings.workerCost * hours;
				const laborCost = baseCost + workersCost;
				const totalCost = laborCost + expense; // ✅ עכשיו כולל גם הוצאות!
				
				document.getElementById('editAmount').value = Math.round(totalCost);
			}
		}
		
		// פונקציה לעדכון הביקור בענן
		async function updateVisitInCloud(updatedVisit) {
			if (!await validateToken()) return;
			
			try {
				// קריאת כל הנתונים מהענן
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Visits!A:N'
				});
				
				const rows = response.result.values || [];
				
				// מציאת השורה לעדכון
				let rowToUpdate = -1;
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] == updatedVisit.ID) {
						rowToUpdate = i + 1; // +1 כי Google Sheets מתחיל מ-1
						break;
					}
				}
				
				if (rowToUpdate > 0) {
					// עדכון השורה
					const updatedRow = [
					updatedVisit.ID,
					updatedVisit.date,
					updatedVisit.location_id,
					updatedVisit.location_name || '',
					updatedVisit.visit_type,
					updatedVisit.work_done,
					updatedVisit.duration_minutes,
					updatedVisit.num_workers || 1,
					updatedVisit.start_time || '',
					updatedVisit.end_time || '',
					updatedVisit.amount,
					updatedVisit.paid || '0',  
					updatedVisit.expense,
					updatedVisit.notes
				];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Visits!A${rowToUpdate}:N${rowToUpdate}`,
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [updatedRow]
						}
					});
					
					console.log(`✅ Updated visit ${updatedVisit.ID} in cloud`);
				}
				
			} catch (error) {
				console.error('Error updating visit in cloud:', error);
				throw error;
			}
		}

		function deleteVisit(visitId) {
			console.log(`✅ deleteVisit ('${visitId}') `);
			if (confirm('האם אתה בטוח שברצונך למחוק את הטיפול?')) {
				visits = visits.filter(visit => visit.ID != visitId);
				applyVisitFilters(); // רענן תצוגה
				saveToLocalStorage();
				showToast('טיפול נמחק בהצלחה!', 'success');
			}
		}
	   
	   // תוספה - בדיקת רשאות
		async function checkPermissions() {
			if (!access_token) {
				showToast('לא מחובר לגוגל - התחבר קודם', 'warning');
				return false;
			}
			
			try {
				// נסה לגשת לטבלה הראשית
				await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				return true;
			} catch (error) {
				if (error.status === 401) {
					showToast('החיבור פג - התחבר מחדש', 'warning');
					access_token = null;
				} else if (error.status === 403) {
					showToast('אין הרשאה לטבלה - בדוק שיתוף', 'error');
				}
				return false;
			}
		}
	   
	   
	   // תוספה - בדיקה תקופתית של חיבור
		setInterval(async () => {
			if (access_token) {
				const isValid = await validateToken();
				if (!isValid) {
					console.log('Token expired - disconnected');
				}
			}
		}, 300000); // בדיקה כל 5 דקות
	   
	   // תוספה - חישוב שעות מדקות
		function updateHoursDisplay() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const hours = (minutes / 60).toFixed(2);
			document.getElementById('calculatedHours').value = hours > 0 ? hours : '';
		}
	   
	    // חישוב עלות טיפול מעודכן
		function calculateTreatmentCost() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const workers = parseInt(document.getElementById('numberOfWorkersVisit').value) || 1;
			const expense = parseFloat(document.getElementById('expense').value) || 0;
			
			if (minutes > 0) {
				const hours = minutes / 60;
				const baseCost = costSettings.hourlyRate * hours;
				// תיקון: עלות עובדים נוספים (לא כולל אותך)
				const workersCost = (workers - 1) * costSettings.workerCost * hours;
				const laborCost = baseCost + workersCost;
				const totalCost = laborCost + expense;
				
				// עדכן את שדה הסכום
				document.getElementById('amount').value = Math.round(totalCost);
				
				// הצג פירוט מפורט יותר
				let breakdown = `${hours.toFixed(2)} שעות × ₪${costSettings.hourlyRate} = ₪${Math.round(baseCost)}`;
				
				if (workers > 1) {
					breakdown += `\n+ ${workers - 1} עובדים × ₪${costSettings.workerCost}/שעה = ₪${Math.round(workersCost)}`;
				}
				
				if (expense > 0) {
					breakdown += `\n+ הוצאות: ₪${expense}`;
				}
				
				breakdown += `\n= סה"כ: ₪${Math.round(totalCost)}`;
				
				document.getElementById('costBreakdown').textContent = breakdown;
				document.getElementById('costBreakdown').style.whiteSpace = 'pre-line';
			} else {
				document.getElementById('costBreakdown').textContent = '';
			}
		}

		// הוסף חישוב אוטומטי כשמקלידים משך זמן
		function updateHoursDisplay() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const hours = minutes > 0 ? (minutes / 60).toFixed(2) : '';
			document.getElementById('calculatedHours').value = hours;
			
			// חשב עלויות אוטומטית
			calculateTreatmentCost();
		}

		// שמירת הגדרות עלות פשוטה יותר
		function saveCostSettings() {
			costSettings.hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 150;
			costSettings.workerCost = parseFloat(document.getElementById('workerCost').value) || 50;
			
			localStorage.setItem('cost_settings', JSON.stringify(costSettings));
			
			if (access_token) {
				saveSettingsToCloud().then(success => {
					if (success) {
						showToast('הגדרות עלות נשמרו בענן', 'success');
					} else {
						showToast('הגדרות נשמרו מקומית בלבד', 'warning');
					}
				});
			} else {
				showToast('הגדרות נשמרו מקומית', 'success');
			}
		}
	   
	   // תוספה - בדיקת טיפול כפול
		function checkDuplicateVisit(locationId, visitDate) {
			const existingVisit = visits.find(visit => 
				visit.location_id == locationId && 
				visit.date === visitDate
			);
			
			return existingVisit;
		}
	   
	   
	   // פונקציה לשמירת הגדרות לענן
		async function saveSettingsToCloud() {
			if (!await validateToken()) {
				return false;
			}
			
			try {
				const settingsData = [
					['Setting', 'Value'],
					['hourly_rate', costSettings.hourlyRate],
					['worker_cost', costSettings.workerCost],
					['last_updated', new Date().toISOString()]
				];
				
				await gapi.client.sheets.spreadsheets.values.clear({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A:B`
				});
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A1:B4`,
					valueInputOption: 'RAW',
					resource: { values: settingsData }
				});
				
				return true;
			} catch (error) {
				console.error('Error saving settings:', error);
				return false;
			}
		}

		// פונקציה לטעינת הגדרות מהענן
		async function loadSettingsFromCloud() {
			if (!await validateToken()) {
				return false;
			}
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A:B`
				});
				
				const rows = response.result.values || [];
				if (rows.length > 1) {
					rows.slice(1).forEach(row => {
						const [setting, value] = row;
						if (setting === 'hourly_rate') {
							costSettings.hourlyRate = parseFloat(value) || 150;
						}
						if (setting === 'worker_cost') {
							costSettings.workerCost = parseFloat(value) || 50;
						}
					});
					
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
					
					return true;
				}
			} catch (error) {
				console.error('Error loading settings:', error);
				return false;
			}
			
			return false;
		}
	   
	   // פונקציה חדשה לבדיקה ויצירת הטבלה הראשית
		async function findOrCreateMainSpreadsheet() {
			try {
				console.log('Searching for existing main spreadsheet...');
				
				// חיפוש טבלה קיימת
				const response = await gapi.client.request({
					path: 'https://www.googleapis.com/drive/v3/files',
					params: {
						q: `name='${SPREADSHEET_NAME}' and mimeType='application/vnd.google-apps.spreadsheet'`,
					}
				});
				
				if (response.result.files.length > 0) {
					console.log('Found existing spreadsheet');
					SPREADSHEET_ID = response.result.files[0].id;
					showToast('נמצאה טבלה קיימת!', 'success');
					
					// בדיקה ותיקון של מבנה הטבלה
					await checkAndFixTableStructure();
				} else {
					console.log('No spreadsheet found, creating new one...');
					await createNewMainSpreadsheet();
				}
				
			} catch (error) {
				console.error('Error in findOrCreateMainSpreadsheet:', error);
				showToast('שגיאה בחיפוש טבלה', 'error');
			}
		}

		// פונקציה חדשה ליצירת טבלה ראשית חדשה
		async function createNewMainSpreadsheet() {
			console.log('Creating new main spreadsheet...');
			try {
				const response = await gapi.client.request({
					path: 'https://sheets.googleapis.com/v4/spreadsheets',
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${access_token}`,
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						properties: {
							title: SPREADSHEET_NAME
						},
						sheets: [
							{ properties: { title: 'Locations' } },
							{ properties: { title: 'Visits' } },
							{ properties: { title: 'Receipts' } },
							{ properties: { title: 'SystemSettings' } }
						]
					})
				});
				
				SPREADSHEET_ID = response.result.spreadsheetId;
				
				// הוסף כותרות לכל הגיליונות
				await addAllHeaders();
				
				showToast('נוצרה טבלה חדשה!', 'success');
				
			} catch (error) {
				console.error('Error creating spreadsheet:', error);
				showToast('שגיאה ביצירת טבלה', 'error');
			}
		}
		

		// פונקציה חדשה לבדיקה ותיקון מבנה הטבלה
		async function checkAndFixTableStructure() {
			console.log('Checking and fixing table structure...');
			
			try {
				// בדיקת כותרות בכל גיליון - כולל החדשים
				const sheetsToCheck = ['Locations', 'Visits', 'Receipts', 'TelegramVisits', 'TelegramIncomes', 'Payments', 'PaymentVisitLink'];
				
				for (const sheetName of sheetsToCheck) {
					try {
						const response = await gapi.client.sheets.spreadsheets.values.get({
							spreadsheetId: SPREADSHEET_ID,
							range: `${sheetName}!A1:A1`
						});
						
						if (!response.result.values || !response.result.values[0][0]) {
							console.log(`Headers missing in ${sheetName}, adding them...`);
							await addHeadersToSheet(sheetName);
						}
					} catch (error) {
						console.log(`Sheet ${sheetName} missing or error, will add headers:`, error);
						await addHeadersToSheet(sheetName);
					}
				}
				
				console.log('✅ Table structure verified');
				
			} catch (error) {
				console.log('Headers check failed, will force add them:', error);
				await addAllHeaders();
			}
		}
		
		// פונקציה חדשה להוספת כותרות לגיליון ספציפי
		async function addHeadersToSheet(sheetName) {
			const headersMap = {
				'Locations': ['ID', 'name', 'full_address', 'neighborhood', 'city', 'contact_person', 'phone', 'allowed_day', 'interval_weeks', 'temp_addition', 'base_amount', 'active', 'notes', 'last_visit', 'next_visit'],
				'Visits': ['ID', 'date', 'location_id', 'location_name', 'visit_type', 'work_done', 'duration_minutes', 'num_workers', 'start_time', 'end_time', 'amount', 'paid', 'expense', 'notes'],  // ✅ ADDED: 'paid' field
				'Receipts': ['ID', 'book_number', 'receipt_number', 'date', 'location_id', 'location_name', 'amount', 'payment_type', 'notes'],
				'TelegramVisits': ['message_id', 'date', 'text', 'processed', 'location_id', 'visit_id'],
				'TelegramIncomes': ['message_id', 'date', 'text', 'processed', 'receipt_id'],
				'Payments': ['ID', 'date', 'client_id', 'client_name', 'amount', 'payment_method', 'notes', 'reference', 'check_date'],	
				'PaymentVisitLink': ['ID', 'payment_id', 'visit_id', 'amount_allocated']
			};
			
			const headers = headersMap[sheetName];
			if (!headers) {
				console.error(`No headers defined for sheet: ${sheetName}`);
				return;
			}
			
			try {
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `${sheetName}!A1:${String.fromCharCode(64 + headers.length)}1`,
					valueInputOption: 'RAW',
					resource: {
						values: [headers]
					}
				});
				console.log(`✅ Headers added to ${sheetName}`);
			} catch (error) {
				console.error(`Error adding headers to ${sheetName}:`, error);
			}
		}
		
		// פונקציה משופרת להוספת כותרות לכל הגיליונות
		async function addAllHeaders() {
			try {
				console.log('Adding headers to all sheets...');
				
				await addHeadersToSheet('Locations');
				await addHeadersToSheet('Visits');
				await addHeadersToSheet('Receipts');
				await addHeadersToSheet('Payments');           
				await addHeadersToSheet('PaymentVisitLink');   
				await addHeadersToSheet('TelegramVisits');     
				await addHeadersToSheet('TelegramIncomes');    
				
				// הוספת כותרות ל-SystemSettings
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'SystemSettings!A1:B1',
					valueInputOption: 'RAW',
					values: [['setting_key', 'setting_value']]
				});
				
				console.log('✅ All headers added successfully');
				
			} catch (error) {
				console.error('Error adding all headers:', error);
			}
		}
	   
	   async function importFromHelperTable() {
			if (!await validateToken()) {
				showToast('התחבר לגוגל קודם', 'warning');
				return;
			}
			
			const importTableId = localStorage.getItem('importTableId');
			if (!importTableId) {
				showToast('לא נמצא ID של טבלת העזר', 'warning');
				return;
			}
			
			console.log('🔍 Import Table ID:', importTableId); // לוג חדש
			
			try {
				showLoading('מייבא נתונים מטבלת העזר...');
				
				let importedCount = 0;
				
				// ייבוא מיקומים
				try {
					console.log('📍 Starting locations import...'); // לוג חדש
					
					const locationsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Locations!A2:O1000'
					});
					
					console.log('📍 Locations response:', locationsResponse.result); // לוג חדש
					
					if (locationsResponse.result.values && locationsResponse.result.values.length > 0) {
						console.log('📍 Found', locationsResponse.result.values.length, 'location rows'); // לוג חדש
						
						for (const row of locationsResponse.result.values) {
							if (row[0] && row[1]) {
								const locationData = parseLocationFromRow(row);
								locations.push(locationData);
								importedCount++;
								
								await new Promise(resolve => setTimeout(resolve, 200));
							}
						}
						showToast(`יובאו ${importedCount} מיקומים`, 'success');
					} else {
						console.log('📍 No locations data found'); // לוג חדש
					}
				} catch (error) {
					console.error('📍 Locations import error:', error); // לוג חדש
				}
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				// ייבוא ביקורים
				try {
					console.log('🔧 Starting visits import...');
					
					const visitsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Visits!A2:M1000'
					});
					
					console.log('🔧 Visits response:', visitsResponse.result);
					
					let visitsCount = 0;
					if (visitsResponse.result.values && visitsResponse.result.values.length > 0) {
						console.log('🔧 Found', visitsResponse.result.values.length, 'visit rows');
						
						for (let i = 0; i < visitsResponse.result.values.length; i++) {
							const row = visitsResponse.result.values[i];
							if (row[0] && row[1]) {
								const visitData = parseVisitFromRow(row);
								if (!isDuplicateVisit(visitData)) {
									visits.push(visitData);
									// עדכון תאריכי טיפול לאחר הוספת ביקור חדש
									//await updateSingleLocationTreatmentDates(visitData.location_id);
									visitsCount++;
								} else {
									console.log('⚠️ Duplicate visit skipped:', visitData.date, visitData.location_id);
								}
								visitsCount++;
								
								// הצג התקדמות כל 50 רשומות
								if (visitsCount % 50 === 0) {
									console.log(`🔧 Processed ${visitsCount}/${visitsResponse.result.values.length} visits`);
									showToast(`מעבד ביקור ${visitsCount}...`, 'info', 1000);
								}
								
								await new Promise(resolve => setTimeout(resolve, 100)); // המתנה קצרה יותר
							}
						}
						showToast(`יובאו ${visitsCount} ביקורים`, 'success');
					} else {
						console.log('🔧 No visits data found');
					}
				} catch (error) {
					console.error('🔧 Visits import error:', error);
				}
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				// ייבוא קבלות
				try {
					console.log('🧾 Starting receipts import...');
					
					const receiptsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Receipts!A2:J1000'
					});
					
					console.log('🧾 Receipts response:', receiptsResponse.result);
					
					let receiptsCount = 0;
					if (receiptsResponse.result.values && receiptsResponse.result.values.length > 0) {
						console.log('🧾 Found', receiptsResponse.result.values.length, 'receipt rows');
						
						for (let i = 0; i < receiptsResponse.result.values.length; i++) {
							const row = receiptsResponse.result.values[i];
							if (row[0] && row[3]) { // ID ותאריך
								const receiptData = parseReceiptFromRow(row);
								
								
								if (!isDuplicateReceipt(receiptData)) {
									receipts.push(receiptData);
									receiptsCount++;
								} else {
									console.log('⚠️ Duplicate receipt skipped:', receiptData.date, receiptData.location_id);
								}
								
								// הצג התקדמות כל 25 רשומות (קבלות בדרך כלל פחות)
								if (receiptsCount % 25 === 0) {
									console.log(`🧾 Processed ${receiptsCount}/${receiptsResponse.result.values.length} receipts`);
									showToast(`מעבד קבלה ${receiptsCount}...`, 'info', 1000);
								}
								
								await new Promise(resolve => setTimeout(resolve, 100)); // המתנה קצרה יותר
							}
						}
						showToast(`יובאו ${receiptsCount} קבלות`, 'success');
					} else {
						console.log('🧾 No receipts data found');
					}
				} catch (error) {
					console.error('🧾 Receipts import error:', error);
				}
				
				// שמירה מקומית ועדכון תצוגה
				saveToLocalStorage();
				loadLocationsTable();
				loadReceiptsTable();
				loadFilterOptions();

				// בדיקה שהנתונים נטענו נכון
				console.log('🔍 בדיקת ייבוא:');
				console.log(`לקוחות: ${locations.length}`);
				console.log(`ביקורים: ${visits.length}`);
				console.log(`קבלות: ${receipts.length}`);

				// הצג דוגמה של הרשומה הראשונה מכל סוג
				if (locations.length > 0) {
					console.log('דוגמה לקוח:', locations[0]);
				}
				if (visits.length > 0) {
					console.log('דוגמה ביקור:', visits[0]);
				}


				// תוספה חשובה - שמירה לענן!
				showToast('שומר נתונים חדשים לענן...', 'info');

				try {
					/// await saveAllToSheets();
					/// await saveAllToSheetsOptimized();
					
					// שמירה מהירה לפי סוג נתונים
					const locationSuccess = await saveLocationsBatch(newLocations || []);
					const visitSuccess = await saveVisitsBatch(newVisits || []);  
					const receiptSuccess = await saveReceiptsBatch(newReceipts || []);

					if (locationSuccess && visitSuccess && receiptSuccess) {
						showToast('🚀 שמירה מהירה הושלמה בהצלחה!', 'success');
					} else {
						showToast('⚠️ חלק מהנתונים לא נשמרו לענן', 'warning');
					}

					showToast(`🎉 ייבוא הושלם בהצלחה!
					📍 ${locationsCount || 0} מיקומים
					🔧 ${visitsCount || 0} ביקורים  
					🧾 ${receiptsCount || 0} קבלות
					✅ הכל נשמר לענן!`, 'success', 6000);
				} catch (error) {
					console.error('Error saving imported data to cloud:', error);
					showToast('ייבוא הושלם מקומית, אבל שגיאה בשמירה לענן', 'warning');
				}
				
			} catch (error) {
				console.error('Import error:', error);
				showToast('שגיאה בייבוא נתונים', 'error');
			} finally {
				hideLoading();
			}
		}

	
		// פונקציות עזר לפרסור שורות
		function parseVisitFromRow(row) {
			return {
				ID: row[0] || generateID(),
				date: row[1] || '',
				location_id: row[2] || '',
				location_name: row[3] || '',
				visit_type: row[4] || '',
				work_done: row[5] || '',
				duration_minutes: parseInt(row[6]) || 0,
				num_workers: parseInt(row[7]) || 1,
				start_time: row[8] || '',
				end_time: row[9] || '',
				amount: parseFloat(row[10]) || 0,
				paid: (row[11] === 'כן' || row[11] === 'yes' || row[11] === '1') ? '1' : '0',
				expense: parseFloat(row[12]) || 0,
				notes: row[13] || ''
			};
		}



		function parseReceiptFromRow(row) {
			return {
				ID: row[0] || generateID(),
				booklet_number: row[1] || '',
				receipt_number: row[2] || '',
				date: row[3] || '',
				location_id: row[4] || '',
				location_name: row[5] || '',
				amount: parseFloat(row[6]) || 0,
				payment_type: row[7] || '',
				tax_code: row[8] || '',
				notes: row[9] || ''
			};
		}
	   
	   // הוסף את זה לסוף הקוד
		function updateImportTableStatus() {
			const importTableId = localStorage.getItem('importTableId');
			const statusDiv = document.getElementById('importTableStatus');
			
			if (importTableId && statusDiv) {
				statusDiv.innerHTML = `
					<span style="font-size: 13px; color: #28a745;">
						✅ טבלת עזר זמינה: 
						<a href="https://docs.google.com/spreadsheets/d/${importTableId}/edit" 
						   target="_blank" style="color: #007bff; text-decoration: underline;">
						   פתח טבלה
						</a>
					</span>
					<br>
					<button onclick="localStorage.removeItem('importTableId'); updateImportTableStatus();" 
							style="background: none; border: none; color: #dc3545; font-size: 12px; cursor: pointer; margin-top: 5px;">
						🗑️ מחק קישור לטבלת עזר
					</button>
				`;
			} else if (statusDiv) {
				statusDiv.innerHTML = `
					<span style="font-size: 13px; color: #666;">
						❌ לא נמצאה טבלת עזר שמורה
					</span>
					<br>
					<span style="font-size: 12px; color: #999;">
						צור טבלת עזר חדשה כדי לייבא נתונים
					</span>
				`;
			}
		}

		// הרץ את זה כשהדף נטען
		document.addEventListener('DOMContentLoaded', function() {
			updateImportTableStatus();
		});

		// הרץ גם כשעוברים לטאב המערכת
		function showTab(event, tabName) {
			// הקוד הקיים שלך...
			
			// הוסף את זה בסוף הפונקציה
			if (tabName === 'system') {
				setTimeout(() => {
					updateImportTableStatus();
					updateTelegramHelperStatus(); // הוסף שורה זו
				}, 100);
			}
		}
	   
	   


		// הוסף פונקציה להצגת מידע על טבלת עזר טלגרם
		function updateTelegramHelperStatus() {
			const telegramTableId = localStorage.getItem('telegramHelperTableId');
			const statusDiv = document.getElementById('telegramHelperStatus');
			
			if (statusDiv) {
				if (telegramTableId) {
					statusDiv.innerHTML = `
						<span style="color: green;">✓ טבלת עזר טלגרם מוכנה</span>
						<br>
						<a href="https://docs.google.com/spreadsheets/d/${telegramTableId}" target="_blank" style="font-size: 12px;">
							פתח בגוגל שיטס
						</a>
					`;
				} else {
					statusDiv.innerHTML = `
						<span style="color: orange;">⚠ לא נמצאה טבלת עזר טלגרם</span>
						<br>
						<span style="font-size: 12px;">צור טבלה חדשה תחילה</span>
					`;
				}
			}
		}


		// פונקציה עזר לסיום ביקור
		function finalizeVisit(visit, pendingNotes) {
			const client = visit.client;
			
			// אם לא נמצא זמן, נסה לחשב מהשעות או קבע ברירת מחדל
			if (visit.duration === 0) {
				if (visit.time) {
					// כאן אפשר להוסיף לוגיקה לחישוב זמן מהפרש שעות
					visit.duration = 60; // ברירת מחדל של שעה
				} else {
					visit.duration = 60;
				}
			}
			
			// פורמט שמתאים בדיוק לקוד הקיים של confirmTelegramImport
			return {
				date: visit.date,
				time: visit.time || '',
				client_name: client ? client.name : 'לא זוהה',
				client_id: client ? client.ID : null,
				address: client ? client.full_address : '',
				work_done: visit.workDescription.join(' '),
				duration_minutes: visit.duration,
				raw_text: visit.workDescription.join('\n') + '\n' + [...visit.notes, ...pendingNotes].join('\n')
			};
		}

		// פונקציות עזר לזיהוי דפוסים
		function isDateLine(line) {
			// זיהוי תאריך כמו "15 August 2024"
			const dateRegex = /^\d{1,2}\s+[A-Za-z]+\s+\d{4}$/;
			return dateRegex.test(line);
		}

		function isTimeLine(line) {
			// זיהוי שעה כמו "13:39"
			const timeRegex = /^\d{1,2}:\d{2}$/;
			return timeRegex.test(line);
		}

		function parseTelegramDate(dateStr) {
			// המר "15 August 2024" ל-"2024-08-15"
			const months = {
				'January': '01', 'February': '02', 'March': '03', 'April': '04',
				'May': '05', 'June': '06', 'July': '07', 'August': '08',
				'September': '09', 'October': '10', 'November': '11', 'December': '12'
			};
			
			const parts = dateStr.split(' ');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = months[parts[1]] || '01';
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			
			return '';
		}



		// פונקציה עזר למציאת לקוח לפי שם
		function findLocationByName(customerName) {
			if (!customerName) return null;
			
			return locations.find(loc => 
				loc.name && loc.name.toLowerCase().includes(customerName.toLowerCase())
			) || null;
		}


		// פונקציה משופרת לזיהוי לקוחות - תחליף את findClientInText הקיימת
		function findClientSmart(text, locations) {
			if (!text || !locations) return null;
			
			const textLower = text.toLowerCase().trim();
			
			// שלב 1: התאמה ישירה מלאה
			//for (const location of locations) {
			//	if (location.name && textLower.includes(location.name.toLowerCase())) {
			//		return location;
			//	}
			//	if (location.full_address && textLower.includes(location.full_address.toLowerCase())) {
			//		return location;
			//	}
			//}
			
			// שלב 2: זיהוי לפי רחוב + מספר (עם או בלי עיר)
			const addressMatch = textLower.match(/([א-ת\s']+)\s+(\d+)/);
			if (addressMatch) {
				const street = addressMatch[1].trim();
				const number = addressMatch[2];
				
				for (const location of locations) {
					if (location.name) {
						const locationParts = location.name.toLowerCase().split(' ');
						if (locationParts.length >= 2) {
							const locationStreet = locationParts[0];
							const locationNumber = locationParts[1];
							
							if (street.includes(locationStreet) && number === locationNumber) {
								return location;
							}
						}
					}
				}
			}
			
			// שלב 3: זיהוי שמות חלקיים (כמו "ויניק" במקום "ויניק 49 ראשלצ")
			const words = textLower.split(/\s+/);
			for (const word of words) {
				if (word.length >= 3) { // רק מילים של 3 אותיות או יותר
					for (const location of locations) {
						if (location.name && location.name.toLowerCase().startsWith(word)) {
							// וודא שזה השם היחיד שמתחיל כך
							const matches = locations.filter(loc => 
								loc.name && loc.name.toLowerCase().startsWith(word)
							);
							if (matches.length === 1) {
								return location;
							}
						}
					}
				}
			}
			
			// שלב 4: זיהוי לפי רחוב בלבד (לשמות ידועים)
			for (const word of words) {
				if (word.length >= 4) {
					for (const location of locations) {
						if (location.name) {
							const locationStreet = location.name.toLowerCase().split(' ')[0];
							if (locationStreet === word) {
								return location;
							}
						}
					}
				}
			}
			
			return null;
		}


		// פונקציה משופרת לחילוץ זמנים - תחליף את extractDuration הקיימת
		function extractTimeFromText(text) {
			if (!text) return 0;
			
			const textLower = text.toLowerCase().trim();
			
			// דפוס 1: מספר + "שעות"
			let match = textLower.match(/(\d+(?:\.\d+)?)\s*שעות/);
			if (match) {
				return Math.round(parseFloat(match[1]) * 60);
			}
			
			// דפוס 2: "שעתיים" עם וריאציות
			if (textLower.includes('שעתיים')) {
				if (textLower.includes('וחצי')) return 150;
				if (textLower.includes('ורבע')) return 135;
				if (textLower.includes('ושלושת רבעי')) return 165;
				return 120;
			}
			
			// דפוס 3: "שעה" עם וריאציות
			if (textLower.includes('שעה') && !textLower.includes('שעות')) {
				if (textLower.includes('וחצי')) return 90;
				if (textLower.includes('ורבע')) return 75;
				if (textLower.includes('ושלושת רבעי')) return 105;
				return 60;
			}
			
			// דפוס 4: "חצי שעה", "רבע שעה"
			if (textLower.includes('חצי שעה')) return 30;
			if (textLower.includes('רבע שעה')) return 15;
			
			// דפוס 5: מספר עשרוני עם שעות (כמו "1.75 שעות")
			match = textLower.match(/(\d+\.\d+)\s*שעה/);
			if (match) {
				return Math.round(parseFloat(match[1]) * 60);
			}
			
			// דפוס 6: כמויות מילוליות
			if (textLower.includes('כשעתיים')) return 120;
			if (textLower.includes('כשעה')) return 60;
			if (textLower.includes('כמעט שעתיים')) return 115;
			if (textLower.includes('כמעט שעה')) return 55;
			
			// דפוס 7: דקות
			match = textLower.match(/(\d+)\s*דק/);
			if (match) {
				return parseInt(match[1]);
			}
			
			// דפוס 8: ביטויים מיוחדים
			if (textLower.includes('לפני רבע שעה')) return 15;
			if (textLower.includes('לפני חצי שעה')) return 30;
			if (textLower.includes('לפני כשעה')) return 60;
			
			// דפוס 9: מספרים עם נקודה (כמו "2.5" או "3.25")
			match = textLower.match(/(\d+)\.(\d+)/);
			if (match) {
				const hours = parseInt(match[1]);
				const fraction = parseInt(match[2]);
				if (fraction === 5) return hours * 60 + 30; // .5 = חצי שעה
				if (fraction === 25) return hours * 60 + 15; // .25 = רבע שעה
				if (fraction === 75) return hours * 60 + 45; // .75 = שלושת רבעי שעה
			}
			
			// דפוס 10: טווחי זמן (כמו "2-3 שעות")
			match = textLower.match(/(\d+)-(\d+)\s*שעות/);
			if (match) {
				const avg = (parseInt(match[1]) + parseInt(match[2])) / 2;
				return Math.round(avg * 60);
			}
			
			return 0;
		}
	
		
		// פונקציה לזיהוי האם שורה מציינת תחילת ביקור חדש
		function isNewVisitStart(text, locations) {
			if (!text) return false;
			
			const textLower = text.toLowerCase().trim();
			
			// זיהוי ישירות של לקוח
			if (findClientSmart(text, locations)) return true;
			
			// דפוסי כתובות ישראליות
			if (/[א-ת\s']+\s+\d+/.test(text)) return true;
			
			// מילות מפתח שמציינות התחלת עבודה
			const startKeywords = [
				'מתחיל', 'התחלתי', 'מתחילים',
				'יציאה', 'הגעתי', 'נוסע ל',
				'בדיקת השקיה', 'טיפול ראשוני',
				'החלפת', 'התקנת', 'תיקון'
			];
			
			for (const keyword of startKeywords) {
				if (textLower.includes(keyword)) return true;
			}
			
			// זיהוי לפי שמות גנים/אזורים מוכרים
			const gardenKeywords = [
				'מבצע נחשון', 'מבצע משה', 'המרגנית',
				'אזר', 'גן יבנה', 'שיינקין'
			];
			
			for (const keyword of gardenKeywords) {
				if (textLower.includes(keyword.toLowerCase())) return true;
			}
			
			return false;
		}

		// פונקציה לזיהוי האם שורה מציינת סיום ביקור
		function isVisitEnd(text) {
			if (!text) return false;
			
			const textLower = text.toLowerCase().trim();
			
			// מילות סיום מפורשות
			if (textLower.includes('סיום') || textLower.includes('סיימתי')) return true;
			
			// ביטויי זמן שמציינים סיום
			if (textLower.includes('שעות') || textLower.includes('שעה')) {
				// אם יש זמן + ביטוי סיכום
				if (textLower.includes('סהכ') || textLower.includes('עד כה') || 
					textLower.includes('כולל') || textLower.includes('לקח')) {
					return true;
				}
			}
			
			// ביטויי מעבר לביקור הבא
			if (textLower.includes('נוסע ל') || textLower.includes('עובר ל') ||
				textLower.includes('ממשיך ל') || textLower.includes('הביתה')) {
				return true;
			}
			
			// הפסקות שמסיימות ביקור
			if (textLower.includes('הפסקה בבית') || textLower.includes('בבית')) {
				return true;
			}
			
			return false;
		}

		// פונקציה לזיהוי הערות שכדאי לשמור
		function extractNotes(text) {
			if (!text) return '';
			
			const textLower = text.toLowerCase();
			let notes = [];
			
			// הערות על תשלום
			if (textLower.includes('קיבלתי') && /\d+/.test(text)) {
				notes.push(text);
			}
			
			// הערות על המשך עבודה
			if (textLower.includes('לחזור') || textLower.includes('להמשיך') ||
				textLower.includes('נשאר') || textLower.includes('צריך')) {
				notes.push(text);
			}
			
			// בעיות או תקלות
			if (textLower.includes('בעיה') || textLower.includes('תקלה') ||
				textLower.includes('לא עובד') || textLower.includes('נשבר')) {
				notes.push(text);
			}
			
			// הערות על מזג אוויר או תנאים
			if (textLower.includes('גשם') || textLower.includes('חום') ||
				textLower.includes('רטוב') || textLower.includes('יבש')) {
				notes.push(text);
			}
			
			return notes.join(' | ');
		}
		
	

		// אישור ייבוא הביקורים מטלגרם - גירסה מעודכנת
		async function confirmTelegramImport() {
			if (!window.pendingTelegramVisits || window.pendingTelegramVisits.length === 0) {
				showToast('אין ביקורים לייבוא', 'warning');
				return;
			}
			
			try {
				showLoading('מייבא ביקורים מטלגרם...');
				
				// שלב 1: שמור לטבלת TelegramVisits (זמני)
				const telegramVisitsWithIds = window.pendingTelegramVisits.map(visit => ({
					...visit,
					ID: generateID()
				}));
				
				await saveTelegramVisitsToCloud(telegramVisitsWithIds);
				
				// שלב 2: המר לביקורים רגילים במערכת
				let importedCount = 0;
				
				for (const telegramVisit of telegramVisitsWithIds) {
					// מצא או צור לקוח
					let locationId = null;
					const existingLocation = locations.find(loc => 
						loc.name.toLowerCase() === telegramVisit.client_name.toLowerCase()
					);
					
					if (existingLocation) {
						locationId = existingLocation.ID;
					} else {
						// צור לקוח חדש אם לא קיים
						locationId = generateID();
						const newLocation = {
							ID: locationId,
							name: telegramVisit.client_name,
							full_address: '',
							neighborhood: '',
							city: '',
							contact_person: '',
							phone: '',
							allowed_day: 'א',
							interval_weeks: 4,
							temp_addition: false,
							base_amount: 0,
							active: true,
							notes: 'נוצר אוטומטית מייבוא טלגרם',
							last_visit: telegramVisit.date,
							next_visit: '',
							client_requests: ''
						};
						locations.push(newLocation);
					}
					
					// צור ביקור במערכת הראשית
					const visitData = {
						ID: generateID(),
						date: telegramVisit.date,
						location_id: locationId,
						location_name: telegramVisit.client_name,
						visit_type: 'מלא',  // ✅ FIX: Use correct visit type from your system
						work_done: telegramVisit.work_done,
						duration_minutes: telegramVisit.duration_minutes,
						num_workers: 1,
						start_time: telegramVisit.time || '',
						end_time: '',
						amount: 0,
						expense: 0,
						notes: `יובא מטלגרם: ${telegramVisit.raw_text}`
					};
					
					visits.push(visitData);
					importedCount++;
				}
				
				// שמור הכל
				saveToLocalStorage();
				
				// עדכן תצוגות
				loadLocationsTable();
				loadReceiptsTable();
				loadFilterOptions();
				
				// שמור לעלנן
				await saveAllToSheetsOptimized();
				
				hideLoading();
				closeModal();
				
				showToast(`🎉 ייבוא טלגרם הושלם!
		📱 ${importedCount} ביקורים יובאו
		💾 הכל נשמר לעלנן!`, 'success', 5000);
				
				// נקה את הנתונים הזמניים
				window.pendingTelegramVisits = null;
				
			} catch (error) {
				console.error('שגיאה בייבוא מטלגרם:', error);
				hideLoading();
				showToast('שגיאה בייבוא מטלגרם', 'error');
			}
		}

		


		function showModal(content) {
			// הסר מודל קיים אם יש
			const existingModal = document.getElementById('telegramModal');
			if (existingModal) {
				existingModal.remove();
			}
			
			// צור מודל
			const modal = document.createElement('div');
			modal.id = 'telegramModal';
			modal.style.cssText = `
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.5);
				display: flex;
				justify-content: center;
				align-items: center;
				z-index: 1000;
			`;
			
			modal.innerHTML = content;
			document.body.appendChild(modal);
			
			// סגירה בלחיצה על הרקע
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					closeModal();
				}
			});
		}

		function closeModal() {
			const modal = document.getElementById('telegramModal');
			if (modal) {
				modal.remove();
			}
		}
	   
	    function generateID() {
			return Date.now() + Math.random().toString(36).substr(2, 9);
		}
	   
	   
	   async function saveAllToSheetsOptimized() {
			if (!await validateToken()) {
				showToast('נדרש חיבור לענן', 'warning');
				return false;
			}
			
			try {
				await checkAndFixTableStructure();
				
				// שמירת כל הטבלאות
				const locationSuccess = locations.length > 0 ? await saveLocationsBatch(locations) : true;
				const visitSuccess = visits.length > 0 ? await saveVisitsBatch(visits) : true;
				const receiptSuccess = receipts.length > 0 ? await saveReceiptsBatch(receipts) : true;
				const incomeSuccess = incomes.length > 0 ? await saveIncomesBatch(incomes) : true;
				const paymentSuccess = payments.length > 0 ? await savePaymentsBatch(payments) : true;
				const linkSuccess = paymentVisitLinks.length > 0 ? await savePaymentVisitLinksBatch(paymentVisitLinks) : true;

				const allSaved = locationSuccess && visitSuccess && receiptSuccess && incomeSuccess && paymentSuccess && linkSuccess;
							

			if (allSaved) {
					showToast('✅ כל הנתונים נשמרו בהצלחה', 'success');
				} else {
					showToast('⚠️ חלק מהנתונים לא נשמרו', 'warning');
				}
				
				return allSaved;
				
			} catch (error) {
				console.error('Error saving all data:', error);
				showToast('שגיאה בשמירת נתונים', 'error');
				return false;
			}
		}
	   
	   // פונקציה להצגת חובות
		function displayDebts() {
			const container = document.getElementById('debtsContainer');
			if (!container) return;
			
			// Get filter values
			const sortBy = document.getElementById('debtSortBy')?.value || 'amount_desc';
			const minAmount = parseFloat(document.getElementById('minDebtAmount')?.value) || 0;
			const selectedDay = document.getElementById('debtDayFilter')?.value || '';
			const selectedClientId = document.getElementById('debtClientSearch')?.getAttribute('data-selected-id') || '';
			
			// ✅ UPDATED: Calculate debts with partial payment support
			const clientDebts = new Map();
			
			visits.forEach(visit => {
				if (visit.amount > 0) {
					const visitAmount = parseFloat(visit.amount) || 0;
					const paidAmount = getVisitPaidAmount(visit.ID);
					const debt = visitAmount - paidAmount;
					
					// Only show if there's actual debt
					if (debt > 0.01) { // Small threshold for rounding errors
						const clientId = visit.location_id;
						if (!clientDebts.has(clientId)) {
							clientDebts.set(clientId, {
								clientId: clientId,
								clientName: visit.location_name || 'לא ידוע',
								totalDebt: 0,
								visits: []
							});
						}
						
						const clientDebt = clientDebts.get(clientId);
						clientDebt.totalDebt += debt;
						
						const paidInfo = parsePaidField(visit.paid);
						clientDebt.visits.push({
							visitId: visit.ID,
							date: visit.date,
							amount: visitAmount,
							paidAmount: paidAmount,
							debt: debt,
							workDone: visit.work_done || '',
							paymentStatus: paidInfo.status
						});
					}
				}
			});
			
			// Convert to array
			let debtsArray = Array.from(clientDebts.values());
			
			// Apply filters
			if (minAmount > 0) {
				debtsArray = debtsArray.filter(d => d.totalDebt >= minAmount);
			}
			
			if (selectedClientId) {
				debtsArray = debtsArray.filter(d => d.clientId === selectedClientId);
			}
			
			if (selectedDay && selectedDay !== '') {
				debtsArray = debtsArray.filter(d => {
					const client = locations.find(loc => loc.ID === d.clientId);
					return client && client.allowed_day === selectedDay;
				});
			}
			
			// Sort
			debtsArray.sort((a, b) => {
				switch(sortBy) {
					case 'amount_desc': return b.totalDebt - a.totalDebt;
					case 'amount_asc': return a.totalDebt - b.totalDebt;
					case 'location': return a.clientName.localeCompare(b.clientName, 'he');
					case 'date_old': 
						return new Date(a.visits[0]?.date || '9999') - new Date(b.visits[0]?.date || '9999');
					case 'date_new':
						return new Date(b.visits[0]?.date || '0') - new Date(a.visits[0]?.date || '0');
					default: return 0;
				}
			});
			
			// Update statistics
			updateDebtStats(debtsArray);
			
			// Display debts
			if (debtsArray.length === 0) {
				container.innerHTML = '<div class="empty-state"><h3>🎉 אין חובות פתוחים!</h3></div>';
				return;
			}
			
			// ✅ UPDATED: Show partial payments in display
			const html = debtsArray.map(debt => `
				<div class="debt-card">
					<div class="debt-header">
						<h3>${debt.clientName}</h3>
						<div class="debt-total">${debt.totalDebt.toFixed(2)} ₪</div>
					</div>
					<div class="debt-visits">
						${debt.visits.map(v => `
							<div class="debt-visit-item">
								<span class="debt-date">${formatDate(v.date)}</span>
								<span class="debt-work">${v.workDone}</span>
								<span class="debt-amount">
									${v.amount} ₪
									${v.paymentStatus === 'partial' ? 
										`<span style="color: #f39c12; font-size: 11px;">(שולם: ${v.paidAmount}₪)</span>` : 
										''}
								</span>
							</div>
						`).join('')}
					</div>
					<div class="debt-actions">
						<button onclick="showAddPaymentModal('${debt.clientId}')" class="btn" style="background: #27ae60; color: white; flex: 1;">
							➕ הוסף תשלום
						</button>
						<button onclick="markClientDebtsPaid('${debt.clientId}')" class="btn-pay" style="flex: 1;">
							✓ סמן הכל כשולם
						</button>
						<button onclick="showClientTreatments('${debt.clientId}')" class="btn-payment" style="flex: 1;">
							📋 עבור לטיפולים
						</button>
					</div>
				</div>
			`).join('');
			
			container.innerHTML = html;
		}


		async function markClientDebtsPaid(clientId) {
			const clientName = locations.find(loc => loc.ID === clientId)?.name || 'הלקוח';
			
			if (!confirm(`האם לסמן את כל החובות של ${clientName} כשולמו?`)) {
				return;
			}
			
			// ✅ UPDATED: Mark as paid with today's date
			const today = new Date().toISOString().split('T')[0];
			let updatedCount = 0;
			
			visits.forEach(visit => {
				if (visit.location_id === clientId && visit.amount > 0) {
					const paidInfo = parsePaidField(visit.paid);
					
					// Only update if not already fully paid
					if (paidInfo.status !== 'paid' && paidInfo.status !== 'no_payment') {
						visit.paid = `paid:${today}`;
						updatedCount++;
					}
				}
			});
			
			if (updatedCount === 0) {
				showToast('אין חובות פתוחים ללקוח זה', 'info');
				return;
			}
			
			// Save locally
			saveToLocalStorage();
			
			// Save to cloud if connected
			if (access_token && SPREADSHEET_ID) {
				const success = await saveAllToSheetsOptimized();
				if (success) {
					showToast(`✅ ${updatedCount} טיפולים סומנו כשולמו ונשמרו בענן`, 'success');
				} else {
					showToast(`⚠️ ${updatedCount} טיפולים סומנו כשולמו מקומית בלבד`, 'warning');
				}
			} else {
				showToast(`💾 ${updatedCount} טיפולים סומנו כשולמו מקומית`, 'info');
			}
			
			// Refresh displays
			displayDebts();
			filterVisits();
		}


		// Function to populate debt filter dropdowns
		// Update loadDebtFilterOptions function with safety checks:
		function loadDebtFilterOptions() {
			const clientSelect = document.getElementById('debtClientFilter');
			
			if (clientSelect) {
				clientSelect.innerHTML = '<option value="">All clients</option>';
				
				// Get unique clients with debts
				const clientsWithDebts = new Set();
				
				visits.forEach(visit => {
					if (visit.amount > 0) {
						const visitAmount = parseFloat(visit.amount) || 0;
						const paidAmount = getVisitPaidAmount(visit.ID);
						const debt = visitAmount - paidAmount;
						
						if (debt > 0) {
							clientsWithDebts.add(visit.location_id);
						}
					}
				});
				
				// Add clients to dropdown
				locations
					.filter(loc => clientsWithDebts.has(loc.ID))
					.sort((a, b) => a.name.localeCompare(b.name))
					.forEach(location => {
						const option = document.createElement('option');
						option.value = location.ID;
						option.textContent = location.name;
						clientSelect.appendChild(option);
					});
			}
		}


		// עדכון כרטיסי סיכום
		function updateDebtsSummary(debtsArray) {
			const totalDebt = debtsArray.reduce((sum, debt) => sum + debt.totalDebt, 0);
			const debtorsCount = debtsArray.length;
			const averageDebt = debtorsCount > 0 ? totalDebt / debtorsCount : 0;
			
			// מציאת החוב הכי ישן
			let oldestDebtDays = 0;
			if (debtsArray.length > 0) {
				const oldestVisit = debtsArray
					.flatMap(debt => debt.visits)
					.reduce((oldest, visit) => 
						new Date(visit.date) < new Date(oldest.date) ? visit : oldest
					);
				oldestDebtDays = Math.floor((new Date() - new Date(oldestVisit.date)) / (1000 * 60 * 60 * 24));
			}
			
			document.getElementById('totalDebt').textContent = `₪${totalDebt.toLocaleString()}`;
			document.getElementById('totalDebt').style.color = totalDebt > 0 ? '#e74c3c' : '#27ae60';
			
			document.getElementById('debtorsCount').textContent = debtorsCount;
			document.getElementById('averageDebt').textContent = `₪${Math.round(averageDebt).toLocaleString()}`;
			document.getElementById('oldestDebt').textContent = oldestDebtDays > 0 ? `${oldestDebtDays} ימים` : '-';
			
			if (oldestDebtDays > 90) {
				document.getElementById('oldestDebt').style.color = '#e74c3c';
			} else if (oldestDebtDays > 30) {
				document.getElementById('oldestDebt').style.color = '#f39c12';
			}
		}

		// הצגת פירוט חוב ללקוח במודל נוח
		function showDebtDetails(locationId) {
			const location = locations.find(loc => loc.ID == locationId);
			const locationVisits = visits.filter(v => v.location_id == locationId && v.paid === '0');
			
			if (!location || locationVisits.length === 0) {
				showToast('לא נמצאו חובות ללקוח זה', 'info');
				return;
			}
			
			// מיון ביקורים לפי תאריך
			locationVisits.sort((a, b) => new Date(a.date) - new Date(b.date));
			
			const totalDebt = locationVisits.reduce((sum, v) => sum + parseFloat(v.amount), 0);
			
			// יצירת רשימת הביקורים
			let visitsHTML = '';
			locationVisits.forEach(visit => {
				const workDone = visit.work_done || 'לא צוין';
				const notes = visit.notes ? `<div style="color: #888; font-size: 12px; margin-top: 5px;">💭 ${visit.notes}</div>` : '';
				
				visitsHTML += `
					<div style="border: 1px solid #e9ecef; border-radius: 6px; padding: 12px; margin-bottom: 10px;">
						<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
							<strong>📅 ${formatDate(visit.date)}</strong>
							<strong style="color: #e74c3c;">₪${parseFloat(visit.amount).toLocaleString()}</strong>
						</div>
						<div style="color: #666; font-size: 14px;">
							🔧 ${workDone}
						</div>
						${notes}
					</div>
				`;
			});
			
			// תוכן המודל
			const modalContent = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 90vw; max-height: 70vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">💰 פירוט חובות - ${location.name}</h3>
					
					<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
						<strong>סה"כ חוב: ₪${totalDebt.toLocaleString()}</strong><br>
						<span style="color: #666;">מספר טיפולים: ${locationVisits.length}</span>
					</div>
					
					<div style="max-height: 300px; overflow-y: auto;">
						${visitsHTML}
					</div>
					
					<div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
						<button type="button" onclick="markDebtAsPaid(${locationId}); closeEditModal();" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
							✅ סמן כמסולק
						</button>
						<button type="button" onclick="closeEditModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
							❌ סגור
						</button>
					</div>
				</div>
			`;
			
			showEditModal(modalContent);
		}  

		// סימון חוב כמסולק
		function markDebtAsPaid(locationId) {
			const location = locations.find(loc => loc.ID == locationId);
			if (!location) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			const unpaidVisits = visits.filter(v => v.location_id == locationId && v.paid === '0');
			
			if (unpaidVisits.length === 0) {
				showToast('אין חובות פתוחים ללקוח זה', 'info');
				return;
			}
			
			const totalDebt = unpaidVisits.reduce((sum, v) => sum + parseFloat(v.amount), 0);
			
			if (confirm(`לסמן את כל החובות של ${location.name} כמסולקים?\n\nסה"כ: ₪${totalDebt.toLocaleString()}\nמספר טיפולים: ${unpaidVisits.length}`)) {
				// עדכון כל הביקורים החייבים
				unpaidVisits.forEach(visit => {
					visit.paid = '1';
				});
				
				// שמירה מקומית
				saveToLocalStorage();
				
				// שמירה בענן אם מחובר
				if (access_token && SPREADSHEET_ID) {
					saveAllToSheets().then(() => {
						console.log('✅ חובות עודכנו בענן');
					}).catch(error => {
						console.error('❌ שגיאה בעדכון ענן:', error);
						showToast('החובות עודכנו מקומית, אך לא בענן', 'warning');
					});
				}
				
				// רענון התצוגה
				displayDebts();
				
				showToast(`החובות של ${location.name} סומנו כמסולקים! (₪${totalDebt.toLocaleString()})`, 'success');
			}
		}

	   
	    // התראה על חובות חמורים
		function checkCriticalDebts() {
			const criticalDebts = visits.filter(visit => {
				if (visit.paid !== '0') return false;
				
				const daysSince = Math.floor((new Date() - new Date(visit.date)) / (1000 * 60 * 60 * 24));
				return daysSince > 90 || parseFloat(visit.amount) > 1000;
			});
			
			if (criticalDebts.length > 0) {
				const totalCritical = criticalDebts.reduce((sum, visit) => sum + parseFloat(visit.amount), 0);
				
				showToast(
					`⚠️ יש ${criticalDebts.length} חובות דחופים (₪${totalCritical.toLocaleString()})`, 
					'warning', 
					8000
				);
			}
		}
	   
	   
	    // דוח הכנסות לחודש נוכחי
		function generateMonthlyReport() {
			const currentMonth = new Date().getMonth();
			const currentYear = new Date().getFullYear();
			
			const monthlyVisits = visits.filter(visit => {
				const visitDate = new Date(visit.date);
				return visitDate.getMonth() === currentMonth && 
					   visitDate.getFullYear() === currentYear;
			});
			
			const totalRevenue = monthlyVisits.reduce((sum, visit) => 
				sum + parseFloat(visit.amount || 0), 0);
			
			const paidRevenue = monthlyVisits
				.filter(visit => visit.paid === '1')
				.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			const totalHours = monthlyVisits.reduce((sum, visit) => 
				sum + (visit.duration_minutes || 0) / 60, 0);
			
			const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני',
				'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
			
			const report = {
				month: monthNames[currentMonth],
				year: currentYear,
				totalVisits: monthlyVisits.length,
				totalRevenue: totalRevenue,
				paidRevenue: paidRevenue,
				pendingRevenue: totalRevenue - paidRevenue,
				totalHours: totalHours.toFixed(1),
				avgPerVisit: monthlyVisits.length > 0 ? Math.round(totalRevenue / monthlyVisits.length) : 0
			};
			
			return report;
		}

		// הצגת דוח במודל
		function showMonthlyReport() {
			const report = generateMonthlyReport();
			
			const reportHTML = `
				<div style="background: white; padding: 20px; border-radius: 10px; max-width: 500px;">
					<h3>📊 דוח ${report.month} ${report.year}</h3>
					
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
						<div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #1976d2;">${report.totalVisits}</div>
							<div style="color: #666;">ביקורים</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #2e7d32;">₪${report.totalRevenue.toLocaleString()}</div>
							<div style="color: #666;">סה"כ הכנסות</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #f3e5f5; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #7b1fa2;">₪${report.paidRevenue.toLocaleString()}</div>
							<div style="color: #666;">נגבה</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #fff3e0; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #f57c00;">₪${report.pendingRevenue.toLocaleString()}</div>
							<div style="color: #666;">בהמתנה</div>
						</div>
					</div>
					
					<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
						<div><strong>שעות עבודה:</strong> ${report.totalHours} שעות</div>
						<div><strong>ממוצע לביקור:</strong> ₪${report.avgPerVisit}</div>
						<div><strong>ממוצע לשעה:</strong> ₪${Math.round(report.paidRevenue / parseFloat(report.totalHours) || 0)}</div>
					</div>
					
					<button onclick="closeModal()" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; width: 100%;">
						סגור
					</button>
				</div>
			`;
			
			showModal(reportHTML);
		}
	   
	    function isDuplicateVisit(newVisit) {
			return visits.some(existing => 
				existing.location_id === newVisit.location_id &&
				existing.date === newVisit.date &&
				existing.work_done === newVisit.work_done &&
				existing.amount === newVisit.amount
			);
		}
	   
	    function isDuplicateReceipt(newReceipt) {
			return receipts.some(existing => 
				existing.receipt_number === newReceipt.receipt_number &&
				existing.booklet_number === newReceipt.booklet_number &&
				existing.date === newReceipt.date
			);
		}
		
		
		function removeDuplicates() {
			const uniqueVisits = [];
			const seen = new Set();
			
			visits.forEach(visit => {
				const key = `${visit.location_id}-${visit.date}-${visit.work_done}-${visit.amount}`;
				if (!seen.has(key)) {
					seen.add(key);
					uniqueVisits.push(visit);
				}
			});
			
			const removedCount = visits.length - uniqueVisits.length;
			visits = uniqueVisits;
			
			console.log(`Removed ${removedCount} duplicate visits`);
			return removedCount;
		}
	   
	   function validateVisitData(visitData) {
			const errors = [];
			
			if (!visitData.location_id) {
				errors.push('חסר מזהה לקוח');
			}
			
			if (!visitData.date) {
				errors.push('חסר תאריך');
			}
			
			if (!visitData.work_done || visitData.work_done.trim() === '') {
				errors.push('חסר תיאור עבודה');
			}
			
			return errors;
		}

		function showValidationErrors(errors) {
			if (errors.length > 0) {
				alert('בעיות בטופס:\n' + errors.join('\n'));
				return true; // יש שגיאות
			}
			return false; // אין שגיאות
		}
	   
	   // שמירה מקבצית של לקוחות
		async function saveLocationsBatch(locationsArray) {
			if (!await validateToken() || locationsArray.length === 0) return false;
			
			try {
				const locationValues = locationsArray.map(loc => [
					loc.ID,
					loc.name,
					loc.full_address,
					loc.neighborhood,
					loc.city,
					loc.contact_person,
					loc.phone,
					loc.allowed_day,
					loc.interval_weeks,
					loc.temp_addition || 0,
					loc.base_amount,
					loc.active,
					loc.notes || '',
					loc.last_visit || '',
					loc.next_visit || '',
					loc.client_requests || ''  // שדה חסר!
				]);
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `Locations!A2:P${locationValues.length + 1}`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: locationValues }
				});
				
				console.log(`✅ Saved ${locationsArray.length} locations to cloud`);
				return true;
			} catch (error) {
				console.error('Error saving locations batch:', error);
				return false;
			}
		}

		// שמירה מקבצית של ביקורים
		async function saveVisitsBatch(visitsToSave) {
			if (!await validateToken()) return false;
			
			try {
				console.log('🔵 saveVisitsBatch called with', visitsToSave.length, 'visits');
				
				const values = visitsToSave.map(visit => [
					visit.ID || '',
					visit.date || '',
					visit.location_id || '',
					visit.location_name || '',
					visit.visit_type || '',
					visit.work_done || '',
					visit.duration_minutes || 0,
					visit.num_workers || 1,
					visit.start_time || '',
					visit.end_time || '',
					visit.amount || 0,
					visit.paid || 'no',  // ✅ ADDED: paid field in correct position
					visit.expense || 0,
					visit.notes || ''
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Visits!A:N',  // ✅ UPDATED: Now 14 columns (A:N)
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`✅ Saved ${visitsToSave.length} visits to cloud`);
				return true;
				
			} catch (error) {
				console.error('Error saving visits batch:', error);
				return false;
			}
		}

		// שמירה מקבצית של קבלות
		async function saveReceiptsBatch(receiptsArray) {
			if (!await validateToken() || receiptsArray.length === 0) return false;
			
			try {
				// קרא את הנתונים הקיימים קודם
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Receipts!A:A'
				});
				
				const existingIDs = new Set(response.result.values?.slice(1).map(row => row[0]) || []);
				
				// סנן רק רשומות חדשות
				const newReceipts = receiptsArray.filter(receipt => !existingIDs.has(receipt.ID));
				
				if (newReceipts.length === 0) {
					console.log('✅ No new receipts to save');
					return true;
				}
				
				const values = newReceipts.map(receipt => [
					receipt.ID,
					receipt.book_number,
					receipt.receipt_number,
					formatDateForSheets(receipt.date),
					receipt.location_id,
					receipt.location_name,
					receipt.amount,
					receipt.payment_type,
					receipt.notes
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:I`,
					valueInputOption: 'USER_ENTERED',
					resource: { 
						values: values,
						majorDimension: 'ROWS'
					}
				});
				
				console.log(`✅ Saved ${newReceipts.length} receipts in batch - from ${receiptsArray.length}`);
				return true;
			} catch (error) {
				console.error('Error in batch save receipts:', error);
				return false;
			}
		}
		
		
		// שמירה מקבצית של תשלומים
		async function savePaymentsBatch(paymentsArray) {
			if (!await validateToken()) return false;
			
			try {
				console.log('💳 savePaymentsBatch called with', paymentsArray.length, 'payments');
				
				const values = paymentsArray.map(payment => [
					payment.ID || '',
					payment.date || '',
					payment.client_id || '',
					payment.client_name || '',
					payment.amount || 0,
					payment.payment_method || '',
					payment.notes || '',
					payment.reference || '',
					payment.check_date || ''
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Payments!A:I',
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`✅ Saved ${paymentsArray.length} payments to cloud`);
				return true;
				
			} catch (error) {
				console.error('Error saving payments batch:', error);
				return false;
			}
		}

		// שמירה מקבצית של קישורי תשלומים
		async function savePaymentVisitLinksBatch(linksArray) {
			if (!await validateToken()) return false;
			
			try {
				console.log('🔗 savePaymentVisitLinksBatch called with', linksArray.length, 'links');
				
				const values = linksArray.map(link => [
					link.ID || '',
					link.payment_id || '',
					link.visit_id || '',
					link.amount_allocated || 0
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'PaymentVisitLink!A:D',
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`✅ Saved ${linksArray.length} payment links to cloud`);
				return true;
				
			} catch (error) {
				console.error('Error saving payment links batch:', error);
				return false;
			}
		}
		
	   
	   // ===== מנגנון תשלומים חדש ===== 

		// פתיחת מודל להוספת תשלום חדש
		function showAddPaymentModal(clientId = null) {
			let selectedClientId = clientId;
			let selectedClientName = '';
			
			// אם יש לקוח נבחר, קח את השם שלו
			if (clientId) {
				const client = locations.find(loc => loc.ID === clientId);
				if (client) {
					selectedClientName = client.name;
				}
			}
			
			const modalHTML = `
				<div style="background: white; padding: 30px; border-radius: 12px; max-width: 700px; width: 90vw; max-height: 80vh; overflow-y: auto; direction: rtl;">
					<h3 style="margin-bottom: 25px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
						💰 הוספת תשלום חדש
					</h3>
					
					<!-- בחירת לקוח -->
					<div class="form-group" style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: bold;">לקוח:</label>
						${clientId ? 
							`<input type="text" value="${selectedClientName}" disabled style="width: 100%; padding: 10px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 6px;">` :
							`<input type="text" 
								id="paymentClientSearch" 
								placeholder="התחל להקליד שם לקוח..."
								oninput="searchClientForPayment(this.value)"
								autocomplete="off"
								style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
							<input type="hidden" id="selectedPaymentClientId">
							<div id="paymentClientResults" style="border: 1px solid #ddd; border-top: none; max-height: 150px; overflow-y: auto; display: none;"></div>`
						}
					</div>
					
					<!-- תאריך ושעה -->
					<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 20px;">
						<div class="form-group">
							<label style="display: block; margin-bottom: 8px; font-weight: bold;">תאריך:</label>
							<input type="date" id="paymentDate" value="${new Date().toISOString().split('T')[0]}" 
								style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
						</div>
						<div class="form-group">
							<label style="display: block; margin-bottom: 8px; font-weight: bold;">שעה:</label>
							<input type="time" id="paymentTime" value="${new Date().toTimeString().slice(0,5)}"
								style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
						</div>
					</div>
					
					<!-- סכום ואמצעי תשלום -->
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
						<div class="form-group">
							<label style="display: block; margin-bottom: 8px; font-weight: bold;">סכום (₪):</label>
							<input type="number" id="paymentAmount" placeholder="0" step="0.01"
								style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
						</div>
						<div class="form-group">
							<label style="display: block; margin-bottom: 8px; font-weight: bold;">אמצעי תשלום:</label>
							<select id="paymentMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
								<option value="cash">מזומן</option>
								<option value="check">צ'ק</option>
								<option value="transfer">העברה בנקאית</option>
								<option value="app">אפליקציה (ביט/פייבוקס)</option>
							</select>
						</div>
					</div>
					
					<!-- פרטי צ'ק (מוצג רק אם בחרו צ'ק) -->
					<div id="checkDetailsSection" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
							<div class="form-group">
								<label style="display: block; margin-bottom: 8px; font-weight: bold;">מספר צ'ק:</label>
								<input type="text" id="checkReference" placeholder="מספר צ'ק"
									style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
							</div>
							<div class="form-group">
								<label style="display: block; margin-bottom: 8px; font-weight: bold;">תאריך פירעון:</label>
								<input type="date" id="checkDate"
									style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
							</div>
						</div>
					</div>
					
					<!-- הערות -->
					<div class="form-group" style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: bold;">הערות:</label>
						<textarea id="paymentNotes" rows="3" placeholder="הערות נוספות..."
							style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
					</div>
					
					<!-- רשימת טיפולים פתוחים -->
					<div id="openVisitsSection" style="display: none; background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 2px solid #ffc107;">
						<h4 style="margin: 0 0 15px 0; color: #856404;">בחר טיפולים לסגירה:</h4>
						<div id="openVisitsList" style="max-height: 200px; overflow-y: auto;"></div>
						<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 14px; color: #666;">
							<strong>סכום נבחר:</strong> <span id="selectedVisitsTotal">0</span> ₪
						</div>
					</div>
					
					<!-- כפתורים -->
					<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
						<button onclick="closeModal()" class="btn" style="background: #95a5a6; color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer;">
							ביטול
						</button>
						<button onclick="saveNewPayment()" class="btn" style="background: #27ae60; color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
							💾 שמור תשלום
						</button>
					</div>
				</div>
			`;
			
			showModal(modalHTML);
			
			// שמירת הלקוח הנבחר אם יש
			if (clientId) {
				window.selectedPaymentClientId = clientId;
				loadOpenVisitsForPayment(clientId);
			}
			
			// הוספת event listener לשינוי אמצעי תשלום
			setTimeout(() => {
				const methodSelect = document.getElementById('paymentMethod');
				if (methodSelect) {
					methodSelect.addEventListener('change', toggleCheckDetails);
				}
			}, 100);
		}


		// פונקציה חדשה: פתיחת מודל תשלום עבור טיפול ספציפי
		function addPaymentForVisit(visitId) {
			const visit = visits.find(v => v.ID === visitId);
			if (!visit) {
				showToast('טיפול לא נמצא', 'error');
				return;
			}
			
			// פתיחת המודל עם הלקוח של הטיפול
			showAddPaymentModal(visit.location_id);
			
			// המתנה קצרה לטעינת המודל ואז בחירת הטיפול הספציפי
			setTimeout(() => {
				const checkbox = document.querySelector(`input[type="checkbox"][data-visit-id="${visitId}"]`);
				if (checkbox) {
					checkbox.checked = true;
					updateSelectedVisitsTotal();
				}
			}, 300);
		}


		// הצגה/הסתרה של פרטי צ'ק
		function toggleCheckDetails() {
			const method = document.getElementById('paymentMethod').value;
			const checkSection = document.getElementById('checkDetailsSection');
			if (checkSection) {
				checkSection.style.display = (method === 'check') ? 'block' : 'none';
			}
		}

		// חיפוש לקוח להוספת תשלום
		function searchClientForPayment(searchTerm) {
			const resultsDiv = document.getElementById('paymentClientResults');
			
			if (!searchTerm || searchTerm.trim().length < 2) {
				resultsDiv.style.display = 'none';
				return;
			}
			
			const matchingClients = searchClientsAdvanced(searchTerm);
			
			if (matchingClients.length === 0) {
				resultsDiv.innerHTML = '<div style="padding: 10px; color: #999;">לא נמצאו לקוחות</div>';
				resultsDiv.style.display = 'block';
				return;
			}
			
			resultsDiv.innerHTML = matchingClients.slice(0, 10).map(client => {
				const safeName = client.name.replace(/'/g, '&#39;');
				return `
					<div onclick="selectClientForPayment('${client.ID}', '${safeName}')" 
						 style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; background: white;"
						 onmouseover="this.style.background='#f0f0f0'" 
						 onmouseout="this.style.background='white'">
						<strong>${client.name}</strong>
						${client.full_address ? `<br><small style="color: #666;">${client.full_address}</small>` : ''}
					</div>
				`;
			}).join('');
			
			resultsDiv.style.display = 'block';
		}

		// בחירת לקוח להוספת תשלום
		function selectClientForPayment(clientId, clientName) {
			document.getElementById('paymentClientSearch').value = clientName;
			document.getElementById('selectedPaymentClientId').value = clientId;
			document.getElementById('paymentClientResults').style.display = 'none';
			
			window.selectedPaymentClientId = clientId;
			
			// טען טיפולים פתוחים של הלקוח
			loadOpenVisitsForPayment(clientId);
		}
	   
	   
	   // טעינת טיפולים פתוחים של לקוח
		function loadOpenVisitsForPayment(clientId) {
			const openVisitsSection = document.getElementById('openVisitsSection');
			const openVisitsList = document.getElementById('openVisitsList');
			
			if (!openVisitsSection || !openVisitsList) return;
			
			// מצא את כל הטיפולים הפתוחים (לא שולמו במלואם) של הלקוח
			const clientVisits = visits.filter(visit => {
				if (visit.location_id !== clientId) return false;
				if (!visit.amount || visit.amount <= 0) return false;
				
				// בדוק אם יש חוב
				const paidAmount = getVisitPaidAmount(visit.ID);
				const debt = parseFloat(visit.amount) - paidAmount;
				
				return debt > 0.01; // יש חוב
			});
			
			if (clientVisits.length === 0) {
				openVisitsSection.style.display = 'none';
				return;
			}
			
			// מיין לפי תאריך
			clientVisits.sort((a, b) => new Date(a.date) - new Date(b.date));
			
			// הצג את הטיפולים
			openVisitsList.innerHTML = clientVisits.map(visit => {
				const paidAmount = getVisitPaidAmount(visit.ID);
				const debt = parseFloat(visit.amount) - paidAmount;
				
				return `
					<div style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px; background: white;">
						<label style="display: flex; align-items: center; cursor: pointer;">
							<input type="checkbox" 
								   class="visit-checkbox" 
								   data-visit-id="${visit.ID}"
								   data-visit-amount="${visit.amount}"
								   data-visit-debt="${debt.toFixed(2)}"
								   onchange="updateSelectedVisitsTotal()"
								   style="margin-left: 10px; transform: scale(1.3);">
							<div style="flex: 1;">
								<div style="display: flex; justify-content: space-between; align-items: center;">
									<span style="font-weight: bold;">${formatDate(visit.date)}</span>
									<span style="color: #e74c3c; font-weight: bold;">${debt.toFixed(2)} ₪</span>
								</div>
								<div style="font-size: 13px; color: #666; margin-top: 4px;">
									${visit.work_done || 'טיפול'}
									${paidAmount > 0 ? `<span style="color: #f39c12;"> (שולם: ${paidAmount}₪)</span>` : ''}
								</div>
							</div>
						</label>
					</div>
				`;
			}).join('');
			
			openVisitsSection.style.display = 'block';
			updateSelectedVisitsTotal();
		}

		// עדכון סכום הטיפולים הנבחרים
		function updateSelectedVisitsTotal() {
			const checkboxes = document.querySelectorAll('.visit-checkbox:checked');
			let total = 0;
			
			checkboxes.forEach(cb => {
				const debt = parseFloat(cb.getAttribute('data-visit-debt')) || 0;
				total += debt;
			});
			
			const totalSpan = document.getElementById('selectedVisitsTotal');
			if (totalSpan) {
				totalSpan.textContent = total.toFixed(2);
			}
		}

		// שמירת תשלום חדש
		async function saveNewPayment() {
			// קבל נתונים מהטופס
			const clientId = window.selectedPaymentClientId || document.getElementById('selectedPaymentClientId')?.value;
			const date = document.getElementById('paymentDate')?.value;
			const amount = parseFloat(document.getElementById('paymentAmount')?.value) || 0;
			const method = document.getElementById('paymentMethod')?.value;
			const notes = document.getElementById('paymentNotes')?.value || '';
			const reference = document.getElementById('checkReference')?.value || '';
			const checkDate = document.getElementById('checkDate')?.value || '';
			
			// בדיקות תקינות
			if (!clientId) {
				showToast('יש לבחור לקוח', 'error');
				return;
			}
			
			if (!date) {
				showToast('יש להזין תאריך', 'error');
				return;
			}
			
			if (amount <= 0) {
				showToast('יש להזין סכום תקין', 'error');
				return;
			}
			
			// מצא את הלקוח
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// קבל את הטיפולים הנבחרים
			const selectedCheckboxes = document.querySelectorAll('.visit-checkbox:checked');
			const selectedVisits = Array.from(selectedCheckboxes).map(cb => ({
				visitId: cb.getAttribute('data-visit-id'),
				debt: parseFloat(cb.getAttribute('data-visit-debt'))
			}));
			
			// בדוק שיש טיפולים נבחרים
			if (selectedVisits.length === 0) {
				if (!confirm('לא נבחרו טיפולים לסגירה. האם להמשיך בכל זאת?')) {
					return;
				}
			}
			
			try {
				showLoading('שומר תשלום...');
				
				// צור את התשלום
				const payment = {
					ID: generateID(),
					date: date,
					client_id: clientId,
					client_name: client.name,
					amount: amount,
					payment_method: method,
					notes: notes,
					reference: reference,
					check_date: checkDate
				};
				
				// הוסף לרשימת התשלומים
				payments.push(payment);
				
				// צור קישורים לטיפולים
				let remainingAmount = amount;
				
				selectedVisits.forEach(selectedVisit => {
					if (remainingAmount <= 0) return;
					
					const visit = visits.find(v => v.ID === selectedVisit.visitId);
					if (!visit) return;
					
					const debt = selectedVisit.debt;
					const amountToAllocate = Math.min(remainingAmount, debt);
					
					// צור קישור
					const link = {
						ID: generateID(),
						payment_id: payment.ID,
						visit_id: visit.ID,
						amount_allocated: amountToAllocate
					};
					
					paymentVisitLinks.push(link);
					
					// עדכן את הטיפול
					const currentPaid = getVisitPaidAmount(visit.ID);
					const newPaidAmount = currentPaid + amountToAllocate;
					const visitAmount = parseFloat(visit.amount);
					
					if (newPaidAmount >= visitAmount - 0.01) {
						// שולם במלואו
						visit.paid = `paid:${date}`;
					} else {
						// שולם חלקית
						visit.paid = `partial:${newPaidAmount.toFixed(2)}`;
					}
					
					remainingAmount -= amountToAllocate;
				});
				
				// שמור מקומית
				saveToLocalStorage();
				
				// שמור לענן
				if (access_token && SPREADSHEET_ID) {
					await saveAllToSheetsOptimized();
					showToast('✅ תשלום נוסף בהצלחה ונשמר לענן!', 'success');
				} else {
					showToast('💾 תשלום נוסף בהצלחה (מקומית)', 'info');
				}
				
				hideLoading();
				closeModal();
				
				// רענן תצוגות
				if (typeof displayDebts === 'function') {
					displayDebts();
				}
				if (typeof applyPaymentFilters === 'function') {
					applyPaymentFilters();
				}
				if (typeof filterVisits === 'function') {
					filterVisits();
				}
				
			} catch (error) {
				console.error('Error saving payment:', error);
				hideLoading();
				showToast('שגיאה בשמירת התשלום', 'error');
			}
		}


		// פונקציית עזר למחיקת תשלום (לעתיד)
		function deletePayment(paymentId) {
			if (!confirm('האם למחוק את התשלום? פעולה זו תבטל את הקישורים לטיפולים.')) {
				return;
			}
			
			// מחק קישורים
			const linksToRemove = paymentVisitLinks.filter(link => link.payment_id === paymentId);
			linksToRemove.forEach(link => {
				const visit = visits.find(v => v.ID === link.visit_id);
				if (visit) {
					// החזר את הטיפול למצב לא שולם
					visit.paid = 'unpaid';
				}
				
				// מחק את הקישור
				const linkIndex = paymentVisitLinks.findIndex(l => l.ID === link.ID);
				if (linkIndex > -1) {
					paymentVisitLinks.splice(linkIndex, 1);
				}
			});
			
			// מחק את התשלום
			const paymentIndex = payments.findIndex(p => p.ID === paymentId);
			if (paymentIndex > -1) {
				payments.splice(paymentIndex, 1);
			}
			
			// שמור
			saveToLocalStorage();
			
			if (access_token && SPREADSHEET_ID) {
				saveAllToSheetsOptimized();
			}
			
			showToast('תשלום נמחק בהצלחה', 'success');
			
			// רענן תצוגות
			if (typeof applyPaymentFilters === 'function') {
				applyPaymentFilters();
			}
			if (typeof displayDebts === 'function') {
				displayDebts();
			}
		}

	   
	   // פונקציה לחישוב ועדכון תאריכי טיפול אחרון וטיפול הבא
		// פונקציה לחישוב ועדכון תאריכי טיפול אחרון וטיפול הבא - גרסה מתקנת
		async function calculateTreatmentDates() {
			console.log('🔄 מחשב תאריכי טיפול אחרון וטיפול הבא...');
			
			let updatedLocations = [];
			
			for (const location of locations) {
				// מצא את כל הטיפולים של הלקוח הזה
				const locationVisits = visits.filter(visit => visit.location_id === location.ID);
				
				if (locationVisits.length > 0) {
					// מיין לפי תאריך (החדש ביותר ראשון)
					locationVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
					
					// הטיפול האחרון
					const lastVisit = locationVisits[0];
					const lastVisitDate = lastVisit.date;
					
					// חישוב יום מועדף לפי הביקור האחרון
					if (!location.allowed_day || location.allowed_day === '') {
						const lastDate = new Date(lastVisitDate);
						const dayNames = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];
						location.allowed_day = dayNames[lastDate.getDay()];
						/// console.log(`📅 ${location.name}: יום מועדף חושב כ-${location.allowed_day} (לפי ביקור מ-${lastVisitDate})`);
					}
					
					// חישוב תאריך הטיפול הבא
					const lastDate = new Date(lastVisitDate);
					const intervalDays = (location.interval_weeks || 4) * 7; // ברירת מחדל 4 שבועות
					const nextDate = new Date(lastDate);
					nextDate.setDate(lastDate.getDate() + intervalDays);
					
					// פורמט התאריך ל-YYYY-MM-DD
					const nextVisitDate = nextDate.toISOString().split('T')[0];
					
					// עדכון האובייקט המקומי
					location.last_visit = lastVisitDate;
					location.next_visit = nextVisitDate;
					
					updatedLocations.push(location);
					
					// console.log(`📅 ${location.name}: טיפול אחרון ${lastVisitDate} → טיפול הבא ${nextVisitDate}`);
				}
			}
			
			// עדכון בגוגל שיטס במקביל - קריאה אחת בלבד עבור כל הלקוחות
			if (updatedLocations.length > 0) {
				console.log(`🔄 מעדכן ${updatedLocations.length} לקוחות בגוגל שיטס...`);
				await updateTreatmentDatesInSheets(updatedLocations);
				showToast(`📅 תאריכי טיפול עודכנו עבור ${updatedLocations.length} לקוחות`, 'success', 2000);
			}
			
			// רענן נתוני תכנון
			refreshPlanningAfterTreatmentUpdate();
			
			return updatedLocations.length;
		}
	   
	   
	    // פונקציה לעדכון תאריכי הטיפול בגוגל שיטס
		async function updateTreatmentDatesInSheets(locationsToUpdate) {
			if (!await validateToken() || locationsToUpdate.length === 0) return false;
			
			console.log(`🔄 מעדכן תאריכי טיפול עבור ${locationsToUpdate.length} לקוחות בגוגל שיטס...`);
			
			try {
				// קרא את כל הנתונים הנוכחיים מהטבלה
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:P'
				});
				
				const allRows = response.result.values || [];
				const updatedRows = [...allRows];
				let updatedCount = 0;
				
				// עבור כל לקוח שצריך עדכון
				for (const location of locationsToUpdate) {
					// מצא את השורה המתאימה בטבלה
					for (let i = 1; i < allRows.length; i++) { // מתחיל מ-1 כדי לדלג על הכותרות
						if (allRows[i][0] === location.ID) {
							// עדכן את עמודות התאריכים והיום המועדף
							updatedRows[i][7] = location.allowed_day;   // allowed_day (עמודה 7)
							updatedRows[i][13] = location.last_visit;   // last_visit
							updatedRows[i][14] = location.next_visit;   // next_visit
							updatedCount++;
							break;
						}
					}
				}
				
				// שמור את כל הטבלה המעודכנת בקריאה אחת בלבד
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:P',
					valueInputOption: 'USER_ENTERED',
					resource: {
						values: updatedRows
					}
				});
				
				console.log(`✅ עודכנו ${updatedCount} תאריכי טיפול בגוגל שיטס`);
				return true;
			} catch (error) {
				console.error('Error updating treatment dates in sheets:', error);
				return false;
			}
		}
		
		// פונקציה לעדכון תאריכי טיפול עבור לקוח אחד לאחר הוספת ביקור
		// Verify this function exists and works correctly - it should already be in your code
		// If it's missing any part, here's the complete correct version:

		async function updateSingleLocationTreatmentDates(locationId) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) return;
			
			// מצא את כל הביקורים של הלקוח הזה
			const locationVisits = visits.filter(visit => visit.location_id === locationId);
			
			if (locationVisits.length > 0) {
				// מיון לפי תאריך (החדש ביותר ראשון)
				locationVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
				
				// הטיפול האחרון
				const lastVisit = locationVisits[0];
				const lastVisitDate = lastVisit.date;
				
				// חישוב תאריך הטיפול הבא
				const lastDate = new Date(lastVisitDate);
				const intervalDays = (location.interval_weeks || 4) * 7; // ברירת מחדל 4 שבועות
				const nextDate = new Date(lastDate);
				nextDate.setDate(lastDate.getDate() + intervalDays);
				
				// פורמט התאריך ל-YYYY-MM-DD
				const nextVisitDate = nextDate.toISOString().split('T')[0];
				
				// עדכון האובייקט המקומי
				location.last_visit = lastVisitDate;
				location.next_visit = nextVisitDate;
				
				// עדכון בגוגל שיטס
				await updateTreatmentDatesInSheets([location]);
				
				console.log(`📅 עודכן לקוח ${location.name}: טיפול אחרון ${lastVisitDate} → טיפול הבא ${nextVisitDate}`);
				
				// רענן נתוני תכנון
				refreshPlanningAfterTreatmentUpdate();
			}
		}
	   
	   // פונקציה לחידוש נתוני התכנון לאחר עדכון תאריכים
		function refreshPlanningAfterTreatmentUpdate() {
			// רענן את נתוני התכנון אם הטאב פתוח
			const currentSection = document.querySelector('.section.active');
			if (currentSection && currentSection.id === 'planning') {
				loadPlanningData();
			}
			
			// רענן גם את רשימת הלקוחות בטופס הביקור
			loadLocationsForSelect();
		}
	   
	   // פונקציה לבדיקת מצב נתוני התכנון - לדיבוג
		function debugPlanningData() {
			console.log('=== Debug Planning Data ===');
			console.log(`סה"כ לקוחות: ${locations.length}`);
			
			// בדוק מה יש בשדה active
			console.log('דוגמאות של שדה active:', locations.slice(0, 5).map(loc => ({ name: loc.name, active: loc.active, type: typeof loc.active })));

			const activeLocations = locations.filter(loc => loc.active === "כן" || loc.active === true || loc.active === "1");
			console.log(`לקוחות פעילים: ${activeLocations.length}`);
			
			const locationsWithDates = activeLocations.filter(loc => loc.next_visit && loc.next_visit.trim() !== '');
			console.log(`לקוחות עם תאריכי טיפול: ${locationsWithDates.length}`);
			
			// הצג 5 לקוחות ראשונים
			locationsWithDates.slice(0, 5).forEach(loc => {
				console.log(`👤 ${loc.name}: אחרון=${loc.last_visit}, הבא=${loc.next_visit}`);
			});
			
			const today = new Date();
			const todayStr = today.toISOString().split('T')[0];
			console.log(`תאריך היום: ${todayStr}`);
			
			const dueToday = locationsWithDates.filter(loc => {
				return new Date(loc.next_visit) <= today;
			});
			console.log(`צריכים טיפול היום: ${dueToday.length}`);
			
			console.log('=== סיום Debug ===');
		}
	   
	   
		// פונקציה חדשה לייבוא מהיר וכולל של כל הנתונים
		async function importFromHelperTableFast() {
			console.log('🚀 Starting FAST complete import from helper table...');
			
			if (!await validateToken()) {
				showToast('התחבר לגוגל קודם', 'warning');
				return;
			}
			
			const importTableId = localStorage.getItem('importTableId');
			console.log('🔍 Import Table ID:', importTableId);  // ✅ הוסף את זה

			if (!importTableId) {
				showToast('לא נמצא ID של טבלת העזר', 'warning');
				return;
			}

console.log('✅ Import table ID exists, proceeding with import...');  // ✅ הוסף את זה
			
			try {
				showLoading('מייבא נתונים מהר מטבלת העזר...');
				
				// Statistics tracking
				const stats = {
					locations: { imported: 0, skipped: 0 },
					visits: { imported: 0, skipped: 0 },
					receipts: { imported: 0, skipped: 0 }
				};
				
				// Arrays for new data only
				const newLocations = [];
				const newVisits = [];
				const newReceipts = [];
				const payments = [];
				const paymentVisitLinks = [];
				
				console.log('📊 About to load data from helper table:', importTableId);  // ✅ הוסף את זה
				
				// ======== STEP 1: Import Locations ========
				try {
					console.log('📊 Starting locations import...');
					const locationsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Locations!A2:I1000'
					});
					
					if (locationsResponse.result.values?.length > 0) {
						for (const row of locationsResponse.result.values) {
							if (row.length > 0 && row[0]) { // Has customer name
								const customerName = row[0].trim();
								const street = row[1] || '';
								const houseNumber = row[2] || '';
								const city = row[3] || '';
								const fullAddress = `${street} ${houseNumber} ${city}`.trim();
								
								// Check if customer already exists
								const existingCustomer = locations.find(loc => 
									loc.name.toLowerCase() === customerName.toLowerCase() ||
									(fullAddress && loc.full_address && 
									 loc.full_address.toLowerCase() === fullAddress.toLowerCase())
								);
								
								if (!existingCustomer) {
									const locationData = {
										ID: generateID(),
										name: customerName,
										full_address: fullAddress || customerName,
										neighborhood: '',
										city: city,
										contact_person: row[5] || '',
										phone: '',
										allowed_day: row[7] || 'א',
										interval_weeks: parseInt(row[4]) || 4,
										temp_addition: false,
										base_amount: parseFloat(row[6]) || 0,
										active: row[8] || '1',
										notes: 'יובא מטבלת עזר',
										last_visit: '',
										next_visit: '',
										client_requests: ''
									};
									
									locations.push(locationData);
									newLocations.push(locationData);
									stats.locations.imported++;
								} else {
									stats.locations.skipped++;
								}
							}
						}
						console.log(`✅ Processed ${stats.locations.imported} new locations`);
					}
				} catch (error) {
					console.error('❌ Error importing locations:', error);
				}
				
				// ======== STEP 2: Import Visits ========
				try {
					console.log('🔧 Starting visits import...');
					const visitsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Visits!A2:M1000'
					});
					
					if (visitsResponse.result.values?.length > 0) {
						let notFoundCustomers = [];
						
						for (const row of visitsResponse.result.values) {
							if (row.length > 3 && row[3]) { // Has customer in column 3
								const customerName = row[3].trim();
								
								// Find existing customer
								const existingCustomer = locations.find(loc =>
									loc.name && loc.name.toLowerCase() === customerName.toLowerCase()
								);
								
								if (!existingCustomer) {
									if (!notFoundCustomers.includes(customerName)) {
										notFoundCustomers.push(customerName);
									}
									stats.visits.skipped++;
									continue;
								}
								
								// Build date from 3 columns: year, month, day
								const year = row[0];
								const month = String(row[1]).padStart(2, '0');
								const day = String(row[2]).padStart(2, '0');
								const visitDate = `${year}-${month}-${day}`;
								
								const workDone = row[7] || '';
								const amount = parseFloat(row[9]) || 0;
								
								// Check for duplicates
								const isDuplicate = visits.some(existing =>
									existing.location_id === existingCustomer.ID &&
									existing.date === visitDate &&
									existing.work_done === workDone &&
									Math.abs(existing.amount - amount) < 0.01
								);
								
								if (!isDuplicate) {
									const visitData = {
										ID: generateID(),
										date: visitDate,
										location_id: existingCustomer.ID,
										location_name: customerName,
										visit_type: row[5] || 'regular',
										work_done: workDone,
										duration_minutes: (() => {
											const val = parseFloat(row[8]) || 0;
											// If value < 24, assume it's hours and convert to minutes
											// If value >= 24, assume it's already in minutes
											return val < 24 ? val * 60 : val;
										})(),
										num_workers: 1,
										start_time: '',
										end_time: '',
										amount: amount,
										paid: mapPaymentStatus(row[10]),
										expense: parseFloat(row[11]) || 0,
										notes: row[12] || ''
									};
									
									visits.push(visitData);
									newVisits.push(visitData);
									stats.visits.imported++;
									
									// Create payment if marked as paid
									const paidStatus = row[10] || '';
									if (paidStatus === '1' || paidStatus === 'כן' || paidStatus === 'שולם') {
										const payment = {
											ID: generateID(),
											date: visitDate,
											time: '12:00',
											amount: amount,
											payment_method: 'cash',
											source_type: 'import_from_helper_fast',
											client_id: existingCustomer.ID,
											client_name: existingCustomer.name,
											notes: `תשלום עבור ייבוא מהיר - ${workDone}`,
											status: 'completed',
											created_at: new Date().toISOString()
										};
										
										payments.push(payment);
										
										const link = {
											ID: generateID(),
											payment_id: payment.ID,
											visit_id: visitData.ID,
											amount_allocated: amount,
											link_type: 'full_payment',
											created_at: new Date().toISOString()
										};
										
										paymentVisitLinks.push(link);
									}
								} else {
									stats.visits.skipped++;
								}
							}
						}
						
						if (notFoundCustomers.length > 0) {
							console.log(`⚠️ ${notFoundCustomers.length} customers not found for visits:`, notFoundCustomers.slice(0, 5));
						}
						console.log(`✅ Processed ${stats.visits.imported} new visits`);
					}
				} catch (error) {
					console.error('❌ Error importing visits:', error);
				}
				
				
				// ======== STEP 3: Import Receipts ========
				try {
					console.log('🧾 Starting receipts import...');
					const receiptsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Receipts!A2:K1000'
					});
					
					if (receiptsResponse.result.values?.length > 0) {
						let notFoundAddresses = [];
						
						for (const row of receiptsResponse.result.values) {
							if (row.length > 6 && row[6]) { // Has address in column 6
								const customerAddress = row[6].trim();
								
								// Find customer by address - search in both name and full_address
								const existingCustomer = locations.find(loc =>
									(loc.name && loc.name.toLowerCase().includes(customerAddress.toLowerCase())) ||
									(loc.full_address && loc.full_address.toLowerCase().includes(customerAddress.toLowerCase()))
								);
								
								if (!existingCustomer) {
									if (!notFoundAddresses.includes(customerAddress)) {
										notFoundAddresses.push(customerAddress);
									}
									stats.receipts.skipped++;
									continue;
								}
								
								// Build date
								const year = row[3];
								const month = String(row[4]).padStart(2, '0');
								const day = String(row[5]).padStart(2, '0');
								const receiptDate = `${year}-${month}-${day}`;
								
								const bookNumber = row[1] || '';
								const receiptNumber = row[2] || '';
								
								// Check for duplicates
								const isDuplicateReceipt = receipts.some(existing =>
									existing.book_number === bookNumber &&
									existing.receipt_number === receiptNumber &&
									existing.date === receiptDate
								);
								
								if (!isDuplicateReceipt) {
									const receiptData = {
										ID: generateID(),
										book_number: bookNumber,
										receipt_number: receiptNumber,
										date: receiptDate,
										location_id: existingCustomer.ID,
										location_name: customerAddress,
										amount: parseFloat(row[7]) || 0,
										payment_type: row[8] || '',
										notes: `${row[9] || ''} ${row[10] || ''}`.trim()
									};
									
									receipts.push(receiptData);
									newReceipts.push(receiptData);
									stats.receipts.imported++;
								} else {
									stats.receipts.skipped++;
								}
							}
						}
						
						if (notFoundAddresses.length > 0) {
							console.log(`⚠️ ${notFoundAddresses.length} addresses not found for receipts:`, notFoundAddresses.slice(0, 5));
						}
						console.log(`✅ Processed ${stats.receipts.imported} new receipts`);
					}
				} catch (error) {
					console.error('❌ Error importing receipts:', error);
				}
				
				
				// ======== STEP 4: Save to Local Storage ========
				saveToLocalStorage();
				
				
				// ======== STEP 4.5: Calculate Treatment Dates ========
				if (stats.visits.imported > 0) {
					showToast('מחשב תאריכי טיפול...', 'info', 2000);
					const updatedCount = await calculateTreatmentDates();
					if (updatedCount > 0) {
						console.log(`✅ עודכנו תאריכי טיפול עבור ${updatedCount} לקוחות`);
					}
				}
				
				// ======== STEP 5: Save to Cloud ========
				console.log('☁️ Saving to cloud...');
				const savePromises = [];
				
				if (newLocations.length > 0) {
					console.log('🔵 saveLocationsBatch called for new locations');
					savePromises.push(saveLocationsBatch(newLocations));
				}
				
				if (newVisits.length > 0) {
					console.log('🔵 saveVisitsBatch called with', newVisits.length, 'visits - checking for duplicates');
					savePromises.push(saveVisitsBatch(newVisits));
				}
				
				if (newReceipts.length > 0) {
					console.log('🔵 saveReceiptsBatch called with', newReceipts.length, 'receipts');
					savePromises.push(saveReceiptsBatch(newReceipts));
				}
				
				const saveResults = await Promise.all(savePromises);
				const allSaved = saveResults.every(result => result === true);
				
				// ======== STEP 6: Update UI ========
				loadLocationsTable();
				loadLocationsForSelect();
				loadPlanningData();
				
				hideLoading();
				
				// ======== STEP 7: Final Report ========
				const totalImported = stats.locations.imported + stats.visits.imported;
				const totalSkipped = stats.locations.skipped + stats.visits.skipped;
				
				if (totalImported > 0) {
					const message = `🎉 ייבוא הושלם בהצלחה!
					
		✅ יובאו: ${stats.locations.imported} לקוחות, ${stats.visits.imported} ביקורים, ${stats.receipts.imported} קבלות
		${totalSkipped > 0 ? `⚠️ דולגו (כפילויות): ${totalSkipped} רשומות` : ''}
		${allSaved ? '☁️ נשמר לענן בהצלחה' : '⚠️ חלק מהנתונים לא נשמרו לענן'}`;
					
					showToast(message, 'success', 8000);
				} else {
					showToast('לא נמצאו נתונים חדשים לייבוא', 'info');
				}
				
			} catch (error) {
				console.error('❌ Error in fast import:', error);
				hideLoading();
				showToast('שגיאה בייבוא מהיר', 'error');
			}
		}
		

	   
	   ////////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

		// החלף את saveEditedLocation בפונקציה זו:
		function saveEditedLocation(locationId) {
			console.log(`✅ saveEditedLocation ('${locationId}')`);
			const locationIndex = locations.findIndex(g => g.ID == locationId);
			if (locationIndex === -1) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			try {
				// עדכן את הלקוח במערך המקומי
				const updatedLocation = {
					...locations[locationIndex], // שמור נתונים קיימים
					name: document.getElementById('editLocationName').value,
					full_address: document.getElementById('editLocationAddress').value,
					neighborhood: document.getElementById('editLocationNeighborhood').value,
					city: document.getElementById('editLocationCity').value,
					contact_person: document.getElementById('editLocationContact').value,
					phone: document.getElementById('editLocationPhone').value,
					allowed_day: document.getElementById('editLocationDay').value,
					interval_weeks: parseInt(document.getElementById('editLocationInterval').value) || 4,
					base_amount: parseFloat(document.getElementById('editLocationAmount').value) || 0,
					active: document.getElementById('editLocationActive').value,
					next_visit: document.getElementById('editLocationNextVisit').value,
					client_requests: document.getElementById('editLocationClientRequests').value,
					notes: document.getElementById('editLocationNotes').value
				};
				
				locations[locationIndex] = updatedLocation;
				
				// שמור מקומית תמיד
				saveToLocalStorage();
				updateCloudStatus('💾 שומר...', 'מעדכן');
				
				// נסה לשמור בענן
				if (access_token && SPREADSHEET_ID) {
					console.log('🔍 About to call updateLocationInCloud with:', updatedLocation.client_requests);
					// עדכון בענן (לא הוספה חדשה)
					updateLocationInCloud(updatedLocation).then(() => {
						updateCloudStatus('✅ מחובר ומסונכרן', 'נשמר');
						showToast('לקוח עודכן בהצלחה במערכת ובענן!', 'success');
					}).catch(error => {
						console.error('❌ updateLocationInCloud failed:', error);
						if (error.status === 401) {
							updateCloudStatus('🔐 נדרש חיבור מחדש', 'נותק');
							showToast('⚠️ החיבור לגוגל פג - הלקוח נשמר מקומית בלבד', 'warning');
							access_token = null;
							document.getElementById('saveBtn').disabled = true;
							document.getElementById('loadBtn').disabled = true;
						} else {
							updateCloudStatus('⚠️ שגיאה בשמירה', 'שגיאה');
							showToast('⚠️ הלקוח נשמר מקומית, אבל לא הצליח לשמור בענן', 'warning');
						}
					});
				} else {
					updateCloudStatus('🔐 שינויים לא נשמרו בענן', 'מקומי');
					showToast('🔐 לקוח נשמר מקומית - התחבר לענן לשמירה מלאה', 'warning');
				}
				
				// עדכן תצוגה
				loadLocationsTable();
				loadLocationsForSelect();
				closeEditModal();
				
			} catch (error) {
				console.error('Error updating location:', error);
				updateCloudStatus('❌ שגיאה במערכת', 'שגיאה');
				showToast('שגיאה בעדכון הלקוח', 'error');
			}
		}


		// החלף את saveEditedReceipt בפונקציה זו:
		function saveEditedReceipt(receiptId) {
			console.log(`✅ saveEditedReceipt ('${receiptId}')`);
			const receiptIndex = receipts.findIndex(r => r.ID == receiptId);
			if (receiptIndex === -1) {
				showToast('קבלה לא נמצאה', 'error');
				return;
			}
			
			try {
				const locationId = document.getElementById('editReceiptLocation').value;
				const location = locations.find(g => g.ID == locationId);
				
				// עדכן את הקבלה במערך המקומי
				const updatedReceipt = {
					...receipts[receiptIndex], // שמור נתונים קיימים
					book_number: document.getElementById('editReceiptBook').value,
					receipt_number: document.getElementById('editReceiptNumber').value,
					date: document.getElementById('editReceiptDate').value,
					location_id: locationId,
					location_name: location ? location.name : '',
					amount: parseFloat(document.getElementById('editReceiptAmount').value) || 0,
					payment_type: document.getElementById('editReceiptPaymentType').value,
					notes: document.getElementById('editReceiptNotes').value
				};
				
				receipts[receiptIndex] = updatedReceipt;
				
				// שמור מקומית תמיד
				saveToLocalStorage();
				updateCloudStatus('💾 שומר קבלה...', 'מעדכן');
				
				// נסה לשמור בענן
				if (access_token && SPREADSHEET_ID) {
					updateReceiptInCloud(updatedReceipt).then(() => {
						updateCloudStatus('✅ מחובר ומסונכרן', 'נשמר');
						showToast('קבלה עודכנה בהצלחה במערכת ובענן!', 'success');
					}).catch(error => {
						if (error.status === 401) {
							updateCloudStatus('🔐 נדרש חיבור מחדש', 'נותק');
							showToast('⚠️ החיבור לגוגל פג - הקבלה נשמרה מקומית בלבד', 'warning');
							access_token = null;
						} else {
							updateCloudStatus('⚠️ שגיאה בשמירה', 'שגיאה');
							showToast('⚠️ הקבלה נשמרה מקומית, אבל לא הצליחה לשמור בענן', 'warning');
						}
					});
				} else {
					updateCloudStatus('🔐 שינויים לא נשמרו בענן', 'מקומי');
					showToast('🔐 קבלה נשמרה מקומית - התחבר לענן לשמירה מלאה', 'warning');
				}
				
				// עדכן תצוגה
				loadReceiptsTable();
				loadReceiptFilterOptions();
				closeEditModal();
				
			} catch (error) {
				console.error('Error updating receipt:', error);
				updateCloudStatus('❌ שגיאה במערכת', 'שגיאה');
				showToast('שגיאה בעדכון הקבלה', 'error');
			}
		}



		// saveEditedVisit
		async function saveEditedVisit() {
			const visitId = document.getElementById('editVisitId').value;
			const visitIndex = visits.findIndex(v => v.ID === visitId);
			
			if (visitIndex === -1) {
				showToast('ביקור לא נמצא', 'error');
				return;
			}
			
			// Update visit object
			visits[visitIndex] = {
				ID: visitId,
				date: document.getElementById('editVisitDate').value,
				location_id: visits[visitIndex].location_id,
				location_name: visits[visitIndex].location_name,
				visit_type: document.getElementById('editVisitType').value,
				work_done: document.getElementById('editWorkDone').value,
				duration_minutes: parseInt(document.getElementById('editManualDurationMinutes').value) || 0,
				num_workers: parseInt(document.getElementById('editNumWorkers').value) || 1,
				start_time: document.getElementById('editStartTime').value || '',
				end_time: document.getElementById('editEndTime').value || '',
				amount: parseFloat(document.getElementById('editAmount').value) || 0,
				paid: visits[visitIndex].paid || 'no',  // ✅ PRESERVE: keep existing paid status
				expense: parseFloat(document.getElementById('editExpense').value) || 0,
				notes: document.getElementById('editNotes').value || ''
			};
			
			// Save locally
			saveToLocalStorage();
			
			// Save to cloud if connected
			if (access_token && SPREADSHEET_ID) {
				await saveAllToSheetsOptimized();
			}
			
			// Update treatment dates
			await updateSingleLocationTreatmentDates(visits[visitIndex].location_id);
			
			// Refresh display
			filterVisits();
			closeEditModal();
			
			showToast('✅ הטיפול עודכן בהצלחה', 'success');
		}

	

	   
	   //////////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	   
	   
	   function formatDateForSheets(dateString) {
			if (!dateString) return '';
			const date = new Date(dateString);
			const day = String(date.getDate()).padStart(2, '0');
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const year = date.getFullYear();
			return `${day}/${month}/${year}`;
		}
	   
	   
	   // פונקציה להמרת סטטוס תשלום לקידוד מספרי
		function mapPaymentStatus(value) {
			if (!value || value.trim() === '') return "0";
			const normalized = value.toString().toLowerCase().trim();
			
			// המרה פשוטה לפי הערכים שיכולים להגיע מהייבוא
			if (normalized === "כן" || normalized === "true" || normalized === "1") return "1";
			if (normalized === "ללא תשלום" || normalized === "ללא") return "2";
			return "0"; // כל השאר = לא שולם
		}

		// פונקציה להצגת טקסט ידידותי
		function getPaymentStatusText(status) {
			switch(status) {
				case "0": return "לא שולם";
				case "1": return "שולם"; 
				case "2": return "ללא תשלום";
				default: return "לא שולם";
			}
		}
	   
	   
	   function parseAddressForImport(customerName) {
			if (!customerName) return { name: '', fullAddress: '', neighborhood: '', city: '' };
			
			const originalAddress = customerName.trim();
			const parts = originalAddress.split(' ');
			let city = '';
			
			if (parts.length >= 3) {
				// חיפוש מספר בית (מספר + אולי אות א/ב)
				let houseNumberIndex = -1;
				for (let i = 0; i < parts.length; i++) {
					if (/^\d+[א-ב]?$/.test(parts[i])) {
						houseNumberIndex = i;
						break; // לוקח את המספר הראשון שנמצא
					}
				}
				
				if (houseNumberIndex !== -1 && houseNumberIndex < parts.length - 1) {
					// יש מספר בית - כל מה שאחריו הוא עיר
					city = parts.slice(houseNumberIndex + 1).join(' ');
				} else {
					// אין מספר בית - כל הכתובת היא עיר
					city = originalAddress;
				}
			} else {
				// פחות מ-3 מילים - כל הכתובת היא עיר
				city = originalAddress;
			}
			
			// ✅ המרת הקיצור אחרי שקבענו את העיר
			if (city === 'ראשלצ') {
				city = 'ראשון לציון';
			}
			
			return {
				name: originalAddress, // השם המקורי ללא שינוי
				fullAddress: originalAddress,
				neighborhood: '', // ריק למילוי ידני
				city: city
			};
		}
		
		
		// פונקציה לעדכון תאריך טיפול הבא
		// עדכון תאריך טיפול הבא ללקוח
		function updateClientNextVisit(clientId, newDate) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לא נמצא לקוח', 'error');
				return;
			}
			
			// בדיקת תקינות התאריך
			if (!newDate || isNaN(new Date(newDate))) {
				showToast('תאריך לא תקין', 'error');
				return;
			}
			
			const oldDate = client.next_visit;
			client.next_visit = newDate;
			
			// איפוס הוספות זמניות
			if (client.temp_addition) {
				client.temp_addition = 0;
			}
			
			// שמירה מקומית
			saveToLocalStorage();
			
			// שמירה בענן אם מחובר
			if (access_token && SPREADSHEET_ID) {
				updateLocationInCloud(client).then(() => {
					console.log('✅ תאריך עודכן בענן');
				}).catch(error => {
					console.error('❌ שגיאה בעדכון ענן:', error);
					showToast('התאריך עודכן מקומית, אך לא בענן', 'warning');
				});
			}
			
			const formattedDate = formatDate(newDate);
			showToast(`תאריך הטיפול הבא עבור ${client.name} עודכן ל-${formattedDate}`, 'success');
			
			// רענון התצוגה
			setTimeout(() => {
				loadPlanningDataAdvanced();
			}, 300);
		}

		// פונקציה להפיכת לקוח לפעיל/לא פעיל
		function toggleClientActive(clientId, activeValue) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			client.active = activeValue;
			
			// שמירה
			saveToLocalStorage();
			
			// עדכון בענן אם מחובר
			if (access_token && SPREADSHEET_ID) {
				updateLocationInCloud(client);
			}
			
			const statusText = activeValue === "1" ? "פעיל" : "לא פעיל";
			showToast(`${client.name} הוגדר כ-${statusText}`, 'success');
			
			// רענון התצוגה (הלקוח ייעלם אם לא פעיל)
			loadPlanningDataAdvanced();
		}

		// פונקציה להצגת היסטוריית טיפולים
		function showClientHistory(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			// מציאת 3 הטיפולים האחרונים
			const clientVisits = visits
				.filter(visit => visit.location_id === clientId)
				.sort((a, b) => new Date(b.date) - new Date(a.date))
				.slice(0, 3);
			
			if (clientVisits.length === 0) {
				alert(`${client.name}\nאין עדיין היסטוריית טיפולים`);
				return;
			}
			
			// בניית תוכן החלונית
			let historyHtml = `
				<div style="background: white; padding: 20px; border-radius: 10px; max-width: 500px; max-height: 400px; overflow-y: auto;">
					<h3 style="margin-bottom: 15px; color: #333;">📋 היסטוריית טיפולים - ${client.name}</h3>
					<div style="margin-bottom: 20px; font-size: 12px; color: #666;">
						כתובת: ${client.full_address}
					</div>
					<div style="space-y: 10px;">
			`;
			
			clientVisits.forEach((visit, index) => {
				const visitDate = formatDate(visit.date);
				const amount = visit.amount || 0;
				const workDone = visit.work_done || 'טיפול';
				const paidStatus = visit.paid === 'כן' ? '✅ שולם' : '❌ לא שולם';
				const paidColor = visit.paid === 'כן' ? '#28a745' : '#dc3545';
				
				historyHtml += `
					<div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 10px; background: ${index === 0 ? '#f8f9ff' : '#fafafa'};">
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
							<strong style="color: #2c3e50;">📅 ${visitDate}</strong>
							<span style="font-weight: bold; color: ${paidColor};">${paidStatus}</span>
						</div>
						<div style="margin-bottom: 5px; color: #666;">
							🛠️ עבודה: ${workDone}
						</div>
						<div style="display: flex; justify-content: space-between; font-size: 14px;">
							<span>💰 ₪${amount}</span>
							${visit.duration_minutes ? `<span>⏱️ ${visit.duration_minutes} דק'</span>` : ''}
						</div>
						${visit.notes ? `<div style="margin-top: 8px; font-size: 12px; color: #666; font-style: italic;">📝 ${visit.notes}</div>` : ''}
					</div>
				`;
			});
			
			historyHtml += `
					</div>
					<div style="text-align: center; margin-top: 20px;">
						<button onclick="closeModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
							סגור
						</button>
					</div>
				</div>
			`;
			
			// הצגת החלונית
			showModal(historyHtml);
		}
		
	   
	   // פונקציה לעדכון לקוח ספציפי בענן
		async function updateLocationInCloud(client) {
			if (!await validateToken()) return;
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:A'
				});
				
				const rows = response.result.values || [];
				const rowIndex = rows.findIndex(row => row[0] === client.ID);
				
				if (rowIndex > 0) {
					const rowNumber = rowIndex + 1;
					const clientRow = [
						client.ID, client.name, client.full_address, client.neighborhood, client.city,
						client.contact_person, client.phone, client.allowed_day, client.interval_weeks,
						client.temp_addition || 0, // ✅ הוסף בדיקה
						client.base_amount, client.active, client.notes,
						client.last_visit, client.next_visit, client.client_requests || ''
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Locations!A${rowNumber}:P${rowNumber}`,
						valueInputOption: 'USER_ENTERED',
						resource: { values: [clientRow] }
					});
					
					console.log('✅ Successfully updated client in cloud'); // לוג להצלחה
				} else {
					throw new Error(`Client with ID ${client.ID} not found in spreadsheet`);
				}
			} catch (error) {
				console.error('Error updating client in cloud:', error);
				throw error; // ✅ חשוב - העבר את השגיאה הלאה
			}
		}
	   
	   
	   // ===== פונקציות פענוח הכנסות מטלגרם =====

		// המרת תאריך מפורמט טלגרם ל-ISO
		function parseTelegramDateToISO(dateStr) {
			const months = {
				'January': '01', 'February': '02', 'March': '03', 'April': '04',
				'May': '05', 'June': '06', 'July': '07', 'August': '08',
				'September': '09', 'October': '10', 'November': '11', 'December': '12'
			};
			
			const parts = dateStr.split(' ');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = months[parts[1]] || '01';
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			return dateStr;
		}

		// פענוח שורת הכנסה בודדת
		function parseIncomeLineFromTelegram(line, date, time) {
			try {
				// חילוץ כתובת לקוח
				let clientAddress = '';
				const dotIndex = line.indexOf('.');
				if (dotIndex > 0) {
					clientAddress = line.substring(0, dotIndex).trim();
				} else {
					const beforeReceived = line.split('קיבלתי')[0].trim();
					clientAddress = beforeReceived.replace(/[.,]$/, '');
				}

				// חילוץ סכום - גרסה משופרת
				let amount = 0;
				const amountPatterns = [
					/קיבלתי\s+תשלום\s+(\d+)/,     
					/קיבלתי\s+(\d+)/,              
					/קיבלתי\s+צ'ק\s+(\d+)/,        
					/קיבלתי\s+עוד\s+(\d+)/,        
					/(\d+)\s+מזומן/,               
					/(\d+)\s+ביט/,                 
					/(\d+)\s+העברה/,               
					/(\d+)\s+פייבוקס/,
					/(\d+)\s+צ'ק/
				];
				
				for (const pattern of amountPatterns) {
					const match = line.match(pattern);
					if (match) {
						amount = parseInt(match[1]);
						break;
					}
				}
				
				// אם עדיין לא מצאנו, חפש מספרים גדולים
				if (amount === 0) {
					const allNumbers = line.match(/\d+/g);
					if (allNumbers && allNumbers.length > 0) {
						const numbers = allNumbers.map(n => parseInt(n)).filter(n => n >= 50);
						if (numbers.length > 0) {
							amount = Math.max(...numbers);
						}
					}
				}

				// זיהוי אמצעי תשלום - עם תיקון "לא צוין" = מזומן
				let paymentMethod = 'מזומן'; // ברירת מחדל במקום "לא צוין"
				if (line.includes('העברה לחשבון') || line.includes('העברה')) {
					paymentMethod = 'העברה בנקאית';
				} else if (line.includes('צ\'ק')) {
					paymentMethod = 'צ\'ק';
				} else if (line.includes('ביט')) {
					paymentMethod = 'ביט';
				} else if (line.includes('מזומן')) {
					paymentMethod = 'מזומן';
				} else if (line.includes('פייבוקס')) {
					paymentMethod = 'פייבוקס';
				}

				// חילוץ הערות
				let notes = '';
				if (line.includes('עבור')) {
					const match = line.match(/עבור[^.]+/);
					if (match) notes += match[0] + ' ';
				}
				if (line.includes('שכחתי') || line.includes('לא רשמתי') || line.includes('לא עדכנתי')) {
					notes += 'לא תועד מיד ';
				}
				if (line.includes('על החשבון') || line.includes('חוב')) {
					notes += 'תשלום על חשבון ';
				}

				return {
					date: date,
					time: time,
					client_address: clientAddress,
					amount: amount,
					payment_method: paymentMethod,
					notes: notes.trim(),
					raw_text: line
				};
			} catch (error) {
				console.error('שגיאה בפענוח שורת הכנסה:', line, error);
				return null;
			}
		}

		// פענוח מלא של נתוני הכנסות מטלגרם
		function parseIncomesFromTelegramText(telegramText) {
			const lines = telegramText.split('\n').map(line => line.replace(/\r$/, '').trim());
			const incomes = [];
			let currentDate = '';
			let currentTime = '';
			
			for (let i = 0; i < lines.length; i++) {
				const line = lines[i];
				
				// זיהוי תאריך (15 August 2024)
				if (/^\d{1,2} \w+ \d{4}$/.test(line)) {
					currentDate = parseTelegramDateToISO(line);
					continue;
				}
				
				// זיהוי שעה (20:04)
				if (/^\d{1,2}:\d{2}$/.test(line)) {
					currentTime = line;
					continue;
				}
				
				// זיהוי הודעת הכנסה (מכילה "קיבלתי" ומספר)
				if (line.includes('קיבלתי') && /\d+/.test(line)) {
					const income = parseIncomeLineFromTelegram(line, currentDate, currentTime);
					if (income && income.amount > 0) {
						incomes.push(income);
					}
				}
			}
			
			return incomes;
		}


		// ===== פונקציות אישור ייבוא הכנסות =====

		// ===== פונקציות וידוא קיום גיליונות נדרשים =====

		// וידוא קיום גיליון הכנסות במערכת הראשית
		async function ensureIncomesSheetExists() {
			if (!await validateToken()) return false;
			
			try {
				const response = await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				
				const existingSheets = response.result.sheets.map(sheet => sheet.properties.title);
				
				if (!existingSheets.includes('Incomes')) {
					console.log('יוצר גיליון הכנסות...');
					
					await gapi.client.sheets.spreadsheets.batchUpdate({
						spreadsheetId: SPREADSHEET_ID,
						resource: {
							requests: [{
								addSheet: {
									properties: {
										title: 'Incomes',
										gridProperties: {
											rowCount: 1000,
											columnCount: 12
										}
									}
								}
							}]
						}
					});
					
					// הוספת כותרות
					const headers = [
						'ID', 'תאריך', 'שעה', 'כתובת_לקוח', 'מזהה_לקוח', 
						'סכום', 'אמצעי_תשלום', 'הערות', 'טקסט_מקורי', 
						'מקור_ייבוא', 'תאריך_ייבוא', 'סטטוס'
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: 'Incomes!A1:L1',
						valueInputOption: 'RAW',
						resource: { values: [headers] }
					});
					
					console.log('✅ גיליון הכנסות נוצר');
				}
				
				return true;
				
			} catch (error) {
				console.error('שגיאה בוידוא גיליון הכנסות:', error);
				return false;
			}
		}

		
		// הוספת כפתור העלאה לממשק (להוסיף למקום המתאים בממשק)
		function addTelegramIncomeUploadButton() {
			const uploadHTML = `
				<div class="upload-section" style="margin: 20px 0; padding: 20px; border: 2px dashed #3498db; border-radius: 10px; text-align: center;">
					<h3 style="color: #3498db; margin-bottom: 15px;">📤 ייבוא הכנסות מטלגרם</h3>
					<p style="color: #666; margin-bottom: 20px;">בחר קובץ טקסט עם ייצוא הכנסות מטלגרם</p>
					<input type="file" id="telegramIncomeFile" accept=".txt,.json" style="display: none;" onchange="handleTelegramIncomeFileUpload(event)">
					<button class="btn btn-primary" onclick="document.getElementById('telegramIncomeFile').click()" style="padding: 12px 25px; font-size: 16px;">
						📁 בחר קובץ הכנסות מטלגרם
					</button>
				</div>
			`;
			
			return uploadHTML;
		}


		// ===== פונקציות עזר נוספות למערכת הכנסות =====

		// יצירת פונקציה לטעינת רשימת הכנסות (אם לא קיימת)
		function loadIncomesTable() {
			if (typeof incomes === 'undefined' || !incomes.length) {
				console.log('📊 אין הכנסות להצגה');
				return;
			}
			
			console.log(`📊 טוען ${incomes.length} הכנסות לתצוגה`);
			// כאן תוסיף את הלוגיקה להצגת הכנסות בממשק בעתיד
		}

		// אתחול מערך הכנסות אם לא קיים
		if (typeof incomes === 'undefined') {
			window.incomes = [];
		}

	
		// ===== פונקציות יצירת גיליונות נוספים במערכת =====

		// יצירת גיליון הכנסות בקובץ הראשי
		async function createIncomesSheet() {
			if (!await validateToken()) {
				showToast('התחבר לגוגל קודם', 'warning');
				return false;
			}
			
			try {
				showLoading('יוצר גיליון הכנסות...');
				
				// בדיקה אם הגיליון כבר קיים
				const sheetsResponse = await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				
				const existingSheet = sheetsResponse.result.sheets.find(sheet => 
					sheet.properties.title === 'Incomes'
				);
				
				if (existingSheet) {
					hideLoading();
					showToast('גיליון הכנסות כבר קיים', 'info');
					return true;
				}
				
				// יצירת הגיליון החדש
				await gapi.client.sheets.spreadsheets.batchUpdate({
					spreadsheetId: SPREADSHEET_ID,
					resource: {
						requests: [{
							addSheet: {
								properties: {
									title: 'Incomes',
									gridProperties: {
										rowCount: 1000,
										columnCount: 10
									}
								}
							}
						}]
					}
				});
				
				// הוספת כותרות
				const headers = [
					'ID', 'תאריך', 'שעה', 'כתובת_לקוח', 'מזהה_לקוח', 
					'סכום', 'אמצעי_תשלום', 'הערות', 'טקסט_מקורי', 'מקור_ייבוא'
				];
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Incomes!A1:J1',
					valueInputOption: 'RAW',
					resource: { values: [headers] }
				});
				
				hideLoading();
				showToast('✅ גיליון הכנסות נוצר בהצלחה!', 'success');
				return true;
				
			} catch (error) {
				console.error('שגיאה ביצירת גיליון הכנסות:', error);
				hideLoading();
				showToast('שגיאה ביצירת גיליון הכנסות', 'error');
				return false;
			}
		}

		

		// ===== פונקציות שמירה לטבלאות החדשות =====



		// טעינת הכנסות מטלגרם מהעלנן
		async function loadTelegramIncomesFromCloud() {
			if (!access_token || !SPREADSHEET_ID) {
				return [];
			}
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'TelegramIncomes!A2:L1000'
				});
				
				if (!response.result.values) {
					return [];
				}
				
				return response.result.values.map(row => ({
					ID: row[0] || '',
					date: row[1] || '',
					time: row[2] || '',
					client_address: row[3] || '',
					amount: parseFloat(row[4]) || 0,
					payment_method: row[5] || '',
					notes: row[6] || '',
					raw_text: row[7] || '',
					matched_to_visit: row[8] === 'true' || row[8] === true,
					visit_ids: row[9] ? row[9].split(',') : [],
					processed: row[10] === 'true' || row[10] === true,
					created_at: row[11] || ''
				}));
				
			} catch (error) {
				console.error('שגיאה בטעינת הכנסות מטלגרם:', error);
				return [];
			}
		}

		// ===== פונקציות לוגיקת תשלומים חדשה =====

		// משתני גלובליים לתשלומים
		let payments = [];
		let paymentVisitLinks = [];

		// בדיקת סטטוס תשלום של ביקור
		function getVisitPaymentStatus(visitId) {
			const visit = visits.find(v => v.ID === visitId);
			if (!visit) return 'unpaid';
			
			// ✅ UPDATED: Use the new parser
			const paidInfo = parsePaidField(visit.paid);
			return paidInfo.status;
		}

		// ✅ NEW: Parse the paid field to get detailed payment info
		function parsePaidField(paidValue) {
			if (!paidValue || paidValue === 'unpaid') {
				return { status: 'unpaid', date: null, amount: 0 };
			}
			
			if (paidValue === 'no_payment') {
				return { status: 'no_payment', date: null, amount: 0 };
			}
			
			// Check for paid with date: "paid:2024-10-23"
			if (paidValue.startsWith('paid:')) {
				const date = paidValue.substring(5);
				return { status: 'paid', date: date, amount: null };
			}
			
			// Check for partial payment: "partial:500"
			if (paidValue.startsWith('partial:')) {
				const amount = parseFloat(paidValue.substring(8)) || 0;
				return { status: 'partial', date: null, amount: amount };
			}
			
			// Old format compatibility: just "paid" without date
			if (paidValue === 'paid') {
				return { status: 'paid', date: null, amount: null };
			}
			
			// Default fallback
			return { status: 'unpaid', date: null, amount: 0 };
		}

		


		// טקסט סטטוס תשלום מעודכן
		function getPaymentStatusText(status) {
			switch (status) {
				case 'paid': return 'שולם';
				case 'unpaid': return 'לא שולם';
				case 'no_payment': return 'ללא תשלום';
				case 'partial': return 'שולם חלקית';
				default: return 'לא ידוע';
			}
		}

		// חישוב סכום שולם עבור ביקור
		function getVisitPaidAmount(visitId) {
			const visit = visits.find(v => v.ID === visitId);
			if (!visit) return 0;
			
			// שיטה 1: חישוב מתוך PaymentVisitLinks (המדויק ביותר)
			const relatedLinks = paymentVisitLinks.filter(link => link.visit_id === visitId);
			if (relatedLinks.length > 0) {
				// יש קישורי תשלום - חשב לפי הקישורים
				const totalFromLinks = relatedLinks.reduce((sum, link) => sum + (parseFloat(link.amount_allocated) || 0), 0);
				return totalFromLinks;
			}
			
			// שיטה 2: חישוב מתוך visit.paid (backwards compatibility)
			const paidInfo = parsePaidField(visit.paid);
			const visitAmount = parseFloat(visit.amount) || 0;
			
			if (paidInfo.status === 'paid') {
				// Fully paid - return full amount
				return visitAmount;
			}
			
			if (paidInfo.status === 'partial') {
				// Partially paid - return the partial amount
				return paidInfo.amount;
			}
			
			if (paidInfo.status === 'no_payment') {
				// No payment needed - return full amount (no debt)
				return visitAmount;
			}
			
			// Unpaid - return 0
			return 0;
		}

		// ===== פונקציות טיפול בתשלומים ===== 

		// פונקציה חדשה לסימון חובות כשולמים
		async function markAllDebtsPaid(locationId) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// מצא כל הביקורים הלא שולמים של הלקוח
			const unpaidVisits = visits.filter(visit => {
				if (visit.location_id !== locationId || !visit.amount || visit.amount <= 0) {
					return false;
				}
				
				const paidAmount = getVisitPaidAmount(visit.ID);
				const debt = parseFloat(visit.amount) - paidAmount;
				return debt > 0;
			});
			
			if (unpaidVisits.length === 0) {
				showToast('אין חובות פתוחים ללקוח זה', 'info');
				return;
			}
			
			const totalDebt = unpaidVisits.reduce((sum, visit) => {
				const paidAmount = getVisitPaidAmount(visit.ID);
				return sum + (parseFloat(visit.amount) - paidAmount);
			}, 0);
			
			if (confirm(`לסמן את כל החובות של ${location.name} כמסולקים?\n\nסה"כ: ₪${totalDebt.toLocaleString()}\nמספר טיפולים: ${unpaidVisits.length}`)) {
				
				try {
					showLoading('יוצר תשלום ומעדכן מערכת...');
					
					// צור תשלום אחד עבור כל החובות
					const payment = {
						ID: generateID(),
						date: new Date().toISOString().split('T')[0],
						time: new Date().toTimeString().substr(0, 5),
						amount: totalDebt,
						payment_method: 'cash',
						source_type: 'debt_settlement',
						client_id: locationId,
						notes: `סילוק חובות - ${unpaidVisits.length} טיפולים`,
						status: 'completed',
						created_at: new Date().toISOString()
					};
					
					// הוסף תשלום למערכת
					payments.push(payment);
					
					// צור קישורים לכל הביקורים
					for (const visit of unpaidVisits) {
						const paidAmount = getVisitPaidAmount(visit.ID);
						const debtAmount = parseFloat(visit.amount) - paidAmount;
						
						if (debtAmount > 0) {
							const link = {
								ID: generateID(),
								payment_id: payment.ID,
								visit_id: visit.ID,
								amount_allocated: debtAmount,
								link_type: 'debt_settlement',
								created_at: new Date().toISOString()
							};
							
							paymentVisitLinks.push(link);
						}
					}
					
					// שמירה מקומית
					saveToLocalStorage();
					
					// שמירה בענן
					if (access_token && SPREADSHEET_ID) {
						await saveAllToSheetsOptimized();
						
						// שמור את כל הקישורים
						for (const link of paymentVisitLinks.filter(l => l.payment_id === payment.ID)) {
							await saveAllToSheetsOptimized();
						}
					}
					
					hideLoading();
					
					// רענון התצוגה
					displayDebts();
					
					showToast(`החובות של ${location.name} סומנו כמסולקים!
		💰 ₪${totalDebt.toLocaleString()} סולקו
		📋 ${unpaidVisits.length} טיפולים עודכנו`, 'success', 5000);
					
				} catch (error) {
					hideLoading();
					console.error('שגיאה בעדכון תשלומים:', error);
					showToast('שגיאה בעדכון התשלומים', 'error');
				}
			}
		}


		// פונקציות לחיפוש לקוחות היברידי
		let clientDropdownOpen = false;

		function handleClientSearch(searchTerm) {
			if (searchTerm.length === 0) {
				showAllClients();
				return;
			}
			
			// שימוש בפונקציית החיפוש החכמה החדשה
			const filteredClients = searchClientsAdvanced(searchTerm);
			populateClientDropdown(filteredClients);
			showClientDropdown();
		}

		function showAllClients() {
			const allClients = locations
				.filter(location => location.active === "1")
				.slice(0, 10);
			populateClientDropdown(allClients);
		}

		function showClientDropdown() {
			document.getElementById('clientDropdown').style.display = 'block';
			clientDropdownOpen = true;
		}

		function hideClientDropdown() {
			setTimeout(() => {
				document.getElementById('clientDropdown').style.display = 'none';
				clientDropdownOpen = false;
			}, 200);
		}

		function toggleClientDropdown() {
			if (clientDropdownOpen) {
				hideClientDropdown();
			} else {
				showAllClients();
				showClientDropdown();
			}
		}

		function populateClientDropdown(clients) {
			const dropdown = document.getElementById('clientDropdown');
			if (!dropdown) return;
			
			if (clients.length === 0) {
				dropdown.innerHTML = '<div style="padding: 10px; color: #666; text-align: center;">לא נמצאו לקוחות</div>';
				return;
			}
			
			const html = clients.map(client => `
				<div class="client-option" onclick="selectClientFromDropdown('${client.ID}')" 
					 style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;">
					<div style="font-weight: bold;">${client.name}</div>
					<div style="font-size: 12px; color: #666;">${client.full_address}</div>
				</div>
			`).join('');
			
			dropdown.innerHTML = html;
		}

		function selectClientFromDropdown(clientId) {
			const client = locations.find(c => c.ID === clientId);
			if (!client) return;
			
			document.getElementById('clientSearchInput').value = `${client.name} - ${client.full_address}`;
			document.getElementById('selectedClientId').value = clientId;
			
			hideClientDropdown();
		}

		function openAddClientModal() {
			showAddLocationForm();
		}

		// הגדרת השעה הנוכחית
		// Update the existing setCurrentTime function to handle edit form
		function setCurrentTime(timeInputId) {
			const now = new Date();
			const hours = String(now.getHours()).padStart(2, '0');
			const minutes = String(now.getMinutes()).padStart(2, '0');
			const currentTime = `${hours}:${minutes}`;
			
			document.getElementById(timeInputId).value = currentTime;
			
			// חישוב משך טיפול אם שני השדות מלאים
			if (timeInputId.includes('modal')) {
				calculateModalDuration();
			} else if (timeInputId.includes('edit')) {
				calculateEditDuration(); // ✅ הוספה לטופס העריכה
			} else {
				calculateDurationFromTimes();
			}
			
			showToast(`שעה נוכחית: ${currentTime}`, 'info');
		}

		function calculateModalDuration() {
			const startTime = document.getElementById('modalStartTime').value;
			const endTime = document.getElementById('modalEndTime').value;
			
			if (!startTime || !endTime) return;
			
			const start = new Date(`2000-01-01T${startTime}`);
			const end = new Date(`2000-01-01T${endTime}`);
			
			if (end <= start) {
				showToast('שעת סיום חייבת להיות אחרי שעת התחלה', 'warning');
				return;
			}
			
			const diffMs = end - start;
			const totalMinutes = Math.round(diffMs / (1000 * 60));
			const hours = Math.floor(totalMinutes / 60);
			const minutes = totalMinutes % 60;
			const decimalHours = (totalMinutes / 60).toFixed(1);
			
			// עדכון השדות
			document.getElementById('modalDurationHours').value = hours;
			document.getElementById('modalDurationMinutes').value = minutes;
			document.getElementById('modalManualDurationMinutes').value = totalMinutes;
			document.getElementById('modalCalculatedHours').value = decimalHours;
			
			// עדכון שעת הביקור לתצוגה
			document.getElementById('modalVisitTime').value = startTime;
			
			// חישוב עלות אוטומטי
			calculateModalTreatmentCost();
		}

		function updateModalManualDuration() {
			const hours = parseInt(document.getElementById('modalDurationHours').value) || 0;
			const minutes = parseInt(document.getElementById('modalDurationMinutes').value) || 0;
			const totalMinutes = hours * 60 + minutes;
			const decimalHours = (totalMinutes / 60).toFixed(1);
			
			document.getElementById('modalManualDurationMinutes').value = totalMinutes;
			document.getElementById('modalCalculatedHours').value = decimalHours;
			
			calculateModalTreatmentCost();
		}

		function updateModalFromTotalMinutes() {
			const totalMinutes = parseInt(document.getElementById('modalManualDurationMinutes').value) || 0;
			const hours = Math.floor(totalMinutes / 60);
			const minutes = totalMinutes % 60;
			const decimalHours = (totalMinutes / 60).toFixed(1);
			
			document.getElementById('modalDurationHours').value = hours;
			document.getElementById('modalDurationMinutes').value = minutes;
			document.getElementById('modalCalculatedHours').value = decimalHours;
			
			calculateModalTreatmentCost();
		}

		function calculateModalTreatmentCost() {
			// console.log('calculateModalTreatmentCost called!');
			
			const totalMinutes = parseInt(document.getElementById('modalManualDurationMinutes').value) || 0;
			const numWorkers = parseInt(document.getElementById('modalNumWorkers').value) || 1;
			const expense = parseFloat(document.getElementById('modalExpense').value) || 0;
			
			// console.log('Calculation params:', { totalMinutes, numWorkers, expense, costSettings });
			
			if (totalMinutes > 0 && costSettings && costSettings.hourlyRate) {
				const hours = totalMinutes / 60;
				const baseCost = costSettings.hourlyRate * hours;
				const workersCost = (numWorkers - 1) * costSettings.workerCost * hours;
				const laborCost = baseCost + workersCost;
				const totalCost = laborCost + expense; // הוספת ההוצאות!
				
				document.getElementById('modalAmount').value = Math.round(totalCost);
				
				// console.log('Calculated cost:', Math.round(totalCost));
				
				const message = `מחושב: ${hours.toFixed(1)} שעות × ${costSettings.hourlyRate}₪ = ${Math.round(totalCost)}₪`;
				// console.log(message);
			} else {
				// console.log('Missing data for calculation:', { totalMinutes, costSettings });
			}
		}

		function loadModalClientOptions() {
			const activeLocations = locations.filter(loc => loc.active === "1" || loc.active === true || loc.active === "כן");
			
			// מיון לפי שם
			activeLocations.sort((a, b) => a.name.localeCompare(b.name, 'he'));
			
			// הגדרת autocompletion לחיפוש לקוחות
			const searchInput = document.getElementById('modalClientSearchInput');
			const optionsDiv = document.getElementById('modalClientOptions');
			
			// נקה רשימת אפשרויות קודמת
			optionsDiv.innerHTML = '';
			
			// הוסף event listener לחיפוש
			searchInput.addEventListener('input', function() {
				filterClientOptions('modalClientSearchInput', 'modalClientOptions');
			});
		}

		function selectModalClient(clientId, clientName) {
			document.getElementById('modalSelectedClientId').value = clientId;
			document.getElementById('modalClientSearchInput').value = clientName;
			document.getElementById('modalClientOptions').style.display = 'none';
			
			// חישוב עלות אוטומטי כשמבחרים לקוח
			calculateModalTreatmentCost();
		}



		// קביעת טיפול לשבוע/שבועיים
		function setNextAllowedDay(clientId, allowedDay, weeksAhead = 1) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// מיפוי ימים לא ינדקס השבוע (0=ראשון, 1=שני...)
			const dayToNumber = {
				'א': 0,
				'ב': 1,
				'ג': 2,
				'ד': 3,
				'ה': 4,
				'ו': 5,
				'ש': 6,
				'כל יום': 0 // ברירת מחדל
			};
			
			const targetDayOfWeek = dayToNumber[allowedDay] || 0;
			const today = new Date();
			
			// חישוב התאריך הנכון - יום מועדף בעוד X שבועות
			const daysUntilTargetDay = (targetDayOfWeek - today.getDay() + 7) % 7;
			const targetDate = new Date(today);
			
			// אם היום המועדף הוא היום - קח אותו בשבוע הבא
			if (daysUntilTargetDay === 0 && weeksAhead === 1) {
				targetDate.setDate(today.getDate() + 7);
			} else {
				// אחרת - קח היום המועדף + שבועות נוספים
				targetDate.setDate(today.getDate() + daysUntilTargetDay + ((weeksAhead - 1) * 7));
			}
			
			const dateString = targetDate.toISOString().split('T')[0];
			
			// עדכון התאריך
			updateClientNextVisit(clientId, dateString);
			
			const weekText = weeksAhead === 1 ? 'שבוע' : 'שבועיים';
			showToast(`נקבע ${allowedDay} בעוד ${weekText} (${formatDate(dateString)})`, 'success');
		}

		function loadLocationsForSelect() {
			const select = document.getElementById('locationSelect');
			if (!select) return; // הוסף בדיקה
			
			select.innerHTML = '<option value="">בחר לקוח...</option>';
			
			locations.filter(location => location.active === "1").forEach(location => {
				const option = document.createElement('option');
				option.value = location.ID;
				option.textContent = `${location.name} - ${location.full_address}`;
				select.appendChild(option);
			});
		}

		// הגדרת תאריך היום לכל שדות התאריך
		function setTodayAsDefault() {
			const today = new Date().toISOString().split('T')[0];
			document.querySelectorAll('.planning-date-input').forEach(input => {
				if (!input.value) {
					input.value = today;
				}
			});
		}

		// סינון טבלת לקוחות
		function filterLocationsTable() {
			loadLocationsTable(); // טען מחדש עם סינון
		}

		// קבלת רשימה מסוננת של לקוחות
		function getFilteredLocations() {
			let filteredData = [...locations];
			
			// סינון לפי שם
			const nameFilter = document.getElementById('filterClientName')?.value.toLowerCase();
			if (nameFilter) {
				filteredData = filteredData.filter(location => 
					location.name.toLowerCase().includes(nameFilter) ||
					location.full_address.toLowerCase().includes(nameFilter)
				);
			}
			
			// סינון לפי יום
			const dayFilter = document.getElementById('filterDay')?.value;
			if (dayFilter) {
				filteredData = filteredData.filter(location => location.allowed_day === dayFilter);
			}
			
			// סינון לפי מרווח
			const intervalFilter = document.getElementById('filterInterval')?.value;
			if (intervalFilter) {
				filteredData = filteredData.filter(location => location.interval_weeks == intervalFilter);
			}
			
			// סינון לפי סטטוס
			const activeFilter = document.getElementById('filterActive')?.value;
			if (activeFilter !== "") {
				filteredData = filteredData.filter(location => location.active === activeFilter);
			}
			
			return filteredData;
		}

		// ניקוי סינונים
		function clearLocationFilters() {
			const nameFilter = document.getElementById('filterClientName');
			const dayFilter = document.getElementById('filterDay');
			const intervalFilter = document.getElementById('filterInterval');
			const activeFilter = document.getElementById('filterActive');
			
			if (nameFilter) nameFilter.value = '';
			if (dayFilter) dayFilter.value = '';
			if (intervalFilter) intervalFilter.value = '';
			if (activeFilter) activeFilter.value = '';
			
			loadLocationsTable();
		}



		function startTreatment(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// בדיקה האם יש כבר טיפול היום ללקוח
			const today = new Date().toISOString().split('T')[0];
			const existingTodayVisit = visits.find(visit => 
				visit.location_id === clientId && 
				visit.date === today
			);
			
			if (existingTodayVisit) {
				// יש כבר טיפול היום - פתח עריכה
				showToast(`נמצא טיפול קיים היום עבור ${client.name} - פותח לעריכה`, 'info');
				editVisit(existingTodayVisit.ID);
			} else {
				// אין טיפול היום - צור חדש
				showToast(`פותח טיפול חדש עבור ${client.name}`, 'success');
				
				// פתח טופס טיפול חדש עם הלקוח מוכן מראש
				showAddTreatmentForm();
				
				// אחרי פתיחת הטופס, מלא את פרטי הלקוח
				setTimeout(() => {
					const clientSearchInput = document.getElementById('modalClientSearchInput');
					const selectedClientId = document.getElementById('modalSelectedClientId');
					const modalDate = document.getElementById('modalVisitDate');
					
					if (clientSearchInput && selectedClientId) {
						clientSearchInput.value = `${client.name} - ${client.full_address}`;
						selectedClientId.value = clientId;
					}
					
					if (modalDate) {
						modalDate.value = today;
					}
					
					// חישוב עלות אוטומטי
					if (typeof calculateModalTreatmentCost === 'function') {
						calculateModalTreatmentCost();
					}
				}, 100);
			}
		}



		// Receipt filtering functions
		function loadReceiptFilterOptions() {
			// Load book numbers
			const bookSelect = document.getElementById('filterReceiptBook');
			if (bookSelect) {
				const uniqueBooks = [...new Set(receipts.map(r => r.book_number).filter(b => b))];
				bookSelect.innerHTML = '<option value="">כל הפנקסים</option>';
				uniqueBooks.sort().forEach(book => {
					bookSelect.innerHTML += `<option value="${book}">${book}</option>`;
				});
			}
		}

		// Update applyReceiptFilters function - add this at the beginning:
		function applyReceiptFilters() {
			// Check if smart search is active
			const smartSearch = document.getElementById('receiptSmartSearch')?.value;
			if (smartSearch && smartSearch.trim()) {
				handleReceiptSmartSearch(smartSearch);
				return;
			}
			
			let filteredReceipts = [...receipts];
			
			// Apply filters with null safety
			const bookFilter = document.getElementById('filterReceiptBook')?.value || '';
			const paymentFilter = document.getElementById('filterPaymentType')?.value || '';
			const dateFrom = document.getElementById('filterReceiptDateFrom')?.value || '';
			const dateTo = document.getElementById('filterReceiptDateTo')?.value || '';
			const sortBy = document.getElementById('receiptSortBy')?.value || 'date_desc';
			
			if (bookFilter) {
				filteredReceipts = filteredReceipts.filter(r => r.book_number === bookFilter);
			}
			
			if (paymentFilter) {
				filteredReceipts = filteredReceipts.filter(r => r.payment_type === paymentFilter);
			}
			
			if (dateFrom) {
				filteredReceipts = filteredReceipts.filter(r => r.date >= dateFrom);
			}
			
			if (dateTo) {
				filteredReceipts = filteredReceipts.filter(r => r.date <= dateTo);
			}
			
			// Sort results
			filteredReceipts.sort((a, b) => {
				switch(sortBy) {
					case 'date_asc': return a.date.localeCompare(b.date);
					case 'date_desc': return b.date.localeCompare(a.date);
					case 'amount_asc': return (a.amount || 0) - (b.amount || 0);
					case 'amount_desc': return (b.amount || 0) - (a.amount || 0);
					case 'book_asc': return (a.book_number || '').localeCompare(b.book_number || '');
					default: return b.date.localeCompare(a.date);
				}
			});
			
			displayFilteredReceipts(filteredReceipts);
			updateReceiptsStats(filteredReceipts);
		}

		function sortReceiptResults(receipts, sortBy) {
			switch(sortBy) {
				case 'date_desc':
					receipts.sort((a, b) => new Date(b.date) - new Date(a.date));
					break;
				case 'date_asc':
					receipts.sort((a, b) => new Date(a.date) - new Date(b.date));
					break;
				case 'amount_desc':
					receipts.sort((a, b) => (b.amount || 0) - (a.amount || 0));
					break;
				case 'amount_asc':
					receipts.sort((a, b) => (a.amount || 0) - (b.amount || 0));
					break;
				case 'book_asc':
					receipts.sort((a, b) => (a.book_number || '').localeCompare(b.book_number || ''));
					break;
			}
		}

		function clearReceiptFilters() {
			const bookFilter = document.getElementById('filterReceiptBook');
			const paymentType = document.getElementById('filterPaymentType');
			const dateFrom = document.getElementById('filterReceiptDateFrom');
			const dateTo = document.getElementById('filterReceiptDateTo');
			const sortBy = document.getElementById('receiptSortBy');
			const smartSearch = document.getElementById('receiptSmartSearch');
			
			if (bookFilter) bookFilter.value = '';
			if (paymentType) paymentType.value = '';
			if (dateFrom) dateFrom.value = '';
			if (dateTo) dateTo.value = '';
			if (sortBy) sortBy.value = 'date_desc';
			if (smartSearch) smartSearch.value = '';
			
			displayFilteredReceipts(receipts);
		}

		function displayFilteredReceipts(filteredReceipts) {
			const tbody = document.getElementById('receiptsTableBody');
			tbody.innerHTML = '';
			
			if (filteredReceipts.length === 0) {
				tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">אין קבלות מתאימות לסינון</td></tr>';
				return;
			}

			filteredReceipts.forEach(receipt => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${receipt.book_number || ''}</td>
					<td>${receipt.receipt_number || ''}</td>
					<td>${formatDate(receipt.date)}</td>
					<td>${receipt.location_name || ''}</td>
					<td>₪${receipt.amount || 0}</td>
					<td>${receipt.payment_type || ''}</td>
					<td>${receipt.codeX || ''}</td>
					<td>
						<button class="action-btn edit-btn" onclick="editReceipt('${receipt.ID}')">ערוך</button>
						<button class="action-btn delete-btn" onclick="deleteReceipt('${receipt.ID}')">מחק</button>
					</td>
				`;
				tbody.appendChild(row);
				
				// הוספת שורת הערות אם קיימות
				if (receipt.notes && receipt.notes.trim() !== '') {
					const notesRow = document.createElement('tr');
					notesRow.className = 'notes-row';
					notesRow.innerHTML = `
						<td colspan="8" class="notes-cell">
							<div class="notes-content">
								<strong>📝 הערות:</strong> ${receipt.notes}
							</div>
						</td>
					`;
					tbody.appendChild(notesRow);
				}
			});
			updateReceiptsStats(filteredReceipts);
		}

		// Update stats functions for all tabs

		function updateReceiptsStats(filteredReceipts) {
			const count = filteredReceipts.length;
			const total = filteredReceipts.reduce((sum, receipt) => {
				const amount = parseFloat(receipt.amount) || 0;
				return sum + amount;
			}, 0);
			const average = count > 0 ? Math.round(total / count) : 0;
			
			document.getElementById('receiptsCount').textContent = count;
			document.getElementById('receiptsTotal').textContent = `${Math.round(total)} ₪`; // העבר את ₪ לסוף
			document.getElementById('receiptsAverage').textContent = `${average} ₪`;
		}


		function updateDebtsStats(debtsArray) {
			const totalDebt = debtsArray.reduce((sum, debt) => sum + debt.totalDebt, 0);
			const debtorsCount = debtsArray.length;
			const averageDebt = debtorsCount > 0 ? totalDebt / debtorsCount : 0;
			
			// Update stats display
			const debtsCountElement = document.getElementById('debtsCount');
			const debtsTotalElement = document.getElementById('debtsTotal');
			const debtsAverageElement = document.getElementById('debtsAverage');
			
			if (debtsCountElement) debtsCountElement.textContent = debtorsCount;
			if (debtsTotalElement) debtsTotalElement.textContent = `₪${Math.round(totalDebt).toLocaleString()}`;
			if (debtsAverageElement) debtsAverageElement.textContent = `₪${Math.round(averageDebt).toLocaleString()}`;
		}

		function updateTreatmentsStats(filteredTreatments) {
			const count = filteredTreatments.length;
			const total = filteredTreatments.reduce((sum, treatment) => {
				const amount = parseFloat(treatment.amount) || 0;
				return sum + amount;
			}, 0);
			const paidCount = filteredTreatments.filter(t => getVisitPaymentStatus(t.ID) === 'paid').length;
			const unpaidCount = filteredTreatments.filter(t => getVisitPaymentStatus(t.ID) === 'unpaid').length;
			
			// חישוב חובות פתוחים
			const openDebts = filteredTreatments
				.filter(t => getVisitPaymentStatus(t.ID) === 'unpaid')
				.reduce((sum, treatment) => {
					const amount = parseFloat(treatment.amount) || 0;
					const paidAmount = getVisitPaidAmount(treatment.ID);
					return sum + (amount - paidAmount);
				}, 0);
			
			document.getElementById('treatmentsCount').textContent = count;
			document.getElementById('treatmentsTotal').textContent = `${Math.round(total)} ₪`;
			document.getElementById('treatmentsPaid').textContent = paidCount;
			document.getElementById('treatmentsUnpaid').textContent = unpaidCount;
			
			// הוסף חוב לסטטיסטיקות
			const debtsElement = document.getElementById('treatmentsDebts');
			if (debtsElement) {
				debtsElement.textContent = `${Math.round(openDebts)} ₪`;
			}
		}


		// פונקציה לסינון מהיר לפי תאריכים
		function setQuickDateFilter(period) {
			const today = new Date();
			const dateFromInput = document.getElementById('filterDateFrom');
			const dateToInput = document.getElementById('filterDateTo');
			
			// הסרת active מכל הכפתורים
			document.querySelectorAll('.filter-quick-btn').forEach(btn => btn.classList.remove('active'));
			
			let fromDate;
			
			switch(period) {
				case 'today':
					fromDate = new Date(today);
					break;
				case 'week':
					fromDate = new Date(today);
					fromDate.setDate(today.getDate() - 7);
					break;
				case 'month':
					fromDate = new Date(today);
					fromDate.setMonth(today.getMonth() - 1);
					break;
			}
			
			dateFromInput.value = fromDate.toISOString().split('T')[0];
			dateToInput.value = today.toISOString().split('T')[0];
			
			// סימון הכפתור כפעיל
			event.target.classList.add('active');
			
			// הפעלת הסינון
			applyVisitFilters();
		}


		function clearVisitFilters() {
			const locationFilter = document.getElementById('filterLocation');
			const paymentFilter = document.getElementById('filterPayment');
			const dateFrom = document.getElementById('filterDateFrom');
			const dateTo = document.getElementById('filterDateTo');
			const maxResults = document.getElementById('maxResults');
			const activeFilter = document.getElementById('filterActiveClients');
			const smartSearch = document.getElementById('visitSmartSearch');
			
			if (locationFilter) locationFilter.value = '';
			if (paymentFilter) paymentFilter.value = '';
			if (dateFrom) dateFrom.value = '';
			if (dateTo) dateTo.value = '';
			if (maxResults) maxResults.value = '200';
			if (activeFilter) activeFilter.value = '1';
			if (smartSearch) smartSearch.value = '';
			
			// Clear quick filter buttons
			document.querySelectorAll('.filter-quick-btn').forEach(btn => 
				btn.classList.remove('active')
			);
			
			displayFilteredVisits(visits);
			updateTreatmentsStats(visits);
		}

		function showAddTreatmentForm() {
		
			const modalContent = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 800px; width: 90vw; max-height: 85vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">🔧 הוספת טיפול חדש</h3>
					
					<form id="modalVisitForm" onsubmit="handleModalVisitSubmit(event)">
						<div class="form-group">
							<label for="modalVisitDate">תאריך:</label>
							<input type="date" id="modalVisitDate" required>
						</div>
						
						<div class="form-group">
							<label for="modalClientSearchInput">לקוח:</label>
							<input type="text" id="modalClientSearchInput" placeholder="חפש לקוח..." onkeyup="filterClientOptions('modalClientSearchInput', 'modalClientOptions')" required>
							<div id="modalClientOptions" class="client-options" style="display: none;"></div>
							<input type="hidden" id="modalSelectedClientId">
						</div>
						
						<div class="form-group">
							<label for="modalVisitType">סוג טיפול:</label>
							<select id="modalVisitType" required>
								<option value="">בחר סוג טיפול</option>
								<option value="מלא">מלא</option>
								<option value="חלקי">חלקי</option>
								<option value="ביקורת">ביקורת</option>
							</select>
						</div>
						
						<div class="form-group">
							<label for="modalWorkDone">עבודה שבוצעה:</label>
							<textarea id="modalWorkDone" rows="3" placeholder="תיאור העבודה שבוצעה"></textarea>
						</div>
						
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
							<div class="form-group">
								<label for="modalStartTime">שעת התחלה:</label>
								<div style="display: flex; gap: 5px; align-items: center;">
									<input type="time" id="modalStartTime" style="flex: 1;" onchange="calculateModalDuration()">
									<button type="button" onclick="setCurrentTime('modalStartTime')" 
											style="padding: 8px 12px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">עכשיו</button>
								</div>
							</div>
							
							<div class="form-group">
								<label for="modalEndTime">שעת סיום:</label>
								<div style="display: flex; gap: 5px; align-items: center;">
									<input type="time" id="modalEndTime" style="flex: 1;" onchange="calculateModalDuration()">
									<button type="button" onclick="setCurrentTime('modalEndTime')" 
											style="padding: 8px 12px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">עכשיו</button>
								</div>
							</div>
						</div>
						
						<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
							<div class="form-group">
								<label for="modalDurationHours">שעות:</label>
								<input type="number" id="modalDurationHours" min="0" max="24" value="0" onchange="updateModalManualDuration()">
							</div>
							
							<div class="form-group">
								<label for="modalDurationMinutes">דקות:</label>
								<input type="number" id="modalDurationMinutes" min="0" max="59" value="0" onchange="updateModalManualDuration()">
							</div>
							
							<div class="form-group">
								<label for="modalManualDurationMinutes">סה"כ דקות:</label>
								<input type="number" id="modalManualDurationMinutes" min="0" value="0" placeholder="0" onchange="updateModalFromTotalMinutes()">
							</div>
						</div>
						
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
							<div class="form-group">
								<label for="modalCalculatedHours">שעות עשרוניות:</label>
								<input type="number" id="modalCalculatedHours" step="0.1" readonly style="background: #f8f9fa;">
							</div>
							
							<div class="form-group">
								<label for="modalNumWorkers">מספר עובדים:</label>
								<input type="number" id="modalNumWorkers" min="1" value="1" onchange="calculateModalTreatmentCost()">
							</div>
						</div>
						
						<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
							<div class="form-group">
								<label for="modalAmount">סכום לגביה:</label>
								<input type="number" id="modalAmount" step="0.01" min="0" placeholder="0">
							</div>
							
							<div class="form-group">
								<label for="modalExpense">הוצאה:</label>
								<input type="number" id="modalExpense" step="0.01" min="0" value="0" placeholder="0" onchange="calculateModalTreatmentCost()">
							</div>
							
							<div class="form-group">
								<label for="modalPaymentStatus">סטטוס תשלום:</label>
								<select id="modalPaymentStatus">
									<option value="לא שולם">לא שולם</option>
									<option value="שולם">שולם</option>
									<option value="שולם חלקית">שולם חלקית</option>
								</select>
							</div>
						</div>
						
						<div class="form-group">
							<label for="modalNotes">הערות:</label>
							<textarea id="modalNotes" rows="2" placeholder="הערות נוספות"></textarea>
						</div>
						
						<div class="form-group">
							<label for="modalVisitTime">שעת ביקור (רק לתצוגה):</label>
							<input type="time" id="modalVisitTime" style="background: #f8f9fa;" readonly>
						</div>
						
						<div class="form-group" style="text-align: center; margin-top: 25px;">
							<button type="submit" style="background: #27ae60; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-left: 10px;">💾 שמור טיפול</button>
							<button type="button" onclick="closeModal()" style="background: #95a5a6; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">❌ ביטול</button>
						</div>
					</form>
				</div>
			`;
			
			showModal(modalContent);
			
			// הגדרת תאריך היום
			document.getElementById('modalVisitDate').value = new Date().toISOString().split('T')[0];
			
			// טעינת רשימת לקוחות
			loadModalClientOptions();
		}
		
		
		// פונקציה לעדכון הערות חוב
		async function updateDebtNotes(locationId, notes) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// עדכון מקומי
			location.debt_notes = notes;
			saveToLocalStorage();
			
			// עדכון בענן (אם מחובר)
			if (access_token && SPREADSHEET_ID) {
				try {
					await updateLocationInCloud(location);
					console.log('הערות חוב עודכנו בענן');
				} catch (error) {
					console.log('הערות עודכנו מקומית בלבד');
				}
			}
		}

		// פונקציה לעדכון סטטוס פעילות לקוח
		async function updateLocationActive(locationId, activeStatus) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// עדכון מקומי
			location.active = activeStatus;
			saveToLocalStorage();
			
			// עדכון בענן (אם מחובר)
			if (access_token && SPREADSHEET_ID) {
				try {
					await updateLocationInCloud(location);
					console.log('סטטוס פעילות עודכן בענן');
				} catch (error) {
					console.log('סטטוס עודכן מקומית בלבד');
				}
			}
			
			// רענון טבלאות רלוונטיות
			loadLocationsForSelect(); // עדכון רשימות נפתחות
			updateLocationsStats(getFilteredLocations()); // עדכון סטטיסטיקות
		}

		// מעבר לטאב טיפולים מסונן לפי לקוח
		function showClientTreatments(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// Jump to treatments tab
			showSection('history');
			
			// Wait for tab to load, then apply client filter
			setTimeout(() => {
				// Clear existing filters
				if (typeof clearVisitFilters === 'function') {
					clearVisitFilters();
				}
				
				// Set smart search to client name
				const smartSearchInput = document.getElementById('visitSmartSearch');
				if (smartSearchInput) {
					smartSearchInput.value = client.name;
					// Trigger the search
					if (typeof handleVisitSmartSearch === 'function') {
						handleVisitSmartSearch(client.name);
					}
				}
				
				showToast(`מציג טיפולים עבור ${client.name}`, 'success', 2000);
			}, 200);
		}

		function showClientReceipts(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// Jump to receipts tab
			showSection('receipts');
			
			// Wait for tab to load, then apply client filter
			setTimeout(() => {
				// Clear existing filters
				if (typeof clearReceiptFilters === 'function') {
					clearReceiptFilters();
				}
				
				// Set client filter if dropdown exists
				const clientFilter = document.getElementById('filterReceiptClient');
				if (clientFilter) {
					clientFilter.value = clientId;
					// Apply filters
					if (typeof applyReceiptFilters === 'function') {
						applyReceiptFilters();
					}
				}
				
				showToast(`מציג קבלות עבור ${client.name}`, 'info', 2000);
			}, 200);
		}


		// טעינת לקוחות לבחירה במודל
		function loadClientsForModal() {
			const clientSearchInput = document.getElementById('modalClientSearchInput');
			const clientOptions = document.getElementById('modalClientOptions');
			
			if (!clientSearchInput || !clientOptions) return;
			
			// הגדרת מאזין לקלט
			clientSearchInput.addEventListener('input', function() {
				filterClientOptions('modalClientSearchInput', 'modalClientOptions');
			});
		}

		// סינון אפשרויות לקוחות במודל (מנצל את הפונקציה הקיימת)
		// הפונקציה filterClientOptions כבר קיימת ותעבוד עם ה-IDs החדשים

		// טיפול בשליחת הטופס מהמודל
		async function handleModalVisitSubmit(event) {
			event.preventDefault();
			
			// איסוף נתונים מהטופס
			const visitDate = document.getElementById('modalVisitDate').value;
			const selectedClientId = document.getElementById('modalSelectedClientId').value;
			const visitType = document.getElementById('modalVisitType').value;
			const workDone = document.getElementById('modalWorkDone').value;
			const startTime = document.getElementById('modalStartTime').value;
			const endTime = document.getElementById('modalEndTime').value;
			const durationMinutes = parseInt(document.getElementById('modalManualDurationMinutes').value) || 0;
			const numWorkers = parseInt(document.getElementById('modalNumWorkers').value) || 1;
			const amount = parseFloat(document.getElementById('modalAmount').value) || 0;
			const expense = parseFloat(document.getElementById('modalExpense').value) || 0;
			const notes = document.getElementById('modalNotes').value;
			
			// בדיקות בסיסיות
			if (!selectedClientId) {
				showToast('❌ אנא בחר לקוח', 'error');
				return;
			}
			
			if (!visitDate) {
				showToast('❌ נדרש תאריך טיפול', 'error');
				return;
			}
			
			if (!visitType) {
				showToast('❌ נדרש סוג טיפול', 'error');
				return;
			}
			
			// Get client info
			const client = locations.find(loc => loc.ID === selectedClientId);
			const clientName = client ? client.name : 'לקוח לא ידוע';
			
			// Create new visit
			const newVisit = {
				ID: generateID(),
				date: visitDate,
				location_id: selectedClientId,
				location_name: clientName,
				visit_type: visitType,
				work_done: workDone,
				duration_minutes: durationMinutes,
				num_workers: numWorkers,
				start_time: startTime || '',
				end_time: endTime || '',
				amount: amount,
				paid: 'unpaid',  // ✅ NEW: Default to unpaid
				expense: expense,
				notes: notes
			};
			
			// Add to visits array
			visits.push(newVisit);
			
			// Save locally
			saveToLocalStorage();
			
			// Save to cloud if connected
			let cloudSaved = false;
			if (access_token && SPREADSHEET_ID) {
				try {
					cloudSaved = await saveVisitsBatch([newVisit]);
				} catch (error) {
					console.error('Cloud save failed:', error);
				}
			}
			
			// Update treatment dates
			await updateSingleLocationTreatmentDates(newVisit.location_id);
			
			// Close modal
			closeEditModal();
			
			// Refresh displays
			loadPlanningData();
			filterVisits();
			
			// Success message
			if (access_token && SPREADSHEET_ID) {
				if (cloudSaved) {
					showToast('✅ הטיפול נשמר בהצלחה במערכת ובענן!', 'success');
				} else {
					showToast('⚠️ הטיפול נשמר מקומית בלבד - בעיה בחיבור לענן', 'warning');
				}
			} else {
				showToast('💾 הטיפול נשמר מקומית - התחבר לענן לשמירה מלאה', 'info');
			}
		}

		function filterClientOptions(inputId, optionsId) {
			const searchInput = document.getElementById(inputId);
			const optionsDiv = document.getElementById(optionsId);
			const searchTerm = searchInput.value.toLowerCase();
			
			if (searchTerm.length < 1) {
				optionsDiv.style.display = 'none';
				return;
			}
			
			const activeLocations = locations.filter(loc => 
				(loc.active === "1" || loc.active === true || loc.active === "כן") &&
				loc.name.toLowerCase().includes(searchTerm)
			);
			
			if (activeLocations.length === 0) {
				optionsDiv.innerHTML = '<div style="padding: 10px; color: #666;">אין לקוחות תואמים</div>';
				optionsDiv.style.display = 'block';
				return;
			}
			
			let optionsHTML = '';
			activeLocations.slice(0, 10).forEach(location => {
				optionsHTML += `
					<div class="client-option" onclick="selectModalClient('${location.ID}', '${location.name.replace(/'/g, "\\'")}')">
						<strong>${location.name}</strong>
						<div style="font-size: 12px; color: #666;">${location.full_address || 'ללא כתובת'}</div>
					</div>
				`;
			});
			
			optionsDiv.innerHTML = optionsHTML;
			optionsDiv.style.display = 'block';
		}


		///>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

		// הוסף פונקציה חדשה:
		async function handlePaymentStatusChange(visitId, newStatus, oldStatus) {
			const visit = visits.find(v => v.ID === visitId);
			if (!visit) return;
			
			console.log(`Payment status change: ${oldStatus} → ${newStatus} for visit ${visitId}`);
			
			// אם משנים ל"שולם" ולא היה שולם לפני
			if (newStatus === '1' && oldStatus !== '1') {
				// יצור תשלום חדש
				const payment = {
					ID: generateID(),
					date: new Date().toISOString().split('T')[0],
					time: new Date().toTimeString().substr(0, 5),
					amount: visit.amount || 0,
					payment_method: 'cash',
					source_type: 'status_change_payment',
					client_id: visit.location_id,
					client_name: location ? location.name : 'לקוח לא ידוע',
					notes: `תשלום עבור טיפול מ-${formatDate(visit.date)}`,
					status: 'completed',
					created_at: new Date().toISOString()
				};
				
				payments.push(payment);
				
				const link = {
					ID: generateID(),
					payment_id: payment.ID,
					visit_id: visitId,
					amount_allocated: visit.amount || 0,
					link_type: 'full_payment',
					created_at: new Date().toISOString()
				};
				
				paymentVisitLinks.push(link);
				
				// שמירה בענן
				if (access_token) {
					await saveAllToSheetsOptimized();
				}
				
				showToast('נוצר תשלום עבור הטיפול', 'success');
			}
			
			// אם משנים מ"שולם" למשהו אחר
			if (oldStatus === '1' && newStatus !== '1') {
				// מצא ומחק קישורי תשלום לטיפול הזה
				const linksToRemove = paymentVisitLinks.filter(link => link.visit_id === visitId);
				
				linksToRemove.forEach(link => {
					// הסר את הקישור
					const linkIndex = paymentVisitLinks.findIndex(l => l.ID === link.ID);
					if (linkIndex > -1) {
						paymentVisitLinks.splice(linkIndex, 1);
					}
					
					// בדוק אם התשלום קשור לטיפולים נוספים
					const otherLinks = paymentVisitLinks.filter(l => l.payment_id === link.payment_id);
					
					// אם אין קישורים נוספים לתשלום, הסר גם את התשלום
					if (otherLinks.length === 0) {
						const paymentIndex = payments.findIndex(p => p.ID === link.payment_id);
						if (paymentIndex > -1) {
							payments.splice(paymentIndex, 1);
						}
					}
				});
				
				showToast('הוסרו תשלומים קשורים לטיפול', 'info');
			}
			
			// שמור שינויים
			saveToLocalStorage();
		}

	///   פונקציות תשלומים   //////////
	
		// טעינת אפשרויות סינון תשלומים
		function loadPaymentFilterOptions() {
			const clientSelect = document.getElementById('filterPaymentClient');
			
			if (clientSelect) {
				clientSelect.innerHTML = '<option value="">כל הלקוחות</option>';
				
				// Create unique client list from payments
				const uniqueClients = [...new Set(payments.map(p => p.client_name).filter(name => name))];
				uniqueClients.sort().forEach(clientName => {
					clientSelect.innerHTML += `<option value="${clientName}">${clientName}</option>`;
				});
			}
		}

		// סינון תשלומים
		function applyPaymentFilters() {
			// Check if smart search is active
			const smartSearch = document.getElementById('paymentSmartSearch')?.value;
			if (smartSearch && smartSearch.trim()) {
				handlePaymentSmartSearch(smartSearch);
				return;
			}
			
			// Get filter values with null safety
			const clientFilter = document.getElementById('filterPaymentClient')?.value || '';
			const dateFromFilter = document.getElementById('filterPaymentDateFrom')?.value || '';
			const dateToFilter = document.getElementById('filterPaymentDateTo')?.value || '';
			
			let filteredPayments = [...payments];
			
			// Filter by client
			if (clientFilter) {
				filteredPayments = filteredPayments.filter(p => p.client_name === clientFilter);
			}
			
			// Filter by date range
			if (dateFromFilter) {
				filteredPayments = filteredPayments.filter(p => p.date >= dateFromFilter);
			}
			if (dateToFilter) {
				filteredPayments = filteredPayments.filter(p => p.date <= dateToFilter);
			}
			
			displayPayments(filteredPayments);
			updatePaymentsStats(filteredPayments);
		}

		// הצגת תשלומים בטבלה
		function displayPayments(paymentsToShow = payments) {
			const tbody = document.querySelector('#paymentsTable tbody');
			if (!tbody) return;
			
			tbody.innerHTML = '';
			
			paymentsToShow.forEach(payment => {
				const row = tbody.insertRow();
				
				// פירוט אמצעי תשלום משופר
				let paymentMethodText = '';
				switch(payment.payment_method) {
					case 'cash': paymentMethodText = 'מזומן'; break;
					case 'check': paymentMethodText = 'צ\'ק'; break;
					case 'transfer': paymentMethodText = 'העברה'; break;
					case 'app': paymentMethodText = 'אפליקציה'; break;
					default: paymentMethodText = payment.payment_method || 'לא צוין';
				}
				
				// הצגת אסמכתא אם קיימת
				if (payment.reference) {
					paymentMethodText += ` (${payment.reference})`;
				}
				
				row.innerHTML = `
					<td>${formatDate(payment.date)}</td>
					<td>${payment.client_name || 'לא ידוע'}</td>
					<td>₪${payment.amount.toLocaleString()}</td>
					<td>${paymentMethodText}</td>
					<td title="${payment.notes || ''}">${(payment.notes || '').substring(0, 50)}${payment.notes && payment.notes.length > 50 ? '...' : ''}</td>
					<td>
						<button onclick="showPaymentDetails('${payment.ID}')" class="btn-info" title="פירוט מלא">🔍 פירוט</button>
					</td>
				`;
			});
		}

		// עדכון סטטיסטיקות תשלומים
		function updatePaymentsStats(filteredPayments) {
			const count = filteredPayments.length;
			const total = filteredPayments.reduce((sum, payment) => sum + (parseFloat(payment.amount) || 0), 0);
			const average = count > 0 ? Math.round(total / count) : 0;
			
			document.getElementById('paymentsCount').textContent = count;
			document.getElementById('paymentsTotal').textContent = `₪${Math.round(total).toLocaleString()}`;
			document.getElementById('paymentsAverage').textContent = `₪${average.toLocaleString()}`;
		}

		// ניקוי סינונים
		function clearPaymentFilters() {
			document.getElementById('filterPaymentClient').value = '';
			document.getElementById('filterPaymentDateFrom').value = '';
			document.getElementById('filterPaymentDateTo').value = '';
			
			// ניקוי החיפוש החכם
			if (document.getElementById('paymentSmartSearch')) {
				document.getElementById('paymentSmartSearch').value = '';
			}
			
			applyPaymentFilters();
		}


		// הצגת פירוט תשלום
		function showPaymentDetails(paymentId) {
			const payment = payments.find(p => p.ID === paymentId);
			if (!payment) {
				showToast('תשלום לא נמצא', 'error');
				return;
			}
			
			// מצא טיפולים קשורים לתשלום
			const relatedLinks = paymentVisitLinks.filter(link => link.payment_id === paymentId);
			const relatedVisits = relatedLinks.map(link => {
				const visit = visits.find(visit => visit.ID === link.visit_id);
				if (visit) {
					return {
						...visit,
						allocated_amount: link.amount_allocated || 0
					};
				}
				return null;
			}).filter(visit => visit);
			
			// חישוב סכום מקושר
			const totalAllocated = relatedLinks.reduce((sum, link) => sum + (link.amount_allocated || 0), 0);
			const unallocated = payment.amount - totalAllocated;
			
			// טקסט אמצעי תשלום
			let methodText = '';
			switch(payment.payment_method) {
				case 'cash': methodText = 'מזומן'; break;
				case 'check': methodText = 'צ\'ק'; break;
				case 'transfer': methodText = 'העברה בנקאית'; break;
				case 'app': methodText = 'אפליקציה (ביט/פייבוקס)'; break;
				default: methodText = payment.payment_method || 'לא צויין';
			}
			
			const modalContent = `
				<div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto; direction: rtl;">
					<h3 style="margin-bottom: 25px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
						💳 פרטי תשלום
					</h3>
					
					<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px; color: white;">
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
							<span style="font-size: 14px; opacity: 0.9;">סכום התשלום:</span>
							<span style="font-size: 28px; font-weight: bold;">₪${Math.round(payment.amount).toLocaleString()}</span>
						</div>
						<div style="font-size: 13px; opacity: 0.8;">
							📅 ${formatDate(payment.date)}
						</div>
					</div>
					
					<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
						<div style="margin-bottom: 15px;">
							<strong style="color: #666; font-size: 12px; display: block; margin-bottom: 5px;">👤 לקוח:</strong>
							<div style="font-size: 16px; color: #2c3e50;">${payment.client_name || 'לא ידוע'}</div>
						</div>
						
						<div style="margin-bottom: 15px;">
							<strong style="color: #666; font-size: 12px; display: block; margin-bottom: 5px;">💳 אמצעי תשלום:</strong>
							<div style="font-size: 16px; color: #2c3e50;">${methodText}</div>
						</div>
						
						${payment.reference ? `
							<div style="margin-bottom: 15px;">
								<strong style="color: #666; font-size: 12px; display: block; margin-bottom: 5px;">🔢 אסמכתא:</strong>
								<div style="font-size: 16px; color: #2c3e50;">${payment.reference}</div>
							</div>
						` : ''}
						
						${payment.check_date ? `
							<div style="margin-bottom: 15px;">
								<strong style="color: #666; font-size: 12px; display: block; margin-bottom: 5px;">📆 תאריך פירעון צ'ק:</strong>
								<div style="font-size: 16px; color: #2c3e50;">${formatDate(payment.check_date)}</div>
							</div>
						` : ''}
						
						${payment.notes ? `
							<div>
								<strong style="color: #666; font-size: 12px; display: block; margin-bottom: 5px;">📝 הערות:</strong>
								<div style="font-size: 14px; color: #555; line-height: 1.6;">${payment.notes}</div>
							</div>
						` : ''}
					</div>
					
					<div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #27ae60;">
						<h4 style="margin: 0 0 15px 0; color: #27ae60; font-size: 16px;">🔗 טיפולים מקושרים:</h4>
						
						${relatedVisits.length > 0 ? 
							relatedVisits.map(visit => `
								<div style="padding: 12px; background: white; border-radius: 6px; margin-bottom: 10px; border-right: 4px solid #27ae60;">
									<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
										<strong style="color: #2c3e50;">${formatDate(visit.date)}</strong>
										<span style="background: #27ae60; color: white; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: bold;">
											₪${visit.allocated_amount.toFixed(2)}
										</span>
									</div>
									<div style="font-size: 13px; color: #666;">
										${visit.work_done || 'ללא תיאור'}
									</div>
								</div>
							`).join('') 
							: '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">אין טיפולים מקושרים לתשלום זה</div>'
						}
						
						${relatedVisits.length > 0 ? `
							<div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #27ae60; display: flex; justify-content: space-between; font-size: 14px;">
								<span><strong>סכום מקושר:</strong></span>
								<span style="color: #27ae60; font-weight: bold;">₪${totalAllocated.toFixed(2)}</span>
							</div>
							${unallocated > 0.01 ? `
								<div style="display: flex; justify-content: space-between; font-size: 14px; margin-top: 5px;">
									<span><strong>סכום לא מקושר:</strong></span>
									<span style="color: #f39c12; font-weight: bold;">₪${unallocated.toFixed(2)}</span>
								</div>
							` : ''}
						` : ''}
					</div>
					
					<div style="text-align: center;">
						<button onclick="closeModal()" style="background: #95a5a6; color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-size: 15px;">
							סגור
						</button>
					</div>
				</div>
			`;
			
			showModal(modalContent);
		}

		// טעינת טאב תשלומים
		function loadPayments() {
			loadPaymentFilterOptions();
			applyPaymentFilters();
		}

		// פונקציה לחישוב תשלום אחרון של לקוח
		function getLastPaymentDate(locationId) {
			const clientPayments = payments.filter(p => p.client_id === locationId);
			
			if (clientPayments.length === 0) {
				return null;
			}
			
			// מיון לפי תאריך - האחרון ראשון
			clientPayments.sort((a, b) => new Date(b.date) - new Date(a.date));
			
			return clientPayments[0].date;
		}

		// פונקציה לפורמט תצוגת תשלום אחרון
		function formatLastPayment(locationId) {
			const lastPaymentDate = getLastPaymentDate(locationId);
			
			if (!lastPaymentDate) {
				return '<span style="color: #999; font-size: 12px;">אין תשלומים</span>';
			}
			
			const daysSince = Math.floor((new Date() - new Date(lastPaymentDate)) / (1000 * 60 * 60 * 24));
			const color = daysSince > 90 ? '#e74c3c' : daysSince > 30 ? '#f39c12' : '#27ae60';
			
			return `
				<div style="text-align: center;">
					<div style="font-size: 12px;">${formatDate(lastPaymentDate)}</div>
					<div style="color: ${color}; font-size: 11px; font-weight: bold;">
						${daysSince === 0 ? 'היום' : daysSince === 1 ? 'אתמול' : `לפני ${daysSince} ימים`}
					</div>
				</div>
			`;
		}


		
		// פונקציה לקבלת שם לקוח לפי ID
		function getClientNameById(clientId) {
			const location = locations.find(loc => loc.ID === clientId);
			return location ? location.name : null;
		}


		// שמירת הכנסות בקבוצה
		async function saveIncomesBatch(incomesArray) {
			if (!incomesArray.length || !access_token || !SPREADSHEET_ID) {
				return false;
			}
			
			try {
				const values = incomesArray.map(income => [
					income.ID,
					income.date,
					income.time || '',
					income.client_address,
					income.client_id || '',
					income.amount,
					income.payment_method,
					income.notes || '',
					income.raw_text || '',
					income.imported_from || 'manual',
					income.import_date || new Date().toISOString().split('T')[0],
					income.matched_to_visit || false
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Incomes!A:L',
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`✅ נשמרו ${incomesArray.length} הכנסות בענן`);
				return true;
				
			} catch (error) {
				console.error('שגיאה בשמירת הכנסות בקבוצה:', error);
				return false;
			}
		}		


		// חיפוש חכם לקוחות - החלפת הפונקציה הקיימת
		function searchClientsAdvanced(searchTerm) {
			if (!searchTerm || searchTerm.trim() === '') {
				return locations.filter(location => location.active === "1").slice(0, 10);
			}
			
			const term = searchTerm.toLowerCase().trim();
			
			return locations
				.filter(location => location.active === "1")
				.filter(location => {
					const name = (location.name || '').toLowerCase();
					const address = (location.full_address || '').toLowerCase();
					const city = (location.city || '').toLowerCase();
					const neighborhood = (location.neighborhood || '').toLowerCase();
					const contact = (location.contact_person || '').toLowerCase();
					
					// חיפוש חלקי בכל השדות הרלוונטיים
					return name.includes(term) || 
						   address.includes(term) || 
						   city.includes(term) ||
						   neighborhood.includes(term) ||
						   contact.includes(term);
				})
				.slice(0, 15); // הגדלת מספר התוצאות ל-15
		}



		// עדכון טיפולים נבחרים וחישוב סכום
		function updateSelectedVisits() {
			const checkboxes = document.querySelectorAll('.visit-checkbox:checked');
			selectedVisitIds = Array.from(checkboxes).map(cb => cb.value);
			
			let totalAmount = 0;
			selectedVisitIds.forEach(visitId => {
				const visit = visits.find(v => v.ID === visitId);
				if (visit) {
					totalAmount += parseFloat(visit.amount) || 0;
				}
			});
			
			document.getElementById('selectedAmount').textContent = totalAmount.toLocaleString();
			document.getElementById('selectedCount').textContent = selectedVisitIds.length;
			
			// הצגת פרטי התשלום אם יש טיפולים נבחרים
			if (selectedVisitIds.length > 0) {
				document.getElementById('paymentDetailsSection').style.display = 'block';
				document.getElementById('savePaymentBtn').disabled = false;
				
				// עדכון הערות אוטומטי
				const selectedDates = selectedVisitIds.map(visitId => {
					const visit = visits.find(v => v.ID === visitId);
					return visit ? formatDate(visit.date) : '';
				}).filter(date => date);
				
				document.getElementById('paymentNotes').value = 
					`תשלום עבור ${selectedVisitIds.length} טיפולים: ${selectedDates.join(', ')}`;
			} else {
				document.getElementById('paymentDetailsSection').style.display = 'none';
				document.getElementById('savePaymentBtn').disabled = true;
			}
		}



		// עדכון סטטוס תשלום של טיפול
		async function updatePaymentStatus(visitId, newStatus) {
			const visit = visits.find(v => v.ID === visitId);
			if (!visit) {
				showToast('טיפול לא נמצא', 'error');
				return;
			}
			
			// ✅ UPDATED: Handle different payment statuses with date selection
			if (newStatus === 'paid') {
				// Ask user for payment date with today as default
				const today = new Date();
				const defaultDate = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
				
				const dateInput = prompt('תאריך תשלום (DD/MM/YYYY):\n\nלחץ OK להיום, או הזן תאריך אחר:', defaultDate);
				
				if (dateInput === null) return; // User cancelled
				
				let paymentDate;
				
				if (!dateInput || dateInput.trim() === '') {
					// Empty input - use today
					paymentDate = today.toISOString().split('T')[0];
				} else {
					// Parse user input
					const parts = dateInput.trim().split('/');
					if (parts.length !== 3) {
						showToast('פורמט תאריך לא תקין. השתמש ב: DD/MM/YYYY', 'error');
						return;
					}
					
					const day = parts[0].padStart(2, '0');
					const month = parts[1].padStart(2, '0');
					const year = parts[2];
					
					// Validate date
					const dateObj = new Date(`${year}-${month}-${day}`);
					if (isNaN(dateObj.getTime())) {
						showToast('תאריך לא תקין', 'error');
						return;
					}
					
					paymentDate = `${year}-${month}-${day}`;
				}
				
				visit.paid = `paid:${paymentDate}`;
				
			} else if (newStatus === 'partial') {
				// Ask user for partial amount
				const visitAmount = parseFloat(visit.amount) || 0;
				const partialAmount = prompt(`כמה שולם? (מתוך ${visitAmount}₪)`, '');
				
				if (partialAmount === null) return; // User cancelled
				
				const amount = parseFloat(partialAmount);
				if (isNaN(amount) || amount <= 0) {
					showToast('סכום לא תקין', 'error');
					return;
				}
				
				if (amount >= visitAmount) {
					// If paid full or more, ask for date and mark as fully paid
					const today = new Date();
					const defaultDate = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
					
					const dateInput = prompt('תאריך תשלום (DD/MM/YYYY):', defaultDate);
					
					if (dateInput === null) return;
					
					let paymentDate;
					if (!dateInput || dateInput.trim() === '') {
						paymentDate = today.toISOString().split('T')[0];
					} else {
						const parts = dateInput.trim().split('/');
						if (parts.length === 3) {
							const day = parts[0].padStart(2, '0');
							const month = parts[1].padStart(2, '0');
							const year = parts[2];
							paymentDate = `${year}-${month}-${day}`;
						} else {
							paymentDate = today.toISOString().split('T')[0];
						}
					}
					
					visit.paid = `paid:${paymentDate}`;
				} else {
					visit.paid = `partial:${amount}`;
				}
				
			} else if (newStatus === 'no_payment') {
				visit.paid = 'no_payment';
				
			} else if (newStatus === 'unpaid') {
				visit.paid = 'unpaid';
			}
			
			// Save locally
			saveToLocalStorage();
			
			// Save to cloud if connected
			if (access_token && SPREADSHEET_ID) {
				const success = await saveAllToSheetsOptimized();
				if (success) {
					showToast('✅ סטטוס תשלום עודכן', 'success', 2000);
				} else {
					showToast('⚠️ עודכן מקומית בלבד', 'warning', 2000);
				}
			} else {
				showToast('💾 עודכן מקומית', 'info', 2000);
			}
			
			// Refresh displays
			filterVisits();
			if (typeof displayDebts === 'function') {
				displayDebts();
			}
		}

		// מחיקת תשלומים הקשורים לטיפול
		function removePaymentsForVisit(visitId) {
			const linksToRemove = paymentVisitLinks.filter(link => link.visit_id === visitId);
			
			linksToRemove.forEach(link => {
				// הסר את הקישור
				const linkIndex = paymentVisitLinks.findIndex(l => l.ID === link.ID);
				if (linkIndex > -1) {
					paymentVisitLinks.splice(linkIndex, 1);
				}
				
				// בדוק אם התשלום קשור לטיפולים נוספים
				const otherLinks = paymentVisitLinks.filter(l => l.payment_id === link.payment_id);
				
				// אם אין קישורים נוספים, מחק את התשלום
				if (otherLinks.length === 0) {
					const paymentIndex = payments.findIndex(p => p.ID === link.payment_id);
					if (paymentIndex > -1) {
						payments.splice(paymentIndex, 1);
					}
				}
			});
		}


		// פונקציית עזר לתרגום אמצעי תשלום
		function getPaymentMethodText(method) {
			const methods = {
				'cash': 'מזומן',
				'check': 'צ\'ק',
				'transfer': 'העברה בנקאית',
				'app': 'אפליקציה'
			};
			return methods[method] || method;
		}

		// פונקציית עזר להצגת מודאל כללי
		function showModal(content) {
			// הסר מודל קיים אם יש
			const existingModal = document.getElementById('telegramModal');
			if (existingModal) {
				existingModal.remove();
			}
			
			// צור מודל
			const modal = document.createElement('div');
			modal.id = 'telegramModal';
			modal.style.cssText = `
				position: fixed !important;
				top: 0 !important;
				left: 0 !important;
				width: 100% !important;
				height: 100% !important;
				background: rgba(0,0,0,0.7) !important;
				display: flex !important;
				justify-content: center !important;
				align-items: center !important;
				z-index: 9999 !important;
			`;
			
			modal.innerHTML = content;
			document.body.appendChild(modal);
			
			// סגירה בלחיצה על הרקע
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					closeModal();
				}
			});
		}

		// חיפוש חכם בטיפולים
		function handleVisitSmartSearch(searchTerm) {
			if (!searchTerm.trim()) {
				// אם אין מונח חיפוש, הצג הכל
				applyVisitFilters();
				return;
			}
			
			// מציאת לקוחות מתאימים
			const matchingClients = searchClientsAdvanced(searchTerm);
			const clientIds = matchingClients.map(client => client.ID);
			
			if (clientIds.length === 0) {
				displayFilteredVisits([]);
				updateTreatmentsStats([]);
				return;
			}
			
			// סינון הטיפולים לפי הלקוחות שנמצאו
			let filteredVisits = visits.filter(visit => clientIds.includes(visit.location_id));
			
			// החלת הסינונים הרגילים (תאריכים, תשלומים) על התוצאות
			filteredVisits = applyAdditionalFiltersToVisits(filteredVisits);
			
			displayFilteredVisits(filteredVisits);
			updateTreatmentsStats(filteredVisits);
		}

		// ניקוי חיפוש חכם
		function clearVisitSmartSearch() {
			const searchInput = document.getElementById('visitSmartSearch');
			if (searchInput) {
				searchInput.value = '';
			}
			applyVisitFilters();
		}

		// פונקציה לhחלת הסינונים הרגילים על קבוצה מסוימת של ביקורים
		function applyAdditionalFiltersToVisits(visitsArray) {
			let filtered = [...visitsArray];
			
			// סינון לפי תשלום
			const paymentFilter = document.getElementById('filterPayment')?.value;
			if (paymentFilter) {
				filtered = filtered.filter(visit => {
					const paymentStatus = getVisitPaymentStatus(visit.ID);
					switch(paymentFilter) {
						case 'כן': return paymentStatus === 'paid';
						case 'לא': return paymentStatus === 'unpaid';
						case 'ללא': return paymentStatus === 'no_payment';
						default: return true;
					}
				});
			}
			
			// סינון לפי תאריך
			const dateFrom = document.getElementById('filterDateFrom')?.value;
			const dateTo = document.getElementById('filterDateTo')?.value;
			
			if (dateFrom) {
				filtered = filtered.filter(visit => visit.date >= dateFrom);
			}
			if (dateTo) {
				filtered = filtered.filter(visit => visit.date <= dateTo);
			}
			
			return filtered;
		}

		// חיפוש חכם בקבלות
		// Check if handleReceiptSmartSearch function exists, if not, add it:
		function handleReceiptSmartSearch(searchTerm) {
			if (!searchTerm.trim()) {
				applyReceiptFilters();
				return;
			}
			
			// Find matching clients
			const matchingClients = searchClientsAdvanced(searchTerm);
			const clientNames = matchingClients.map(client => client.name);
			
			if (clientNames.length === 0) {
				displayFilteredReceipts([]);
				updateReceiptsStats([]);
				return;
			}
			
			// Filter receipts by found clients
			let filteredReceipts = receipts.filter(receipt => 
				clientNames.some(name => 
					receipt.location_name && receipt.location_name.toLowerCase().includes(name.toLowerCase())
				)
			);
			
			// Apply additional filters
			filteredReceipts = applyAdditionalReceiptFilters(filteredReceipts);
			
			displayFilteredReceipts(filteredReceipts);
			updateReceiptsStats(filteredReceipts);
		}

		// ניקוי חיפוש חכם בקבלות
		function clearReceiptSmartSearch() {
			const searchInput = document.getElementById('receiptSmartSearch');
			if (searchInput) {
				searchInput.value = '';
			}
			applyReceiptFilters();
		}

		// פונקציה להחלת סינונים נוספים על קבלות
		function applyAdditionalReceiptFilters(receiptsArray) {
			let filtered = [...receiptsArray];
			
			// סינון לפי פנקס
			const bookFilter = document.getElementById('filterReceiptBook')?.value;
			if (bookFilter) {
				filtered = filtered.filter(r => r.book_number === bookFilter);
			}
			
			// סינון לפי סוג תשלום
			const paymentFilter = document.getElementById('filterPaymentType')?.value;
			if (paymentFilter) {
				filtered = filtered.filter(r => r.payment_type === paymentFilter);
			}
			
			// סינון לפי תאריך
			const dateFrom = document.getElementById('filterReceiptDateFrom')?.value;
			const dateTo = document.getElementById('filterReceiptDateTo')?.value;
			
			if (dateFrom) {
				filtered = filtered.filter(r => r.date >= dateFrom);
			}
			if (dateTo) {
				filtered = filtered.filter(r => r.date <= dateTo);
			}
			
			return filtered;
		}

		// חיפוש חכם בתשלומים
		function handlePaymentSmartSearch(searchTerm) {
			if (!searchTerm.trim()) {
				applyPaymentFilters();
				return;
			}
			
			// מציאת לקוחות מתאימים
			const matchingClients = searchClientsAdvanced(searchTerm);
			const clientNames = matchingClients.map(client => client.name);
			
			if (clientNames.length === 0) {
				displayPayments([]);
				updatePaymentsStats([]);
				return;
			}
			
			// סינון התשלומים לפי הלקוחות שנמצאו
			let filteredPayments = payments.filter(payment => 
				clientNames.some(name => 
					payment.client_name && payment.client_name.includes(name)
				)
			);
			
			// החלת הסינונים הרגילים
			filteredPayments = applyAdditionalPaymentFilters(filteredPayments);
			
			displayPayments(filteredPayments);
			updatePaymentsStats(filteredPayments);
		}

		// ניקוי חיפוש חכם בתשלומים
		function clearPaymentSmartSearch() {
			const searchInput = document.getElementById('paymentSmartSearch');
			if (searchInput) {
				searchInput.value = '';
			}
			applyPaymentFilters();
		}

		// פונקציה להחלת סינונים נוספים על תשלומים
		function applyAdditionalPaymentFilters(paymentsArray) {
			let filtered = [...paymentsArray];
			
			// סינון לפי תאריך
			const dateFrom = document.getElementById('filterPaymentDateFrom')?.value;
			const dateTo = document.getElementById('filterPaymentDateTo')?.value;
			
			if (dateFrom) {
				filtered = filtered.filter(p => p.date >= dateFrom);
			}
			if (dateTo) {
				filtered = filtered.filter(p => p.date <= dateTo);
			}
			
			return filtered;
		}

		// Add new function for clearing debt filters:
		function clearDebtFilters() {
			const sortBy = document.getElementById('debtSortBy');
			const minAmount = document.getElementById('minDebtAmount');
			const dayFilter = document.getElementById('debtDayFilter');
			const clientSearch = document.getElementById('debtClientSearch');
			
			if (sortBy) sortBy.value = 'amount_desc';
			if (minAmount) minAmount.value = '';
			if (dayFilter) dayFilter.value = '';
			if (clientSearch) {
				clientSearch.value = '';
				clientSearch.removeAttribute('data-selected-id');
			}
			
			displayDebts();
		}

		// Smart search for receipts
		function handleReceiptSmartSearch(searchTerm) {
			if (!searchTerm.trim()) {
				applyReceiptFilters();
				return;
			}
			
			// Find matching clients
			const matchingClients = searchClientsAdvanced(searchTerm);
			const clientNames = matchingClients.map(client => client.name);
			
			if (clientNames.length === 0) {
				displayFilteredReceipts([]);
				updateReceiptsStats([]);
				return;
			}
			
			// Filter receipts by found clients
			let filteredReceipts = receipts.filter(receipt => 
				clientNames.some(name => 
					receipt.location_name && receipt.location_name.includes(name)
				)
			);
			
			// Apply additional filters
			filteredReceipts = applyAdditionalReceiptFilters(filteredReceipts);
			
			displayFilteredReceipts(filteredReceipts);
			updateReceiptsStats(filteredReceipts);
		}

		// Clear smart search for receipts
		function clearReceiptSmartSearch() {
			document.getElementById('receiptSmartSearch').value = '';
			applyReceiptFilters();
		}

		// Apply additional receipt filters
		function applyAdditionalReceiptFilters(receiptsArray) {
			let filtered = [...receiptsArray];
			
			// Filter by book
			const bookFilter = document.getElementById('filterReceiptBook')?.value;
			if (bookFilter) {
				filtered = filtered.filter(r => r.book_number === bookFilter);
			}
			
			// Filter by payment type
			const paymentFilter = document.getElementById('filterPaymentType')?.value;
			if (paymentFilter) {
				filtered = filtered.filter(r => r.payment_type === paymentFilter);
			}
			
			// Filter by date range
			const dateFrom = document.getElementById('filterReceiptDateFrom')?.value;
			const dateTo = document.getElementById('filterReceiptDateTo')?.value;
			
			if (dateFrom) {
				filtered = filtered.filter(r => r.date >= dateFrom);
			}
			if (dateTo) {
				filtered = filtered.filter(r => r.date <= dateTo);
			}
			
			return filtered;
		}


		// Add this helper function at the top of your script:
		function safeSetHTML(elementId, html) {
			const element = document.getElementById(elementId);
			if (element) {
				element.innerHTML = html;
				return true;
			}
			return false;
		}

		function safeSetValue(elementId, value) {
			const element = document.getElementById(elementId);
			if (element) {
				element.value = value;
				return true;
			}
			return false;
		} 


		document.addEventListener('DOMContentLoaded', function() {
			console.log('App starting...');
			
			// Initialize Google APIs first
			initializeGoogleAPIs();
			
			// Initialize data from local storage
			loadFromLocalStorage();
			
			// Set default section
			showSection('planning');
			
			// Initialize cost settings if they exist
			if (costSettings.hourlyRate) {
				const hourlyRateEl = document.getElementById('hourlyRate');
				if (hourlyRateEl) hourlyRateEl.value = costSettings.hourlyRate;
			}
			
			// Auto-connect to Google Sheets if credentials exist
			if (localStorage.getItem('google_access_token')) {
				setTimeout(() => {
					if (typeof connectToGoogleSheets === 'function') {
						connectToGoogleSheets();
					}
				}, 1000);
			}
			
			console.log('App initialization complete');
		});

		// Add this function - it's missing from the code:
		function showClientHistory(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// Jump to treatments tab
			showSection('history');
			
			// Wait for tab to load, then apply client filter
			setTimeout(() => {
				// Clear existing filters first
				if (typeof clearVisitFilters === 'function') {
					clearVisitFilters();
				}
				
				// Set smart search to client name
				const smartSearchInput = document.getElementById('visitSmartSearch');
				if (smartSearchInput) {
					smartSearchInput.value = client.name;
					// Trigger the search
					if (typeof handleVisitSmartSearch === 'function') {
						handleVisitSmartSearch(client.name);
					}
				}
				
				showToast(`מציג היסטוריית טיפולים עבור ${client.name}`, 'info', 2000);
			}, 200);
		}

		
		
		async function validateToken() {
			if (!access_token || !gapi.client) {
				updateCloudStatus('🔐 לא מחובר לענן', 'נותק');
				return false;
			}

			try {
				// בדיקה פשוטה - נסה לקרוא מהטבלה
				await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID || 'test'
				});
				return true;
			} catch (error) {
				if (error.status === 401) {
					console.log('Google token expired');
					access_token = null;
					updateCloudStatus('🔐 נדרש חיבור מחדש', 'נותק');
					document.getElementById('statusText').classList.remove('connected');
					document.getElementById('saveBtn').disabled = true;
					document.getElementById('loadBtn').disabled = true;
					showToast('⚠️ החיבור לגוגל פג - התחבר מחדש', 'warning');
					return false;
				}
				updateCloudStatus('⚠️ בעיית חיבור לענן', 'שגיאה');
				return false;
			}
		}
		
		
		function updateCloudStatus(status, lastAction) {
			const statusElement = document.getElementById('statusText');
			const lastSavedElement = document.getElementById('lastSaved');
			
			if (statusElement) {
				statusElement.textContent = status;
				
				// עדכון צבעים לפי סטטוס
				if (status.includes('מחובר') || status.includes('מסונכרן')) {
					statusElement.style.color = '#28a745'; // ירוק
					statusElement.style.fontWeight = 'bold';
					statusElement.style.background = 'transparent'; // הסר רקע
					statusElement.classList.add('connected');
				} else if (status.includes('שומר') || status.includes('מעדכן')) {
					statusElement.style.color = '#ffc107'; // צהוב
					statusElement.style.fontWeight = 'bold';
				} else if (status.includes('שגיאה')) {
					statusElement.style.color = '#dc3545'; // אדום
					statusElement.style.fontWeight = 'bold';
					statusElement.classList.remove('connected');
				} else if (status.includes('נדרש חיבור')) {
					statusElement.style.color = '#fd7e14'; // כתום
					statusElement.style.fontWeight = 'bold';
					statusElement.classList.remove('connected');
				}
			}
			
			// עדכון זמן פעולה אחרונה
			if (lastSavedElement && lastAction) {
				lastSavedElement.textContent = `${lastAction}: ${new Date().toLocaleTimeString('he-IL')}`;
				//lastSavedElement.style.color = //'#333'; // צבע כהה יותר
			}
		}
		
		
		// Add this function for the "proceed to payment details" button
		function proceedToPaymentDetails() {
			// בדיקה שנבחרו טיפולים
			if (selectedVisitIds.length === 0) {
				showToast('יש לבחור לפחות טיפול אחד', 'error');
				return;
			}
			
			// מעבר לשלב הבא
			document.getElementById('visitsSelectionSection').style.display = 'none';
			document.getElementById('paymentDetailsSection').style.display = 'block';
			
			// אפשר את כפתור השמירה
			document.getElementById('savePaymentBtn').disabled = false;
			
			// עדכון הכותרת
			const totalAmount = selectedVisitIds.reduce((sum, visitId) => {
				const visit = visits.find(v => v.ID === visitId);
				return sum + (parseFloat(visit?.amount) || 0);
			}, 0);
			
			document.getElementById('paymentModalTitle').textContent = 
				`💰 תשלום ${totalAmount}₪ עבור: ${selectedClient.name}`;
		}


		// Add event listeners to checkboxes when creating visit items
		function loadClientVisitsForPayment(clientId) {
			const clientVisits = visits.filter(visit => 
				visit.location_id === clientId && 
				getVisitPaymentStatus(visit.ID) !== 'paid'
			);
			
			if (clientVisits.length === 0) {
				document.getElementById('visitsList').innerHTML = 
					'<div style="text-align: center; padding: 20px; color: #666;">אין טיפולים פתוחים ללקוח זה</div>';
				return;
			}
			
			const visitsHtml = clientVisits.map(visit => {
				const isPreSelected = selectedVisitIds.includes(visit.ID);
				return `
					<div class="visit-item">
						<input type="checkbox" 
							   class="visit-checkbox" 
							   id="visit_${visit.ID}" 
							   value="${visit.ID}"
							   ${isPreSelected ? 'checked' : ''}
							   onchange="updateSelectedVisitsCount()">
						<div class="visit-details">
							<div style="font-weight: bold;">${formatDate(visit.date)}</div>
							<div style="font-size: 12px; color: #666;">${visit.work_done || 'ללא תיאור'}</div>
						</div>
						<div class="visit-amount">${visit.amount || 0}₪</div>
					</div>
				`;
			}).join('');
			
			document.getElementById('visitsList').innerHTML = visitsHtml;
			
			// עדכון ספירה ראשונית
			updateSelectedVisitsCount();
		}


		// Add this debug function to test if the dates update system works
		function testTreatmentDatesUpdate() {
			console.log('🧪 Testing treatment dates update system...');
			
			// בדוק כמה לקוחות יש
			console.log(`Total locations: ${locations.length}`);
			console.log(`Total visits: ${visits.length}`);
			
			// מצא לקוח עם ביקורים
			const locationsWithVisits = locations.filter(loc => {
				const hasVisits = visits.some(visit => visit.location_id === loc.ID);
				return hasVisits;
			});
			
			console.log(`Locations with visits: ${locationsWithVisits.length}`);
			
			// הצג דוגמאות
			locationsWithVisits.slice(0, 3).forEach(location => {
				const clientVisits = visits.filter(v => v.location_id === location.ID);
				const latestVisit = clientVisits.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
				
				console.log(`👤 ${location.name}:`);
				console.log(`   Last visit in system: ${location.last_visit}`);
				console.log(`   Next visit in system: ${location.next_visit}`);
				console.log(`   Latest actual visit: ${latestVisit ? latestVisit.date : 'none'}`);
				console.log(`   Interval weeks: ${location.interval_weeks || 4}`);
			});
			
			console.log('🧪 Test complete - check console output above');
		}


		// Load and display today's treatments in the work day section
		function loadTodayTreatments() {
			const today = new Date().toISOString().split('T')[0];
			const todayVisits = visits.filter(visit => visit.date === today)
				.sort((a, b) => {
					const timeA = a.start_time || '23:59';
					const timeB = b.start_time || '23:59';
					return timeA.localeCompare(timeB);
				});
			
			const container = document.getElementById('todayTreatmentsContainer');
			const statusElement = document.getElementById('todayWorkStatus');
			
			if (todayVisits.length === 0) {
				container.innerHTML = `
					<div style="text-align: center; padding: 15px; color: #666; font-style: italic;">
						עדיין לא התחלת טיפולים היום 🌅
					</div>
				`;
				statusElement.textContent = '';
				return;
			}
			
			// ✅ NEW: Separate in-progress from completed
			const inProgressVisits = todayVisits.filter(v => v.start_time && !v.end_time);
			const completedVisits = todayVisits.filter(v => v.end_time);
			const notStartedVisits = todayVisits.filter(v => !v.start_time);
			
			// Update status summary
			const totalIncome = todayVisits.reduce((sum, v) => sum + parseFloat(v.amount || 0), 0);
			statusElement.textContent = `(${completedVisits.length}/${todayVisits.length} הסתיימו • ₪${totalIncome} סה"כ)`;
			
			// Generate treatments HTML
			let html = '';
			
			// ✅ Show in-progress treatments first
			if (inProgressVisits.length > 0) {
				html += `<div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
					<h4 style="margin: 0 0 10px 0; color: #856404;">🔄 בתהליך עכשיו</h4>`;
				
				html += inProgressVisits.map(visit => {
					const client = locations.find(loc => loc.ID === visit.location_id);
					const clientName = visit.location_name || client?.name || 'לקוח לא מזוהה';
					const startTime = visit.start_time || '--:--';
					const workDone = visit.work_done || 'ללא תיאור';
					
					return `
						<div style="background: white; padding: 10px; border-radius: 5px; margin-bottom: 8px; border-left: 4px solid #ffc107;">
							<div style="display: flex; justify-content: space-between; align-items: center;">
								<div style="flex: 1;">
									<div style="font-weight: bold; color: #2c3e50;">${clientName}</div>
									<div style="font-size: 12px; color: #666;">${workDone}</div>
									<div style="font-size: 11px; color: #856404; margin-top: 3px;">⏱️ התחלה: ${startTime}</div>
								</div>
								<button onclick="editVisit('${visit.ID}')" 
										style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">
									✅ סיים טיפול
								</button>
							</div>
						</div>
					`;
				}).join('');
				
				html += `</div>`;
			}
			
			// Show completed treatments
			if (completedVisits.length > 0) {
				html += `<div style="margin-bottom: 10px;">
					<h4 style="margin: 0 0 10px 0; color: #27ae60;">✅ הושלמו היום</h4>`;
				
				html += completedVisits.map(visit => {
					const client = locations.find(loc => loc.ID === visit.location_id);
					const clientName = visit.location_name || client?.name || 'לקוח לא מזוהה';
					const startTime = visit.start_time || '--:--';
					const endTime = visit.end_time || '--:--';
					const amount = visit.amount || 0;
					const workDone = visit.work_done || 'ללא תיאור';
					
					return `
						<div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 8px; opacity: 0.8;">
							<div style="display: flex; justify-content: space-between;">
								<div style="flex: 1;">
									<div style="font-weight: bold; color: #2c3e50;">${clientName}</div>
									<div style="font-size: 12px; color: #666;">${workDone}</div>
									<div style="font-size: 11px; color: #666; margin-top: 3px;">
										${startTime} → ${endTime}
									</div>
								</div>
								<div style="text-align: left; color: #27ae60; font-weight: bold;">
									${amount}₪
								</div>
							</div>
						</div>
					`;
				}).join('');
				
				html += `</div>`;
			}
			
			// Show not started treatments
			if (notStartedVisits.length > 0) {
				html += `<div>
					<h4 style="margin: 0 0 10px 0; color: #666;">📋 מתוכננים</h4>`;
				
				html += notStartedVisits.map(visit => {
					const client = locations.find(loc => loc.ID === visit.location_id);
					const clientName = visit.location_name || client?.name || 'לקוח לא מזוהה';
					
					return `
						<div style="background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 8px;">
							<div style="font-weight: bold; color: #495057;">${clientName}</div>
							<button onclick="editVisit('${visit.ID}')" 
									style="margin-top: 5px; padding: 6px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
								▶️ התחל טיפול
							</button>
						</div>
					`;
				}).join('');
				
				html += `</div>`;
			}
			
			container.innerHTML = html;
		}

		// Refresh today's treatments - called by refresh button
		function refreshTodayTreatments() {
			loadTodayTreatments();
			showToast('הטיפולים של היום עודכנו', 'success', 1500);
		}

		// Add to the existing loadPlanningData function - call loadTodayTreatments() at the end
		// You need to add this line: loadTodayTreatments(); 
		// to the end of the loadPlanningData() function
		
		
		function updateLocationNotes(locationId, newNotes) {
			const location = locations.find(loc => loc.ID === locationId);
			if (location) {
				location.notes = newNotes;
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(location);
				}
			}
		}

		// Load client options for debts filter
		function loadDebtClientOptions() {
			const datalist = document.getElementById('debtClientOptions');
			if (!datalist) return;
			
			// Get clients with debts
			const clientsWithDebts = new Set();
			visits.forEach(visit => {
				if (visit.amount > 0) {
					const visitAmount = parseFloat(visit.amount) || 0;
					const paidAmount = getVisitPaidAmount(visit.ID);
					const debt = visitAmount - paidAmount;
					if (debt > 0) {
						clientsWithDebts.add(visit.location_id);
					}
				}
			});
			
			// Populate datalist
			datalist.innerHTML = '';
			locations
				.filter(loc => clientsWithDebts.has(loc.ID))
				.sort((a, b) => a.name.localeCompare(b.name, 'he'))
				.forEach(client => {
					const option = document.createElement('option');
					option.value = client.name;
					option.setAttribute('data-client-id', client.ID);
					datalist.appendChild(option);
				});
		}

		// Handle client selection
		function handleDebtClientSelection(clientName) {
			const option = document.querySelector(`#debtClientOptions option[value="${clientName}"]`);
			const clientId = option ? option.getAttribute('data-client-id') : '';
			
			// Store selected client ID for filtering
			document.getElementById('debtClientSearch').setAttribute('data-selected-id', clientId);
			
			// Apply filter
			displayDebts();
		}

		// Clear client search
		function clearDebtClientSearch() {
			const searchInput = document.getElementById('debtClientSearch');
			searchInput.value = '';
			searchInput.removeAttribute('data-selected-id');
			displayDebts();
		}

		// Filter client options as user types (optional enhancement)
		function filterDebtClientOptions(searchTerm) {
			// This function can be enhanced later if needed
			// For now, the datalist handles filtering automatically
		}


		
		// Global client lock system
		let isClientLocked = false;
		let lockedClientId = null;
		let lockedClientName = '';

		function toggleClientLock() {
			const lockBtn = document.getElementById('lockBtn');
			const clientSelector = document.getElementById('lockClientSelector');
			
			if (isClientLocked) {
				// Unlock - release all tabs and hide client selector
				isClientLocked = false;
				lockedClientId = null;
				lockedClientName = '';
				
				lockBtn.textContent = '🔓';
				lockBtn.classList.remove('locked');
				lockBtn.title = 'נעילת סינכרון לקוחות';
				
				// Hide client selector
				clientSelector.style.display = 'none';
				clientSelector.value = '';
				
				showToast('נעילה שוחררה - כל הטאבים עצמאיים', 'info', 2000);
			} else {
				// Lock - show client selector
				isClientLocked = true;
				
				lockBtn.textContent = '🔒';
				lockBtn.classList.add('locked');
				lockBtn.title = 'משחרר נעילה';
				
				// Show and populate client selector
				clientSelector.style.display = 'inline-block';
				clientSelector.innerHTML = `
					<option value="">בחר לקוח...</option>
					${locations.filter(loc => loc.active === '1').sort((a, b) => a.name.localeCompare(b.name, 'he')).map(client => 
						`<option value="${client.ID}">${client.name}</option>`
					).join('')}
				`;
				
				showToast('נעילה פעילה - בחר לקוח מהרשימה', 'info', 3000);
			}
		}

		function selectClientForLock(clientId) {
			if (!clientId || !isClientLocked) return;
			
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			lockedClientId = clientId;
			lockedClientName = client.name;
			
			// Apply client to all tabs
			syncAllTabsToClient(clientId, client.name);
			
			showToast(`כל הטאבים מסונכרנים ל: ${client.name}`, 'success', 3000);
		}

		function syncAllTabsToClient(clientId, clientName) {
			// Sync visits/history tab
			const visitSearch = document.getElementById('visitSmartSearch');
			if (visitSearch) {
				visitSearch.value = clientName;
				if (typeof handleVisitSmartSearch === 'function') {
					handleVisitSmartSearch(clientName);
				}
			}
			
			// Sync debts tab
			const debtSearch = document.getElementById('debtClientSearch');
			if (debtSearch) {
				debtSearch.value = clientName;
				debtSearch.setAttribute('data-selected-id', clientId);
				if (typeof displayDebts === 'function') {
					displayDebts();
				}
			}
			
			// Sync payments tab
			const paymentSearch = document.getElementById('paymentSmartSearch');
			if (paymentSearch) {
				paymentSearch.value = clientName;
				if (typeof handlePaymentSmartSearch === 'function') {
					handlePaymentSmartSearch(clientName);
				}
			}
			
			// Fix receipts tab - use the smart search
			const receiptSearch = document.getElementById('receiptSmartSearch');
			if (receiptSearch) {
				receiptSearch.value = clientName;
				if (typeof handleReceiptSmartSearch === 'function') {
					handleReceiptSmartSearch(clientName);
				}
			}
			
			// For locations tab - filter the table directly
			if (typeof filterLocationsTable === 'function') {
				const nameFilter = document.getElementById('filterClientName');
				if (nameFilter) {
					nameFilter.value = clientName;
					filterLocationsTable();
				}
			}
		}

		// ✅ TEMPORARY: Placeholder for future CSV import feature
		function handleImportFile(event) {
			showToast('⚠️ תכונה זו בפיתוח - בינתיים השתמש בייבוא דרך טבלת העזר', 'info', 3000);
			event.target.value = ''; // Reset file input
		}

   </script>
</body>
</html>
