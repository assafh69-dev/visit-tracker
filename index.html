<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול טיפולים ולקוחות</title>
	
	<script src="https://apis.google.com/js/api.js"></script>
	<script src="https://accounts.google.com/gsi/client"></script>
	
    <style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			direction: rtl;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}

		/* Header מעוצב */
		.header {
			background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
			border-radius: 15px;
			padding: 30px;
			margin-bottom: 20px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.3);
			color: white;
		}

		.header h1 {
			font-size: 2.5em;
			margin-bottom: 10px;
			text-align: center;
			text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
			background: linear-gradient(45deg, #3498db, #2ecc71);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}

		/* Connection Status מעוצב */
		.connection-status {
			text-align: center;
			margin: 20px 0;
			padding: 20px;
			background: rgba(255,255,255,0.1);
			border-radius: 15px;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255,255,255,0.2);
		}

		.connect-btn {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 12px 24px;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			margin: 5px;
			transition: all 0.3s ease;
			box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
		}

		.connect-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
		}

		.connect-btn:disabled {
			background: #95a5a6;
			cursor: not-allowed;
			transform: none;
		}

		/* Navigation מעוצב */
		.nav-buttons {
			display: flex;
			gap: 15px;
			justify-content: center;
			flex-wrap: wrap;
			margin-top: 20px;
		}

		.nav-btn {
			padding: 15px 25px;
			border: none;
			background: rgba(255,255,255,0.1);
			color: white;
			border-radius: 10px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255,255,255,0.2);
		}

		.nav-btn:hover {
			background: rgba(255,255,255,0.2);
			transform: translateY(-2px);
		}

		.nav-btn.active {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
			transform: translateY(-2px);
		}

		/* Main Content מעוצב */
		.main-content {
			background: rgba(255,255,255,0.95);
			border-radius: 15px;
			padding: 30px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.2);
			backdrop-filter: blur(10px);
		}

		.section {
			display: none;
		}

		.section.active {
			display: block;
		}

		.section h2 {
			color: #2c3e50;
			margin-bottom: 30px;
			padding-bottom: 15px;
			border-bottom: 3px solid #3498db;
			font-size: 1.8em;
			position: relative;
		}

		.section h2::before {
			content: '';
			position: absolute;
			bottom: -3px;
			left: 0;
			width: 60px;
			height: 3px;
			background: linear-gradient(45deg, #e74c3c, #f39c12);
			border-radius: 2px;
		}

		/* Forms מעוצבים */
		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			margin-bottom: 8px;
			color: #2c3e50;
			font-weight: bold;
			font-size: 14px;
		}

		.form-group input, .form-group select, .form-group textarea {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #e9ecef;
			border-radius: 8px;
			font-size: 14px;
			transition: all 0.3s ease;
			background: white;
		}

		.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
			transform: translateY(-1px);
		}

		/* Buttons מעוצבים */
		.add-btn {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
			border: none;
			padding: 15px 30px;
			border-radius: 10px;
			cursor: pointer;
			margin-bottom: 20px;
			font-size: 16px;
			font-weight: bold;
			transition: all 0.3s ease;
			box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
		}

		.add-btn:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
		}

		.action-btn {
			padding: 8px 16px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 12px;
			margin: 0 3px;
			transition: all 0.3s ease;
			font-weight: bold;
		}

		.edit-btn {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
		}

		.edit-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
		}

		.delete-btn {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			color: white;
		}

		.delete-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
		}

		/* Tables מעוצבות */
		.table-container {
			background: white;
			border-radius: 12px;
			overflow: hidden;
			box-shadow: 0 8px 25px rgba(0,0,0,0.15);
			margin-top: 20px;
		}

		.data-table {
			width: 100%;
			border-collapse: collapse;
			background: white;
		}

		.data-table thead {
			background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
			color: white;
		}

		.data-table th {
			padding: 15px 12px;
			text-align: right;
			font-weight: bold;
			border-bottom: 2px solid #3498db;
		}

		.data-table td {
			padding: 12px;
			border-bottom: 1px solid #ecf0f1;
			transition: background 0.3s ease;
		}

		.data-table tbody tr:hover {
			background: #f8f9fa;
			transform: scale(1.01);
		}

		.data-table tbody tr:nth-child(even) {
			background: #fbfcfd;
		}

		/* Filter Panels מעוצבים */
		.filter-panel, .info-panel {
			background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%);
			border: 2px solid #95a5a6;
			border-radius: 12px;
			margin-bottom: 20px;
			overflow: hidden;
			box-shadow: 0 5px 15px rgba(0,0,0,0.1);
		}

		.filter-header, .info-header {
			background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
			padding: 15px 20px;
			cursor: pointer;
			color: white;
			transition: all 0.3s ease;
			border-bottom: 2px solid #3498db;
		}

		.filter-header:hover, .info-header:hover {
			background: linear-gradient(135deg, #4a6741 0%, #2c3e50 100%);
		}

		.filter-content, .info-content {
			padding: 25px;
			display: block;
			background: white;
		}

		.filter-content.collapsed, .info-content.collapsed {
			display: none;
		}

		/* Submit Button מעוצב */
		button[type="submit"] {
			width: 100%;
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 18px;
			border-radius: 10px;
			cursor: pointer;
			font-size: 18px;
			font-weight: bold;
			margin-top: 20px;
			transition: all 0.3s ease;
			box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
		}

		button[type="submit"]:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
		}

		/* Mobile Responsive */
		@media (max-width: 768px) {
			.container {
				padding: 10px;
			}
			
			.header {
				padding: 20px 15px;
			}
			
			.header h1 {
				font-size: 1.8em;
			}
			
			.nav-buttons {
				gap: 8px;
			}
			
			.nav-btn {
				padding: 12px 16px;
				font-size: 12px;
			}
			
			.main-content {
				padding: 20px 15px;
			}
		}

		/* Toast Notifications */
		.toast-container {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 1000;
			max-width: 300px;
		}

		.toast {
			background: linear-gradient(45deg, #2c3e50, #3498db);
			color: white;
			padding: 15px 20px;
			border-radius: 8px;
			margin-bottom: 10px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
			transform: translateX(400px);
			opacity: 0;
			transition: all 0.3s ease;
			border-right: 4px solid #27ae60;
			font-weight: bold;
		}

		.toast.success {
			border-right-color: #27ae60;
			background: linear-gradient(45deg, #27ae60, #2ecc71);
		}

		.toast.error {
			border-right-color: #e74c3c;
			background: linear-gradient(45deg, #e74c3c, #c0392b);
		}

		.toast.warning {
			border-right-color: #f39c12;
			background: linear-gradient(45deg, #f39c12, #e67e22);
		}

		.toast.info {
			border-right-color: #3498db;
			background: linear-gradient(45deg, #3498db, #2980b9);
		}

		.toast.show {
			transform: translateX(0);
			opacity: 1;
		}

		@media (max-width: 768px) {
			.toast-container {
				left: 10px;
				right: 10px;
				top: 10px;
				max-width: none;
			}
			
			.toast {
				transform: translateY(-100px);
			}
			
			.toast.show {
				transform: translateY(0);
			}
		}
		

		/* כפתורים כלליים */
		.btn {
			padding: 12px 20px;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			box-shadow: 0 3px 10px rgba(0,0,0,0.2);
			min-width: 120px;
		}

		.btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(0,0,0,0.3);
		}

		.btn-primary {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
		}

		.btn-success {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
		}

		.btn-warning {
			background: linear-gradient(45deg, #f39c12, #e67e22);
			color: white;
		}

		.btn-secondary {
			background: linear-gradient(45deg, #95a5a6, #7f8c8d);
			color: white;
		}

		.btn-info {
			background: linear-gradient(45deg, #17a2b8, #138496);
			color: white;
		}

		/* כפתורי פילטר */
		.filter-btn {
			padding: 10px 18px;
			border: 2px solid #3498db;
			background: linear-gradient(45deg, #ecf0f1, #bdc3c7);
			color: #2c3e50;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			min-width: 100px;
		}

		.filter-btn:hover {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
		}

		.filter-btn.active {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
		}

		/* רשימות נפתחות */
		select, .form-group select {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			cursor: pointer;
			min-height: 45px;
		}

		select:focus, .form-group select:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		select:hover {
			border-color: #7f8c8d;
			background: white;
		}

		/* שדות תאריך */
		input[type="date"] {
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			min-height: 45px;
		}

		input[type="date"]:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		/* כפתורי פעולות פילטר */
		.filter-actions .btn {
			margin: 5px 8px;
			padding: 10px 20px;
			font-size: 14px;
			min-width: 100px;
		}

		/* כפתורי ייבוא במערכת */
		.form-section .btn {
			margin: 8px 5px;
			padding: 12px 20px;
			font-size: 14px;
			font-weight: bold;
			min-width: 150px;
		}

		/* שיפור נוסף לכפתורים קטנים */
		.action-btn {
			padding: 10px 16px;
			font-size: 13px;
			font-weight: bold;
			min-width: 80px;
		}

		/* כפתורים מוקפצים (disabled) */
		button:disabled, .btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none !important;
			box-shadow: none !important;
		}

		/* שיפור לתיבות טקסט */
		input[type="text"], input[type="number"], textarea {
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			min-height: 45px;
		}

		input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		/* שיפור לכותרות בפאנלים */
		.filter-header h3, .info-header h3 {
			font-size: 16px;
			font-weight: bold;
			margin: 0;
			text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
		}

		/* מובייל - התאמות */
		@media (max-width: 768px) {
			.btn {
				padding: 10px 15px;
				font-size: 13px;
				min-width: 100px;
			}
			
			select, input[type="date"], input[type="text"], input[type="number"] {
				padding: 10px 12px;
				font-size: 13px;
				min-height: 40px;
			}
		}
		
		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
		}

		.stat-item {
			background: rgba(255,255,255,0.7);
			padding: 15px;
			border-radius: 8px;
			border-left: 4px solid #27ae60;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			backdrop-filter: blur(5px);
		}

		.stat-label {
			display: block;
			font-weight: bold;
			color: #495057;
			margin-bottom: 5px;
			font-size: 14px;
		}

		.stat-value {
			font-size: 1.4em;
			font-weight: bold;
			color: #2c3e50;
		}

		@media (max-width: 768px) {
			.stats-grid {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		.debt-card .summary-value {
			color: #e74c3c !important;
			font-weight: bold;
		}

		.debts-table tr:hover {
			background-color: #f8f9fa !important;
		}

		.action-btn {
			margin: 1px;
			padding: 4px 8px;
			font-size: 12px;
			border-radius: 3px;
			border: none;
			color: white;
			cursor: pointer;
		}

		.action-btn:hover {
			opacity: 0.8;
		}

	</style>
   
</head>
<body>
	<!-- Toast Container -->
	<div id="toastContainer" class="toast-container"></div>
    <div class="container">
        <header class="header">
            <h1>טיפולים</h1>
			<div id="connectionStatus" class="connection-status">
				<button onclick="connectToGoogleSheets()" id="connectBtn" class="connect-btn">
					התחבר ל-Google Sheets
				</button>
				<button onclick="saveAllToSheets()" id="saveBtn" class="connect-btn" disabled>
					שמור לענן
				</button>
				<button onclick="loadAllFromSheets()" id="loadBtn" class="connect-btn" disabled>
					טען מהענן
				</button>
				<span id="statusText">לא מחובר</span>
			</div>
            <nav class="nav-buttons">
				<button onclick="showSection('planning')" class="nav-btn active">תכנון יומי</button>
				<button onclick="showSection('visit')" class="nav-btn">טיפול חדש</button>
				<button onclick="showSection('history')" class="nav-btn">טיפולים</button> 
				<button onclick="showSection('locations')" class="nav-btn">לקוחות</button>
				<button onclick="showSection('receipts')" class="nav-btn">קבלות</button>
				<button onclick="showSection('debts')" class="nav-btn">💰 חובות</button>
				<button onclick="showSection('system')" class="nav-btn">מערכת v2.0</button>
			</nav>
        </header>

        <main class="main-content">
            <!-- Planning Section -->
            <section id="planning" class="section active">
                <h2>📅 תכנון יומי</h2>
				<!-- Statistics Panel -->
				<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
					<div style="background: rgba(52, 152, 219, 0.1); border: 2px solid #3498db; border-radius: 8px; padding: 12px;">
						<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
							<span style="font-size: 13px; color: #2c3e50;">לקוחות:</span>
							<span id="totalLocations" style="font-weight: bold; color: #2c3e50;">0</span>
						</div>
						<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
							<span style="font-size: 13px; color: #2c3e50;">פעילים:</span>
							<span id="activeLocations" style="font-weight: bold; color: #27ae60;">0</span>
						</div>
						<div style="display: flex; justify-content: space-between;">
							<span style="font-size: 13px; color: #2c3e50;">טיפולים השבוע:</span>
							<span id="weeklyVisits" style="font-weight: bold; color: #2c3e50;">0</span>
						</div>
					</div>
					
					<div style="background: rgba(39, 174, 96, 0.1); border: 2px solid #27ae60; border-radius: 8px; padding: 12px;">
						<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
							<span style="font-size: 13px; color: #2c3e50;">הכנסה השבוע:</span>
							<span id="weeklyIncome" style="font-weight: bold; color: #27ae60;">₪0</span>
						</div>
						<div style="display: flex; justify-content: space-between;">
							<span style="font-size: 13px; color: #2c3e50;">חובות פתוחים:</span>
							<span id="openDebts" style="font-weight: bold; color: #e74c3c;">₪0</span>
						</div>
					</div>
				</div>
                <div class="filter-buttons">
					<button onclick="filterVisits('today')" class="filter-btn active">היום</button>
					<button onclick="filterVisits('week')" class="filter-btn">השבוע</button>
					<button onclick="filterVisits('overdue')" class="filter-btn">מאחרות</button>
					<button onclick="showMonthlyReport()" class="btn" style="background: #17a2b8; margin: 10px;">
						📊 דוח חודשי
					</button>
				</div>
                <div class="table-container">
                    <table id="planningTable" class="data-table">
                        <thead>
                            <tr>
                                <th>שם גינה</th>
                                <th>כתובת</th>
                                <th>יום מותר</th>
                                <th>טיפול הבא</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody id="planningTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- VisitSection -->
            <section id="visit" class="section">
                <h2>טיפול חדש</h2>
                <div class="form-container">
                    <form id="visitForm">
                        <div class="form-group">
							<label for="locationSelect">בחר לקוח:</label>
							<select id="locationSelect" required>
								<option value="">בחר לקוח...</option>
							</select>
						</div>

						<!-- הוסף כאן -->
						<div class="form-group">
							<label for="visitDate">תאריך טיפול:</label>
							<input type="date" id="visitDate" required>
						</div>

						<div class="form-group">
							<label for="visitTime">שעת התחלה:</label>
							<input type="time" id="visitTime" required>
						</div>
                        <div class="form-group">
                            <label for="visitType">סוג טיפול:</label>
                            <select id="visitType" required>
                                <option value="מלא">מלא</option>
                                <option value="חלקי">חלקי</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="workDone">מה בוצע:</label>
                            <textarea id="workDone" placeholder="תיאור העבודה שבוצעה"></textarea>
                        </div>
                        <div class="form-group">
							<label for="manualDurationMinutes">משך הטיפול (דקות):</label>
							<div style="display: flex; gap: 10px; align-items: center;">
								<input type="number" id="manualDurationMinutes" placeholder="90" min="0" onchange="updateHoursDisplay()" style="flex: 1;">
								<span style="color: #666; font-size: 14px;">שעות:</span>
								<input type="text" id="calculatedHours" readonly style="width: 80px; background: #f8f9fa; color: #666; border: 2px solid #e9ecef; border-radius: 6px; padding: 8px; text-align: center;" placeholder="1.5">
							</div>
						</div>
                        <div class="form-group">
							<label for="numberOfWorkersVisit">מספר עובדים בטיפול:</label>
							<div style="display: flex; gap: 10px; align-items: center;">
								<input type="number" id="numberOfWorkersVisit" value="1" min="1" onchange="calculateTreatmentCost()" style="width: 80px;">
								<span style="color: #666; font-size: 14px;">עובדים (כולל אותך)</span>
							</div>
						</div>

						<div class="form-group">
							<label for="amount">סכום:</label>
							<div style="display: flex; gap: 10px; align-items: center;">
								<input type="number" id="amount" placeholder="סכום הטיפול" style="flex: 1;">
								<button type="button" onclick="calculateTreatmentCost()" style="background: #f39c12; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
									🔄 חשב
								</button>
							</div>
							<div id="costBreakdown" style="font-size: 12px; color: #666; margin-top: 5px;">
								<!-- כאן יופיע פירוט החישוב -->
							</div>
						</div>
                        <div class="form-group">
							<label for="expense">הוצאה:</label>
							<input type="number" id="expense" placeholder="הוצאות נילוות" onchange="calculateTreatmentCost()">
						</div>
                        <button type="submit">שמור טיפול</button>
                    </form>
                </div>
            </section>

			<!-- History Section -->
			<section id="history" class="section">
				<h2>📋 טיפולים</h2>
				
				<!-- Filter Panel -->
				<div class="filter-panel">
					<div class="filter-header" onclick="toggleFilterPanel()">
						<h3>🔍 סינון טיפולים <span id="filterIcon">🔽</span></h3>
					</div>
					<div id="filterContent" class="filter-content">
						<div class="filter-row">
							<div class="filter-group">
								<label>לקוח:</label>
								<select id="filterLocation">
									<option value="">כל הלקוחות</option>
								</select>
							</div>
							<div class="filter-group">
								<label>סטטוס תשלום:</label>
								<select id="filterPayment">
									<option value="">הכל</option>
									<option value="כן">שולם</option>
									<option value="לא">לא שולם</option>
									<option value="ללא">ללא תשלום</option>
								</select>
							</div>
						</div>
						<div class="filter-row">
							<div class="filter-group">
								<label>מתאריך:</label>
								<input type="date" id="filterDateFrom">
							</div>
							<div class="filter-group">
								<label>עד תאריך:</label>
								<input type="date" id="filterDateTo">
							</div>
						</div>
						<div class="filter-actions">
							<button onclick="applyVisitFilters()" class="btn btn-primary">סנן</button>
							<button onclick="clearVisitFilters()" class="btn btn-secondary">נקה סינון</button>
						</div>
					</div>
				</div>

				<!-- Info Panel -->
				<div class="info-panel">
					<div class="info-header" onclick="toggleInfoPanel()">
						<h3>📊 מידע <span id="infoIcon">🔽</span></h3>
					</div>
					<div id="infoContent" class="info-content">
						<div class="info-grid">
							<div class="info-item">
								<span class="info-label">טיפולים מוצגים:</span>
								<span id="visitsCount" class="info-value">0</span>
							</div>
							<div class="info-item">
								<span class="info-label">סה"כ שעות:</span>
								<span id="totalHours" class="info-value">0</span>
							</div>
							<div class="info-item">
								<span class="info-label">סה"כ הכנסות:</span>
								<span id="totalIncome" class="info-value">₪0</span>
							</div>
							<div class="info-item">
								<span class="info-label">חובות פתוחים:</span>
								<span id="outstandingDebt" class="info-value">₪0</span>
							</div>
						</div>
					</div>
				</div>

				<!-- Visits Table -->
				<div class="table-container">
					<table id="visitsHistoryTable" class="data-table">
						<thead>
							<tr>
								<th>תאריך</th>
								<th>לקוח</th>
								<th>סוג טיפול</th>
								<th>עבודה שבוצעה</th>
								<th>משך (שעות)</th>
								<th>סכום</th>
								<th>שולם</th>
								<th>פעולות</th>
							</tr>
						</thead>
						<tbody id="visitsHistoryTableBody">
						</tbody>
					</table>
				</div>
			</section>

            <!-- locations Section -->
            <section id="locations" class="section">
                <h2>ניהול לקוחות</h2>
				<button onclick="showAddLocationForm()" class="add-btn">הוסף לקוח חדש</button>
                <div class="table-container">
                    <table id="locationsTable" class="data-table">
                        <thead>
                            <tr>
                                <th>שם</th>
                                <th>כתובת</th>
                                <th>איש קשר</th>
                                <th>יום מותר</th>
                                <th>מרווח</th>
                                <th>פעילה</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody id="locationsTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Receipts Section -->
            <section id="receipts" class="section">
                <h2>ניהול קבלות</h2>
                <button onclick="showAddReceiptForm()" class="add-btn">הוסף קבלה חדשה</button>
                <div class="table-container">
                    <table id="receiptsTable" class="data-table">
                        <thead>
							<tr>
								<th>פנקס</th>
								<th>קבלה</th>
								<th>תאריך</th>
								<th>בינה</th>
								<th>סכום</th>
								<th>סוג תשלום</th>
								<th>קודX</th>  
								<th>פעולות</th>
							</tr>
						</thead>
                        <tbody id="receiptsTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

			<section id="debts" class="section">
				<h2>💰 ניהול חובות</h2>
				
				<!-- סיכום כללי -->
				<div class="summary-cards">
					<div class="summary-card debt-card">
						<h3>סה"כ חובות</h3>
						<div id="totalDebt" class="summary-value">₪0</div>
					</div>
					<div class="summary-card">
						<h3>לקוחות חייבים</h3>
						<div id="debtorsCount" class="summary-value">0</div>
					</div>
					<div class="summary-card">
						<h3>חוב ממוצע</h3>
						<div id="averageDebt" class="summary-value">₪0</div>
					</div>
					<div class="summary-card">
						<h3>חוב הכי ישן</h3>
						<div id="oldestDebt" class="summary-value">-</div>
					</div>
				</div>
				
				<!-- רשימת חובות -->
				<div class="filter-panel">
					<div class="filter-header">
						<h3>🔍 חובות פתוחים</h3>
					</div>
					<div class="filter-row">
						<div class="filter-group">
							<label>מיון לפי:</label>
							<select id="debtSortBy" onchange="displayDebts()">
								<option value="amount_desc">סכום (גבוה לנמוך)</option>
								<option value="amount_asc">סכום (נמוך לגבוה)</option>
								<option value="date_old">תאריך (הכי ישן)</option>
								<option value="date_new">תאריך (הכי חדש)</option>
								<option value="location">לקוח (א-ב)</option>
							</select>
						</div>
						<div class="filter-group">
							<label>סכום מינימלי:</label>
							<input type="number" id="minDebtAmount" placeholder="0" onchange="displayDebts()">
						</div>
					</div>
				</div>
				
				<div class="table-container">
					<table id="debtsTable" class="data-table">
						<thead>
							<tr>
								<th>לקוח</th>
								<th>כתובת</th>
								<th>טלפון</th>
								<th>מספר טיפולים</th>
								<th>סה"כ חוב</th>
								<th>טיפול אחרון</th>
								<th>ימים</th>
								<th>פעולות</th>
							</tr>
						</thead>
						<tbody id="debtsTableBody">
						</tbody>
					</table>
				</div>
			</section>

			<!-- System Section -->
			<section id="system" class="section">
				<h2>🛠️ מערכת</h2>
				
				<!-- Import Section -->
				<div class="form-section">
					<h3>📥 ייבוא נתונים</h3>
					
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
						<button class="btn btn-primary" onclick="createImportTable()">
							🔗 צור טבלת עזר לייבוא
						</button>
						<button class="btn btn-success" onclick="importFromHelperTable()">
							📥 ייבא הכל מטבלת העזר
						</button>
					</div>
					
					<div style="text-align: center; margin-top: 15px;">
						<button class="btn btn-info" onclick="importFromTelegram()">
							💬 ייבוא מטקסט טלגרם
						</button>
					</div>

					<!-- ייבוא חלקי - מקופל -->
					<details style="margin-top: 15px;">
						<summary style="cursor: pointer; color: #666; font-size: 14px;">⚙️ ייבוא חלקי (למתקדמים)</summary>
						<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
							<button class="btn btn-info" onclick="importCustomersFromHelper()">👥 רק לקוחות</button>
							<button class="btn btn-primary" onclick="importVisitsFromHelper()">🔧 רק טיפולים</button>
							<button class="btn btn-warning" onclick="importReceiptsFromHelper()">🧾 רק קבלות</button>
						</div>
						<p style="font-size: 12px; color: #666; margin-top: 8px;">
							השתמש בזה רק אם אתה צריך לייבא סוג נתונים ספציפי
						</p>
					</details>
					
					<div style="text-align: center; margin: 15px 0;">
						<span style="color: #666;">או</span>
					</div>
					
					<div style="text-align: center;">
						<button class="btn btn-warning" onclick="document.getElementById('importFileInput').click()">
							📁 ייבוא מהיר מקובץ
						</button>
						<input type="file" id="importFileInput" accept=".csv,.xlsx" style="display: none;" onchange="handleImportFile(event)">
					</div>
					
					<p style="text-align: center; font-size: 12px; color: #666; margin-top: 15px;">
						ייבוא לקוחות, ביקורים וקבלות מקובץ Excel או Google Sheets
					</p>
				</div>
				
				<!-- ניהול נתונים -->
				<div class="form-section">
					<h3>🗂️ ניהול נתונים</h3>
					
					<div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
						<h4 style="color: #856404; margin-bottom: 10px;">⚠️ ניקוי נתונים</h4>
						<p style="font-size: 14px; color: #856404; margin-bottom: 10px;">
							נקה את כל הנתונים המקומיים לפני ייבוא חדש (לא משפיע על הענן)
						</p>
						
						<button class="btn" onclick="clearAllDataBeforeImport()" 
								style="background: #dc3545; color: white; border: none;">
							🗑️ נקה את כל הנתונים המקומיים
						</button>
					</div>
					
					<!-- סטטוס טבלת עזר -->
					<div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
						<h4 style="color: #495057; margin-bottom: 10px;">📊 טבלת עזר לייבוא</h4>
						<div id="importTableStatus">
							<span style="font-size: 13px; color: #666;">
								בודק סטטוס טבלת עזר...
							</span>
						</div>
					</div>
				</div>
				
				<!-- Additional System Features -->
					<div class="form-section">
						<h3>⚙️ הגדרות מערכת</h3>
						
						<!-- Cost Settings -->
						<div style="background: rgba(39, 174, 96, 0.1); border: 2px solid #27ae60; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
							<h4 style="color: #27ae60; margin-bottom: 10px;">💰 הגדרות עלות טיפול</h4>
							<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
								<div class="form-group">
									<label for="hourlyRate">שעת עבודה (₪):</label>
									<input type="number" id="hourlyRate" value="150" min="0" onchange="saveCostSettings()">
								</div>
								<div class="form-group">
									<label for="workerCost">תוספת לפועל (₪):</label>
									<input type="number" id="workerCost" value="50" min="0" onchange="saveCostSettings()">
								</div>
							</div>
						</div>
						
						<p style="color: #666;">תכונות נוספות יתווספו כאן בהמשך...</p>
					</div>
			</section>
			
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <script>
		 // Google Sheets API Configuration
		const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
		const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
		let SPREADSHEET_ID = '1fSD5dh0bXRzFSeOZUwJ2bPjGRLqs2crGXPkebz6MpWc';
		const CLIENT_ID = '1040357646874-4sbkrokgjn4dd7a0e9rkrtjt8d9l3vie.apps.googleusercontent.com';
		const API_KEY = 'AIzaSyB25ms_UzbgfY9FnduMwMhGhlvwfVPaTg8';
		const SPREADSHEET_NAME = 'service_visits_data';

//////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>   למחיקה
		// בדיקה זמנית - תמחק אחרי הבדיקה
		console.log('Spreadsheet ID:', SPREADSHEET_ID);
		console.log('API Key:', API_KEY);
		console.log('Client ID:', CLIENT_ID);
//////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>


		let gapi_loaded = false;
		let google_loaded = false;
		let access_token = null;
		let spreadsheet_id = SPREADSHEET_ID;
        
        // Sheet names
        const SHEETS = {
			LOCATIONS: 'Locations',
			VISITS: 'Visits',
			RECEIPTS: 'Receipts',
			SETTINGS: 'SystemSettings'
		};

        // Global variables
        let locations = [];
        let visits = [];
        let receipts = [];
        let currentFilter = 'today';
		// הגדרות עלות
		let costSettings = {
			hourlyRate: 150,
			workerCost: 50
		};

		// Initialize Google APIs
		function initializeGoogleAPIs() {
			gapi.load('client', initializeGapiClient);
			google.accounts.id.initialize({
				client_id: CLIENT_ID,
				callback: handleCredentialResponse,
			});
		}
		
		async function initializeGapiClient() {
			try {
				await gapi.client.init({
					apiKey: API_KEY,
					discoveryDocs: [DISCOVERY_DOC],
				});
				gapi_loaded = true;
				console.log('GAPI client initialized successfully');
			} catch (error) {
				console.error('Error initializing GAPI client:', error);
				showToast('שגיאה באתחול Google API', 'error');
			}
		}

		function handleCredentialResponse(response) {
			access_token = response.credential;
			showSuccess('התחברת בהצלחה ל-Google!');
		}

		// תוספה - פונקציה שנקראת אחרי ההתחברות
		async function loadAllDataFromSheets() {
			if (!await validateToken()) {
				showToast('אין חיבור לגוגל - טוען נתונים מקומיים', 'warning');
				return;
			}
			
			try {
				showLoading('טוען נתונים מ-Google Sheets...');
				
				await loadLocationsFromSheets();
				await loadVisitsFromSheets(); 
				await loadReceiptsFromSheets();
				
				// Update UI
				loadLocationsForSelect();
				loadLocationsTable();
				loadReceiptsTable();
				loadPlanningData();
				
				hideLoading();
				showSuccess('נתונים נטענו בהצלחה מ-Google Sheets!');
				setTimeout(checkCriticalDebts, 2000); // התראה אחרי 2 שניות
				
			} catch (error) {
				console.error('Error loading data from sheets:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('⚠️ החיבור פג במהלך טעינה', 'warning');
				} else {
					showError('שגיאה בטעינת נתונים מ-Google Sheets');
				}
				throw error;
			}
		}

		async function connectToGoogleSheets() {
			try {
				console.log('Connecting to Google Sheets...');
				showToast('מתחבר ל-Google Sheets...', 'info');
				
				const tokenClient = google.accounts.oauth2.initTokenClient({
					client_id: CLIENT_ID,
					scope: SCOPES,
					callback: async (response) => {
						access_token = response.access_token;
						
						// עדכון סטטוס
						document.getElementById('statusText').textContent = 'מחובר';
						document.getElementById('statusText').classList.add('connected');
						document.getElementById('saveBtn').disabled = false;
						document.getElementById('loadBtn').disabled = false;
						
						showToast('התחברת בהצלחה ל-Google Sheets!', 'success');
						
						// כעת חפש או צור טבלה - כמו בטריידים
						await findOrCreateMainSpreadsheet();
						
						// טען נתונים ממש אחרי החיבור
						await loadAllDataFromSheets();
						
						// טען הגדרות אחרון
						await loadSettingsFromCloud();
					},
				});
				
				tokenClient.requestAccessToken();
				
			} catch (error) {
				console.error('Error connecting to Google Sheets:', error);
				showToast('שגיאה בחיבור ל-Google Sheets', 'error');
			}
		}

		// תוספה - טעינת מיקומים (גינות)
		async function loadLocationsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:O`
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					locations = rows.slice(1).map(row => ({
						ID: row[0] || '',
						name: row[1] || '',
						full_address: row[2] || '',
						neighborhood: row[3] || '',
						city: row[4] || '',
						contact_person: row[5] || '',
						phone: row[6] || '',
						allowed_day: row[7] || '',
						interval_weeks: row[8] || '',
						temp_addition: row[9] || 0,
						base_amount: row[10] || '',
						active: row[11] || '',
						notes: row[12] || '',
						last_visit: row[13] || '',
						next_visit: row[14] || ''
					}));
				}
				
			} catch (error) {
				console.error('Error loading locations:', error);
			}
		}

		// תוספה - טעינת ביקורים (טיפולים)
		async function loadVisitsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:L`
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					visits = rows.slice(1).map(row => ({
						ID: row[0] || '',
						date: row[1] || '',
						location_id: row[2] || '',
						visit_type: row[3] || '',
						work_done: row[4] || '',
						duration_minutes: row[5] || 0,
						start_time: row[6] || '',
						end_time: row[7] || '',
						amount: row[8] || 0,
						expense: row[9] || 0,
						paid: row[10] || 'לא',
						notes: row[11] || ''
					}));
				}
				
			} catch (error) {
				console.error('Error loading visits:', error);
			}
		}

		// תוספה - טעינת קבלות
		async function loadReceiptsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:I`
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					receipts = rows.slice(1).map(row => ({
						ID: row[0] || '',
						book_number: row[1] || '',
						receipt_number: row[2] || '',
						date: row[3] || '',
						location_id: row[4] || '',
						location_name: row[5] || '',
						amount: row[6] || 0,
						payment_type: row[7] || '',
						notes: row[8] || ''
					}));
				}
				
			} catch (error) {
				console.error('Error loading receipts:', error);
			}
		}
		
		// תוספה - שמירת מיקום חדש לשיטס
		async function saveLocationToSheets(locationData) {
		
			if (!await validateToken()) {
				showToast('החיבור לגוגל פג - שמירה מקומית בלבד', 'warning');
				return;
			}
    
			try {
				const values = [[
					locationData.ID,
					locationData.name,
					locationData.full_address,
					locationData.neighborhood,
					locationData.city,
					locationData.contact_person,
					locationData.phone,
					locationData.allowed_day,
					locationData.interval_weeks,
					locationData.temp_addition,
					locationData.base_amount,
					locationData.active,
					locationData.notes,
					locationData.last_visit,
					locationData.next_visit
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:O`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving location to sheets:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('⚠️ החיבור פג - התחבר מחדש', 'warning');
					document.getElementById('statusText').textContent = '🔓 נותק';
				} else {
					// שגיאות אחרות (לא קשורות לאסימון)
					showToast('⚠️ שגיאה בשמירה לענן', 'error');
				}
				throw error;

			}
		}

		// שמירת ביקור חדש לשיטס
		async function saveVisitToSheets(visitData) {
			if (!await validateToken()) {
				return;
			}
			
			try {
				const values = [[
					visitData.ID,
					visitData.date,
					visitData.location_id,
					visitData.visit_type,
					visitData.work_done,
					visitData.duration_minutes,
					visitData.num_workers || 1,
					visitData.start_time,
					visitData.end_time,
					visitData.amount,
					visitData.expense || 0,
					visitData.paid,
					visitData.notes
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:M`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving visit to sheets:', error);
				throw error;
			}
		}

		// תוספה - שמירת קבלה לשיטס
		async function saveReceiptToSheets(receiptData) {
			if (!await validateToken()) {
				return;
			}
			
			try {
				const values = [[
					receiptData.ID,
					receiptData.booklet_number || '',
					receiptData.receipt_number || '',
					receiptData.date,
					receiptData.location_id,
					receiptData.location_name || '',
					receiptData.amount,
					receiptData.payment_type || '',
					receiptData.tax_code || '',
					receiptData.notes || ''
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:J`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving receipt to sheets:', error);
				throw error;
			}
		}

		// תוספה - שמירת כל הנתונים לענן
		async function saveAllToSheets() {
			if (!await validateToken()) {
				showToast('חיבור לגוגל פג - שמירה מקומית בלבד', 'warning');
				return;
			}
			
			try {
				showLoading('שומר נתונים לענן...');
				
				let savedCount = 0;
				const totalItems = locations.length + visits.length + receipts.length;
				
				// שמירת מיקומים עם מעקב
				showToast(`שומר ${locations.length} מיקומים לענן...`, 'info', 2000);
				for (let i = 0; i < locations.length; i++) {
					await saveLocationToSheets(locations[i]);
					savedCount++;
					
					if (i % 10 === 0 && i > 0) {
						showToast(`נשמרו ${savedCount}/${totalItems} רשומות...`, 'info', 1000);
					}
					
					if (i < locations.length - 1) {
						await new Promise(resolve => setTimeout(resolve, 500));
					}
				}
				
				// המתנה לפני ביקורים
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				// שמירת ביקורים עם מעקב
				showToast(`שומר ${visits.length} ביקורים לענן...`, 'info', 2000);
				for (let i = 0; i < visits.length; i++) {
					await saveVisitToSheets(visits[i]);
					savedCount++;
					
					if (i % 10 === 0 && i > 0) {
						showToast(`נשמרו ${savedCount}/${totalItems} רשומות...`, 'info', 1000);
					}
					
					if (i < visits.length - 1) {
						await new Promise(resolve => setTimeout(resolve, 500));
					}
				}
				
				// המתנה לפני קבלות
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				// שמירת קבלות עם מעקב
				showToast(`שומר ${receipts.length} קבלות לענן...`, 'info', 2000);
				for (let i = 0; i < receipts.length; i++) {
					await saveReceiptToSheets(receipts[i]);
					savedCount++;
					
					if (i % 5 === 0 && i > 0) {
						showToast(`נשמרו ${savedCount}/${totalItems} רשומות...`, 'info', 1000);
					}
					
					if (i < receipts.length - 1) {
						await new Promise(resolve => setTimeout(resolve, 500));
					}
				}
				
				showToast(`🎉 שמירה הושלמה! 
		✅ ${savedCount} רשומות נשמרו לענן
		📊 כל הנתונים מסונכרנים`, 'success', 5000);
				
			} catch (error) {
				console.error('Error saving all data:', error);
				
				if (error.status === 429) {
					showToast('יותר מדי בקשות - נסה שוב בעוד כמה דקות', 'warning');
				} else {
					showToast('שגיאה בשמירה לענן', 'error');
				}
			} finally {
				hideLoading();
			}
		}


		// תוספה - טעינת כל הנתונים מהענן
		async function loadAllFromSheets() {
			try {
				showLoading('טוען נתונים מהענן...');
				
				await loadLocationsFromSheets();
				await loadVisitsFromSheets(); 
				await loadReceiptsFromSheets();
				
				// עדכון התצוגה
				loadLocationsForSelect();
				loadLocationsTable();
				loadReceiptsTable();
				loadPlanningData();
				
				hideLoading();
				showSuccess('נתונים נטענו בהצלחה מהענן!');
				
			} catch (error) {
				console.error('Error loading all data:', error);
				hideLoading();
				showError('שגיאה בטעינת הנתונים מהענן');
			}
		}


		// Local Storage functions
		function saveToLocalStorage() {
			try {
				localStorage.setItem('locations_data', JSON.stringify(locations));  // שונה
				localStorage.setItem('visits_data', JSON.stringify(visits));        // שונה
				localStorage.setItem('receipts_data', JSON.stringify(receipts));
				console.log('Data saved to local storage');
			} catch (error) {
				console.error('Error saving to local storage:', error);
			}
		}

		function loadFromLocalStorage() {
			try {
				const savedLocations = localStorage.getItem('locations_data');
				const savedVisits = localStorage.getItem('visits_data');
				const savedReceipts = localStorage.getItem('receipts_data');
				const savedCostSettings = localStorage.getItem('cost_settings'); // הוסף זה
				
				if (savedLocations) {
					locations = JSON.parse(savedLocations);
				}
				if (savedVisits) {
					visits = JSON.parse(savedVisits);
				}
				if (savedReceipts) {
					receipts = JSON.parse(savedReceipts);
				}
				if (savedCostSettings) { // הוסף את הבלוק הזה
					costSettings = JSON.parse(savedCostSettings);
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
				}
				
				if (savedCostSettings) {
					costSettings = JSON.parse(savedCostSettings);
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
				}

				console.log('Data loaded from local storage');
				
			} catch (error) {
				console.error('Error loading from local storage:', error);
			}
		}



        document.addEventListener('DOMContentLoaded', function() {
			console.log('App starting...');
			initializeGoogleAPIs();
			loadAllData(); // זה יטען נתונים מקומיים
			setupEventListeners();
		});

        // Setup event listeners
        function setupEventListeners() {
            // Visitform submission
            document.getElementById('visitForm').addEventListener('submit', handleVisitSubmit);
        }

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Add active class to clicked button
            if (event && event.target) {
				event.target.classList.add('active');
			}
            
            // Load section-specific data
            switch(sectionName) {
                case 'planning':
                    loadPlanningData();
                    break;
                case 'visit':
                    loadLocationsForSelect();
                    break;
				case 'history':
					loadVisitsHistory();
					break;
                case 'locations':
                    loadLocationsTable();
                    break;
                case 'receipts':
                    loadReceiptsTable();
                    break;
				case 'debts':
                    displayDebts();
                    break;
            }
        }

        // Data loading functions
		async function loadAllData() {
			try {
				showLoading('טוען נתונים...');
				loadFromLocalStorage();
				hideLoading();
				loadPlanningData();
			} catch (error) {
				console.error('Error loading data:', error);
				showError('שגיאה בטעינת הנתונים');
			}
		}

        async function loadlocations() {
            // For now, we'll use dummy data until we set up the Google Sheets API
            locations = [
                {
                    ID: 1,
                    name: "גינת דוגמה 1",
                    full_address: "רחוב הדוגמה 1, תל אביב",
                    neighborhood: "מרכז",
                    city: "תל אביב",
                    contact_person: "יוסי כהן",
                    phone: "050-1234567",
                    allowed_day: "א'",
                    interval_weeks: 4,
                    temp_addition: 0,
                    base_amount: 300,
                    active: "כן",
                    notes: "",
                    last_visit: "2024-01-15",
                    next_visit: "2024-02-12"
                },
                {
                    ID: 2,
                    name: "גינת דוגמה 2",
                    full_address: "רחוב הדוגמה 2, תל אביב",
                    neighborhood: "צפון",
                    city: "תל אביב",
                    contact_person: "מרים לוי",
                    phone: "052-7654321",
                    allowed_day: "ג'",
                    interval_weeks: 6,
                    temp_addition: 0,
                    base_amount: 400,
                    active: "כן",
                    notes: "",
                    last_visit: "2024-01-10",
                    next_visit: "2024-02-21"
                }
            ];
        }

        async function loadVisits() {
            visits = []; // Will be loaded from Google Sheets
        }

        async function loadReceipts() {
            receipts = []; // Will be loaded from Google Sheets
        }

        // Display functions
        function loadPlanningData() {
			// חישוב סטטיסטיקות
			updatePlanningStats();
			
			// סינון רגיל
			filterVisits(currentFilter);
		}

		// תוספה - עדכון סטטיסטיקות
		function updatePlanningStats() {
			// לקוחות
			const totalLocations = locations.length;
			const activeLocations = locations.filter(loc => loc.active === 'כן').length;
			
			// טיפולים השבוע
			const today = new Date();
			const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
			const weeklyVisits = visits.filter(visit => {
				const visitDate = new Date(visit.date);
				return visitDate >= weekAgo && visitDate <= today;
			});
			
			// הכנסה השבוע
			const weeklyIncome = weeklyVisits.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			// חובות פתוחים
			const openDebts = visits
				.filter(visit => visit.paid === 'לא')
				.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			// עדכון התצוגה
			document.getElementById('totalLocations').textContent = totalLocations;
			document.getElementById('activeLocations').textContent = `${activeLocations} (${totalLocations > 0 ? Math.round((activeLocations / totalLocations) * 100) : 0}%)`;
			document.getElementById('weeklyVisits').textContent = weeklyVisits.length;
			document.getElementById('weeklyIncome').textContent = `₪${weeklyIncome.toLocaleString()}`;
			document.getElementById('openDebts').textContent = `₪${openDebts.toLocaleString()}`;
		}

        function filterVisits(filter) {
			currentFilter = filter;
			
			// Update filter buttons - fix the event.target issue
			document.querySelectorAll('.filter-btn').forEach(btn => {
				btn.classList.remove('active');
				// Add active class to the button that matches the current filter
				if ((filter === 'today' && btn.textContent === 'היום') ||
					(filter === 'week' && btn.textContent === 'השבוע') ||
					(filter === 'overdue' && btn.textContent === 'מאחרות')) {
					btn.classList.add('active');
				}
			});
			
			// Filter locations based on next_visitdate
			const today = new Date();
			const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
			
			let filteredlocations = locations.filter(location => location.active === "כן");
			
			switch(filter) {
				case 'today':
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit= new Date(location.next_visit);
						return nextVisit<= today;
					});
					break;
				case 'week':
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit= new Date(location.next_visit);
						return nextVisit<= weekFromNow;
					});
					break;
				case 'overdue':
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit= new Date(location.next_visit);
						return nextVisit< today;
					});
					break;
			}
			
			displayPlanningTable(filteredlocations);
		}

        function displayPlanningTable(locationsToShow) {
            const tbody = document.getElementById('planningTableBody');
            tbody.innerHTML = '';
            
            if (locationsToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">אין גינות לטיפול</td></tr>';
                return;
            }
            
            locationsToShow.forEach(location => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${location.name}</td>
                    <td>${location.full_address}</td>
                    <td>${location.allowed_day}</td>
                    <td>${formatDate(location.next_visit)}</td>
                    <td>
                        <button class="action-btn start-visit-btn" onclick="startVisitForlocation(${location.ID})">
                            התחל טיפול
                        </button>
                        <button class="action-btn edit-btn" onclick="postponeVisit(${location.ID})">
                            דחה
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadLocationsForSelect() {
            const select = document.getElementById('locationSelect');
            select.innerHTML = '<option value="">בחר לקוח...</option>';
            
            locations.filter(location => location.active === "כן").forEach(location => {
                const option = document.createElement('option');
                option.value = location.ID;
                option.textContent = `${location.name} - ${location.full_address}`;
                select.appendChild(option);
            });
        }

        function loadLocationsTable() {
            const tbody = document.getElementById('locationsTableBody');
            tbody.innerHTML = '';
            
            locations.forEach(location => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${location.name}</td>
                    <td>${location.full_address}</td>
                    <td>${location.contact_person}</td>
                    <td>${location.allowed_day}</td>
                    <td>${location.interval_weeks} שבועות</td>
                    <td>${location.active}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editLocation(${location.ID})">ערוך</button>
                        <button class="action-btn delete-btn" onclick="deleteLocation(${location.ID})">מחק</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

       function loadReceiptsTable() {
			const tbody = document.getElementById('receiptsTableBody');
			tbody.innerHTML = '';
			
			if (receipts.length === 0) {
				tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">אין קבלות</td></tr>';
				return;
			}
			
			receipts.forEach(receipt => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${receipt.book_number}</td>
					<td>${receipt.receipt_number}</td>
					<td>${formatDate(receipt.date)}</td>
					<td>${receipt.location_name}</td>
					<td>${receipt.amount}</td>
					<td>${receipt.payment_type}</td>
					<td>${receipt.codeX || ''}</td>
					<td>
						<button class="action-btn edit-btn" onclick="editReceipt(${receipt.ID})">ערוך</button>
						<button class="action-btn delete-btn" onclick="deleteReceipt(${receipt.ID})">מחק</button>
					</td>
				`;
				tbody.appendChild(row);
			});
		}

        // Visithandling
        function startVisitForlocation(locationId) {
            const location = locations.find(g => g.ID === locationId);
            if (location) {
                showSection('visit');
                document.getElementById('locationSelect').value = locationId;
            }
        }

        function handleVisitSubmit(event) {
			event.preventDefault();
			
			const formData = new FormData(event.target);
			const selectedLocationId = document.getElementById('locationSelect').value;
			const visitDate = document.getElementById('visitDate').value; // התאריך הנוכחי
			
			// בדיקות בסיסיות
			if (!selectedLocationId) {
				showError('אנא בחר לקוח');
				return;
			}
			
			// בדיקת כפילות
			const duplicateVisit = checkDuplicateVisit(selectedLocationId, visitDate);
			if (duplicateVisit) {
				const location = locations.find(loc => loc.ID == selectedLocationId);
				const locationName = location ? location.name : 'לקוח לא ידוע';
				
				const confirmMessage = `כבר קיים טיפול ללקוח "${locationName}" היום (${formatDate(visitDate)}).\n\nהאם להוסיף טיפול נוסף בכל זאת?`;
				
				if (!confirm(confirmMessage)) {
					return; // ביטול הוספה
				}
			}

			const visitData = {
				ID: Date.now(), // הוסף ID
				location_id: selectedLocationId,  
				visit_type: document.getElementById('visitType').value,
				work_done: document.getElementById('workDone').value,
				duration_minutes: parseFloat(document.getElementById('manualDurationMinutes').value) || 0,
				workers_count: parseInt(document.getElementById('numberOfWorkersVisit').value) || 1,		
				amount: document.getElementById('amount').value || 0,
				expense: document.getElementById('expense').value || 0,
				paid: document.getElementById('paid') ? document.getElementById('paid').value : 'לא', // הוסף אם קיים
				notes: document.getElementById('notes') ? document.getElementById('notes').value : '', // הוסף אם קיים
				date: visitDate,
				start_time: document.getElementById('visitTime').value,
				end_time: document.getElementById('visitTime').value
			};
			
			console.log('Visitdata:', visitData);
			
			// Here we would save to Google Sheets
			saveVisit(visitData);
		}

		// לשנות בפונקציה הקיימת - להוסיף שמירה לשיטס
		async function saveVisit(visitData) {
			try {
				// For now, just add to local array
				const newVisit= {
					ID: Date.now(),
					...visitData,
					paid: 'לא',
					notes: ''
				};
				
				// בדיקת תקינות
				const visitErrors = validateVisitData(visitData);
				if (showValidationErrors(visitErrors)) {
					return;
				}
				
				// בדיקת כפילויות ביקור
				const existingVisit = visits.find(visit => 
					visit.location_id === visitData.location_id &&
					visit.date === visitData.date &&
					Math.abs(new Date(`${visit.date} ${visit.start_time}`) - new Date(`${visitData.date} ${visitData.start_time}`)) < 60000 // פחות מדקה הפרש
				);

				if (existingVisit) {
					if (!confirm(`כבר קיים ביקור באותה כתובת באותו תאריך ושעה דומה.\n\nהאם להוסיף בכל זאת?`)) {
						return; // ביטול הוספה
					}
				}
				
				visits.push(newVisit);

				// תוספה - שמירה לגוגל שיטס
				if (access_token) {
					await saveVisitToSheets(newVisit);
				}

				// Update next visitdate if it's a full visit
				if (visitData.visit_type === 'מלא') {
				   updateNextVisitDate(visitData.location_id);
				}
		
				showSuccess('טיפול נשמר בהצלחה!');
				
				// Reset form
				document.getElementById('visitForm').reset();
			   		   
				// Reload planning data
				loadPlanningData();
				saveToLocalStorage();
				   
			} catch (error) {
				console.error('Error saving visit:', error);
				showError('שגיאה בשמירת הטיפול');
			}
		}

		function updateNextVisitDate(locationId) {
			const location = locations.find(g => g.ID == locationId);
			if (location) {
               const lastVisit= new Date();
               const intervalWeeks = parseInt(location.interval_weeks) + parseInt(location.temp_addition || 0);
               const nextVisit= new Date(lastVisit.getTime() + (intervalWeeks * 7 * 24 * 60 * 60 * 1000));
               
               location.last_visit= lastVisit.toISOString().split('T')[0];
               location.next_visit= nextVisit.toISOString().split('T')[0];
               location.temp_addition = 0; // Reset temporary addition
               
               // Here we would update Google Sheets
               console.log(`Updated next visitfor ${location.name}: ${location.next_visit}`);
			}
		}

		function postponeVisit(locationId) {
			const location = locations.find(g => g.ID == locationId);
			if (location) {
				const weeks = prompt('כמה שבועות לדחות?', '1');
				if (weeks && !isNaN(weeks)) {
					const currentNext = new Date(location.next_visit);
					const newNext = new Date(currentNext.getTime() + (parseInt(weeks) * 7 * 24 * 60 * 60 * 1000));
					location.next_visit= newNext.toISOString().split('T')[0];

					loadPlanningData();
					showSuccess(`טיפול נדחה ב-${weeks} שבועות`);
				}
			}
		}

       // location management
       function showAddLocationForm() {
           const modalHTML = `
               <div class="modal" id="locationModal">
                   <div class="modal-content">
                       <div class="modal-header">
                           <h3>הוספת גינה חדשה</h3>
                           <span class="close" onclick="closeModal('locationModal')">&times;</span>
                       </div>
                       <form id="locationForm" onsubmit="handleLocationSubmit(event)">
                           <div class="form-group">
                               <label for="locationName">שם גינה:</label>
                               <input type="text" id="locationName" required>
                           </div>
                           <div class="form-group">
                               <label for="locationAddress">כתובת מלאה:</label>
                               <input type="text" id="locationAddress" required>
                           </div>
                           <div class="form-group">
                               <label for="locationNeighborhood">שכונה:</label>
                               <input type="text" id="locationNeighborhood">
                           </div>
                           <div class="form-group">
                               <label for="locationCity">עיר:</label>
                               <input type="text" id="locationCity">
                           </div>
                           <div class="form-group">
                               <label for="locationContact">איש קשר:</label>
                               <input type="text" id="locationContact" required>
                           </div>
                           <div class="form-group">
                               <label for="locationPhone">טלפון:</label>
                               <input type="tel" id="locationPhone">
                           </div>
                           <div class="form-group">
                               <label for="locationDay">יום מותר:</label>
                               <select id="locationDay" required>
                                   <option value="">בחר יום...</option>
                                   <option value="א'">ראשון</option>
                                   <option value="ב'">שני</option>
                                   <option value="ג'">שלישי</option>
                                   <option value="ד'">רביעי</option>
                                   <option value="ה'">חמישי</option>
                                   <option value="ו'">שישי</option>
                                   <option value="שבת">שבת</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label for="locationInterval">מרווח שבועות:</label>
                               <input type="number" id="locationInterval" required min="1" max="52">
                           </div>
                           <div class="form-group">
                               <label for="locationAmount">סכום בסיסי:</label>
                               <input type="number" id="locationAmount">
                           </div>
                           <div class="form-group">
                               <label for="locationActive">פעילה:</label>
                               <select id="locationActive" required>
                                   <option value="כן">כן</option>
                                   <option value="לא">לא</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label for="locationNextVisit">תאריך לטיפול הבא:</label>
                               <input type="date" id="locationNextVisit" required>
                           </div>
                           <div class="form-group">
                               <label for="locationNotes">הערות:</label>
                               <textarea id="locationNotes"></textarea>
                           </div>
                           <button type="submit">שמור גינה</button>
                       </form>
                   </div>
               </div>
           `;
           
           document.getElementById('modalContainer').innerHTML = modalHTML;
           document.getElementById('locationModal').style.display = 'block';
           
           // Set default next visitdate to today
           document.getElementById('locationNextVisit').value = new Date().toISOString().split('T')[0];
       }

        async function handleLocationSubmit(event) {
            event.preventDefault();
           
			const locationData = {
				ID: generateID(),
				name: document.getElementById('locationName').value,
				full_address: document.getElementById('locationAddress').value,
				neighborhood: document.getElementById('locationNeighborhood').value,
				city: document.getElementById('locationCity').value,
				contact_person: document.getElementById('locationContact').value,
				phone: document.getElementById('locationPhone').value,
				allowed_day: document.getElementById('locationDay').value,
				interval_weeks: parseInt(document.getElementById('locationInterval').value),
				temp_addition: 0,
				base_amount: parseFloat(document.getElementById('locationAmount').value) || 0,
				active: document.getElementById('locationActive').value,
				notes: document.getElementById('locationNotes').value,
				last_visit: '',
				next_visit: document.getElementById('locationNextVisit').value
			};
           
		    // בדיקת כפילויות לפני הוספה
			const existingLocation = locations.find(loc => 
				loc.full_address && locationData.full_address &&
				loc.full_address.toLowerCase().trim() === locationData.full_address.toLowerCase().trim()
			);

			if (existingLocation) {
				if (!confirm(`לקוח עם כתובת "${locationData.full_address}" כבר קיים.\n\nהאם להוסיף בכל זאת?`)) {
					return; // ביטול הוספה
				}
			}
		   
            // שמירה לזיכרון מקומי
			locations.push(locationData);

			// שמירה אוטומטית לענן
			if (access_token && spreadsheet_id) {
				document.getElementById('statusText').textContent = '🔄 שומר לקוח...';
				try {
					await saveLocationToSheets(locationData);
					document.getElementById('statusText').textContent = 'מחובר';
					showSuccess('לקוח נשמר בהצלחה ל-Google Sheets!');
				} catch (error) {
					if (error.status === 401) {
						document.getElementById('statusText').textContent = '🔓 נדרש חיבור מחדש';
						document.getElementById('statusText').classList.remove('connected');
						showToast('⚠️ החיבור לגוגל פג - התחבר מחדש', 'warning');
						access_token = null;
					} else {
						document.getElementById('statusText').textContent = '⚠️ שגיאה בשמירה';
						showToast('⚠️ הלקוח נשמר מקומית בלבד', 'warning');
					}
				}
			} else {
				showToast('🔓 לקוח נשמר מקומית - התחבר לענן לשמירה', 'warning');
			}

			closeModal('locationModal');
			loadLocationsTable();
			loadLocationsForSelect();
			saveToLocalStorage();
        }

		function editLocation(locationId) {
			const location = locations.find(g => g.ID == locationId);
			if (!location) return;

			showAddLocationForm();

			// Populate form with existing data
			setTimeout(() => {
			    document.getElementById('locationName').value = location.name;
			    document.getElementById('locationAddress').value = location.full_address;
			    document.getElementById('locationNeighborhood').value = location.neighborhood || '';
			    document.getElementById('locationCity').value = location.city || '';
			    document.getElementById('locationContact').value = location.contact_person;
			    document.getElementById('locationPhone').value = location.phone || '';
			    document.getElementById('locationDay').value = location.allowed_day;
			    document.getElementById('locationInterval').value = location.interval_weeks;
			    document.getElementById('locationAmount').value = location.base_amount;
			    document.getElementById('locationActive').value = location.active;
			    document.getElementById('locationNextVisit').value = location.next_visit;
			    document.getElementById('locationNotes').value = location.notes || '';
			   
			    // Change form submission to update instead of add
			    document.getElementById('locationForm').onsubmit = function(event) {
				   event.preventDefault();
				   updatelocation(locationId);
			    };
			   
			   document.querySelector('.modal-header h3').textContent = 'עריכת גינה';
			}, 100);
		}
        
       function updatelocation(locationId) {
           const location = locations.find(g => g.ID == locationId);
           if (!location) return;
           
           location.name = document.getElementById('locationName').value;
           location.full_address = document.getElementById('locationAddress').value;
           location.neighborhood = document.getElementById('locationNeighborhood').value;
           location.city = document.getElementById('locationCity').value;
           location.contact_person = document.getElementById('locationContact').value;
           location.phone = document.getElementById('locationPhone').value;
           location.allowed_day = document.getElementById('locationDay').value;
           location.interval_weeks = parseInt(document.getElementById('locationInterval').value);
           location.base_amount = parseFloat(document.getElementById('locationAmount').value) || 0;
           location.active = document.getElementById('locationActive').value;
           location.next_visit= document.getElementById('locationNextVisit').value;
           location.notes = document.getElementById('locationNotes').value;
           
           closeModal('locationModal');
           loadLocationsTable();
           loadLocationsForSelect();
           loadPlanningData();
           showSuccess('גינה עודכנה בהצלחה!');
		   saveToLocalStorage();
       }

       function deleteLocation(locationId) {
           if (confirm('האם אתה בטוח שברצונך למחוק את הגינה?')) {
               locations = locations.filter(g => g.ID != locationId);
               loadLocationsTable();
               loadLocationsForSelect();
               loadPlanningData();
               showSuccess('גינה נמחקה בהצלחה!');
			   saveToLocalStorage();
           }
       }

       // Receipt management
       function showAddReceiptForm() {
           const modalHTML = `
               <div class="modal" id="receiptModal">
                   <div class="modal-content">
                       <div class="modal-header">
                           <h3>הוספת קבלה חדשה</h3>
                           <span class="close" onclick="closeModal('receiptModal')">&times;</span>
                       </div>
                       <form id="receiptForm" onsubmit="handleReceiptSubmit(event)">
                           <div class="form-group">
                               <label for="receiptBook">מספר פנקס:</label>
                               <input type="number" id="receiptBook" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptNumber">מספר קבלה:</label>
                               <input type="number" id="receiptNumber" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptDate">תאריך:</label>
                               <input type="date" id="receiptDate" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptlocations">גינה:</label>
                               <select id="receiptlocations" required>
                                   <option value="">בחר גינה...</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label for="receiptAmount">סכום:</label>
                               <input type="number" id="receiptAmount" required>
                           </div>
                           <div class="form-group">
                               <label for="receiptPaymentType">סוג תשלום:</label>
                               <select id="receiptPaymentType" required>
                                   <option value="">בחר סוג...</option>
                                   <option value="מזומן">מזומן</option>
                                   <option value="צ'ק">צ'ק</option>
                                   <option value="העברה">העברה בנקאית</option>
                                   <option value="ביט">ביט</option>
                                   <option value="פייבוקס">פייבוקס</option>
                               </select>
                           </div>
                           <div class="form-group">
                               <label for="receiptNotes">הערות:</label>
                               <textarea id="receiptNotes"></textarea>
                           </div>
                           <button type="submit">שמור קבלה</button>
                       </form>
                   </div>
               </div>
           `;
           
           document.getElementById('modalContainer').innerHTML = modalHTML;
           document.getElementById('receiptModal').style.display = 'block';
           
           // Set default date to today
           document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
           
           // Populate locations select
           const select = document.getElementById('receiptlocations');
           locations.forEach(location => {
               const option = document.createElement('option');
               option.value = location.ID;
               option.textContent = `${location.name} - ${location.full_address}`;
               select.appendChild(option);
           });
       }

       async function handleReceiptSubmit(event) {
           event.preventDefault();
           
           const locationId = document.getElementById('receiptlocation').value;
           const location = locations.find(g => g.ID == locationId);
           
           const receiptData = {
				ID: Date.now(),
				book_number: document.getElementById('receiptBook').value,
				receipt_number: document.getElementById('receiptNumber').value,
				date: document.getElementById('receiptDate').value,
				location_id: locationId,        
				location_name: location ? location.name : '',  // שונה מ-location_name
				amount: parseFloat(document.getElementById('receiptAmount').value),
				payment_type: document.getElementById('receiptPaymentType').value,
				notes: document.getElementById('receiptNotes').value
			};
           
		   // תוספה - בדיקת תקינות לפני שמירה
			const errors = validateReceiptData(receiptData);
			if (showValidationErrors(errors)) {
				return; // יש שגיאות - עצור כאן
			}
		   
		   // בדיקת כפילויות קבלה
			const existingReceipt = receipts.find(receipt => 
				(receipt.book_number === receiptData.book_number && receipt.receipt_number === receiptData.receipt_number) ||
				(receipt.location_id === receiptData.location_id && receipt.date === receiptData.date && receipt.amount === receiptData.amount)
			);

			if (existingReceipt) {
				if (!confirm(`כבר קיימת קבלה עם אותו מספר או באותה כתובת/תאריך/סכום.\n\nהאם להוסיף בכל זאת?`)) {
					return; // ביטול הוספה
				}
			}
		   
            receipts.push(receiptData);
		   
			if (access_token) {
				await saveReceiptToSheets(receiptData);
				showSuccess('קבלה נשמרה בהצלחה ל-Google Sheets!');
			} else {
				showSuccess('קבלה נשמרה מקומית!');
			}

			closeModal('receiptModal');
			loadReceiptsTable();
			saveToLocalStorage();
       }

       // Utility functions
       function closeModal(modalId) {
           document.getElementById(modalId).style.display = 'none';
       }

       function formatDate(dateString) {
           const date = new Date(dateString);
           return date.toLocaleDateString('he-IL');
       }

       function showLoading(message) {
           // Could implement loading spinner
           console.log('Loading:', message);
       }

       function hideLoading() {
           // Hide loading spinner
           console.log('Loading complete');
       }

       
       // Click outside modal to close
       window.onclick = function(event) {
           if (event.target.classList.contains('modal')) {
               event.target.style.display = 'none';
           }
       }
	   
	   function editReceipt(receiptId) {
			const receipt = receipts.find(r => r.ID == receiptId);
			if (!receipt) return;
			
			showAddReceiptForm();
			
			// Populate form with existing data
			setTimeout(() => {
				document.getElementById('receiptBook').value = receipt.book_number;
				document.getElementById('receiptNumber').value = receipt.receipt_number;
				document.getElementById('receiptDate').value = receipt.date;
				document.getElementById('receiptLocation').value = receipt.location_id;
				document.getElementById('receiptAmount').value = receipt.amount;
				document.getElementById('receiptPaymentType').value = receipt.payment_type;
				document.getElementById('receiptNotes').value = receipt.notes || '';
				
				// Change form submission to update instead of add
				document.getElementById('receiptForm').onsubmit = function(event) {
					event.preventDefault();
					updateReceipt(receiptId);
				};
				
				document.querySelector('.modal-header h3').textContent = 'עריכת קבלה';
			}, 100);
		}

		function updateReceipt(receiptId) {
			const receipt = receipts.find(r => r.ID == receiptId);
			if (!receipt) return;
			
			const locationId = document.getElementById('receiptLocation').value;
			const location = locations.find(g => g.ID == locationId);
			
			receipt.book_number = document.getElementById('receiptBook').value;
			receipt.receipt_number = document.getElementById('receiptNumber').value;
			receipt.date = document.getElementById('receiptDate').value;
			receipt.location_id = locationId;
			receipt.location_name = location ? location.name : '';
			receipt.amount = parseFloat(document.getElementById('receiptAmount').value);
			receipt.payment_type = document.getElementById('receiptPaymentType').value;
			receipt.notes = document.getElementById('receiptNotes').value;
			
			closeModal('receiptModal');
			loadReceiptsTable();
			saveToLocalStorage();
			showSuccess('קבלה עודכנה בהצלחה!');
		}

		function deleteReceipt(receiptId) {
			if (confirm('האם אתה בטוח שברצונך למחוק את הקבלה?')) {
				receipts = receipts.filter(r => r.ID != receiptId);
				loadReceiptsTable();
				saveToLocalStorage();
				showSuccess('קבלה נמחקה בהצלחה!');
			}
		}
	   
	   // תוספה - הודעות Toast מתקדמות
		function showToast(message, type = 'info', duration = 3000) {
			const toastContainer = document.getElementById('toastContainer');
			
			if (!toastContainer) {
				console.error('Toast container not found');
				return;
			}
			
			const toast = document.createElement('div');
			toast.className = `toast ${type}`;
			toast.textContent = message;
			
			toastContainer.appendChild(toast);
			
			// Trigger animation
			setTimeout(() => {
				toast.classList.add('show');
			}, 100);
			
			// Remove toast after specified duration
			setTimeout(() => {
				toast.classList.remove('show');
				setTimeout(() => {
					if (toast.parentNode) {
						toast.parentNode.removeChild(toast);
					}
				}, 300);
			}, duration);
		}
	   
	   // פונקציות עזר להודעות
		function showSuccess(message, duration = 3000) {
			showToast(message, 'success', duration);
		}

		function showError(message, duration = 4000) {
			showToast(message, 'error', duration);
		}

		function showWarning(message, duration = 3500) {
			showToast(message, 'warning', duration);
		}

		function showInfo(message, duration = 3000) {
			showToast(message, 'info', duration);
		}
	   
	   
	    // יצירת טבלת עזר לייבוא
		async function clearAllDataBeforeImport() {
			if (confirm('האם אתה בטוח שברצונך למחוק את כל הנתונים הקיימים לפני הייבוא החדש?\n\nפעולה זו תמחק:\n- את כל המיקומים\n- את כל הביקורים\n- את כל הקבלות\n\nהנתונים בגוגל שיטס לא יימחקו.')) {
				locations = [];
				visits = [];
				receipts = [];
				saveToLocalStorage();
				
				// עדכון רק הפונקציות שקיימות
				loadLocationsTable();
				loadReceiptsTable(); 
				loadFilterOptions();
				
				showToast('כל הנתונים נוקו בהצלחה', 'success');
				return true;
			}
			return false;
		}

		// שיפור לפונקציה הקיימת
		async function createImportTable() {
			if (!await validateToken()) {
				showToast('התחבר לגוגל קודם', 'warning');
				return;
			}
			
			try {
				showLoading('יוצר טבלת עזר לייבוא...');
				
				const response = await gapi.client.sheets.spreadsheets.create({
					resource: {
						properties: {
							title: `ייבוא_נתונים_${new Date().toISOString().split('T')[0]}`
						},
						sheets: [{
							properties: { title: 'Locations' },
						}, {
							properties: { title: 'Visits' },
						}, {
							properties: { title: 'Receipts' }
						}, {
							properties: { title: 'SystemSettings' }
						}]
					}
				});
				
				const newSpreadsheetId = response.result.spreadsheetId;
				
				// הוספת כותרות לכל גליון
				await addImportHeaders(newSpreadsheetId);
				
				// פתיחת הטבלה
				window.open(`https://docs.google.com/spreadsheets/d/${newSpreadsheetId}/edit`, '_blank');
				
				// שמירת ID לייבוא מאוחר יותר
				localStorage.setItem('importTableId', newSpreadsheetId);
				
				showToast('טבלת עזר נוצרה! מלא את הנתונים ואז חזור לייבא', 'success');
				
			} catch (error) {
				console.error('Error creating import table:', error);
				showToast('שגיאה ביצירת טבלת עזר', 'error');
			} finally {
				hideLoading();
			}
		}

		// הוספת כותרות לטבלת עזר
		async function addImportHeaders(spreadsheetId) {
			if (!await validateToken()) {
				showToast('בעיה בחיבור לגוגל במהלך הוספת כותרות', 'error');
				return;
			}

			try {
				// כל הכותרות באנגלית
				const locationHeaders = [['customer_name', 'street', 'house_number', 'city', 'frequency', 'contact_person', 'base_amount']];
				const visitHeaders = [['year', 'month', 'day', 'customer', 'contact_person', 'treatment', 'date', 'work_done', 'duration', 'amount', 'paid', 'expense', 'notes']];
				const receiptHeaders = [['code_x', 'booklet', 'receipt', 'year', 'month', 'day', 'address', 'amount', 'type', 'notes', 'details']];
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				await Promise.all([
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Locations!A1:G1',
						valueInputOption: 'RAW',
						resource: { values: locationHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Visits!A1:M1',
						valueInputOption: 'RAW', 
						resource: { values: visitHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'Receipts!A1:K1',
						valueInputOption: 'RAW',
						resource: { values: receiptHeaders }
					}),
					gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: spreadsheetId,
						range: 'SystemSettings!A1:B1',
						valueInputOption: 'RAW',
						resource: { values: [['Setting', 'Value']] }
					})
				]);			
				
				console.log('Headers added successfully to import table');
				
			} catch (error) {
				console.error('Error adding headers:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('⚠️ החיבור פג במהלך הוספת כותרות', 'warning');
				} else {
					showToast('⚠️ שגיאה בהוספת כותרות לטבלה', 'error');
				}
				throw error;
			}
		}
		
		
		// תוספה - פיענוח כתובת מלאה לחלקים
		function parseFullAddress(fullAddress) {
			if (!fullAddress) return { street: '', houseNumber: '', city: '' };
			
			const parts = fullAddress.trim().split(' ');
			
			if (parts.length >= 3) {
				// העיר היא החלק האחרון
				const city = parts[parts.length - 1];
				
				// מספר הבית הוא החלק הלפני אחרון
				const houseNumber = parts[parts.length - 2];
				
				// הרחוב הוא כל השאר
				const street = parts.slice(0, -2).join(' ');
				
				return { street, houseNumber, city };
			} else if (parts.length === 2) {
				return { street: parts[0], houseNumber: '', city: parts[1] };
			} else {
				return { street: fullAddress, houseNumber: '', city: '' };
			}
		}
	   
	   // תוספה - ייבוא לקוחות מטבלת עזר
		async function importCustomersFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('טבלת עזר לא נמצאה - צור קודם', 'warning');
					return;
				}
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: importTableId,
					range: 'Locations!A2:G1000' // עד G במקום H
				});
				
				const rows = response.result.values || [];
				let importedCount = 0;
				let newLocations = []; // מערך לאיסוף כל הלקוחות החדשים
				
				for (const row of rows) {
					if (row.length > 0 && row[0]) { // יש שם לקוח
						// מיפוי לפי הכותרות החדשות באנגלית:
						const customerName = row[0].trim();  // customer_name
						const street = row[1] || '';         // street  
						const houseNumber = row[2] || '';    // house_number
						const city = row[3] || '';           // city
						const frequency = row[4] || '';      // frequency
						const contactPerson = row[5] || '';  // contact_person
						const baseAmount = row[6] || '';     // base_amount
						
						// בניית כתובת מלאה
						const fullAddress = `${street} ${houseNumber} ${city}`.trim();
						
						// בדוק אם לקוח כבר קיים (לפי כתובת מלאה)
						const existingCustomer = locations.find(loc => 
							loc.full_address && 
							loc.full_address.toLowerCase() === fullAddress.toLowerCase()
						);
						
						if (existingCustomer) {
							console.log(`לקוח ${fullAddress} כבר קיים - דולג`);
							continue;
						}
						
						const locationData = {
							ID: generateID(),
							name: customerName,           // שם הלקוח (עכשיו נפרד מהכתובת)
							full_address: fullAddress,   // כתובת מלאה מורכבת
							neighborhood: '',
							city: city,
							contact_person: contactPerson,
							phone: '',
							allowed_day: 'כל יום',
							interval_weeks: parseInt(frequency) || 4,
							temp_addition: 0,
							base_amount: parseFloat(baseAmount) || 0,
							active: 'כן',
							notes: 'יובא מטבלת לקוחות',
							last_visit: '',
							next_visit: ''
						};
						
						locations.push(locationData);
						newLocations.push(locationData); // הוסף למערך החדש
						importedCount++;
					}
				}
				
				// שמירה מקבצית אחת בסוף:
				if (newLocations.length > 0) {
					showToast(`שומר ${newLocations.length} לקוחות בבת אחת...`, 'info', 2000);
					const success = await saveLocationsBatch(newLocations);
					
					if (success) {
						showToast(`✅ יובאו ${importedCount} לקוחות במהירות!`, 'success');
					} else {
						showToast('⚠️ בעיה בשמירה לענן - נשמר מקומית בלבד', 'warning');
					}
				} else {
					showToast('לא נמצאו לקוחות חדשים לייבוא', 'info');
				}
				
				// עדכון תצוגות
				saveToLocalStorage();
				loadLocationsTable();
				loadLocationsForSelect();
				
			} catch (error) {
				console.error('Error importing customers:', error);
				showToast('שגיאה בייבוא לקוחות', 'error');
			}
		}
	   
	   // תוספה - ייבוא טיפולים מטבלת עזר
		async function importVisitsFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('טבלת עזר לא נמצאה - צור קודם', 'warning');
					return;
				}
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: importTableId,
					range: 'Visits!A2:M1000'
				});
				
				const rows = response.result.values || [];
				let importedCount = 0;
				let notFoundCustomers = [];
				let newVisits = []; // מערך לאיסוף כל הביקורים החדשים
				
				for (const row of rows) {
					if (row.length > 3 && row[3]) { // יש לקוח בעמודה 3 (customer)
						// מיפוי לפי הכותרות החדשות באנגלית:
						const year = row[0];                    // year
						const month = row[1];                   // month
						const day = row[2];                     // day
						const customerName = row[3].trim();     // customer
						const contactPerson = row[4] || '';     // contact_person
						const treatment = row[5] || 'מלא';      // treatment
						const dateField = row[6];               // date (לא נשתמש - נבנה מהעמודות הראשונות)
						const workDone = row[7] || '';          // work_done
						const duration = row[8] || 0;           // duration
						const amount = row[9] || 0;             // amount
						const paid = row[10] || 'לא';           // paid
						const expense = row[11] || 0;           // expense
						const notes = row[12] || '';            // notes
						
						// מצא לקוח קיים לפי כתובת מלאה
						const existingCustomer = locations.find(loc => 
							loc.full_address && 
							loc.full_address.toLowerCase().includes(customerName.toLowerCase())
						);
						
						if (!existingCustomer) {
							if (!notFoundCustomers.includes(customerName)) {
								notFoundCustomers.push(customerName);
							}
							continue;
						}
						
						// בניית תאריך נכון מ-3 עמודות
						const visitDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
						
						const visitData = {
							ID: generateID(),
							date: visitDate,
							location_id: existingCustomer.ID,
							location_name: existingCustomer.name,
							visit_type: treatment,
							work_done: workDone,
							duration_minutes: parseFloat(duration) * 60 || 0, // שעות → דקות
							start_time: '',
							end_time: '',
							amount: parseFloat(amount) || 0,
							expense: parseFloat(expense) || 0,
							paid: paid === 'כן' ? 'כן' : 'לא',
							notes: notes
						};
						
						visits.push(visitData);
						newVisits.push(visitData); // הוסף למערך החדש
						importedCount++;
					}
				}
				
				// שמירה מקבצית אחת בסוף:
				if (newVisits.length > 0) {
					showToast(`שומר ${newVisits.length} ביקורים בבת אחת...`, 'info', 2000);
					const success = await saveVisitsBatch(newVisits);
					
					if (success) {
						showToast(`✅ יובאו ${importedCount} ביקורים במהירות!`, 'success');
					} else {
						showToast('⚠️ בעיה בשמירה לענן - נשמר מקומית בלבד', 'warning');
					}
				} else {
					showToast('לא נמצאו ביקורים חדשים לייבוא', 'info');
				}
				
				// עדכון תצוגות
				saveToLocalStorage();
				loadPlanningData();
				
				// הודעה על לקוחות שלא נמצאו
				let message = `יובאו ${importedCount} ביקורים בהצלחה!`;
				if (notFoundCustomers.length > 0) {
					message += `\n⚠️ ${notFoundCustomers.length} לקוחות לא נמצאו: ${notFoundCustomers.slice(0, 3).join(', ')}${notFoundCustomers.length > 3 ? '...' : ''}`;
					showToast(message, 'warning', 5000);
				}
				
			} catch (error) {
				console.error('Error importing visits:', error);
				showToast('שגיאה בייבוא ביקורים', 'error');
			}
		}
	   
	   
	   // תוספה - ייבוא קבלות מטבלת עזר
		async function importReceiptsFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('טבלת עזר לא נמצאה - צור קודם', 'warning');
					return;
				}
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: importTableId,
					range: 'Receipts!A2:K1000'
				});
				
				const rows = response.result.values || [];
				let importedCount = 0;
				let notFoundCustomers = [];
				
				for (const row of rows) {
					if (row.length > 6 && row[6]) { // יש כתובת בעמודה 6 (G)
						const customerAddress = row[6].trim(); // עמודה "כתובת"
						
						// מצא לקוח קיים לפי כתובת מלאה
						const existingCustomer = locations.find(loc => 
							loc.full_address && 
							loc.full_address.toLowerCase().includes(customerAddress.toLowerCase())
						);
						
						if (!existingCustomer) {
							if (!notFoundCustomers.includes(customerAddress)) {
								notFoundCustomers.push(customerAddress);
							}
							continue;
						}
						
						// בניית תאריך מ-3 עמודות
						const year = row[3];   // שנה - עמודה D
						const month = String(row[4]).padStart(2, '0');  // חודש - עמודה E
						const day = String(row[5]).padStart(2, '0');    // יום - עמודה F
						const receiptDate = `${year}-${month}-${day}`;
						
						const receiptData = {
							ID: generateID(),
							book_number: row[1] || '',      // פנקס - עמודה B
							receipt_number: row[2] || '',   // קבלה - עמודה C
							date: receiptDate,              // תאריך נכון
							location_id: existingCustomer.ID,
							location_name: customerAddress,
							amount: parseFloat(row[7]) || 0, // סכום - עמודה H
							payment_type: row[8] || '',     // סוג - עמודה I
							codeX: row[0] || '',           // XK - עמודה A
							notes: `${row[9] || ''} ${row[10] || ''}`.trim() // הערות + פירוט
						};
						
						receipts.push(receiptData);
						importedCount++;
					}
				}
				
				// שמירה
				await saveAllToSheets();
				loadReceiptsTable();
				
				let message = `יובאו ${importedCount} קבלות בהצלחה!`;
				if (notFoundCustomers.length > 0) {
					message += `\n⚠️ ${notFoundCustomers.length} לקוחות לא נמצאו: ${notFoundCustomers.slice(0, 3).join(', ')}${notFoundCustomers.length > 3 ? '...' : ''}`;
				}
				
				showToast(message, 'success');
				
			} catch (error) {
				console.error('Error importing receipts:', error);
				showToast('שגיאה בייבוא קבלות', 'error');
			}
		}
	   
	   // תוספה - המרת פורמט תאריך מ-DD/MM/YYYY ל-YYYY-MM-DD
		function convertDateFormat(dateStr) {
			if (!dateStr) return '';
			
			const parts = dateStr.split('/');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = parts[1].padStart(2, '0');
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			
			return dateStr;
		}
	   
	   
	   // תוספה - ייבוא מלא מטבלת העזר
		async function importFromHelper() {
			try {
				const importTableId = localStorage.getItem('importTableId');
				if (!importTableId) {
					showToast('טבלת עזר לא נמצאה - צור קודם', 'warning');
					return;
				}
				
				showToast('מתחיל ייבוא מלא...', 'info');
				
				// ייבוא בסדר: לקוחות → טיפולים → קבלות
				await importCustomersFromHelper();
				await new Promise(resolve => setTimeout(resolve, 1000)); // המתנה קצרה
				
				await importVisitsFromHelper();
				await new Promise(resolve => setTimeout(resolve, 1000)); // המתנה קצרה
				
				await importReceiptsFromHelper();
				
				showToast('🎉 ייבוא מלא הושלם בהצלחה!', 'success', 5000);
				
				setTimeout(() => {
					if (confirm('ייבוא הושלם בהצלחה!\n\nהאם למחוק את טבלת העזר מה-Google Drive?')) {
						showToast('💡 ניתן למחוק את טבלת העזר ידנית בגוגל דרייב', 'info');
						localStorage.removeItem('importTableId');
					}
				}, 2000);
				
			} catch (error) {
				console.error('Error in full import:', error);
				showToast('שגיאה בייבוא מלא', 'error');
			}
		}
	   
	   // תוספה - בדיקת תקינות נתונים
		function validateReceiptData(receiptData) {
			const errors = [];
			
			if (!receiptData.location_id) {
				errors.push('חובה לבחור לקוח');
			}
			
			if (!receiptData.amount || receiptData.amount <= 0) {
				errors.push('חובה להזין סכום חיובי');
			}
			
			if (!receiptData.date) {
				errors.push('חובה להזין תאריך');
			}
			
			return errors;
		}

		function showValidationErrors(errors) {
			if (errors.length > 0) {
				showToast(errors.join('\n'), 'error');
				return true; // יש שגיאות
			}
			return false; // אין שגיאות
		}
	   
	   
	    // תוספה - ניהול פאנלי סינון ומידע
		function toggleFilterPanel() {
			const content = document.getElementById('filterContent');
			const icon = document.getElementById('filterIcon');
			
			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				icon.textContent = '🔽';
			} else {
				content.classList.add('collapsed');
				icon.textContent = '🔼';
			}
		}

		function toggleInfoPanel() {
			const content = document.getElementById('infoContent');
			const icon = document.getElementById('infoIcon');
			
			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				icon.textContent = '🔽';
			} else {
				content.classList.add('collapsed');
				icon.textContent = '🔼';
			}
		}

		// תוספה - טעינת אפשרויות סינון
		function loadFilterOptions() {
			const locationSelect = document.getElementById('filterLocation');
			locationSelect.innerHTML = '<option value="">כל הלקוחות</option>';
			
			locations.forEach(location => {
				const option = document.createElement('option');
				option.value = location.ID;
				option.textContent = location.name;
				locationSelect.appendChild(option);
			});
		}
	   
		// תוספה - סינון וטעינת טיפולים
		function applyVisitFilters() {
			const locationFilter = document.getElementById('filterLocation').value;
			const paymentFilter = document.getElementById('filterPayment').value;
			const dateFromFilter = document.getElementById('filterDateFrom').value;
			const dateToFilter = document.getElementById('filterDateTo').value;
			
			let filteredVisits = visits.filter(visit => {
				// סינון לפי לקוח
				if (locationFilter && visit.location_id != locationFilter) {
					return false;
				}
				
				// סינון לפי סטטוס תשלום
				if (paymentFilter && visit.paid !== paymentFilter) {
					return false;
				}
				
				// סינון לפי תאריך
				if (dateFromFilter && visit.date < dateFromFilter) {
					return false;
				}
				
				if (dateToFilter && visit.date > dateToFilter) {
					return false;
				}
				
				return true;
			});
			
			displayFilteredVisits(filteredVisits);
			updateVisitsInfo(filteredVisits);
		}

		function clearVisitFilters() {
			document.getElementById('filterLocation').value = '';
			document.getElementById('filterPayment').value = '';
			document.getElementById('filterDateFrom').value = '';
			document.getElementById('filterDateTo').value = '';
			
			displayFilteredVisits(visits);
			updateVisitsInfo(visits);
		}

		// תוספה - הצגת טיפולים מסוננים
		function displayFilteredVisits(filteredVisits) {
			const tbody = document.getElementById('visitsHistoryTableBody');
			tbody.innerHTML = '';
			
			if (filteredVisits.length === 0) {
				tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">אין טיפולים תואמים לסינון</td></tr>';
				return;
			}
			
			// מיון לפי תאריך (החדשים ראשונים)
			filteredVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
			
			filteredVisits.forEach(visit => {
				const location = locations.find(loc => loc.ID == visit.location_id);
				const locationName = location ? location.name : `לא נמצא (ID: ${visit.location_id})`;
				//////////console.log(`Visit location_id: ${visit.location_id}, Found location:`, location);   //////>>>>>>>>>>>>>
				
				const row = document.createElement('tr');
				
				// הדגשת שורות לפי סטטוס תשלום
				if (visit.paid === 'לא') {
					row.style.backgroundColor = '#fff2cc'; // צהוב עדין לחובות
				} else if (visit.paid === 'כן') {
					row.style.backgroundColor = '#d4edda'; // ירוק עדין לשולם
				}
				
				row.innerHTML = `
					<td>${formatDate(visit.date)}</td>
					<td>${locationName}</td>
					<td>${visit.visit_type}</td>
					<td>${visit.work_done}</td>
					<td>${(visit.duration_minutes / 60).toFixed(2)}</td>
					<td>
						<div style="display: flex; flex-direction: column; align-items: center;">
							<span style="font-weight: bold; color: #27ae60;">₪${visit.amount}</span>
							${getVisitCostBreakdown(visit)}
						</div>
					</td>
					<td>
						<span class="payment-status payment-${visit.paid}">
							${visit.paid === 'כן' ? '✅ שולם' : visit.paid === 'לא' ? '❌ לא שולם' : '⚪ ללא'}
						</span>
					</td>
					<td>
						<button class="action-btn edit-btn" onclick="editVisit(${visit.ID})">ערוך</button>
						<button class="action-btn delete-btn" onclick="deleteVisit(${visit.ID})">מחק</button>
					</td>
				`;
				tbody.appendChild(row);
			});
		}

		// הוסף פונקציה חדשה להצגת פירוט עלויות:
		function getVisitCostBreakdown(visit) {
			if (!visit.duration_minutes) return '<span style="font-size: 11px; color: #999;">ללא פירוט</span>';
			
			const hours = (visit.duration_minutes / 60).toFixed(2);
			const workers = visit.num_workers || 1;
			const expense = visit.expense || 0;
			
			let breakdown = `${hours}ש`;
			if (workers > 1) breakdown += ` × ${workers}ע`;
			if (expense > 0) breakdown += ` + ₪${expense}`;
			
			return `<span style="font-size: 11px; color: #666;">${breakdown}</span>`;
		}

		// תוספה - עדכון פאנל המידע
		function updateVisitsInfo(filteredVisits) {
			const visitsCount = filteredVisits.length;
			const totalHours = filteredVisits.reduce((sum, visit) => sum + (visit.duration_minutes / 60), 0);
			const totalIncome = filteredVisits.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			const outstandingDebt = filteredVisits
				.filter(visit => visit.paid === 'לא')
				.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			document.getElementById('visitsCount').textContent = visitsCount;
			document.getElementById('totalHours').textContent = totalHours.toFixed(2);
			document.getElementById('totalIncome').textContent = `₪${totalIncome.toLocaleString()}`;
			document.getElementById('outstandingDebt').textContent = `₪${outstandingDebt.toLocaleString()}`;
			
			// הדגשת חובות פתוחים
			const debtElement = document.getElementById('outstandingDebt');
			if (outstandingDebt > 0) {
				debtElement.style.color = '#e74c3c';
				debtElement.style.fontWeight = 'bold';
			} else {
				debtElement.style.color = '#27ae60';
				debtElement.style.fontWeight = 'bold';
			}
			
			// חישוב נתונים מפורטים יותר על חובות
			const unpaidVisits = filteredVisits.filter(visit => visit.paid === 'לא');
			const uniqueDebtors = new Set(unpaidVisits.map(visit => visit.location_id)).size;
			
			// הצגת מידע נוסף בכרטיסי הסיכום
			if (outstandingDebt > 0) {
				const avgDebtPerClient = uniqueDebtors > 0 ? Math.round(outstandingDebt / uniqueDebtors) : 0;
				document.getElementById('outstandingDebt').title = 
					`${uniqueDebtors} לקוחות חייבים | ממוצע ₪${avgDebtPerClient} ללקוח`;
			}
	
		}



		// תוספה - טעינה ראשונית של הטאב
		function loadVisitsHistory() {
			loadFilterOptions();
			displayFilteredVisits(visits);
			updateVisitsInfo(visits);
		}

		// תוספה - פונקציות עריכה ומחיקה
		function editVisit(visitId) {
			// כאן תוכל להוסיף מודל עריכה
			showToast('עריכת טיפול - יתווסף בהמשך', 'info');
		}

		function deleteVisit(visitId) {
			if (confirm('האם אתה בטוח שברצונך למחוק את הטיפול?')) {
				visits = visits.filter(visit => visit.ID != visitId);
				applyVisitFilters(); // רענן תצוגה
				saveToLocalStorage();
				showToast('טיפול נמחק בהצלחה!', 'success');
			}
		}
	   
	   // תוספה - בדיקת רשאות
		async function checkPermissions() {
			if (!access_token) {
				showToast('לא מחובר לגוגל - התחבר קודם', 'warning');
				return false;
			}
			
			try {
				// נסה לגשת לטבלה הראשית
				await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				return true;
			} catch (error) {
				if (error.status === 401) {
					showToast('החיבור פג - התחבר מחדש', 'warning');
					access_token = null;
				} else if (error.status === 403) {
					showToast('אין הרשאה לטבלה - בדוק שיתוף', 'error');
				}
				return false;
			}
		}
	   
	   // תוספה - בדיקת תקינות אסימון
		async function validateToken() {
			if (!access_token || !gapi.client) {
				return false;
			}
			
			try {
				// בדיקה פשוטה - נסה לקרוא מהטבלה
				await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID || 'test'
				});
				return true;
			} catch (error) {
				if (error.status === 401) {
					console.log('Google token expired');
					access_token = null;
					document.getElementById('statusText').textContent = '🔓 נדרש חיבור מחדש';
					document.getElementById('statusText').classList.remove('connected');
					showToast('⚠️ החיבור לגוגל פג - התחבר מחדש', 'warning');
					return false;
				}
				return false;
			}
		}
	   
	   // תוספה - בדיקה תקופתית של חיבור
		setInterval(async () => {
			if (access_token) {
				const isValid = await validateToken();
				if (!isValid) {
					console.log('Token expired - disconnected');
				}
			}
		}, 300000); // בדיקה כל 5 דקות
	   
	   // תוספה - חישוב שעות מדקות
		function updateHoursDisplay() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const hours = (minutes / 60).toFixed(2);
			document.getElementById('calculatedHours').value = hours > 0 ? hours : '';
		}
	   
	    // חישוב עלות טיפול מעודכן
		function calculateTreatmentCost() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const workers = parseInt(document.getElementById('numberOfWorkersVisit').value) || 1;
			const expense = parseFloat(document.getElementById('expense').value) || 0;
			
			if (minutes > 0) {
				const hours = minutes / 60;
				const baseCost = costSettings.hourlyRate * hours;
				// תיקון: עלות עובדים נוספים (לא כולל אותך)
				const workersCost = (workers - 1) * costSettings.workerCost * hours;
				const laborCost = baseCost + workersCost;
				const totalCost = laborCost + expense;
				
				// עדכן את שדה הסכום
				document.getElementById('amount').value = Math.round(totalCost);
				
				// הצג פירוט מפורט יותר
				let breakdown = `${hours.toFixed(2)} שעות × ₪${costSettings.hourlyRate} = ₪${Math.round(baseCost)}`;
				
				if (workers > 1) {
					breakdown += `\n+ ${workers - 1} עובדים × ₪${costSettings.workerCost}/שעה = ₪${Math.round(workersCost)}`;
				}
				
				if (expense > 0) {
					breakdown += `\n+ הוצאות: ₪${expense}`;
				}
				
				breakdown += `\n= סה"כ: ₪${Math.round(totalCost)}`;
				
				document.getElementById('costBreakdown').textContent = breakdown;
				document.getElementById('costBreakdown').style.whiteSpace = 'pre-line';
			} else {
				document.getElementById('costBreakdown').textContent = '';
			}
		}

		// הוסף חישוב אוטומטי כשמקלידים משך זמן
		function updateHoursDisplay() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const hours = minutes > 0 ? (minutes / 60).toFixed(2) : '';
			document.getElementById('calculatedHours').value = hours;
			
			// חשב עלויות אוטומטית
			calculateTreatmentCost();
		}

		// שמירת הגדרות עלות פשוטה יותר
		function saveCostSettings() {
			costSettings.hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 150;
			costSettings.workerCost = parseFloat(document.getElementById('workerCost').value) || 50;
			
			localStorage.setItem('cost_settings', JSON.stringify(costSettings));
			
			if (access_token) {
				saveSettingsToCloud().then(success => {
					if (success) {
						showToast('הגדרות עלות נשמרו בענן', 'success');
					} else {
						showToast('הגדרות נשמרו מקומית בלבד', 'warning');
					}
				});
			} else {
				showToast('הגדרות נשמרו מקומית', 'success');
			}
		}
	   
	   // תוספה - בדיקת טיפול כפול
		function checkDuplicateVisit(locationId, visitDate) {
			const existingVisit = visits.find(visit => 
				visit.location_id == locationId && 
				visit.date === visitDate
			);
			
			return existingVisit;
		}
	   
	   // תוספה - אתחול תאריך ושעה נוכחיים
		function initializeVisitForm() {
			const now = new Date();
			document.getElementById('visitDate').value = now.toISOString().split('T')[0];
			document.getElementById('visitTime').value = now.toTimeString().split(':').slice(0,2).join(':');
		}

		// קריאה לאתחול כשהדף נטען
		document.addEventListener('DOMContentLoaded', function() {
			initializeVisitForm();
		});
	   
	   // פונקציה לשמירת הגדרות לענן
		async function saveSettingsToCloud() {
			if (!await validateToken()) {
				return false;
			}
			
			try {
				const settingsData = [
					['Setting', 'Value'],
					['hourly_rate', costSettings.hourlyRate],
					['worker_cost', costSettings.workerCost],
					['last_updated', new Date().toISOString()]
				];
				
				await gapi.client.sheets.spreadsheets.values.clear({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A:B`
				});
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A1:B4`,
					valueInputOption: 'RAW',
					resource: { values: settingsData }
				});
				
				return true;
			} catch (error) {
				console.error('Error saving settings:', error);
				return false;
			}
		}

		// פונקציה לטעינת הגדרות מהענן
		async function loadSettingsFromCloud() {
			if (!await validateToken()) {
				return false;
			}
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A:B`
				});
				
				const rows = response.result.values || [];
				if (rows.length > 1) {
					rows.slice(1).forEach(row => {
						const [setting, value] = row;
						if (setting === 'hourly_rate') {
							costSettings.hourlyRate = parseFloat(value) || 150;
						}
						if (setting === 'worker_cost') {
							costSettings.workerCost = parseFloat(value) || 50;
						}
					});
					
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
					
					return true;
				}
			} catch (error) {
				console.error('Error loading settings:', error);
				return false;
			}
			
			return false;
		}
	   
	   async function findOrCreateMainSpreadsheet() {
			try {
				console.log('Starting findOrCreateMainSpreadsheet...');
				
				// קודם נסה להשתמש ב-ID הקיים
				if (SPREADSHEET_ID && SPREADSHEET_ID !== '') {
					try {
						console.log('Testing existing spreadsheet ID:', SPREADSHEET_ID);
						
						const testResponse = await gapi.client.sheets.spreadsheets.get({
							spreadsheetId: SPREADSHEET_ID
						});
						
						console.log('✅ Found existing spreadsheet by ID:', SPREADSHEET_ID);
						showToast('טבלה קיימת נמצאה!', 'success');
						return; // יציאה - הטבלה קיימת ועובדת
						
					} catch (error) {
						console.log('❌ Cannot access spreadsheet with ID:', SPREADSHEET_ID, error);
						showToast('לא ניתן לגשת לטבלה הקיימת, מחפש חלופות...', 'warning');
					}
				}
				
				// אם הגענו לכאן - ה-ID לא עובד, חפש לפי שם
				console.log('Searching for spreadsheet by name...');
				
				const response = await gapi.client.request({
					path: 'https://www.googleapis.com/drive/v3/files',
					params: {
						q: `name='${SPREADSHEET_NAME}' and mimeType='application/vnd.google-apps.spreadsheet'`,
						access_token: access_token
					}
				});
				
				console.log('Search response:', response.result.files);
				
				if (response.result.files.length > 0) {
					console.log('Found existing spreadsheet by name');
					SPREADSHEET_ID = response.result.files[0].id; // עדכן את ה-ID החדש
					showToast('נמצאה טבלה לפי שם!', 'success');
				} else {
					console.log('No spreadsheet found, creating new one...');
					await createNewMainSpreadsheet();
				}
				
			} catch (error) {
				console.error('Error in findOrCreateMainSpreadsheet:', error);
				showToast('שגיאה בחיפוש טבלה', 'error');
			}
		}

		async function createNewMainSpreadsheet() {
			console.log('Creating new main spreadsheet...');
			try {
				const response = await gapi.client.request({
					path: 'https://sheets.googleapis.com/v4/spreadsheets',
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${access_token}`,
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						properties: {
							title: SPREADSHEET_NAME
						},
						sheets: [
							{ properties: { title: 'Locations' } },
							{ properties: { title: 'Visits' } },
							{ properties: { title: 'Receipts' } },
							{ properties: { title: 'SystemSettings' } }
						]
					})
				});
				
				SPREADSHEET_ID = response.result.spreadsheetId;
				
				// הוסף כותרות לכל הגליונות
				await addAllHeaders();
				
				showToast('נוצרה טבלה חדשה!', 'success');
				
			} catch (error) {
				console.error('Error creating spreadsheet:', error);
				showToast('שגיאה ביצירת טבלה', 'error');
			}
		}

		async function checkHeaders() {
			// פונקציה פשוטה לבדיקה שכותרות קיימות
			// בדומה לטריידים
			console.log('Checking headers...');
			
			try {
				const locationsCheck = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A1:A1'
				});
				
				if (!locationsCheck.result.values || !locationsCheck.result.values[0][0]) {
					await addAllHeaders();
				}
				
				console.log('✅ Headers verified');
				
			} catch (error) {
				console.log('Headers check failed, will add them:', error);
				await addAllHeaders();
			}
		}
	   
	   
	   async function importFromHelperTable() {
			if (!await validateToken()) {
				showToast('התחבר לגוגל קודם', 'warning');
				return;
			}
			
			const importTableId = localStorage.getItem('importTableId');
			if (!importTableId) {
				showToast('לא נמצא ID של טבלת העזר', 'warning');
				return;
			}
			
			console.log('🔍 Import Table ID:', importTableId); // לוג חדש
			
			try {
				showLoading('מייבא נתונים מטבלת העזר...');
				
				let importedCount = 0;
				
				// ייבוא מיקומים
				try {
					console.log('📍 Starting locations import...'); // לוג חדש
					
					const locationsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Locations!A2:O1000'
					});
					
					console.log('📍 Locations response:', locationsResponse.result); // לוג חדש
					
					if (locationsResponse.result.values && locationsResponse.result.values.length > 0) {
						console.log('📍 Found', locationsResponse.result.values.length, 'location rows'); // לוג חדש
						
						for (const row of locationsResponse.result.values) {
							if (row[0] && row[1]) {
								const locationData = parseLocationFromRow(row);
								locations.push(locationData);
								importedCount++;
								
								await new Promise(resolve => setTimeout(resolve, 200));
							}
						}
						showToast(`יובאו ${importedCount} מיקומים`, 'success');
					} else {
						console.log('📍 No locations data found'); // לוג חדש
					}
				} catch (error) {
					console.error('📍 Locations import error:', error); // לוג חדש
				}
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				// ייבוא ביקורים
				try {
					console.log('🔧 Starting visits import...');
					
					const visitsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Visits!A2:M1000'
					});
					
					console.log('🔧 Visits response:', visitsResponse.result);
					
					let visitsCount = 0;
					if (visitsResponse.result.values && visitsResponse.result.values.length > 0) {
						console.log('🔧 Found', visitsResponse.result.values.length, 'visit rows');
						
						for (let i = 0; i < visitsResponse.result.values.length; i++) {
							const row = visitsResponse.result.values[i];
							if (row[0] && row[1]) {
								const visitData = parseVisitFromRow(row);
								if (!isDuplicateVisit(visitData)) {
									visits.push(visitData);
									visitsCount++;
								} else {
									console.log('⚠️ Duplicate visit skipped:', visitData.date, visitData.location_id);
								}
								visitsCount++;
								
								// הצג התקדמות כל 50 רשומות
								if (visitsCount % 50 === 0) {
									console.log(`🔧 Processed ${visitsCount}/${visitsResponse.result.values.length} visits`);
									showToast(`מעבד ביקור ${visitsCount}...`, 'info', 1000);
								}
								
								await new Promise(resolve => setTimeout(resolve, 100)); // המתנה קצרה יותר
							}
						}
						showToast(`יובאו ${visitsCount} ביקורים`, 'success');
					} else {
						console.log('🔧 No visits data found');
					}
				} catch (error) {
					console.error('🔧 Visits import error:', error);
				}
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				// ייבוא קבלות
				try {
					console.log('🧾 Starting receipts import...');
					
					const receiptsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Receipts!A2:J1000'
					});
					
					console.log('🧾 Receipts response:', receiptsResponse.result);
					
					let receiptsCount = 0;
					if (receiptsResponse.result.values && receiptsResponse.result.values.length > 0) {
						console.log('🧾 Found', receiptsResponse.result.values.length, 'receipt rows');
						
						for (let i = 0; i < receiptsResponse.result.values.length; i++) {
							const row = receiptsResponse.result.values[i];
							if (row[0] && row[3]) { // ID ותאריך
								const receiptData = parseReceiptFromRow(row);
								
								
								if (!isDuplicateReceipt(receiptData)) {
									receipts.push(receiptData);
									receiptsCount++;
								} else {
									console.log('⚠️ Duplicate receipt skipped:', receiptData.date, receiptData.location_id);
								}
								
								// הצג התקדמות כל 25 רשומות (קבלות בדרך כלל פחות)
								if (receiptsCount % 25 === 0) {
									console.log(`🧾 Processed ${receiptsCount}/${receiptsResponse.result.values.length} receipts`);
									showToast(`מעבד קבלה ${receiptsCount}...`, 'info', 1000);
								}
								
								await new Promise(resolve => setTimeout(resolve, 100)); // המתנה קצרה יותר
							}
						}
						showToast(`יובאו ${receiptsCount} קבלות`, 'success');
					} else {
						console.log('🧾 No receipts data found');
					}
				} catch (error) {
					console.error('🧾 Receipts import error:', error);
				}
				
				// שמירה מקומית ועדכון תצוגה
				saveToLocalStorage();
				loadLocationsTable();
				loadReceiptsTable();
				loadFilterOptions();

				// בדיקה שהנתונים נטענו נכון
				console.log('🔍 בדיקת ייבוא:');
				console.log(`לקוחות: ${locations.length}`);
				console.log(`ביקורים: ${visits.length}`);
				console.log(`קבלות: ${receipts.length}`);

				// הצג דוגמה של הרשומה הראשונה מכל סוג
				if (locations.length > 0) {
					console.log('דוגמה לקוח:', locations[0]);
				}
				if (visits.length > 0) {
					console.log('דוגמה ביקור:', visits[0]);
				}


				// תוספה חשובה - שמירה לענן!
				showToast('שומר נתונים חדשים לענן...', 'info');

				try {
					/// await saveAllToSheets();
					/// await saveAllToSheetsOptimized();
					
					// שמירה מהירה לפי סוג נתונים
					const locationSuccess = await saveLocationsBatch(newLocations || []);
					const visitSuccess = await saveVisitsBatch(newVisits || []);  
					const receiptSuccess = await saveReceiptsBatch(newReceipts || []);

					if (locationSuccess && visitSuccess && receiptSuccess) {
						showToast('🚀 שמירה מהירה הושלמה בהצלחה!', 'success');
					} else {
						showToast('⚠️ חלק מהנתונים לא נשמרו לענן', 'warning');
					}

					showToast(`🎉 ייבוא הושלם בהצלחה!
					📍 ${locationsCount || 0} מיקומים
					🔧 ${visitsCount || 0} ביקורים  
					🧾 ${receiptsCount || 0} קבלות
					✅ הכל נשמר לענן!`, 'success', 6000);
				} catch (error) {
					console.error('Error saving imported data to cloud:', error);
					showToast('ייבוא הושלם מקומית, אבל שגיאה בשמירה לענן', 'warning');
				}
				
			} catch (error) {
				console.error('Import error:', error);
				showToast('שגיאה בייבוא נתונים', 'error');
			} finally {
				hideLoading();
			}
		}

		// פונקציות עזר לפרסור שורות
		function parseVisitFromRow(row) {
			return {
				ID: row[0] || generateID(),
				date: row[1] || '',
				location_id: row[2] || '',
				visit_type: row[3] || '',
				work_done: row[4] || '',
				duration_minutes: parseInt(row[5]) || 0,
				num_workers: parseInt(row[6]) || 1,
				start_time: row[7] || '',
				end_time: row[8] || '',
				amount: parseFloat(row[9]) || 0,
				expense: parseFloat(row[10]) || 0,
				paid: row[11] || 'לא',
				notes: row[12] || ''
			};
		}

		function parseReceiptFromRow(row) {
			return {
				ID: row[0] || generateID(),
				booklet_number: row[1] || '',
				receipt_number: row[2] || '',
				date: row[3] || '',
				location_id: row[4] || '',
				location_name: row[5] || '',
				amount: parseFloat(row[6]) || 0,
				payment_type: row[7] || '',
				tax_code: row[8] || '',
				notes: row[9] || ''
			};
		}
	   
	   // הוסף את זה לסוף הקוד
		function updateImportTableStatus() {
			const importTableId = localStorage.getItem('importTableId');
			const statusDiv = document.getElementById('importTableStatus');
			
			if (importTableId && statusDiv) {
				statusDiv.innerHTML = `
					<span style="font-size: 13px; color: #28a745;">
						✅ טבלת עזר זמינה: 
						<a href="https://docs.google.com/spreadsheets/d/${importTableId}/edit" 
						   target="_blank" style="color: #007bff; text-decoration: underline;">
						   פתח טבלה
						</a>
					</span>
					<br>
					<button onclick="localStorage.removeItem('importTableId'); updateImportTableStatus();" 
							style="background: none; border: none; color: #dc3545; font-size: 12px; cursor: pointer; margin-top: 5px;">
						🗑️ מחק קישור לטבלת עזר
					</button>
				`;
			} else if (statusDiv) {
				statusDiv.innerHTML = `
					<span style="font-size: 13px; color: #666;">
						❌ לא נמצאה טבלת עזר שמורה
					</span>
					<br>
					<span style="font-size: 12px; color: #999;">
						צור טבלת עזר חדשה כדי לייבא נתונים
					</span>
				`;
			}
		}

		// הרץ את זה כשהדף נטען
		document.addEventListener('DOMContentLoaded', function() {
			updateImportTableStatus();
		});

		// הרץ גם כשעוברים לטאב המערכת
		function showTab(event, tabName) {
			// הקוד הקיים שלך...
			
			// הוסף את זה בסוף הפונקציה
			if (tabName === 'system') {
				setTimeout(updateImportTableStatus, 100);
			}
		}
	   
	   
	   // ייבוא מטקסט טלגרם - פונקציה ראשית
		async function importFromTelegram() {
			// יצירת input קובץ עם תמיכה בקבצים מרובים
			const fileInput = document.createElement('input');
			fileInput.type = 'file';
			fileInput.accept = '.txt';
			fileInput.multiple = true; // תמיכה בקבצים מרובים!
			
			fileInput.onchange = async (event) => {
				const files = Array.from(event.target.files);
				if (files.length === 0) return;
				
				try {
					showLoading(`מפרסר ${files.length} קבצי טלגרם...`);
					
					let allParsedVisits = [];
					
					// עבור על כל הקבצים
					for (let i = 0; i < files.length; i++) {
						const file = files[i];
						console.log(`📄 Processing file ${i+1}/${files.length}: ${file.name}`);
						
						const text = await file.text();
						const parsedVisits = parseTelegramText(text);
						
						console.log(`📄 File ${file.name}: found ${parsedVisits.length} visits`);
						allParsedVisits = allParsedVisits.concat(parsedVisits);
						
						// המתנה קצרה בין קבצים
						if (i < files.length - 1) {
							await new Promise(resolve => setTimeout(resolve, 300));
						}
					}
					
					if (allParsedVisits.length > 0) {
						showToast(`נמצאו ${allParsedVisits.length} ביקורים מ-${files.length} קבצים`, 'success');
						
						// פתרון פשוט - אישור ישיר
						if (confirm(`נמצאו ${allParsedVisits.length} ביקורים מטלגרם.\n\nהאם לייבא אותם למערכת?`)) {
							window.pendingTelegramVisits = allParsedVisits;
							await confirmTelegramImport();
						} else {
							showToast('ייבוא בוטל', 'info');
						}
					} else {
						showToast('לא נמצאו ביקורים בקבצים', 'warning');
					}
					
				} catch (error) {
					console.error('Error parsing telegram files:', error);
					showToast('שגיאה בפרסור קבצי טלגרם', 'error');
				} finally {
					hideLoading();
				}
			};
			
			fileInput.click();
		}

		// פונקציה ראשית לפרסור הטקסט
		function parseTelegramText(text) {
			const lines = text.split('\n');
			const visits = [];
			
			let currentDate = '';
			let currentTime = '';
			let currentAddress = '';
			let currentClient = null;
			let workDone = '';
			let duration = 0;
			
			console.log('🔍 Parsing', lines.length, 'lines...');
			
			for (let i = 0; i < lines.length; i++) {
				const line = lines[i].trim();
				if (!line) continue;
				
				// זיהוי תאריך
				if (isDateLine(line)) {
					currentDate = parseTelegramDate(line);
					console.log('📅 Found date:', currentDate);
					continue;
				}
				
				// זיהוי שעה
				if (isTimeLine(line)) {
					currentTime = line;
					console.log('🕐 Found time:', currentTime);
					continue;
				}
				
				// זיהוי כתובת לקוח
				const foundClient = findClientInText(line);
				if (foundClient) {
					currentClient = foundClient;
					currentAddress = foundClient.full_address;
					console.log('👤 Found client:', foundClient.name, 'at', currentAddress);
					continue;
				}
				
				// זיהוי סיום עבודה
				if (line.startsWith('סיום')) {
					workDone = line.replace('סיום', '').trim();
					console.log('🔧 Found work:', workDone);
					
					// חפש זמן בשורות הבאות
					for (let j = i + 1; j < Math.min(i + 5, lines.length); j++) {
						const nextLine = lines[j].trim();
						const foundDuration = parseWorkDuration(nextLine);
						if (foundDuration > 0) {
							duration = foundDuration;
							console.log('⏱️ Found duration:', duration, 'minutes');
							break;
						}
					}
					
					// צור ביקור אם יש מספיק מידע
					if (currentDate && currentClient && workDone) {
						const visit = {
							date: currentDate,
							time: currentTime,
							client_name: currentClient.name,
							client_id: currentClient.ID,
							address: currentAddress,
							work_done: workDone,
							duration_minutes: duration || 60, // ברירת מחדל שעה
							raw_text: `${line}\n${lines.slice(i+1, i+3).join('\n')}`
						};
						
						visits.push(visit);
						console.log('✅ Created visit:', visit);
					}
					
					// איפוס למצב הבא
					workDone = '';
					duration = 0;
				}
			}
			
			console.log('📊 Total parsed visits:', visits.length);
			return visits;
		}

		// פונקציות עזר לזיהוי דפוסים
		function isDateLine(line) {
			// זיהוי תאריך כמו "15 August 2024"
			const dateRegex = /^\d{1,2}\s+[A-Za-z]+\s+\d{4}$/;
			return dateRegex.test(line);
		}

		function isTimeLine(line) {
			// זיהוי שעה כמו "13:39"
			const timeRegex = /^\d{1,2}:\d{2}$/;
			return timeRegex.test(line);
		}

		function parseTelegramDate(dateStr) {
			// המר "15 August 2024" ל-"2024-08-15"
			const months = {
				'January': '01', 'February': '02', 'March': '03', 'April': '04',
				'May': '05', 'June': '06', 'July': '07', 'August': '08',
				'September': '09', 'October': '10', 'November': '11', 'December': '12'
			};
			
			const parts = dateStr.split(' ');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = months[parts[1]] || '01';
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			
			return '';
		}

		function findClientInText(text) {
			// חפש לקוח לפי כתובת או שם מהרשימה הקיימת
			for (const location of locations) {
				// התאמה מדויקת לשם
				if (location.name && text.includes(location.name)) {
					return location;
				}
				
				// התאמה לרחוב
				if (location.street && text.includes(location.street)) {
					return location;
				}
				
				// התאמה לכתובת מלאה
				if (location.full_address && text.toLowerCase().includes(location.full_address.toLowerCase())) {
					return location;
				}
				
				// חיפוש גמיש יותר - לפי חלקי כתובת
				if (location.full_address) {
					const addressParts = location.full_address.split(' ');
					if (addressParts.length >= 2) {
						const street = addressParts.slice(0, -1).join(' ');
						const number = addressParts[addressParts.length - 1];
						
						if (text.includes(street) && text.includes(number)) {
							return location;
						}
					}
				}
			}
			
			return null;
		}

		function parseWorkDuration(text) {
			const patterns = {
				'שעתיים וחצי': 150,
				'שעה ורבע נטו': 75,
				'שעה ורבע': 75,
				'שעה וחצי': 90,
				'שעתיים': 120,
				'שעה': 60,
				'חצי שעה': 30
			};
			
			for (const [pattern, minutes] of Object.entries(patterns)) {
				if (text.includes(pattern)) {
					return minutes;
				}
			}
			
			return 0;
		}

		// תצוגה מקדימה של הביקורים שנמצאו
		function showTelegramPreview(parsedVisits) {
			let previewHTML = `
				<div style="background: white; padding: 20px; border-radius: 10px; max-width: 800px; max-height: 600px; overflow-y: auto;">
					<h3 style="margin-bottom: 20px;">📋 תצוגה מקדימה - ביקורים שנמצאו</h3>
					
					<div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
						<p><strong>נמצאו ${parsedVisits.length} ביקורים פוטנציאליים</strong></p>
						<p style="font-size: 14px; color: #666;">בדוק את הנתונים ואשר ייבוא</p>
					</div>
					
					<div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
						<table style="width: 100%; border-collapse: collapse;">
							<thead style="background: #f8f9fa; position: sticky; top: 0;">
								<tr>
									<th style="padding: 10px; border: 1px solid #ddd;">תאריך</th>
									<th style="padding: 10px; border: 1px solid #ddd;">שעה</th>
									<th style="padding: 10px; border: 1px solid #ddd;">לקוח</th>
									<th style="padding: 10px; border: 1px solid #ddd;">עבודה</th>
									<th style="padding: 10px; border: 1px solid #ddd;">זמן (דק')</th>
								</tr>
							</thead>
							<tbody>
			`;
			
			parsedVisits.forEach((visit, index) => {
				previewHTML += `
					<tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
						<td style="padding: 8px; border: 1px solid #ddd;">${visit.date}</td>
						<td style="padding: 8px; border: 1px solid #ddd;">${visit.time}</td>
						<td style="padding: 8px; border: 1px solid #ddd;">${visit.client_name}</td>
						<td style="padding: 8px; border: 1px solid #ddd;">${visit.work_done}</td>
						<td style="padding: 8px; border: 1px solid #ddd;">${visit.duration_minutes}</td>
					</tr>
				`;
			});
			
			previewHTML += `
							</tbody>
						</table>
					</div>
					
					<div style="margin-top: 20px; text-align: center; gap: 10px; display: flex; justify-content: center;">
						<button class="btn btn-success" onclick="confirmTelegramImport()">
							✅ אשר ייבוא (${parsedVisits.length} ביקורים)
						</button>
						<button class="btn btn-secondary" onclick="closeTelegramPreview()">
							❌ ביטול
						</button>
					</div>
				</div>
			`;
			
			// שמור את הנתונים למשתנה גלובלי לייבוא
			window.pendingTelegramVisits = parsedVisits;
			
			// הצג מודל
			showModal(previewHTML);
		}

		// אישור ייבוא הביקורים מטלגרם
		async function confirmTelegramImport() {
			if (!window.pendingTelegramVisits || window.pendingTelegramVisits.length === 0) {
				showToast('אין ביקורים לייבוא', 'warning');
				return;
			}
			
			try {
				showLoading('מייבא ביקורים מטלגרם...');
				
				let importedCount = 0;
				
				for (const telegramVisit of window.pendingTelegramVisits) {
					// צור ביקור חדש במבנה המערכת
					const visitData = {
						ID: generateID(),
						date: telegramVisit.date,
						location_id: telegramVisit.client_id,
						visit_type: 'גינון', // ברירת מחדל
						work_done: telegramVisit.work_done,
						duration_minutes: telegramVisit.duration_minutes,
						start_time: telegramVisit.time || '',
						end_time: '',
						amount: 0, // יחושב לפי זמן ותעריף
						expense: 0,
						paid: 'לא',
						notes: `יובא מטלגרם: ${telegramVisit.raw_text}`
					};
					
					// הוסף למערכת
					visits.push(visitData);
					importedCount++;
				}
				
				// שמור הכל
				saveToLocalStorage();
				
				// עדכן תצוגות
				loadReceiptsTable(); // זה מעדכן גם טבלת ביקורים
				loadFilterOptions();
				
				// שמור לענן
				/// await saveAllToSheets();
				await saveAllToSheetsOptimized();
				
				showToast(`🎉 ייבוא טלגרם הושלם!
				💬 ${importedCount} ביקורים יובאו
				✅ הכל נשמר לענן!
				🕐 תהליך הושלם`, 'success', 6000);;
				
				// נקה ונסגור
				window.pendingTelegramVisits = null;
				closeTelegramPreview();
				
			} catch (error) {
				console.error('Error importing telegram visits:', error);
				showToast('שגיאה בייבוא מטלגרם', 'error');
			} finally {
				hideLoading();
			}
		}

		// סגירת תצוגה מקדימה
		function closeTelegramPreview() {
			window.pendingTelegramVisits = null;
			closeModal();
		}


		function showModal(content) {
			// הסר מודל קיים אם יש
			const existingModal = document.getElementById('telegramModal');
			if (existingModal) {
				existingModal.remove();
			}
			
			// צור מודל
			const modal = document.createElement('div');
			modal.id = 'telegramModal';
			modal.style.cssText = `
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.5);
				display: flex;
				justify-content: center;
				align-items: center;
				z-index: 1000;
			`;
			
			modal.innerHTML = content;
			document.body.appendChild(modal);
			
			// סגירה בלחיצה על הרקע
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					closeModal();
				}
			});
		}

		function closeModal() {
			const modal = document.getElementById('telegramModal');
			if (modal) {
				modal.remove();
			}
		}
	   
	    function generateID() {
			return Date.now() + Math.random().toString(36).substr(2, 9);
		}
	   
	   
	   async function saveAllToSheetsOptimized() {
			if (!await validateToken()) {
				showToast('חיבור לגוגל פג - שמירה מקומית בלבד', 'warning');
				return;
			}
			
			try {
				showLoading('שומר נתונים לענן (מצב מהיר)...');
				
				// שמירה אצווית - כל המיקומים בבת אחת
				if (locations.length > 0) {
					showToast(`שומר ${locations.length} מיקומים בבת אחת...`, 'info', 2000);
					
					const locationValues = locations.map(loc => [
						loc.ID, loc.name, loc.full_address, loc.neighborhood, loc.city,
						loc.contact_person, loc.phone, loc.allowed_day, loc.interval_weeks,
						loc.temporary_addition, loc.base_amount, loc.active, loc.notes,
						loc.last_visit, loc.next_visit
					]);
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Locations!A2:O${locationValues.length + 1}`,
						valueInputOption: 'USER_ENTERED',
						resource: { values: locationValues }
					});
				}
				
				// שמירה אצווית - כל הביקורים בבת אחת
				if (visits.length > 0) {
					showToast(`שומר ${visits.length} ביקורים בבת אחת...`, 'info', 2000);
					
					const visitValues = visits.map(visit => [
						visit.ID, visit.date, visit.location_id, visit.visit_type,
						visit.work_done, visit.duration_minutes, visit.num_workers || 1,
						visit.start_time, visit.end_time, visit.amount, visit.expense || 0,
						visit.paid, visit.notes
					]);
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Visits!A2:M${visitValues.length + 1}`,
						valueInputOption: 'USER_ENTERED',
						resource: { values: visitValues }
					});
				}
				
				// שמירה אצווית - כל הקבלות בבת אחת
				if (receipts.length > 0) {
					showToast(`שומר ${receipts.length} קבלות בבת אחת...`, 'info', 2000);
					
					const receiptValues = receipts.map(receipt => [
						receipt.ID, receipt.book_number, receipt.receipt_number, receipt.date,
						receipt.location_id, receipt.location_name, receipt.amount,
						receipt.payment_type, receipt.notes
					]);
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Receipts!A2:I${receiptValues.length + 1}`,
						valueInputOption: 'USER_ENTERED',
						resource: { values: receiptValues }
					});
				}
				
				showToast(`🚀 שמירה מהירה הושלמה!
		✅ ${locations.length + visits.length + receipts.length} רשומות נשמרו
		⚡ זמן חיסכון: ~90%`, 'success', 5000);
				
			} catch (error) {
				console.error('Error in optimized save:', error);
				showToast('שגיאה בשמירה מהירה - חוזר לשיטה רגילה', 'warning');
				
				// אם נכשל, חזור לשיטה הרגילה
				await saveAllToSheets();
			} finally {
				hideLoading();
			}
		}
	   
	   // פונקציה להצגת חובות
		function displayDebts() {
			const sortBy = document.getElementById('debtSortBy').value;
			const minAmount = parseFloat(document.getElementById('minDebtAmount').value) || 0;
			
			// חישוב חובות לכל לקוח
			const debtsByLocation = {};
			
			visits.forEach(visit => {
				if (visit.paid === 'לא' && visit.amount > 0) {
					if (!debtsByLocation[visit.location_id]) {
						const location = locations.find(loc => loc.ID == visit.location_id);
						debtsByLocation[visit.location_id] = {
							location: location,
							visits: [],
							totalDebt: 0
						};
					}
					debtsByLocation[visit.location_id].visits.push(visit);
					debtsByLocation[visit.location_id].totalDebt += parseFloat(visit.amount);
				}
			});
			
			// המרה למערך וסינון
			let debtsArray = Object.values(debtsByLocation)
				.filter(debt => debt.totalDebt >= minAmount);
			
			// מיון
			debtsArray.sort((a, b) => {
				switch(sortBy) {
					case 'amount_desc':
						return b.totalDebt - a.totalDebt;
					case 'amount_asc':
						return a.totalDebt - b.totalDebt;
					case 'date_old':
						return new Date(a.visits[0].date) - new Date(b.visits[0].date);
					case 'date_new':
						return new Date(b.visits[0].date) - new Date(a.visits[0].date);
					case 'location':
						return a.location?.name.localeCompare(b.location?.name);
					default:
						return b.totalDebt - a.totalDebt;
				}
			});
			
			// הצגה בטבלה
			const tbody = document.getElementById('debtsTableBody');
			tbody.innerHTML = '';
			
			debtsArray.forEach(debt => {
				const location = debt.location || { name: 'לא נמצא', full_address: '', phone: '' };
				const lastVisit = debt.visits[debt.visits.length - 1];
				const daysSinceLastVisit = Math.floor((new Date() - new Date(lastVisit.date)) / (1000 * 60 * 60 * 24));
				
				const row = document.createElement('tr');
				
				// הדגשת חובות ישנים
				if (daysSinceLastVisit > 60) {
					row.style.backgroundColor = '#ffebee'; // אדום עדין
				} else if (daysSinceLastVisit > 30) {
					row.style.backgroundColor = '#fff3e0'; // כתום עדין  
				}
				
				row.innerHTML = `
					<td>
						<strong>${location.name}</strong>
						<br><small style="color: #666;">${location.contact_person || ''}</small>
					</td>
					<td><small>${location.full_address || ''}</small></td>
					<td>
						${location.phone ? 
							`<a href="tel:${location.phone}" style="color: #007bff; text-decoration: none;">
								📞 ${location.phone}
							</a>` : 
							'<span style="color: #999;">-</span>'
						}
					</td>
					<td style="text-align: center;">
						<span style="background: #e3f2fd; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
							${debt.visits.length}
						</span>
					</td>
					<td style="text-align: center;">
						<strong style="color: #e74c3c; font-size: 16px;">₪${debt.totalDebt.toLocaleString()}</strong>
					</td>
					<td style="text-align: center;">${formatDate(lastVisit.date)}</td>
					<td style="text-align: center;">
						<span style="color: ${daysSinceLastVisit > 60 ? '#e74c3c' : daysSinceLastVisit > 30 ? '#f39c12' : '#666'}; font-weight: bold;">
							${daysSinceLastVisit}
						</span>
					</td>
					<td style="text-align: center;">
						<button class="action-btn" onclick="showDebtDetails(${location.ID})" style="background: #007bff; margin: 2px;">
							🔍 פירוט
						</button>
						<button class="action-btn" onclick="markDebtAsPaid(${location.ID})" style="background: #28a745; margin: 2px;">
							✅ סולק
						</button>
					</td>
				`;
				
				tbody.appendChild(row);
			});
			
			// עדכון סיכום
			updateDebtsSummary(debtsArray);
		}

		// עדכון כרטיסי סיכום
		function updateDebtsSummary(debtsArray) {
			const totalDebt = debtsArray.reduce((sum, debt) => sum + debt.totalDebt, 0);
			const debtorsCount = debtsArray.length;
			const averageDebt = debtorsCount > 0 ? totalDebt / debtorsCount : 0;
			
			// מציאת החוב הכי ישן
			let oldestDebtDays = 0;
			if (debtsArray.length > 0) {
				const oldestVisit = debtsArray
					.flatMap(debt => debt.visits)
					.reduce((oldest, visit) => 
						new Date(visit.date) < new Date(oldest.date) ? visit : oldest
					);
				oldestDebtDays = Math.floor((new Date() - new Date(oldestVisit.date)) / (1000 * 60 * 60 * 24));
			}
			
			document.getElementById('totalDebt').textContent = `₪${totalDebt.toLocaleString()}`;
			document.getElementById('totalDebt').style.color = totalDebt > 0 ? '#e74c3c' : '#27ae60';
			
			document.getElementById('debtorsCount').textContent = debtorsCount;
			document.getElementById('averageDebt').textContent = `₪${Math.round(averageDebt).toLocaleString()}`;
			document.getElementById('oldestDebt').textContent = oldestDebtDays > 0 ? `${oldestDebtDays} ימים` : '-';
			
			if (oldestDebtDays > 90) {
				document.getElementById('oldestDebt').style.color = '#e74c3c';
			} else if (oldestDebtDays > 30) {
				document.getElementById('oldestDebt').style.color = '#f39c12';
			}
		}

		// הצגת פירוט חוב ללקוח
		function showDebtDetails(locationId) {
			const location = locations.find(loc => loc.ID == locationId);
			const locationVisits = visits.filter(v => v.location_id == locationId && v.paid === 'לא');
			
			let details = `פירוט חוב עבור: ${location?.name}\n\n`;
			
			locationVisits.forEach(visit => {
				details += `📅 ${formatDate(visit.date)}\n`;
				details += `🔧 ${visit.work_done}\n`;
				details += `💰 ₪${visit.amount}\n`;
				details += `---\n`;
			});
			
			const totalDebt = locationVisits.reduce((sum, v) => sum + parseFloat(v.amount), 0);
			details += `\nסה"כ חוב: ₪${totalDebt}`;
			
			alert(details);
		}

		// סימון חוב כמסולק
		function markDebtAsPaid(locationId) {
			if (confirm('לסמן את כל החובות של הלקוח הזה כמסולקים?')) {
				visits.forEach(visit => {
					if (visit.location_id == locationId && visit.paid === 'לא') {
						visit.paid = 'כן';
					}
				});
				
				saveToLocalStorage();
				displayDebts();
				showToast('החובות סומנו כמסולקים!', 'success');
			}
		}

	   
	    // התראה על חובות חמורים
		function checkCriticalDebts() {
			const criticalDebts = visits.filter(visit => {
				if (visit.paid !== 'לא') return false;
				
				const daysSince = Math.floor((new Date() - new Date(visit.date)) / (1000 * 60 * 60 * 24));
				return daysSince > 90 || parseFloat(visit.amount) > 1000;
			});
			
			if (criticalDebts.length > 0) {
				const totalCritical = criticalDebts.reduce((sum, visit) => sum + parseFloat(visit.amount), 0);
				
				showToast(
					`⚠️ יש ${criticalDebts.length} חובות דחופים (₪${totalCritical.toLocaleString()})`, 
					'warning', 
					8000
				);
			}
		}
	   
	   
	    // דוח הכנסות לחודש נוכחי
		function generateMonthlyReport() {
			const currentMonth = new Date().getMonth();
			const currentYear = new Date().getFullYear();
			
			const monthlyVisits = visits.filter(visit => {
				const visitDate = new Date(visit.date);
				return visitDate.getMonth() === currentMonth && 
					   visitDate.getFullYear() === currentYear;
			});
			
			const totalRevenue = monthlyVisits.reduce((sum, visit) => 
				sum + parseFloat(visit.amount || 0), 0);
			
			const paidRevenue = monthlyVisits
				.filter(visit => visit.paid === 'כן')
				.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			const totalHours = monthlyVisits.reduce((sum, visit) => 
				sum + (visit.duration_minutes || 0) / 60, 0);
			
			const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני',
				'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
			
			const report = {
				month: monthNames[currentMonth],
				year: currentYear,
				totalVisits: monthlyVisits.length,
				totalRevenue: totalRevenue,
				paidRevenue: paidRevenue,
				pendingRevenue: totalRevenue - paidRevenue,
				totalHours: totalHours.toFixed(1),
				avgPerVisit: monthlyVisits.length > 0 ? Math.round(totalRevenue / monthlyVisits.length) : 0
			};
			
			return report;
		}

		// הצגת דוח במודל
		function showMonthlyReport() {
			const report = generateMonthlyReport();
			
			const reportHTML = `
				<div style="background: white; padding: 20px; border-radius: 10px; max-width: 500px;">
					<h3>📊 דוח ${report.month} ${report.year}</h3>
					
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
						<div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #1976d2;">${report.totalVisits}</div>
							<div style="color: #666;">ביקורים</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #2e7d32;">₪${report.totalRevenue.toLocaleString()}</div>
							<div style="color: #666;">סה"כ הכנסות</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #f3e5f5; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #7b1fa2;">₪${report.paidRevenue.toLocaleString()}</div>
							<div style="color: #666;">נגבה</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #fff3e0; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #f57c00;">₪${report.pendingRevenue.toLocaleString()}</div>
							<div style="color: #666;">בהמתנה</div>
						</div>
					</div>
					
					<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
						<div><strong>שעות עבודה:</strong> ${report.totalHours} שעות</div>
						<div><strong>ממוצע לביקור:</strong> ₪${report.avgPerVisit}</div>
						<div><strong>ממוצע לשעה:</strong> ₪${Math.round(report.paidRevenue / parseFloat(report.totalHours) || 0)}</div>
					</div>
					
					<button onclick="closeModal()" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; width: 100%;">
						סגור
					</button>
				</div>
			`;
			
			showModal(reportHTML);
		}
	   
	    function isDuplicateVisit(newVisit) {
			return visits.some(existing => 
				existing.location_id === newVisit.location_id &&
				existing.date === newVisit.date &&
				existing.work_done === newVisit.work_done &&
				existing.amount === newVisit.amount
			);
		}
	   
	    function isDuplicateReceipt(newReceipt) {
			return receipts.some(existing => 
				existing.receipt_number === newReceipt.receipt_number &&
				existing.booklet_number === newReceipt.booklet_number &&
				existing.date === newReceipt.date
			);
		}
		
		
		function removeDuplicates() {
			const uniqueVisits = [];
			const seen = new Set();
			
			visits.forEach(visit => {
				const key = `${visit.location_id}-${visit.date}-${visit.work_done}-${visit.amount}`;
				if (!seen.has(key)) {
					seen.add(key);
					uniqueVisits.push(visit);
				}
			});
			
			const removedCount = visits.length - uniqueVisits.length;
			visits = uniqueVisits;
			
			console.log(`Removed ${removedCount} duplicate visits`);
			return removedCount;
		}
	   
	   function validateVisitData(visitData) {
			const errors = [];
			
			if (!visitData.location_id) {
				errors.push('חסר מזהה לקוח');
			}
			
			if (!visitData.date) {
				errors.push('חסר תאריך');
			}
			
			if (!visitData.work_done || visitData.work_done.trim() === '') {
				errors.push('חסר תיאור עבודה');
			}
			
			return errors;
		}

		function showValidationErrors(errors) {
			if (errors.length > 0) {
				alert('בעיות בטופס:\n' + errors.join('\n'));
				return true; // יש שגיאות
			}
			return false; // אין שגיאות
		}
	   
	   // שמירה מקבצית של לקוחות
		async function saveLocationsBatch(locationsArray) {
			if (!await validateToken() || locationsArray.length === 0) return false;
			
			try {
				const values = locationsArray.map(location => [
					location.ID,
					location.name,
					location.full_address,
					location.neighborhood,
					location.city,
					location.contact_person,
					location.phone,
					location.allowed_day,
					location.interval_weeks,
					location.temp_addition,
					location.base_amount,
					location.active,
					location.notes,
					location.last_visit,
					location.next_visit
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:O`,
					valueInputOption: 'USER_ENTERED',
					resource: { 
						values: values,
						majorDimension: 'ROWS'
					}
				});
				
				console.log(`✅ Saved ${locationsArray.length} locations in batch`);
				return true;
			} catch (error) {
				console.error('Error in batch save locations:', error);
				return false;
			}
		}

		// שמירה מקבצית של ביקורים
		async function saveVisitsBatch(visitsArray) {
			if (!await validateToken() || visitsArray.length === 0) return false;
			
			try {
				const values = visitsArray.map(visit => [
					visit.ID,
					visit.date,
					visit.location_id,
					visit.location_name,
					visit.visit_type,
					visit.work_done,
					visit.duration_minutes,
					visit.start_time,
					visit.end_time,
					visit.amount,
					visit.expense,
					visit.paid,
					visit.notes
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:M`,
					valueInputOption: 'USER_ENTERED',
					resource: { 
						values: values,
						majorDimension: 'ROWS'
					}
				});
				
				console.log(`✅ Saved ${visitsArray.length} visits in batch`);
				return true;
			} catch (error) {
				console.error('Error in batch save visits:', error);
				return false;
			}
		}

		// שמירה מקבצית של קבלות
		async function saveReceiptsBatch(receiptsArray) {
			if (!await validateToken() || receiptsArray.length === 0) return false;
			
			try {
				const values = receiptsArray.map(receipt => [
					receipt.ID,
					receipt.book_number,
					receipt.receipt_number,
					receipt.date,
					receipt.location_id,
					receipt.location_name,
					receipt.amount,
					receipt.payment_type,
					receipt.notes
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:I`,
					valueInputOption: 'USER_ENTERED',
					resource: { 
						values: values,
						majorDimension: 'ROWS'
					}
				});
				
				console.log(`✅ Saved ${receiptsArray.length} receipts in batch`);
				return true;
			} catch (error) {
				console.error('Error in batch save receipts:', error);
				return false;
			}
		}
	   
	   
   </script>
</body>
</html>
