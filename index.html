<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול טיפולים ולקוחות</title>
	
	<script src="https://apis.google.com/js/api.js"></script>
	<script src="https://accounts.google.com/gsi/client"></script>

	
    <style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			direction: rtl;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}

		/* Header מעוצב */
		.header {
			background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
			border-radius: 15px;
			padding: 30px;
			margin-bottom: 20px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.3);
			color: white;
		}

		.header h1 {
			font-size: 2.5em;
			margin-bottom: 10px;
			text-align: center;
			text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
			background: linear-gradient(45deg, #3498db, #2ecc71);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}

		/* Connection Status מעוצב */
		.connection-status {
			text-align: center;
			margin: 20px 0;
			padding: 20px;
			background: rgba(255,255,255,0.1);
			border-radius: 15px;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255,255,255,0.2);
		}

		.connect-btn {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 12px 24px;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			margin: 5px;
			transition: all 0.3s ease;
			box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
		}

		.connect-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
		}

		.connect-btn:disabled {
			background: #95a5a6;
			cursor: not-allowed;
			transform: none;
		}

		/* Navigation מעוצב */
		.nav-buttons {
			display: flex;
			gap: 15px;
			justify-content: center;
			flex-wrap: wrap;
			margin-top: 20px;
		}

		.nav-btn {
			padding: 15px 25px;
			border: none;
			background: rgba(255,255,255,0.1);
			color: white;
			border-radius: 10px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255,255,255,0.2);
		}

		.nav-btn:hover {
			background: rgba(255,255,255,0.2);
			transform: translateY(-2px);
		}

		.nav-btn.active {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
			transform: translateY(-2px);
		}

		/* Main Content מעוצב */
		.main-content {
			background: rgba(255,255,255,0.95);
			border-radius: 15px;
			padding: 30px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.2);
			backdrop-filter: blur(10px);
		}

		.section {
			display: none;
		}

		.section.active {
			display: block;
		}

		.section h2 {
			color: #2c3e50;
			margin-bottom: 30px;
			padding-bottom: 15px;
			border-bottom: 3px solid #3498db;
			font-size: 1.8em;
			position: relative;
		}

		.section h2::before {
			content: '';
			position: absolute;
			bottom: -3px;
			left: 0;
			width: 60px;
			height: 3px;
			background: linear-gradient(45deg, #e74c3c, #f39c12);
			border-radius: 2px;
		}

		/* Forms מעוצבים */
		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			margin-bottom: 8px;
			color: #2c3e50;
			font-weight: bold;
			font-size: 14px;
		}

		.form-group input, .form-group select, .form-group textarea {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #e9ecef;
			border-radius: 8px;
			font-size: 14px;
			transition: all 0.3s ease;
			background: white;
		}

		.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
			transform: translateY(-1px);
		}

		/* Buttons מעוצבים */
		.add-btn {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
			border: none;
			padding: 15px 30px;
			border-radius: 10px;
			cursor: pointer;
			margin-bottom: 20px;
			font-size: 16px;
			font-weight: bold;
			transition: all 0.3s ease;
			box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
		}

		.add-btn:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
		}

		.action-btn {
			padding: 8px 16px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 12px;
			margin: 0 3px;
			transition: all 0.3s ease;
			font-weight: bold;
		}

		.edit-btn {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
		}

		.edit-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
		}

		.delete-btn {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			color: white;
		}

		.delete-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
		}

		/* Tables מעוצבות */
		.table-container {
			background: white;
			border-radius: 12px;
			overflow: hidden;
			box-shadow: 0 8px 25px rgba(0,0,0,0.15);
			margin-top: 20px;
		}

		.data-table {
			width: 100%;
			border-collapse: collapse;
			background: white;
		}

		.data-table thead {
			background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
			color: white;
		}

		.data-table th {
			padding: 15px 12px;
			text-align: right;
			font-weight: bold;
			border-bottom: 2px solid #3498db;
		}

		.data-table td {
			padding: 12px;
			border-bottom: 1px solid #ecf0f1;
			transition: background 0.3s ease;
		}

		.data-table tbody tr:hover {
			background: #f8f9fa;
			transform: scale(1.01);
		}

		.data-table tbody tr:nth-child(even) {
			background: #fbfcfd;
		}

		/*************************/
		/* Filter Panels מעוצבים */
		
		.filter-panel-unified {
			background: #f8f9fa;
			padding: 15px;
			border-radius: 8px;
			margin-bottom: 20px;
			border: 1px solid #e9ecef;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}

		.filter-panel-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 15px;
			padding-bottom: 10px;
			border-bottom: 1px solid #dee2e6;
		}

		.filter-panel-title {
			font-size: 14px;
			font-weight: bold;
			color: #2c3e50;
			margin: 0;
		}

		.filter-row-unified {
			display: flex;
			gap: 15px;
			align-items: center;
			flex-wrap: wrap;
			margin-bottom: 10px;
		}

		.filter-row-unified:last-child {
			margin-bottom: 0;
		}

		.filter-group-unified {
			flex: 1;
			min-width: 150px;
		}

		.filter-group-unified.compact {
			flex: 0 0 120px;
		}

		.filter-group-unified.small {
			flex: 0 0 100px;
		}

		.filter-group-unified.medium {
			flex: 0 0 140px;
		}

		.filter-group-unified label {
			font-size: 12px;
			font-weight: bold;
			margin-bottom: 5px;
			display: block;
			color: #495057;
		}

		.filter-group-unified input,
		.filter-group-unified select {
			width: 100%;
			padding: 8px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 13px;
			background: white;
			transition: border-color 0.3s ease;
		}

		.filter-group-unified input:focus,
		.filter-group-unified select:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
		}

		.filter-clear-btn {
			background: #e74c3c;
			color: white;
			border: none;
			padding: 8px 12px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 12px;
			font-weight: bold;
			transition: all 0.3s ease;
		}

		.filter-clear-btn:hover {
			background: #c0392b;
			transform: translateY(-1px);
		}

		/* Mobile responsiveness */
		@media (max-width: 768px) {
			.filter-row-unified {
				flex-direction: column;
				gap: 10px;
			}
			
			.filter-group-unified,
			.filter-group-unified.compact,
			.filter-group-unified.small,
			.filter-group-unified.medium {
				flex: none;
				min-width: auto;
				width: 100%;
			}
			
			.filter-panel-header {
				flex-direction: column;
				gap: 10px;
				text-align: center;
			}
		}
		
		/***********************/
		
		.filter-quick-btn {
			background: #e3f2fd;
			color: #1976d2;
			border: 1px solid #90caf9;
			padding: 6px 12px;
			border-radius: 5px;
			cursor: pointer;
			font-size: 12px;
			transition: all 0.2s ease;
		}

		.filter-quick-btn:hover {
			background: #bbdefb;
		}

		.filter-quick-btn.active {
			background: #1976d2;
			color: white;
		}
		
		
		/***********************/

		/* Submit Button מעוצב */
		button[type="submit"] {
			width: 100%;
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 18px;
			border-radius: 10px;
			cursor: pointer;
			font-size: 18px;
			font-weight: bold;
			margin-top: 20px;
			transition: all 0.3s ease;
			box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
		}

		button[type="submit"]:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
		}

		/* Mobile Responsive */
		@media (max-width: 768px) {
			.container {
				padding: 10px;
			}
			
			.header {
				padding: 20px 15px;
			}
			
			.header h1 {
				font-size: 1.8em;
			}
			
			.nav-buttons {
				gap: 8px;
			}
			
			.nav-btn {
				padding: 12px 16px;
				font-size: 12px;
			}
			
			.main-content {
				padding: 20px 15px;
			}
		}

		/* Toast Notifications */
		.toast-container {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 1000;
			max-width: 300px;
		}

		.toast {
			background: linear-gradient(45deg, #2c3e50, #3498db);
			color: white;
			padding: 15px 20px;
			border-radius: 8px;
			margin-bottom: 10px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
			transform: translateX(400px);
			opacity: 0;
			transition: all 0.3s ease;
			border-right: 4px solid #27ae60;
			font-weight: bold;
		}

		.toast.success {
			border-right-color: #27ae60;
			background: linear-gradient(45deg, #27ae60, #2ecc71);
		}

		.toast.error {
			border-right-color: #e74c3c;
			background: linear-gradient(45deg, #e74c3c, #c0392b);
		}

		.toast.warning {
			border-right-color: #f39c12;
			background: linear-gradient(45deg, #f39c12, #e67e22);
		}

		.toast.info {
			border-right-color: #3498db;
			background: linear-gradient(45deg, #3498db, #2980b9);
		}

		.toast.show {
			transform: translateX(0);
			opacity: 1;
		}

		@media (max-width: 768px) {
			.toast-container {
				left: 10px;
				right: 10px;
				top: 10px;
				max-width: none;
			}
			
			.toast {
				transform: translateY(-100px);
			}
			
			.toast.show {
				transform: translateY(0);
			}
		}
		

		/* כפתורים כלליים */
		.btn {
			padding: 12px 20px;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			transition: all 0.3s ease;
			box-shadow: 0 3px 10px rgba(0,0,0,0.2);
			min-width: 120px;
		}

		.btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(0,0,0,0.3);
		}

		.btn-primary {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
		}

		.btn-success {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
		}

		.btn-warning {
			background: linear-gradient(45deg, #f39c12, #e67e22);
			color: white;
		}

		.btn-secondary {
			background: linear-gradient(45deg, #95a5a6, #7f8c8d);
			color: white;
		}

		.btn-info {
			background: linear-gradient(45deg, #17a2b8, #138496);
			color: white;
		}


		/* רשימות נפתחות */
		select, .form-group select {
			width: 100%;
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			cursor: pointer;
			min-height: 45px;
		}

		select:focus, .form-group select:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		select:hover {
			border-color: #7f8c8d;
			background: white;
		}

		/* שדות תאריך */
		input[type="date"] {
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			min-height: 45px;
		}

		input[type="date"]:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		
		/* כפתורי ייבוא במערכת */
		.form-section .btn {
			margin: 8px 5px;
			padding: 12px 20px;
			font-size: 14px;
			font-weight: bold;
			min-width: 150px;
		}

		/* שיפור נוסף לכפתורים קטנים */
		.action-btn {
			padding: 10px 16px;
			font-size: 13px;
			font-weight: bold;
			min-width: 80px;
		}

		/* כפתורים מוקפצים (disabled) */
		button:disabled, .btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none !important;
			box-shadow: none !important;
		}

		/* שיפור לתיבות טקסט */
		input[type="text"], input[type="number"], textarea {
			padding: 12px 15px;
			border: 2px solid #bdc3c7;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 500;
			background: linear-gradient(45deg, #ffffff, #f8f9fa);
			color: #2c3e50;
			transition: all 0.3s ease;
			min-height: 45px;
		}

		input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
			transform: translateY(-1px);
			background: white;
		}

		/* שיפור לכותרות בפאנלים */
		.filter-header h3, .info-header h3 {
			font-size: 16px;
			font-weight: bold;
			margin: 0;
			text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
		}

		/* מובייל - התאמות */
		@media (max-width: 768px) {
			.btn {
				padding: 10px 15px;
				font-size: 13px;
				min-width: 100px;
			}
			
			select, input[type="date"], input[type="text"], input[type="number"] {
				padding: 10px 12px;
				font-size: 13px;
				min-height: 40px;
			}
		}
		
		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
		}

		.stat-item {
			background: rgba(255,255,255,0.7);
			padding: 15px;
			border-radius: 8px;
			border-left: 4px solid #27ae60;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			backdrop-filter: blur(5px);
		}

		.stat-label {
			display: block;
			font-weight: bold;
			color: #495057;
			margin-bottom: 5px;
			font-size: 14px;
		}

		.stat-value {
			font-size: 1.4em;
			font-weight: bold;
			color: #2c3e50;
		}

		@media (max-width: 768px) {
			.stats-grid {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		.debt-card .summary-value {
			color: #e74c3c !important;
			font-weight: bold;
		}

		.debts-table tr:hover {
			background-color: #f8f9fa !important;
		}

		.action-btn {
			margin: 1px;
			padding: 4px 8px;
			font-size: 12px;
			border-radius: 3px;
			border: none;
			color: white;
			cursor: pointer;
		}

		.action-btn:hover {
			opacity: 0.8;
		}

		#statusText {
			transition: all 0.3s ease;
			padding: 8px 12px;
			border-radius: 6px;
			font-size: 14px;
		}

		#statusText.connected {
			background: linear-gradient(45deg, #28a745, #20c997);
			color: white;
			box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
			text-shadow: 0 1px 2px rgba(0,0,0,0.3);
		}

		#statusText.connecting {
			background: linear-gradient(45deg, #3498db, #5dade2);
			color: white;
			box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
			animation: pulse 1.5s ease-in-out infinite;
		}

		#statusText.disconnected {
			background: linear-gradient(45deg, #e74c3c, #ec7063);
			color: white;
			box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
		}

		#statusText.warning {
			background: linear-gradient(45deg, #f39c12, #f8b739);
			color: white;
			box-shadow: 0 2px 8px rgba(243, 156, 18, 0.3);
		}

		@keyframes pulse {
			0%, 100% { opacity: 1; }
			50% { opacity: 0.7; }
		}


		/* תצוגת תכנון - שורות כפולות */
			.planning-cards-container {
				min-height: 300px;
				border: 2px dashed #ddd;
				border-radius: 10px;
				padding: 15px;
				background: #fafafa;
				margin-bottom: 20px;
			}

			.planning-client-row {
				background: white;
				border-radius: 8px;
				margin-bottom: 12px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
				transition: all 0.3s ease;
			}

			.planning-client-row:hover {
				transform: translateY(-1px);
				box-shadow: 0 4px 8px rgba(0,0,0,0.15);
			}

			/***************************************************************/	
			/* צבעי רמזור */
			/* צבעי סטטוס משופרים לתכנון */
			.planning-status-green { 
				border-right: 4px solid #27ae60;
				background: linear-gradient(90deg, rgba(39, 174, 96, 0.1), white);
			}

			.planning-status-yellow { 
				border-right: 4px solid #f39c12;
				background: linear-gradient(90deg, rgba(243, 156, 18, 0.1), white);
			}

			.planning-status-orange { 
				border-right: 4px solid #e67e22;
				background: linear-gradient(90deg, rgba(230, 126, 34, 0.1), white);
			}

			.planning-status-red { 
				border-right: 4px solid #e74c3c;
				background: linear-gradient(90deg, rgba(231, 76, 60, 0.1), white);
			}

			.planning-status-gray {
				border-right: 4px solid #95a5a6;
				background: linear-gradient(90deg, rgba(149, 165, 166, 0.1), white);
			}

			/* כפתור התחל טיפול מעוצב */
			.planning-complete {
				background: linear-gradient(45deg, #27ae60, #2ecc71);
				color: white;
				font-size: 14px;
				font-weight: bold;
				width: 36px;
				height: 36px;
			}

			.planning-complete:hover {
				background: linear-gradient(45deg, #219a52, #27ae60);
				transform: scale(1.05);
			}

			/* עיצוב משופר לכותרות יום בשבוע */
			.weekly-day-header {
				background: linear-gradient(45deg, #3498db, #2980b9);
				color: white;
				padding: 12px 15px;
				border-radius: 8px;
				margin-bottom: 12px;
				font-size: 15px;
				font-weight: bold;
				text-align: center;
				box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
			}
			
			
			
			
			/****************************************************************/
			.planning-row-main {
				display: flex;
				align-items: center;
				padding: 12px 15px;
				gap: 15px;
			}

			.planning-client-info {
				flex: 1;
				text-align: right;
			}

			.planning-client-name {
				font-weight: bold;
				font-size: 16px;
				color: #333;
				margin-bottom: 3px;
			}

			.planning-client-address {
				font-size: 12px;
				color: #666;
				margin-bottom: 3px;
			}

			.planning-client-date {
				font-size: 12px;
				color: #555;
				font-weight: 500;
			}

			.planning-client-price {
				font-weight: bold;
				color: #2196F3;
				font-size: 16px;
				min-width: 80px;
				text-align: center;
			}

			.planning-client-actions {
				display: flex;
				gap: 8px;
			}

			.planning-action-btn {
				width: 32px;
				height: 32px;
				border: none;
				border-radius: 50%;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 12px;
				transition: all 0.3s ease;
			}

			
			.planning-postpone {
				background: #FF9800;
				color: white;
			}

			.planning-menu {
				background: #607D8B;
				color: white;
			}

			.planning-action-btn:hover {
				transform: scale(1.1);
			}

			.planning-row-details {
				background: #f8f9fa;
				padding: 8px 15px 12px 15px;
				border-top: 1px solid #e9ecef;
				font-size: 13px;
			}

			.client-requests {
				color: #0066cc;
				margin-bottom: 4px;
				font-weight: 500;
			}

			.client-notes {
				color: #666;
				font-style: italic;
			}

			/* מובייל */
			@media (max-width: 768px) {
				.planning-row-main {
					flex-direction: column;
					align-items: stretch;
					gap: 10px;
				}
				
				.planning-client-info {
					text-align: center;
				}
				
				.planning-client-actions {
					justify-content: center;
				}
				
				.planning-action-btn {
					width: 40px;
					height: 40px;
					font-size: 14px;
				}
			}

			/* שאר הסטיילים הקיימים נשארים */
			
			.planning-tab-btn.active {
				background: #3498db; /* שינוי מירוק לכחול */
				color: white;
				border-color: #3498db;
			}

			.planning-view-tabs {
				display: flex;
				justify-content: center;
				gap: 10px;
				margin-bottom: 20px;
			}

			.planning-tab-btn {
				padding: 8px 12px;
				font-size: 13px;
				border: 2px solid #ddd;
				background: white;
				border-radius: 25px;
				cursor: pointer;
				transition: all 0.3s ease;
				font-weight: bold;
			}


		/***************************************/
		/* ייבוא נתונים - כפתורים אחידים */
		.import-main-buttons {
			display: flex;
			justify-content: center;
			gap: 15px;
			margin: 15px 0;
			flex-wrap: wrap;
		}

		.import-other-buttons {
			display: flex;
			justify-content: center;
			margin: 15px 0;
		}

		.import-main-buttons button,
		.import-other-buttons button {
			padding: 12px 20px;
			background: #ffc107;
			color: #212529;
			border: 1px solid #ffc107;
			border-radius: 5px;
			font-weight: 500;
			font-size: 14px;
			cursor: pointer;
			transition: all 0.3s ease;
			min-width: 200px;
			white-space: nowrap;
		}

		.import-main-buttons button:hover,
		.import-other-buttons button:hover {
			background: #e0a800;
			border-color: #d39e00;
			transform: translateY(-1px);
			box-shadow: 0 4px 8px rgba(0,0,0,0.15);
		}

		/* כפתורי הייבוא החלקי */
		details[open] > div {
			display: flex !important;
			flex-wrap: wrap;
			gap: 8px;
			margin-top: 10px;
			justify-content: center;
		}

		details[open] > div button {
			flex: 1;
			min-width: 120px;
			max-width: 150px;
			font-size: 13px;
			padding: 10px 12px;
		}

		/* תגובה למובייל */
		@media (max-width: 768px) {
			.import-main-buttons {
				flex-direction: column;
				align-items: center;
			}
			
			.import-main-buttons button,
			.import-other-buttons button {
				min-width: 80%;
				max-width: 300px;
				padding: 15px 20px;
				font-size: 16px;
			}
			
			details[open] > div {
				flex-direction: column;
			}
			
			details[open] > div button {
				min-width: 80%;
				max-width: 250px;
				font-size: 14px;
			}
		}
		/***************************************/

		/* סטיילינג למצב שבועי */
		.weekly-day-section {
			margin-bottom: 25px;
		}

		.planning-empty-state {
			text-align: center;
			color: #666;
			padding: 40px 20px;
		}

		.planning-empty-state h3 {
			margin-bottom: 10px;
			color: #4CAF50;
		}


/***************************************/
/***************************************/

		/* עדכון CSS לכרטיסיות תכנון - מבנה דו-שורתי */
		.planning-row-details {
			background: #f8f9fa;
			padding: 8px 15px 12px 15px;
			border-top: 1px solid #e9ecef;
			font-size: 13px;
		}

		.client-requests {
			color: #0066cc;
			margin-bottom: 4px;
			font-weight: 500;
		}

		.client-notes {
			color: #666;
			font-style: italic;
		}

		.planning-active-toggle {
			margin-right: 5px;
		}

		.planning-history-btn {
			background: #6c757d;
			color: white;
			border: none;
			padding: 6px 10px;
			border-radius: 4px;
			font-size: 11px;
			cursor: pointer;
		}

		.planning-history-btn:hover {
			background: #5a6268;
		}

/***************************************/

		/* תיקון CSS לכפתורי הפעולה החדשים */
		.planning-client-actions {
			display: flex;
			gap: 5px;
			align-items: center;
			flex-wrap: wrap;
		}

		.planning-date-input {
			padding: 4px 6px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 11px;
			width: 100px;
			background: white;
		}

		.planning-active-toggle {
			padding: 4px 6px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 11px;
			background: white;
			width: 70px;
		}

		.planning-history-btn {
			background: #6c757d;
			color: white;
			border: none;
			padding: 6px 8px;
			border-radius: 4px;
			font-size: 11px;
			cursor: pointer;
			min-width: 35px;
		}

		.planning-history-btn:hover {
			background: #5a6268;
		}

		
		/* טאבי ימים */
		.days-tabs-container {
			margin-bottom: 20px;
		}

		.days-tabs {
			display: flex;
			gap: 5px;
			margin-bottom: 15px;
			flex-wrap: wrap;
			justify-content: center;
		}

		.day-tab-btn {
			padding: 10px 15px;
			border: 2px solid #ddd;
			background: white;
			border-radius: 20px;
			cursor: pointer;
			font-size: 13px;
			font-weight: bold;
			transition: all 0.3s ease;
			min-width: 100px;
		}

		.day-tab-btn:hover {
			background: #f8f9fa;
			border-color: #3498db;
		}

		.day-tab-btn.active {
			background: #3498db;
			color: white;
			border-color: #3498db;
		}

		.days-content {
			min-height: 200px;
		}

		.day-content {
			display: none;
		}

		.day-content.active {
			display: block;
		}
		
		.day-content-header {
			padding: 10px 15px;
			background: #f8f9fa;
			border-radius: 8px;
			margin-bottom: 15px;
			text-align: center;
			font-weight: 600;
			color: #2c3e50;
			border: 2px solid #e9ecef;
		}
		
		/* תגובה למובייל לטאבי ימים */
		@media (max-width: 768px) {
			.days-tabs {
				flex-direction: row;
				justify-content: center;
				gap: 5px;
				flex-wrap: wrap;
			}
			
			.day-tab-btn {
				min-width: 40px;
				max-width: 60px;
				padding: 8px 10px;
				font-size: 13px;
			}
			
			.days-content {
				min-height: 150px;
			}
		}

		/* אנימציה חלקה לתוכן הימים */
		.day-content {
			opacity: 0;
			transition: opacity 0.3s ease;
		}

		.day-content.active {
			display: block;
			opacity: 1;
		}

		/* שיפור לכותרת המכיל */
		.days-tabs-container {
			background: rgba(255,255,255,0.7);
			border-radius: 12px;
			padding: 15px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
		}

		.week-btn {
			background: #28a745;
			color: white;
			border: none;
			padding: 4px 6px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 10px;
			margin-left: 2px;
		}

		.week-btn:hover {
			background: #218838;
			transform: scale(1.05);
		}

		.week-btn-double {
			background: #17a2b8;
		}

		.week-btn-double:hover {
			background: #138496;
		}


		/* Notes row styles */
		.notes-row {
			background-color: #f8f9fa;
			border-top: none !important;
		}

		.notes-cell {
			padding: 8px 15px !important;
			border-top: 1px dashed #dee2e6 !important;
		}

		.notes-content {
			font-size: 13px;
			color: #495057;
			font-style: italic;
			background: #e9ecef;
			padding: 8px 12px;
			border-radius: 6px;
			border-left: 4px solid #6c757d;
		}

		/* Button styles */
		.btn {
			padding: 8px 16px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 12px;
			font-weight: bold;
			transition: all 0.3s ease;
		}

		.btn-secondary {
			background: #6c757d;
			color: white;
		}

		.btn-secondary:hover {
			background: #5a6268;
			transform: translateY(-1px);
		}

		/****************************/
		
		/* Payment status indicators */
		.payment-status-1 {
			color: #27ae60;
			font-weight: bold;
			background: #d5f4e6;
			padding: 2px 6px;
			border-radius: 4px;
			font-size: 12px;
		}

		.payment-status-0 {
			color: #e74c3c;
			font-weight: bold;
			background: #fadbd8;
			padding: 2px 6px;
			border-radius: 4px;
			font-size: 12px;
		}

		.payment-status-2 {
			color: #f39c12;
			font-weight: bold;
			background: #fef5e7;
			padding: 2px 6px;
			border-radius: 4px;
			font-size: 12px;
		}

		/* Performance optimization - reduce animations on large tables */
		.data-table tbody tr {
			transition: none; /* הסר אנימציות בטבלאות גדולות */
		}

		.data-table tbody tr:hover {
			background: #f8f9fa;
			transform: none; /* הסר scale effect שגורם לאיטיות */
		}

		/* Loading indicator */
		.loading-indicator {
			text-align: center;
			padding: 20px;
			color: #666;
			font-style: italic;
		}

		.loading-indicator::before {
			content: "⏳ ";
		}

		/* Quick filter buttons */
		.filter-quick-btn {
			background: #3498db;
			color: white;
			border: none;
			padding: 6px 10px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 11px;
			font-weight: bold;
			transition: all 0.3s ease;
			margin-right: 4px;
		}

		.filter-quick-btn:hover {
			background: #2980b9;
			transform: translateY(-1px);
		}

		.filter-quick-btn.active {
			background: #27ae60;
		}

		.filter-quick-btn.active:hover {
			background: #219a52;
		}


		.payment-btn {
			background: #28a745;
			color: white;
			border: none;
			padding: 4px 8px;
			border-radius: 3px;
			cursor: pointer;
			margin-right: 5px;
			font-size: 14px;
		}

		.payment-btn:hover {
			background: #218838;
		}

		/* עיצוב חלונית תשלום */
			
		.visits-list {
			max-height: 250px;
			overflow-y: auto;
			border: 2px solid #ddd;
			border-radius: 8px;
			padding: 0; /* ✅ הסרת padding מהמכיל */
			margin: 10px 0;
			background: #f9f9f9;
		}

		.visit-item {
			display: grid; /* ✅ שינוי מ-flex לגריד */
			grid-template-columns: 40px 1fr 80px; /* ✅ רוחבים קבועים */
			align-items: center;
			padding: 12px;
			border-bottom: 1px solid #eee;
			cursor: pointer;
			transition: background-color 0.2s;
			border-radius: 0; /* ✅ ביטול border-radius פנימי */
			margin-bottom: 0; /* ✅ ביטול margin */
			gap: 10px; /* ✅ רווח קבוע בין העמודות */
		}

		.visit-item:hover {
			background: #f0f0f0;
		}

		.visit-item:last-child {
			border-bottom: none;
		}

		.visit-checkbox {
			width: 18px; /* ✅ רוחב קבוע */
			height: 18px; /* ✅ גובה קבוע */
			margin: 0; /* ✅ ביטול margin */
			cursor: pointer;
			justify-self: center; /* ✅ מרכז בתא הגריד */
		}

		.visit-details {
			line-height: 1.4;
			min-width: 0; /* ✅ מאפשר word-wrap */
		}

		.visit-details div:first-child {
			font-weight: bold;
			color: #2c3e50;
			margin-bottom: 2px;
		}

		.visit-details div:last-child {
			font-size: 12px;
			color: #666;
			white-space: nowrap; /* ✅ מונע שבירת שורה */
			overflow: hidden;
			text-overflow: ellipsis; /* ✅ נקודות אם הטקסט ארוך מדי */
		}

		.visit-amount {
			font-weight: bold;
			color: #27ae60;
			text-align: left;
			font-size: 15px;
			justify-self: start; /* ✅ יישור לשמאל בתא הגריד */
		}

		/* תגובה למובייל */
		@media (max-width: 600px) {
			.visit-item {
				grid-template-columns: 35px 1fr 70px; /* ✅ קצת יותר קטן במובייל */
				padding: 10px;
				gap: 8px;
			}
			
			.visit-checkbox {
				width: 16px;
				height: 16px;
			}
			
			.visit-amount {
				font-size: 14px;
			}
			
			.visit-details div:first-child {
				font-size: 13px;
			}
			
			.visit-details div:last-child {
				font-size: 11px;
			}
		}

		.form-row {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 15px;
			margin-bottom: 15px;
		}

		.form-group {
			display: flex;
			flex-direction: column;
		}

		.form-group label {
			margin-bottom: 5px;
			font-weight: bold;
			color: #333;
		}

		#paymentDetailsSection {
			background: #f8f9fa;
			padding: 15px;
			border-radius: 8px;
			margin-top: 15px;
		}

		.payment-status-select {
			padding: 4px 8px;
			border: 1px solid #ddd;
			border-radius: 3px;
			font-size: 12px;
			background: white;
			cursor: pointer;
			min-width: 100px;
		}

		.payment-status-select:focus {
			outline: none;
			border-color: #007bff;
			box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
		}



		.client-option {
			padding: 10px;
			cursor: pointer;
			border-bottom: 1px solid #eee;
		}

		.client-option:hover {
			background-color: #f8f9fa;
		}

		.client-option:last-child {
			border-bottom: none;
		}

		/* עיצוב שורות פרטים */
		.details-row {
			background-color: #f8f9fa !important;
			border-top: none !important;
		}

		.details-row td {
			padding: 15px !important;
			border-top: 1px solid #e0e0e0 !important;
		}

		.visit-details-content {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 12px;
			font-size: 13px;
			line-height: 1.6;
		}

		.visit-details-content > div {
			padding: 5px 0;
		}

		.visit-details-content strong {
			color: #666;
			font-size: 12px;
			display: block;
			margin-bottom: 3px;
		}

		@media (max-width: 768px) {
			.visit-details-content {
				grid-template-columns: 1fr;
				gap: 8px;
			}
		}

		.details-row:hover {
			background-color: #f1f3f4 !important;
		}

		.details-cell {
			padding: 10px 15px !important;
			border-top: 1px dashed #dee2e6 !important;
		}

		.details-content {
			font-size: 13px;
			color: #495057;
			line-height: 1.4;
		}

		.work-done-column {
		  width: 350px; /* רוחב קבוע */
		  max-width: 350px; /* לוודא שלא עובר את הרוחב הזה */
		  overflow: hidden; /* הסתרת טקסט חורג */
		  text-overflow: ellipsis; /* הוספת '...' בסוף אם הטקסט נחתך */
		  white-space: nowrap; /* למנוע שבירת שורות */
		}

		.work-done-section {
			background: #e3f2fd;
			padding: 8px 12px;
			border-radius: 6px;
			border-left: 4px solid #2196f3;
			margin-bottom: 8px;
		}

		.notes-section {
			background: #fff3e0;
			padding: 8px 12px;
			border-radius: 6px;
			border-left: 4px solid #ff9800;
			font-style: italic;
		}

		.work-done-section strong,
		.notes-section strong {
			color: #2c3e50;
			font-size: 12px;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		/* שיפור לטבלה הראשית */
		.data-table tbody tr.main-row {
			border-bottom: 1px solid #e9ecef;
		}

		.data-table tbody tr.details-row {
			border-bottom: 2px solid #dee2e6;
		}

		/* אופטימיזציה למובייל */
		@media (max-width: 768px) {
			.details-content {
				font-size: 12px;
			}
			
			.work-done-section,
			.notes-section {
				padding: 6px 8px;
				margin-bottom: 6px;
			}
		}

		/* תיקון z-index לחלונית התשלום */
		#paymentModal {
			position: fixed !important;
			top: 0 !important;
			left: 0 !important;
			width: 100% !important;
			height: 100% !important;
			background: rgba(0,0,0,0.7) !important;
			display: flex !important;
			justify-content: center !important;
			align-items: center !important;
			z-index: 99999 !important; /* גבוה מאוד! */
			backdrop-filter: blur(3px);
		}

		#paymentModal .modal-content {
			background: white !important;
			border-radius: 12px !important;
			max-width: 600px !important;
			width: 90vw !important;
			max-height: 85vh !important;
			overflow-y: auto !important;
			position: relative !important;
			z-index: 100000 !important; /* עוד יותר גבוה! */
			box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important;
		}

		/* וידוא שגם החלוניות האחרות יעבדו */
		#editModal {
			z-index: 99998 !important;
		}

		#telegramModal {
			z-index: 99997 !important;
		}

		/* הסתרת scroll של הגוף כשחלונית פתוחה */
		body.modal-open {
			overflow: hidden;
		}

		/* עיצוב שורות פרטים בטבלת הטיפולים */
		.data-table tbody tr.main-row {
			border-bottom: 1px solid #e9ecef;
		}

		.data-table tbody tr.details-row {
			background-color: #f8f9fa !important;
			border-top: none !important;
			border-bottom: 2px solid #dee2e6;
		}

		.data-table tbody tr.details-row:hover {
			background-color: #f1f3f4 !important;
		}

		.details-cell {
			padding: 10px 15px !important;
			border-top: 1px dashed #dee2e6 !important;
		}

		.details-content {
			font-size: 13px;
			color: #495057;
			line-height: 1.4;
		}

		.work-done-section {
			background: #e3f2fd;
			padding: 8px 12px;
			border-radius: 6px;
			border-left: 4px solid #2196f3;
			margin-bottom: 8px;
		}

		.notes-section {
			background: #fff3e0;
			padding: 8px 12px;
			border-radius: 6px;
			border-left: 4px solid #ff9800;
			font-style: italic;
		}

		.work-done-section strong,
		.notes-section strong {
			color: #2c3e50;
			font-size: 12px;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		/* Badges לסוגי טיפול */
		.visit-type-badge {
			padding: 4px 8px;
			border-radius: 12px;
			font-size: 11px;
			font-weight: bold;
			text-transform: uppercase;
		}

		.visit-type-מלא {
			background: #d4edda;
			color: #155724;
		}

		.visit-type-חלקי {
			background: #fff3cd;
			color: #856404;
		}

		.visit-type-ביקורת {
			background: #d1ecf1;
			color: #0c5460;
		}

		.visit-type-other {
			background: #f8d7da;
			color: #721c24;
		}

		.duration-badge {
			background: #e7f3ff;
			color: #0366d6;
			padding: 2px 6px;
			border-radius: 8px;
			font-size: 11px;
			font-weight: bold;
		}

		/* אופטימיזציה למובייל */
		@media (max-width: 768px) {
			.details-content {
				font-size: 12px;
			}
			
			.work-done-section,
			.notes-section {
				padding: 6px 8px;
				margin-bottom: 6px;
			}
			
			.visit-type-badge,
			.duration-badge {
				font-size: 10px;
				padding: 2px 4px;
			}
		}

		/* תיקון חיוני - החלונית צריכה להיות מוסתרת כברירת מחדל */
		#paymentModal {
			position: fixed !important;
			top: 0 !important;
			left: 0 !important;
			width: 100% !important;
			height: 100% !important;
			background: rgba(0,0,0,0.7) !important;
			display: none !important; /* ✅ שינוי קריטי - none במקום flex! */
			justify-content: center !important;
			align-items: center !important;
			z-index: 99999 !important;
			backdrop-filter: blur(3px);
		}

		/* כשהחלונית פתוחה - אז תהיה flex */
		#paymentModal.show {
			display: flex !important;
		}


		/* שיפורים נוספים לחלונית התשלום */
		.payment-summary {
			background: #e8f5e8;
			border: 2px solid #27ae60;
			border-radius: 8px;
			padding: 15px;
			margin: 15px 0;
			text-align: center;
			font-size: 16px;
			color: #155724;
		}

		.visits-list {
			max-height: 250px;
			overflow-y: auto;
			border: 2px solid #ddd;
			border-radius: 8px;
			padding: 10px;
			margin: 10px 0;
			background: #f9f9f9;
		}

		.visit-item {
			display: flex;
			align-items: center;
			padding: 10px;
			border-bottom: 1px solid #eee;
			cursor: pointer;
			transition: background-color 0.2s;
			border-radius: 6px;
			margin-bottom: 5px;
		}

		.visit-item:hover {
			background: #f0f0f0;
		}

		.visit-item:last-child {
			border-bottom: none;
			margin-bottom: 0;
		}

		.visit-checkbox {
			margin-left: 10px;
			transform: scale(1.3);
			cursor: pointer;
		}

		.visit-details {
			flex: 1;
			margin: 0 15px;
			line-height: 1.4;
		}

		.visit-amount {
			font-weight: bold;
			color: #27ae60;
			min-width: 80px;
			text-align: left;
			font-size: 15px;
		}

		.client-dropdown {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			background: white;
			border: 2px solid #3498db;
			border-top: none;
			max-height: 200px;
			overflow-y: auto;
			z-index: 1000;
			border-radius: 0 0 8px 8px;
			box-shadow: 0 4px 8px rgba(0,0,0,0.1);
		}

		.client-option {
			padding: 12px;
			cursor: pointer;
			border-bottom: 1px solid #eee;
			transition: background-color 0.2s;
		}

		.client-option:hover {
			background: #f8f9fa;
		}

		.client-option:last-child {
			border-bottom: none;
		}

		/* שיפור כפתורים */
		.btn:hover {
			transform: translateY(-1px);
			box-shadow: 0 4px 8px rgba(0,0,0,0.2);
		}

		.btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none !important;
			box-shadow: none !important;
		}

		/* ===== עיצוב משופר לכרטיסיות תכנון במובייל ===== */
		/* ===== עיצוב דחוס למובייל ===== */
		@media (max-width: 768px) {
			
			/* הכרטיסייה הראשית - דחוסה */
			.planning-client-row {
				padding: 10px;
				margin-bottom: 8px;
				border-radius: 8px;
				background: white;
				box-shadow: 0 2px 6px rgba(0,0,0,0.1);
			}
			
			/* שם הלקוח - קטן יותר */
			.planning-client-header {
				margin-bottom: 8px;
				padding-bottom: 6px;
				border-bottom: 1px solid #e0e0e0;
			}
			
			.planning-client-name-large {
				font-size: 15px;
				font-weight: 600;
				color: #2c3e50;
				line-height: 1.2;
				
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
				max-width: 200px;
			}
			
			/* הסתרת שדות ישנים */
			.planning-client-info,
			.planning-client-price,
			.planning-client-actions {
				display: none;
			}
			
			/* קטע התאריכים - דחוס */
			.planning-dates-section {
				margin-bottom: 8px;
				padding: 6px 8px;
				background: #f8f9fa;
				border-radius: 6px;
			}
			
			.planning-date-item {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 4px;
				padding: 2px 0;
			}
			
			.planning-date-item:last-child {
				margin-bottom: 0;
			}
			
			.date-label {
				font-size: 13px;
				color: #666;
				font-weight: 500;
			}
			
			.date-value {
				font-size: 14px;
				font-weight: 600;
				color: #2c3e50;
			}
			
			/* סכום - קטן */
			.planning-amount-small {
				font-size: 12px;
				color: #999;
				text-align: center;
				margin-top: 4px;
				padding-top: 4px;
				border-top: 1px solid #e9ecef;
			}
			
			/* שורת כפתורים - דחוסה */
			.planning-actions-row {
				display: flex;
				gap: 6px;
				margin-bottom: 8px;
			}
			
			.week-btn-mobile {
				flex: 1;
				min-width: 60px;
				padding: 8px 10px;
				background: #28a745 !important;
				color: white !important;
				border: none;
				border-radius: 5px;
				font-size: 13px;
				font-weight: 600;
				cursor: pointer;
			}
			
			.week-btn-mobile:active {
				transform: scale(0.95);
			}
			
			.start-treatment-btn-mobile {
				min-width: 50px;
				padding: 8px 14px;
				background: #ff9800;
				color: white;
				border: none;
				border-radius: 5px;
				font-size: 18px;
				cursor: pointer;
			}
			
			.profile-btn-mobile:active {
				transform: scale(0.95);
			}
			
			.profile-btn-mobile {
				padding: 8px 12px;
				background: white !important;
				color: #007bff !important;
				border: 2px solid #007bff !important;
				border-radius: 5px;
				font-size: 16px;
				cursor: pointer;
			}
			
			.calendar-btn-mobile {
				padding: 8px 12px;
				background: #f8f9fa;
				color: #333;
				border: 1px solid #ddd;
				border-radius: 5px;
				font-size: 16px;
				cursor: pointer;
			}
			
			.calendar-btn-mobile:active {
				transform: scale(0.95);
				background: #e9ecef;
			}
			
			.active-checkbox-mobile {
				display: flex;
				align-items: center;
				justify-content: center;
				min-width: 44px;
				padding: 8px;
				background: #f8f9fa;
				border: 1px solid #ddd;
				border-radius: 5px;
				cursor: pointer;
			}
			
			.active-checkbox-mobile input[type="checkbox"] {
				width: 20px;
				height: 20px;
				margin: 0;
				cursor: pointer;
			}
			
			.active-checkbox-mobile span {
				display: none; /* הסתרת הטקסט */
			}
			
			/* שורת תאריך והתחלה */
			.planning-date-row {
				display: flex;
				gap: 6px;
				align-items: center;
			}
			
			.planning-date-input-mobile {
				flex: 1;
				min-width: 120px;
				padding: 8px;
				border: 1px solid #ddd;
				border-radius: 5px;
				font-size: 13px;
			}
			
			.start-treatment-btn-mobile {
				min-width: 50px;
				padding: 8px 14px;
				background: #ff9800 !important;
				color: white !important;
				border: none;
				border-radius: 5px;
				font-size: 18px;
				cursor: pointer;
			}
			
			.start-treatment-btn-mobile:active {
				transform: scale(0.95);
			}
			
			/* הערות - קטנות */
			.planning-row-details {
				margin-top: 8px;
				padding-top: 8px;
				border-top: 1px solid #e0e0e0;
			}
			
			.client-requests,
			.client-notes {
				padding: 6px;
				margin-bottom: 4px;
				background: #fff3cd;
				border-left: 3px solid #ffc107;
				border-radius: 4px;
				font-size: 12px;
				line-height: 1.3;
			}
			
			.client-notes {
				background: #d1ecf1;
				border-left-color: #17a2b8;
			}
		}

		/* Loading Overlay */
		.loading-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.6);
			backdrop-filter: blur(3px);
			display: flex;
			justify-content: center;
			align-items: center;
			z-index: 10000;
			transition: opacity 0.2s ease;
		}

		.loading-overlay.hidden {
			display: none;
		}

		.loading-content {
			background: white;
			padding: 30px 50px;
			border-radius: 12px;
			text-align: center;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 5px solid #f3f3f3;
			border-top: 5px solid #3498db;
			border-radius: 50%;
			margin: 0 auto 15px;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

		.loading-text {
			font-size: 18px;
			font-weight: 600;
			color: #2c3e50;
			margin-top: 10px;
		}
	
		/* Filter Panel Collapse */
		.filter-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 12px 15px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			border-radius: 8px 8px 0 0;
			cursor: pointer;
			user-select: none;
			margin-bottom: 0;
		}

		.filter-header h3 {
			color: white;
			font-size: 16px;
			margin: 0;
			font-weight: bold;
		}

		.filter-toggle-btn {
			background: rgba(255, 255, 255, 0.2);
			border: 1px solid rgba(255, 255, 255, 0.3);
			color: white;
			padding: 5px 12px;
			border-radius: 5px;
			cursor: pointer;
			font-size: 14px;
			transition: all 0.3s ease;
		}

		.filter-toggle-btn:hover {
			background: rgba(255, 255, 255, 0.3);
			transform: scale(1.05);
		}

		.filter-content {
			max-height: 1000px;
			overflow: hidden;
			transition: max-height 0.3s ease, opacity 0.3s ease;
			opacity: 1;
		}

		.filter-content.collapsed {
			max-height: 0;
			opacity: 0;
			margin: 0;
			padding: 0;
		}

		.filters-container {
			border: 2px solid #667eea;
			border-radius: 8px;
			margin-bottom: 20px;
			overflow: hidden;
		}
	
	
		/* Mobile Expandable Rows */
		.mobile-optimized tbody tr {
			cursor: pointer;
			transition: background-color 0.2s;
		}

		.mobile-optimized tbody tr:hover {
			background-color: #f8f9fa;
		}

		.mobile-optimized .details-row {
			display: none;
			background-color: #f8f9fa !important;
		}

		.mobile-optimized .details-row.expanded {
			display: table-row;
		}

		.mobile-optimized .details-row td {
			padding: 12px 15px;
			border-top: none !important;
		}

		.mobile-optimized .details-content {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 10px;
			font-size: 13px;
		}

		.mobile-optimized .detail-item {
			display: flex;
			flex-direction: column;
		}

		.mobile-optimized .detail-label {
			font-weight: bold;
			color: #666;
			font-size: 11px;
			margin-bottom: 3px;
		}

		.mobile-optimized .detail-value {
			color: #2c3e50;
		}

		/* Mobile specific adjustments */
		@media (max-width: 768px) {
			.mobile-optimized th,
			.mobile-optimized .main-row td {
				padding: 10px 8px;
				font-size: 13px;
			}
			
			.mobile-optimized .action-btn {
				padding: 6px 10px;
				font-size: 11px;
				margin: 2px;
			}
			
			.mobile-optimized .details-content {
				grid-template-columns: 1fr;
				gap: 8px;
			}
		}

		/* Expand indicator */
		.mobile-optimized .main-row td:first-child::before {
			content: '▶';
			display: inline-block;
			margin-left: 5px;
			font-size: 10px;
			color: #3498db;
			transition: transform 0.3s;
		}

		.mobile-optimized .main-row.expanded td:first-child::before {
			transform: rotate(90deg);
		}
	
	
		/* Modal Container - Fixed Position */
		#modalContainer {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.7);
			justify-content: center;
			align-items: center;
			z-index: 10000;
			overflow-y: auto;
			padding: 20px;
			box-sizing: border-box;
		}

		#modalContainer > div {
			max-height: 90vh;
			overflow-y: auto;
		}
	
	
	</style>
   
</head>
<body>
	<!-- Toast Container -->
	<div id="toastContainer" class="toast-container"></div>
    <div class="container">
        <header class="header">
            <h1>טיפולים</h1>
				<div id="headerConnectionStatus" class="connection-status" style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
					<!-- שורה 1: תווית -->
					<div style="font-size: 14px; color: white; font-weight: bold;">
						☁️ חיבור ל-Google Sheets
					</div>
					
					<!-- שורה 2: כפתורים -->
					<div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
						<button onclick="connectToGoogleSheets()" id="connectBtn" class="connect-btn" style="padding: 8px 16px; font-size: 13px;">
							התחבר
						</button>
						<button onclick="saveAllToSheets()" id="saveBtn" class="connect-btn" disabled style="padding: 8px 16px; font-size: 13px;">
							שמור
						</button>
						<button onclick="loadAllFromSheets()" id="loadBtn" class="connect-btn" disabled style="padding: 8px 16px; font-size: 13px;">
							טען
						</button>
						<button onclick="disconnectFromCloud()" class="connect-btn" style="padding: 8px 16px; font-size: 13px; background: #e74c3c; color: white;">
							התנתק
						</button>
					</div>
					
					<!-- שורה 3: סטטוס -->
					<div id="statusText" style="color: white; font-weight: bold; font-size: 14px; text-align: center;">
						⚪ לא מחובר
					</div>
					
					<!-- שורה 4: זמן אחרון -->
					<div id="lastSaved" style="font-size: 11px; color: rgba(255,255,255,0.8); text-align: center;"></div>
				</div>
           <nav class="nav-buttons">
				<button onclick="showSection('planning')" class="nav-btn active">תכנון</button>
				<button onclick="showSection('history')" class="nav-btn">טיפולים</button> 
				<button onclick="showSection('locations')" class="nav-btn">לקוחות</button>
				<button onclick="showSection('receipts')" class="nav-btn">קבלות</button>
				<button onclick="showSection('debts')" class="nav-btn">💰 חובות</button>
				<button onclick="showSection('payments')" class="nav-btn">💳 תשלומים</button>
				<button onclick="showSection('tasks')" class="nav-btn">📋 משימות</button>
				<button onclick="showSection('expenses')" class="nav-btn">💰 הוצאות</button>
				<button onclick="showSection('system')" class="nav-btn">מערכת v3.3</button>
				
				<!-- Client selector - only visible when locked -->
				<button onclick="toggleClientLock()" class="nav-btn lock-btn" id="lockBtn" title="נעילת סינכרון לקוחות">
					🔓
				</button>
				<select id="lockClientSelector" onchange="selectClientForLock(this.value)" style="display: none; padding: 8px; border: 2px solid #28a745; border-radius: 5px; background: #d4edda; color: #155724; font-size: 13px; min-width: 150px;">
					<option value="">בחר לקוח...</option>
				</select>
			</nav>
        </header>

        <main class="main-content">
            <!-- Planning Section -->
			<section id="planning" class="section active">
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
					<h2 style="margin: 0;">📅 תכנון יומי ושבועי</h2>
					<button onclick="showScheduleClientModal()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
						📅 זמן לקוח
					</button>
				</div>
					
			   <!-- מצב יום עבודה -->
				<div class="work-day-section" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #28a745; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
					<h3 style="margin: 0 0 15px 0; color: #28a745; font-size: 18px; display: flex; align-items: center; gap: 8px;">
						🏃‍♂️ הטיפולים שלי היום
						<span id="todayWorkStatus" style="font-size: 14px; color: #666; font-weight: normal;"></span>
					</h3>
					
					<div id="todayTreatmentsContainer">
						<!-- הטיפולים של היום יוכנסו כאן דינמית -->
					</div>
					
					<div style="text-align: center; margin-top: 15px;">
						<button onclick="refreshTodayTreatments()" class="btn" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
							🔄 רענן
						</button>
					</div>
				</div>
				
				<!-- טאבים -->
				<div class="planning-view-tabs">
					<button class="planning-tab-btn active" onclick="switchPlanningView('daily')">היום</button>
					<button class="planning-tab-btn" onclick="switchPlanningView('weekly')">השבוע</button>
					<button class="planning-tab-btn" onclick="switchPlanningView('next_week')">הבא</button>
					<button class="planning-tab-btn" onclick="switchPlanningView('overdue')">איחור</button>
					<button class="planning-tab-btn" onclick="switchPlanningView('future')">עתידי</button>
				</div>

				<!-- כרטיסי לקוחות -->
				<div class="planning-cards-container" id="planningCardsContainer">
					<!-- כרטיסים יטענו כאן דינמית -->
				</div>

				<!-- סטטיסטיקות (שמירה על הקיים) -->
				<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
					<div style="background: rgba(52, 152, 219, 0.1); border: 2px solid #3498db; border-radius: 8px; padding: 12px;">
						<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
							<span style="font-size: 13px; color: #2c3e50;">לקוחות:</span>
							<span id="totalLocations" style="font-weight: bold; color: #2c3e50;">0</span>
						</div>
						<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
							<span style="font-size: 13px; color: #2c3e50;">פעילים:</span>
							<span id="activeLocations" style="font-weight: bold; color: #27ae60;">0</span>
						</div>
						<div style="display: flex; justify-content: space-between;">
							<span style="font-size: 13px; color: #2c3e50;">טיפולים השבוע:</span>
							<span id="weeklyVisits" style="font-weight: bold; color: #2c3e50;">0</span>
						</div>
					</div>
					
					<div style="background: rgba(39, 174, 96, 0.1); border: 2px solid #27ae60; border-radius: 8px; padding: 12px;">
						<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
							<span style="font-size: 13px; color: #2c3e50;">הכנסה השבוע:</span>
							<span id="weeklyIncome" style="font-weight: bold; color: #27ae60;">₪0</span>
						</div>
						<div style="display: flex; justify-content: space-between;">
							<span style="font-size: 13px; color: #2c3e50;">חובות פתוחים:</span>
							<span id="openDebts" style="font-weight: bold; color: #e74c3c;">₪0</span>
						</div>
					</div>
				</div>
			</section>

			<!-- History Section -->
			<section id="history" class="section">
				<h2>📋 טיפולים</h2>
					<div style="display: flex; gap: 10px; margin-bottom: 20px;">
						<button onclick="showVisitForm()" class="add-btn">➕ הוסף טיפול חדש</button>
						<button onclick="showAddPaymentModal()" class="add-btn" style="background: linear-gradient(45deg, #f39c12, #e67e22);">💰 תשלום חדש</button>
					</div>
					
				<!-- Filter Panel -->
				<div class="filters-container">
					<div class="filter-header" onclick="toggleFilterPanel('visitsFilterContent')">
						<h3>🔍 סינון טיפולים</h3>
						<button type="button" class="filter-toggle-btn" onclick="event.stopPropagation(); toggleFilterPanel('visitsFilterContent')">🔼 כווץ</button>
					</div>
					<div id="visitsFilterContent" class="filter-content">
						<div class="filter-panel-unified" style="border: none; margin: 0;">
							<div class="filter-panel-header" style="background: transparent; border: none; padding-top: 0;">
								<div style="display: flex; gap: 8px; width: 100%;">
									<button onclick="setQuickDateFilter('today')" class="filter-quick-btn">היום</button>
									<button onclick="setQuickDateFilter('week')" class="filter-quick-btn">השבוע</button>
									<button onclick="setQuickDateFilter('month')" class="filter-quick-btn active">החודש</button>
									<button onclick="clearVisitFilters()" class="filter-clear-btn">נקה סינון</button>
								</div>
							</div>
							
							<div class="filter-row-unified">
								<div class="filter-group-unified">
									<label>חיפוש חכם:</label>
									<input type="text" id="visitSmartSearch" placeholder="חפש לקוח לפי שם, כתובת, עיר..." 
										   oninput="handleVisitSmartSearch(this.value)">
								</div>
								<div class="filter-group-unified small">
									<button type="button" onclick="clearVisitSmartSearch()" class="filter-clear-btn">נקה חיפוש</button>
								</div>
								<div class="filter-group-unified medium">
									<label>סטטוס תשלום:</label>
									<select id="filterPayment" onchange="applyVisitFilters()">
										<option value="">הכל</option>
										<option value="1">שולם</option>
										<option value="0">לא שולם</option>
										<option value="3">חלקי</option>
										<option value="2">ללא תשלום</option>
									</select>
								</div>
								<div class="filter-group-unified small">
									<label>מקסימום תוצאות:</label>
									<select id="maxResults" onchange="applyVisitFilters()">
										<option value="50">50</option>
										<option value="100">100</option>
										<option value="200" selected>200</option>
										<option value="500">500</option>
									</select>
								</div>
							</div>
							
							<div class="filter-row-unified">
								<div class="filter-group-unified compact">
									<label>מתאריך:</label>
									<input type="date" id="filterDateFrom" onchange="applyVisitFilters()">
								</div>
								<div class="filter-group-unified compact">
									<label>עד תאריך:</label>
									<input type="date" id="filterDateTo" onchange="applyVisitFilters()">
								</div>
								<div class="filter-group-unified small">
									<label>הצג לקוחות:</label>
									<select id="filterActiveClients" onchange="applyVisitFilters()">
										<option value="1" selected>פעילים בלבד</option>
										<option value="">כל הלקוחות</option>
										<option value="0">לא פעילים</option>
									</select>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Treatments Stats Box -->
				<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
					<div id="treatmentsStatsBox" style="background: #e8f5e8; border: 1px solid #27ae60; border-radius: 6px; padding: 8px 12px; font-size: 13px; color: #2c3e50;">
						<span id="treatmentsCount">0</span> טיפולים מוצגים
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #27ae60; font-weight: bold;" id="treatmentsTotal">₪0</span> סה"כ הכנסות
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #3498db; font-weight: bold;" id="treatmentsPaid">0</span> שולמו
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #e74c3c; font-weight: bold;" id="treatmentsUnpaid">0</span> לא שולמו
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #ff6b35; font-weight: bold;" id="treatmentsDebts">₪0</span> חובות פתוחים
					</div>
				</div>

				<!-- Visits Table -->
				<div class="table-container">
					<table id="visitsHistoryTable" class="data-table">
						<thead>
							<tr>
								<th>תאריך</th>
								<th>לקוח</th>
								<th>סכום</th>
								<th>פעולות</th>
							</tr>
						</thead>
						<tbody id="visitsHistoryTableBody">
						</tbody>
					</table>
				</div>
			</section>

           <!-- locations Section -->
            <section id="locations" class="section">
                <h2>ניהול לקוחות</h2>
                
                <!-- כפתור הוספה למעלה -->
                <button onclick="showAddLocationForm()" class="add-btn">הוסף לקוח חדש</button>
                
				<!-- פאנל סינון -->
				<div class="filters-container">
					<div class="filter-header" onclick="toggleFilterPanel('locationsFilterContent')">
						<h3>🔍 סינון לקוחות</h3>
						<button type="button" class="filter-toggle-btn" onclick="event.stopPropagation(); toggleFilterPanel('locationsFilterContent')">🔼 כווץ</button>
					</div>
					<div id="locationsFilterContent" class="filter-content">
						<div class="filter-panel-compact" style="background: #f8f9fa; padding: 15px; border-radius: 0 0 8px 8px;">
						<div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
							<div style="flex: 1; min-width: 150px;">
								<label style="font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block;">שם לקוח:</label>
								<input type="text" id="filterClientName" placeholder="חפש לקוח..." onkeyup="filterLocationsTable()" 
									   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
							</div>
							
							<div style="flex: 0 0 120px;">
								<label style="font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block;">יום מועדף:</label>
								<select id="filterDay" onchange="filterLocationsTable()" 
										style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
									<option value="">כל הימים</option>
									<option value="כל יום">כל יום</option>
									<option value="א">א (ראשון)</option>
									<option value="ב">ב (שני)</option>
									<option value="ג">ג (שלישי)</option>
									<option value="ד">ד (רביעי)</option>
									<option value="ה">ה (חמישי)</option>
									<option value="ו">ו (שישי)</option>
									<option value="ש">ש (שבת)</option>
								</select>
							</div>
							
							<div style="flex: 0 0 100px;">
								<label style="font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block;">מרווח שבועות:</label>
								<select id="filterInterval" onchange="filterLocationsTable()" 
										style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
									<option value="">הכל</option>
									<option value="1">1</option>
									<option value="2">2</option>
									<option value="4">4</option>
									<option value="8">8</option>
									<option value="12">12</option>
									<option value="52">52</option>
								</select>
							</div>
							
							<div style="flex: 0 0 100px;">
								<label style="font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block;">סטטוס:</label>
								<select id="filterActive" onchange="filterLocationsTable()" 
										style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
									<option value="">הכל</option>
									<option value="1" selected>פעיל</option>
									<option value="0">לא פעיל</option>
								</select>
							</div>
							
							<div style="flex: 0 0 80px;">
								<button onclick="clearLocationFilters()" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 20px;">
									נקה סינון
								</button>
							</div>
						</div>
					</div>
				</div>
				
				<!-- סטטיסטיקה -->
				<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
					<div id="locationsStatsBox" style="background: #e8f4fd; border: 1px solid #3498db; border-radius: 6px; padding: 8px 12px; font-size: 13px; color: #2c3e50;">
						<span id="locationsCount">0</span> לקוחות מוצגים
						<span style="margin-right: 10px; color: #666;">|</span>
						<span style="color: #27ae60; font-weight: bold;" id="activeCount">0</span> פעילים
						<span style="margin-right: 10px; color: #666;">|</span>
						<span style="color: #e74c3c; font-weight: bold;" id="inactiveCount">0</span> לא פעילים
					</div>
				</div>
				
                <div class="table-container">
                    <table id="locationsTable" class="data-table mobile-optimized">
                        <thead>
							<tr>
								<th>שם</th>
								<th>כתובת</th>
								<th>פעולות</th>
							</tr>
						</thead>
                        <tbody id="locationsTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Receipts Section -->
            <section id="receipts" class="section">
                <h2>ניהול קבלות</h2>
                <button onclick="showAddReceiptForm()" class="add-btn">הוסף קבלה חדשה</button>
				<!-- Unified Filter Panel for Receipts -->
				<div class="filters-container">
					<div class="filter-header" onclick="toggleFilterPanel('receiptsFilterContent')">
						<h3>🔍 סינון קבלות</h3>
						<button type="button" class="filter-toggle-btn" onclick="event.stopPropagation(); toggleFilterPanel('receiptsFilterContent')">🔼 כווץ</button>
					</div>
					<div id="receiptsFilterContent" class="filter-content">
						<div class="filter-panel-unified" style="border-radius: 0 0 8px 8px; border-top: none;">
							<div class="filter-panel-header" style="display: none;">
								<h4 class="filter-panel-title">🔍 סינון קבלות</h4>
								<button onclick="clearReceiptFilters()" class="filter-clear-btn">נקה סינון</button>
							</div>
					
							<div class="filter-row-unified">
								<div class="filter-group-unified">
									<label>חיפוש חכם:</label>
									<input type="text" id="receiptSmartSearch" placeholder="חפש לקוח לפי שם, כתובת, עיר..." 
										   oninput="handleReceiptSmartSearch(this.value)">
								</div>
								<div class="filter-group-unified small">
									<button type="button" onclick="clearReceiptSmartSearch()" class="filter-clear-btn">נקה חיפוש</button>
								</div>
							</div>

							<div class="filter-row-unified">
								<div class="filter-group-unified medium">
									<label>פנקס קבלות:</label>
									<select id="filterReceiptBook" onchange="applyReceiptFilters()">
										<option value="">כל הפנקסים</option>
									</select>
								</div>
								<div class="filter-group-unified medium">
									<label>סוג תשלום:</label>
									<select id="filterPaymentType" onchange="applyReceiptFilters()">
										<option value="">כל הסוגים</option>
										<option value="מזומן">מזומן</option>
										<option value="העברה">העברה</option>
										<option value="צ'ק">צ'ק</option>
										<option value="כרטיס אשראי">כרטיס אשראי</option>
									</select>
								</div>
							</div>
							
							<div class="filter-row-unified">
								<div class="filter-group-unified compact">
									<label>מתאריך:</label>
									<input type="date" id="filterReceiptDateFrom" onchange="applyReceiptFilters()">
								</div>
								<div class="filter-group-unified compact">
									<label>עד תאריך:</label>
									<input type="date" id="filterReceiptDateTo" onchange="applyReceiptFilters()">
								</div>
								<div class="filter-group-unified medium">
									<label>מיון:</label>
									<select id="receiptSortBy" onchange="applyReceiptFilters()">
										<option value="date_desc">תאריך (חדש לישן)</option>
										<option value="date_asc">תאריך (ישן לחדש)</option>
										<option value="amount_desc">סכום (גבוה לנמוך)</option>
										<option value="amount_asc">סכום (נמוך לגבוה)</option>
										<option value="book_asc">פנקס (לפי סדר)</option>
									</select>
								</div>
							</div>
						</div>
					</div>			
				</div>
				
				<!-- Receipt Stats Box -->
				<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
					<div id="receiptsStatsBox" style="background: #e8f4fd; border: 1px solid #3498db; border-radius: 6px; padding: 8px 12px; font-size: 13px; color: #2c3e50;">
						<span id="receiptsCount">0</span> קבלות מוצגות
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #27ae60; font-weight: bold;" id="receiptsTotal">₪0</span> סה"כ
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #3498db; font-weight: bold;" id="receiptsAverage">₪0</span> ממוצע
					</div>
				</div>
                <div class="table-container">
                    <table id="receiptsTable" class="data-table mobile-optimized">
						<thead>
							<tr>
								<th>תאריך</th>
								<th>לקוח</th>
								<th>סכום</th>
								<th>פעולות</th>
							</tr>
						</thead>
						<tbody id="receiptsTableBody">
						</tbody>
					</table>
                </div>
            </section>

			<section id="debts" class="section">
				<h2>💰 ניהול חובות</h2>
				
				<!-- Filters Section -->
				<div class="filters-container">
					<div class="filter-header" onclick="toggleFilterPanel('debtsFilterContent')">
						<h3>🔍 סינון חובות</h3>
						<button type="button" class="filter-toggle-btn" onclick="event.stopPropagation(); toggleFilterPanel('debtsFilterContent')">🔼 כווץ</button>
					</div>
					<div id="debtsFilterContent" class="filter-content">
						<div class="filter-panel-unified" style="border-radius: 0 0 8px 8px; border-top: none;">
							<div class="filter-panel-header" style="display: none;">
								<h4 class="filter-panel-title">🔍 סינון חובות</h4>
								<button onclick="clearDebtFilters()" class="filter-clear-btn">נקה סינון</button>
							</div>
					
							<div class="filter-row-unified">
								<div class="filter-group-unified medium">
									<label>מיון לפי:</label>
									<select id="debtSortBy" onchange="displayDebts()">
										<option value="amount_desc">סכום (גבוה לנמוך)</option>
										<option value="amount_asc">סכום (נמוך לגבוה)</option>
										<option value="date_old">תאריך (הכי ישן)</option>
										<option value="date_new">תאריך (הכי חדש)</option>
										<option value="location">לקוח (א-ת)</option>
									</select>
								</div>
								<div class="filter-group-unified compact">
									<label>סכום מינימלי:</label>
									<input type="number" id="minDebtAmount" placeholder="0" onchange="displayDebts()">
								</div>
							</div>
					
							<div class="filter-row-unified">
								<div class="filter-group-unified">
									<label>חיפוש/בחירת לקוח:</label>
									<input type="text" 
										   id="debtClientSearch" 
										   list="debtClientOptions"
										   placeholder="הקלד שם לקוח או בחר מהרשימה..."
										   onchange="handleDebtClientSelection(this.value)"
										   oninput="filterDebtClientOptions(this.value)"
										   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
									<datalist id="debtClientOptions">
										<!-- Options will be populated by JavaScript -->
									</datalist>
									<button type="button" 
											onclick="clearDebtClientSearch()" 
											style="margin-top: 5px; padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer;">
										נקה בחירה
									</button>
								</div>
								
								<div class="filter-group-unified compact">
									<label>יום מועדף:</label>
									<select id="debtDayFilter" onchange="displayDebts()">
										<option value="">כל הימים</option>
										<option value="כל יום">כל יום</option>
										<option value="א">א (ראשון)</option>
										<option value="ב">ב (שני)</option>
										<option value="ג">ג (שלישי)</option>
										<option value="ד">ד (רביעי)</option>
										<option value="ה">ה (חמישי)</option>
										<option value="ו">ו (שישי)</option>
										<option value="ש">ש (שבת)</option>
									</select>
								</div>
							</div>
						</div>
					</div>		
				</div>
				
				<!-- Debts Stats Box -->
				<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
					<div id="debtsStatsBox" style="background: #fdf2e8; border: 1px solid #f39c12; border-radius: 6px; padding: 8px 12px; font-size: 13px; color: #2c3e50;">
						<span id="debtsCount">0</span> חייבים מוצגים
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #e74c3c; font-weight: bold;" id="debtsTotal">₪0</span> סה"כ חוב
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #f39c12; font-weight: bold;" id="debtsAverage">₪0</span> ממוצע
					</div>
				</div>
				
				<div id="debtsContainer"></div>
				
			</section>

			<section id="payments" class="section">
				<h2>💳 ניהול תשלומים</h2>
				
				<div class="section-actions" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
					<button onclick="showAddPaymentModal()" class="btn" style="background: #27ae60; color: white; padding: 12px 25px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);">
						➕ הוסף תשלום חדש
					</button>
				</div>
				
				<!-- פאנל סינון -->
				<div class="filters-container">
					<div class="filter-header" onclick="toggleFilterPanel('paymentsFilterContent')">
						<h3>🔍 סינון תשלומים</h3>
						<button type="button" class="filter-toggle-btn" onclick="event.stopPropagation(); toggleFilterPanel('paymentsFilterContent')">🔼 כווץ</button>
					</div>
					<div id="paymentsFilterContent" class="filter-content" style="padding: 15px; background: #f8f9fa; border-radius: 0 0 8px 8px;">
						<!-- שורה 1: חיפוש חכם -->
						<div class="filter-row-unified">
							<div class="filter-group-unified">
								<label>חיפוש חכם:</label>
								<input type="text" 
									   id="paymentSmartSearch" 
									   placeholder="הקלד שם לקוח לחיפוש..."
									   oninput="handlePaymentSmartSearch(this.value)"
									   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
							</div>
							<div class="filter-group-unified small">
								<button type="button" 
										onclick="clearPaymentSmartSearch()" 
										class="filter-clear-btn">
									נקה חיפוש
								</button>
							</div>
						</div>

						<!-- שורה 2: תאריכים וסטטוס -->
						<div class="filter-row-unified">
							<div class="filter-group-unified compact">
								<label>מתאריך:</label>
								<input type="date" id="filterPaymentDateFrom" onchange="applyPaymentFilters()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
							</div>
							<div class="filter-group-unified compact">
								<label>עד תאריך:</label>
								<input type="date" id="filterPaymentDateTo" onchange="applyPaymentFilters()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
							</div>
							<div class="filter-group-unified compact">
								<label>סטטוס קישור:</label>
								<select id="filterPaymentLinkStatus" onchange="applyPaymentFilters()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
									<option value="">הכל</option>
									<option value="fully_linked">🟢 מקושר מלא</option>
									<option value="partially_linked">🟡 מקושר חלקית</option>
									<option value="unlinked">🔴 ממתין לקישור</option>
								</select>
							</div>
						</div>
					</div>
				</div>
				
				<!-- סטטיסטיקות -->
				<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
					<div id="paymentsStatsBox" style="background: #e8f5e8; border: 1px solid #27ae60; border-radius: 6px; padding: 8px 12px; font-size: 13px; color: #2c3e50;">
						<span id="paymentsCount">0</span> תשלומים מוצגים
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #27ae60; font-weight: bold;" id="paymentsTotal">₪0</span> סה"כ
						<span style="margin: 0 10px; color: #666;">|</span>
						<span style="color: #3498db; font-weight: bold;" id="paymentsAverage">₪0</span> ממוצע
					</div>
				</div>
				
				<!-- טבלת תשלומים -->
				<div class="table-container">
					<table id="paymentsTable" class="data-table mobile-optimized">
						<thead>
							<tr>
								<th>תאריך</th>
								<th>לקוח</th>
								<th>סכום</th>
								<th>סטטוס</th>
								<th>פעולות</th>
							</tr>
						</thead>
						<tbody id="paymentsTableBody">
						</tbody>
					</table>
				</div>
			</section>

			<!-- System Section -->
			<section id="system" class="section">
				<h2>🛠️ מערכת</h2>
				
				<!-- Import Section -->
				<div class="form-section">
					<h3>📥 ייבוא נתונים</h3>
					
					<div class="import-main-buttons" style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">
						<button onclick="createImportTable()" class="btn">
							🔗 צור טבלת עזר לייבוא
						</button>
						<button onclick="importFromHelperTableFast()" class="btn" style="background: #27ae60; color: white;">
							🚀 ייבוא מהיר וכולל
						</button>
						<button onclick="importPaymentsFromHelper()" class="btn" style="background: #9b59b6; color: white;">
							💳 ייבוא תשלומים
						</button>
						<button onclick="autoCalculatePricesByDuration()" class="btn" style="background: linear-gradient(45deg, #f39c12, #e67e22); color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);">
							⚡ חשב מחירים לפי זמן
						</button>
						<button onclick="autoLinkPaymentsToVisits()" class="btn" style="background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);">
							🔗 קישור אוטומטי תשלומים-טיפולים
						</button>
					</div>
					
					<div style="text-align: center; margin: 15px 0;">
						<span style="color: #666;">או</span>
					</div>
				</div>
				
				<!-- גיבוי ושחזור -->
				<div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 20px; margin-top: 20px;">
					<h3 style="margin: 0 0 15px 0; color: #856404;">💾 גיבוי ושחזור</h3>
					<p style="color: #856404; font-size: 14px; margin-bottom: 15px;">
						גיבוי שומר עותק של כל הנתונים. מומלץ לפני פעולות מסוכנות.
					</p>
					<div style="display: flex; gap: 10px; flex-wrap: wrap;">
						<button onclick="createBackup()" style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
							💾 צור גיבוי עכשיו
						</button>
						<button onclick="showRestoreConfirm()" style="padding: 12px 20px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
							🔄 שחזר מגיבוי
						</button>
					</div>
					<div id="backupStatus" style="margin-top: 15px; font-size: 13px; color: #666;"></div>
				</div>
				
				<!-- ייצוא נתונים -->
				<div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 12px; padding: 20px; margin-top: 20px;">
					<h3 style="margin: 0 0 15px 0; color: #1565c0;">📤 ייצוא נתונים</h3>
					<p style="color: #1565c0; font-size: 14px; margin-bottom: 15px;">
						ייצוא טיפולים לגיליון בפורמט המקורי (תואם לאקסל הישן)
					</p>
					<div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 15px;">
						<label style="font-size: 14px; color: #333;">מתאריך:</label>
						<input type="date" id="exportFromDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
						<label style="font-size: 14px; color: #333;">עד תאריך:</label>
						<input type="date" id="exportToDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
					</div>
					<div style="display: flex; gap: 10px; flex-wrap: wrap;">
						<button onclick="exportVisitsClassic()" style="padding: 12px 20px; background: #2196f3; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
							📤 ייצוא טיפולים (מבנה קלאסי)
						</button>
						<button onclick="setExportDateRange('year')" style="padding: 8px 15px; background: #90caf9; color: #1565c0; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
							השנה
						</button>
						<button onclick="setExportDateRange('lastYear')" style="padding: 8px 15px; background: #90caf9; color: #1565c0; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
							שנה שעברה
						</button>
						<button onclick="setExportDateRange('all')" style="padding: 8px 15px; background: #90caf9; color: #1565c0; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
							הכל
						</button>
					</div>
					<div id="exportStatus" style="margin-top: 15px; font-size: 13px; color: #666;"></div>
				</div>
				
				<!-- דוחות -->
				<div style="background: #f3e5f5; border: 2px solid #9c27b0; border-radius: 12px; padding: 20px; margin-top: 20px;">
					<h3 style="margin: 0 0 15px 0; color: #7b1fa2;">📊 דוחות וסטטיסטיקות</h3>
					<p style="color: #7b1fa2; font-size: 14px; margin-bottom: 15px;">
						צפייה בנתונים מסוכמים לפי תקופות
					</p>
					<div style="display: flex; gap: 10px; flex-wrap: wrap;">
						<button onclick="showYearlyIncomeReport()" style="padding: 12px 20px; background: #9c27b0; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
							📈 סיכום הכנסות שנתי
						</button>
					</div>
				</div>
				
				
				<!-- ניהול נתונים -->
				<div class="form-section">
					<h3>🗂️ ניהול נתונים</h3>
					
					<div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
						<h4 style="color: #856404; margin-bottom: 10px;">⚠️ ניקוי נתונים</h4>
						<p style="font-size: 14px; color: #856404; margin-bottom: 10px;">
							נקה את כל הנתונים המקומיים לפני ייבוא חדש (לא משפיע על הענן)
						</p>
						
						<button class="btn" onclick="clearAllDataBeforeImport()" 
								style="background: #dc3545; color: white; border: none;">
							🗑️ נקה את כל הנתונים המקומיים
						</button>
					</div>
					
					<!-- סטטוס טבלת עזר -->
					<div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
						<h4 style="color: #495057; margin-bottom: 10px;">📊 טבלת עזר לייבוא</h4>
						<div id="importTableStatus">
							<span style="font-size: 13px; color: #666;">
								בודק סטטוס טבלת עזר...
							</span>
						</div>
					</div>
				</div>
				
				<!-- Additional System Features -->
				<div class="form-section">
					<h3>⚙️ הגדרות מערכת</h3>
					
					<!-- Cost Settings -->
					<div style="background: rgba(39, 174, 96, 0.1); border: 2px solid #27ae60; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
						<h4 style="color: #27ae60; margin-bottom: 10px;">💰 הגדרות עלות טיפול</h4>
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
							<div class="form-group">
								<label for="hourlyRate">שעת עבודה (₪):</label>
								<input type="number" id="hourlyRate" value="150" min="0" onchange="saveCostSettings()">
							</div>
							<div class="form-group">
								<label for="workerCost">תוספת לפועל (₪):</label>
								<input type="number" id="workerCost" value="50" min="0" onchange="saveCostSettings()">
							</div>
						</div>
					</div>
				</div>
			</section>
			
			<!-- Tasks Section -->
			<section id="tasks" class="section">
				<div class="section-header">
					<h2>📋 משימות מיוחדות</h2>
					<div style="display: flex; gap: 10px; align-items: center;">
						<button onclick="showAddTaskModal()" class="add-btn" style="background: #9b59b6;">
							➕ משימה חדשה
						</button>
					</div>
				</div>
				
				<!-- Tasks Filter Panel - Collapsible -->
				<div class="filters-container">
					<div class="filter-header" onclick="toggleFilterPanel('tasksFilterContent')">
						<h3>🔍 סינון משימות</h3>
						<button type="button" class="filter-toggle-btn" onclick="event.stopPropagation(); toggleFilterPanel('tasksFilterContent')">🔼 כווץ</button>
					</div>
					<div id="tasksFilterContent" class="filter-content">
						<div class="filter-panel-unified" style="border: none; margin: 0; border-radius: 0 0 8px 8px;">
							<div class="filter-row-unified">
								<div class="filter-group-unified medium">
									<label>סטטוס:</label>
									<select id="filterTaskStatus" onchange="displayTasks()">
										<option value="">הכל</option>
										<option value="pending">ממתין</option>
										<option value="in_progress">בתהליך</option>
										<option value="completed">הושלם</option>
										<option value="cancelled">בוטל</option>
									</select>
								</div>
								<div class="filter-group-unified medium">
									<label>היקף:</label>
									<select id="filterTaskScope" onchange="displayTasks()">
										<option value="">הכל</option>
										<option value="client">👤 ללקוח</option>
										<option value="all">👥 גורפת</option>
										<option value="personal">🔧 עצמית</option>
									</select>
								</div>
								<div class="filter-group-unified medium">
									<label>סוג משימה:</label>
									<select id="filterTaskType" onchange="displayTasks()">
										<option value="">הכל</option>
										<option value="pest_control">🪲 הדברה</option>
										<option value="planting">🌱 שתילה</option>
										<option value="tree_trimming">✂️ גיזום עצים</option>
										<option value="upgrade">🏡 שדרוג גינה</option>
										<option value="repair">🔧 תיקון</option>
										<option value="irrigation">💧 השקייה</option>
										<option value="other">📦 אחר</option>
									</select>
								</div>
								<div class="filter-group-unified">
									<label>חיפוש לקוח:</label>
									<input type="text" id="filterTaskClient" placeholder="🔍 חיפוש לקוח..." onkeyup="displayTasks()">
								</div>
							</div>
							<div class="filter-row-unified">
								<div class="filter-group-unified compact">
									<label>מתאריך:</label>
									<input type="date" id="filterTaskDateFrom" onchange="displayTasks()">
								</div>
								<div class="filter-group-unified compact">
									<label>עד תאריך:</label>
									<input type="date" id="filterTaskDateTo" onchange="displayTasks()">
								</div>
								<div class="filter-group-unified small">
									<button onclick="clearTaskFilters()" class="filter-clear-btn">🗑️ נקה סינון</button>
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<!-- Tasks Stats Bar -->
				<div style="background: #f8f9fa; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; border: 1px solid #e0e0e0;">
					<span style="font-size: 13px; color: #333;">📋 מוצגות: <strong style="color: #666;" id="tasksCount">0</strong></span>
					<span style="font-size: 13px; color: #333;">⏳ ממתינות: <strong style="color: #f39c12;" id="statsPending">0</strong></span>
					<span style="font-size: 13px; color: #333;">🔄 בתהליך: <strong style="color: #3498db;" id="statsInProgress">0</strong></span>
					<span style="font-size: 13px; color: #333;">✅ הושלמו: <strong style="color: #27ae60;" id="statsCompleted">0</strong></span>
				</div>
				
				<!-- Tasks Table -->
					<div class="table-container" style="overflow-x: auto;">
						<table id="tasksTable" style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
							<thead style="background: #9b59b6; color: white;">
								<tr>
									<th style="padding: 12px; text-align: right;">סטטוס</th>
									<th style="padding: 12px; text-align: right;">היקף</th>
									<th style="padding: 12px; text-align: right;">סוג</th>
									<th style="padding: 12px; text-align: right;">לקוח</th>
									<th style="padding: 12px; text-align: right;">תיאור</th>
									<th style="padding: 12px; text-align: right;">תאריך יעד</th>
									<th style="padding: 12px; text-align: right;">עלות משוערת</th>
									<th style="padding: 12px; text-align: center;">פעולות</th>
								</tr>
							</thead>
							<tbody id="tasksTableBody">
								<!-- Will be populated by displayTasks() -->
							</tbody>
						</table>
					</div>
			</section>
			
			<!-- Expenses Section -->
			<section id="expenses" class="section">
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
					<h2 style="margin: 0;">💰 הוצאות</h2>
					<button onclick="showAddExpenseModal()" style="padding: 10px 20px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600;">
						➕ הוספת הוצאה
					</button>
				</div>
				
				<!-- Expenses Filter Panel - Collapsible -->
				<div class="filters-container">
					<div class="filter-header" onclick="toggleFilterPanel('expensesFilterContent')">
						<h3>🔍 סינון הוצאות</h3>
						<button type="button" class="filter-toggle-btn" onclick="event.stopPropagation(); toggleFilterPanel('expensesFilterContent')">🔼 כווץ</button>
					</div>
					<div id="expensesFilterContent" class="filter-content">
						<div class="filter-panel-unified" style="border: none; margin: 0; border-radius: 0 0 8px 8px;">
							<div class="filter-row-unified">
								<div class="filter-group-unified">
									<label>חיפוש בתיאור:</label>
									<input type="text" id="expenseSearchText" onkeyup="displayExpenses()" placeholder="🔍 חיפוש בתיאור...">
								</div>
								<div class="filter-group-unified">
									<label>חיפוש שם/עסק:</label>
									<input type="text" id="expenseSearchVendor" onkeyup="displayExpenses()" placeholder="🏪 חיפוש שם/עסק...">
								</div>
							</div>
							<div class="filter-row-unified">
								<div class="filter-group-unified medium">
									<label>סוג:</label>
									<select id="expenseTypeFilter" onchange="updateExpenseCategoryFilter(); displayExpenses()">
										<option value="">כל הסוגים</option>
										<option value="general">📦 כללי</option>
										<option value="client">👤 לקוח</option>
										<option value="vehicle">🚗 רכב</option>
										<option value="worker">👷 עובדים</option>
									</select>
								</div>
								<div class="filter-group-unified medium">
									<label>קטגוריה:</label>
									<select id="expenseCategoryFilter" onchange="displayExpenses()">
										<option value="">כל הקטגוריות</option>
									</select>
								</div>
								<div class="filter-group-unified compact">
									<label>חודש:</label>
									<input type="month" id="expenseMonthFilter" onchange="displayExpenses()">
								</div>
							</div>
							<div class="filter-row-unified" style="margin-top: 10px;">
								<div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
									<span style="font-size: 12px; color: #666;">תקופה:</span>
									<button onclick="setExpenseDateFilter('today')" class="filter-quick-btn">היום</button>
									<button onclick="setExpenseDateFilter('week')" class="filter-quick-btn">השבוע</button>
									<button onclick="setExpenseDateFilter('month')" class="filter-quick-btn">החודש</button>
									<button onclick="setExpenseDateFilter('year')" class="filter-quick-btn">השנה</button>
									<button onclick="clearExpenseFilters()" class="filter-clear-btn">🗑️ נקה הכל</button>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Expense Stats Bar -->
				<div style="background: #f8f9fa; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; border: 1px solid #e0e0e0;">
					<span style="font-size: 13px; color: #333;">📋 מוצגות: <strong style="color: #666;" id="expensesCount">0</strong></span>
					<span style="font-size: 13px; color: #333;">💰 סה"כ: <strong style="color: #e74c3c;" id="totalExpensesAmount">0 ₪</strong></span>
					<span style="font-size: 13px; color: #333;">👷 עובדים: <strong style="color: #9b59b6;" id="workerExpensesAmount">0 ₪</strong></span>
					<span style="font-size: 13px; color: #333;">🚗 רכב: <strong style="color: #3498db;" id="vehicleExpensesAmount">0 ₪</strong></span>
					<span style="font-size: 13px; color: #333;">📦 כללי: <strong style="color: #27ae60;" id="generalExpensesAmount">0 ₪</strong></span>
					<span style="font-size: 13px; color: #333;">👤 לקוחות: <strong style="color: #f39c12;" id="clientExpensesAmount">0 ₪</strong></span>
				</div>
				
				<!-- Expenses List -->
				<div id="expensesContainer">
					<!-- Will be populated by displayExpenses() -->
				</div>
			</section>
			
        </main>
    </div>

	<!-- חלונית תשלום -->

    <!-- Modal Container -->
    <div id="modalContainer"></div>

	<!-- Loading Overlay -->
	<div id="loadingOverlay" class="loading-overlay hidden">
		<div class="loading-content">
			<div class="spinner"></div>
			<div id="loadingText" class="loading-text">בתהליך...</div>
		</div>
	</div>

    <script>
		// Google Sheets API Configuration
		const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
		const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
		//let SPREADSHEET_ID = prompt('Enter Spreadsheet ID:') || localStorage.getItem('SPREADSHEET_ID') || '';  // Changed to let
		//let CLIENT_ID = prompt('Enter Client ID:') || localStorage.getItem('CLIENT_ID') || '';  // Changed to let
		//let API_KEY = prompt('Enter API Key:') || localStorage.getItem('API_KEY') || '';  // Changed to let
		let SPREADSHEET_ID = '1fSD5dh0bXRzFSeOZUwJ2bPjGRLqs2crGXPkebz6MpWc';
		let  CLIENT_ID = '1040357646874-4sbkrokgjn4dd7a0e9rkrtjt8d9l3vie.apps.googleusercontent.com';
		let  API_KEY = 'AIzaSyB25ms_UzbgfY9FnduMwMhGhlvwfVPaTg8';
		const SPREADSHEET_NAME = 'service_visits_data';

		// Save for next time
		if (SPREADSHEET_ID) localStorage.setItem('SPREADSHEET_ID', SPREADSHEET_ID);
		if (CLIENT_ID) localStorage.setItem('CLIENT_ID', CLIENT_ID);
		if (API_KEY) localStorage.setItem('API_KEY', API_KEY);

		let gapi_loaded = false;
		let google_loaded = false;
		let access_token = null;
		let spreadsheet_id = SPREADSHEET_ID;
        
        // Sheet names
        const SHEETS = {
			LOCATIONS: 'Locations',
			VISITS: 'Visits',
			RECEIPTS: 'Receipts',
			SETTINGS: 'SystemSettings'
		};

        // Global variables
        let locations = [];
        let visits = [];
        let receipts = [];
		let payments = [];
		let paymentVisitLinks = [];
		let tasks = [];
		let expenses = [];
        let currentFilter = 'today';
		
		// הגדרות עלות
		let costSettings = {
			hourlyRate: 150,
			workerCost: 50
		};


		// Initialize Google APIs
		function initializeGoogleAPIs() {
			gapi.load('client', initializeGapiClient);
			//google.accounts.id.initialize({
			//	client_id: CLIENT_ID,
			//	callback: handleCredentialResponse,
			//});
		}
		
		async function initializeGapiClient() {
			try {
				await gapi.client.init({
					apiKey: API_KEY,
					discoveryDocs: [DISCOVERY_DOC],
				});
				gapi_loaded = true;
				console.log('GAPI client initialized successfully');
			} catch (error) {
				console.error('Error initializing GAPI client:', error);
				showToast('שגיאה באתחול Google API', 'error');
			}
		}

/* 		function handleCredentialResponse(response) {
			access_token = response.credential;
			showSuccess('התחברת בהצלחה ל-Google!');
		}
 */

		// Add this function if it's missing or not accessible:
		async function connectToGoogleSheets() {
			try {
				console.log('Connecting to Google Sheets...');
				updateCloudStatus('🔗 מתחבר...', 'מתחבר');
				showToast('מתחבר ל-Google Sheets...', 'info');
				
				const tokenClient = google.accounts.oauth2.initTokenClient({
					client_id: CLIENT_ID,
					scope: SCOPES,
					callback: async (response) => {
						access_token = response.access_token;

						// שמירת Token ב-localStorage
						const tokenData = {
							token: access_token,
							timestamp: Date.now(),
							expiresIn: response.expires_in || 3600 // 1 hour default
						};
						localStorage.setItem('google_token', JSON.stringify(tokenData));
						console.log('✅ Token saved to localStorage');

						// הגדרת רענון אוטומטי (50 דקות)
						setupTokenRefresh();
						
						// עדכון סטטוס
						updateCloudStatus('✅ מחובר ומסונכרן', 'התחבר');
						document.getElementById('statusText').classList.add('connected');
						document.getElementById('saveBtn').disabled = false;
						document.getElementById('loadBtn').disabled = false;
						
						showToast('התחברת בהצלחה ל-Google Sheets!', 'success');
						
						// מציאה או יצירת הטבלה הראשית
						await findOrCreateMainSpreadsheet();

						// ודא שכל הטבלאות החדשות קיימות
						await checkAndFixTableStructure();

						// טעינה אוטומטית של נתונים אם קיימים
						// ❌ בוטל: טעינה אוטומטית - עכשיו רק ידנית
						// המשתמש יבחר מתי לטעון כדי למנוע דריסת נתונים מקומיים
						console.log('✅ מחובר לענן - טעינה ידנית בלבד (כפתור "טען")');
					},
				});
				
				tokenClient.requestAccessToken();
				
			} catch (error) {
				console.error('Error connecting to Google Sheets:', error);
				updateCloudStatus('❌ שגיאה בחיבור', 'שגיאה');
				showToast('שגיאה בחיבור ל-Google Sheets', 'error');
			}
		}

		// רענון אוטומטי של Token
		let tokenRefreshInterval = null;

		function setupTokenRefresh() {
			// ניקוי interval קודם אם קיים
			if (tokenRefreshInterval) {
				clearInterval(tokenRefreshInterval);
			}
			
			// איפוס מונה ניסיונות
			window.tokenRefreshFailures = 0;
			
			// רענון כל 50 דקות (לפני שה-token פג)
			tokenRefreshInterval = setInterval(async () => {
				// בדיקה אם יש יותר מדי כשלונות
				if (window.tokenRefreshFailures >= 3) {
					console.log('⛔ יותר מדי כשלונות רענון - עוצר ניסיונות אוטומטיים');
					clearInterval(tokenRefreshInterval);
					tokenRefreshInterval = null;
					updateCloudStatus('🔑 נדרש חיבור ידני', 'נותק');
					showToast('⚠️ החיבור פג - לחץ על "התחבר לגוגל"', 'warning');
					return;
				}
				
				console.log('🔄 מרענן Token...');
				
				try {
					const tokenClient = google.accounts.oauth2.initTokenClient({
						client_id: CLIENT_ID,
						scope: SCOPES,
						callback: (response) => {
							if (response.access_token) {
								access_token = response.access_token;
								
								// שמירה מחדש ב-localStorage
								const tokenData = {
									token: access_token,
									timestamp: Date.now(),
									expiresIn: response.expires_in || 3600
								};
								localStorage.setItem('google_token', JSON.stringify(tokenData));
								
								// איפוס מונה כשלונות
								window.tokenRefreshFailures = 0;
								
								console.log('✅ Token refreshed successfully');
							} else {
								console.log('⚠️ Token refresh returned no token');
								window.tokenRefreshFailures++;
							}
						},
						error_callback: (error) => {
							console.error('❌ Token refresh error:', error);
							window.tokenRefreshFailures++;
						}
					});
					
					// בקשה שקטה (prompt: 'none')
					tokenClient.requestAccessToken({ prompt: '' });
					
				} catch (error) {
					console.error('❌ שגיאה ברענון Token:', error);
					window.tokenRefreshFailures++;
				}
			}, 50 * 60 * 1000); // 50 minutes
			
			console.log('✅ Token refresh scheduled every 50 minutes');
		}

		
		// ניסיון שחזור Token מ-localStorage
		async function tryRestoreToken() {
			try {
				const savedTokenData = localStorage.getItem('google_token');
				
				if (!savedTokenData) {
					console.log('ℹ️ אין Token שמור - נדרש חיבור ידני');
					return false;
				}
				
				const tokenData = JSON.parse(savedTokenData);
				const tokenAge = Date.now() - tokenData.timestamp;
				const tokenExpired = tokenAge > (tokenData.expiresIn * 1000);
				
				if (tokenExpired) {
					console.log('⏰ Token פג תוקף - נדרש חיבור מחדש');
					localStorage.removeItem('google_token');
					return false;
				}
				
				// Token תקין - שחזור
				access_token = tokenData.token;
				console.log('✅ Token restored from localStorage');

				// וידוא ש-gapi.client מוכן
				if (!gapi.client) {
					console.log('⏳ Waiting for gapi.client...');
					await new Promise(resolve => {
						const checkGapi = setInterval(() => {
							if (gapi.client) {
								clearInterval(checkGapi);
								resolve();
							}
						}, 100);
					});
				}

				// הגדרת headers עם ה-Token
				gapi.client.setToken({
					access_token: access_token
				});
				console.log('✅ Token set in gapi.client');
				
				// עדכון UI
				updateCloudStatus('✅ מחובר ומסונכרן', 'התחבר');
				document.getElementById('statusText').classList.add('connected');
				document.getElementById('saveBtn').disabled = false;
				document.getElementById('loadBtn').disabled = false;
				
				// הגדרת רענון אוטומטי
				setupTokenRefresh();
				
				// בדיקת מבנה טבלאות בלבד - ללא טעינת נתונים
				await findOrCreateMainSpreadsheet();
				await checkAndFixTableStructure();
				
				// ❌ בוטל: טעינה אוטומטית - עכשיו רק ידנית
				// המשתמש יבחר מתי לטעון כדי למנוע דריסת נתונים מקומיים
				console.log('✅ Token שוחזר - טעינה ידנית בלבד (כפתור "טען")');
				
				showToast('חיבור Google שוחזר בהצלחה', 'success');
				return true;
				
			} catch (error) {
				console.error('❌ שגיאה בשחזור Token:', error);
				localStorage.removeItem('google_token');
				return false;
			}
		}
		

		// Single comprehensive loading function
		async function loadAllFromSheets() {
			// Validate connection first
			if (!await validateToken()) {
				showToast('אין חיבור לגוגל - טוען נתונים מקומיים', 'warning');
				return false;
			}
			
			showLoading('טוען נתונים מ-Google Sheets...');
			
			try {
				// Core data loading (required)
				await loadCoreData();
				
				// Optional data loading (non-critical)
				await loadOptionalData();
				
				// Update all UI components
				updateAllUIComponents();

				// Save to localStorage after loading from cloud
				saveToLocalStorage();
				
				// Success feedback
				hideLoading();
				showSuccess('נתונים נטענו בהצלחה מהענן!');
				
				// Schedule post-load tasks
				schedulePostLoadTasks();
				
				return true;
				
			} catch (error) {
				return handleLoadingError(error);
			}
		}

		// Helper functions for better organization:
		async function loadCoreData() {
			await loadLocationsFromSheets();
			await loadVisitsFromSheets(); 
			await loadReceiptsFromSheets();
			await loadTasksFromSheets();
			await loadExpensesFromSheets();
		}

		async function loadOptionalData() {
			const optionalTasks = [
				{ fn: ensureClientNameInPayments, name: 'client name column' },
				{ fn: loadPaymentsFromCloud, name: 'payments' }
			];
			
			for (const task of optionalTasks) {
				try {
					await task.fn();
				} catch (error) {
					console.warn(`Could not load ${task.name}:`, error.message);
				}
			}
		}

		function updateAllUIComponents() {
			const uiUpdaters = [
				loadLocationsForSelect,
				loadLocationsTable,
				loadReceiptsTable,
				loadReceiptFilterOptions,
				loadFilterOptions,
				loadPaymentFilterOptions,
				loadPlanningData
			];
			
			uiUpdaters.forEach(updater => updater());
		}

		function schedulePostLoadTasks() {
			setTimeout(() => {
				if (typeof checkCriticalDebts === 'function') {
					checkCriticalDebts();
				}
			}, 2000);
		}

		function handleLoadingError(error) {
			console.error('Error loading data from sheets:', error);
			hideLoading();
			
			if (error.status === 401) {
				access_token = null;
				showToast('החיבור פג במהלך טעינה', 'warning');
			} else {
				showError('שגיאה בטעינת נתונים מהענן');
			}
			
			return false;
		}


		// תוספה - טעינת מיקומים (גינות)
		async function loadLocationsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:P` // וודא שקוראים עד עמודה P
				});
				
				const rows = response.result.values;
								
				if (rows && rows.length > 1) {
					locations = rows.slice(1).map((row, index) => {
						const location = {
							ID: row[0] || '',
							name: row[1] || '',
							full_address: row[2] || '',
							neighborhood: row[3] || '',
							city: row[4] || '',
							contact_person: row[5] || '',
							phone: row[6] || '',
							allowed_day: row[7] || '',
							interval_weeks: row[8] || '',
							temp_addition: row[9] || 0,
							base_amount: row[10] || '',
							active: row[11] || '',
							notes: row[12] || '',
							last_visit: row[13] || '',
							next_visit: row[14] || '',
							client_requests: row[15] || '' // עמודה P
						};
						
						// לוג רק לשורות עם client_requests
						if (row[15]) {
							console.log(`✅ Row ${index + 1} - ${location.name}: client_requests = "${row[15]}"`);
						}
						
						return location;
					});
				}
				
				console.log('📊 Total locations loaded:', locations.length);
				
			} catch (error) {
				console.error('Error loading locations:', error);
			}
		}

		// תוספה - טעינת ביקורים (טיפולים)
		async function loadVisitsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:N`
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					visits = rows.slice(1).map(row => ({
						ID: row[0] || '',
						date: row[1] || '',
						location_id: row[2] || '',
						location_name: row[3] || '',
						visit_type: row[4] || '',
						work_done: row[5] || '',
						duration_minutes: row[6] || 0,
						num_workers: row[7] || 1,
						start_time: row[8] || '',
						end_time: row[9] || '',
						amount: row[10] || 0,
						paid: row[11] || '0',           // ✅ ADDED: עמודה 11 - paid
						expense: row[12] || 0,          // ✅ FIXED: עבר מ-11 ל-12
						notes: row[13] || ''            // ✅ FIXED: עבר מ-12 ל-13
					}));
				}
				
			} catch (error) {
				console.error('Error loading visits:', error);
			}
		}

		// תוספה - טעינת קבלות
		async function loadReceiptsFromSheets() {
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:I`
				});
				
				const rows = response.result.values;
				if (rows && rows.length > 1) {
					receipts = rows.slice(1).map(row => ({
						ID: row[0] || '',
						book_number: row[1] || '',
						receipt_number: row[2] || '',
						date: row[3] || '',
						location_id: row[4] || '',
						location_name: row[5] || '',
						amount: row[6] || 0,
						payment_type: row[7] || '',
						notes: row[8] || '',
						payment_id: row[9] || ''
					}));
				}
				
			} catch (error) {
				console.error('Error loading receipts:', error);
			}
		}
	
		// טעינת תשלומים וקישורים מהענן
		async function loadPaymentsFromCloud() {
			if (!access_token || !SPREADSHEET_ID) {
				return;
			}
			
			try {
				// טען תשלומים
				const paymentsResponse = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Payments!A2:I1000'
				});
				
				if (paymentsResponse.result.values) {
					payments = paymentsResponse.result.values.map(row => ({
						ID: row[0] || '',
						date: row[1] || '',
						time: row[2] || '',
						amount: parseFloat(row[3]) || 0,
						payment_method: row[4] || '',
						source_type: row[5] || '',
						client_id: row[6] || '',
						client_name: row[7] || '',
						notes: row[8] || '',
						status: row[9] || 'completed',
						created_at: row[10] || '',
						reference: row[11] || '',
						check_date: row[12] || '',
						bank_account: row[13] || '',
						payment_details: row[14] || '',
						receipt_id: row[15] || ''
					}));
				}
				
				// טען קישורים
				const linksResponse = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'PaymentVisitLink!A2:D1000'
				});
				
				if (linksResponse.result.values) {
					paymentVisitLinks = linksResponse.result.values.map(row => ({
						ID: row[0] || '',
						payment_id: row[1] || '',
						visit_id: row[2] || '',
						amount_allocated: parseFloat(row[3]) || 0
					}));
				}
				
				console.log(`✅ נטענו ${payments.length} תשלומים ו-${paymentVisitLinks.length} קישורים`);
				
			} catch (error) {
				console.error('שגיאה בטעינת תשלומים:', error);
			}
		}
	
		// פונקציה לוידוא שיש עמודת client_name בטבלת Payments
		async function ensureClientNameInPayments() {
			if (!access_token || !SPREADSHEET_ID) return;
			
			try {
				// קריאת הכותרות הנוכחיות
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Payments!1:1'
				});
				
				const headers = response.result.values ? response.result.values[0] : [];
				
				// בדיקה אם client_name קיים
				if (!headers.includes('client_name')) {
					console.log('Adding client_name column to Payments sheet...');
					
					// הוספת העמודה החדשה
					const newHeaders = [...headers, 'client_name'];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Payments!A1:${String.fromCharCode(64 + newHeaders.length)}1`,
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [newHeaders]
						}
					});
					
					console.log('✅ client_name column added to Payments sheet');
				}
			} catch (error) {
				console.error('Error ensuring client_name column:', error);
			}
		}


		async function saveAllToSheets() {
		if (!await validateToken()) {
			showToast('אין חיבור לגוגל - שמירה מקומית בלבד', 'warning');
			return;
		}
		
		try {
			updateCloudStatus('שומר נתונים לענן...', 'מעדכן');
			
			// שמירה בבאצ'ים (לא לולאות!)
			const savePromises = [];
			
			if (locations.length > 0) {
				showToast(`שומר ${locations.length} לקוחות בבת אחת...`, 'info', 2000);
				savePromises.push(saveLocationsBatch(locations));
			}
			
			if (visits.length > 0) {
				showToast(`שומר ${visits.length} ביקורים בבת אחת...`, 'info', 2000);
				savePromises.push(saveVisitsBatch(visits));
			}
			
			if (receipts.length > 0) {
				showToast(`שומר ${receipts.length} קבלות בבת אחת...`, 'info', 2000);
				savePromises.push(saveReceiptsBatch(receipts));
			}
			
			if (payments.length > 0) {
				showToast(`שומר ${payments.length} תשלומים בבת אחת...`, 'info', 2000);
				savePromises.push(savePaymentsBatch(payments));
			}
			
			if (paymentVisitLinks.length > 0) {
				showToast(`שומר ${paymentVisitLinks.length} קישורי תשלום בבת אחת...`, 'info', 2000);
				savePromises.push(savePaymentVisitLinksBatch(paymentVisitLinks));
			}
			
			// המתנה לכל השמירות במקביל
			await Promise.all(savePromises);
			
			updateCloudStatus('מחובר ומסונכרן', 'נשמר');
			showToast(`כל הנתונים נשמרו בענן בהצלחה!`, 'success', 3000);
			
		} catch (error) {
			console.error('Error saving all data to cloud:', error);
			updateCloudStatus('שגיאה בשמירה לענן', 'שגיאה');
			showToast('שגיאה בשמירה לענן - הנתונים נשמרו מקומית', 'error');
		}
	}


		async function saveLocationToSheets(locationData) {
		
			if (!await validateToken()) {
				showToast('החיבור לגוגל פג - שמירה מקומית בלבד', 'warning');
				return;
			}
    
			try {
				const values = [[
					locationData.ID,
					locationData.name,
					locationData.full_address,
					locationData.neighborhood,
					locationData.city,
					locationData.contact_person,
					locationData.phone,
					locationData.allowed_day,
					locationData.interval_weeks,
					locationData.temp_addition,
					locationData.base_amount,
					locationData.active,
					locationData.notes || '',
					locationData.last_visit,
					locationData.next_visit,
					locationData.client_requests || ''
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.LOCATIONS}!A:P`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving location to sheets:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('⚠️ החיבור פג - התחבר מחדש', 'warning');
					document.getElementById('statusText').textContent = '🔓 נותק';
				} else {
					// שגיאות אחרות (לא קשורות לאסימון)
					showToast('⚠️ שגיאה בשמירה לענן', 'error');
				}
				throw error;

			}
		}


		// שמירת ביקור חדש לשיטס
		async function saveVisitToSheets(visitData) {
			if (!await validateToken()) {
				return;
			}
			
			try {
				const values = [[
					visitData.ID,                       // A: ID
					visitData.date,                     // B: date  
					visitData.location_id,              // C: location_id
					visitData.location_name || '',      // D: location_name
					visitData.visit_type,               // E: visit_type
					visitData.work_done,                // F: work_done
					visitData.duration_minutes,         // G: duration_minutes
					visitData.num_workers || 1,         // H: num_workers (THIS WAS MISSING!)
					visitData.start_time,               // I: start_time
					visitData.end_time,                 // J: end_time
					visitData.amount,                   // K: amount
					visitData.expense || 0,             // L: expense
					visitData.notes                     // M: notes
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.VISITS}!A:M`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving visit to sheets:', error);
				throw error;
			}
		}

		// תוספה - שמירת קבלה לשיטס
		async function saveReceiptToSheets(receiptData) {
			if (!await validateToken()) {
				return;
			}
			
			try {
				const values = [[
					receiptData.ID,
					receiptData.booklet_number || '',
					receiptData.receipt_number || '',
					receiptData.date,
					receiptData.location_id,
					receiptData.location_name || '',
					receiptData.amount,
					receiptData.payment_type || '',
					receiptData.tax_code || '',
					receiptData.notes || ''
				]];
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:J`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: values }
				});
				
			} catch (error) {
				console.error('Error saving receipt to sheets:', error);
				throw error;
			}
		}

		
		// Local Storage functions
		function saveToLocalStorage() {
			try {
				localStorage.setItem('locations_data', JSON.stringify(locations));
				localStorage.setItem('visits_data', JSON.stringify(visits));
				localStorage.setItem('receipts_data', JSON.stringify(receipts));
				localStorage.setItem('payments_data', JSON.stringify(payments));
				localStorage.setItem('payment_links_data', JSON.stringify(paymentVisitLinks));
				localStorage.setItem('incomes_data', JSON.stringify(incomes));
				localStorage.setItem('tasks_data', JSON.stringify(tasks));
				localStorage.setItem('expenses_data', JSON.stringify(expenses));
				
				console.log('Data saved to local storage');
			} catch (error) {
				console.error('Error saving to local storage:', error);
			}
		}

		function loadFromLocalStorage() {
			try {
				const savedLocations = localStorage.getItem('locations_data');
				const savedVisits = localStorage.getItem('visits_data');
				const savedReceipts = localStorage.getItem('receipts_data');
				const savedPayments = localStorage.getItem('payments_data');
				const savedPaymentLinks = localStorage.getItem('payment_links_data');
				const savedIncomes = localStorage.getItem('incomes_data');
				const savedCostSettings = localStorage.getItem('cost_settings');
				const savedTasks = localStorage.getItem('tasks_data');
				const savedExpenses = localStorage.getItem('expenses_data');
				
				if (savedLocations) {
					locations = JSON.parse(savedLocations);
				}
				if (savedVisits) {
					visits = JSON.parse(savedVisits);
				}
				if (savedReceipts) {
					receipts = JSON.parse(savedReceipts);
				}
				if (savedPayments) {
					payments = JSON.parse(savedPayments);
				}
				if (savedPaymentLinks) {
					paymentVisitLinks = JSON.parse(savedPaymentLinks);
				}
				if (savedIncomes) {
					incomes = JSON.parse(savedIncomes);
				}
				if (savedTasks) {
					tasks = JSON.parse(savedTasks);
				}
				if (savedExpenses) {
					expenses = JSON.parse(savedExpenses);
				}
				if (savedCostSettings) {
					costSettings = JSON.parse(savedCostSettings);
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
				}
				
				console.log('Data loaded from local storage');
				
			} catch (error) {
				console.error('Error loading from local storage:', error);
			}
		}
      
        // Navigation
        function showSection(sectionName) {
			// Hide all sections
			document.querySelectorAll('.section').forEach(section => {
				section.classList.remove('active');
			});
			
			// Show selected section
			const targetSection = document.getElementById(sectionName);
			if (!targetSection) {
				console.warn(`Section ${sectionName} not found`);
				return;
			}
			
			targetSection.classList.add('active');
			
			// Update navigation buttons
			document.querySelectorAll('.nav-btn').forEach(btn => {
				btn.classList.remove('active');
			});
			
			// Set active nav button
			const navButtons = document.querySelectorAll('.nav-btn');
			const buttonTexts = {
				'planning': 'תכנון',
				'history': 'טיפולים',
				'locations': 'לקוחות',
				'receipts': 'קבלות',
				'debts': '💰 חובות',
				'payments': '💳 תשלומים',
				'tasks': '📋 משימות',
				'system': 'מערכת v3.0'
			};
			
			navButtons.forEach(btn => {
				if (btn.textContent.includes(buttonTexts[sectionName])) {
					btn.classList.add('active');
				}
			});
			
			// Load section-specific data
			switch(sectionName) {
				case 'planning':
					loadPlanningData();
					break;
				case 'history':
					loadFilterOptions();
					applyVisitFilters();
					break;
				case 'locations':
					loadLocationsTable();
					break;
				case 'receipts':
					loadReceiptFilterOptions(); // Only load filter options, don't reset filters
					// Don't call displayFilteredReceipts(receipts) - keep existing filters
					if (isClientLocked && lockedClientId) {
						// If locked, apply the locked client filter
						const receiptSearch = document.getElementById('receiptSmartSearch');
						if (receiptSearch) {
							receiptSearch.value = lockedClientName;
							handleReceiptSmartSearch(lockedClientName);
						}
					} else {
						// Only apply filters if no smart search is active
						const smartSearch = document.getElementById('receiptSmartSearch');
						if (!smartSearch || !smartSearch.value.trim()) {
							applyReceiptFilters();
						}
					}
					break;
				case 'debts':
					loadDebtClientOptions(); // Load client options first
					if (typeof displayDebts === 'function') {
						displayDebts();
					}
					break;
				case 'payments':
					if (typeof loadPaymentFilterOptions === 'function') {
						loadPaymentFilterOptions();
					}
					if (typeof applyPaymentFilters === 'function') {
						applyPaymentFilters();
					}
					break;
				case 'tasks':
					if (typeof displayTasks === 'function') {
						displayTasks();
					}
					break;
				case 'expenses':
					if (typeof displayExpenses === 'function') {
						displayExpenses();
					}
					break;	
			}
		}

        // Data loading functions
		async function loadAllData() {
			try {
				showLoading('טוען נתונים...');
				loadFromLocalStorage();
				hideLoading();
				loadPlanningData();
			} catch (error) {
				console.error('Error loading data:', error);
				showError('שגיאה בטעינת הנתונים');
			}
		}

        async function loadlocations() {
            // For now, we'll use dummy data until we set up the Google Sheets API
            locations = [
                {
                    ID: 1,
                    name: "גינת דוגמה 1",
                    full_address: "רחוב הדוגמה 1, תל אביב",
                    neighborhood: "מרכז",
                    city: "תל אביב",
                    contact_person: "יוסי כהן",
                    phone: "050-1234567",
                    allowed_day: "א'",
                    interval_weeks: 4,
                    temp_addition: 0,
                    base_amount: 300,
                    active: "כן",
                    notes: "",
                    last_visit: "2024-01-15",
                    next_visit: "2024-02-12"
                },
                {
                    ID: 2,
                    name: "גינת דוגמה 2",
                    full_address: "רחוב הדוגמה 2, תל אביב",
                    neighborhood: "צפון",
                    city: "תל אביב",
                    contact_person: "מרים לוי",
                    phone: "052-7654321",
                    allowed_day: "ג'",
                    interval_weeks: 6,
                    temp_addition: 0,
                    base_amount: 400,
                    active: "כן",
                    notes: "",
                    last_visit: "2024-01-10",
                    next_visit: "2024-02-21"
                }
            ];
        }

        
        // Display functions
        function loadPlanningData() {
			// Debug - בדיקת נתונים
			// debugPlanningData();
			
			// חישוב סטטיסטיקות
			updatePlanningStats();
			
			// סינון רגיל
			filterVisits(currentFilter);
			loadTodayTreatments(); 
		}

	/////<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
	
	// ========== מערכת תכנון משודרגת ==========

		// משתנים גלובליים לתכנון משודרג
		let currentPlanningView = 'daily';
		let planningClients = [];
		let selectedDayTab = null; 

		// זמני עבודה זמינים (07:00-19:00 בקפיצות של 30 דקות)
		const timeSlots = [];
		for (let hour = 7; hour <= 19; hour++) {
			timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
			if (hour < 19) timeSlots.push(`${hour.toString().padStart(2, '0')}:30`);
		}

		// פונקציה עיקרית לטעינת נתוני תכנון - גרסה משודרגת
		function loadPlanningDataAdvanced() {
			updatePlanningStats();
			loadPlanningClientsAdvanced();
			// updatePlanningDateHeader();
			renderPlanningCards();
		}

		// טעינת לקוחות לתכנון לפי התצוגה הנוכחית - גרסה מתוקנת
		function loadPlanningClientsAdvanced() {
			const today = new Date();
			today.setHours(0, 0, 0, 0);
			
			console.log('🔄 טוען לקוחות לתכנון - תצוגה:', currentPlanningView);
			
			// סינון לקוחות פעילים בלבד
			const activeClients = locations.filter(client => client.active === "1");
			console.log('📊 לקוחות פעילים:', activeClients.length);
			
			// חישוב נתונים לכל לקוח פעיל
			planningClients = activeClients.map(client => {
				const nextVisitDate = new Date(client.next_visit);
				nextVisitDate.setHours(0, 0, 0, 0);
				
				const daysDiff = Math.floor((nextVisitDate - today) / (1000 * 60 * 60 * 24));
				const daysOverdue = daysDiff < 0 ? Math.abs(daysDiff) : 0;
				
				return {
					...client,
					nextVisitDate: nextVisitDate,
					daysDiff: daysDiff,
					daysOverdue: daysOverdue,
					status: calculateClientStatus(daysDiff, daysOverdue)
				};
			});
			
			// סינון לפי תצוגה נוכחית
			planningClients = filterClientsByView(planningClients);
			
			// מיון הלקוחות
			sortPlanningClients();
			
			console.log('✅ לקוחות לתצוגה:', planningClients.length);
		}
	
		// חישוב סטטוס לקוח לפי הפרש ימים
		function calculateClientStatus(daysDiff, daysOverdue) {
			if (daysOverdue > 14) return 'red';        // איחור מעל שבועיים
			if (daysOverdue > 0) return 'orange';      // איחור עד שבועיים  
			if (daysDiff === 0) return 'green';        // היום בדיוק
			if (daysDiff <= 7) return 'yellow';        // השבוע הקרוב
			return 'gray';                             // עתידי רחוק
		}

		// סינון לקוחות לפי התצוגה הנבחרת
		function filterClientsByView(clients) {
			const today = new Date();
			const todayDay = today.getDay(); // 0=ראשון, 1=שני וכו'
			const dayNames = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];
			
			// חישוב גבולות שבועות - פעם אחת
			const daysSinceSunday = todayDay; // כמה ימים מראשון
			const daysUntilSaturday = 6 - todayDay; // כמה ימים עד שבת השבוע
			const daysUntilNextSunday = 7 - todayDay; // ימים עד ראשון הבא
			const daysUntilNextSaturday = daysUntilNextSunday + 6; // ימים עד שבת הבא
			
			switch (currentPlanningView) {
				case 'daily':
					// רק לקוחות שהיום בדיוק התאריך שלהם (בלי מאחרים)
					return clients.filter(client => client.daysDiff === 0);
					
				case 'weekly':
					// השבוע הנוכחי (א'-ש') - כולל טיפולים שבוצעו וטיפולים מתוכננים
					return clients.filter(client => {
						// בדיקה 1: next_visit השבוע
						const nextVisitThisWeek = client.daysDiff >= -daysSinceSunday && client.daysDiff <= daysUntilSaturday;
						
						// בדיקה 2: last_visit השבוע
						let lastVisitThisWeek = false;
						if (client.last_visit) {
							const lastVisitDate = new Date(client.last_visit);
							lastVisitDate.setHours(0, 0, 0, 0);
							const today = new Date();
							today.setHours(0, 0, 0, 0);
							const lastVisitDaysDiff = Math.floor((lastVisitDate - today) / (1000 * 60 * 60 * 24));
							lastVisitThisWeek = lastVisitDaysDiff >= -daysSinceSunday && lastVisitDaysDiff <= 0;
						}
						
						return nextVisitThisWeek || lastVisitThisWeek;
					});
					
				case 'next_week':
					// שבוע הבא (א'-ש')
					return clients.filter(client => {
						// מראשון הבא עד שבת הבא
						return client.daysDiff >= daysUntilNextSunday && client.daysDiff <= daysUntilNextSaturday;
					});
					
				case 'overdue':
					// רק מאחרים
					return clients.filter(client => client.daysOverdue > 0);
					
				case 'future':
					// רק לקוחות מעבר לשבוע הבא (יותר מ-14 ימים)
					return clients.filter(client => client.daysDiff > daysUntilNextSaturday);
					
				default:
					return clients;
			}
		}
	
		// מיון לקוחות לפי התצוגה הנוכחית
		function sortPlanningClients() {
			const dayNames = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];
			
			planningClients.sort((a, b) => {
				switch (currentPlanningView) {
					case 'daily':
						// קודם מי שמתוכנן להיום (daysDiff === 0), אחר כך מאחרים (daysDiff < 0)
						const aIsToday = a.daysDiff === 0 ? 0 : 1;
						const bIsToday = b.daysDiff === 0 ? 0 : 1;
						if (aIsToday !== bIsToday) return aIsToday - bIsToday;
						// בתוך אותה קבוצה - לפי שם
						return (a.name || '').localeCompare(b.name || '');
						
					case 'weekly':
					case 'next_week':
					case 'future':
						// ✅ שינוי: מיון לפי היום של next_visit במקום allowed_day
						const aNextDate = a.next_visit ? new Date(a.next_visit) : new Date('9999-12-31');
						const bNextDate = b.next_visit ? new Date(b.next_visit) : new Date('9999-12-31');
						const aDayIndex = aNextDate.getDay();
						const bDayIndex = bNextDate.getDay();
						
						if (aDayIndex !== bDayIndex) return aDayIndex - bDayIndex;
						// בתוך אותו יום - לפי תאריך ואז לפי שם
						if (a.daysDiff !== b.daysDiff) return a.daysDiff - b.daysDiff;
						return (a.name || '').localeCompare(b.name || '');
						
					case 'overdue':
						// מיון לפי חומרת האיחור (הכי מאחר ראשון)
						return b.daysOverdue - a.daysOverdue;
						
					default:
						return 0;
				}
			});
		}
	
		// החלפת תצוגת תכנון עם לוגיקה מעודכנת
		function switchPlanningView(view) {
			// Update tab buttons
			document.querySelectorAll('.planning-tab-btn').forEach(btn => {
				btn.classList.remove('active');
			});
			
			// Set active button
			const buttonTexts = {
				'daily': 'היום',
				'weekly': 'השבוע',
				'next_week': 'הבא',
				'overdue': 'איחור',
				'future': 'עתידי'
			};
			
			document.querySelectorAll('.planning-tab-btn').forEach(btn => {
				if (btn.textContent === buttonTexts[view]) {
					btn.classList.add('active');
				}
			});
			
			currentPlanningView = view;
			selectedDayTab = null;
			loadPlanningClientsAdvanced();  // Changed from loadPlanningClients(view)
			renderPlanningCards();  // Also need to render the cards after loading
		}

		
		// רינדור כרטיסי לקוחות לתכנון
		function renderPlanningCards() {
			const container = document.getElementById('planningCardsContainer');
			
			if (!container) {
				console.log('⚠️ לא נמצא container לכרטיסי התכנון');
				return;
			}
			
			if (planningClients.length === 0) {
				// בתצוגה יומית - עדיין צריך לבדוק אם יש מאחרים
				if (currentPlanningView === 'daily') {
					renderRegularPlanningList();
					return;
				}
				
				// בתצוגה שבועית - עדיין צריך לבדוק אם יש מאחרים
				if (currentPlanningView === 'weekly' || currentPlanningView === 'next_week') {
					renderWeeklyPlanningByDays();
					return;
				}
				
				let emptyMessage = '';
				switch (currentPlanningView) {
					case 'overdue':
						emptyMessage = '<h3>✅ אין לקוחות מאחרים</h3><p>כל הטיפולים במועדם!</p>';
						break;
					case 'future':
						emptyMessage = '<h3>🔮 אין טיפולים עתידיים</h3><p>כל הטיפולים מתוכננים לשבוע הקרוב!</p>';
						break;	
				}
				
				container.innerHTML = `
					<div class="planning-empty-state">
						${emptyMessage}
					</div>
				`;
				return;
			}

			// במצב שבועי - חלוקה לפי ימים
			if (currentPlanningView === 'weekly' || currentPlanningView === 'next_week' || currentPlanningView === 'overdue' || currentPlanningView === 'future') {
				renderWeeklyPlanningByDays();
			} else {
				// במצב יומי או מאחרות - רשימה רגילה
				renderRegularPlanningList();
			}
			
			setTimeout(setTodayAsDefault, 100);
		}


		// רינדור למצב שבועי ומאחרות עם טאבי ימים
		function renderWeeklyPlanningByDays() {
			const container = document.getElementById('planningCardsContainer');
			const dayNames = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];
			
			// יצירת מערך עם נתוני ימים + חישוב תאריכים
			const today = new Date();
			today.setHours(0, 0, 0, 0);
			const todayDayIndex = today.getDay(); // 0=ראשון
			const dayIndexMap = {'א': 0, 'ב': 1, 'ג': 2, 'ד': 3, 'ה': 4, 'ו': 5, 'ש': 6};

			// קבלת מאחרים דחופים לתצוגה שבועית (מרווח עד 12 שבועות)
			const urgentOverdueByDay = {};
			if (currentPlanningView === 'weekly') {
				dayNames.forEach(dayName => {
					urgentOverdueByDay[dayName] = getUrgentOverdueForDay(dayName);
				});
			}

			const daysData = dayNames.map(dayName => {
				const dayClients = planningClients.filter(client => 
					(client.allowed_day || 'א') === dayName
				);
				// מיון לקוחות היום
				dayClients.sort((a, b) => {
					if (currentPlanningView === 'overdue') {
						return b.daysOverdue - a.daysOverdue; // מאחרים - לפי דחיפות
					} else {
						return a.daysDiff - b.daysDiff; // שבועי - לפי תאריך
					}
				});
				
				// חישוב התאריך רק לשבוע נוכחי ושבוע הבא
				let formattedDate = '';
				if (currentPlanningView === 'weekly' || currentPlanningView === 'next_week') {
					const dayIndex = dayIndexMap[dayName];
					let daysDiff = dayIndex - todayDayIndex;
					if (currentPlanningView === 'next_week') {
						daysDiff += 7; // שבוע הבא
					}
					const dayDate = new Date(today);
					dayDate.setDate(today.getDate() + daysDiff);
					formattedDate = dayDate.toLocaleDateString('he-IL', { day: 'numeric', month: 'numeric' });
				}

				// מאחרים דחופים ליום זה
				const overdueForDay = urgentOverdueByDay[dayName] || [];

				return { dayName, clients: dayClients, date: formattedDate, overdueClients: overdueForDay };
			});
			
			// רק ימים עם לקוחות או מאחרים
			const activeDays = daysData.filter(day => day.clients.length > 0 || day.overdueClients.length > 0);
			
			if (activeDays.length === 0) {
				container.innerHTML = '<div class="planning-empty-state"><h3>אין לקוחות להציג</h3></div>';
				return;
			}
			
			// יצירת HTML עם טאבים
			let html = `
				<div class="days-tabs-container">
					<div class="days-tabs">
						${activeDays.map((day, index) => {
							// אם יש יום שנבחר, השתמש בו. אחרת - היום הראשון
							const isActive = selectedDayTab ? (day.dayName === selectedDayTab) : (index === 0);
							const hasOverdue = day.overdueClients.length > 0;
							return `<button class="day-tab-btn ${isActive ? 'active' : ''} ${hasOverdue ? 'has-overdue' : ''}" 
											 onclick="switchDayTab('${day.dayName}')" 
											 data-day="${day.dayName}">
										${day.dayName}${hasOverdue ? ' ⚠️' : ''}
									</button>`;
						}).join('')}
					</div>
					<div class="days-content">
						${activeDays.map((day, index) => {
							const isActive = selectedDayTab ? (day.dayName === selectedDayTab) : (index === 0);
							
							// מאחרים דחופים ליום זה
							let overdueHtml = '';
							if (day.overdueClients.length > 0) {
								overdueHtml = `
									<div style="margin-bottom: 15px; background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%); border: 2px solid #e74c3c; border-radius: 10px; padding: 12px;">
										<div style="font-size: 14px; font-weight: 600; color: #c0392b; margin-bottom: 10px;">
											⚠️ מאחרים דחופים (${day.overdueClients.length})
										</div>
										${day.overdueClients.map(client => renderClientRow(client)).join('')}
									</div>
								`;
							}
							
							return `<div class="day-content ${isActive ? 'active' : ''}" data-day="${day.dayName}">
										<div class="day-content-header">
											${day.clients.length} טיפולים ליום ${day.dayName}'${day.date ? ' - ' + day.date : ''}
										</div>
										${overdueHtml}
										${day.clients.map(client => renderClientRow(client)).join('')}
									</div>`;
						}).join('')}
					</div>
				</div>
			`;
			
			container.innerHTML = html;
		}

		// פונקציה לקבלת מאחרים דחופים ליום ספציפי
		function getUrgentOverdueForDay(dayName) {
			const today = new Date();
			today.setHours(0, 0, 0, 0);
			
			return locations
				.filter(loc => {
					// רק לקוחות פעילים
					if (loc.active !== 'כן' && loc.active !== true && loc.active !== '1') return false;
					
					// רק היום המועדף תואם
					if ((loc.allowed_day || 'א') !== dayName) return false;
					
					// רק עם מרווח עד 12 שבועות (3 חודשים)
					const interval = parseInt(loc.interval_weeks) || 4;
					if (interval > 12) return false;
					
					// רק מאחרים (תאריך הבא עבר)
					if (!loc.next_visit) return false;
					const nextVisit = new Date(loc.next_visit);
					if (nextVisit >= today) return false;
					
					// לא להציג את מי שכבר מופיע ברשימה השבועית
					const isInWeeklyList = planningClients.some(pc => pc.ID === loc.ID);
					if (isInWeeklyList) return false;
					
					return true;
				})
				.map(loc => {
					const nextVisit = new Date(loc.next_visit);
					const daysOverdue = Math.floor((today - nextVisit) / (1000 * 60 * 60 * 24));
					const interval = parseInt(loc.interval_weeks) || 4;
					
					return {
						...loc,
						daysOverdue: daysOverdue,
						interval_weeks: interval,
						urgencyScore: daysOverdue / (interval * 7),
						status: 'overdue'
					};
				})
				.sort((a, b) => b.urgencyScore - a.urgencyScore)
				.slice(0, 5); // מקסימום 5 לכל יום
		}

		// רינדור רגיל (יומי/מאחרות)
		function renderRegularPlanningList() {
			const container = document.getElementById('planningCardsContainer');
			
			// הוספת כותרת עם תאריך לתצוגה יומית
			let headerHtml = '';
			if (currentPlanningView === 'daily') {
				const today = new Date();
				const formattedDate = today.toLocaleDateString('he-IL', { day: 'numeric', month: 'numeric' });
				headerHtml = `<div class="day-content-header">${planningClients.length} טיפולים היום - ${formattedDate}</div>`;
			}
			
			let html = headerHtml + planningClients.map(client => renderClientRow(client)).join('');
			
			// בתצוגה יומית - הוספת מאחרים דחופים
			if (currentPlanningView === 'daily') {
				const urgentOverdue = getUrgentOverdueClients();
				
				if (urgentOverdue.length > 0) {
					html += `
						<div style="margin-top: 20px; background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%); border: 2px solid #e74c3c; border-radius: 12px; padding: 15px;">
							<h3 style="margin: 0 0 15px 0; color: #c0392b; font-size: 16px; display: flex; align-items: center; gap: 8px;">
								⚠️ מאחרים דחופים (${urgentOverdue.length})
								<span style="font-size: 12px; color: #666; font-weight: normal;">מרווח עד 3 חודשים</span>
							</h3>
							<div class="urgent-overdue-list">
								${urgentOverdue.map(client => renderClientRow(client)).join('')}
							</div>
						</div>
					`;
				}
			}
			
			container.innerHTML = html;
			setTimeout(setTodayAsDefault, 100);
		}

		// פונקציה לקבלת מאחרים דחופים (מרווח עד 12 שבועות) - רק ליום המועדף של היום
		function getUrgentOverdueClients() {
			const today = new Date();
			today.setHours(0, 0, 0, 0);
			
			// היום בשבוע - לסינון לפי יום מועדף
			const dayNames = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];
			const todayDayName = dayNames[today.getDay()];
			
			return locations
				.filter(loc => {
					// רק לקוחות פעילים
					if (loc.active !== 'כן' && loc.active !== true && loc.active !== '1') return false;
					
					// רק לקוחות שהיום המועדף שלהם הוא היום
					if ((loc.allowed_day || 'א') !== todayDayName) return false;
					
					// רק עם מרווח עד 12 שבועות (3 חודשים)
					const interval = parseInt(loc.interval_weeks) || 4;
					if (interval > 12) return false;
					
					// רק מאחרים (תאריך הבא עבר)
					if (!loc.next_visit) return false;
					const nextVisit = new Date(loc.next_visit);
					if (nextVisit >= today) return false;
					
					// לא להציג את מי שכבר מופיע בתצוגה היומית
					const isInDailyList = planningClients.some(pc => pc.ID === loc.ID);
					if (isInDailyList) return false;
					
					return true;
				})
				.map(loc => {
					const nextVisit = new Date(loc.next_visit);
					const daysOverdue = Math.floor((today - nextVisit) / (1000 * 60 * 60 * 24));
					const interval = parseInt(loc.interval_weeks) || 4;
					
					return {
						...loc,
						daysOverdue: daysOverdue,
						interval_weeks: interval,
						// ציון דחיפות: איחור ביחס למרווח
						urgencyScore: daysOverdue / (interval * 7)
					};
				})
				.sort((a, b) => b.urgencyScore - a.urgencyScore) // מיון לפי דחיפות
				.slice(0, 10); // מקסימום 10 לקוחות
		}

		// רינדור שורת לקוח (משותף לשני המצבים)
		// Update the renderClientRow function to show last treatment date		
		function renderClientRow(client) {
			const nextVisitFormatted = formatDate(client.next_visit);
			
			// בדיקה אם הלקוח מאחר
			const isOverdue = client.daysDiff < 0 || client.daysOverdue > 0;

			// Find last treatment date for this client
			const clientVisits = visits.filter(visit => visit.location_id === client.ID);
			const lastTreatmentDate = clientVisits.length > 0 
				? clientVisits.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date
				: '';
			
			// צבע לתאריך הבא לפי סטטוס
			let nextDateColor = '#2196F3'; // כחול - ברירת מחדל
			if (currentPlanningView === 'overdue') {
				nextDateColor = '#f44336'; // אדום - מאחר
			} else if (currentPlanningView === 'daily') {
				nextDateColor = '#4CAF50'; // ירוק - היום
			}
			
			let statusText = '';
			
			// טקסט סטטוס לפי תצוגה
			switch (currentPlanningView) {
				case 'daily':
					statusText = 'מתוכנן להיום';
					break;
				case 'weekly':
					statusText = client.daysDiff === 0 ? 'היום' : 
								client.daysDiff === 1 ? 'מחר' : 
								`בעוד ${client.daysDiff} ימים`;
					break;
				case 'overdue':
					statusText = client.daysOverdue === 1 ? 'איחור יום אחד' : `איחור ${client.daysOverdue} ימים`;
					break;
				case 'future':
					statusText = `בעוד ${client.daysDiff} ימים`;
					break;	
			}
			
			return `
				<div class="planning-client-row planning-status-${client.status}" data-client-id="${client.ID}">
					<div class="planning-row-main">
						<!-- שם הלקוח - גדול ובולט -->
						<div class="planning-client-header">
							<div class="planning-client-name-large" style="${isOverdue ? 'color: #e74c3c;' : ''}">👤 ${client.name}</div>
						</div>
						
						<!-- תאריכים - גדולים ובולטים -->
						<div class="planning-dates-section">
							${lastTreatmentDate ? 
								`<div class="planning-date-item">
									<span class="date-label">קודם:</span>
									<span class="date-value">${formatDate(lastTreatmentDate)}</span>
								</div>` 
								: 
								`<div class="planning-date-item">
									<span class="date-label">קודם:</span>
									<span class="date-value" style="color: #999;">---</span>
								</div>`
							}
							<div class="planning-date-item">
								<span class="date-label">הבא:</span>
								<span class="date-value" style="color: ${nextDateColor}; font-weight: 600;">${nextVisitFormatted}</span>
							</div>
							${client.base_amount > 0 ? 
								`<div class="planning-amount-small">💰 ${client.base_amount} ₪</div>` 
								: ''
							}
						</div>

						<!-- שורה עליונה: פרופיל, פעיל, התחל טיפול -->
						<div class="planning-actions-row">
							<button class="profile-btn-mobile" onclick="showClientProfile('${client.ID}')" title="פרופיל">
								👤
							</button>
							<label class="active-checkbox-mobile" title="פעיל">
								<input type="checkbox" ${client.active === '1' ? 'checked' : ''} onchange="toggleClientActive('${client.ID}', this.checked ? '1' : '0')">
							</label>
							<button class="start-treatment-btn-mobile" onclick="startTreatment('${client.ID}')" title="התחל טיפול">
								▶️
							</button>
						</div>

						<!-- שורה תחתונה: כפתורי תאריך + לוח שנה -->
						<div class="planning-date-row">
							<button class="week-btn-mobile" onclick="setNextAllowedDayThisWeek('${client.ID}', '${client.allowed_day}')" title="היום הקרוב בשבוע">
								⏬
							</button>
							<button class="week-btn-mobile" onclick="setNextAllowedDay('${client.ID}', '${client.allowed_day}', 1)" title="שבוע הבא">
								1W+
							</button>
							<button class="week-btn-mobile" onclick="setNextAllowedDay('${client.ID}', '${client.allowed_day}', 2)" title="עוד שבועיים">
								2W+
							</button>
							<input type="date" id="dateInput_${client.ID}" style="display:none;" onchange="updateClientNextVisit('${client.ID}', this.value)">
							<button class="calendar-btn-mobile" onclick="document.getElementById('dateInput_${client.ID}').showPicker()" title="בחר תאריך">
								📅
							</button>
						</div>
					</div>
					
					<!-- הערות ובקשות -->
					${(client.notes || client.client_requests) ? `
						<div class="planning-row-details">
							${client.client_requests ? `<div class="client-requests">📢 בקשות: ${client.client_requests}</div>` : ''}
							${client.notes ? `<div class="client-notes">💭 הערות: ${client.notes}</div>` : ''}
						</div>
					` : ''}
				</div>
			`;
		}
	
		// החלפת טאב יום
		function switchDayTab(dayName) {
			// שמירת היום הנבחר
			selectedDayTab = dayName;
			
			// הסרת active מכל הכפתורים
			document.querySelectorAll('.day-tab-btn').forEach(btn => btn.classList.remove('active'));
			document.querySelectorAll('.day-content').forEach(content => content.classList.remove('active'));
			
			// הוספת active לכפתור ותוכן הנוכחיים
			const activeBtn = document.querySelector(`[data-day="${dayName}"]`);
			const activeContent = document.querySelector(`.day-content[data-day="${dayName}"]`);
			
			if (activeBtn) activeBtn.classList.add('active');
			if (activeContent) activeContent.classList.add('active');
		}
		
	
		// עדכון שעה מתוכננת ללקוח
		function updateClientScheduledTime(clientId, newTime) {
			const client = locations.find(loc => loc.ID === clientId);
			if (client) {
				client.scheduled_time = newTime;
				saveToLocalStorage();
				
				// שמירה בענן אם מחובר
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`שעת טיפול עודכנה ל-${newTime}`, 'success', 2000);
			}
		}

		// סיום טיפול (מעבר לטופס הוספת ביקור)
		function completePlanningVisit(clientId) {
			showSection('visit');
			document.getElementById('locationSelect').value = clientId;
			document.getElementById('visitDate').value = getLocalDateString();
			
			const client = locations.find(loc => loc.ID === clientId);
			if (client && client.scheduled_time) {
				const timeInput = document.getElementById('visitTime');
				if (timeInput) timeInput.value = client.scheduled_time;
			}
		}

		// דחיית טיפול
		function postponePlanningVisit(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			const weeks = prompt(`כמה שבועות לדחות את הטיפול עבור ${client.name}?`, '1');
			if (weeks && !isNaN(weeks) && parseInt(weeks) > 0) {
				const currentNextVisit = new Date(client.next_visit);
				const postponedDate = new Date(currentNextVisit.getTime() + (parseInt(weeks) * 7 * 24 * 60 * 60 * 1000));
				
				client.next_visit = getLocalDateString(postponedDate);
				client.temp_addition = 0;
				
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`טיפול נדחה ל-${formatDate(client.next_visit)}`, 'success');
				loadPlanningDataAdvanced();
			}
		}

		// תפריט פעולות נוספות ללקוח
		function showPlanningClientMenu(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			const actions = [
				'צפייה בהיסטוריית טיפולים',
				'התחלת טיפול מיידי',
				'קביעת תאריך ספציפי',
				'עריכת פרטי לקוח',
				'ביטול'
			];
			
			const choice = prompt(`בחר פעולה עבור ${client.name}:\n\n` + 
				actions.map((action, i) => `${i + 1}. ${action}`).join('\n'));
			
			switch (choice) {
				case '1':
					showClientTreatmentHistory(clientId);
					break;
				case '2':
					startImmediateVisit(clientId);
					break;
				case '3':
					setSpecificVisitDate(clientId);
					break;
				case '4':
					editLocation(clientId);
					break;
			}
		}

		// צפייה בהיסטוריית טיפולים
		function showClientTreatmentHistory(clientId) {
			// Use the existing working showClientHistory function instead of alert
			showClientHistory(clientId);
		}

		// התחלת טיפול מיידי
		function startImmediateVisit(clientId) {
			showSection('visit');
			document.getElementById('locationSelect').value = clientId;
			document.getElementById('visitDate').value = getLocalDateString();
			document.getElementById('visitTime').value = new Date().toTimeString().slice(0,5);
		}

		// קביעת תאריך ספציפי לטיפול
		function setSpecificVisitDate(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			const newDate = prompt(`הזן תאריך חדש לטיפול הבא עבור ${client.name}:`, client.next_visit);
			
			if (newDate && !isNaN(new Date(newDate))) {
				client.next_visit = newDate;
				client.temp_addition = 0;
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(client);
				}
				
				showToast(`תאריך הטיפול הבא עבור ${client.name} עודכן ל-${formatDate(newDate)}`, 'success');
				loadPlanningDataAdvanced();
			}
		}
	
	
	// הוספת אירועי גרירה לכרטיסים (רק בתצוגה יומית)
		let draggedPlanningCard = null;

		function addPlanningDragEvents() {
			const cards = document.querySelectorAll('.planning-client-card');
			
			cards.forEach(card => {
				card.addEventListener('dragstart', handlePlanningDragStart);
				card.addEventListener('dragend', handlePlanningDragEnd);
				card.addEventListener('dragover', handlePlanningDragOver);
				card.addEventListener('drop', handlePlanningDrop);
			});
		}

		function handlePlanningDragStart(e) {
			draggedPlanningCard = this;
			this.classList.add('planning-dragging');
			e.dataTransfer.effectAllowed = 'move';
		}

		function handlePlanningDragEnd(e) {
			this.classList.remove('planning-dragging');
			document.querySelectorAll('.planning-client-card').forEach(card => {
				card.classList.remove('planning-drag-over');
			});
		}

		function handlePlanningDragOver(e) {
			if (e.preventDefault) e.preventDefault();
			this.classList.add('planning-drag-over');
			e.dataTransfer.dropEffect = 'move';
			return false;
		}

		function handlePlanningDrop(e) {
			if (e.stopPropagation) e.stopPropagation();
			
			if (draggedPlanningCard !== this) {
				const draggedIndex = parseInt(draggedPlanningCard.dataset.index);
				const droppedIndex = parseInt(this.dataset.index);
				
				// החלפת מקומות במערך
				const temp = planningClients[draggedIndex];
				planningClients[draggedIndex] = planningClients[droppedIndex];
				planningClients[droppedIndex] = temp;
				
				// רינדור מחדש
				renderPlanningCards();
				
				showToast('סדר הלקוחות שונה', 'info');
			}
			
			this.classList.remove('planning-drag-over');
			return false;
		}

		// שמירת הפונקציה המקורית לפני ההחלפה
		window.originalLoadPlanningData = window.loadPlanningData;

		// החלפת הפונקציה loadPlanningData
		window.loadPlanningData = function() {
			console.log('🔄 loadPlanningData נקראה');
			
			// בדיקה אם יש את האלמנטים החדשים
			if (document.getElementById('planningCardsContainer')) {
				console.log('📊 משתמש במערכת חדשה');
				loadPlanningDataAdvanced();
			} else {
				console.log('📊 משתמש במערכת ישנה');
				updatePlanningStats();
				filterVisits(window.currentFilter || 'today');
			}
		};

		// עדכון הפונקציה refreshPlanningAfterTreatmentUpdate לעבוד עם שתי המערכות
		// Make sure this function exists and gets called after dates update
		
		function refreshPlanningAfterTreatmentUpdate() {
			// רענן את נתוני התכנון אם הטאב פתוח
			const currentSection = document.querySelector('.section.active');
			if (currentSection && currentSection.id === 'planning') {
				loadPlanningData();
			}
			
			// רענן גם את רשימת הלקוחות בטופס הביקור
			loadLocationsForSelect();
			
			// ✅ הוסף: רענן את טבלת הטיפולים אם פתוחה
			const historySection = document.getElementById('history');
			if (historySection && historySection.classList.contains('active')) {
				applyVisitFilters();
			}
			
			// רענן את הטיפולים של היום
			loadTodayTreatments();
		}
	
	/////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>


		// תוספה - עדכון סטטיסטיקות
		function updatePlanningStats() {
			// לקוחות
			const totalLocations = locations.length;
			const activeLocations = locations.filter(loc => loc.active === 'כן').length;
			
			// טיפולים השבוע
			const today = new Date();
			const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
			const weeklyVisits = visits.filter(visit => {
				const visitDate = new Date(visit.date);
				return visitDate >= weekAgo && visitDate <= today;
			});
			
			// הכנסה השבוע
			const weeklyIncome = weeklyVisits.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			// חובות פתוחים
			const openDebts = visits
				.filter(visit => visit.paid === '0')
				.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			// עדכון התצוגה
			document.getElementById('totalLocations').textContent = totalLocations;
			document.getElementById('activeLocations').textContent = `${activeLocations} (${totalLocations > 0 ? Math.round((activeLocations / totalLocations) * 100) : 0}%)`;
			document.getElementById('weeklyVisits').textContent = weeklyVisits.length;
			document.getElementById('weeklyIncome').textContent = `₪${weeklyIncome.toLocaleString()}`;
			document.getElementById('openDebts').textContent = `₪${openDebts.toLocaleString()}`;
		}

        function filterVisits(filter) {
			currentFilter = filter;
			
			// Update filter buttons
			document.querySelectorAll('.filter-btn').forEach(btn => {
				btn.classList.remove('active');
				if ((filter === 'today' && btn.textContent === 'היום') ||
					(filter === 'week' && btn.textContent === 'השבוע') ||
					(filter === 'overdue' && btn.textContent === 'מאוחרות')) {
					btn.classList.add('active');
				}
			});
			
			// Filter locations based on next_visit date
			const today = new Date();
			today.setHours(0, 0, 0, 0); // תחילת היום
			const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
			
			let filteredlocations = locations.filter(location => {
				return location.active === "1" && location.next_visit && location.next_visit.trim() !== '';
			});
			
			switch(filter) {
				case 'today':
					// לקוחות שהתאריך הבא שלהם הוא היום או עבר (צריכים טיפול)
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						nextVisit.setHours(0, 0, 0, 0); // תחילת היום
						return nextVisit <= today;
					});
					break;
				case 'week':
					// לקוחות שהתאריך הבא שלהם הוא השבוע הקרוב או עבר
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						return nextVisit <= weekFromNow;
					});
					break;
				case 'overdue':
					// לקוחות שהתאריך הבא שלהם עבר (מאוחרים)
					const yesterday = new Date(today);
					yesterday.setDate(yesterday.getDate() - 1);
					
					filteredlocations = filteredlocations.filter(location => {
						const nextVisit = new Date(location.next_visit);
						return nextVisit <= yesterday;
					});
					break;
			}
			
			displayPlanningTable(filteredlocations);
			updateTreatmentsStats(filteredlocations);
		}

        function displayPlanningTable(locationsToShow) {
			const tbody = document.getElementById('planningTableBody');
			
			// בדיקה אם האלמנט קיים
			if (!tbody) {
				console.log('⚠️ planningTableBody not found, skipping display');
				return;
			}
			
			tbody.innerHTML = '';
			
			if (locationsToShow.length === 0) {
				tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">אין בינות לטיפול</td></tr>';
				return;
			}
			
			locationsToShow.forEach(location => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${location.name}</td>
					<td>${location.full_address}</td>
					<td>${location.allowed_day}</td>
					<td>${formatDate(location.next_visit)}</td>
					<td>
						<button class="action-btn start-visit-btn" onclick="startVisitForlocation(${location.ID})">
							התחל טיפול
						</button>
						<button class="action-btn edit-btn" onclick="postponeVisit(${location.ID})">
							דחה
						</button>
					</td>
				`;
				tbody.appendChild(row);
			});
		}

       function calculateDurationFromTimes() {
			const startTime = document.getElementById('visitTime').value;
			const endTime = document.getElementById('endTime').value;
			
			if (!startTime || !endTime) return;
			
			const start = new Date(`2000-01-01T${startTime}`);
			const end = new Date(`2000-01-01T${endTime}`);
			
			if (end <= start) {
				showToast('שעת סיום חייבת להיות אחרי שעת התחלה', 'warning');
				return;
			}
			
			const diffMs = end - start;
			const totalMinutes = Math.round(diffMs / (1000 * 60));
			const hours = Math.floor(totalMinutes / 60);
			const minutes = totalMinutes % 60;
			const decimalHours = (totalMinutes / 60).toFixed(1);
			
			// בדיקה שהאלמנטים קיימים לפני עדכון
			const durationHoursEl = document.getElementById('durationHours');
			const durationMinutesEl = document.getElementById('durationMinutes');
			const manualDurationEl = document.getElementById('manualDurationMinutes');
			const calculatedHoursEl = document.getElementById('calculatedHours');
			
			if (durationHoursEl) durationHoursEl.value = hours;
			if (durationMinutesEl) durationMinutesEl.value = minutes;
			if (manualDurationEl) manualDurationEl.value = totalMinutes;
			if (calculatedHoursEl) calculatedHoursEl.value = decimalHours;
			
			// עדכון המחיר אוטומטית
			if (typeof calculateTreatmentCost === 'function') {
				calculateTreatmentCost();
			}
		}


	   function loadLocationsTable() {
			const filteredData = getFilteredLocations();
			
			const tbody = document.getElementById('locationsTableBody');
			tbody.innerHTML = '';
			
			if (filteredData.length === 0) {
				tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #666;">אין לקוחות תואמים לסינון</td></tr>';
				updateLocationsStats(filteredData);
				return;
			}
			
			filteredData.forEach(location => {
				// Find last treatment date for this client - ONCE!
				const clientVisits = visits.filter(visit => String(visit.location_id) === String(location.ID));
				const lastTreatmentDate = clientVisits.length > 0 
					? clientVisits.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date
					: '';
				
				// Main row
				const row = document.createElement('tr');
				row.className = 'main-row';
				row.innerHTML = `
					<td>
						<strong>${location.name}</strong>
					</td>
					<td>${location.full_address}</td>
					<td>
						<button class="action-btn" onclick="event.stopPropagation(); showClientProfile('${location.ID}')" title="פרופיל" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 10px;">👤</button>
						<button class="action-btn edit-btn" onclick="event.stopPropagation(); editLocation('${location.ID}')">✏️</button>
						<button class="action-btn delete-btn" onclick="event.stopPropagation(); deleteLocation('${location.ID}')">🗑️</button>
					</td>
				`;
				tbody.appendChild(row);
				
				// Details row
				const detailsRow = document.createElement('tr');
				detailsRow.className = 'details-row';
				detailsRow.innerHTML = `
					<td colspan="3" style="padding: 15px; background: #f8f9fa;">
						<div style="display: flex; gap: 20px; margin-bottom: 10px; font-size: 14px; flex-wrap: wrap;">
							<div><strong style="color: #666;">יום:</strong> ${location.allowed_day || '-'}</div>
							<div><strong style="color: #666;">מרווח:</strong> ${location.interval_weeks || 4} שבועות</div>
							<div><strong style="color: #666;">קודם:</strong> ${lastTreatmentDate ? formatDate(lastTreatmentDate) : '-'}</div>
							<div><strong style="color: #666;">הבא:</strong> ${location.next_visit ? formatDate(location.next_visit) : '-'}</div>
						</div>
						
						<div style="margin-bottom: 10px; font-size: 14px;">
							<strong style="color: #666;">איש קשר:</strong> ${location.contact_person || '-'}
						</div>
						
						<div style="font-size: 14px;">
							<strong style="color: #666;">הערות:</strong>
							<input type="text" 
								   value="${location.notes || ''}" 
								   placeholder="הערות..."
								   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; margin-top: 5px;"
								   onchange="updateLocationNotes('${location.ID}', this.value)">
						</div>
						
						<div style="margin-top: 10px; font-size: 14px;">
							<label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer;">
								<strong style="color: #666;">פעיל:</strong>
								<input type="checkbox" 
									   ${location.active === '1' ? 'checked' : ''} 
									   onchange="toggleLocationStatus('${location.ID}', this.checked ? '1' : '0')"
									   style="transform: scale(1.3); cursor: pointer;">
							</label>
						</div>
					</td>
				`;
				tbody.appendChild(detailsRow);
			});
			
			updateLocationsStats(filteredData);
			
			// Initialize expandable rows for mobile
			setTimeout(() => {
				initExpandableTable('locationsTable');
			}, 100);
		}

		// עדכון סטטיסטיקות הלקוחות
		function updateLocationsStats(filteredData) {
			const activeClients = filteredData.filter(loc => loc.active === "1").length;
			const inactiveClients = filteredData.filter(loc => loc.active === "0").length;
			
			document.getElementById('locationsCount').textContent = filteredData.length;
			document.getElementById('activeCount').textContent = activeClients;
			document.getElementById('inactiveCount').textContent = inactiveClients;
		}

        function loadReceiptsTable() {
			// טען אפשרויות סינון
			loadReceiptFilterOptions();
			
			// אל תציג את כל הקבלות אוטומטית - שמור על הסינון הקיים
			// displayFilteredReceipts(receipts); // <- מחק את השורה הזו
			
			// במקום זה, בדוק אם יש סינון פעיל
			const smartSearch = document.getElementById('receiptSmartSearch');
			if (smartSearch && smartSearch.value.trim()) {
				// יש חיפוש פעיל - השתמש בו
				handleReceiptSmartSearch(smartSearch.value);
			} else {
				// אין חיפוש - הצג הכל
				applyReceiptFilters();
			}
		}

        // Visithandling
        function startVisitForlocation(locationId) {
            const location = locations.find(g => g.ID === locationId);
            if (location) {
                showSection('visit');
                document.getElementById('locationSelect').value = locationId;
            }
        }

        function handleVisitSubmit(event) {
			event.preventDefault();
			
			// בדיקות בטיחות לכל האלמנטים
			const clientSearchInput = document.getElementById('clientSearchInput');
			const selectedClientIdInput = document.getElementById('selectedClientId');

			let selectedLocationId = '';
			if (selectedClientIdInput && selectedClientIdInput.value) {
				selectedLocationId = selectedClientIdInput.value;
			} else if (clientSearchInput && clientSearchInput.value) {
				// אם אין ID נבחר, נסה למצוא לפי הטקסט
				const searchValue = clientSearchInput.value;
				const matchingClient = locations.find(loc => 
					`${loc.name} - ${loc.full_address}` === searchValue ||
					loc.name === searchValue
				);
				if (matchingClient) {
					selectedLocationId = matchingClient.ID;
				}
			}

			const visitDateElement = document.getElementById('visitDate');
			const visitDate = visitDateElement ? visitDateElement.value : '';

			const endTimeElement = document.getElementById('endTime');
			const endTime = endTimeElement ? endTimeElement.value : '';

			const paymentStatusElement = document.getElementById('paymentStatus');
			const paymentStatus = paymentStatusElement ? paymentStatusElement.value : '0';

			const visitTypeElement = document.getElementById('visitType');
			const visitType = visitTypeElement ? visitTypeElement.value : 'מלא';

			const workDoneElement = document.getElementById('workDone');
			const workDone = workDoneElement ? workDoneElement.value : '';

			const amountElement = document.getElementById('amount');
			const amount = amountElement ? amountElement.value : '0';

			const notesElement = document.getElementById('notes');
			const notes = notesElement ? notesElement.value : '';

			const manualDurationElement = document.getElementById('manualDurationMinutes');
			const durationMinutes = manualDurationElement ? parseFloat(manualDurationElement.value) || 0 : 0;

			const numberOfWorkersElement = document.getElementById('numberOfWorkersVisit');
			const numberOfWorkers = numberOfWorkersElement ? parseInt(numberOfWorkersElement.value) || 1 : 1;

			const expenseElement = document.getElementById('expense');
			const expense = expenseElement ? expenseElement.value : '0';

			const visitTimeElement = document.getElementById('visitTime');
			const startTime = visitTimeElement ? visitTimeElement.value : '';
			
			// בדיקות בסיסיות
			if (!selectedLocationId) {
				showToast('אנא בחר לקוח', 'error');
				return;
			}
			
			if (!visitDate) {
				showToast('נדרש תאריך טיפול', 'error');
				return;
			}
			
			// בדיקת כפילות
			const duplicateVisit = checkDuplicateVisit(selectedLocationId, visitDate);
			if (duplicateVisit) {
				const location = locations.find(loc => loc.ID == selectedLocationId);
				const locationName = location ? location.name : 'לקוח לא ידוע';
				
				const confirmMessage = `כבר קיים טיפול ללקוח "${locationName}" היום (${formatDate(visitDate)}).\n\nהאם להוסיף טיפול נוסף בכל זאת?`;
				
				if (!confirm(confirmMessage)) {
					return; // ביטול הוספה
				}
			}

			// חישוב אוטומטי של משך הזמן אם יש שעת התחלה וסיום
			let calculatedDuration = durationMinutes;
			if (startTime && endTime) {
				const start = new Date(`2000-01-01 ${startTime}`);
				const end = new Date(`2000-01-01 ${endTime}`);
				const diffMs = end - start;
				if (diffMs > 0) {
					calculatedDuration = Math.round(diffMs / (1000 * 60)); // הפרש בדקות
					if (manualDurationElement) {
						manualDurationElement.value = calculatedDuration;
					}
				}
			}

			const visitData = {
				location_id: selectedLocationId,  
				visit_type: visitType,
				work_done: workDone,
				duration_minutes: calculatedDuration,
				workers_count: numberOfWorkers,		
				amount: parseFloat(amount) || 0,
				expense: parseFloat(expense) || 0,
				date: visitDate,
				start_time: startTime,
				end_time: endTime,
				paid: paymentStatus,
				notes: notes
			};
			
			console.log('Visit data:', visitData);
			
			// שמירת הטיפול
			saveVisit(visitData);
		}


		// Fixed saveVisit - proper mapping for workers_count to num_workers
		async function saveVisit(visitData) {
			try {
				// Find the client
				const location = locations.find(loc => loc.ID === visitData.location_id);
				
				// Create the correct visit object structure
				const newVisit = {
					ID: generateID(),
					date: visitData.date,
					location_id: visitData.location_id,
					location_name: location ? location.name : 'לקוח לא ידוע',
					visit_type: visitData.visit_type,
					work_done: visitData.work_done,
					duration_minutes: visitData.duration_minutes,
					num_workers: visitData.workers_count || 1,    // ✅ CORRECT mapping!
					start_time: visitData.start_time,
					end_time: visitData.end_time,
					amount: visitData.amount,
					expense: visitData.expense || 0,
					notes: visitData.notes
					// ✅ REMOVED: no 'paid' field - this caused the column shift problem
				};

				// Add to visits array
				visits.push(newVisit);
				
				// Save locally (always succeeds)
				saveToLocalStorage();
				
				// Try to save to cloud
				let cloudSaved = false;
				if (access_token && SPREADSHEET_ID) {
					try {
						await saveVisitToSheets(newVisit);
						cloudSaved = true;
					} catch (error) {
						console.error('Cloud save failed:', error);
						cloudSaved = false;
					}
				}
				
				// Update treatment dates
				await updateSingleLocationTreatmentDates(newVisit.location_id);
				
				// Refresh display
				document.getElementById('visitForm')?.reset();

				// Force refresh planning view if we're in planning section
				const planningSection = document.getElementById('planning');
				if (planningSection && planningSection.classList.contains('active')) {
					loadPlanningData();
					// Also refresh the current planning tab view
					const currentView = document.querySelector('.planning-tab-btn.active')?.textContent;
					if (currentView) {
						if (currentView.includes('איחור')) switchPlanningView('overdue');
						else if (currentView.includes('היום')) switchPlanningView('daily');
						else if (currentView.includes('השבוע')) switchPlanningView('weekly');
						else if (currentView.includes('הבא')) switchPlanningView('next_week');
						else if (currentView.includes('עתידי')) switchPlanningView('future');
					}
				} else {
					// Still update data in background
					loadPlanningData();
				}
				
				// Success message based on actual result
				if (access_token && SPREADSHEET_ID) {
					if (cloudSaved) {
						showToast('✅ הטיפול נשמר בהצלחה במערכת ובענן!', 'success');
					} else {
						showToast('⚠️ הטיפול נשמר מקומית בלבד - בעיה בחיבור לענן', 'warning');
					}
				} else {
					showToast('💾 הטיפול נשמר מקומית - התחבר לענן לשמירה מלאה', 'info');
				}
				
			} catch (error) {
				console.error('Error saving visit:', error);
				showToast('❌ שגיאה בשמירת הטיפול - נסה שנית', 'error');
			}
		}
		
		
		function postponeVisit(locationId) {
			const location = locations.find(g => g.ID == locationId);
			if (location) {
				const weeks = prompt('כמה שבועות לדחות?', '1');
				if (weeks && !isNaN(weeks)) {
					const currentNext = new Date(location.next_visit);
					const newNext = new Date(currentNext.getTime() + (parseInt(weeks) * 7 * 24 * 60 * 60 * 1000));
					location.next_visit = `${newNext.getFullYear()}-${String(newNext.getMonth() + 1).padStart(2, '0')}-${String(newNext.getDate()).padStart(2, '0')}`;
					loadPlanningData();
					showSuccess(`טיפול נדחה ב-${weeks} שבועות`);
				}
			}
		}

        // location management
        function showAddLocationForm() {
			const modalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<div style="position: relative;">
						<button onclick="closeAnyModal()" style="position: absolute; top: 0; left: 0; background: #e74c3c; border: none; color: white; font-size: 20px; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">×</button>
						<h3 style="margin-bottom: 20px; color: #2c3e50;">הוספת לקוח חדש</h3>
					</div>
					
					<form id="locationForm" onsubmit="handleLocationSubmit(event)">
						<div class="form-group">
							<label for="locationName">שם לקוח:</label>
							<input type="text" id="locationName" required>
						</div>
						<div class="form-group">
							<label for="locationAddress">כתובת מלאה:</label>
							<input type="text" id="locationAddress" required>
						</div>
						<div class="form-group">
							<label for="locationNeighborhood">שכונה:</label>
							<input type="text" id="locationNeighborhood">
						</div>
						<div class="form-group">
							<label for="locationCity">עיר:</label>
							<input type="text" id="locationCity">
						</div>
						<div class="form-group">
							<label for="locationContact">איש קשר:</label>
							<input type="text" id="locationContact">
						</div>
						<div class="form-group">
							<label for="locationPhone">טלפון:</label>
							<input type="tel" id="locationPhone">
						</div>
						<div class="form-group">
							<label for="locationDay">יום מועדף:</label>
							<select id="locationDay">
								<option value="כל יום">כל יום</option>
								<option value="א">א (ראשון)</option>
								<option value="ב">ב (שני)</option>
								<option value="ג">ג (שלישי)</option>
								<option value="ד">ד (רביעי)</option>
								<option value="ה">ה (חמישי)</option>
								<option value="ו">ו (שישי)</option>
								<option value="ש">ש (שבת)</option>
							</select>
						</div>
						<div class="form-group">
							<label for="locationInterval">מרווח שבועות:</label>
							<input type="number" id="locationInterval" value="4" min="1">
						</div>
						<div class="form-group">
							<label for="locationAmount">סכום בסיסי:</label>
							<input type="number" id="locationAmount">
						</div>
						<div class="form-group">
							<label for="locationActive">פעילות:</label>
							<select id="locationActive" required>
								<option value="1">פעיל</option>
								<option value="0">לא פעיל</option>
							</select>
						</div>
						<div class="form-group">
							<label for="locationNextVisit">תאריך לטיפול הבא:</label>
							<input type="date" id="locationNextVisit" required>
						</div>
						<div class="form-group">
							<label for="locationClientRequests">בקשות לקוח:</label>
							<textarea id="locationClientRequests" rows="2"></textarea>
						</div>
						<div class="form-group">
							<label for="locationNotes">הערות:</label>
							<textarea id="locationNotes" rows="3"></textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="submit" class="btn btn-success">שמור לקוח</button>
							<button type="button" onclick="closeAnyModal()" class="btn btn-secondary">ביטול</button>
						</div>
					</form>
				</div>
			`;
			
			showEditModal(modalHTML);
			
			// Set default date
			document.getElementById('locationNextVisit').value = getLocalDateString();
		}

        async function handleLocationSubmit(event) {
            event.preventDefault();
           
			const locationData = {
				ID: generateID(),
				name: document.getElementById('locationName').value,
				full_address: document.getElementById('locationAddress').value,
				neighborhood: document.getElementById('locationNeighborhood').value,
				city: document.getElementById('locationCity').value,
				contact_person: document.getElementById('locationContact').value,
				phone: document.getElementById('locationPhone').value,
				allowed_day: document.getElementById('locationDay').value,
				interval_weeks: parseInt(document.getElementById('locationInterval').value),
				temp_addition: 0,
				base_amount: parseFloat(document.getElementById('locationAmount').value) || 0,
				active: document.getElementById('locationActive').value,
				notes: document.getElementById('locationNotes').value,
				client_requests: document.getElementById('locationClientRequests').value || '', // שדה חדש
				last_visit: '',
				next_visit: document.getElementById('locationNextVisit').value
			};
           
		    // בדיקת כפילויות גם לפי ID וגם לפי כתובת
			const existingLocation = locations.find(loc => 
				loc.ID === locationData.ID || 
				(loc.full_address && locationData.full_address &&
				 loc.full_address.toLowerCase().trim() === locationData.full_address.toLowerCase().trim())
			);

			if (existingLocation) {
				if (!confirm(`לקוח עם כתובת "${locationData.full_address}" כבר קיים.\n\nהאם להוסיף בכל זאת?`)) {
					return; // ביטול הוספה
				}
			}
		   
            // שמירה לזיכרון מקומי
			locations.push(locationData);

			// שמירה אוטומטית לענן
			if (access_token && spreadsheet_id) {
				document.getElementById('statusText').textContent = '🔄 שומר לקוח...';
				try {
					await saveLocationToSheets(locationData);
					updateCloudStatus('✅ מחובר ומסונכרן', 'נשמר');
					showSuccess('לקוח נשמר בהצלחה ל-Google Sheets!');
				} catch (error) {
					if (error.status === 401) {
						document.getElementById('statusText').textContent = '🔓 נדרש חיבור מחדש';
						document.getElementById('statusText').classList.remove('connected');
						showToast('⚠️ החיבור לגוגל פג - התחבר מחדש', 'warning');
						access_token = null;
					} else {
						document.getElementById('statusText').textContent = '⚠️ שגיאה בשמירה';
						showToast('⚠️ הלקוח נשמר מקומית בלבד', 'warning');
					}
				}
			} else {
				showToast('🔓 לקוח נשמר מקומית - התחבר לענן לשמירה', 'warning');
			}

			closeAnyModal();
			loadLocationsTable();
			loadLocationsForSelect();
			saveToLocalStorage();
        }


		// ✅ NEW: Show comprehensive client profile modal
		function showClientProfile(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// Get client's visits
			const clientVisits = visits
				.filter(v => v.location_id === clientId)
				.sort((a, b) => b.date.localeCompare(a.date));
			
			// Calculate statistics
			const totalVisits = clientVisits.length;
			const totalIncome = clientVisits.reduce((sum, v) => sum + (parseFloat(v.amount) || 0), 0);
			const totalPaid = clientVisits.reduce((sum, v) => sum + getVisitPaidAmount(v.ID), 0);
			const totalDebt = totalIncome - totalPaid;
			
			// Last visit date
			const lastVisit = clientVisits.length > 0 ? clientVisits[0].date : 'אין';
			
			// Build modal HTML
			const modalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 900px; width: 95vw; max-height: 90vh; overflow-y: auto; position: relative;">
					<!-- Close X Button -->
					<button onclick="closeAnyModal()" 
							style="position: absolute; top: 15px; left: 15px; background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px; font-weight: bold; line-height: 1; display: flex; align-items: center; justify-content: center; z-index: 10;">
						×
					</button>
					
					<!-- Header -->
					<div style="border-bottom: 3px solid #3498db; padding-bottom: 15px; margin-bottom: 20px;">
						<h2 style="margin: 0; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
							👤 ${client.name}
							<span style="font-size: 14px; color: #666; font-weight: normal;">${client.full_address}</span>
						</h2>
					</div>
					
					<!-- Compact Statistics + Next Treatment -->
					<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: center;">
						<div style="display: flex; gap: 8px; flex-wrap: wrap; flex: 1;">
							<span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px;">
								🔧 ${totalVisits} טיפולים
							</span>
							<span style="background: #f093fb; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px;">
								💵 ₪${totalIncome.toFixed(0)}
							</span>
							<span style="background: #4facfe; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px;">
								✓ ₪${totalPaid.toFixed(0)}
							</span>
							<span style="background: ${totalDebt > 0 ? '#e74c3c' : '#27ae60'}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px;">
								${totalDebt > 0 ? '⚠ חוב ₪' + Math.abs(totalDebt).toFixed(0) : '✓ ללא חוב'}
							</span>
						</div>
						<div style="display: flex; align-items: center; gap: 10px; background: #e8f5e9; padding: 8px 12px; border-radius: 8px; border: 1px solid #4caf50;">
							<div style="font-size: 12px; color: #2e7d32;">
								<div>📅 הבא: <strong>${formatDate(client.next_visit)}</strong></div>
								<div style="font-size: 11px; color: #666;">אחרון: ${lastVisit !== 'אין' ? formatDate(lastVisit) : 'אין'}</div>
							</div>
							<button onclick="startTreatment('${clientId}')" 
									title="התחל טיפול עכשיו"
									style="padding: 6px 10px; background: #4caf50; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;">
								▶️
							</button>
							<button onclick="showBalanceReportModal('${clientId}')" 
									title="הפק דוח מאזן PDF"
									style="padding: 6px 10px; background: #9b59b6; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;">
								📄
							</button>
						</div>
					</div>
					
					<!-- Tabs -->
					<div style="border-bottom: 2px solid #e0e0e0; margin-bottom: 20px;">
						<button onclick="switchClientProfileTab('treatments')" 
								class="client-profile-tab active" 
								data-tab="treatments"
								style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid #3498db; cursor: pointer; font-size: 15px; font-weight: bold; color: #3498db;">
							🔧 טיפולים (${totalVisits})
						</button>
						<button onclick="switchClientProfileTab('payments')" 
								class="client-profile-tab" 
								data-tab="payments"
								style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 15px; color: #666;">
							💰 תשלומים
						</button>
						<button onclick="switchClientProfileTab('info')" 
								class="client-profile-tab" 
								data-tab="info"
								style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 15px; color: #666;">
							ℹ️ פרטים
						</button>
						<button onclick="switchClientProfileTab('tasks')" 
								class="client-profile-tab" 
								data-tab="tasks"
								style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 15px; color: #666;">
							📋 משימות
						</button>
						<button onclick="switchClientProfileTab('stats')" 
								class="client-profile-tab" 
								data-tab="stats"
								style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 15px; color: #666;">
							📊 סטטיסטיקה
						</button>
						<button onclick="switchClientProfileTab('expenses')" 
								class="client-profile-tab" 
								data-tab="expenses"
								style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 15px; color: #666;">
							💰 הוצאות
						</button>
					</div>
					
					<!-- Tab Content -->
					<div id="clientProfileTabContent">
						<!-- Will be populated by switchClientProfileTab -->
					</div>
					
					<!-- Close Button -->
					<div style="text-align: center; margin-top: 20px;">
						<button onclick="closeAnyModal()" 
								style="padding: 10px 30px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
							סגור
						</button>
					</div>
				</div>
			`;
			
			showEditModal(modalHTML);
			
			// Show treatments tab by default
			setTimeout(() => switchClientProfileTab('treatments', clientId), 100);
		}


		// ✅ NEW: Switch between tabs in client profile
		function switchClientProfileTab(tabName, clientId) {
			// If clientId not provided, try to get it from the modal
			if (!clientId) {
				const modal = document.getElementById('editModal');
				if (!modal) return;
				// Try to extract clientId from the modal content
				const startButton = modal.querySelector('[onclick*="startTreatment"]');
				if (startButton) {
					const match = startButton.getAttribute('onclick').match(/'([^']+)'/);
					clientId = match ? match[1] : null;
				}
			}
			
			if (!clientId) {
				console.error('Client ID not found');
				return;
			}
			
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			// Update tab buttons
			document.querySelectorAll('.client-profile-tab').forEach(btn => {
				if (btn.dataset.tab === tabName) {
					btn.style.borderBottom = '3px solid #3498db';
					btn.style.color = '#3498db';
					btn.style.fontWeight = 'bold';
				} else {
					btn.style.borderBottom = '3px solid transparent';
					btn.style.color = '#666';
					btn.style.fontWeight = 'normal';
				}
			});
			
			const contentDiv = document.getElementById('clientProfileTabContent');
			if (!contentDiv) return;
			
			// Generate content based on tab
			let html = '';
			
			if (tabName === 'treatments') {
				// Treatments tab
				const clientVisits = visits
					.filter(v => v.location_id === clientId)
					.sort((a, b) => b.date.localeCompare(a.date));
				
				if (clientVisits.length === 0) {
					html = '<div style="text-align: center; padding: 40px; color: #666;">עדיין אין טיפולים ללקוח זה</div>';
				} else {
					html = `
						<div style="max-height: 400px; overflow-y: auto;">
							<table style="width: 100%; border-collapse: collapse;">
								<thead style="position: sticky; top: 0; background: #f8f9fa;">
									<tr style="border-bottom: 2px solid #dee2e6;">
										<th style="padding: 8px; text-align: right;">תאריך</th>
										<th style="padding: 8px; text-align: right;">זמן</th>
										<th style="padding: 8px; text-align: right;">סכום</th>
										<th style="padding: 8px; text-align: right;">תשלום</th>
										<th style="padding: 8px; text-align: center;">פעולות</th>
									</tr>
								</thead>
								<tbody>
									${clientVisits.map((visit, index) => {
										const paidInfo = parsePaidField(visit.paid);
										let paymentBadge = '';

										if (paidInfo.status === '1') {
											paymentBadge = `<span style="background: #d4edda; color: #155724; padding: 2px 6px; border-radius: 4px; font-size: 11px;">✓</span>`;
										} else if (paidInfo.status === '3') {
											paymentBadge = `<span style="background: #fff3cd; color: #856404; padding: 2px 6px; border-radius: 4px; font-size: 11px;">½</span>`;
										} else if (paidInfo.status === '2') {
											paymentBadge = `<span style="background: #e2e3e5; color: #383d41; padding: 2px 6px; border-radius: 4px; font-size: 11px;">-</span>`;
										} else {
											paymentBadge = `<span style="background: #f8d7da; color: #721c24; padding: 2px 6px; border-radius: 4px; font-size: 11px;">✗</span>`;
										}
										
										const duration = visit.duration_minutes ? `${(visit.duration_minutes / 60).toFixed(1)}ש` : '-';
										const workDone = visit.work_done || '';
										const hasWorkDone = workDone.length > 0;
										
										return `
											<tr style="border-bottom: 1px solid #dee2e6; cursor: ${hasWorkDone ? 'pointer' : 'default'};" 
												onclick="${hasWorkDone ? `toggleVisitDetails('visit-details-${index}')` : ''}">
												<td style="padding: 8px; font-size: 13px;">${formatDate(visit.date)}</td>
												<td style="padding: 8px; font-size: 13px;">${duration}</td>
												<td style="padding: 8px; font-weight: bold; color: #27ae60;">${visit.amount || 0}₪</td>
												<td style="padding: 8px;">${paymentBadge}</td>
												<td style="padding: 8px; text-align: center;" onclick="event.stopPropagation();">
													<button onclick="closeAnyModal(); setTimeout(() => showVisitForm('${visit.ID}'), 100);" 
															style="padding: 4px 6px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" 
															title="עריכת טיפול">✏️</button>
													${paidInfo.status === '0' ? `
														<button onclick="closeAnyModal(); setTimeout(() => showAddPaymentModal('${clientId}'), 100);" 
																style="padding: 4px 6px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 3px;" 
																title="תשלום">💰</button>
													` : ''}
												</td>
											</tr>
											${hasWorkDone ? `
												<tr id="visit-details-${index}" style="display: none; background: #f8f9fa;">
													<td colspan="5" style="padding: 8px 15px; font-size: 12px; color: #666; border-bottom: 1px solid #dee2e6;">
														📝 ${workDone}
													</td>
												</tr>
											` : ''}
										`;
									}).join('')}
								</tbody>
							</table>
						</div>
					`;
				}
				
			} else if (tabName === 'payments') {
				// Payments tab - show actual payments from payments array
				const clientPayments = payments
					.filter(p => p.client_id === clientId)
					.sort((a, b) => b.date.localeCompare(a.date));
				
				html = `
					<div style="margin-bottom: 15px; text-align: center;">
						<button onclick="showAddPaymentModal('${clientId}')" 
								style="padding: 12px 24px; background: #27ae60; color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);">
							➕ הוסף תשלום
						</button>
					</div>
				`;
				
				if (clientPayments.length === 0) {
					html += '<div style="text-align: center; padding: 40px; color: #666;">עדיין אין תשלומים ללקוח זה</div>';
				} else {
					const totalPaid = clientPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
					
					html += `
						<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #27ae60;">
							<div style="display: flex; justify-content: space-between; align-items: center;">
								<span style="font-size: 14px; color: #27ae60; font-weight: bold;">סך הכל תשלומים:</span>
								<span style="font-size: 24px; font-weight: bold; color: #27ae60;">₪${totalPaid.toFixed(2)}</span>
							</div>
						</div>
						
						<div style="max-height: 400px; overflow-y: auto;">
							${clientPayments.map(payment => {
								// מצא טיפולים מקושרים
								const relatedLinks = paymentVisitLinks.filter(link => link.payment_id === payment.ID);
								const linkedVisitsCount = relatedLinks.length;
								const totalLinked = relatedLinks.reduce((sum, link) => sum + (link.amount_allocated || 0), 0);
								
								// טקסט אמצעי תשלום
								let methodText = '';
								switch(payment.payment_method) {
									case 'cash': methodText = '💵 מזומן'; break;
									case 'check': methodText = '📝 צ\'ק'; break;
									case 'transfer': methodText = '🏦 העברה'; break;
									case 'app': methodText = '📱 אפליקציה'; break;
									default: methodText = payment.payment_method || '';
								}
								
								return `
									<div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 12px; background: white;">
										<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
											<div>
												<div style="font-size: 16px; font-weight: bold; color: #2c3e50;">${formatDate(payment.date)}</div>
												<div style="font-size: 13px; color: #666; margin-top: 3px;">${methodText}</div>
											</div>
											<div style="text-align: left;">
												<div style="font-size: 24px; font-weight: bold; color: #27ae60;">₪${payment.amount.toFixed(2)}</div>
												${linkedVisitsCount > 0 ? 
													`<div style="font-size: 11px; color: #666; margin-top: 2px;">מקושר: ₪${totalLinked.toFixed(2)}</div>` 
													: ''}
											</div>
										</div>
										
										${payment.reference ? 
											`<div style="font-size: 12px; color: #666; margin-bottom: 5px;">
												<strong>אסמכתא:</strong> ${payment.reference}
											</div>` 
											: ''}
										
										${payment.check_date ? 
											`<div style="font-size: 12px; color: #666; margin-bottom: 5px;">
												<strong>תאריך פירעון:</strong> ${formatDate(payment.check_date)}
											</div>` 
											: ''}
										
										${payment.notes ? 
											`<div style="font-size: 13px; color: #555; background: #f8f9fa; padding: 8px; border-radius: 4px; margin-top: 8px;">
												💬 ${payment.notes}
											</div>` 
											: ''}
										
										${linkedVisitsCount > 0 ? 
											`<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6;">
												<div style="font-size: 12px; color: #666; font-weight: bold; margin-bottom: 5px;">
													🔗 מקושר ל-${linkedVisitsCount} טיפולים
												</div>
											</div>` 
											: `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6; font-size: 12px; color: #f39c12;">
												⚠️ לא מקושר לטיפולים
											</div>`}
										
										<div style="text-align: center; margin-top: 10px;">
											<button onclick="showPaymentDetails('${payment.ID}')" 
													style="padding: 6px 16px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">
												🔍 פרטים מלאים
											</button>
										</div>
									</div>
								`;
							}).join('')}
						</div>
					`;
				}
				
			} else if (tabName === 'info') {
				// Info tab
				html = `
					<div style="display: grid; gap: 15px;">
						<div>
							<strong style="color: #666;">כתובת מלאה:</strong>
							<div style="margin-top: 5px;">${client.full_address}</div>
						</div>
						<div>
							<strong style="color: #666;">איש קשר:</strong>
							<div style="margin-top: 5px;">${client.contact_person || 'לא צוין'}</div>
						</div>
						<div>
							<strong style="color: #666;">טלפון:</strong>
							<div style="margin-top: 5px;">${client.phone || 'לא צוין'}</div>
						</div>
						<div>
							<strong style="color: #666;">יום מועדף:</strong>
							<div style="margin-top: 5px;">${client.allowed_day || 'לא צוין'}</div>
						</div>
						<div>
							<strong style="color: #666;">תדירות (שבועות):</strong>
							<div style="margin-top: 5px;">${client.interval_weeks || 4} שבועות</div>
						</div>
						<div>
							<strong style="color: #666;">מחיר בסיס:</strong>
							<div style="margin-top: 5px;">${client.base_amount || 0}₪</div>
						</div>
						<div>
							<strong style="color: #666;">הערות:</strong>
							<div style="margin-top: 5px; background: #f8f9fa; padding: 10px; border-radius: 5px; min-height: 60px;">
								${client.notes || 'אין הערות'}
							</div>
						</div>
						<div style="text-align: center; margin-top: 10px;">
							<button onclick="editLocation('${clientId}')" 
									style="padding: 8px 20px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">
								✏️ ערוך פרטי לקוח
							</button>
						</div>
					</div>
				`;
			} else if (tabName === 'tasks') {
				// Tasks tab
				const clientTasks = tasks.filter(t => t.client_id === clientId);
				
				html = `
					<div style="margin-bottom: 15px; text-align: center;">
						<button onclick="closeAnyModal(); setTimeout(() => { showAddTaskModal('${clientId}'); }, 100);" 
								style="padding: 12px 24px; background: #9b59b6; color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; font-weight: bold;">
							➕ הוסף משימה
						</button>
					</div>
				`;
				
				if (clientTasks.length === 0) {
					html += '<div style="text-align: center; padding: 40px; color: #666;">אין משימות ללקוח זה</div>';
				} else {
					html += `<div style="max-height: 300px; overflow-y: auto;">`;
					clientTasks.forEach(task => {
						const typeInfo = TASK_TYPES[task.type] || TASK_TYPES['other'];
						const statusInfo = TASK_STATUSES[task.status] || TASK_STATUSES['pending'];
						
						html += `
							<div style="background: ${statusInfo.bg}; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-right: 4px solid ${statusInfo.color};">
								<div style="display: flex; justify-content: space-between; align-items: start;">
									<div style="flex: 1;">
										<div style="font-weight: 600; color: #333;">
											${typeInfo.icon} ${task.description}
										</div>
										<div style="font-size: 12px; color: #666; margin-top: 5px;">
											📅 יעד: ${formatDate(task.due_date)} | ${statusInfo.icon} ${statusInfo.label}
										</div>
										${task.notes ? `<div style="font-size: 11px; color: #888; margin-top: 3px;">💬 ${task.notes}</div>` : ''}
									</div>
									<div style="display: flex; gap: 5px;">
										<button onclick="closeAnyModal(); setTimeout(() => showEditTaskModal('${task.ID}'), 100);" 
												style="padding: 4px 8px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">✏️</button>
									</div>
								</div>
							</div>
						`;
					});
					html += `</div>`;
				}
			} else if (tabName === 'stats') {
				// Statistics tab - monthly breakdown
				const clientVisits = visits
					.filter(v => v.location_id === clientId)
					.sort((a, b) => b.date.localeCompare(a.date));
				
				// Target rate (can be customized later)
				const targetRate = 150; // ש"ח לשעה
				
				// Group visits by month
				const monthlyData = {};
				clientVisits.forEach(visit => {
					const date = new Date(visit.date);
					const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
					
					if (!monthlyData[monthKey]) {
						monthlyData[monthKey] = {
							month: monthKey,
							visits: 0,
							totalMinutes: 0,
							totalIncome: 0
						};
					}
					
					monthlyData[monthKey].visits++;
					monthlyData[monthKey].totalMinutes += parseFloat(visit.duration_minutes) || 0;
					monthlyData[monthKey].totalIncome += parseFloat(visit.amount) || 0;
				});
				
				// Convert to array and sort by month (newest first)
				const monthlyArray = Object.values(monthlyData).sort((a, b) => b.month.localeCompare(a.month));
				
				// Calculate overall averages
				const totalHours = monthlyArray.reduce((sum, m) => sum + m.totalMinutes / 60, 0);
				const totalIncome = monthlyArray.reduce((sum, m) => sum + m.totalIncome, 0);
				const overallRate = totalHours > 0 ? totalIncome / totalHours : 0;
				
				// Format month name
				const formatMonth = (monthKey) => {
					const [year, month] = monthKey.split('-');
					const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
					return `${monthNames[parseInt(month) - 1]} ${year}`;
				};
				
				html = `
					<!-- Overall Summary -->
					<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
						<div style="text-align: center; margin-bottom: 15px;">
							<div style="font-size: 14px; opacity: 0.9;">ממוצע הכנסה לשעה</div>
							<div style="font-size: 36px; font-weight: bold;">${overallRate.toFixed(0)} ₪</div>
							<div style="font-size: 12px; margin-top: 5px; padding: 5px 10px; border-radius: 20px; display: inline-block; background: ${overallRate >= targetRate ? 'rgba(39, 174, 96, 0.3)' : 'rgba(231, 76, 60, 0.3)'};">
								${overallRate >= targetRate ? '✓ מעל היעד' : '⚠ מתחת ליעד'} (${targetRate} ₪/שעה)
							</div>
						</div>
						<div style="display: flex; justify-content: space-around; text-align: center;">
							<div>
								<div style="font-size: 24px; font-weight: bold;">${totalHours.toFixed(1)}</div>
								<div style="font-size: 12px; opacity: 0.9;">שעות סה"כ</div>
							</div>
							<div>
								<div style="font-size: 24px; font-weight: bold;">${totalIncome.toFixed(0)} ₪</div>
								<div style="font-size: 12px; opacity: 0.9;">הכנסה סה"כ</div>
							</div>
							<div>
								<div style="font-size: 24px; font-weight: bold;">${monthlyArray.length}</div>
								<div style="font-size: 12px; opacity: 0.9;">חודשים</div>
							</div>
						</div>
					</div>
					
					<!-- Monthly Table -->
					<div style="max-height: 350px; overflow-y: auto;">
						<table style="width: 100%; border-collapse: collapse;">
							<thead style="position: sticky; top: 0; background: #f8f9fa;">
								<tr style="border-bottom: 2px solid #dee2e6;">
									<th style="padding: 10px; text-align: right; font-weight: 600;">חודש</th>
									<th style="padding: 10px; text-align: center; font-weight: 600;">טיפולים</th>
									<th style="padding: 10px; text-align: center; font-weight: 600;">שעות</th>
									<th style="padding: 10px; text-align: center; font-weight: 600;">הכנסה</th>
									<th style="padding: 10px; text-align: center; font-weight: 600;">לשעה</th>
								</tr>
							</thead>
							<tbody>
								${monthlyArray.length === 0 ? `
									<tr>
										<td colspan="5" style="padding: 40px; text-align: center; color: #666;">אין נתונים להצגה</td>
									</tr>
								` : monthlyArray.map(m => {
									const hours = m.totalMinutes / 60;
									const rate = hours > 0 ? m.totalIncome / hours : 0;
									const rateColor = rate >= targetRate ? '#27ae60' : rate >= targetRate * 0.8 ? '#f39c12' : '#e74c3c';
									
									return `
										<tr style="border-bottom: 1px solid #dee2e6;">
											<td style="padding: 10px; font-weight: 500;">${formatMonth(m.month)}</td>
											<td style="padding: 10px; text-align: center;">${m.visits}</td>
											<td style="padding: 10px; text-align: center;">${hours.toFixed(1)}</td>
											<td style="padding: 10px; text-align: center; font-weight: 600; color: #27ae60;">${m.totalIncome.toFixed(0)} ₪</td>
											<td style="padding: 10px; text-align: center;">
												<span style="background: ${rateColor}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
													${rate.toFixed(0)} ₪
												</span>
											</td>
										</tr>
									`;
								}).join('')}
							</tbody>
						</table>
					</div>
				`;
			} else if (tabName === 'expenses') {
				// Client expenses tab
				const clientExpenses = expenses
					.filter(exp => exp.client_id === clientId)
					.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
				
				const totalExpenses = clientExpenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
				
				html = `
					<div style="margin-bottom: 15px; text-align: center;">
						<button onclick="closeAnyModal(); setTimeout(() => showAddExpenseModal('${clientId}', '${client.name}'), 100);" 
								style="padding: 12px 24px; background: #e74c3c; color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; font-weight: bold;">
							➕ הוסף הוצאה ללקוח
						</button>
					</div>
				`;
				
				if (clientExpenses.length === 0) {
					html += '<div style="text-align: center; padding: 40px; color: #666;">אין הוצאות ללקוח זה</div>';
				} else {
					html += `
						<div style="background: #fce4ec; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #e74c3c;">
							<div style="display: flex; justify-content: space-between; align-items: center;">
								<span style="font-size: 14px; color: #c0392b; font-weight: bold;">סה"כ הוצאות ללקוח:</span>
								<span style="font-size: 24px; font-weight: bold; color: #e74c3c;">${totalExpenses.toFixed(0)} ₪</span>
							</div>
						</div>
						
						<div style="max-height: 300px; overflow-y: auto;">
							${clientExpenses.map(exp => {
								const category = EXPENSE_CATEGORIES[exp.category] || EXPENSE_CATEGORIES['other'];
								const payment = PAYMENT_METHODS[exp.payment_method] || PAYMENT_METHODS['cash'];
								
								return `
									<div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-bottom: 8px; border-right: 4px solid #e74c3c;">
										<div style="display: flex; justify-content: space-between; align-items: center;">
											<div>
												<div style="font-weight: 600; color: #333;">${category.icon} ${exp.description}</div>
												<div style="font-size: 12px; color: #666; margin-top: 3px;">
													📅 ${formatDate(exp.date)} | ${payment.icon} ${payment.name}
												</div>
												${exp.vendor_name ? `<div style="font-size: 11px; color: #888; margin-top: 2px;">🏪 ${exp.vendor_name}</div>` : ''}
											</div>
											<div style="font-size: 18px; font-weight: bold; color: #e74c3c;">
												${exp.amount} ₪
											</div>
										</div>
									</div>
								`;
							}).join('')}
						</div>
					`;
				}
			}
			
			
			contentDiv.innerHTML = html;
		}


		function editLocation(locationId) {
			console.log(`✅ editLocation ('${locationId}')`);
			const location = locations.find(g => g.ID == locationId);
			if (!location) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			console.log(`✅ editLocation second: ('${locationId}')`);
			
			// Calculate last treatment date from actual visits
			const clientVisits = visits.filter(visit => visit.location_id === locationId);
			const lastTreatmentDate = clientVisits.length > 0 
				? clientVisits.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date
				: location.last_visit || '';
			
			// צור חלון עריכה
			const editModalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90vw; max-height: 80vh; overflow-y: auto; position: relative;">
					<button onclick="closeAnyModal()" style="position: absolute; top: 15px; left: 15px; background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px; font-weight: bold;">×</button>
					<h3 style="margin-bottom: 20px; color: #2c3e50;">🏠 עריכת לקוח - ${location.name}</h3>	
					<form id="editLocationForm">
						<div class="form-group">
							<label>שם הלקוח:</label>
							<input type="text" id="editLocationName" value="${location.name || ''}" required>
						</div>
						
						<div class="form-group">
							<label>כתובת מלאה:</label>
							<input type="text" id="editLocationAddress" value="${location.full_address || ''}" required>
						</div>
						
						<div class="form-group">
							<label>שכונה:</label>
							<input type="text" id="editLocationNeighborhood" value="${location.neighborhood || ''}">
						</div>
						
						<div class="form-group">
							<label>עיר:</label>
							<input type="text" id="editLocationCity" value="${location.city || ''}">
						</div>
						
						<div class="form-group">
							<label>איש קשר:</label>
							<input type="text" id="editLocationContact" value="${location.contact_person || ''}">
						</div>
						
						<div class="form-group">
							<label>טלפון:</label>
							<input type="tel" id="editLocationPhone" value="${location.phone || ''}">
						</div>
						
						<div class="form-group">
							<label>יום מועדף:</label>
							<select id="editLocationDay" value="${location.allowed_day||''}">
								<option value="כל יום" ${location.allowed_day === 'כל יום' ? 'selected' : ''}>כל יום</option>
								<option value="א" ${location.allowed_day === 'א' ? 'selected' : ''}>א (ראשון)</option>
								<option value="ב" ${location.allowed_day === 'ב' ? 'selected' : ''}>ב (שני)</option>
								<option value="ג" ${location.allowed_day === 'ג' ? 'selected' : ''}>ג (שלישי)</option>
								<option value="ד" ${location.allowed_day === 'ד' ? 'selected' : ''}>ד (רביעי)</option>
								<option value="ה" ${location.allowed_day === 'ה' ? 'selected' : ''}>ה (חמישי)</option>
								<option value="ו" ${location.allowed_day === 'ו' ? 'selected' : ''}>ו (שישי)</option>
								<option value="ש" ${location.allowed_day === 'ש' ? 'selected' : ''}>ש (שבת)</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>מרווח בשבועות:</label>
							<input type="number" id="editLocationInterval" value="${location.interval_weeks || 4}" min="1" required onchange="updateNextVisitFromInterval()">
						</div>
						
						<div class="form-group">
							<label>סכום בסיס (₪):</label>
							<input type="number" id="editLocationAmount" value="${location.base_amount || 0}" step="0.01">
						</div>
						
						<div class="form-group">
							<label>סטטוס:</label>
							<select id="editLocationActive">
								<option value="1" ${location.active === '1' ? 'selected' : ''}>פעיל</option>
								<option value="0" ${location.active === '0' ? 'selected' : ''}>לא פעיל</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>טיפול אחרון:</label>
							<input type="date" id="editLocationLastVisit" value="${lastTreatmentDate}" readonly style="background: #f8f9fa;">
						</div>

						<div class="form-group">
							<label>טיפול הבא:</label>
							<input type="date" id="editLocationNextVisit" value="${location.next_visit || ''}">
						</div>
						
						<div class="form-group">
							<label>הערות:</label>
							<textarea id="editLocationNotes" rows="3">${location.notes || ''}</textarea>
						</div>
						
						<div class="form-group">
							<label>בקשות לקוח:</label>
							<textarea id="editLocationClientRequests" rows="2">${location.client_requests || ''}</textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="button" onclick="saveEditedLocation('${locationId}')" class="btn btn-success">
								💾 שמור שינויים
							</button>
							<button type="button" onclick="closeAnyModal()" class="btn btn-secondary">
								❌ ביטול
							</button>
						</div>
					</form>
				</div>
			`;
			
			// הצג את המודל
			showEditModal(editModalHTML);
		}


       function deleteLocation(locationId) {
           if (confirm('האם אתה בטוח שברצונך למחוק את הלקוח?')) {
               locations = locations.filter(g => g.ID != locationId);
               loadLocationsTable();
               loadLocationsForSelect();
               loadPlanningData();
               showSuccess('לקוח נמחק בהצלחה!');
			   saveToLocalStorage();
           }
       }

       // Receipt management
       function showAddReceiptForm() {
			const modalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<div style="position: relative;">
						<button onclick="closeAnyModal()" style="position: absolute; top: 0; left: 0; background: #e74c3c; border: none; color: white; font-size: 20px; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">×</button>
						<h3 style="margin-bottom: 20px; color: #2c3e50;">🧾 הוספת קבלה חדשה</h3>
					</div>
					
					<form id="receiptForm" onsubmit="handleReceiptSubmit(event)">
						<div class="form-group">
							<label for="receiptBook">מספר פנקס:</label>
							<input type="text" id="receiptBook" required>
						</div>
						
						<div class="form-group">
							<label for="receiptNumber">מספר קבלה:</label>
							<input type="text" id="receiptNumber" required>
						</div>
						
						<div class="form-group">
							<label for="receiptDate">תאריך:</label>
							<input type="date" id="receiptDate" required>
						</div>
						
						<div class="form-group">
							<label for="receiptLocation">לקוח:</label>
							<select id="receiptLocation" required>
								<option value="">בחר לקוח</option>
							</select>
						</div>
						
						<div class="form-group">
							<label for="receiptAmount">סכום (₪):</label>
							<input type="number" step="0.01" id="receiptAmount" required>
						</div>
						
						<div class="form-group">
							<label for="receiptPaymentType">סוג תשלום:</label>
							<select id="receiptPaymentType">
								<option value="מזומן">מזומן</option>
								<option value="העברה">העברה</option>
								<option value="צ'ק">צ'ק</option>
								<option value="כרטיס אשראי">כרטיס אשראי</option>
							</select>
						</div>
						
						<div class="form-group">
							<label for="receiptNotes">הערות:</label>
							<textarea id="receiptNotes" rows="3"></textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="submit" class="btn btn-success">
								💾 שמור קבלה
							</button>
							<button type="button" onclick="closeAnyModal()" class="btn btn-secondary">
								❌ ביטול
							</button>
						</div>
					</form>
				</div>
			`;
			
			showEditModal(modalHTML);
			
			// הגדרות ראשוניות
			setTimeout(() => {
				// הגדרת תאריך היום
				document.getElementById('receiptDate').value = getLocalDateString();
				
				// טעינת לקוחות לבחירה
				const receiptLocation = document.getElementById('receiptLocation');
				locations.forEach(location => {
					const option = document.createElement('option');
					option.value = location.ID;
					option.textContent = `${location.name} - ${location.full_address}`;
					receiptLocation.appendChild(option);
				});
			}, 100);
		}

		async function handleReceiptSubmit(event) {
			event.preventDefault();
			
			try {
				// מצא את הלקוח הנבחר
				const selectedLocationId = document.getElementById('receiptLocation').value;
				const location = locations.find(loc => loc.ID === selectedLocationId);
				
				if (!selectedLocationId || !location) {
					showToast('חובה לבחור לקוח', 'error');
					return;
				}
				
				const receiptData = {
					ID: generateID(),
					book_number: document.getElementById('receiptBook').value,
					receipt_number: document.getElementById('receiptNumber').value,
					date: document.getElementById('receiptDate').value,
					location_id: selectedLocationId,
					location_name: location.name,
					amount: parseFloat(document.getElementById('receiptAmount').value),
					payment_type: document.getElementById('receiptPaymentType').value,
					notes: document.getElementById('receiptNotes').value || ''
				};
				
				// בדיקת תקינות
				const errors = validateReceiptData(receiptData);
				if (showValidationErrors(errors)) {
					return;
				}
				
				// בדיקת כפילויות קבלה
				const existingReceipt = receipts.find(receipt => 
					(receipt.book_number === receiptData.book_number && receipt.receipt_number === receiptData.receipt_number) ||
					(receipt.location_id === receiptData.location_id && receipt.date === receiptData.date && receipt.amount === receiptData.amount)
				);

				if (existingReceipt) {
					if (!confirm(`כבר קיימת קבלה עם אותו מספר או באותה כתובת/תאריך/סכום.\n\nהאם להוסיף בכל זאת?`)) {
						return;
					}
				}
				
				// הוספה למערך
				receipts.push(receiptData);
				
				// שמירה מקומית
				saveToLocalStorage();
				
				// שמירה בענן
				if (access_token) {
					try {
						await saveReceiptToSheets(receiptData);
						showToast('קבלה נשמרה בהצלחה במערכת ובענן!', 'success');
					} catch (error) {
						showToast('קבלה נשמרה מקומית, אך נכשלה בשמירה לענן', 'warning');
					}
				} else {
					showToast('קבלה נשמרה מקומית - התחבר לענן לשמירה מלאה', 'info');
				}

				// סגירת המודל ורענון
				closeAnyModal();
				loadReceiptsTable();
				loadReceiptFilterOptions();
				
			} catch (error) {
				console.error('Error saving receipt:', error);
				showToast('שגיאה בשמירת הקבלה', 'error');
			}
		}

       // Utility functions
       function closeModal(modalId) {
           document.getElementById(modalId).style.display = 'none';
       }

		// Get today's date in local timezone as YYYY-MM-DD string
		function getLocalDateString(date = new Date()) {
			return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
		}

       function formatDate(dateString) {
           const date = new Date(dateString);
           return date.toLocaleDateString('he-IL');
       }

       function showLoading(message = 'בתהליך...') {
			const overlay = document.getElementById('loadingOverlay');
			const text = document.getElementById('loadingText');
			if (overlay && text) {
				text.textContent = message;
				overlay.classList.remove('hidden');
			}
			console.log('Loading:', message);
		}

		function hideLoading() {
			const overlay = document.getElementById('loadingOverlay');
			if (overlay) {
				overlay.classList.add('hidden');
			}
			console.log('Loading complete');
		}

       
       // Click outside modal to close
       window.onclick = function(event) {
           if (event.target.classList.contains('modal')) {
               event.target.style.display = 'none';
           }
       }
	   
	  function editReceipt(receiptId) {
			console.log(`✅ editReceipt ('${receiptId}')`);
			const receipt = receipts.find(r => r.ID == receiptId);
			if (!receipt) {
				showToast('קבלה לא נמצאה', 'error');
				return;
			}
			
			// בניית אפשרויות הלקוחות
			let locationOptions = '<option value="">בחר לקוח</option>';
			locations.forEach(location => {
				const selected = location.ID == receipt.location_id ? 'selected' : '';
				locationOptions += `<option value="${location.ID}" ${selected}>${location.name} - ${location.full_address}</option>`;
			});
			
			// צור חלון עריכה
			const editModalHTML = `
				<div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">🧾 עריכת קבלה</h3>
					
					<form id="editReceiptForm">
						<div class="form-group">
							<label>מספר פנקס:</label>
							<input type="text" id="editReceiptBook" value="${receipt.book_number || ''}" required>
						</div>
						
						<div class="form-group">
							<label>מספר קבלה:</label>
							<input type="text" id="editReceiptNumber" value="${receipt.receipt_number || ''}" required>
						</div>
						
						<div class="form-group">
							<label>תאריך:</label>
							<input type="date" id="editReceiptDate" value="${receipt.date}" required>
						</div>
						
						<div class="form-group">
							<label>לקוח:</label>
							<select id="editReceiptLocation" required>
								${locationOptions}
							</select>
						</div>
						
						<div class="form-group">
							<label>סכום (₪):</label>
							<input type="number" step="0.01" id="editReceiptAmount" value="${receipt.amount || 0}" required>
						</div>
						
						<div class="form-group">
							<label>סוג תשלום:</label>
							<select id="editReceiptPaymentType">
								<option value="מזומן" ${receipt.payment_type === 'מזומן' ? 'selected' : ''}>מזומן</option>
								<option value="העברה" ${receipt.payment_type === 'העברה' ? 'selected' : ''}>העברה</option>
								<option value="צ׳ק" ${receipt.payment_type === 'צ׳ק' ? 'selected' : ''}>צ׳ק</option>
								<option value="כרטיס אשראי" ${receipt.payment_type === 'כרטיס אשראי' ? 'selected' : ''}>כרטיס אשראי</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>הערות:</label>
							<textarea id="editReceiptNotes" rows="3">${receipt.notes || ''}</textarea>
						</div>
						
						<div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
							<button type="button" onclick="saveEditedReceipt('${receiptId}')" class="btn btn-success">
								💾 שמור שינויים
							</button>
							<button type="button" onclick="closeAnyModal()" class="btn btn-secondary">
								❌ ביטול
							</button>
						</div>
					</form>
				</div>
			`;
			
			// הצג את המודל
			showEditModal(editModalHTML);
		}

		
		// פונקציה לעדכון הקבלה בענן (אופציונלית)
		async function updateReceiptInCloud(updatedReceipt) {
			if (!await validateToken()) return;
			
			try {
				// קריאת כל הנתונים מהענן
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Receipts!A:I'
				});
				
				const rows = response.result.values || [];
				
				// מציאת השורה לעדכון
				let rowToUpdate = -1;
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] == updatedReceipt.ID) {
						rowToUpdate = i + 1; // +1 כי Google Sheets מתחיל מ-1
						break;
					}
				}
				
				if (rowToUpdate > 0) {
					// עדכון השורה
					const updatedRow = [
						updatedReceipt.ID,
						updatedReceipt.book_number,
						updatedReceipt.receipt_number,
						updatedReceipt.date,
						updatedReceipt.location_id,
						updatedReceipt.location_name,
						updatedReceipt.amount,
						updatedReceipt.payment_type,
						updatedReceipt.notes
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Receipts!A${rowToUpdate}:I${rowToUpdate}`,
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [updatedRow]
						}
					});
					
					console.log(`✅ Updated receipt ${updatedReceipt.ID} in cloud`);
				}
				
			} catch (error) {
				console.error('Error updating receipt in cloud:', error);
				throw error;
			}
		}

		
		function deleteReceipt(receiptId) {
			if (confirm('האם אתה בטוח שברצונך למחוק את הקבלה?')) {
				receipts = receipts.filter(r => r.ID != receiptId);
				loadReceiptsTable();
				loadReceiptFilterOptions();
				saveToLocalStorage();
				showSuccess('קבלה נמחקה בהצלחה!');
			}
		}
	   
	   // תוספה - הודעות Toast מתקדמות
		function showToast(message, type = 'info', duration = 3000) {
			const toastContainer = document.getElementById('toastContainer');
			
			if (!toastContainer) {
				console.error('Toast container not found');
				return;
			}
			
			const toast = document.createElement('div');
			toast.className = `toast ${type}`;
			toast.textContent = message;
			
			toastContainer.appendChild(toast);
			
			// Trigger animation
			setTimeout(() => {
				toast.classList.add('show');
			}, 100);
			
			// Remove toast after specified duration
			setTimeout(() => {
				toast.classList.remove('show');
				setTimeout(() => {
					if (toast.parentNode) {
						toast.parentNode.removeChild(toast);
					}
				}, 300);
			}, duration);
		}
	   
	   // פונקציות עזר להודעות
		function showSuccess(message, duration = 3000) {
			showToast(message, 'success', duration);
		}

		function showError(message, duration = 4000) {
			showToast(message, 'error', duration);
		}

		function showWarning(message, duration = 3500) {
			showToast(message, 'warning', duration);
		}

		function showInfo(message, duration = 3000) {
			showToast(message, 'info', duration);
		}
	   
	   
		// יצירת טבלת עזר לייבוא
		async function clearAllDataBeforeImport() {
			if (!confirm('האם אתה בטוח שברצונך למחוק את כל הנתונים הקיימים לפני הייבוא החדש?\n\nפעולה זו תמחק:\n- את כל המיקומים\n- את כל הביקורים\n- את כל הקבלות\n- את כל התשלומים\n- את כל הקישורים בין תשלומים לביקורים\n- את כל ההכנסות\n\nהנתונים בגוגל שיטס לא יימחקו.')) {
				return false;
			}
			
			try {
				console.log('🗑️ Starting complete data cleanup...');
				
				// Clear all arrays
				locations = [];
				visits = [];
				receipts = [];
				payments = [];
				paymentVisitLinks = [];
				incomes = [];  // ✅ ADDED: Clear incomes too
				
				console.log('✅ All arrays cleared');
				
				// Save empty arrays to localStorage
				saveToLocalStorage();
				console.log('✅ Empty data saved to localStorage');
				
				// Clear localStorage keys explicitly (belt and suspenders approach)
				localStorage.removeItem('locations_data');
				localStorage.removeItem('visits_data');
				localStorage.removeItem('receipts_data');
				localStorage.removeItem('payments_data');
				localStorage.removeItem('payment_links_data');
				localStorage.removeItem('incomes_data');
				console.log('✅ localStorage keys removed');
				
				// Update UI displays
				if (typeof loadLocationsTable === 'function') {
					loadLocationsTable();
					console.log('✅ Locations table refreshed');
				}
				if (typeof loadLocationsForSelect === 'function') {
					loadLocationsForSelect();
					console.log('✅ Location selectors refreshed');
				}
				if (typeof displayDebts === 'function') {
					displayDebts();
					console.log('✅ Debts display refreshed');
				}
				if (typeof displayPayments === 'function') {
					displayPayments();
					console.log('✅ Payments display refreshed');
				}
				if (typeof displayReceipts === 'function') {
					displayReceipts();
					console.log('✅ Receipts display refreshed');
				}
				if (typeof displayVisits === 'function') {
					displayVisits();
					console.log('✅ Visits display refreshed');
				}
				
				showToast('✅ כל הנתונים המקומיים נוקו בהצלחה', 'success');
				console.log('✅ Complete cleanup finished successfully');
				return true;
				
			} catch (error) {
				console.error('❌ Error during cleanup:', error);
				showToast('❌ שגיאה בניקוי נתונים', 'error');
				return false;
			}
		}
		
		
		// שיפור לפונקציה הקיימת
		async function createImportTable() {
			if (!await validateToken()) {
				showToast('התחבר לגוגל קודם', 'warning');
				return;
			}
			
			try {
				showLoading('יוצר טבלת עזר לייבוא...');
				
				const response = await gapi.client.sheets.spreadsheets.create({
					resource: {
						properties: {
							title: `import_table_${getLocalDateString()}`
						},
						sheets: [{
						properties: { title: 'Locations' },
						}, {
							properties: { title: 'Visits' },
						}, {
							properties: { title: 'Receipts' }
						}, {
							properties: { title: 'PaymentsImport' }
						}, {
							properties: { title: 'SystemSettings' }
						}]
					}
				});
				
				const newSpreadsheetId = response.result.spreadsheetId;
				
				// הוספת כותרות לכל גליון
				await addImportHeaders(newSpreadsheetId);
				
				// פתיחת הטבלה
				window.open(`https://docs.google.com/spreadsheets/d/${newSpreadsheetId}/edit`, '_blank');
				
				// שמירת ID לייבוא מאוחר יותר
				localStorage.setItem('importTableId', newSpreadsheetId);
				
				showToast('טבלת עזר נוצרה! מלא את הנתונים ואז חזור לייבא', 'success');
				
			} catch (error) {
				console.error('Error creating import table:', error);
				showToast('שגיאה ביצירת טבלת עזר', 'error');
			} finally {
				hideLoading();
			}
		}

		// הוספת כותרות לטבלת עזר
		async function addImportHeaders(spreadsheetId) {
			if (!await validateToken()) {
				showToast('בעיה בחיבור לגוגל במהלך הוספת כותרות', 'error');
				return;
			}

			try {
				// כל הכותרות באנגלית
				const locationHeaders = [['customer_name', 'street', 'house_number', 'city', 'frequency', 'contact_person', 'base_amount', 'allowed_day', 'active']];
				const visitHeaders = [['year', 'month', 'day', 'customer', 'contact_person', 'treatment', 'date', 'work_done', 'duration', 'amount', 'paid', 'expense', 'notes']];
				const receiptHeaders = [['code_x', 'booklet', 'receipt', 'year', 'month', 'day', 'address', 'amount', 'type', 'notes', 'details']];
				const paymentsImportHeaders = [['date', 'time', 'client_address', 'amount', 'payment_method', 'notes', 'original_text']];
					
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				await Promise.all([
				gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: spreadsheetId,
					range: 'Locations!A1:I1',
					valueInputOption: 'RAW',
					resource: { values: locationHeaders }
				}),
				gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: spreadsheetId,
					range: 'Visits!A1:M1',
					valueInputOption: 'RAW', 
					resource: { values: visitHeaders }
				}),
				gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: spreadsheetId,
					range: 'Receipts!A1:K1',
					valueInputOption: 'RAW',
					resource: { values: receiptHeaders }
				}),
				gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: spreadsheetId,
					range: 'PaymentsImport!A1:G1',
					valueInputOption: 'RAW',
					resource: { values: paymentsImportHeaders }
				}),
				gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: spreadsheetId,
					range: 'SystemSettings!A1:B1',
					valueInputOption: 'RAW',
					resource: { values: [['Setting', 'Value']] }
				})
			]);	
				
				console.log('Headers added successfully to import table');
				
			} catch (error) {
				console.error('Error adding headers:', error);
				
				if (error.status === 401) {
					access_token = null;
					showToast('⚠️ החיבור פג במהלך הוספת כותרות', 'warning');
				} else {
					showToast('⚠️ שגיאה בהוספת כותרות לטבלה', 'error');
				}
				throw error;
			}
		}
		
		
		// תוספה - פיענוח כתובת מלאה לחלקים
		function parseFullAddress(fullAddress) {
			if (!fullAddress) return { street: '', houseNumber: '', city: '' };
			
			const parts = fullAddress.trim().split(' ');
			
			if (parts.length >= 3) {
				// העיר היא החלק האחרון
				const city = parts[parts.length - 1];
				
				// מספר הבית הוא החלק הלפני אחרון
				const houseNumber = parts[parts.length - 2];
				
				// הרחוב הוא כל השאר
				const street = parts.slice(0, -2).join(' ');
				
				return { street, houseNumber, city };
			} else if (parts.length === 2) {
				return { street: parts[0], houseNumber: '', city: parts[1] };
			} else {
				return { street: fullAddress, houseNumber: '', city: '' };
			}
		}
	   
	      
	   
	   
	   // תוספה - המרת פורמט תאריך מ-DD/MM/YYYY ל-YYYY-MM-DD
		function convertDateFormat(dateStr) {
			if (!dateStr) return '';
			
			const parts = dateStr.split('/');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = parts[1].padStart(2, '0');
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			
			return dateStr;
		}
	   
	   
	  	   
	   // תוספה - בדיקת תקינות נתונים
		function validateReceiptData(receiptData) {
			const errors = [];
			
			if (!receiptData.location_id) {
				errors.push('חובה לבחור לקוח');
			}
			
			if (!receiptData.amount || receiptData.amount <= 0) {
				errors.push('חובה להזין סכום חיובי');
			}
			
			if (!receiptData.date) {
				errors.push('חובה להזין תאריך');
			}
			
			return errors;
		}

		function showValidationErrors(errors) {
			if (errors.length > 0) {
				showToast(errors.join('\n'), 'error');
				return true; // יש שגיאות
			}
			return false; // אין שגיאות
		}
	   
	   
	    // תוספה - ניהול פאנלי סינון ומידע
		function toggleFilterPanel() {
			const content = document.getElementById('filterContent');
			const icon = document.getElementById('filterIcon');
			
			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				icon.textContent = '🔽';
			} else {
				content.classList.add('collapsed');
				icon.textContent = '🔼';
			}
		}

		function toggleInfoPanel() {
			const content = document.getElementById('infoContent');
			const icon = document.getElementById('infoIcon');
			
			if (content.classList.contains('collapsed')) {
				content.classList.remove('collapsed');
				icon.textContent = '🔽';
			} else {
				content.classList.add('collapsed');
				icon.textContent = '🔼';
			}
		}

		// תוספה - טעינת אפשרויות סינון
		function loadFilterOptions() {
			const locationSelect = document.getElementById('filterLocation');
			
			if (locationSelect) {
				locationSelect.innerHTML = '<option value="">כל הלקוחות</option>';
				
				locations.forEach(location => {
					const option = document.createElement('option');
					option.value = location.ID;
					option.textContent = location.name;
					locationSelect.appendChild(option);
				});
			}
		}
	   
		// תוספה - סינון וטעינת טיפולים
		function applyVisitFilters() {
			console.log('🔍 מסנן טיפולים...');
			
			// Check for smart search first
			const smartSearch = document.getElementById('visitSmartSearch')?.value;
			if (smartSearch && smartSearch.trim()) {
				handleVisitSmartSearch(smartSearch);
				return;
			}
			
			let filteredVisits = [...visits];
			
			// Filter by active status with null safety
			const activeFilter = document.getElementById('filterActiveClients')?.value || '1';
			if (activeFilter !== '') {
				const activeStatus = activeFilter === '1';
				const activeLocationIds = locations
					.filter(loc => (activeStatus ? loc.active === "1" : loc.active !== "1"))
					.map(loc => loc.ID);
				filteredVisits = filteredVisits.filter(visit => 
					activeLocationIds.includes(visit.location_id)
				);
			}
			
			// Filter by payment status with null safety
			const paymentFilter = document.getElementById('filterPayment')?.value || '';
			if (paymentFilter) {
				filteredVisits = filteredVisits.filter(visit => {
					const paymentStatus = getVisitPaymentStatus(visit.ID);
					return paymentStatus === paymentFilter;
				});
			}
			
			// Filter by date range with null safety
			const dateFrom = document.getElementById('filterDateFrom')?.value || '';
			const dateTo = document.getElementById('filterDateTo')?.value || '';
			
			if (dateFrom) {
				filteredVisits = filteredVisits.filter(visit => visit.date >= dateFrom);
			}
			if (dateTo) {
				filteredVisits = filteredVisits.filter(visit => visit.date <= dateTo);
			}
			
			// Limit results with null safety
			const maxResults = parseInt(document.getElementById('maxResults')?.value) || 200;
			
			// Sort by date (newest first)
			filteredVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
			
			// Limit number of results
			if (filteredVisits.length > maxResults) {
				filteredVisits = filteredVisits.slice(0, maxResults);
			}
			
			console.log(`✅ נמצאו ${filteredVisits.length} טיפולים מתוך ${visits.length}`);
			
			displayFilteredVisits(filteredVisits);
			updateTreatmentsStats(filteredVisits);
		}

		
		// תוספה - הצגת טיפולים מסוננים
		function displayFilteredVisits(filteredVisits) {
			const tbody = document.getElementById('visitsHistoryTableBody');
			
			// Clear quickly
			tbody.innerHTML = '';
			
			if (filteredVisits.length === 0) {
				tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #666;">אין טיפולים תואמים לסינון</td></tr>';
				return;
			}
			
			// Sort by date descending
			filteredVisits.sort((a, b) => b.date.localeCompare(a.date));
			
			const fragment = document.createDocumentFragment();
			const locationMap = new Map();
			locations.forEach(loc => locationMap.set(loc.ID, loc));
			
			filteredVisits.forEach(visit => {
				const location = locationMap.get(visit.location_id);
				const locationName = visit.location_name || location?.name || 'לקוח לא ידוע';
				
				// Main row
				const mainRow = document.createElement('tr');
				mainRow.className = 'main-row';
				const hours = visit.duration_minutes ? (visit.duration_minutes / 60).toFixed(1) : '0';
				
				// ✅ NEW: Parse paid field for better display
				const paidInfo = parsePaidField(visit.paid);
				let paymentDisplay = '';

				if (paidInfo.status === '1') {
					paymentDisplay = `
						<div style="color: #27ae60; font-weight: bold;">
							✅ שולם
						</div>
					`;
				} else if (paidInfo.status === '3') {
					const paidAmount = getVisitPaidAmount(visit.ID);
					const debt = (parseFloat(visit.amount) || 0) - paidAmount;
					paymentDisplay = `
						<div style="color: #f39c12; font-weight: bold;">
							⚠️ חלקי: ${paidAmount.toFixed(2)}₪
							<div style="font-size: 11px; color: #666;">חוב: ${debt.toFixed(2)}₪</div>
						</div>
					`;
				} else if (paidInfo.status === '2') {
					paymentDisplay = `<div style="color: #95a5a6;">🚫 ללא תשלום</div>`;
				} else {
					paymentDisplay = `<div style="color: #e74c3c; font-weight: bold;">❌ לא שולם</div>`;
				}
				
				mainRow.innerHTML = `
					<td>${formatDate(visit.date)}</td>
					<td><strong>${locationName}</strong></td>
					<td style="font-weight: bold; color: #27ae60; font-size: 15px;">${getPaymentStatusIcon(visit.ID)} ${visit.amount || 0} ₪</td>
					<td>
						<button onclick="event.stopPropagation(); ${visit.paid === '0' ? `addPaymentForVisit('${visit.ID}')` : 'return false'}" class="action-btn" style="background: ${visit.paid === '0' ? '#27ae60' : '#95a5a6'}; color: white; padding: 6px 10px; ${visit.paid === '0' ? '' : 'opacity: 0.5; cursor: not-allowed;'}" ${visit.paid === '0' ? '' : 'disabled'}>💰</button>
						<button onclick="event.stopPropagation(); showVisitForm('${visit.ID}')" class="action-btn edit-btn">✏️</button>
						<button onclick="event.stopPropagation(); deleteVisit('${visit.ID}')" class="action-btn delete-btn">🗑️</button>
					</td>
				`;
				fragment.appendChild(mainRow);

				// Details row (collapsed by default)
				const detailsRow = document.createElement('tr');
				detailsRow.className = 'details-row';
				detailsRow.innerHTML = `
					<td colspan="4" style="padding: 15px; background: #f8f9fa;">
						<div style="display: flex; gap: 20px; margin-bottom: 10px; font-size: 14px;">
							<div><strong style="color: #666;">טיפול:</strong> ${visit.visit_type || '-'}</div>
							<div><strong style="color: #666;">משך:</strong> ${hours}ש</div>
							<div><strong style="color: #666;">שעות:</strong> ${visit.start_time || '-'} - ${visit.end_time || '-'}</div>
						</div>
						
						<div style="margin-bottom: 10px; font-size: 14px;">
							<strong style="color: #666;">בוצע:</strong> ${visit.work_done || '-'}
						</div>
						
						<div style="margin-bottom: 10px; font-size: 14px;">
							<strong style="color: #666;">הערות:</strong> ${visit.notes || 'אין'}
						</div>
						
						<div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
							<div style="font-size: 14px;">
								<strong style="color: #666;">שולם:</strong> ${paymentDisplay}
							</div>
						</div>
					</td>
				`;
				fragment.appendChild(detailsRow);
			});
			
			tbody.appendChild(fragment);
			console.log(`📊 הוצגו ${filteredVisits.length} טיפולים`);

			// Initialize expandable rows for mobile
			setTimeout(() => {
				initExpandableTable('visitsHistoryTable');
			}, 100);
		}

		// הוסף פונקציה חדשה להצגת פירוט עלויות:
		function getVisitCostBreakdown(visit) {
			if (!visit.duration_minutes) return '<span style="font-size: 11px; color: #999;">ללא פירוט</span>';
			
			const hours = (visit.duration_minutes / 60).toFixed(2);
			const workers = visit.num_workers || 1;
			const expense = visit.expense || 0;
			
			let breakdown = `${hours}ש`;
			if (workers > 1) breakdown += ` × ${workers}ע`;
			if (expense > 0) breakdown += ` + ₪${expense}`;
			
			return `<span style="font-size: 11px; color: #666;">${breakdown}</span>`;
		}

		

		// טעינה ראשונית של הטאב
		function loadVisitsHistory() {
			loadFilterOptions();
			
			// הגדרת סינון ברירת מחדל - חודש אחרון
			setDefaultDateFilter();
			
			// טעינה עם סינון מהחודש האחרון
			applyVisitFilters();
		}

		// פונקציה חדשה להגדרת תאריכי ברירת מחדל
		function setDefaultDateFilter() {
			const today = new Date();
			const lastMonth = new Date();
			lastMonth.setMonth(today.getMonth() - 1);
			
			// הגדרת תאריכים בשדות הסינון
			const dateFromInput = document.getElementById('filterDateFrom');
			const dateToInput = document.getElementById('filterDateTo');
			
			if (dateFromInput && dateToInput) {
				dateFromInput.value = getLocalDateString(lastMonth);
				dateToInput.value = getLocalDateString(today);
			}
		}


		// הצגת מודל עריכה (אם לא קיימת)
		function showEditModal(content) {
			// הסר מודל קיים אם יש
			const existingModal = document.getElementById('editModal');
			if (existingModal) {
				existingModal.remove();
			}
			
			// צור מודל חדש
			const modal = document.createElement('div');
			modal.id = 'editModal';
			modal.style.cssText = `
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.6);
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 10000;
				backdrop-filter: blur(3px);
			`;
			
			modal.innerHTML = content;
			
			// הוספה לעמוד
			document.body.appendChild(modal);
			
			// סגירה בלחיצה על הרקע
			modal.addEventListener('click', function(e) {
				if (e.target === modal) {
					closeAnyModal();
				}
			});
			
			// ✅ תיקון הטעינה של זמנים - נוודא שלא נטען ערך לא תקין
			setTimeout(() => {
				const startTimeInput = document.getElementById('editStartTime');
				const endTimeInput = document.getElementById('editEndTime');
				
				if (startTimeInput && startTimeInput.value === '00:00') {
					startTimeInput.value = '';
				}
				
				if (endTimeInput && endTimeInput.value === '00:00') {
					endTimeInput.value = '';
				}
			}, 50);
		}

		// סגירת מודל עריכה
		function closeEditModal() {
			const modal = document.getElementById('editModal');
			if (modal) {
				modal.remove();
			}
		}

		function closeAddTreatmentModal() {
			// Try multiple possible modal IDs
			const possibleIds = ['editModal', 'telegramModal', 'clientModal'];
			
			for (const id of possibleIds) {
				const modal = document.getElementById(id);
				if (modal) {
					modal.remove();
					return;
				}
			}
			
			// Fallback: remove any modal-like div
			const modals = document.querySelectorAll('[style*="position: fixed"][style*="z-index"]');
			modals.forEach(m => m.remove());
		}



		function updateEditManualDuration() {
			const hours = parseInt(document.getElementById('editDurationHours').value) || 0;
			const minutes = parseInt(document.getElementById('editDurationMinutes').value) || 0;
			const totalMinutes = hours * 60 + minutes;
			const decimalHours = (totalMinutes / 60).toFixed(1);
			
			document.getElementById('editDuration').value = totalMinutes;
			document.getElementById('editCalculatedHours').value = decimalHours;
			
			calculateEditTreatmentCost();
		}

		/* function updateEditFromTotalMinutes() {
			// This function is no longer needed with the new form design
			// The duration is now calculated automatically from start/end times
			console.log('updateEditFromTotalMinutes called - skipping (deprecated)');
		} */

		/* function calculateEditTreatmentCost() {
			// Try to get duration from multiple possible field names
			let totalMinutes = 0;
			
			const manualField = document.getElementById('editManualDurationMinutes');
			const durationField = document.getElementById('editDuration');
			
			if (manualField && manualField.value) {
				totalMinutes = parseInt(manualField.value) || 0;
			} else if (durationField && durationField.value) {
				totalMinutes = parseInt(durationField.value) || 0;
			}
			
			const numWorkers = parseInt(document.getElementById('editNumWorkers')?.value) || 1;
			const expense = parseFloat(document.getElementById('editExpense')?.value) || 0;
			
			if (totalMinutes > 0 && costSettings && costSettings.hourlyRate) {
				const hours = totalMinutes / 60;
				const baseCost = costSettings.hourlyRate * hours;
				const workersCost = (numWorkers - 1) * costSettings.workerCost * hours;
				const laborCost = baseCost + workersCost;
				const totalCost = laborCost + expense;
				
				const amountField = document.getElementById('editAmount');
				if (amountField) {
					amountField.value = Math.round(totalCost);
				}
			}
		} */
		
		// פונקציה לעדכון הביקור בענן
		async function updateVisitInCloud(updatedVisit) {
			if (!await validateToken()) return;
			
			try {
				// קריאת כל הנתונים מהענן
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Visits!A:N'
				});
				
				const rows = response.result.values || [];
				
				// מציאת השורה לעדכון
				let rowToUpdate = -1;
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] == updatedVisit.ID) {
						rowToUpdate = i + 1; // +1 כי Google Sheets מתחיל מ-1
						break;
					}
				}
				
				if (rowToUpdate > 0) {
					// עדכון השורה
					const updatedRow = [
					updatedVisit.ID,
					updatedVisit.date,
					updatedVisit.location_id,
					updatedVisit.location_name || '',
					updatedVisit.visit_type,
					updatedVisit.work_done,
					updatedVisit.duration_minutes,
					updatedVisit.num_workers || 1,
					updatedVisit.start_time || '',
					updatedVisit.end_time || '',
					updatedVisit.amount,
					updatedVisit.paid || '0',  
					updatedVisit.expense,
					updatedVisit.notes
				];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Visits!A${rowToUpdate}:N${rowToUpdate}`,
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [updatedRow]
						}
					});
					
					console.log(`✅ Updated visit ${updatedVisit.ID} in cloud`);
				}
				
			} catch (error) {
				console.error('Error updating visit in cloud:', error);
				throw error;
			}
		}

		async function deleteVisit(visitId) {
			console.log(`✅ deleteVisit ('${visitId}') `);
			if (confirm('האם אתה בטוח שברצונך למחוק את הטיפול?')) {
				// שמור את location_id לפני המחיקה
				const visitToDelete = visits.find(v => v.ID == visitId);
				const locationId = visitToDelete?.location_id;
				
				visits = visits.filter(visit => visit.ID != visitId);
				applyVisitFilters(); // רענן תצוגה
				saveToLocalStorage();
				
				// עדכון תאריכי טיפול של הלקוח
			if (locationId) {
				await updateSingleLocationTreatmentDates(locationId);
			}
			
			// רענון טיפולים של היום
			loadTodayTreatments();
			
			showToast('טיפול נמחק בהצלחה!', 'success');
			}
		}
	   
	   // תוספה - בדיקת רשאות
		async function checkPermissions() {
			if (!access_token) {
				showToast('לא מחובר לגוגל - התחבר קודם', 'warning');
				return false;
			}
			
			try {
				// נסה לגשת לטבלה הראשית
				await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				return true;
			} catch (error) {
				if (error.status === 401) {
					showToast('החיבור פג - התחבר מחדש', 'warning');
					access_token = null;
				} else if (error.status === 403) {
					showToast('אין הרשאה לטבלה - בדוק שיתוף', 'error');
				}
				return false;
			}
		}
	   
	   
	   // תוספה - בדיקה תקופתית של חיבור
		setInterval(async () => {
			if (access_token) {
				const isValid = await validateToken();
				if (!isValid) {
					console.log('Token expired - disconnected');
				}
			}
		}, 300000); // בדיקה כל 5 דקות
	   
	   
	    // חישוב עלות טיפול מעודכן
		function calculateTreatmentCost() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const workers = parseInt(document.getElementById('numberOfWorkersVisit').value) || 1;
			const expense = parseFloat(document.getElementById('expense').value) || 0;
			
			if (minutes > 0) {
				const hours = minutes / 60;
				const baseCost = costSettings.hourlyRate * hours;
				// תיקון: עלות עובדים נוספים (לא כולל אותך)
				const workersCost = (workers - 1) * costSettings.workerCost * hours;
				const laborCost = baseCost + workersCost;
				const totalCost = laborCost + expense;
				
				// עדכן את שדה הסכום רק אם ריק
				const amountField = document.getElementById('amount');
				if (!amountField.value || amountField.value === '0') {
					amountField.value = Math.round(totalCost);
				}
				
				// הצג פירוט מפורט יותר
				let breakdown = `${hours.toFixed(2)} שעות × ₪${costSettings.hourlyRate} = ₪${Math.round(baseCost)}`;
				
				if (workers > 1) {
					breakdown += `\n+ ${workers - 1} עובדים × ₪${costSettings.workerCost}/שעה = ₪${Math.round(workersCost)}`;
				}
				
				if (expense > 0) {
					breakdown += `\n+ הוצאות: ₪${expense}`;
				}
				
				breakdown += `\n= סה"כ: ₪${Math.round(totalCost)}`;
				
				document.getElementById('costBreakdown').textContent = breakdown;
				document.getElementById('costBreakdown').style.whiteSpace = 'pre-line';
				document.getElementById('costBreakdown').style.color = '#27ae60';
				document.getElementById('costBreakdown').style.fontSize = '14px';
				document.getElementById('costBreakdown').style.fontWeight = '600';
			} else {
				document.getElementById('costBreakdown').textContent = '';
			}
		}

		// הוסף חישוב אוטומטי כשמקלידים משך זמן
		function updateHoursDisplay() {
			const minutes = parseFloat(document.getElementById('manualDurationMinutes').value) || 0;
			const hours = minutes > 0 ? (minutes / 60).toFixed(2) : '';
			document.getElementById('calculatedHours').value = hours;
			
			// חשב עלויות אוטומטית
			calculateTreatmentCost();
		}

		// שמירת הגדרות עלות פשוטה יותר
		function saveCostSettings() {
			costSettings.hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 150;
			costSettings.workerCost = parseFloat(document.getElementById('workerCost').value) || 50;
			
			localStorage.setItem('cost_settings', JSON.stringify(costSettings));
			
			if (access_token) {
				saveSettingsToCloud().then(success => {
					if (success) {
						showToast('הגדרות עלות נשמרו בענן', 'success');
					} else {
						showToast('הגדרות נשמרו מקומית בלבד', 'warning');
					}
				});
			} else {
				showToast('הגדרות נשמרו מקומית', 'success');
			}
		}
	   
	   // תוספה - בדיקת טיפול כפול
		function checkDuplicateVisit(locationId, visitDate) {
			const existingVisit = visits.find(visit => 
				visit.location_id == locationId && 
				visit.date === visitDate
			);
			
			return existingVisit;
		}
	   
	   
	   // פונקציה לשמירת הגדרות לענן
		async function saveSettingsToCloud() {
			if (!await validateToken()) {
				return false;
			}
			
			try {
				const settingsData = [
					['Setting', 'Value'],
					['hourly_rate', costSettings.hourlyRate],
					['worker_cost', costSettings.workerCost],
					['last_updated', new Date().toISOString()]
				];
				
				await gapi.client.sheets.spreadsheets.values.clear({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A:B`
				});
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A1:B4`,
					valueInputOption: 'RAW',
					resource: { values: settingsData }
				});
				
				return true;
			} catch (error) {
				console.error('Error saving settings:', error);
				return false;
			}
		}

		// פונקציה לטעינת הגדרות מהענן
		async function loadSettingsFromCloud() {
			if (!await validateToken()) {
				return false;
			}
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.SETTINGS}!A:B`
				});
				
				const rows = response.result.values || [];
				if (rows.length > 1) {
					rows.slice(1).forEach(row => {
						const [setting, value] = row;
						if (setting === 'hourly_rate') {
							costSettings.hourlyRate = parseFloat(value) || 150;
						}
						if (setting === 'worker_cost') {
							costSettings.workerCost = parseFloat(value) || 50;
						}
					});
					
					document.getElementById('hourlyRate').value = costSettings.hourlyRate;
					document.getElementById('workerCost').value = costSettings.workerCost;
					
					return true;
				}
			} catch (error) {
				console.error('Error loading settings:', error);
				return false;
			}
			
			return false;
		}
	   
	   // פונקציה חדשה לבדיקה ויצירת הטבלה הראשית
		async function findOrCreateMainSpreadsheet() {
			try {
				console.log('Searching for existing main spreadsheet...');
				
				// חיפוש טבלה קיימת
				const response = await gapi.client.request({
					path: 'https://www.googleapis.com/drive/v3/files',
					params: {
						q: `name='${SPREADSHEET_NAME}' and mimeType='application/vnd.google-apps.spreadsheet'`,
					}
				});
				
				if (response.result.files.length > 0) {
					console.log('Found existing spreadsheet');
					SPREADSHEET_ID = response.result.files[0].id;
					showToast('נמצאה טבלה קיימת!', 'success');
				} else {
					console.log('No spreadsheet found, creating new one...');
					await createNewMainSpreadsheet();
				}
				
			} catch (error) {
				console.error('Error in findOrCreateMainSpreadsheet:', error);
				showToast('שגיאה בחיפוש טבלה', 'error');
			}
		}

		// פונקציה חדשה ליצירת טבלה ראשית חדשה
		async function createNewMainSpreadsheet() {
			console.log('Creating new main spreadsheet...');
			try {
				const response = await gapi.client.request({
					path: 'https://sheets.googleapis.com/v4/spreadsheets',
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${access_token}`,
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						properties: {
							title: SPREADSHEET_NAME
						},
						sheets: [
							{ properties: { title: 'Locations' } },
							{ properties: { title: 'Visits' } },
							{ properties: { title: 'Receipts' } },
							{ properties: { title: 'SystemSettings' } }
						]
					})
				});
				
				SPREADSHEET_ID = response.result.spreadsheetId;
				
				// הוסף כותרות לכל הגיליונות
				await addAllHeaders();
				
				showToast('נוצרה טבלה חדשה!', 'success');
				
			} catch (error) {
				console.error('Error creating spreadsheet:', error);
				showToast('שגיאה ביצירת טבלה', 'error');
			}
		}
		

		// פונקציה חדשה לבדיקה ותיקון מבנה הטבלה
		async function checkAndFixTableStructure() {
			console.log('Checking and fixing table structure...');
			
			try {
				// בדיקת כותרות בכל גיליון - כולל החדשים
				const sheetsToCheck = ['Locations', 'Visits', 'Receipts', 'TelegramVisits', 'TelegramIncomes', 'Payments', 'PaymentVisitLink', 'Tasks', 'Expenses'];
				
				for (const sheetName of sheetsToCheck) {
					try {
						const response = await gapi.client.sheets.spreadsheets.values.get({
							spreadsheetId: SPREADSHEET_ID,
							range: `${sheetName}!A1:A1`
						});
						
						if (!response.result.values || !response.result.values[0][0]) {
							console.log(`Headers missing in ${sheetName}, adding them...`);
							await addHeadersToSheet(sheetName);
						}
					} catch (error) {
						console.log(`Sheet ${sheetName} missing or error, will add headers:`, error);
						await addHeadersToSheet(sheetName);
					}
				}
				
				console.log('✅ Table structure verified');
				
			} catch (error) {
				console.log('Headers check failed, will force add them:', error);
				await addAllHeaders();
			}
		}
		
		// פונקציה חדשה להוספת כותרות לגיליון ספציפי
		async function addHeadersToSheet(sheetName) {
			const headersMap = {
				'Locations': ['ID', 'name', 'full_address', 'neighborhood', 'city', 'contact_person', 'phone', 'allowed_day', 'interval_weeks', 'temp_addition', 'base_amount', 'active', 'notes', 'last_visit', 'next_visit', 'client_requests'],
				'Visits': ['ID', 'date', 'location_id', 'location_name', 'visit_type', 'work_done', 'duration_minutes', 'num_workers', 'start_time', 'end_time', 'amount', 'paid', 'expense', 'notes'],
				'Receipts': ['ID', 'book_number', 'receipt_number', 'date', 'location_id', 'location_name', 'amount', 'payment_type', 'notes', 'payment_id'],
				'TelegramVisits': ['message_id', 'date', 'text', 'processed', 'location_id', 'visit_id'],
				'TelegramIncomes': ['message_id', 'date', 'text', 'processed', 'receipt_id'],
				'Payments': ['ID', 'date', 'time', 'amount', 'payment_method', 'source_type', 'client_id', 'client_name', 'notes', 'status', 'created_at', 'reference', 'check_date', 'bank_account', 'payment_details', 'receipt_id'],
				'PaymentVisitLink': ['ID', 'payment_id', 'visit_id', 'amount_allocated'],
				'Tasks': ['ID', 'scope', 'client_id', 'client_name', 'type', 'description', 'due_date', 'priority', 'estimated_cost', 'equipment', 'notes', 'recurring', 'recurring_interval', 'status', 'created_date', 'completed_date'],
				'Expenses': ['ID', 'date', 'amount', 'description', 'category', 'expense_type', 'client_id', 'client_name', 'visit_id', 'vendor_name', 'vendor_type', 'payment_method', 'receipt_number', 'notes'],
				'ExportVisitsClassic': ['year', 'month', 'day', 'customer', 'full_address', 'contact_person', 'treatment', 'date', 'work_done', 'duration', 'amount', 'paid', 'expense', 'notes', 'export_date']
			};
			
			const headers = headersMap[sheetName];
			if (!headers) {
				console.error(`No headers defined for sheet: ${sheetName}`);
				return;
			}
			
			try {
				// First, check if sheet exists
				const spreadsheet = await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				
				const sheetExists = spreadsheet.result.sheets.some(s => s.properties.title === sheetName);
				
				// Create sheet if it doesn't exist
				if (!sheetExists) {
					console.log(`Creating sheet: ${sheetName}`);
					await gapi.client.sheets.spreadsheets.batchUpdate({
						spreadsheetId: SPREADSHEET_ID,
						resource: {
							requests: [{
								addSheet: {
									properties: { title: sheetName }
								}
							}]
						}
					});
					console.log(`✅ Sheet ${sheetName} created`);
				}
				
				// Now add headers
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `${sheetName}!A1:${String.fromCharCode(64 + headers.length)}1`,
					valueInputOption: 'RAW',
					resource: {
						values: [headers]
					}
				});
				console.log(`✅ Headers added to ${sheetName}`);
			} catch (error) {
				console.error(`Error adding headers to ${sheetName}:`, error);
			}
		}
		
		// פונקציה משופרת להוספת כותרות לכל הגיליונות
		async function addAllHeaders() {
			try {
				console.log('Adding headers to all sheets...');
				
				await addHeadersToSheet('Locations');
				await addHeadersToSheet('Visits');
				await addHeadersToSheet('Receipts');
				await addHeadersToSheet('Payments');           
				await addHeadersToSheet('PaymentVisitLink');   
				await addHeadersToSheet('TelegramVisits');     
				await addHeadersToSheet('TelegramIncomes');    
				await addHeadersToSheet('Tasks');
				await addHeadersToSheet('Expenses');
				await addHeadersToSheet('ExportVisitsClassic');

				// הוספת כותרות ל-SystemSettings
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'SystemSettings!A1:B1',
					valueInputOption: 'RAW',
					values: [['setting_key', 'setting_value']]
				});
				
				console.log('✅ All headers added successfully');
				
			} catch (error) {
				console.error('Error adding all headers:', error);
			}
		}
	   
	   async function importFromHelperTable() {
			if (!await validateToken()) {
				showToast('התחבר לגוגל קודם', 'warning');
				return;
			}
			
			const importTableId = localStorage.getItem('importTableId');
			if (!importTableId) {
				showToast('לא נמצא ID של טבלת העזר', 'warning');
				return;
			}
			
			// גיבוי אוטומטי לפני ייבוא
			if (access_token && SPREADSHEET_ID) {
				showToast('💾 יוצר גיבוי לפני ייבוא...', 'info');
				console.log('💾 יוצר גיבוי לפני ייבוא...');
				await createBackup();
			}
			
			console.log('🔍 Import Table ID:', importTableId); // לוג חדש
			
			try {
				showLoading('מייבא נתונים מטבלת העזר...');
				
				let importedCount = 0;
				
				// ייבוא מיקומים
				try {
					console.log('📍 Starting locations import...'); // לוג חדש
					
					const locationsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Locations!A2:O1000'
					});
					
					console.log('📍 Locations response:', locationsResponse.result); // לוג חדש
					
					if (locationsResponse.result.values && locationsResponse.result.values.length > 0) {
						console.log('📍 Found', locationsResponse.result.values.length, 'location rows'); // לוג חדש
						
						for (const row of locationsResponse.result.values) {
							if (row[0] && row[1]) {
								const locationData = parseLocationFromRow(row);
								locations.push(locationData);
								importedCount++;
								
								await new Promise(resolve => setTimeout(resolve, 200));
							}
						}
						showToast(`יובאו ${importedCount} מיקומים`, 'success');
					} else {
						console.log('📍 No locations data found'); // לוג חדש
					}
				} catch (error) {
					console.error('📍 Locations import error:', error); // לוג חדש
				}
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				// ייבוא ביקורים
				try {
					console.log('🔧 Starting visits import...');
					
					const visitsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Visits!A2:M1000'
					});
					
					console.log('🔧 Visits response:', visitsResponse.result);
					
					let visitsCount = 0;
					if (visitsResponse.result.values && visitsResponse.result.values.length > 0) {
						console.log('🔧 Found', visitsResponse.result.values.length, 'visit rows');
						
						for (let i = 0; i < visitsResponse.result.values.length; i++) {
							const row = visitsResponse.result.values[i];
							if (row[0] && row[1]) {
								const visitData = parseVisitFromRow(row);
								if (!isDuplicateVisit(visitData)) {
									visits.push(visitData);
									// עדכון תאריכי טיפול לאחר הוספת ביקור חדש
									//await updateSingleLocationTreatmentDates(visitData.location_id);
									visitsCount++;
								} else {
									console.log('⚠️ Duplicate visit skipped:', visitData.date, visitData.location_id);
								}
								visitsCount++;
								
								// הצג התקדמות כל 50 רשומות
								if (visitsCount % 50 === 0) {
									console.log(`🔧 Processed ${visitsCount}/${visitsResponse.result.values.length} visits`);
									showToast(`מעבד ביקור ${visitsCount}...`, 'info', 1000);
								}
								
								await new Promise(resolve => setTimeout(resolve, 100)); // המתנה קצרה יותר
							}
						}
						showToast(`יובאו ${visitsCount} ביקורים`, 'success');
					} else {
						console.log('🔧 No visits data found');
					}
				} catch (error) {
					console.error('🔧 Visits import error:', error);
				}
				
				await new Promise(resolve => setTimeout(resolve, 1000));
				
				// ייבוא קבלות
				try {
					console.log('🧾 Starting receipts import...');
					
					const receiptsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Receipts!A2:J1000'
					});
					
					console.log('🧾 Receipts response:', receiptsResponse.result);
					
					let receiptsCount = 0;
					if (receiptsResponse.result.values && receiptsResponse.result.values.length > 0) {
						console.log('🧾 Found', receiptsResponse.result.values.length, 'receipt rows');
						
						for (let i = 0; i < receiptsResponse.result.values.length; i++) {
							const row = receiptsResponse.result.values[i];
							if (row[0] && row[3]) { // ID ותאריך
								const receiptData = parseReceiptFromRow(row);
								
								
								if (!isDuplicateReceipt(receiptData)) {
									receipts.push(receiptData);
									receiptsCount++;
								} else {
									console.log('⚠️ Duplicate receipt skipped:', receiptData.date, receiptData.location_id);
								}
								
								// הצג התקדמות כל 25 רשומות (קבלות בדרך כלל פחות)
								if (receiptsCount % 25 === 0) {
									console.log(`🧾 Processed ${receiptsCount}/${receiptsResponse.result.values.length} receipts`);
									showToast(`מעבד קבלה ${receiptsCount}...`, 'info', 1000);
								}
								
								await new Promise(resolve => setTimeout(resolve, 100)); // המתנה קצרה יותר
							}
						}
						showToast(`יובאו ${receiptsCount} קבלות`, 'success');
					} else {
						console.log('🧾 No receipts data found');
					}
				} catch (error) {
					console.error('🧾 Receipts import error:', error);
				}
				
				// שמירה מקומית ועדכון תצוגה
				saveToLocalStorage();
				loadLocationsTable();
				loadReceiptsTable();
				loadFilterOptions();

				// בדיקה שהנתונים נטענו נכון
				console.log('🔍 בדיקת ייבוא:');
				console.log(`לקוחות: ${locations.length}`);
				console.log(`ביקורים: ${visits.length}`);
				console.log(`קבלות: ${receipts.length}`);

				// הצג דוגמה של הרשומה הראשונה מכל סוג
				if (locations.length > 0) {
					console.log('דוגמה לקוח:', locations[0]);
				}
				if (visits.length > 0) {
					console.log('דוגמה ביקור:', visits[0]);
				}


				// תוספה חשובה - שמירה לענן!
				showToast('שומר נתונים חדשים לענן...', 'info');

				try {
					/// await saveAllToSheets();
					/// await saveAllToSheetsOptimized();
					
					// שמירה מהירה לפי סוג נתונים
					const locationSuccess = await saveLocationsBatch(newLocations || []);
					const visitSuccess = await saveVisitsBatch(newVisits || []);  
					const receiptSuccess = await saveReceiptsBatch(newReceipts || []);

					if (locationSuccess && visitSuccess && receiptSuccess) {
						showToast('🚀 שמירה מהירה הושלמה בהצלחה!', 'success');
					} else {
						showToast('⚠️ חלק מהנתונים לא נשמרו לענן', 'warning');
					}

					showToast(`🎉 ייבוא הושלם בהצלחה!
					📍 ${locationsCount || 0} מיקומים
					🔧 ${visitsCount || 0} ביקורים  
					🧾 ${receiptsCount || 0} קבלות
					✅ הכל נשמר לענן!`, 'success', 6000);
				} catch (error) {
					console.error('Error saving imported data to cloud:', error);
					showToast('ייבוא הושלם מקומית, אבל שגיאה בשמירה לענן', 'warning');
				}
				
			} catch (error) {
				console.error('Import error:', error);
				showToast('שגיאה בייבוא נתונים', 'error');
			} finally {
				hideLoading();
			}
		}

	
		// פונקציות עזר לפרסור שורות
		function parseVisitFromRow(row) {
			return {
				ID: row[0] || generateID(),
				date: row[1] || '',
				location_id: row[2] || '',
				location_name: row[3] || '',
				visit_type: row[4] || '',
				work_done: row[5] || '',
				duration_minutes: parseInt(row[6]) || 0,
				num_workers: parseInt(row[7]) || 1,
				start_time: row[8] || '',
				end_time: row[9] || '',
				amount: parseFloat(row[10]) || 0,
				paid: (row[11] === 'כן' || row[11] === 'yes' || row[11] === '1') ? '1' : '0',
				expense: parseFloat(row[12]) || 0,
				notes: row[13] || ''
			};
		}



		function parseReceiptFromRow(row) {
			return {
				ID: row[0] || generateID(),
				booklet_number: row[1] || '',
				receipt_number: row[2] || '',
				date: row[3] || '',
				location_id: row[4] || '',
				location_name: row[5] || '',
				amount: parseFloat(row[6]) || 0,
				payment_type: row[7] || '',
				tax_code: row[8] || '',
				notes: row[9] || ''
			};
		}
	   
	   // הוסף את זה לסוף הקוד
		function updateImportTableStatus() {
			const importTableId = localStorage.getItem('importTableId');
			const statusDiv = document.getElementById('importTableStatus');
			
			if (importTableId && statusDiv) {
				statusDiv.innerHTML = `
					<span style="font-size: 13px; color: #28a745;">
						✅ טבלת עזר זמינה: 
						<a href="https://docs.google.com/spreadsheets/d/${importTableId}/edit" 
						   target="_blank" style="color: #007bff; text-decoration: underline;">
						   פתח טבלה
						</a>
					</span>
					<br>
					<button onclick="localStorage.removeItem('importTableId'); updateImportTableStatus();" 
							style="background: none; border: none; color: #dc3545; font-size: 12px; cursor: pointer; margin-top: 5px;">
						🗑️ מחק קישור לטבלת עזר
					</button>
				`;
			} else if (statusDiv) {
				statusDiv.innerHTML = `
					<span style="font-size: 13px; color: #666;">
						❌ לא נמצאה טבלת עזר שמורה
					</span>
					<br>
					<span style="font-size: 12px; color: #999;">
						צור טבלת עזר חדשה כדי לייבא נתונים
					</span>
				`;
			}
		}

		// הרץ את זה כשהדף נטען
		document.addEventListener('DOMContentLoaded', function() {
			updateImportTableStatus();
		});

		// הרץ גם כשעוברים לטאב המערכת
		function showTab(event, tabName) {
			// הקוד הקיים שלך...
			
			// הוסף את זה בסוף הפונקציה
			if (tabName === 'system') {
				setTimeout(() => {
					updateImportTableStatus();
					updateTelegramHelperStatus(); // הוסף שורה זו
				}, 100);
			}
		}
	   
	   


		// הוסף פונקציה להצגת מידע על טבלת עזר טלגרם
		function updateTelegramHelperStatus() {
			const telegramTableId = localStorage.getItem('telegramHelperTableId');
			const statusDiv = document.getElementById('telegramHelperStatus');
			
			if (statusDiv) {
				if (telegramTableId) {
					statusDiv.innerHTML = `
						<span style="color: green;">✓ טבלת עזר טלגרם מוכנה</span>
						<br>
						<a href="https://docs.google.com/spreadsheets/d/${telegramTableId}" target="_blank" style="font-size: 12px;">
							פתח בגוגל שיטס
						</a>
					`;
				} else {
					statusDiv.innerHTML = `
						<span style="color: orange;">⚠ לא נמצאה טבלת עזר טלגרם</span>
						<br>
						<span style="font-size: 12px;">צור טבלה חדשה תחילה</span>
					`;
				}
			}
		}


		// פונקציה עזר לסיום ביקור
		function finalizeVisit(visit, pendingNotes) {
			const client = visit.client;
			
			// אם לא נמצא זמן, נסה לחשב מהשעות או קבע ברירת מחדל
			if (visit.duration === 0) {
				if (visit.time) {
					// כאן אפשר להוסיף לוגיקה לחישוב זמן מהפרש שעות
					visit.duration = 60; // ברירת מחדל של שעה
				} else {
					visit.duration = 60;
				}
			}
			
			// פורמט שמתאים בדיוק לקוד הקיים של confirmTelegramImport
			return {
				date: visit.date,
				time: visit.time || '',
				client_name: client ? client.name : 'לא זוהה',
				client_id: client ? client.ID : null,
				address: client ? client.full_address : '',
				work_done: visit.workDescription.join(' '),
				duration_minutes: visit.duration,
				raw_text: visit.workDescription.join('\n') + '\n' + [...visit.notes, ...pendingNotes].join('\n')
			};
		}

		// פונקציות עזר לזיהוי דפוסים
		function isDateLine(line) {
			// זיהוי תאריך כמו "15 August 2024"
			const dateRegex = /^\d{1,2}\s+[A-Za-z]+\s+\d{4}$/;
			return dateRegex.test(line);
		}

		function isTimeLine(line) {
			// זיהוי שעה כמו "13:39"
			const timeRegex = /^\d{1,2}:\d{2}$/;
			return timeRegex.test(line);
		}

		function parseTelegramDate(dateStr) {
			// המר "15 August 2024" ל-"2024-08-15"
			const months = {
				'January': '01', 'February': '02', 'March': '03', 'April': '04',
				'May': '05', 'June': '06', 'July': '07', 'August': '08',
				'September': '09', 'October': '10', 'November': '11', 'December': '12'
			};
			
			const parts = dateStr.split(' ');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = months[parts[1]] || '01';
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			
			return '';
		}



		// פונקציה עזר למציאת לקוח לפי שם
		function findLocationByName(customerName) {
			if (!customerName) return null;
			
			return locations.find(loc => 
				loc.name && loc.name.toLowerCase().includes(customerName.toLowerCase())
			) || null;
		}


		// פונקציה משופרת לזיהוי לקוחות - תחליף את findClientInText הקיימת
		function findClientSmart(text, locations) {
			if (!text || !locations) return null;
			
			const textLower = text.toLowerCase().trim();
			
			// שלב 1: התאמה ישירה מלאה
			//for (const location of locations) {
			//	if (location.name && textLower.includes(location.name.toLowerCase())) {
			//		return location;
			//	}
			//	if (location.full_address && textLower.includes(location.full_address.toLowerCase())) {
			//		return location;
			//	}
			//}
			
			// שלב 2: זיהוי לפי רחוב + מספר (עם או בלי עיר)
			const addressMatch = textLower.match(/([א-ת\s']+)\s+(\d+)/);
			if (addressMatch) {
				const street = addressMatch[1].trim();
				const number = addressMatch[2];
				
				for (const location of locations) {
					if (location.name) {
						const locationParts = location.name.toLowerCase().split(' ');
						if (locationParts.length >= 2) {
							const locationStreet = locationParts[0];
							const locationNumber = locationParts[1];
							
							if (street.includes(locationStreet) && number === locationNumber) {
								return location;
							}
						}
					}
				}
			}
			
			// שלב 3: זיהוי שמות חלקיים (כמו "ויניק" במקום "ויניק 49 ראשלצ")
			const words = textLower.split(/\s+/);
			for (const word of words) {
				if (word.length >= 3) { // רק מילים של 3 אותיות או יותר
					for (const location of locations) {
						if (location.name && location.name.toLowerCase().startsWith(word)) {
							// וודא שזה השם היחיד שמתחיל כך
							const matches = locations.filter(loc => 
								loc.name && loc.name.toLowerCase().startsWith(word)
							);
							if (matches.length === 1) {
								return location;
							}
						}
					}
				}
			}
			
			// שלב 4: זיהוי לפי רחוב בלבד (לשמות ידועים)
			for (const word of words) {
				if (word.length >= 4) {
					for (const location of locations) {
						if (location.name) {
							const locationStreet = location.name.toLowerCase().split(' ')[0];
							if (locationStreet === word) {
								return location;
							}
						}
					}
				}
			}
			
			return null;
		}


		// פונקציה משופרת לחילוץ זמנים - תחליף את extractDuration הקיימת
		function extractTimeFromText(text) {
			if (!text) return 0;
			
			const textLower = text.toLowerCase().trim();
			
			// דפוס 1: מספר + "שעות"
			let match = textLower.match(/(\d+(?:\.\d+)?)\s*שעות/);
			if (match) {
				return Math.round(parseFloat(match[1]) * 60);
			}
			
			// דפוס 2: "שעתיים" עם וריאציות
			if (textLower.includes('שעתיים')) {
				if (textLower.includes('וחצי')) return 150;
				if (textLower.includes('ורבע')) return 135;
				if (textLower.includes('ושלושת רבעי')) return 165;
				return 120;
			}
			
			// דפוס 3: "שעה" עם וריאציות
			if (textLower.includes('שעה') && !textLower.includes('שעות')) {
				if (textLower.includes('וחצי')) return 90;
				if (textLower.includes('ורבע')) return 75;
				if (textLower.includes('ושלושת רבעי')) return 105;
				return 60;
			}
			
			// דפוס 4: "חצי שעה", "רבע שעה"
			if (textLower.includes('חצי שעה')) return 30;
			if (textLower.includes('רבע שעה')) return 15;
			
			// דפוס 5: מספר עשרוני עם שעות (כמו "1.75 שעות")
			match = textLower.match(/(\d+\.\d+)\s*שעה/);
			if (match) {
				return Math.round(parseFloat(match[1]) * 60);
			}
			
			// דפוס 6: כמויות מילוליות
			if (textLower.includes('כשעתיים')) return 120;
			if (textLower.includes('כשעה')) return 60;
			if (textLower.includes('כמעט שעתיים')) return 115;
			if (textLower.includes('כמעט שעה')) return 55;
			
			// דפוס 7: דקות
			match = textLower.match(/(\d+)\s*דק/);
			if (match) {
				return parseInt(match[1]);
			}
			
			// דפוס 8: ביטויים מיוחדים
			if (textLower.includes('לפני רבע שעה')) return 15;
			if (textLower.includes('לפני חצי שעה')) return 30;
			if (textLower.includes('לפני כשעה')) return 60;
			
			// דפוס 9: מספרים עם נקודה (כמו "2.5" או "3.25")
			match = textLower.match(/(\d+)\.(\d+)/);
			if (match) {
				const hours = parseInt(match[1]);
				const fraction = parseInt(match[2]);
				if (fraction === 5) return hours * 60 + 30; // .5 = חצי שעה
				if (fraction === 25) return hours * 60 + 15; // .25 = רבע שעה
				if (fraction === 75) return hours * 60 + 45; // .75 = שלושת רבעי שעה
			}
			
			// דפוס 10: טווחי זמן (כמו "2-3 שעות")
			match = textLower.match(/(\d+)-(\d+)\s*שעות/);
			if (match) {
				const avg = (parseInt(match[1]) + parseInt(match[2])) / 2;
				return Math.round(avg * 60);
			}
			
			return 0;
		}
	
		
		// פונקציה לזיהוי האם שורה מציינת תחילת ביקור חדש
		function isNewVisitStart(text, locations) {
			if (!text) return false;
			
			const textLower = text.toLowerCase().trim();
			
			// זיהוי ישירות של לקוח
			if (findClientSmart(text, locations)) return true;
			
			// דפוסי כתובות ישראליות
			if (/[א-ת\s']+\s+\d+/.test(text)) return true;
			
			// מילות מפתח שמציינות התחלת עבודה
			const startKeywords = [
				'מתחיל', 'התחלתי', 'מתחילים',
				'יציאה', 'הגעתי', 'נוסע ל',
				'בדיקת השקיה', 'טיפול ראשוני',
				'החלפת', 'התקנת', 'תיקון'
			];
			
			for (const keyword of startKeywords) {
				if (textLower.includes(keyword)) return true;
			}
			
			// זיהוי לפי שמות גנים/אזורים מוכרים
			const gardenKeywords = [
				'מבצע נחשון', 'מבצע משה', 'המרגנית',
				'אזר', 'גן יבנה', 'שיינקין'
			];
			
			for (const keyword of gardenKeywords) {
				if (textLower.includes(keyword.toLowerCase())) return true;
			}
			
			return false;
		}

		// פונקציה לזיהוי האם שורה מציינת סיום ביקור
		function isVisitEnd(text) {
			if (!text) return false;
			
			const textLower = text.toLowerCase().trim();
			
			// מילות סיום מפורשות
			if (textLower.includes('סיום') || textLower.includes('סיימתי')) return true;
			
			// ביטויי זמן שמציינים סיום
			if (textLower.includes('שעות') || textLower.includes('שעה')) {
				// אם יש זמן + ביטוי סיכום
				if (textLower.includes('סהכ') || textLower.includes('עד כה') || 
					textLower.includes('כולל') || textLower.includes('לקח')) {
					return true;
				}
			}
			
			// ביטויי מעבר לביקור הבא
			if (textLower.includes('נוסע ל') || textLower.includes('עובר ל') ||
				textLower.includes('ממשיך ל') || textLower.includes('הביתה')) {
				return true;
			}
			
			// הפסקות שמסיימות ביקור
			if (textLower.includes('הפסקה בבית') || textLower.includes('בבית')) {
				return true;
			}
			
			return false;
		}

		// פונקציה לזיהוי הערות שכדאי לשמור
		function extractNotes(text) {
			if (!text) return '';
			
			const textLower = text.toLowerCase();
			let notes = [];
			
			// הערות על תשלום
			if (textLower.includes('קיבלתי') && /\d+/.test(text)) {
				notes.push(text);
			}
			
			// הערות על המשך עבודה
			if (textLower.includes('לחזור') || textLower.includes('להמשיך') ||
				textLower.includes('נשאר') || textLower.includes('צריך')) {
				notes.push(text);
			}
			
			// בעיות או תקלות
			if (textLower.includes('בעיה') || textLower.includes('תקלה') ||
				textLower.includes('לא עובד') || textLower.includes('נשבר')) {
				notes.push(text);
			}
			
			// הערות על מזג אוויר או תנאים
			if (textLower.includes('גשם') || textLower.includes('חום') ||
				textLower.includes('רטוב') || textLower.includes('יבש')) {
				notes.push(text);
			}
			
			return notes.join(' | ');
		}
		
	

		// אישור ייבוא הביקורים מטלגרם - גירסה מעודכנת
		async function confirmTelegramImport() {
			if (!window.pendingTelegramVisits || window.pendingTelegramVisits.length === 0) {
				showToast('אין ביקורים לייבוא', 'warning');
				return;
			}
			
			try {
				showLoading('מייבא ביקורים מטלגרם...');
				
				// שלב 1: שמור לטבלת TelegramVisits (זמני)
				const telegramVisitsWithIds = window.pendingTelegramVisits.map(visit => ({
					...visit,
					ID: generateID()
				}));
				
				await saveTelegramVisitsToCloud(telegramVisitsWithIds);
				
				// שלב 2: המר לביקורים רגילים במערכת
				let importedCount = 0;
				
				for (const telegramVisit of telegramVisitsWithIds) {
					// מצא או צור לקוח
					let locationId = null;
					const existingLocation = locations.find(loc => 
						loc.name.toLowerCase() === telegramVisit.client_name.toLowerCase()
					);
					
					if (existingLocation) {
						locationId = existingLocation.ID;
					} else {
						// צור לקוח חדש אם לא קיים
						locationId = generateID();
						const newLocation = {
							ID: locationId,
							name: telegramVisit.client_name,
							full_address: '',
							neighborhood: '',
							city: '',
							contact_person: '',
							phone: '',
							allowed_day: 'א',
							interval_weeks: 4,
							temp_addition: false,
							base_amount: 0,
							active: true,
							notes: 'נוצר אוטומטית מייבוא טלגרם',
							last_visit: telegramVisit.date,
							next_visit: '',
							client_requests: ''
						};
						locations.push(newLocation);
					}
					
					// צור ביקור במערכת הראשית
					const visitData = {
						ID: generateID(),
						date: telegramVisit.date,
						location_id: locationId,
						location_name: telegramVisit.client_name,
						visit_type: 'מלא',  // ✅ FIX: Use correct visit type from your system
						work_done: telegramVisit.work_done,
						duration_minutes: telegramVisit.duration_minutes,
						num_workers: 1,
						start_time: telegramVisit.time || '',
						end_time: '',
						amount: 0,
						expense: 0,
						notes: `יובא מטלגרם: ${telegramVisit.raw_text}`
					};
					
					visits.push(visitData);
					importedCount++;
				}
				
				// שמור הכל
				saveToLocalStorage();
				
				// עדכן תצוגות
				loadLocationsTable();
				loadReceiptsTable();
				loadFilterOptions();
				
				// עדכון תאריכי טיפול
				if (importedCount > 0) {
					await calculateTreatmentDates();
				}
				
				// שמור לענן
				await saveAllToSheetsOptimized();
				
				hideLoading();
				closeAnyModal();
				
				showToast(`🎉 ייבוא טלגרם הושלם!
		📱 ${importedCount} ביקורים יובאו
		💾 הכל נשמר לעלנן!`, 'success', 5000);
				
				// נקה את הנתונים הזמניים
				window.pendingTelegramVisits = null;
				
			} catch (error) {
				console.error('שגיאה בייבוא מטלגרם:', error);
				hideLoading();
				showToast('שגיאה בייבוא מטלגרם', 'error');
			}
		}

		


		function showtelegramModal(content) {
			// הסר מודל קיים אם יש
			const existingModal = document.getElementById('telegramModal');
			if (existingModal) {
				existingModal.remove();
			}
			
			// צור מודל
			const modal = document.createElement('div');
			modal.id = 'telegramModal';
			modal.style.cssText = `
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.5);
				display: flex;
				justify-content: center;
				align-items: center;
				z-index: 1000;
			`;
			
			modal.innerHTML = content;
			document.body.appendChild(modal);
			
			// סגירה בלחיצה על הרקע
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					closeAnyModal();
				}
			});
		}

		function closeTelegramModal() {
			const modal = document.getElementById('telegramModal');
			if (modal) {
				modal.remove();
			}
		}
	   
	    function generateID() {
			return Date.now() + Math.random().toString(36).substr(2, 9);
		}
	   
	   
	   async function saveAllToSheetsOptimized() {
			if (!await validateToken()) {
				showToast('נדרש חיבור לענן', 'warning');
				return false;
			}
			
			try {
				await checkAndFixTableStructure();
				
				// שמירת כל הטבלאות
				const locationSuccess = locations.length > 0 ? await saveLocationsBatch(locations) : true;
				const visitSuccess = visits.length > 0 ? await saveVisitsBatch(visits) : true;
				const receiptSuccess = receipts.length > 0 ? await saveReceiptsBatch(receipts) : true;
				const incomeSuccess = incomes.length > 0 ? await saveIncomesBatch(incomes) : true;
				const paymentSuccess = payments.length > 0 ? await savePaymentsBatch(payments) : true;
				const linkSuccess = paymentVisitLinks.length > 0 ? await savePaymentVisitLinksBatch(paymentVisitLinks) : true;
				const tasksSuccess = tasks.length > 0 ? await saveTasksToSheets() : true;
				const expensesSuccess = expenses.length > 0 ? await saveExpensesBatch(expenses) : true;

				const allSaved = locationSuccess && visitSuccess && receiptSuccess && incomeSuccess && paymentSuccess && linkSuccess && tasksSuccess && expensesSuccess;
							

			if (allSaved) {
					showToast('✅ כל הנתונים נשמרו בהצלחה', 'success');
				} else {
					showToast('⚠️ חלק מהנתונים לא נשמרו', 'warning');
				}
				
				return allSaved;
				
			} catch (error) {
				console.error('Error saving all data:', error);
				showToast('שגיאה בשמירת נתונים', 'error');
				return false;
			}
		}
	   
	   // פונקציה להצגת חובות
		function displayDebts() {
			const container = document.getElementById('debtsContainer');
			if (!container) return;
			
			// Get filter values
			const sortBy = document.getElementById('debtSortBy')?.value || 'amount_desc';
			const minAmount = parseFloat(document.getElementById('minDebtAmount')?.value) || 0;
			const selectedDay = document.getElementById('debtDayFilter')?.value || '';
			const selectedClientId = document.getElementById('debtClientSearch')?.getAttribute('data-selected-id') || '';
			
			// ✅ FIXED: Calculate debts including zero-amount visits that require payment
			const clientDebts = new Map();
			
			visits.forEach(visit => {
				const paidInfo = parsePaidField(visit.paid);
				
				// Skip if status is "no payment required" (status '2')
				if (paidInfo.status === '2') {
					return;
				}
				
				const visitAmount = parseFloat(visit.amount) || 0;
				const paidAmount = getVisitPaidAmount(visit.ID);
				const debt = visitAmount - paidAmount;
				
				// Include if: has debt OR zero amount that needs pricing
				if (debt > 0.01 || visitAmount === 0) {
					const clientId = visit.location_id;
					if (!clientDebts.has(clientId)) {
						clientDebts.set(clientId, {
							clientId: clientId,
							clientName: visit.location_name || 'לא ידוע',
							totalDebt: 0,
							zeroAmountCount: 0,
							visits: []
						});
					}
					
					const clientDebt = clientDebts.get(clientId);
					clientDebt.totalDebt += debt;
					
					if (visitAmount === 0) {
						clientDebt.zeroAmountCount++;
					}
					
					clientDebt.visits.push({
						visitId: visit.ID,
						date: visit.date,
						amount: visitAmount,
						paidAmount: paidAmount,
						debt: debt,
						workDone: visit.work_done || '',
						paymentStatus: paidInfo.status,
						isZeroAmount: visitAmount === 0
					});
				}
			});
			
			// Convert to array
			let debtsArray = Array.from(clientDebts.values());
			
			// Apply filters
			if (minAmount > 0) {
				debtsArray = debtsArray.filter(d => d.totalDebt >= minAmount);
			}
			
			if (selectedClientId) {
				debtsArray = debtsArray.filter(d => d.clientId === selectedClientId);
			}
			
			if (selectedDay && selectedDay !== '') {
				debtsArray = debtsArray.filter(d => {
					const client = locations.find(loc => loc.ID === d.clientId);
					return client && client.allowed_day === selectedDay;
				});
			}
			
			// Sort
			debtsArray.sort((a, b) => {
				switch(sortBy) {
					case 'amount_desc': return b.totalDebt - a.totalDebt;
					case 'amount_asc': return a.totalDebt - b.totalDebt;
					case 'location': return a.clientName.localeCompare(b.clientName, 'he');
					case 'date_old': 
						return new Date(a.visits[0]?.date || '9999') - new Date(b.visits[0]?.date || '9999');
					case 'date_new':
						return new Date(b.visits[0]?.date || '0') - new Date(a.visits[0]?.date || '0');
					default: return 0;
				}
			});
			
			// Update statistics
			updateDebtStats(debtsArray);
			
			// Display debts
			if (debtsArray.length === 0) {
				container.innerHTML = '<div class="empty-state"><h3>🎉 אין חובות פתוחים!</h3></div>';
				return;
			}
			
			// ✅ UPDATED: Show debts with zero-amount indicator
			const html = debtsArray.map((debt, index) => `
				<div class="debt-card" id="debtCard_${index}">
					<div class="debt-header" onclick="toggleDebtDetails(${index})" style="cursor: pointer;">
						<!-- שורה 1: שם + פרופיל -->
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
							<h3 style="margin: 0; color: #2c3e50;">${debt.clientName}</h3>
							<button onclick="event.stopPropagation(); showClientProfile('${debt.clientId}')" 
									class="action-btn" 
									style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 10px;"
									title="פרופיל לקוח">
								👤
							</button>
						</div>
						
						<!-- שורה 2: סכום + כפתורי פעולה -->
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
							<div style="display: flex; align-items: center; gap: 10px;">
								<div class="debt-total" style="margin: 0;">💰 ${debt.totalDebt.toFixed(0)} ₪</div>
								${debt.zeroAmountCount > 0 ? `
									<span style="background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
										⚠️ +${debt.zeroAmountCount} ללא מחיר
									</span>
								` : ''}
							</div>
							<div style="display: flex; gap: 5px; flex-wrap: wrap;">
								<button onclick="event.stopPropagation(); showAddPaymentModal('${debt.clientId}')" 
										class="action-btn" 
										style="background: #27ae60; color: white; padding: 5px 8px; font-size: 11px; border-radius: 6px; border: none; cursor: pointer;"
										title="רישום תשלום">
									💳
								</button>
								<button onclick="event.stopPropagation(); markAllDebtsPaid('${debt.clientId}')" 
										class="action-btn" 
										style="background: #3498db; color: white; padding: 5px 8px; font-size: 11px; border-radius: 6px; border: none; cursor: pointer;"
										title="סמן הכל כשולם">
									✓
								</button>
								<button onclick="event.stopPropagation(); showBalanceReportModal('${debt.clientId}')" 
										class="action-btn" 
										style="background: #9b59b6; color: white; padding: 5px 8px; font-size: 11px; border-radius: 6px; border: none; cursor: pointer;"
										title="דוח מאזן">
									📄
								</button>
							</div>
						</div>
						
						<!-- שורה 3: מידע נוסף -->
						<div style="font-size: 12px; color: #7f8c8d;">
							<span>📋 ${debt.visits.length} ביקורים</span>
							<span style="margin-right: 15px;" id="debtExpand_${index}">▼ הצג פירוט</span>
						</div>
					</div>
					
					<!-- Collapsible Details -->
					<div id="debtDetails_${index}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 2px solid #ecf0f1;">
						${debt.visits.map(v => `
							<div style="padding: 10px; margin-bottom: 8px; background: ${v.isZeroAmount ? '#fff3cd' : '#f8f9fa'}; border-radius: 6px; border-right: 4px solid ${v.isZeroAmount ? '#ff9800' : '#3498db'};">
								<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
									<span style="font-weight: 600; color: #2c3e50;">📅 ${formatDate(v.date)}</span>
									<span style="font-weight: bold; color: ${v.isZeroAmount ? '#ff9800' : '#e74c3c'};">
										${v.isZeroAmount ? '⚠️ לא הוזן מחיר' : v.debt.toFixed(0) + ' ₪'}
									</span>
								</div>
								<div style="font-size: 13px; color: #555;">
									${v.workDone || 'ללא תיאור'}
								</div>
							</div>
						`).join('')}
					</div>
				</div>
			`).join('');
			
			container.innerHTML = html;
		}

		

		function toggleDebtDetails(index) {
			const detailsDiv = document.getElementById(`debtDetails_${index}`);
			const expandSpan = document.getElementById(`debtExpand_${index}`);
			
			if (!detailsDiv) return;
			
			if (detailsDiv.style.display === 'none') {
				// הרחב
				detailsDiv.style.display = 'block';
				if (expandSpan) expandSpan.innerHTML = '▲ הסתר פירוט';
			} else {
				// כווץ
				detailsDiv.style.display = 'none';
				if (expandSpan) expandSpan.innerHTML = '▼ הצג פירוט';
			}
		}


		// עדכון סטטיסטיקות חובות
		function updateDebtStats(debtsArray) {
			const totalDebts = debtsArray.reduce((sum, debt) => sum + debt.totalDebt, 0);
			const avgDebt = debtsArray.length > 0 ? totalDebts / debtsArray.length : 0;
			const count = debtsArray.length;
			
			document.getElementById('debtsCount').textContent = count;
			document.getElementById('debtsTotal').textContent = `₪${totalDebts.toFixed(0)}`;
			document.getElementById('debtsAverage').textContent = `₪${avgDebt.toFixed(0)}`;
		}


		async function markClientDebtsPaid(clientId) {
			const clientName = locations.find(loc => loc.ID === clientId)?.name || 'הלקוח';
			
			if (!confirm(`האם לסמן את כל החובות של ${clientName} כשולמו?`)) {
				return;
			}
			
			// ✅ UPDATED: Mark as paid with today's date
			const today = getLocalDateString();
			let updatedCount = 0;
			
			visits.forEach(visit => {
				if (visit.location_id === clientId && visit.amount > 0) {
					const paidInfo = parsePaidField(visit.paid);
					
					// Only update if not already fully paid
					if (paidInfo.status !== 'paid' && paidInfo.status !== 'no_payment') {
						visit.paid = `paid:${today}`;
						updatedCount++;
					}
				}
			});
			
			if (updatedCount === 0) {
				showToast('אין חובות פתוחים ללקוח זה', 'info');
				return;
			}
			
			// Save locally
			saveToLocalStorage();
			
			// Update only changed visits in cloud
			if (access_token && SPREADSHEET_ID) {
				try {
					const visitsToUpdate = visits.filter(v => 
						v.location_id === clientId && 
						v.paid && 
						v.paid.startsWith('paid:')
					);
					
					const success = await updateMultipleVisitsInSheets(visitsToUpdate);
					
					if (success) {
						showToast(`✅ ${updatedCount} טיפולים סומנו כשולמו ונשמרו בענן`, 'success');
					} else {
						showToast(`⚠️ ${updatedCount} טיפולים סומנו כשולמו מקומית בלבד`, 'warning');
					}
				} catch (error) {
					console.error('Error updating visits:', error);
					showToast(`⚠️ ${updatedCount} טיפולים סומנו כשולמו מקומית בלבד`, 'warning');
				}
			} else {
				showToast(`💾 ${updatedCount} טיפולים סומנו כשולמו מקומית`, 'info');
			}
			
			// Refresh displays
			displayDebts();
			filterVisits();
			loadTodayTreatments();
		}


		// ✅ UNIFIED: Show link payment modal - can be called from debts or payments tab
		function showLinkPaymentModal(clientId, totalDebt, preSelectedPaymentId = null) {
			// If called with paymentId only (from payments tab), extract clientId
			if (!totalDebt && typeof clientId === 'string' && clientId.startsWith('PAY')) {
				// This is actually a paymentId, redirect to the proper function
				showLinkPaymentModalFromPayments(clientId);
				return;
			}
			
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('❌ לא נמצא לקוח', 'error');
				return;
			}
			
			// Get client's payments
			const clientPayments = payments.filter(p => p.location_id === clientId);
			
			if (clientPayments.length === 0) {
				showToast('ℹ️ אין תשלומים קיימים ללקוח זה. השתמש ב"➕ תשלום" כדי להוסיף תשלום חדש.', 'info');
				return;
			}
			
			// Calculate available amount for each payment
			const paymentsWithAvailable = clientPayments.map(payment => {
				const links = paymentVisitLinks.filter(link => link.payment_id === payment.ID);
				const allocatedAmount = links.reduce((sum, link) => sum + (parseFloat(link.amount_allocated) || 0), 0);
				const availableAmount = parseFloat(payment.amount) - allocatedAmount;
				
				return {
					...payment,
					allocatedAmount,
					availableAmount
				};
			}).filter(p => p.availableAmount > 0);
			
			if (paymentsWithAvailable.length === 0) {
				showToast('ℹ️ כל התשלומים הקיימים כבר מקושרים במלואם. השתמש ב"➕ תשלום" להוספת תשלום חדש.', 'info');
				return;
			}
			
			// If preSelectedPaymentId provided, use it; otherwise use first available
			const selectedPayment = preSelectedPaymentId 
				? paymentsWithAvailable.find(p => p.ID === preSelectedPaymentId) || paymentsWithAvailable[0]
				: paymentsWithAvailable[0];
			
			// Store data for later use
			window.currentLinkData = {
				clientId: clientId,
				paymentId: selectedPayment.ID,
				availableAmount: selectedPayment.availableAmount,
				totalDebt: totalDebt || 0
			};
			
			// Create modal HTML
			const modalHTML = `
				<div id="linkPaymentModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
					<div style="background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
						<!-- Header -->
						<div style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; position: relative;">
							<button onclick="closeAnyModal()" style="position: absolute; top: 15px; left: 15px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">×</button>
							<h2 style="margin: 0; font-size: 20px;">💳 קישור תשלום לטיפולים</h2>
							<p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">${client.name}</p>
						</div>
						
						<!-- Body -->
						<div style="padding: 20px;">
							<!-- Payment Selection (if multiple) -->
							${paymentsWithAvailable.length > 1 ? `
								<div style="margin-bottom: 15px;">
									<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">בחר תשלום:</label>
									<select id="selectedPaymentId" onchange="updateSelectedPayment()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
										${paymentsWithAvailable.map(p => `
											<option value="${p.ID}" ${p.ID === selectedPayment.ID ? 'selected' : ''}>
												${formatDate(p.date)} - ₪${p.amount} (זמין: ₪${p.availableAmount.toFixed(0)})
											</option>
										`).join('')}
									</select>
								</div>
							` : ''}
							
							<!-- Payment Info -->
							<div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
								<div style="display: flex; justify-content: space-between; align-items: center;">
									<div>
										<div style="font-size: 12px; color: #666;">תשלום מתאריך ${formatDate(selectedPayment.date)}</div>
										<div style="font-size: 20px; font-weight: bold; color: #2e7d32;">₪${selectedPayment.availableAmount.toFixed(0)} זמין לקישור</div>
									</div>
									<div style="font-size: 24px;">💰</div>
								</div>
							</div>
							
							<!-- Link Method -->
							<div style="margin-bottom: 15px;">
								<label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">שיטת קישור:</label>
								<div style="display: flex; gap: 10px;">
									<label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
										<input type="radio" name="linkMethod" value="auto" checked onchange="updateLinkPaymentPreviewSingle('${selectedPayment.ID}')" style="margin-left: 8px;">
										<div>
											<div style="font-weight: 600;">🤖 אוטומטי</div>
											<div style="font-size: 11px; color: #666;">מהישן לחדש</div>
										</div>
									</label>
									<label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;">
										<input type="radio" name="linkMethod" value="manual" onchange="updateLinkPaymentPreviewSingle('${selectedPayment.ID}')" style="margin-left: 8px;">
										<div>
											<div style="font-weight: 600;">✋ ידני</div>
											<div style="font-size: 11px; color: #666;">בחירה חופשית</div>
										</div>
									</label>
								</div>
							</div>
							
							<!-- Preview Area -->
							<div id="linkPreviewArea" style="min-height: 100px; border: 1px solid #eee; border-radius: 8px; padding: 10px;">
								<div style="text-align: center; color: #999; padding: 20px;">טוען...</div>
							</div>
							
							<!-- Action Buttons -->
							<div style="display: flex; gap: 10px; margin-top: 20px;">
								<button id="executeLinkBtn" onclick="executeLinkPaymentSingle('${selectedPayment.ID}')" 
										style="flex: 1; padding: 12px; background: #9b59b6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;" disabled>
									🔗 בצע קישור
								</button>
								<button onclick="closeAnyModal()" 
										style="padding: 12px 20px; background: #95a5a6; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
									ביטול
								</button>
							</div>
						</div>
					</div>
				</div>
			`;
			
			// Show modal
			const modalContainer = document.createElement('div');
			modalContainer.id = 'linkPaymentModalContainer';
			modalContainer.innerHTML = modalHTML;
			document.body.appendChild(modalContainer);
			
			// Load preview
			setTimeout(() => updateLinkPaymentPreviewSingle(selectedPayment.ID), 100);
		}

		// Helper function to update selected payment
		function updateSelectedPayment() {
			const select = document.getElementById('selectedPaymentId');
			if (!select || !window.currentLinkData) return;
			
			const paymentId = select.value;
			const payment = payments.find(p => p.ID === paymentId);
			if (!payment) return;
			
			// Recalculate available amount
			const links = paymentVisitLinks.filter(link => link.payment_id === paymentId);
			const allocatedAmount = links.reduce((sum, link) => sum + (parseFloat(link.amount_allocated) || 0), 0);
			const availableAmount = parseFloat(payment.amount) - allocatedAmount;
			
			window.currentLinkData.paymentId = paymentId;
			window.currentLinkData.availableAmount = availableAmount;
			
			// Update preview
			updateLinkPaymentPreviewSingle(paymentId);
		}
		
		
		// ✅ Show link payment modal from payments tab (calls unified function)
		function showLinkPaymentModalFromPayments(paymentId) {
			const payment = payments.find(p => p.ID === paymentId);
			if (!payment) {
				showToast('❌ לא נמצא תשלום', 'error');
				return;
			}
			
			const clientId = payment.client_id || payment.location_id;
			if (!clientId) {
				showToast('⚠️ תשלום זה לא משויך ללקוח', 'warning');
				return;
			}
			
			// Calculate client's total debt
			let totalDebt = 0;
			visits.forEach(visit => {
				if (visit.location_id === clientId && visit.amount > 0) {
					const visitAmount = parseFloat(visit.amount) || 0;
					const paidAmount = getVisitPaidAmount(visit.ID);
					const debt = visitAmount - paidAmount;
					if (debt > 0.01) {
						totalDebt += debt;
					}
				}
			});
			
			// Call unified function with pre-selected payment
			showLinkPaymentModal(clientId, totalDebt, paymentId);
		}
		

		
		// ✅ Update manual selection for single payment
		function updateManualSelectionSingle() {
			const checkboxes = document.querySelectorAll('#manualVisitsArea input[type="checkbox"]:checked');
			const summaryDiv = document.getElementById('manualSummary');
			const executeBtn = document.getElementById('executeLinkBtn');
			
			if (!window.currentLinkData) return;
			
			const { availableAmount } = window.currentLinkData;
			
			let totalSelected = 0;
			const allocations = [];
			
			checkboxes.forEach(cb => {
				const visitId = cb.value;
				const debt = parseFloat(cb.dataset.debt);
				const visit = visits.find(v => v.ID === visitId);
				
				const amountToAllocate = Math.min(availableAmount - totalSelected, debt);
				
				if (amountToAllocate > 0) {
					allocations.push({
						visitId: visitId,
						date: visit.date,
						workDone: visit.work_done || 'ללא תיאור',
						visitAmount: parseFloat(visit.amount),
						debt: debt,
						allocated: amountToAllocate
					});
					
					totalSelected += amountToAllocate;
				}
			});
			
			if (allocations.length === 0) {
				summaryDiv.innerHTML = 'לא נבחרו טיפולים';
				summaryDiv.style.color = '#666';
				executeBtn.disabled = true;
			} else {
				summaryDiv.innerHTML = `
					<strong>נבחרו ${allocations.length} טיפולים</strong><br>
					💰 סה"כ יקושר: <strong style="color: #4caf50;">${totalSelected.toFixed(0)} ₪</strong> מתוך ${availableAmount.toFixed(0)} ₪ זמין
				`;
				summaryDiv.style.color = '#333';
				
				window.currentLinkData.allocations = allocations;
				executeBtn.disabled = false;
			}
		}
		
		
		// ✅ Execute payment linking for single payment
		async function executeLinkPaymentSingle(paymentId) {
			if (!window.currentLinkData || !window.currentLinkData.allocations) {
				showToast('⌫ אין נתונים לביצוע', 'error');
				return;
			}
			
			const { allocations } = window.currentLinkData;
			
			if (allocations.length === 0) {
				showToast('⚠️ אנא בחר טיפולים לקישור', 'warning');
				return;
			}
			
			try {
				showLoading('מקשר תשלום לטיפולים...');
				
				const payment = payments.find(p => p.ID === paymentId);
				const totalLinked = allocations.reduce((sum, a) => sum + a.allocated, 0);
				
				// Create payment-visit links
				allocations.forEach(allocation => {
					const link = {
						ID: generateID(),
						payment_id: payment.ID,
						visit_id: allocation.visitId,
						amount_allocated: allocation.allocated,
						link_type: allocation.allocated >= allocation.debt ? 'full_payment' : 'partial_payment',
						created_at: new Date().toISOString()
					};
					
					paymentVisitLinks.push(link);
					
					// Update visit paid status
					const visit = visits.find(v => v.ID === allocation.visitId);
					if (visit) {
						const totalPaid = getVisitPaidAmount(visit.ID);
						const visitAmount = parseFloat(visit.amount);
						
						if (totalPaid >= visitAmount - 0.01) {
							visit.paid = `paid:${payment.date}`;
						} else {
							visit.paid = `partial:${totalPaid.toFixed(2)}`;
						}
					}
				});
				
				// Save
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					try {
						await savePaymentVisitLinksBatch(paymentVisitLinks);
						
						const visitsToUpdate = allocations.map(a => visits.find(v => v.ID === a.visitId)).filter(v => v);
						if (visitsToUpdate.length > 0) {
							await updateMultipleVisitsInSheets(visitsToUpdate);
						}
					} catch (error) {
						console.error('Error saving to cloud:', error);
					}
				}
				
				hideLoading();
				
				// ✅ CHECK: Should we close modal or keep it open?
				const hasZeroAmountVisits = window.currentLinkData.hasZeroAmountVisits || false;
				const remainingAmount = window.currentLinkData.remainingAmount || 0;
				
				if (remainingAmount > 0.01 || hasZeroAmountVisits) {
					// Keep modal open - there's more work to do!
					let message = `✅ קושרו ${allocations.length} טיפולים (${totalLinked.toFixed(0)} ₪)\n\n`;
					
					if (remainingAmount > 0.01) {
						message += `⚠️ נשארו ${remainingAmount.toFixed(0)} ₪ לא מקושרים\n`;
					}
					
					if (hasZeroAmountVisits) {
						message += `⚠️ יש עוד טיפולים ללא מחיר\n`;
					}
					
					message += `\n💡 עבור למצב ידני כדי להמשיך`;
					
					showToast(message, 'success', 5000);
					
					// Switch to manual mode automatically
					const manualRadio = document.querySelector('input[name="linkMethod"][value="manual"]');
					if (manualRadio) {
						manualRadio.checked = true;
					}
					
					// Refresh preview
					setTimeout(() => {
						updateLinkPaymentPreviewSingle(paymentId);
					}, 1000);
					
				} else {
					// All done - close modal
					showToast(`✅ קושרו ${allocations.length} טיפולים (${totalLinked.toFixed(0)} ₪)`, 'success');
					closeAnyModal();
					window.currentLinkData = null;
				}
				
				// Refresh displays
			if (typeof displayDebts === 'function') displayDebts();
			if (typeof displayPayments === 'function') displayPayments();
			if (typeof displayVisits === 'function') displayVisits();
			loadTodayTreatments();
				
			} catch (error) {
				console.error('Error executing payment link:', error);
				showToast('⌫ שגיאה בקישור תשלום: ' + error.message, 'error');
				hideLoading();
			}
		}
		
		
		// ✅ Update preview of payment linking
		function updateLinkPaymentPreview() {
			const previewArea = document.getElementById('linkPreviewArea');
			const executeBtn = document.getElementById('executeLinkBtn');
			const selectedPaymentId = document.getElementById('selectedPaymentId').value;
			const linkMethod = document.querySelector('input[name="linkMethod"]:checked').value;
			
			if (!selectedPaymentId) {
				previewArea.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">בחר תשלום כדי לראות תצוגה מקדימה</div>';
				executeBtn.disabled = true;
				return;
			}
			
			// Get selected payment
			const payment = payments.find(p => p.ID === selectedPaymentId);
			if (!payment) return;
			
			// Calculate available amount
			const links = paymentVisitLinks.filter(link => link.payment_id === payment.ID);
			const allocatedAmount = links.reduce((sum, link) => sum + (parseFloat(link.amount_allocated) || 0), 0);
			const availableAmount = parseFloat(payment.amount) - allocatedAmount;
			
			// Get client's unpaid visits
			const clientId = window.currentLinkData.clientId;
			const unpaidVisits = visits.filter(visit => {
				if (visit.location_id !== clientId) return false;
				if (!visit.amount || visit.amount <= 0) return false;
				
				const paidAmount = getVisitPaidAmount(visit.ID);
				const debt = parseFloat(visit.amount) - paidAmount;
				
				return debt > 0.01; // Small threshold for rounding errors
			});
			
			// Sort by date (oldest first)
			unpaidVisits.sort((a, b) => new Date(a.date) - new Date(b.date));
			
			if (unpaidVisits.length === 0) {
				previewArea.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">אין טיפולים פתוחים לקישור</div>';
				executeBtn.disabled = true;
				return;
			}
			
			// AUTO mode: allocate to oldest visits first
			if (linkMethod === 'auto') {
				let remainingAmount = availableAmount;
				const allocations = [];
				
				for (const visit of unpaidVisits) {
					if (remainingAmount <= 0) break;
					
					const paidAmount = getVisitPaidAmount(visit.ID);
					const debt = parseFloat(visit.amount) - paidAmount;
					const amountToAllocate = Math.min(remainingAmount, debt);
					
					allocations.push({
						visitId: visit.ID,
						date: visit.date,
						workDone: visit.work_done || 'ללא תיאור',
						visitAmount: parseFloat(visit.amount),
						debt: debt,
						allocated: amountToAllocate
					});
					
					remainingAmount -= amountToAllocate;
				}
				
				const totalAllocated = allocations.reduce((sum, a) => sum + a.allocated, 0);
				const remainingDebt = window.currentLinkData.totalDebt - totalAllocated;
				
				previewArea.innerHTML = `
					<div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
						<div style="font-weight: 600; color: #2e7d32; margin-bottom: 10px;">✓ חלוקה אוטומטית:</div>
						<div style="font-size: 13px; color: #555;">
							<div>💰 סכום זמין: <strong>${availableAmount.toFixed(0)} ₪</strong></div>
							<div>📋 יחולק על <strong>${allocations.length}</strong> טיפולים (מהישנים ביותר)</div>
							<div>💵 סה"כ יקושר: <strong>${totalAllocated.toFixed(0)} ₪</strong></div>
							${remainingDebt > 0 ? `<div style="color: #f57c00;">⚠️ חוב נותר: <strong>${remainingDebt.toFixed(0)} ₪</strong></div>` : ''}
						</div>
					</div>
					
					<div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px;">
						${allocations.map(a => `
							<div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
								<div style="flex: 1;">
									<div style="font-size: 12px; color: #666;">${formatDate(a.date)}</div>
									<div style="font-size: 13px; color: #333;">${a.workDone}</div>
								</div>
								<div style="text-align: left;">
									<div style="font-size: 14px; font-weight: 600; color: #4caf50;">${a.allocated.toFixed(0)} ₪</div>
									<div style="font-size: 11px; color: #999;">מתוך ${a.visitAmount.toFixed(0)} ₪</div>
								</div>
							</div>
						`).join('')}
					</div>
				`;
				
				// Store allocations for execution
				window.currentLinkData.allocations = allocations;
				executeBtn.disabled = false;
				
			} else {
				// MANUAL mode: show checkboxes
				previewArea.innerHTML = `
					<div style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
						<div style="font-weight: 600; color: #e65100; margin-bottom: 5px;">✋ בחירה ידנית:</div>
						<div style="font-size: 13px; color: #555;">
							סמן את הטיפולים שברצונך לקשר (זמין: <strong>${availableAmount.toFixed(0)} ₪</strong>)
						</div>
					</div>
					
					<div id="manualVisitsArea" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px;">
						${unpaidVisits.map(visit => {
							const paidAmount = getVisitPaidAmount(visit.ID);
							const debt = parseFloat(visit.amount) - paidAmount;
							
							return `
								<label style="display: flex; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; align-items: center;" onchange="updateManualSelection()">
									<input type="checkbox" value="${visit.ID}" data-debt="${debt}" style="margin-left: 10px; width: 18px; height: 18px;">
									<div style="flex: 1;">
										<div style="font-size: 12px; color: #666;">${formatDate(visit.date)}</div>
										<div style="font-size: 13px; color: #333;">${visit.work_done || 'ללא תיאור'}</div>
									</div>
									<div style="text-align: left;">
										<div style="font-size: 14px; font-weight: 600; color: #e74c3c;">${debt.toFixed(0)} ₪</div>
									</div>
								</label>
							`;
						}).join('')}
					</div>
					
					<div id="manualSummary" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 13px; color: #666;">
						לא נבחרו טיפולים
					</div>
				`;
				
				executeBtn.disabled = true;
			}
		}
		
		// ✅ Update manual selection summary
		function updateManualSelection() {
			const checkboxes = document.querySelectorAll('#manualVisitsArea input[type="checkbox"]:checked');
			const summaryDiv = document.getElementById('manualSummary');
			const executeBtn = document.getElementById('executeLinkBtn');
			const selectedPaymentId = document.getElementById('selectedPaymentId').value;
			
			if (!selectedPaymentId) return;
			
			const payment = payments.find(p => p.ID === selectedPaymentId);
			const links = paymentVisitLinks.filter(link => link.payment_id === payment.ID);
			const allocatedAmount = links.reduce((sum, link) => sum + (parseFloat(link.amount_allocated) || 0), 0);
			const availableAmount = parseFloat(payment.amount) - allocatedAmount;
			
			let totalSelected = 0;
			const allocations = [];
			
			checkboxes.forEach(cb => {
				const visitId = cb.value;
				const debt = parseFloat(cb.dataset.debt);
				const visit = visits.find(v => v.ID === visitId);
				
				const amountToAllocate = Math.min(availableAmount - totalSelected, debt);
				
				if (amountToAllocate > 0) {
					allocations.push({
						visitId: visitId,
						date: visit.date,
						workDone: visit.work_done || 'ללא תיאור',
						visitAmount: parseFloat(visit.amount),
						debt: debt,
						allocated: amountToAllocate
					});
					
					totalSelected += amountToAllocate;
				}
			});
			
			if (allocations.length === 0) {
				summaryDiv.innerHTML = 'לא נבחרו טיפולים';
				summaryDiv.style.color = '#666';
				executeBtn.disabled = true;
			} else {
				summaryDiv.innerHTML = `
					<strong>נבחרו ${allocations.length} טיפולים</strong><br>
					💰 סה"כ יקושר: <strong style="color: #4caf50;">${totalSelected.toFixed(0)} ₪</strong> מתוך ${availableAmount.toFixed(0)} ₪ זמין
				`;
				summaryDiv.style.color = '#333';
				
				// Store allocations
				window.currentLinkData.allocations = allocations;
				executeBtn.disabled = false;
			}
		}
		
			
		
		// ✅ Save payment-visit links to Google Sheets
		async function savePaymentVisitLinksToSheets() {
			if (!access_token || !SPREADSHEET_ID) {
				console.log('⚠️ Not connected to Google Sheets');
				return false;
			}
			
			try {
				// Prepare data for sheets
				const rows = paymentVisitLinks.map(link => [
					link.ID,
					link.payment_id,
					link.visit_id,
					link.amount_allocated,
					link.link_type || 'full_payment',
					link.created_at || new Date().toISOString()
				]);
				
				// Clear existing data and write new
				await gapi.client.sheets.spreadsheets.values.clear({
					spreadsheetId: SPREADSHEET_ID,
					range: 'PaymentVisitLink!A2:F'
				});
				
				if (rows.length > 0) {
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: 'PaymentVisitLink!A2',
						valueInputOption: 'RAW',
						resource: { values: rows }
					});
				}
				
				console.log(`✅ Saved ${rows.length} payment links to cloud`);
				return true;
				
			} catch (error) {
				console.error('Error saving payment links:', error);
				return false;
			}
		}
		

		// ✅ Update visit amount directly from modal
		function updateVisitAmountInModal(input, visitId) {
			const newAmount = parseFloat(input.value) || 0;
			const visit = visits.find(v => v.ID === visitId);
			
			if (!visit) {
				showToast('⚠️ לא נמצא טיפול', 'warning');
				return;
			}
			
			// Update amount
			visit.amount = newAmount;
			
			// Save to localStorage immediately
			saveToLocalStorage();
			
			// Update the debt attribute for checkbox
			const checkbox = input.closest('label').querySelector('input[type="checkbox"]');
			if (checkbox) {
				const paidAmount = getVisitPaidAmount(visitId);
				const newDebt = newAmount - paidAmount;
				checkbox.setAttribute('data-debt', newDebt);
			}
			
			// Update debt display
			const debtDisplay = input.closest('label').querySelector('div:last-child');
			if (debtDisplay) {
				const paidAmount = getVisitPaidAmount(visitId);
				const debt = newAmount - paidAmount;
				
				if (newAmount === 0) {
					debtDisplay.innerHTML = '⚠️';
					debtDisplay.style.color = '#ff9800';
				} else if (debt > 0) {
					debtDisplay.innerHTML = debt.toFixed(0) + ' ₪';
					debtDisplay.style.color = '#e74c3c';
				} else {
					debtDisplay.innerHTML = '✓';
					debtDisplay.style.color = '#27ae60';
				}
			}
			
			// Change background color
			const row = input.closest('label');
			if (row) {
				if (newAmount === 0) {
					row.style.background = '#fff3cd';
					input.style.borderColor = '#ff9800';
				} else {
					row.style.background = '';
					input.style.borderColor = '#ddd';
				}
			}
			
			// Refresh selection calculation if checked
			if (checkbox && checkbox.checked) {
				updateManualSelectionSingle();
			}
			
			// Show success
			showToast(`✅ מחיר עודכן ל-${newAmount}₪`, 'success', 2000);
		}

		// Function to populate debt filter dropdowns
		// Update loadDebtFilterOptions function with safety checks:
		function loadDebtFilterOptions() {
			const clientSelect = document.getElementById('debtClientFilter');
			
			if (clientSelect) {
				clientSelect.innerHTML = '<option value="">All clients</option>';
				
				// Get unique clients with debts
				const clientsWithDebts = new Set();
				
				visits.forEach(visit => {
					if (visit.amount > 0) {
						const visitAmount = parseFloat(visit.amount) || 0;
						const paidAmount = getVisitPaidAmount(visit.ID);
						const debt = visitAmount - paidAmount;
						
						if (debt > 0) {
							clientsWithDebts.add(visit.location_id);
						}
					}
				});
				
				// Add clients to dropdown
				locations
					.filter(loc => clientsWithDebts.has(loc.ID))
					.sort((a, b) => a.name.localeCompare(b.name))
					.forEach(location => {
						const option = document.createElement('option');
						option.value = location.ID;
						option.textContent = location.name;
						clientSelect.appendChild(option);
					});
			}
		}


		// עדכון כרטיסי סיכום
		function updateDebtsSummary(debtsArray) {
			const totalDebt = debtsArray.reduce((sum, debt) => sum + debt.totalDebt, 0);
			const debtorsCount = debtsArray.length;
			const averageDebt = debtorsCount > 0 ? totalDebt / debtorsCount : 0;
			
			// מציאת החוב הכי ישן
			let oldestDebtDays = 0;
			if (debtsArray.length > 0) {
				const oldestVisit = debtsArray
					.flatMap(debt => debt.visits)
					.reduce((oldest, visit) => 
						new Date(visit.date) < new Date(oldest.date) ? visit : oldest
					);
				oldestDebtDays = Math.floor((new Date() - new Date(oldestVisit.date)) / (1000 * 60 * 60 * 24));
			}
			
			document.getElementById('totalDebt').textContent = `₪${totalDebt.toLocaleString()}`;
			document.getElementById('totalDebt').style.color = totalDebt > 0 ? '#e74c3c' : '#27ae60';
			
			document.getElementById('debtorsCount').textContent = debtorsCount;
			document.getElementById('averageDebt').textContent = `₪${Math.round(averageDebt).toLocaleString()}`;
			document.getElementById('oldestDebt').textContent = oldestDebtDays > 0 ? `${oldestDebtDays} ימים` : '-';
			
			if (oldestDebtDays > 90) {
				document.getElementById('oldestDebt').style.color = '#e74c3c';
			} else if (oldestDebtDays > 30) {
				document.getElementById('oldestDebt').style.color = '#f39c12';
			}
		}

		// הצגת פירוט חוב ללקוח במודל נוח
		function showDebtDetails(locationId) {
			const location = locations.find(loc => loc.ID == locationId);
			const locationVisits = visits.filter(v => v.location_id == locationId && v.paid === '0');
			
			if (!location || locationVisits.length === 0) {
				showToast('לא נמצאו חובות ללקוח זה', 'info');
				return;
			}
			
			// מיון ביקורים לפי תאריך
			locationVisits.sort((a, b) => new Date(a.date) - new Date(b.date));
			
			const totalDebt = locationVisits.reduce((sum, v) => sum + parseFloat(v.amount), 0);
			
			// יצירת רשימת הביקורים
			let visitsHTML = '';
			locationVisits.forEach(visit => {
				const workDone = visit.work_done || 'לא צוין';
				const notes = visit.notes ? `<div style="color: #888; font-size: 12px; margin-top: 5px;">💭 ${visit.notes}</div>` : '';
				
				visitsHTML += `
					<div style="border: 1px solid #e9ecef; border-radius: 6px; padding: 12px; margin-bottom: 10px;">
						<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
							<strong>📅 ${formatDate(visit.date)}</strong>
							<strong style="color: #e74c3c;">₪${parseFloat(visit.amount).toLocaleString()}</strong>
						</div>
						<div style="color: #666; font-size: 14px;">
							🔧 ${workDone}
						</div>
						${notes}
					</div>
				`;
			});
			
			// תוכן המודל
			const modalContent = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 90vw; max-height: 70vh; overflow-y: auto;">
					<h3 style="margin-bottom: 20px; color: #2c3e50;">💰 פירוט חובות - ${location.name}</h3>
					
					<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
						<strong>סה"כ חוב: ₪${totalDebt.toLocaleString()}</strong><br>
						<span style="color: #666;">מספר טיפולים: ${locationVisits.length}</span>
					</div>
					
					<div style="max-height: 300px; overflow-y: auto;">
						${visitsHTML}
					</div>
					
					<div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
						<button type="button" onclick="markDebtAsPaid(${locationId}); closeAnyModal();" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
							✅ סמן כמסולק
						</button>
						<button type="button" onclick="closeAnyModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
							❌ סגור
						</button>
					</div>
				</div>
			`;
			
			showEditModal(modalContent);
		}  

		// סימון חוב כמסולק
		function markDebtAsPaid(locationId) {
			const location = locations.find(loc => loc.ID == locationId);
			if (!location) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			const unpaidVisits = visits.filter(v => v.location_id == locationId && v.paid === '0');
			
			if (unpaidVisits.length === 0) {
				showToast('אין חובות פתוחים ללקוח זה', 'info');
				return;
			}
			
			const totalDebt = unpaidVisits.reduce((sum, v) => sum + parseFloat(v.amount), 0);
			
			if (confirm(`לסמן את כל החובות של ${location.name} כמסולקים?\n\nסה"כ: ₪${totalDebt.toLocaleString()}\nמספר טיפולים: ${unpaidVisits.length}`)) {
				// עדכון כל הביקורים החייבים
				unpaidVisits.forEach(visit => {
					visit.paid = '1';
				});
				
				// שמירה מקומית
				saveToLocalStorage();
				
				// שמירה בענן אם מחובר
				if (access_token && SPREADSHEET_ID) {
					saveAllToSheets().then(() => {
						console.log('✅ חובות עודכנו בענן');
					}).catch(error => {
						console.error('❌ שגיאה בעדכון ענן:', error);
						showToast('החובות עודכנו מקומית, אך לא בענן', 'warning');
					});
				}
				
				// רענון התצוגה
				displayDebts();
				
				showToast(`החובות של ${location.name} סומנו כמסולקים! (₪${totalDebt.toLocaleString()})`, 'success');
			}
		}

	   
	    // התראה על חובות חמורים
		function checkCriticalDebts() {
			const criticalDebts = visits.filter(visit => {
				// Skip visits with no amount
				if (!visit.amount || visit.amount <= 0) {
					return false;
				}
				
				// Get payment status correctly
				const paymentStatus = getVisitPaymentStatus(visit.ID);
				
				// Skip if fully paid or no payment needed
				if (paymentStatus === '1' || paymentStatus === '2') {
					return false; // '1' = paid, '2' = no payment needed
				}
				
				// Calculate actual debt
				const paidAmount = getVisitPaidAmount(visit.ID);
				const debt = parseFloat(visit.amount) - paidAmount;
				
				// Skip if no debt
				if (debt <= 0.01) {
					return false;
				}
				
				// Check if critical: old (>90 days) OR large amount (>1000)
				const daysSince = Math.floor((new Date() - new Date(visit.date)) / (1000 * 60 * 60 * 24));
				return daysSince > 90 || debt > 1000;
			});
			
			if (criticalDebts.length > 0) {
				// Calculate total DEBT (not total amount!)
				const totalCritical = criticalDebts.reduce((sum, visit) => {
					const paidAmount = getVisitPaidAmount(visit.ID);
					const debt = parseFloat(visit.amount) - paidAmount;
					return sum + debt;
				}, 0);
				
				showToast(
					`⚠️ יש ${criticalDebts.length} חובות חמורים (₪${Math.round(totalCritical).toLocaleString()})`, 
					'warning', 
					8000
				);
			}
		}
	   
	   
	    // דוח הכנסות לחודש נוכחי
		function generateMonthlyReport() {
			const currentMonth = new Date().getMonth();
			const currentYear = new Date().getFullYear();
			
			const monthlyVisits = visits.filter(visit => {
				const visitDate = new Date(visit.date);
				return visitDate.getMonth() === currentMonth && 
					   visitDate.getFullYear() === currentYear;
			});
			
			const totalRevenue = monthlyVisits.reduce((sum, visit) => 
				sum + parseFloat(visit.amount || 0), 0);
			
			const paidRevenue = monthlyVisits
				.filter(visit => visit.paid === '1')
				.reduce((sum, visit) => sum + parseFloat(visit.amount || 0), 0);
			
			const totalHours = monthlyVisits.reduce((sum, visit) => 
				sum + (visit.duration_minutes || 0) / 60, 0);
			
			const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני',
				'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
			
			const report = {
				month: monthNames[currentMonth],
				year: currentYear,
				totalVisits: monthlyVisits.length,
				totalRevenue: totalRevenue,
				paidRevenue: paidRevenue,
				pendingRevenue: totalRevenue - paidRevenue,
				totalHours: totalHours.toFixed(1),
				avgPerVisit: monthlyVisits.length > 0 ? Math.round(totalRevenue / monthlyVisits.length) : 0
			};
			
			return report;
		}

		// הצגת דוח במודל
		function showMonthlyReport() {
			const report = generateMonthlyReport();
			
			const reportHTML = `
				<div style="background: white; padding: 20px; border-radius: 10px; max-width: 500px;">
					<h3>📊 דוח ${report.month} ${report.year}</h3>
					
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
						<div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #1976d2;">${report.totalVisits}</div>
							<div style="color: #666;">ביקורים</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #2e7d32;">₪${report.totalRevenue.toLocaleString()}</div>
							<div style="color: #666;">סה"כ הכנסות</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #f3e5f5; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #7b1fa2;">₪${report.paidRevenue.toLocaleString()}</div>
							<div style="color: #666;">נגבה</div>
						</div>
						
						<div style="text-align: center; padding: 15px; background: #fff3e0; border-radius: 8px;">
							<div style="font-size: 24px; font-weight: bold; color: #f57c00;">₪${report.pendingRevenue.toLocaleString()}</div>
							<div style="color: #666;">בהמתנה</div>
						</div>
					</div>
					
					<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
						<div><strong>שעות עבודה:</strong> ${report.totalHours} שעות</div>
						<div><strong>ממוצע לביקור:</strong> ₪${report.avgPerVisit}</div>
						<div><strong>ממוצע לשעה:</strong> ₪${Math.round(report.paidRevenue / parseFloat(report.totalHours) || 0)}</div>
					</div>
					
					<button onclick="closeAnyModal()" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; width: 100%;">
						סגור
					</button>
				</div>
			`;
			
			showModal(reportHTML);
		}
	   
	    function isDuplicateVisit(newVisit) {
			return visits.some(existing => 
				existing.location_id === newVisit.location_id &&
				existing.date === newVisit.date &&
				existing.work_done === newVisit.work_done &&
				existing.amount === newVisit.amount
			);
		}
	   
	    function isDuplicateReceipt(newReceipt) {
			return receipts.some(existing => 
				existing.receipt_number === newReceipt.receipt_number &&
				existing.booklet_number === newReceipt.booklet_number &&
				existing.date === newReceipt.date
			);
		}
		
		
		function removeDuplicates() {
			const uniqueVisits = [];
			const seen = new Set();
			
			visits.forEach(visit => {
				const key = `${visit.location_id}-${visit.date}-${visit.work_done}-${visit.amount}`;
				if (!seen.has(key)) {
					seen.add(key);
					uniqueVisits.push(visit);
				}
			});
			
			const removedCount = visits.length - uniqueVisits.length;
			visits = uniqueVisits;
			
			console.log(`Removed ${removedCount} duplicate visits`);
			return removedCount;
		}
	   
	   function validateVisitData(visitData) {
			const errors = [];
			
			if (!visitData.location_id) {
				errors.push('חסר מזהה לקוח');
			}
			
			if (!visitData.date) {
				errors.push('חסר תאריך');
			}
			
			if (!visitData.work_done || visitData.work_done.trim() === '') {
				errors.push('חסר תיאור עבודה');
			}
			
			return errors;
		}


	   // שמירה מקבצית של לקוחות
		async function saveLocationsBatch(locationsArray) {
			if (!await validateToken() || locationsArray.length === 0) return false;
			
			try {
				const locationValues = locationsArray.map(loc => [
					loc.ID,
					loc.name,
					loc.full_address,
					loc.neighborhood,
					loc.city,
					loc.contact_person,
					loc.phone,
					loc.allowed_day,
					loc.interval_weeks,
					loc.temp_addition || 0,
					loc.base_amount,
					loc.active,
					loc.notes || '',
					loc.last_visit || '',
					loc.next_visit || '',
					loc.client_requests || ''  // שדה חסר!
				]);
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `Locations!A2:P${locationValues.length + 1}`,
					valueInputOption: 'USER_ENTERED',
					resource: { values: locationValues }
				});
				
				console.log(`✅ Saved ${locationsArray.length} locations to cloud`);
				return true;
			} catch (error) {
				console.error('Error saving locations batch:', error);
				return false;
			}
		}

		// שמירה מקבצית של ביקורים
		async function saveVisitsBatch(visitsToSave) {
			if (!await validateToken()) return false;
			
			try {
				console.log('🔵 saveVisitsBatch called with', visitsToSave.length, 'visits');
				
				const values = visitsToSave.map(visit => [
					visit.ID || '',
					visit.date || '',
					visit.location_id || '',
					visit.location_name || '',
					visit.visit_type || '',
					visit.work_done || '',
					visit.duration_minutes || 0,
					visit.num_workers || 1,
					visit.start_time || '',
					visit.end_time || '',
					visit.amount || 0,
					visit.paid || '0',
					visit.expense || 0,
					visit.notes || ''
				]);
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `Visits!A2:N${values.length + 1}`,
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`✅ Saved ${visitsToSave.length} visits to cloud (no duplicates)`);
				return true;
				
			} catch (error) {
				console.error('Error saving visits batch:', error);
				return false;
			}
		}

		// עדכון טיפול בודד ב-Sheets (במקום לשמור הכל מחדש)
		async function updateSingleVisitInSheets(visit) {
			if (!await validateToken()) return false;
			
			try {
				console.log(`🔵 updateSingleVisitInSheets: Updating visit ${visit.ID}`);
				
				// 1. קריאת כל ה-IDs כדי למצוא את מספר השורה
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Visits!A:A'
				});
				
				const rows = response.result.values || [];
				let rowIndex = -1;
				
				// מציאת השורה עם ה-ID הזה (דילוג על כותרת)
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] === visit.ID) {
						rowIndex = i + 1; // +1 כי Sheets מתחיל מ-1
						break;
					}
				}
				
				if (rowIndex === -1) {
					console.warn(`⚠️ Visit ${visit.ID} not found in Sheets, cannot update`);
					return false;
				}
				
				// 2. עדכון רק השורה הזו
				const values = [[
					visit.ID || '',
					visit.date || '',
					visit.location_id || '',
					visit.location_name || '',
					visit.visit_type || '',
					visit.work_done || '',
					visit.duration_minutes || 0,
					visit.num_workers || 1,
					visit.start_time || '',
					visit.end_time || '',
					visit.amount || 0,
					visit.paid || '0',
					visit.expense || 0,
					visit.notes || ''
				]];
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `Visits!A${rowIndex}:N${rowIndex}`,
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`✅ Updated visit ${visit.ID} in row ${rowIndex}`);
				return true;
				
			} catch (error) {
				console.error('❌ Error updating single visit:', error);
				return false;
			}
		}


		// עדכון מספר טיפולים ב-Sheets
		async function updateMultipleVisitsInSheets(visitsToUpdate) {
			if (!await validateToken()) return false;
			
			let successCount = 0;
			
			for (const visit of visitsToUpdate) {
				const success = await updateSingleVisitInSheets(visit);
				if (success) successCount++;
			}
			
			console.log(`✅ Updated ${successCount} out of ${visitsToUpdate.length} visits in Sheets`);
			return successCount === visitsToUpdate.length;
		}


		// שמירה מקבצית של קבלות
		async function saveReceiptsBatch(receiptsArray) {
			if (!await validateToken() || receiptsArray.length === 0) return false;
			
			try {
				// קרא את הנתונים הקיימים קודם
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Receipts!A:A'
				});
				
				const existingIDs = new Set(response.result.values?.slice(1).map(row => row[0]) || []);
				
				// סנן רק רשומות חדשות
				const newReceipts = receiptsArray.filter(receipt => !existingIDs.has(receipt.ID));
				
				if (newReceipts.length === 0) {
					console.log('✅ No new receipts to save');
					return true;
				}
				
				const values = newReceipts.map(receipt => [
					receipt.ID,
					receipt.book_number,
					receipt.receipt_number,
					formatDateForSheets(receipt.date),
					receipt.location_id,
					receipt.location_name,
					receipt.amount,
					receipt.payment_type,
					receipt.notes,
					receipt.payment_id || ''
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: `${SHEETS.RECEIPTS}!A:I`,
					valueInputOption: 'USER_ENTERED',
					resource: { 
						values: values,
						majorDimension: 'ROWS'
					}
				});
				
				console.log(`✅ Saved ${newReceipts.length} receipts in batch - from ${receiptsArray.length}`);
				return true;
			} catch (error) {
				console.error('Error in batch save receipts:', error);
				return false;
			}
		}
		
		
		// שמירה מקבצית של תשלומים
		async function savePaymentsBatch(paymentsArray) {
			if (!await validateToken()) return false;
			
			try {
				console.log('💳 savePaymentsBatch called with', paymentsArray.length, 'payments');
				
				const values = paymentsArray.map(payment => [
					payment.ID || '',
					payment.date || '',
					payment.time || '',
					payment.amount || 0,
					payment.payment_method || '',
					payment.source_type || '',
					payment.client_id || '',
					payment.client_name || '',
					payment.notes || '',
					payment.status || 'completed',
					payment.created_at || new Date().toISOString(),
					payment.reference || '',
					payment.check_date || '',
					payment.bank_account || '',
					payment.payment_details || '',
					payment.receipt_id || ''
				]);
				
				// ✅ Clear existing data first (עדכון טווח ל-P)
				await gapi.client.sheets.spreadsheets.values.clear({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Payments!A2:P'
				});
				
				// ✅ Then write new data
				if (values.length > 0) {
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: 'Payments!A2',
						valueInputOption: 'USER_ENTERED',
						resource: { values }
					});
				}
				
				console.log(`✅ Saved ${paymentsArray.length} payments to cloud`);
				return true;
				
			} catch (error) {
				console.error('Error saving payments batch:', error);
				return false;
			}
		}
		
		
		// שמירת הוצאות לענן
		async function saveExpensesBatch(expensesArray) {
			if (!access_token || !SPREADSHEET_ID) return false;
			
			try {
				console.log('💰 saveExpensesBatch called with', expensesArray.length, 'expenses');
				
				const values = expensesArray.map(exp => [
					exp.ID,
					exp.date,
					exp.amount,
					exp.description,
					exp.category,
					exp.expense_type,
					exp.client_id || '',
					exp.client_name || '',
					exp.visit_id || '',
					exp.vendor_name || '',
					exp.vendor_type || 'other',
					exp.payment_method || 'cash',
					exp.receipt_number || '',
					exp.notes || ''
				]);
			
			// Ensure Expenses sheet exists with headers
			await addHeadersToSheet('Expenses');
			
			// Write data starting from row 2 (after header)
			await gapi.client.sheets.spreadsheets.values.update({
				spreadsheetId: SPREADSHEET_ID,
				range: 'Expenses!A2',
				valueInputOption: 'RAW',
				resource: {
					values: values
				}
			});
				
				console.log('✅ Expenses saved to cloud');
				return true;
			} catch (error) {
				console.error('❌ Error saving expenses:', error);
				return false;
			}
		}
		
		
		// עדכון תשלום בודד ב-Sheets (במקום לשמור הכל מחדש)
		async function updateSinglePaymentInSheets(payment) {
			if (!await validateToken()) return false;
			
			try {
				console.log(`🔵 updateSinglePaymentInSheets: Updating payment ${payment.ID}`);
				
				// 1. קריאת כל ה-IDs כדי למצוא את מספר השורה
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Payments!A:A'
				});
				
				const rows = response.result.values || [];
				let rowIndex = -1;
				
				// מציאת השורה עם ה-ID הזה (דילוג על כותרת)
				for (let i = 1; i < rows.length; i++) {
					if (rows[i][0] === payment.ID) {
						rowIndex = i + 1; // +1 כי Sheets מתחיל מ-1
						break;
					}
				}
				
				if (rowIndex === -1) {
					console.warn(`⚠️ Payment ${payment.ID} not found in Sheets, cannot update`);
					return false;
				}
				
				// 2. עדכון רק השורה הזו
				const values = [[
					payment.ID || '',
					payment.date || '',
					payment.time || '',
					payment.amount || 0,
					payment.payment_method || '',
					payment.source_type || '',
					payment.client_id || '',
					payment.client_name || '',
					payment.notes || '',
					payment.status || 'completed',
					payment.created_at || new Date().toISOString(),
					payment.reference || '',
					payment.check_date || '',
					payment.bank_account || '',
					payment.payment_details || ''
				]];
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: `Payments!A${rowIndex}:O${rowIndex}`,
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`✅ Updated payment ${payment.ID} in row ${rowIndex}`);
				return true;
				
			} catch (error) {
				console.error('❌ Error updating single payment:', error);
				return false;
			}
		}
		
		// שמירה מקבצית של קישורי תשלומים
		async function savePaymentVisitLinksBatch(linksArray) {
			if (!await validateToken()) return false;
			
			try {
				console.log('🔗 savePaymentVisitLinksBatch called with', linksArray.length, 'links');
				
				const values = linksArray.map(link => [
					link.ID || '',
					link.payment_id || '',
					link.visit_id || '',
					link.amount_allocated || 0,
					link.link_type || 'full_payment',
					link.created_at || new Date().toISOString()
				]);
				
				// ✅ Clear existing data first
				await gapi.client.sheets.spreadsheets.values.clear({
					spreadsheetId: SPREADSHEET_ID,
					range: 'PaymentVisitLink!A2:F'
				});
				
				// ✅ Then write new data
				if (values.length > 0) {
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: 'PaymentVisitLink!A2',
						valueInputOption: 'USER_ENTERED',
						resource: { values }
					});
				}
				
				console.log(`✅ Saved ${linksArray.length} payment links to cloud`);
				return true;
				
			} catch (error) {
				console.error('Error saving payment links batch:', error);
				return false;
			}
		}
		
	   
	   // ===== מנגנון תשלומים חדש ===== 

		// פתיחת מודל להוספת תשלום חדש
		function showAddPaymentModal(clientId = null, visitId = null) {
			let selectedClientId = clientId;
			let selectedClientName = '';
			let specificVisit = null;
			
			// אם יש טיפול ספציפי, טען אותו
			if (visitId) {
				specificVisit = visits.find(v => v.ID === visitId);
				if (specificVisit) {
					selectedClientId = specificVisit.location_id;
					const client = locations.find(loc => loc.ID === specificVisit.location_id);
					if (client) {
						selectedClientName = client.name;
					}
				}
			}
			// אם יש לקוח נבחר (ללא טיפול ספציפי), קח את השם שלו
			else if (clientId) {
				const client = locations.find(loc => loc.ID === clientId);
				if (client) {
					selectedClientName = client.name;
				}
			}
			
			const modalHTML = `
				<div style="background: white; padding: 30px; border-radius: 12px; max-width: 700px; width: 90vw; max-height: 80vh; overflow-y: auto; direction: rtl;">
					<div style="position: relative;">
						<button onclick="closeAnyModal()" style="position: absolute; top: 0; left: 0; background: #e74c3c; border: none; color: white; font-size: 20px; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">×</button>
						<h3 style="margin-bottom: 25px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
							💰 הוספת תשלום חדש
						</h3>
					</div>
					
					<!-- בחירת לקוח -->
					<div class="form-group" style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: bold;">לקוח:</label>
						${selectedClientId ? 
							`<input type="text" value="${selectedClientName}" disabled style="width: 100%; padding: 10px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 6px;">` :
							`<input type="text" 
								id="paymentClientSearch" 
								placeholder="התחל להקליד שם לקוח..."
								oninput="searchClientForPayment(this.value)"
								autocomplete="off"
								style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
							<input type="hidden" id="selectedPaymentClientId">
							<div id="paymentClientResults" style="border: 1px solid #ddd; border-top: none; max-height: 150px; overflow-y: auto; display: none;"></div>`
						}
					</div>
					
					<!-- תאריך ושעה -->
					<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 20px;">
						<div class="form-group">
							<label style="display: block; margin-bottom: 8px; font-weight: bold;">תאריך:</label>
							<input type="date" id="paymentDate" value="${getLocalDateString()}" 
								style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
						</div>
						<div class="form-group">
							<label style="display: block; margin-bottom: 8px; font-weight: bold;">שעה:</label>
							<input type="time" id="paymentTime" value="${new Date().toTimeString().slice(0,5)}"
								style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
						</div>
					</div>
					
					<!-- סכום ואמצעי תשלום -->
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
						<div class="form-group">
							<label style="display: block; margin-bottom: 8px; font-weight: bold;">סכום (₪):</label>
							<input type="number" id="paymentAmount" placeholder="0" step="0.01" 
								value="${specificVisit ? specificVisit.amount : ''}"
								style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
						</div>
						<div class="form-group">
							<label style="display: block; margin-bottom: 8px; font-weight: bold;">אמצעי תשלום:</label>
							<select id="paymentMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
								<option value="cash">מזומן</option>
								<option value="check">צ'ק</option>
								<option value="transfer">העברה בנקאית</option>
								<option value="app">אפליקציה (ביט/פייבוקס)</option>
							</select>
						</div>
					</div>
					
					<!-- פרטי צ'ק (מוצג רק אם בחרו צ'ק) -->
					<div id="checkDetailsSection" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
							<div class="form-group">
								<label style="display: block; margin-bottom: 8px; font-weight: bold;">מספר צ'ק:</label>
								<input type="text" id="checkReference" placeholder="מספר צ'ק"
									style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
							</div>
							<div class="form-group">
								<label style="display: block; margin-bottom: 8px; font-weight: bold;">תאריך פירעון:</label>
								<input type="date" id="checkDate"
									style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
							</div>
						</div>
					</div>
					
					<!-- הערות -->
					<div class="form-group" style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: bold;">הערות:</label>
						<textarea id="paymentNotes" rows="3" placeholder="הערות נוספות..."
							style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
					</div>
					
					<!-- רשימת טיפולים פתוחים או טיפול ספציפי -->
					${specificVisit ? `
						<!-- מצב: טיפול ספציפי -->
						<div style="background: #e8f5e9; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 2px solid #27ae60;">
							<h4 style="margin: 0 0 10px 0; color: #27ae60;">✓ תשלום עבור טיפול:</h4>
							<div style="background: white; padding: 12px; border-radius: 6px;">
								<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
									<strong>תאריך:</strong>
									<span>${formatDate(specificVisit.date)}</span>
								</div>
								<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
									<strong>עבודה:</strong>
									<span>${specificVisit.work_done || 'טיפול'}</span>
								</div>
								<div style="display: flex; justify-content: space-between;">
									<strong>סכום:</strong>
									<span style="color: #27ae60; font-weight: bold;">₪${specificVisit.amount}</span>
								</div>
							</div>
							<input type="hidden" id="specificVisitId" value="${specificVisit.ID}">
						</div>
					` : `
						<!-- מצב: רשימת טיפולים פתוחים -->
						<div id="openVisitsSection" style="display: none; background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 2px solid #ffc107;">
							<h4 style="margin: 0 0 15px 0; color: #856404;">בחר טיפולים לסגירה:</h4>
							<div id="openVisitsList" style="max-height: 200px; overflow-y: auto;"></div>
							<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 14px; color: #666;">
								<strong>סכום נבחר:</strong> <span id="selectedVisitsTotal">0</span> ₪
							</div>
						</div>
					`}
					
					<!-- כפתורים -->
					<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
						<button onclick="closeAnyModal()" class="btn" style="background: #95a5a6; color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer;">
							ביטול
						</button>
						<button id="savePaymentBtn" onclick="saveNewPayment()" class="btn" style="background: #27ae60; color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
							💾 שמור תשלום
						</button>
					</div>
				</div>
			`;
			
			showModal(modalHTML);
			
			// שמירת הלקוח הנבחר אם יש
			if (selectedClientId) {
				window.selectedPaymentClientId = selectedClientId;
				loadOpenVisitsForPayment(selectedClientId);
			}
			
			// הוספת event listener לשינוי אמצעי תשלום
			setTimeout(() => {
				const methodSelect = document.getElementById('paymentMethod');
				if (methodSelect) {
					methodSelect.addEventListener('change', toggleCheckDetails);
				}
			}, 100);
		}


		// פתיחת מודל תשלום עבור טיפול ספציפי
		function addPaymentForVisit(visitId) {
			const visit = visits.find(v => v.ID === visitId);
			if (!visit) {
				showToast('טיפול לא נמצא', 'error');
				return;
			}
			
			// פתיחת המודל עם הלקוח והטיפול הספציפי
			showAddPaymentModal(visit.location_id, visitId);
		}


		// הצגה/הסתרה של פרטי צ'ק
		function toggleCheckDetails() {
			const method = document.getElementById('paymentMethod').value;
			const checkSection = document.getElementById('checkDetailsSection');
			if (checkSection) {
				checkSection.style.display = (method === 'check') ? 'block' : 'none';
			}
		}

		// חיפוש לקוח להוספת תשלום
		function searchClientForPayment(searchTerm) {
			const resultsDiv = document.getElementById('paymentClientResults');
			
			if (!searchTerm || searchTerm.trim().length < 2) {
				resultsDiv.style.display = 'none';
				return;
			}
			
			const matchingClients = searchClientsAdvanced(searchTerm);
			
			if (matchingClients.length === 0) {
				resultsDiv.innerHTML = '<div style="padding: 10px; color: #999;">לא נמצאו לקוחות</div>';
				resultsDiv.style.display = 'block';
				return;
			}
			
			resultsDiv.innerHTML = matchingClients.slice(0, 10).map(client => {
				const safeName = client.name.replace(/'/g, '&#39;');
				return `
					<div onclick="selectClientForPayment('${client.ID}', '${safeName}')" 
						 style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; background: white;"
						 onmouseover="this.style.background='#f0f0f0'" 
						 onmouseout="this.style.background='white'">
						<strong>${client.name}</strong>
						${client.full_address ? `<br><small style="color: #666;">${client.full_address}</small>` : ''}
					</div>
				`;
			}).join('');
			
			resultsDiv.style.display = 'block';
		}

		// בחירת לקוח להוספת תשלום
		function selectClientForPayment(clientId, clientName) {
			document.getElementById('paymentClientSearch').value = clientName;
			document.getElementById('selectedPaymentClientId').value = clientId;
			document.getElementById('paymentClientResults').style.display = 'none';
			
			window.selectedPaymentClientId = clientId;
			
			// טען טיפולים פתוחים של הלקוח
			loadOpenVisitsForPayment(clientId);
		}
	   

//////<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
//////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

	   
	   // טעינת טיפולים פתוחים של לקוח
		function loadOpenVisitsForPayment(clientId) {
			const openVisitsSection = document.getElementById('openVisitsSection');
			const openVisitsList = document.getElementById('openVisitsList');
			
			if (!openVisitsSection || !openVisitsList) return;
			
			// מצא את כל הטיפולים הפתוחים (לא שולמו במלואם) של הלקוח
			const clientVisits = visits.filter(visit => {
				if (visit.location_id !== clientId) return false;
				if (!visit.amount || visit.amount <= 0) return false;
				
				// בדוק אם יש חוב
				const paidAmount = getVisitPaidAmount(visit.ID);
				const debt = parseFloat(visit.amount) - paidAmount;
				
				return debt > 0.01; // יש חוב
			});
			
			if (clientVisits.length === 0) {
				openVisitsSection.style.display = 'none';
				return;
			}
			
			// מיין לפי תאריך
			clientVisits.sort((a, b) => new Date(a.date) - new Date(b.date));
			
			// הצג את הטיפולים
			openVisitsList.innerHTML = clientVisits.map(visit => {
				const paidAmount = getVisitPaidAmount(visit.ID);
				const debt = parseFloat(visit.amount) - paidAmount;
				
				return `
					<div style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px; background: white;">
						<label style="display: flex; align-items: center; cursor: pointer;">
							<input type="checkbox" 
								   class="visit-checkbox" 
								   data-visit-id="${visit.ID}"
								   data-visit-amount="${visit.amount}"
								   data-visit-debt="${debt.toFixed(2)}"
								   onchange="updateSelectedVisitsTotal()"
								   style="margin-left: 10px; transform: scale(1.3);">
							<div style="flex: 1;">
								<div style="display: flex; justify-content: space-between; align-items: center;">
									<span style="font-weight: bold;">${formatDate(visit.date)}</span>
									<span style="color: #e74c3c; font-weight: bold;">${debt.toFixed(2)} ₪</span>
								</div>
								<div style="font-size: 13px; color: #666; margin-top: 4px;">
									${visit.work_done || 'טיפול'}
									${paidAmount > 0 ? `<span style="color: #f39c12;"> (שולם: ${paidAmount}₪)</span>` : ''}
								</div>
							</div>
						</label>
					</div>
				`;
			}).join('');
			
			openVisitsSection.style.display = 'block';
			updateSelectedVisitsTotal();
		}

		// עדכון סכום הטיפולים הנבחרים
		function updateSelectedVisitsTotal() {
			const checkboxes = document.querySelectorAll('.visit-checkbox:checked');
			let total = 0;
			
			checkboxes.forEach(cb => {
				const debt = parseFloat(cb.getAttribute('data-visit-debt')) || 0;
				total += debt;
			});
			
			const totalSpan = document.getElementById('selectedVisitsTotal');
			if (totalSpan) {
				totalSpan.textContent = total.toFixed(2);
			}
		}

		// תרגום אמצעי תשלום מאנגלית לעברית
		function translatePaymentMethod(method) {
			const translations = {
				'cash': 'מזומן',
				'check': 'צ\'ק',
				'transfer': 'העברה בנקאית',
				'app': 'אפליקציה'
			};
			return translations[method] || method;
		}

		// שמירת תשלום חדש
		async function saveNewPayment() {
			// קבל נתונים מהטופס
			const clientId = window.selectedPaymentClientId || document.getElementById('selectedPaymentClientId')?.value;
			const date = document.getElementById('paymentDate')?.value;
			const amount = parseFloat(document.getElementById('paymentAmount')?.value) || 0;
			const method = document.getElementById('paymentMethod')?.value;
			const notes = document.getElementById('paymentNotes')?.value || '';
			const reference = document.getElementById('checkReference')?.value || '';
			const checkDate = document.getElementById('checkDate')?.value || '';
			
			// בדיקות תקינות
			if (!clientId) {
				showToast('יש לבחור לקוח', 'error');
				return;
			}
			
			if (!date) {
				showToast('יש להזין תאריך', 'error');
				return;
			}
			
			if (amount <= 0) {
				showToast('יש להזין סכום תקין', 'error');
				return;
			}
			
			// מצא את הלקוח
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// בדוק אם יש טיפול ספציפי (מהכפתור בטבלה)
			const specificVisitId = document.getElementById('specificVisitId')?.value;
			let selectedVisits = [];

			if (specificVisitId) {
				// מצב: טיפול ספציפי
				const visit = visits.find(v => v.ID === specificVisitId);
				if (visit) {
					const paidAmount = getVisitPaidAmount(visit.ID);
					const debt = parseFloat(visit.amount) - paidAmount;
					selectedVisits = [{ visitId: visit.ID, debt: debt }];
				}
			} else {
				// מצב: רשימת טיפולים עם checkboxes
				const selectedCheckboxes = document.querySelectorAll('.visit-checkbox:checked');
				selectedVisits = Array.from(selectedCheckboxes).map(cb => ({
					visitId: cb.getAttribute('data-visit-id'),
					debt: parseFloat(cb.getAttribute('data-visit-debt'))
				}));
			}

			// בדוק שיש טיפולים
			if (selectedVisits.length === 0) {
				if (!confirm('לא נבחרו טיפולים לסגירה. האם להמשיך בכל זאת?')) {
					return;
				}
			}
			
			try {
				showLoading('שומר תשלום...');
				
				// 🔒 נעל את הכפתור
				let saveBtn = document.getElementById('savePaymentBtn');
				if (saveBtn) saveBtn.disabled = true;
				
				// צור את התשלום
				const payment = {
					ID: generateID(),
					date: date,
					time: new Date().toTimeString().split(' ')[0].substring(0, 5), // HH:MM
					amount: amount,
					payment_method: translatePaymentMethod(method),
					source_type: 'manual_payment',
					client_id: clientId,
					client_name: client.name,
					notes: notes || '',
					status: 'completed',
					created_at: new Date().toISOString(),
					reference: reference || '',
					check_date: checkDate || '',
					bank_account: '',
					payment_details: ''
				};
				
				// הוסף לרשימת התשלומים
				payments.push(payment);
				
				// צור קישורים לטיפולים
				let remainingAmount = amount;
				const linksToSave = [];
				
				selectedVisits.forEach(selectedVisit => {
					if (remainingAmount <= 0) return;
					
					const visit = visits.find(v => v.ID === selectedVisit.visitId);
					if (!visit) return;
					
					const debt = selectedVisit.debt;
					const amountToAllocate = Math.min(remainingAmount, debt);
					
					// צור קישור
					const link = {
						ID: generateID(),
						payment_id: payment.ID,
						visit_id: visit.ID,
						amount_allocated: amountToAllocate
					};
					
					paymentVisitLinks.push(link);
					linksToSave.push(link);
					
					// עדכן את הטיפול
					const currentPaid = getVisitPaidAmount(visit.ID);
					const newPaidAmount = currentPaid + amountToAllocate;
					const visitAmount = parseFloat(visit.amount);
					
					if (newPaidAmount >= visitAmount - 0.01) {
						// שולם במלואו
						visit.paid = '1';
					} else {
						// שולם חלקית
						visit.paid = '3';
					}
					
					remainingAmount -= amountToAllocate;
				});
				
				// שמירה מקומית
				saveToLocalStorage();
				
				// שמור לענן
				if (access_token && SPREADSHEET_ID) {
					// שמור תשלום חדש לענן
					await gapi.client.sheets.spreadsheets.values.append({
						spreadsheetId: SPREADSHEET_ID,
						range: 'Payments!A:P',
						valueInputOption: 'USER_ENTERED',
						resource: {
							values: [[
							payment.ID,
							payment.date,
							payment.time,
							payment.amount,
							payment.payment_method,
							payment.source_type,
							payment.client_id,
							payment.client_name,
							payment.notes,
							payment.status,
							payment.created_at,
							payment.reference,
							payment.check_date,
							payment.bank_account,
							payment.payment_details,
							payment.receipt_id || ''
						]]
						}
					});
					
					// שמור קישורים אם יש
					if (linksToSave.length > 0) {
						await savePaymentVisitLinksBatch(paymentVisitLinks);
					}
					
					// עדכן טיפולים שהשתנו
					const visitsToUpdate = selectedVisits
						.map(sv => visits.find(v => v.ID === sv.visitId))
						.filter(v => v);
					
					if (visitsToUpdate.length > 0) {
						await updateMultipleVisitsInSheets(visitsToUpdate);
					}
					
					showToast('✅ תשלום נוסף בהצלחה ונשמר לענן!', 'success');
				} else {
					showToast('💾 תשלום נוסף בהצלחה (מקומית)', 'info');
				}
				
				
				hideLoading();

				// 🔓 שחרר את הכפתור
				saveBtn = document.getElementById('savePaymentBtn');
				if (saveBtn) saveBtn.disabled = false;

				closeAnyModal();
				
				// רענן את תצוגת הטיפולים
				if (typeof filterVisits === 'function') {
					applyVisitFilters();
				}
				
				// רענן תצוגות
				if (typeof displayDebts === 'function') {
					displayDebts();
				}
				if (typeof applyPaymentFilters === 'function') {
					applyPaymentFilters();
				}
				
				// רענון טיפולים של היום
				loadTodayTreatments();
				
				// שאלה להפקת קבלה
				setTimeout(() => {
					showReceiptPrompt(payment);
				}, 500);
				
			} catch (error) {
				console.error('Error saving payment:', error);
				showToast('❌ שגיאה בשמירת תשלום', 'error');
				hideLoading();
				
				// 🔓 שחרר את הכפתור
				saveBtn = document.getElementById('savePaymentBtn');
				if (saveBtn) saveBtn.disabled = false;
			}
		}


		// פונקציית עזר למחיקת תשלום (לעתיד)
		function deletePayment(paymentId) {
			if (!confirm('האם למחוק את התשלום? פעולה זו תבטל את הקישורים לטיפולים.')) {
				return;
			}
			
			// מחק קישורים
			const linksToRemove = paymentVisitLinks.filter(link => link.payment_id === paymentId);
			linksToRemove.forEach(link => {
				const visit = visits.find(v => v.ID === link.visit_id);
				if (visit) {
					// החזר את הטיפול למצב לא שולם
					visit.paid = 'unpaid';
				}
				
				// מחק את הקישור
				const linkIndex = paymentVisitLinks.findIndex(l => l.ID === link.ID);
				if (linkIndex > -1) {
					paymentVisitLinks.splice(linkIndex, 1);
				}
			});
			
			// מחק את התשלום
			const paymentIndex = payments.findIndex(p => p.ID === paymentId);
			if (paymentIndex > -1) {
				payments.splice(paymentIndex, 1);
			}
			
			// שמור
			saveToLocalStorage();
			
			if (access_token && SPREADSHEET_ID) {
				saveAllToSheetsOptimized();
			}
			
			showToast('תשלום נמחק בהצלחה', 'success');
			
			// רענן תצוגות
			if (typeof applyPaymentFilters === 'function') {
				applyPaymentFilters();
			}
			if (typeof displayDebts === 'function') {
				displayDebts();
			}
		}

	   
	   // פונקציה לחישוב ועדכון תאריכי טיפול אחרון וטיפול הבא
		// פונקציה לחישוב ועדכון תאריכי טיפול אחרון וטיפול הבא - גרסה מתקנת
		async function calculateTreatmentDates() {
			console.log('🔄 מחשב תאריכי טיפול אחרון וטיפול הבא...');
			
			let updatedLocations = [];
			
			for (const location of locations) {
				// מצא את כל הטיפולים של הלקוח הזה
				const locationVisits = visits.filter(visit => visit.location_id === location.ID);
				
				if (locationVisits.length > 0) {
					// מיין לפי תאריך (החדש ביותר ראשון)
					locationVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
					
					// הטיפול האחרון
					const lastVisit = locationVisits[0];
					const lastVisitDate = lastVisit.date;
					
					// חישוב יום מועדף לפי הביקור האחרון
					if (!location.allowed_day || location.allowed_day === '') {
						const lastDate = new Date(lastVisitDate);
						const dayNames = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];
						location.allowed_day = dayNames[lastDate.getDay()];
						/// console.log(`📅 ${location.name}: יום מועדף חושב כ-${location.allowed_day} (לפי ביקור מ-${lastVisitDate})`);
					}
					
					// חישוב תאריך הטיפול הבא
					const lastDate = new Date(lastVisitDate);
					const intervalDays = (location.interval_weeks || 4) * 7; // ברירת מחדל 4 שבועות
					const nextDate = new Date(lastDate);
					nextDate.setDate(lastDate.getDate() + intervalDays);
					
					// פורמט התאריך ל-YYYY-MM-DD
					const nextVisitDate = `${nextDate.getFullYear()}-${String(nextDate.getMonth() + 1).padStart(2, '0')}-${String(nextDate.getDate()).padStart(2, '0')}`;	
					// עדכון האובייקט המקומי
					location.last_visit = lastVisitDate;
					location.next_visit = nextVisitDate;
					
					updatedLocations.push(location);
					
					// console.log(`📅 ${location.name}: טיפול אחרון ${lastVisitDate} → טיפול הבא ${nextVisitDate}`);
				}
			}
			
			// עדכון בגוגל שיטס במקביל - קריאה אחת בלבד עבור כל הלקוחות
			if (updatedLocations.length > 0) {
				console.log(`🔄 מעדכן ${updatedLocations.length} לקוחות בגוגל שיטס...`);
				await updateTreatmentDatesInSheets(updatedLocations);
				showToast(`📅 תאריכי טיפול עודכנו עבור ${updatedLocations.length} לקוחות`, 'success', 2000);
			}
			
			// רענן נתוני תכנון
			refreshPlanningAfterTreatmentUpdate();
			
			return updatedLocations.length;
		}
	   
	   
	    // פונקציה לעדכון תאריכי הטיפול בגוגל שיטס
		async function updateTreatmentDatesInSheets(locationsToUpdate) {
			if (!await validateToken() || locationsToUpdate.length === 0) return false;
			
			console.log(`🔄 מעדכן תאריכי טיפול עבור ${locationsToUpdate.length} לקוחות בגוגל שיטס...`);
			
			try {
				// קרא את כל הנתונים הנוכחיים מהטבלה
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:P'
				});
				
				const allRows = response.result.values || [];
				const updatedRows = [...allRows];
				let updatedCount = 0;
				
				// עבור כל לקוח שצריך עדכון
				for (const location of locationsToUpdate) {
					// מצא את השורה המתאימה בטבלה
					for (let i = 1; i < allRows.length; i++) { // מתחיל מ-1 כדי לדלג על הכותרות
						if (allRows[i][0] === location.ID) {
							// עדכן את עמודות התאריכים והיום המועדף
							updatedRows[i][7] = location.allowed_day;   // allowed_day (עמודה 7)
							updatedRows[i][13] = location.last_visit;   // last_visit
							updatedRows[i][14] = location.next_visit;   // next_visit
							updatedCount++;
							break;
						}
					}
				}
				
				// שמור את כל הטבלה המעודכנת בקריאה אחת בלבד
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:P',
					valueInputOption: 'USER_ENTERED',
					resource: {
						values: updatedRows
					}
				});
				
				console.log(`✅ עודכנו ${updatedCount} תאריכי טיפול בגוגל שיטס`);
				return true;
			} catch (error) {
				console.error('Error updating treatment dates in sheets:', error);
				return false;
			}
		}
		
		// פונקציה לעדכון תאריכי טיפול עבור לקוח אחד לאחר הוספת ביקור
		// Verify this function exists and works correctly - it should already be in your code
		// If it's missing any part, here's the complete correct version:

		async function updateSingleLocationTreatmentDates(locationId) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) return;
			
			// מצא את כל הביקורים של הלקוח הזה
			const locationVisits = visits.filter(visit => visit.location_id === locationId);
			
			if (locationVisits.length > 0) {
				// מיון לפי תאריך (החדש ביותר ראשון)
				locationVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
				
				// הטיפול האחרון
				const lastVisit = locationVisits[0];
				const lastVisitDate = lastVisit.date;
				
				// ✅ עדכון last_visit תמיד
				location.last_visit = lastVisitDate;
				
				// ✅ עדכון next_visit רק אם הטיפול האחרון היה "טיפול מלא"
				if (lastVisit.visit_type === 'מלא') {
					// חישוב תאריך הטיפול הבא
					const lastDate = new Date(lastVisitDate);
					const intervalDays = (location.interval_weeks || 4) * 7; // ברירת מחדל 4 שבועות
					const nextDate = new Date(lastDate);
					nextDate.setDate(lastDate.getDate() + intervalDays);
					
					// פורמט התאריך ל-YYYY-MM-DD
					const nextVisitDate = `${nextDate.getFullYear()}-${String(nextDate.getMonth() + 1).padStart(2, '0')}-${String(nextDate.getDate()).padStart(2, '0')}`;
					location.next_visit = nextVisitDate;
					
					console.log(`📅 עודכן לקוח ${location.name}: טיפול אחרון ${lastVisitDate} → טיפול הבא ${nextVisitDate}`);
				} else {
					console.log(`⏸️ תאריך הבא לא עודכן ללקוח ${location.name} - סוג טיפול: ${lastVisit.visit_type}`);
				}
				
				// עדכון בגוגל שיטס
				await updateTreatmentDatesInSheets([location]);
				
				// שמירה מקומית
				saveToLocalStorage();
			}
		}
	   
	   
	   // פונקציה לבדיקת מצב נתוני התכנון - לדיבוג
		function debugPlanningData() {
			console.log('=== Debug Planning Data ===');
			console.log(`סה"כ לקוחות: ${locations.length}`);
			
			// בדוק מה יש בשדה active
			console.log('דוגמאות של שדה active:', locations.slice(0, 5).map(loc => ({ name: loc.name, active: loc.active, type: typeof loc.active })));

			const activeLocations = locations.filter(loc => loc.active === "כן" || loc.active === true || loc.active === "1");
			console.log(`לקוחות פעילים: ${activeLocations.length}`);
			
			const locationsWithDates = activeLocations.filter(loc => loc.next_visit && loc.next_visit.trim() !== '');
			console.log(`לקוחות עם תאריכי טיפול: ${locationsWithDates.length}`);
			
			// הצג 5 לקוחות ראשונים
			locationsWithDates.slice(0, 5).forEach(loc => {
				console.log(`👤 ${loc.name}: אחרון=${loc.last_visit}, הבא=${loc.next_visit}`);
			});
			
			const today = new Date();
			const todayStr = today.toISOString().split('T')[0];
			console.log(`תאריך היום: ${todayStr}`);
			
			const dueToday = locationsWithDates.filter(loc => {
				return new Date(loc.next_visit) <= today;
			});
			console.log(`צריכים טיפול היום: ${dueToday.length}`);
			
			console.log('=== סיום Debug ===');
		}
	   
	   
		// פונקציה חדשה לייבוא מהיר וכולל של כל הנתונים
		async function importFromHelperTableFast() {
			console.log('🚀 Starting FAST complete import from helper table...');
			
			if (!await validateToken()) {
				showToast('התחבר לגוגל קודם', 'warning');
				return;
			}
			
			const importTableId = localStorage.getItem('importTableId');
			console.log('🔍 Import Table ID:', importTableId);  // ✅ הוסף את זה

			if (!importTableId) {
				showToast('לא נמצא ID של טבלת העזר', 'warning');
				return;
			}

			console.log('✅ Import table ID exists, proceeding with import...');  // ✅ הוסף את זה
			
			try {
				showLoading('מייבא נתונים מהר מטבלת העזר...');
				
				// Statistics tracking
				const stats = {
					locations: { imported: 0, skipped: 0 },
					visits: { imported: 0, skipped: 0 },
					receipts: { imported: 0, skipped: 0 }
				};
				
				// Arrays for new data only
				const newLocations = [];
				const newVisits = [];
				const newReceipts = [];
				const payments = [];
				const paymentVisitLinks = [];
				
				console.log('📊 About to load data from helper table:', importTableId);  // ✅ הוסף את זה
				
				// ======== STEP 1: Import Locations ========
				try {
					console.log('📊 Starting locations import...');
					const locationsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Locations!A2:I1000'
					});
					
					if (locationsResponse.result.values?.length > 0) {
						for (const row of locationsResponse.result.values) {
							if (row.length > 0 && row[0]) { // Has customer name
								const customerName = row[0].trim();
								const street = row[1] || '';
								const houseNumber = row[2] || '';
								const city = row[3] || '';
								const fullAddress = `${street} ${houseNumber} ${city}`.trim();
								
								// Check if customer already exists
								const existingCustomer = locations.find(loc => 
									loc.name.toLowerCase() === customerName.toLowerCase() ||
									(fullAddress && loc.full_address && 
									 loc.full_address.toLowerCase() === fullAddress.toLowerCase())
								);
								
								if (!existingCustomer) {
									const locationData = {
										ID: generateID(),
										name: customerName,
										full_address: fullAddress || customerName,
										neighborhood: '',
										city: city,
										contact_person: row[5] || '',
										phone: '',
										allowed_day: row[7] || 'א',
										interval_weeks: parseInt(row[4]) || 4,
										temp_addition: false,
										base_amount: parseFloat(row[6]) || 0,
										active: row[8] || '1',
										notes: 'יובא מטבלת עזר',
										last_visit: '',
										next_visit: '',
										client_requests: ''
									};
									
									locations.push(locationData);
									newLocations.push(locationData);
									stats.locations.imported++;
								} else {
									stats.locations.skipped++;
								}
							}
						}
						console.log(`✅ Processed ${stats.locations.imported} new locations`);
					}
				} catch (error) {
					console.error('❌ Error importing locations:', error);
				}
				
				// ======== STEP 2: Import Visits ========
				try {
					console.log('🔧 Starting visits import...');
					const visitsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Visits!A2:M1000'
					});
					
					if (visitsResponse.result.values?.length > 0) {
						let notFoundCustomers = [];
						
						for (const row of visitsResponse.result.values) {
							if (row.length > 3 && row[3]) { // Has customer in column 3
								const customerName = row[3].trim();
								
								// Find existing customer
								const existingCustomer = locations.find(loc =>
									loc.name && loc.name.toLowerCase() === customerName.toLowerCase()
								);
								
								if (!existingCustomer) {
									if (!notFoundCustomers.includes(customerName)) {
										notFoundCustomers.push(customerName);
									}
									stats.visits.skipped++;
									continue;
								}
								
								// Build date from 3 columns: year, month, day
								const year = row[0];
								const month = String(row[1]).padStart(2, '0');
								const day = String(row[2]).padStart(2, '0');
								const visitDate = `${year}-${month}-${day}`;
								
								const workDone = row[7] || '';
								const amount = parseFloat(row[9]) || 0;
								
								// Check for duplicates
								const isDuplicate = visits.some(existing =>
									existing.location_id === existingCustomer.ID &&
									existing.date === visitDate &&
									existing.work_done === workDone &&
									Math.abs(existing.amount - amount) < 0.01
								);
								
								if (!isDuplicate) {
									const visitData = {
										ID: generateID(),
										date: visitDate,
										location_id: existingCustomer.ID,
										location_name: customerName,
										visit_type: row[5] || 'regular',
										work_done: workDone,
										duration_minutes: (() => {
											const val = parseFloat(row[8]) || 0;
											// If value < 24, assume it's hours and convert to minutes
											// If value >= 24, assume it's already in minutes
											return val < 24 ? val * 60 : val;
										})(),
										num_workers: 1,
										start_time: '',
										end_time: '',
										amount: amount,
										paid: mapPaymentStatus(row[10]),
										expense: parseFloat(row[11]) || 0,
										notes: row[12] || ''
									};
									
									visits.push(visitData);
									newVisits.push(visitData);
									stats.visits.imported++;
									
									// Create payment if marked as paid
									const paidStatus = row[10] || '';
									if (paidStatus === '1' || paidStatus === 'כן' || paidStatus === 'שולם') {
										const payment = {
											ID: generateID(),
											date: visitDate,
											time: '12:00',
											amount: amount,
											payment_method: 'cash',
											source_type: 'import_from_helper_fast',
											client_id: existingCustomer.ID,
											client_name: existingCustomer.name,
											notes: `תשלום עבור ייבוא מהיר - ${workDone}`,
											status: 'completed',
											created_at: new Date().toISOString()
										};
										
										payments.push(payment);
										
										const link = {
											ID: generateID(),
											payment_id: payment.ID,
											visit_id: visitData.ID,
											amount_allocated: amount,
											link_type: 'full_payment',
											created_at: new Date().toISOString()
										};
										
										paymentVisitLinks.push(link);
									}
								} else {
									stats.visits.skipped++;
								}
							}
						}
						
						if (notFoundCustomers.length > 0) {
							console.log(`⚠️ ${notFoundCustomers.length} customers not found for visits:`, notFoundCustomers.slice(0, 5));
						}
						console.log(`✅ Processed ${stats.visits.imported} new visits`);
					}
				} catch (error) {
					console.error('❌ Error importing visits:', error);
				}
				
				
				// ======== STEP 3: Import Receipts ========
				try {
					console.log('🧾 Starting receipts import...');
					const receiptsResponse = await gapi.client.sheets.spreadsheets.values.get({
						spreadsheetId: importTableId,
						range: 'Receipts!A2:K1000'
					});
					
					if (receiptsResponse.result.values?.length > 0) {
						let notFoundAddresses = [];
						
						for (const row of receiptsResponse.result.values) {
							if (row.length > 6 && row[6]) { // Has address in column 6
								const customerAddress = row[6].trim();
								
								// Find customer by address - search in both name and full_address
								const existingCustomer = locations.find(loc =>
									(loc.name && loc.name.toLowerCase().includes(customerAddress.toLowerCase())) ||
									(loc.full_address && loc.full_address.toLowerCase().includes(customerAddress.toLowerCase()))
								);
								
								if (!existingCustomer) {
									if (!notFoundAddresses.includes(customerAddress)) {
										notFoundAddresses.push(customerAddress);
									}
									stats.receipts.skipped++;
									continue;
								}
								
								// Build date
								const year = row[3];
								const month = String(row[4]).padStart(2, '0');
								const day = String(row[5]).padStart(2, '0');
								const receiptDate = `${year}-${month}-${day}`;
								
								const bookNumber = row[1] || '';
								const receiptNumber = row[2] || '';
								
								// Check for duplicates
								const isDuplicateReceipt = receipts.some(existing =>
									existing.book_number === bookNumber &&
									existing.receipt_number === receiptNumber &&
									existing.date === receiptDate
								);
								
								if (!isDuplicateReceipt) {
									const receiptData = {
										ID: generateID(),
										book_number: bookNumber,
										receipt_number: receiptNumber,
										date: receiptDate,
										location_id: existingCustomer.ID,
										location_name: customerAddress,
										amount: parseFloat(row[7]) || 0,
										payment_type: row[8] || '',
										notes: `${row[9] || ''} ${row[10] || ''}`.trim()
									};
									
									receipts.push(receiptData);
									newReceipts.push(receiptData);
									stats.receipts.imported++;
								} else {
									stats.receipts.skipped++;
								}
							}
						}
						
						if (notFoundAddresses.length > 0) {
							console.log(`⚠️ ${notFoundAddresses.length} addresses not found for receipts:`, notFoundAddresses.slice(0, 5));
						}
						console.log(`✅ Processed ${stats.receipts.imported} new receipts`);
					}
				} catch (error) {
					console.error('❌ Error importing receipts:', error);
				}
				
				
				// ======== STEP 4: Save to Local Storage ========
				saveToLocalStorage();
				
				
				// ======== STEP 4.5: Calculate Treatment Dates ========
				if (stats.visits.imported > 0) {
					showToast('מחשב תאריכי טיפול...', 'info', 2000);
					const updatedCount = await calculateTreatmentDates();
					if (updatedCount > 0) {
						console.log(`✅ עודכנו תאריכי טיפול עבור ${updatedCount} לקוחות`);
					}
				}
				
				// ======== STEP 5: Save to Cloud ========
				console.log('☁️ Saving to cloud...');
				const savePromises = [];
				
				if (newLocations.length > 0) {
					console.log('🔵 saveLocationsBatch called for new locations');
					savePromises.push(saveLocationsBatch(newLocations));
				}
				
				if (newVisits.length > 0) {
					console.log('🔵 saveVisitsBatch called with', newVisits.length, 'visits - checking for duplicates');
					savePromises.push(saveVisitsBatch(newVisits));
				}
				
				if (newReceipts.length > 0) {
					console.log('🔵 saveReceiptsBatch called with', newReceipts.length, 'receipts');
					savePromises.push(saveReceiptsBatch(newReceipts));
				}
				
				const saveResults = await Promise.all(savePromises);
				const allSaved = saveResults.every(result => result === true);
				
				// ======== STEP 6: Update UI ========
				loadLocationsTable();
				loadLocationsForSelect();
				loadPlanningData();
				
				hideLoading();
				
				// ======== STEP 7: Final Report ========
				const totalImported = stats.locations.imported + stats.visits.imported;
				const totalSkipped = stats.locations.skipped + stats.visits.skipped;
				
				if (totalImported > 0) {
					const message = `🎉 ייבוא הושלם בהצלחה!
					
		✅ יובאו: ${stats.locations.imported} לקוחות, ${stats.visits.imported} ביקורים, ${stats.receipts.imported} קבלות
		${totalSkipped > 0 ? `⚠️ דולגו (כפילויות): ${totalSkipped} רשומות` : ''}
		${allSaved ? '☁️ נשמר לענן בהצלחה' : '⚠️ חלק מהנתונים לא נשמרו לענן'}`;
					
					showToast(message, 'success', 8000);
				} else {
					showToast('לא נמצאו נתונים חדשים לייבוא', 'info');
				}
				
			} catch (error) {
				console.error('❌ Error in fast import:', error);
				hideLoading();
				showToast('שגיאה בייבוא מהיר', 'error');
			}
		}
		

		// ✅ NEW: Import payments from PaymentsImport helper sheet
		async function importPaymentsFromHelper() {
			console.log('💳 Starting payments import from helper table...');
			
			const importTableId = localStorage.getItem('importTableId');
			
			if (!importTableId) {
				showToast('⚠️ לא נמצא מזהה טבלת עזר. אנא הגדר תחילה.', 'warning');
				return;
			}
			
			try {
				showLoading('טוען תשלומים מטבלת עזר...');
				
				// Load data from PaymentsImport sheet
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: importTableId,
					range: 'PaymentsImport!A2:G' // Skip header row
				});
				
				const rows = response.result.values || [];
				
				if (rows.length === 0) {
					showToast('ℹ️ אין נתונים בטבלת PaymentsImport', 'info');
					hideLoading();
					return;
				}
				
				let imported = 0;
				let notFound = [];
				
				rows.forEach((row, index) => {
					const [date, time, clientAddress, amount, paymentMethod, notes, originalText] = row;
					
					// Skip empty rows
					if (!date || !amount) return;
					
					// Find matching client
					const client = findClientByPartialAddress(clientAddress);
					
					if (!client) {
						notFound.push({
							row: index + 2,
							address: clientAddress,
							amount: amount,
							originalText: originalText || clientAddress
						});
						return;
					}
					
					// Create new payment
					const newPayment = {
						ID: generateID(),
						client_id: client.ID,
						client_name: client.name,
						date: date,
						amount: parseFloat(amount) || 0,
						payment_method: (paymentMethod === 'לא צוין' || !paymentMethod) ? 'מזומן' : paymentMethod,
						notes: notes || '',
						original_text: originalText || clientAddress
					};
					
					payments.push(newPayment);
					imported++;
				});
				
				// Save to localStorage
				saveToLocalStorage();
				
				// ✅ ADDED: Save to Google Sheets
				if (access_token && SPREADSHEET_ID && imported > 0) {
					try {
						// Get the newly imported payments (last 'imported' items)
						const newPayments = payments.slice(-imported);
						await savePaymentsBatch(newPayments);
						console.log('✅ Payments saved to Google Sheets');
					} catch (error) {
						console.error('Error saving payments to sheets:', error);
						showToast('⚠️ התשלומים נשמרו מקומית אבל לא בענן', 'warning');
					}
				}
				
				hideLoading();
				
				// Show results
				let message = `✅ יובאו ${imported} תשלומים בהצלחה!`;
				
				if (notFound.length > 0) {
					message += `\n\n⚠️ ${notFound.length} תשלומים לא זוהו:`;
					notFound.slice(0, 5).forEach(item => {
						message += `\n• ${item.address} (${item.amount} ₪)`;
					});
					if (notFound.length > 5) {
						message += `\n... ועוד ${notFound.length - 5}`;
					}
				}
				
				showToast(message, imported > 0 ? 'success' : 'warning');
				
				// Refresh displays
				if (typeof displayPayments === 'function') displayPayments();
				if (typeof displayDebts === 'function') displayDebts();
				
			} catch (error) {
				console.error('Error importing payments:', error);
				showToast('❌ שגיאה בייבוא תשלומים: ' + error.message, 'error');
				hideLoading();
			}
		}
		
		
		// Helper function to find client by partial address
		function findClientByPartialAddress(partialAddress) {
			if (!partialAddress) return null;
			
			const normalized = partialAddress.trim().toLowerCase();
			
			// Try exact match first
			let match = locations.find(loc => 
				loc.name.toLowerCase() === normalized ||
				loc.full_address?.toLowerCase() === normalized
			);
			
			if (match) return match;
			
			// Try partial match
			match = locations.find(loc => {
				const locName = loc.name.toLowerCase();
				const locAddress = (loc.full_address || '').toLowerCase();
				
				return locName.includes(normalized) || 
					   normalized.includes(locName) ||
					   locAddress.includes(normalized) ||
					   normalized.includes(locAddress);
			});
			
			return match;
		}

	   
	   ////////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

		// החלף את saveEditedLocation בפונקציה זו:
		function saveEditedLocation(locationId) {
			console.log(`✅ saveEditedLocation ('${locationId}')`);
			const locationIndex = locations.findIndex(g => g.ID == locationId);
			if (locationIndex === -1) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			try {
				// עדכן את הלקוח במערך המקומי
				const updatedLocation = {
					...locations[locationIndex], // שמור נתונים קיימים
					name: document.getElementById('editLocationName').value,
					full_address: document.getElementById('editLocationAddress').value,
					neighborhood: document.getElementById('editLocationNeighborhood').value,
					city: document.getElementById('editLocationCity').value,
					contact_person: document.getElementById('editLocationContact').value,
					phone: document.getElementById('editLocationPhone').value,
					allowed_day: document.getElementById('editLocationDay').value,
					interval_weeks: parseInt(document.getElementById('editLocationInterval').value) || 4,
					base_amount: parseFloat(document.getElementById('editLocationAmount').value) || 0,
					active: document.getElementById('editLocationActive').value,
					next_visit: document.getElementById('editLocationNextVisit').value,
					client_requests: document.getElementById('editLocationClientRequests').value,
					notes: document.getElementById('editLocationNotes').value
				};
				
				locations[locationIndex] = updatedLocation;
				
				// שמור מקומית תמיד
				saveToLocalStorage();
				updateCloudStatus('💾 שומר...', 'מעדכן');
				
				// נסה לשמור בענן
				if (access_token && SPREADSHEET_ID) {
					console.log('🔍 About to call updateLocationInCloud with:', updatedLocation.client_requests);
					// עדכון בענן (לא הוספה חדשה)
					updateLocationInCloud(updatedLocation).then(() => {
						updateCloudStatus('✅ מחובר ומסונכרן', 'נשמר');
						showToast('לקוח עודכן בהצלחה במערכת ובענן!', 'success');
					}).catch(error => {
						console.error('❌ updateLocationInCloud failed:', error);
						if (error.status === 401) {
							updateCloudStatus('🔐 נדרש חיבור מחדש', 'נותק');
							showToast('⚠️ החיבור לגוגל פג - הלקוח נשמר מקומית בלבד', 'warning');
							access_token = null;
							document.getElementById('saveBtn').disabled = true;
							document.getElementById('loadBtn').disabled = true;
						} else {
							updateCloudStatus('⚠️ שגיאה בשמירה', 'שגיאה');
							showToast('⚠️ הלקוח נשמר מקומית, אבל לא הצליח לשמור בענן', 'warning');
						}
					});
				} else {
					updateCloudStatus('🔐 שינויים לא נשמרו בענן', 'מקומי');
					showToast('🔐 לקוח נשמר מקומית - התחבר לענן לשמירה מלאה', 'warning');
				}
				
				// עדכן תצוגה
				loadLocationsTable();
				loadLocationsForSelect();
				closeAnyModal();
				
			} catch (error) {
				console.error('Error updating location:', error);
				updateCloudStatus('❌ שגיאה במערכת', 'שגיאה');
				showToast('שגיאה בעדכון הלקוח', 'error');
			}
		}

		// חישוב אוטומטי של תאריך טיפול הבא כשמשנים מרווח
		function updateNextVisitFromInterval() {
			const lastVisit = document.getElementById('editLocationLastVisit').value;
			const intervalWeeks = parseInt(document.getElementById('editLocationInterval').value) || 4;
			
			if (lastVisit) {
				const lastDate = new Date(lastVisit);
				const nextDate = new Date(lastDate);
				nextDate.setDate(lastDate.getDate() + (intervalWeeks * 7));
				
				document.getElementById('editLocationNextVisit').value = nextDate.toISOString().split('T')[0];
			}
		}


		// החלף את saveEditedReceipt בפונקציה זו:
		function saveEditedReceipt(receiptId) {
			console.log(`✅ saveEditedReceipt ('${receiptId}')`);
			const receiptIndex = receipts.findIndex(r => r.ID == receiptId);
			if (receiptIndex === -1) {
				showToast('קבלה לא נמצאה', 'error');
				return;
			}
			
			try {
				const locationId = document.getElementById('editReceiptLocation').value;
				const location = locations.find(g => g.ID == locationId);
				
				// עדכן את הקבלה במערך המקומי
				const updatedReceipt = {
					...receipts[receiptIndex], // שמור נתונים קיימים
					book_number: document.getElementById('editReceiptBook').value,
					receipt_number: document.getElementById('editReceiptNumber').value,
					date: document.getElementById('editReceiptDate').value,
					location_id: locationId,
					location_name: location ? location.name : '',
					amount: parseFloat(document.getElementById('editReceiptAmount').value) || 0,
					payment_type: document.getElementById('editReceiptPaymentType').value,
					notes: document.getElementById('editReceiptNotes').value
				};
				
				receipts[receiptIndex] = updatedReceipt;
				
				// שמור מקומית תמיד
				saveToLocalStorage();
				updateCloudStatus('💾 שומר קבלה...', 'מעדכן');
				
				// נסה לשמור בענן
				if (access_token && SPREADSHEET_ID) {
					updateReceiptInCloud(updatedReceipt).then(() => {
						updateCloudStatus('✅ מחובר ומסונכרן', 'נשמר');
						showToast('קבלה עודכנה בהצלחה במערכת ובענן!', 'success');
					}).catch(error => {
						if (error.status === 401) {
							updateCloudStatus('🔐 נדרש חיבור מחדש', 'נותק');
							showToast('⚠️ החיבור לגוגל פג - הקבלה נשמרה מקומית בלבד', 'warning');
							access_token = null;
						} else {
							updateCloudStatus('⚠️ שגיאה בשמירה', 'שגיאה');
							showToast('⚠️ הקבלה נשמרה מקומית, אבל לא הצליחה לשמור בענן', 'warning');
						}
					});
				} else {
					updateCloudStatus('🔐 שינויים לא נשמרו בענן', 'מקומי');
					showToast('🔐 קבלה נשמרה מקומית - התחבר לענן לשמירה מלאה', 'warning');
				}
				
				// עדכן תצוגה
				loadReceiptsTable();
				loadReceiptFilterOptions();
				closeAnyModal();
				
			} catch (error) {
				console.error('Error updating receipt:', error);
				updateCloudStatus('❌ שגיאה במערכת', 'שגיאה');
				showToast('שגיאה בעדכון הקבלה', 'error');
			}
		}

   
	   //////////>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	   
	   
	   function formatDateForSheets(dateString) {
			if (!dateString) return '';
			const date = new Date(dateString);
			const day = String(date.getDate()).padStart(2, '0');
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const year = date.getFullYear();
			return `${day}/${month}/${year}`;
		}
	   
	   
	   // פונקציה להמרת סטטוס תשלום לקידוד מספרי
		function mapPaymentStatus(value) {
			if (!value || value.trim() === '') return "0";
			const normalized = value.toString().toLowerCase().trim();
			
			// המרה פשוטה לפי הערכים שיכולים להגיע מהייבוא
			if (normalized === "כן" || normalized === "true" || normalized === "1") return "1";
			if (normalized === "ללא תשלום" || normalized === "ללא") return "2";
			if (normalized === "חלקי" || normalized === "שולם חלקית") return "3";  // ✅ הוסף את זה
			return "0"; // כל השאר = לא שולם
		}
   
	   
	   function parseAddressForImport(customerName) {
			if (!customerName) return { name: '', fullAddress: '', neighborhood: '', city: '' };
			
			const originalAddress = customerName.trim();
			const parts = originalAddress.split(' ');
			let city = '';
			
			if (parts.length >= 3) {
				// חיפוש מספר בית (מספר + אולי אות א/ב)
				let houseNumberIndex = -1;
				for (let i = 0; i < parts.length; i++) {
					if (/^\d+[א-ב]?$/.test(parts[i])) {
						houseNumberIndex = i;
						break; // לוקח את המספר הראשון שנמצא
					}
				}
				
				if (houseNumberIndex !== -1 && houseNumberIndex < parts.length - 1) {
					// יש מספר בית - כל מה שאחריו הוא עיר
					city = parts.slice(houseNumberIndex + 1).join(' ');
				} else {
					// אין מספר בית - כל הכתובת היא עיר
					city = originalAddress;
				}
			} else {
				// פחות מ-3 מילים - כל הכתובת היא עיר
				city = originalAddress;
			}
			
			// ✅ המרת הקיצור אחרי שקבענו את העיר
			if (city === 'ראשלצ') {
				city = 'ראשון לציון';
			}
			
			return {
				name: originalAddress, // השם המקורי ללא שינוי
				fullAddress: originalAddress,
				neighborhood: '', // ריק למילוי ידני
				city: city
			};
		}
		
		
		// פונקציה לעדכון תאריך טיפול הבא
		// עדכון תאריך טיפול הבא ללקוח
		function updateClientNextVisit(clientId, newDate) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לא נמצא לקוח', 'error');
				return;
			}
			
			// בדיקת תקינות התאריך
			if (!newDate || isNaN(new Date(newDate))) {
				showToast('תאריך לא תקין', 'error');
				return;
			}
			
			const oldDate = client.next_visit;
			client.next_visit = newDate;
			
			// איפוס הוספות זמניות
			if (client.temp_addition) {
				client.temp_addition = 0;
			}
			
			// שמירה מקומית
			saveToLocalStorage();
			
			// שמירה בענן אם מחובר
			if (access_token && SPREADSHEET_ID) {
				updateLocationInCloud(client).then(() => {
					console.log('✅ תאריך עודכן בענן');
				}).catch(error => {
					console.error('❌ שגיאה בעדכון ענן:', error);
					showToast('התאריך עודכן מקומית, אך לא בענן', 'warning');
				});
			}
			
			const formattedDate = formatDate(newDate);
			showToast(`תאריך הטיפול הבא עבור ${client.name} עודכן ל-${formattedDate}`, 'success');
			
			// רענון התצוגה
			setTimeout(() => {
				loadPlanningDataAdvanced();
			}, 300);
		}

		// פונקציה להפיכת לקוח לפעיל/לא פעיל
		function toggleClientActive(clientId, activeValue) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			client.active = activeValue;
			
			// שמירה
			saveToLocalStorage();
			
			// עדכון בענן אם מחובר
			if (access_token && SPREADSHEET_ID) {
				updateLocationInCloud(client);
			}
			
			const statusText = activeValue === "1" ? "פעיל" : "לא פעיל";
			showToast(`${client.name} הוגדר כ-${statusText}`, 'success');
			
			// רענון התצוגה (הלקוח ייעלם אם לא פעיל)
			loadPlanningDataAdvanced();
		}

		// פונקציה להצגת היסטוריית טיפולים
		function showClientHistory(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			// מציאת 3 הטיפולים האחרונים
			const clientVisits = visits
				.filter(visit => visit.location_id === clientId)
				.sort((a, b) => new Date(b.date) - new Date(a.date))
				.slice(0, 3);
			
			if (clientVisits.length === 0) {
				showToast(`${client.name} - אין עדיין היסטוריית טיפולים`, 'info');
				return;
			}
			
			// בניית תוכן החלונית
			let historyHtml = `
				<div style="background: white; padding: 20px; border-radius: 10px; max-width: 500px; max-height: 400px; overflow-y: auto;">
					<h3 style="margin-bottom: 15px; color: #333;">📋 היסטוריית טיפולים - ${client.name}</h3>
					<div style="margin-bottom: 20px; font-size: 12px; color: #666;">
						כתובת: ${client.full_address}
					</div>
					<div style="space-y: 10px;">
			`;
			
			clientVisits.forEach((visit, index) => {
				const visitDate = formatDate(visit.date);
				const amount = visit.amount || 0;
				const workDone = visit.work_done || 'טיפול';
				const paidInfo = parsePaidField(visit.paid);
				const paidStatus = paidInfo.text;
				let paidColor = '#dc3545'; // לא שולם
				if (paidInfo.status === '1') paidColor = '#28a745'; // שולם
				else if (paidInfo.status === '2') paidColor = '#6c757d'; // ללא תשלום
				else if (paidInfo.status === '3') paidColor = '#ffc107'; // חלקי
				
				historyHtml += `
					<div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 10px; background: ${index === 0 ? '#f8f9ff' : '#fafafa'};">
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
							<strong style="color: #2c3e50;">📅 ${visitDate}</strong>
							<span style="font-weight: bold; color: ${paidColor};">${paidStatus}</span>
						</div>
						<div style="margin-bottom: 5px; color: #666;">
							🛠️ עבודה: ${workDone}
						</div>
						<div style="display: flex; justify-content: space-between; font-size: 14px;">
							<span>💰 ₪${amount}</span>
							${visit.duration_minutes ? `<span>⏱️ ${visit.duration_minutes} דק'</span>` : ''}
						</div>
						${visit.notes ? `<div style="margin-top: 8px; font-size: 12px; color: #666; font-style: italic;">📝 ${visit.notes}</div>` : ''}
					</div>
				`;
			});
			
			historyHtml += `
					</div>
					<div style="text-align: center; margin-top: 20px;">
						<button onclick="closeAnyModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
							סגור
						</button>
					</div>
				</div>
			`;
			
			// הצגת החלונית
			showModal(historyHtml);
		}
		
	   
	   // פונקציה לעדכון לקוח ספציפי בענן
		async function updateLocationInCloud(client) {
			if (!await validateToken()) return;
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Locations!A:A'
				});
				
				const rows = response.result.values || [];
				const rowIndex = rows.findIndex(row => row[0] === client.ID);
				
				if (rowIndex > 0) {
					const rowNumber = rowIndex + 1;
					const clientRow = [
						client.ID, client.name, client.full_address, client.neighborhood, client.city,
						client.contact_person, client.phone, client.allowed_day, client.interval_weeks,
						client.temp_addition || 0, // ✅ הוסף בדיקה
						client.base_amount, client.active, client.notes,
						client.last_visit, client.next_visit, client.client_requests || ''
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: `Locations!A${rowNumber}:P${rowNumber}`,
						valueInputOption: 'USER_ENTERED',
						resource: { values: [clientRow] }
					});
					
					console.log('✅ Successfully updated client in cloud'); // לוג להצלחה
				} else {
					throw new Error(`Client with ID ${client.ID} not found in spreadsheet`);
				}
			} catch (error) {
				console.error('Error updating client in cloud:', error);
				throw error; // ✅ חשוב - העבר את השגיאה הלאה
			}
		}
	   
	   
	   // ===== פונקציות פענוח הכנסות מטלגרם =====

		// המרת תאריך מפורמט טלגרם ל-ISO
		function parseTelegramDateToISO(dateStr) {
			const months = {
				'January': '01', 'February': '02', 'March': '03', 'April': '04',
				'May': '05', 'June': '06', 'July': '07', 'August': '08',
				'September': '09', 'October': '10', 'November': '11', 'December': '12'
			};
			
			const parts = dateStr.split(' ');
			if (parts.length === 3) {
				const day = parts[0].padStart(2, '0');
				const month = months[parts[1]] || '01';
				const year = parts[2];
				return `${year}-${month}-${day}`;
			}
			return dateStr;
		}

		// פענוח שורת הכנסה בודדת
		function parseIncomeLineFromTelegram(line, date, time) {
			try {
				// חילוץ כתובת לקוח
				let clientAddress = '';
				const dotIndex = line.indexOf('.');
				if (dotIndex > 0) {
					clientAddress = line.substring(0, dotIndex).trim();
				} else {
					const beforeReceived = line.split('קיבלתי')[0].trim();
					clientAddress = beforeReceived.replace(/[.,]$/, '');
				}

				// חילוץ סכום - גרסה משופרת
				let amount = 0;
				const amountPatterns = [
					/קיבלתי\s+תשלום\s+(\d+)/,     
					/קיבלתי\s+(\d+)/,              
					/קיבלתי\s+צ'ק\s+(\d+)/,        
					/קיבלתי\s+עוד\s+(\d+)/,        
					/(\d+)\s+מזומן/,               
					/(\d+)\s+ביט/,                 
					/(\d+)\s+העברה/,               
					/(\d+)\s+פייבוקס/,
					/(\d+)\s+צ'ק/
				];
				
				for (const pattern of amountPatterns) {
					const match = line.match(pattern);
					if (match) {
						amount = parseInt(match[1]);
						break;
					}
				}
				
				// אם עדיין לא מצאנו, חפש מספרים גדולים
				if (amount === 0) {
					const allNumbers = line.match(/\d+/g);
					if (allNumbers && allNumbers.length > 0) {
						const numbers = allNumbers.map(n => parseInt(n)).filter(n => n >= 50);
						if (numbers.length > 0) {
							amount = Math.max(...numbers);
						}
					}
				}

				// זיהוי אמצעי תשלום - עם תיקון "לא צוין" = מזומן
				let paymentMethod = 'מזומן'; // ברירת מחדל במקום "לא צוין"
				if (line.includes('העברה לחשבון') || line.includes('העברה')) {
					paymentMethod = 'העברה בנקאית';
				} else if (line.includes('צ\'ק')) {
					paymentMethod = 'צ\'ק';
				} else if (line.includes('ביט')) {
					paymentMethod = 'ביט';
				} else if (line.includes('מזומן')) {
					paymentMethod = 'מזומן';
				} else if (line.includes('פייבוקס')) {
					paymentMethod = 'פייבוקס';
				}

				// חילוץ הערות
				let notes = '';
				if (line.includes('עבור')) {
					const match = line.match(/עבור[^.]+/);
					if (match) notes += match[0] + ' ';
				}
				if (line.includes('שכחתי') || line.includes('לא רשמתי') || line.includes('לא עדכנתי')) {
					notes += 'לא תועד מיד ';
				}
				if (line.includes('על החשבון') || line.includes('חוב')) {
					notes += 'תשלום על חשבון ';
				}

				return {
					date: date,
					time: time,
					client_address: clientAddress,
					amount: amount,
					payment_method: paymentMethod,
					notes: notes.trim(),
					raw_text: line
				};
			} catch (error) {
				console.error('שגיאה בפענוח שורת הכנסה:', line, error);
				return null;
			}
		}

		// פענוח מלא של נתוני הכנסות מטלגרם
		function parseIncomesFromTelegramText(telegramText) {
			const lines = telegramText.split('\n').map(line => line.replace(/\r$/, '').trim());
			const incomes = [];
			let currentDate = '';
			let currentTime = '';
			
			for (let i = 0; i < lines.length; i++) {
				const line = lines[i];
				
				// זיהוי תאריך (15 August 2024)
				if (/^\d{1,2} \w+ \d{4}$/.test(line)) {
					currentDate = parseTelegramDateToISO(line);
					continue;
				}
				
				// זיהוי שעה (20:04)
				if (/^\d{1,2}:\d{2}$/.test(line)) {
					currentTime = line;
					continue;
				}
				
				// זיהוי הודעת הכנסה (מכילה "קיבלתי" ומספר)
				if (line.includes('קיבלתי') && /\d+/.test(line)) {
					const income = parseIncomeLineFromTelegram(line, currentDate, currentTime);
					if (income && income.amount > 0) {
						incomes.push(income);
					}
				}
			}
			
			return incomes;
		}


		// ===== פונקציות אישור ייבוא הכנסות =====

		// ===== פונקציות וידוא קיום גיליונות נדרשים =====

		// וידוא קיום גיליון הכנסות במערכת הראשית
		async function ensureIncomesSheetExists() {
			if (!await validateToken()) return false;
			
			try {
				const response = await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				
				const existingSheets = response.result.sheets.map(sheet => sheet.properties.title);
				
				if (!existingSheets.includes('Incomes')) {
					console.log('יוצר גיליון הכנסות...');
					
					await gapi.client.sheets.spreadsheets.batchUpdate({
						spreadsheetId: SPREADSHEET_ID,
						resource: {
							requests: [{
								addSheet: {
									properties: {
										title: 'Incomes',
										gridProperties: {
											rowCount: 1000,
											columnCount: 12
										}
									}
								}
							}]
						}
					});
					
					// הוספת כותרות
					const headers = [
						'ID', 'תאריך', 'שעה', 'כתובת_לקוח', 'מזהה_לקוח', 
						'סכום', 'אמצעי_תשלום', 'הערות', 'טקסט_מקורי', 
						'מקור_ייבוא', 'תאריך_ייבוא', 'סטטוס'
					];
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: 'Incomes!A1:L1',
						valueInputOption: 'RAW',
						resource: { values: [headers] }
					});
					
					console.log('✅ גיליון הכנסות נוצר');
				}
				
				return true;
				
			} catch (error) {
				console.error('שגיאה בוידוא גיליון הכנסות:', error);
				return false;
			}
		}

		
		// הוספת כפתור העלאה לממשק (להוסיף למקום המתאים בממשק)
		function addTelegramIncomeUploadButton() {
			const uploadHTML = `
				<div class="upload-section" style="margin: 20px 0; padding: 20px; border: 2px dashed #3498db; border-radius: 10px; text-align: center;">
					<h3 style="color: #3498db; margin-bottom: 15px;">📤 ייבוא הכנסות מטלגרם</h3>
					<p style="color: #666; margin-bottom: 20px;">בחר קובץ טקסט עם ייצוא הכנסות מטלגרם</p>
					<input type="file" id="telegramIncomeFile" accept=".txt,.json" style="display: none;" onchange="handleTelegramIncomeFileUpload(event)">
					<button class="btn btn-primary" onclick="document.getElementById('telegramIncomeFile').click()" style="padding: 12px 25px; font-size: 16px;">
						📁 בחר קובץ הכנסות מטלגרם
					</button>
				</div>
			`;
			
			return uploadHTML;
		}


		// ===== פונקציות עזר נוספות למערכת הכנסות =====

		// יצירת פונקציה לטעינת רשימת הכנסות (אם לא קיימת)
		function loadIncomesTable() {
			if (typeof incomes === 'undefined' || !incomes.length) {
				console.log('📊 אין הכנסות להצגה');
				return;
			}
			
			console.log(`📊 טוען ${incomes.length} הכנסות לתצוגה`);
			// כאן תוסיף את הלוגיקה להצגת הכנסות בממשק בעתיד
		}

		// אתחול מערך הכנסות אם לא קיים
		if (typeof incomes === 'undefined') {
			window.incomes = [];
		}

	
		// ===== פונקציות יצירת גיליונות נוספים במערכת =====

		// יצירת גיליון הכנסות בקובץ הראשי
		async function createIncomesSheet() {
			if (!await validateToken()) {
				showToast('התחבר לגוגל קודם', 'warning');
				return false;
			}
			
			try {
				showLoading('יוצר גיליון הכנסות...');
				
				// בדיקה אם הגיליון כבר קיים
				const sheetsResponse = await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID
				});
				
				const existingSheet = sheetsResponse.result.sheets.find(sheet => 
					sheet.properties.title === 'Incomes'
				);
				
				if (existingSheet) {
					hideLoading();
					showToast('גיליון הכנסות כבר קיים', 'info');
					return true;
				}
				
				// יצירת הגיליון החדש
				await gapi.client.sheets.spreadsheets.batchUpdate({
					spreadsheetId: SPREADSHEET_ID,
					resource: {
						requests: [{
							addSheet: {
								properties: {
									title: 'Incomes',
									gridProperties: {
										rowCount: 1000,
										columnCount: 10
									}
								}
							}
						}]
					}
				});
				
				// הוספת כותרות
				const headers = [
					'ID', 'תאריך', 'שעה', 'כתובת_לקוח', 'מזהה_לקוח', 
					'סכום', 'אמצעי_תשלום', 'הערות', 'טקסט_מקורי', 'מקור_ייבוא'
				];
				
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Incomes!A1:J1',
					valueInputOption: 'RAW',
					resource: { values: [headers] }
				});
				
				hideLoading();
				showToast('✅ גיליון הכנסות נוצר בהצלחה!', 'success');
				return true;
				
			} catch (error) {
				console.error('שגיאה ביצירת גיליון הכנסות:', error);
				hideLoading();
				showToast('שגיאה ביצירת גיליון הכנסות', 'error');
				return false;
			}
		}

		

		// ===== פונקציות שמירה לטבלאות החדשות =====



		// טעינת הכנסות מטלגרם מהעלנן
		async function loadTelegramIncomesFromCloud() {
			if (!access_token || !SPREADSHEET_ID) {
				return [];
			}
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'TelegramIncomes!A2:L1000'
				});
				
				if (!response.result.values) {
					return [];
				}
				
				return response.result.values.map(row => ({
					ID: row[0] || '',
					date: row[1] || '',
					time: row[2] || '',
					client_address: row[3] || '',
					amount: parseFloat(row[4]) || 0,
					payment_method: row[5] || '',
					notes: row[6] || '',
					raw_text: row[7] || '',
					matched_to_visit: row[8] === 'true' || row[8] === true,
					visit_ids: row[9] ? row[9].split(',') : [],
					processed: row[10] === 'true' || row[10] === true,
					created_at: row[11] || ''
				}));
				
			} catch (error) {
				console.error('שגיאה בטעינת הכנסות מטלגרם:', error);
				return [];
			}
		}

		// ===== פונקציות לוגיקת תשלומים חדשה =====

		// בדיקת סטטוס תשלום של ביקור
		function getVisitPaymentStatus(visitId) {
			const visit = visits.find(v => v.ID === visitId);
			if (!visit) return 'unpaid';
			
			// ✅ UPDATED: Use the new parser
			const paidInfo = parsePaidField(visit.paid);
			return paidInfo.status;
		}


		// ✅ Parse the paid field to get detailed payment info
		function parsePaidField(paidValue) {
			// טיפול בערך ריק
			if (!paidValue || paidValue === '0') {
				return { status: '0', text: 'לא שולם', date: null, amount: 0 };
			}
			
			// שולם מלא
			if (paidValue === '1') {
				return { status: '1', text: 'שולם', date: null, amount: null };
			}
			
			// ללא תשלום
			if (paidValue === '2') {
				return { status: '2', text: 'ללא תשלום', date: null, amount: 0 };
			}
			
			// שולם חלקית
			if (paidValue === '3') {
				return { status: '3', text: 'שולם חלקית', date: null, amount: 0 };
			}
			
			// Default fallback
			return { status: '0', text: 'לא שולם', date: null, amount: 0 };
		}

		


		// טקסט סטטוס תשלום מעודכן
		function getPaymentStatusText(status) {
						
			switch (status) {
				case '1': return 'שולם';
				case '0': return 'לא שולם';
				case '2': return 'ללא תשלום';
				case '3': return 'שולם חלקית';
				default: return 'לא ידוע';
			}
		}

		// חישוב סכום שולם עבור ביקור
		function getVisitPaidAmount(visitId) {
			const visit = visits.find(v => v.ID === visitId);
			if (!visit) return 0;
			
			// שיטה 1: חישוב מתוך PaymentVisitLinks (המדויק ביותר)
			const relatedLinks = paymentVisitLinks.filter(link => link.visit_id === visitId);
			if (relatedLinks.length > 0) {
				// יש קישורי תשלום - חשב לפי הקישורים
				const totalFromLinks = relatedLinks.reduce((sum, link) => sum + (parseFloat(link.amount_allocated) || 0), 0);
				return totalFromLinks;
			}
			
			// שיטה 2: חישוב מתוך visit.paid
			const paidInfo = parsePaidField(visit.paid);
			const visitAmount = parseFloat(visit.amount) || 0;
			
			if (paidInfo.status === '1') {
				// שולם מלא - החזר סכום מלא
				return visitAmount;
			}
			
			if (paidInfo.status === '3') {
				// שולם חלקית - החזר הסכום החלקי
				return paidInfo.amount;
			}
			
			if (paidInfo.status === '2') {
				// ללא תשלום - החזר סכום מלא (אין חוב)
				return visitAmount;
			}
			
			// לא שולם (status '0') - החזר 0
			return 0;
		}

		// ===== פונקציות טיפול בתשלומים ===== 

		// ===== AUTO-LINK PAYMENTS TO VISITS SYSTEM =====

		// Get all unlinked payments (payments without any links or with available amount)
		function getUnlinkedPayments() {
			const unlinkedPayments = [];
			
			for (const payment of payments) {
				// Skip if no client_id (can't match without client)
				if (!payment.client_id) {
					continue;
				}
				
				// Get payment link status
				const linkStatus = getPaymentLinkStatus(payment.ID);
				
				// Include if: (1) no links at all, or (2) has available amount
				if (linkStatus.linksCount === 0 || linkStatus.available > 0.01) {
					unlinkedPayments.push({
						payment: payment,
						availableAmount: linkStatus.linksCount === 0 ? payment.amount : linkStatus.available
					});
				}
			}
			
			console.log(`🔍 Found ${unlinkedPayments.length} unlinked/partially-linked payments`);
			return unlinkedPayments;
		}

		// Get all unpaid visits (visits with debt)
		function getUnpaidVisits() {
			const unpaidVisits = [];
			
			for (const visit of visits) {
				const paidInfo = parsePaidField(visit.paid);
				
				// Skip "no payment required" status
				if (paidInfo.status === '2') {
					continue;
				}
				
				const visitAmount = parseFloat(visit.amount) || 0;
				const paidAmount = getVisitPaidAmount(visit.ID);
				const debt = visitAmount - paidAmount;
				
				// Include if has debt OR zero amount (needs pricing)
				if (debt > 0.01 || visitAmount === 0) {
					unpaidVisits.push({
						visit: visit,
						debtAmount: debt,
						paidAmount: paidAmount
					});
				}
			}
			
			console.log(`🔍 Found ${unpaidVisits.length} unpaid visits (including zero-amount)`);
			return unpaidVisits;
		}

		// Calculate match confidence level
		function calculateMatchConfidence(payment, visit, amountToAllocate) {
			let confidence = 1; // Default: ⭐ (low)
			
			const paymentAmount = parseFloat(payment.amount);
			const visitAmount = parseFloat(visit.amount);
			const paymentDate = payment.date;
			const visitDate = visit.date;
			
			// Perfect match: same date + same amount
			if (paymentDate && visitDate === paymentDate && 
				Math.abs(paymentAmount - visitAmount) < 0.01) {
				return 3; // ⭐⭐⭐ (perfect)
			}
			
			// Very good match: similar amount (±5%)
			const amountDiff = Math.abs(paymentAmount - visitAmount) / paymentAmount;
			if (amountDiff < 0.05) {
				confidence = 3; // ⭐⭐⭐ (very good)
			}
			// Good match: exact allocation amount
			else if (Math.abs(amountToAllocate - visitAmount) < 0.01) {
				confidence = 2; // ⭐⭐ (good)
			}
			
			// Bonus: payment date is after visit date (makes sense)
			if (paymentDate && visitDate && paymentDate >= visitDate) {
				// Don't reduce confidence
			} else if (paymentDate && visitDate && paymentDate < visitDate) {
				// Payment before visit - reduce confidence
				confidence = Math.max(1, confidence - 1);
			}
			
			return confidence;
		}

		// Get confidence display
		function getConfidenceDisplay(confidenceLevel) {
			switch (confidenceLevel) {
				case 3:
					return { stars: '⭐⭐⭐', text: 'גבוהה', color: '#27ae60' };
				case 2:
					return { stars: '⭐⭐', text: 'בינונית', color: '#f39c12' };
				case 1:
				default:
					return { stars: '⭐', text: 'נמוכה', color: '#95a5a6' };
			}
		}


		// Find matches for a single payment
		function findPaymentMatches(paymentInfo) {
			const payment = paymentInfo.payment;
			const availableAmount = paymentInfo.availableAmount;
			
			// Get all unpaid visits for this client
			const unpaidVisits = getUnpaidVisits();
			const clientVisits = unpaidVisits.filter(vInfo => 
				vInfo.visit.location_id === payment.client_id
			);
			
			if (clientVisits.length === 0) {
				return null; // No matches possible
			}
			
			// Filter by date if payment has a date
			let eligibleVisits = clientVisits;
			if (payment.date) {
				// Only visits on or before payment date
				eligibleVisits = clientVisits.filter(vInfo => 
					vInfo.visit.date <= payment.date
				);
				
				// If no visits before payment date, use all visits (fallback)
				if (eligibleVisits.length === 0) {
					eligibleVisits = clientVisits;
				}
			}
			
			// Sort by date (oldest first)
			eligibleVisits.sort((a, b) => {
				const dateA = new Date(a.visit.date);
				const dateB = new Date(b.visit.date);
				return dateA - dateB;
			});
			
			// Allocate payment to visits
			let remainingAmount = availableAmount;
			const visitMatches = [];
			
			for (const vInfo of eligibleVisits) {
				if (remainingAmount <= 0.01) break;
				
				const amountToAllocate = Math.min(remainingAmount, vInfo.debtAmount);
				
				// Calculate confidence
				const confidence = calculateMatchConfidence(
					payment, 
					vInfo.visit, 
					amountToAllocate
				);
				
				visitMatches.push({
					visit_id: vInfo.visit.ID,
					visit_date: vInfo.visit.date,
					visit_amount: vInfo.visit.amount,
					visit_work: vInfo.visit.work_done || 'ללא תיאור',
					debt_amount: vInfo.debtAmount,
					amount_to_allocate: amountToAllocate,
					confidence: confidence
				});
				
				remainingAmount -= amountToAllocate;
			}
			
			if (visitMatches.length === 0) {
				return null;
			}
			
			// Overall confidence is the highest confidence among matches
			const maxConfidence = Math.max(...visitMatches.map(m => m.confidence));
			
			return {
				payment: payment,
				payment_id: payment.ID,
				payment_date: payment.date,
				payment_amount: payment.amount,
				available_amount: availableAmount,
				client_name: payment.client_name || 'לא ידוע',
				matches: visitMatches,
				total_allocated: visitMatches.reduce((sum, m) => sum + m.amount_to_allocate, 0),
				remaining: remainingAmount,
				overall_confidence: maxConfidence
			};
		}

		// Main function: find all matches
		function findAllMatches() {
			console.log('🔗 Starting auto-match process...');
			
			const unlinkedPayments = getUnlinkedPayments();
			
			if (unlinkedPayments.length === 0) {
				showToast('אין תשלומים לא מקושרים', 'info');
				return [];
			}
			
			// ✅ Get unpaid visits ONCE - not for every payment!
			const allUnpaidVisits = getUnpaidVisits();
			console.log(`📋 Processing ${unlinkedPayments.length} payments against ${allUnpaidVisits.length} unpaid visits`);
			
			const allMatches = [];
			
			for (const paymentInfo of unlinkedPayments) {
				const match = findPaymentMatchesOptimized(paymentInfo, allUnpaidVisits);
				if (match) {
					allMatches.push(match);
				}
			}
			
			console.log(`✅ Found ${allMatches.length} possible matches`);
			return allMatches;
		}


		// Find matches for a single payment - OPTIMIZED VERSION
		function findPaymentMatchesOptimized(paymentInfo, allUnpaidVisits) {
			const payment = paymentInfo.payment;
			const availableAmount = paymentInfo.availableAmount;
			
			// Filter to this client only
			const clientVisits = allUnpaidVisits.filter(vInfo => 
				vInfo.visit.location_id === payment.client_id
			);
			
			if (clientVisits.length === 0) {
				return null; // No matches possible
			}
			
			// Filter by date if payment has a date
			let eligibleVisits = clientVisits;
			if (payment.date) {
				// Only visits on or before payment date
				eligibleVisits = clientVisits.filter(vInfo => 
					vInfo.visit.date <= payment.date
				);
				
				// If no visits before payment date, use all visits (fallback)
				if (eligibleVisits.length === 0) {
					eligibleVisits = clientVisits;
				}
			}
			
			// Sort by date (oldest first)
			eligibleVisits.sort((a, b) => {
				const dateA = new Date(a.visit.date);
				const dateB = new Date(b.visit.date);
				return dateA - dateB;
			});
			
			// Allocate payment to visits
			let remainingAmount = availableAmount;
			const visitMatches = [];
			
			for (const vInfo of eligibleVisits) {
				if (remainingAmount <= 0.01) break;
				
				const amountToAllocate = Math.min(remainingAmount, vInfo.debtAmount);
				
				// Calculate confidence
				const confidence = calculateMatchConfidence(
					payment, 
					vInfo.visit, 
					amountToAllocate
				);
				
				visitMatches.push({
					visit_id: vInfo.visit.ID,
					visit_date: vInfo.visit.date,
					visit_amount: vInfo.visit.amount,
					visit_work: vInfo.visit.work_done || 'ללא תיאור',
					debt_amount: vInfo.debtAmount,
					amount_to_allocate: amountToAllocate,
					confidence: confidence
				});
				
				remainingAmount -= amountToAllocate;
			}
			
			if (visitMatches.length === 0) {
				return null;
			}
			
			// Overall confidence is the highest confidence among matches
			const maxConfidence = Math.max(...visitMatches.map(m => m.confidence));
			
			return {
				payment: payment,
				payment_id: payment.ID,
				payment_date: payment.date,
				payment_amount: payment.amount,
				available_amount: availableAmount,
				client_name: payment.client_name || 'לא ידוע',
				matches: visitMatches,
				total_allocated: visitMatches.reduce((sum, m) => sum + m.amount_to_allocate, 0),
				remaining: remainingAmount,
				overall_confidence: maxConfidence
			};
		}

		// Show matches modal to user
		function showMatchesModal(matches) {
			if (matches.length === 0) {
				showToast('לא נמצאו התאמות אפשריות', 'info');
				return;
			}
			
			// Group by confidence
			const highConfidence = matches.filter(m => m.overall_confidence === 3);
			const mediumConfidence = matches.filter(m => m.overall_confidence === 2);
			const lowConfidence = matches.filter(m => m.overall_confidence === 1);
			
			const modalHTML = `
				<div style="background: white; padding: 30px; border-radius: 12px; max-width: 800px; width: 90vw; max-height: 85vh; overflow-y: auto; direction: rtl;">
					<div style="position: relative;">
						<button onclick="closeAnyModal()" style="position: absolute; top: 0; left: 0; background: #e74c3c; border: none; color: white; font-size: 20px; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">×</button>
						<h3 style="margin-bottom: 25px; color: #2c3e50; border-bottom: 3px solid #9b59b6; padding-bottom: 15px; font-size: 24px;">
							🔗 קישור אוטומטי תשלומים-טיפולים
						</h3>
					</div>
					
					<!-- Summary Stats -->
					<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 25px; color: white;">
						<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
							<div>
								<div style="font-size: 28px; font-weight: bold;">${matches.length}</div>
								<div style="font-size: 13px; opacity: 0.9;">התאמות נמצאו</div>
							</div>
							<div>
								<div style="font-size: 28px; font-weight: bold;">${highConfidence.length}</div>
								<div style="font-size: 13px; opacity: 0.9;">ביטחון גבוה</div>
							</div>
							<div>
								<div style="font-size: 28px; font-weight: bold;">${mediumConfidence.length + lowConfidence.length}</div>
								<div style="font-size: 13px; opacity: 0.9;">דורש סקירה</div>
							</div>
						</div>
					</div>
					
					<!-- High Confidence Section -->
					${highConfidence.length > 0 ? `
						<div style="margin-bottom: 30px;">
							<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px; background: #d4edda; border-radius: 8px; border-right: 4px solid #27ae60;">
								<div>
									<span style="font-size: 18px; font-weight: bold; color: #27ae60;">⭐⭐⭐ ביטחון גבוה</span>
									<span style="font-size: 14px; color: #666; margin-right: 10px;">(${highConfidence.length} התאמות)</span>
								</div>
								<button onclick="approveAllHighConfidence()" class="btn" style="background: #27ae60; color: white; padding: 10px 20px; font-size: 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
									⚡ אשר את כל הבטוחות
								</button>
							</div>
							<div id="highConfidenceMatches" style="max-height: 300px; overflow-y: auto;">
								${renderMatchesList(highConfidence, 'high')}
							</div>
						</div>
					` : ''}
					
					<!-- Medium/Low Confidence Section -->
					${(mediumConfidence.length + lowConfidence.length) > 0 ? `
						<div style="margin-bottom: 20px;">
							<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px; background: #fff3cd; border-radius: 8px; border-right: 4px solid #f39c12;">
								<div>
									<span style="font-size: 18px; font-weight: bold; color: #f39c12;">⭐⭐ / ⭐ דורש סקירה</span>
									<span style="font-size: 14px; color: #666; margin-right: 10px;">(${mediumConfidence.length + lowConfidence.length} התאמות)</span>
								</div>
								<button onclick="reviewMatchesOneByOne()" class="btn" style="background: #f39c12; color: white; padding: 10px 20px; font-size: 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
									👁️ סקור אחת-אחת
								</button>
							</div>
							<div id="mediumLowConfidenceMatches" style="max-height: 300px; overflow-y: auto;">
								${renderMatchesList([...mediumConfidence, ...lowConfidence], 'medium-low')}
							</div>
						</div>
					` : ''}
					
					<!-- Action Buttons -->
					<div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e9ecef;">
						<button onclick="closeAnyModal()" class="btn" style="background: #95a5a6; color: white; padding: 12px 30px; font-size: 15px; border: none; border-radius: 8px; cursor: pointer;">
							❌ ביטול
						</button>
					</div>
				</div>
			`;
			
			const modalContainer = document.getElementById('modalContainer');
			modalContainer.innerHTML = modalHTML;
			modalContainer.style.display = 'flex';
			window.scrollTo({ top: 0, behavior: 'smooth' });
			
			// Store matches globally for later use
			window.currentMatches = matches;
			window.currentMatchIndex = 0;
		}

		// Safe date formatting - handles invalid dates
		function formatDateSafe(dateStr) {
			if (!dateStr || dateStr === '' || dateStr === 'undefined') {
				return 'ללא תאריך';
			}
			
			try {
				// Try to parse the date
				const date = new Date(dateStr);
				
				// Check if valid date
				if (isNaN(date.getTime())) {
					return 'תאריך לא תקין';
				}
				
				const day = String(date.getDate()).padStart(2, '0');
				const month = String(date.getMonth() + 1).padStart(2, '0');
				const year = date.getFullYear();
				
				return `${day}.${month}.${year}`;
			} catch (error) {
				console.error('Error formatting date:', dateStr, error);
				return 'תאריך לא תקין';
			}
		}


		// Render matches list
		function renderMatchesList(matches, type) {
			return matches.map((match, index) => {
				const confDisplay = getConfidenceDisplay(match.overall_confidence);
				const matchId = `${type}-${index}`;
				
				return `
					<div id="match-${matchId}" style="background: white; border: 2px solid ${confDisplay.color}; border-radius: 8px; padding: 15px; margin-bottom: 12px;">
						<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
							<div style="flex: 1;">
								<div style="font-size: 16px; font-weight: bold; color: #2c3e50; margin-bottom: 5px;">
									💰 ${match.client_name}
								</div>
								<div style="font-size: 13px; color: #666;">
									תשלום: ${formatDateSafe(match.payment_date)} | ₪${Math.round(match.payment_amount).toLocaleString()}
								</div>
							</div>
							<div style="text-align: left;">
								<div style="display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; background: ${confDisplay.color}; color: white; border-radius: 20px; font-size: 12px; font-weight: bold;">
									${confDisplay.stars} ${confDisplay.text}
								</div>
							</div>
						</div>
						
						<div style="background: #f8f9fa; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
							<div style="font-size: 12px; font-weight: bold; color: #495057; margin-bottom: 8px;">
								📋 יקושר ל-${match.matches.length} טיפולים:
							</div>
							${match.matches.map(m => `
								<div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #e9ecef; font-size: 12px;">
									<div style="color: #666;">
										${formatDateSafe(m.visit_date)} - ${m.visit_work}
									</div>
									<div style="color: #27ae60; font-weight: bold;">
										₪${Math.round(m.amount_to_allocate).toLocaleString()}
									</div>
								</div>
							`).join('')}
							<div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 2px solid #dee2e6; font-weight: bold;">
								<span>סה"כ לקישור:</span>
								<span style="color: #27ae60;">₪${Math.round(match.total_allocated).toLocaleString()}</span>
							</div>
							${match.remaining > 0.01 ? `
								<div style="display: flex; justify-content: space-between; margin-top: 5px; color: #f39c12;">
									<span>ישאר לא מקושר:</span>
									<span style="font-weight: bold;">₪${Math.round(match.remaining).toLocaleString()}</span>
								</div>
							` : ''}
						</div>
						
						${type === 'medium-low' ? `
							<div style="display: flex; gap: 10px;">
								<button onclick="approveMatch('${matchId}')" class="btn" style="flex: 1; background: #27ae60; color: white; padding: 8px; font-size: 13px; border: none; border-radius: 6px; cursor: pointer;">
									✅ אשר
								</button>
								<button onclick="skipMatch('${matchId}')" class="btn" style="flex: 1; background: #95a5a6; color: white; padding: 8px; font-size: 13px; border: none; border-radius: 6px; cursor: pointer;">
									⏭️ דלג
								</button>
							</div>
						` : ''}
					</div>
				`;
			}).join('');
		}


		// Execute a single match (create links)
		async function executeMatch(match) {
			const newLinks = [];
			
			for (const visitMatch of match.matches) {
				const link = {
					ID: generateID(),
					payment_id: match.payment_id,
					visit_id: visitMatch.visit_id,
					amount_allocated: visitMatch.amount_to_allocate,
					link_type: 'auto_linked',
					created_at: new Date().toISOString()
				};
				
				newLinks.push(link);
				paymentVisitLinks.push(link);
			}
			
			// Update visits paid status
			for (const visitMatch of match.matches) {
				const visit = visits.find(v => v.ID === visitMatch.visit_id);
				if (visit) {
					const newPaidAmount = getVisitPaidAmount(visitMatch.visit_id);
					const visitAmount = parseFloat(visit.amount);
					
					// Update paid status
					if (newPaidAmount >= visitAmount - 0.01) {
						visit.paid = '1'; // Fully paid
					} else if (newPaidAmount > 0) {
						visit.paid = '3'; // Partially paid
					}
				}
			}
			
			console.log(`✅ Created ${newLinks.length} links for payment ${match.payment_id}`);
			return newLinks;
		}

		// Execute multiple matches
		async function executeMatches(matchesToExecute) {
			if (matchesToExecute.length === 0) {
				showToast('אין התאמות לביצוע', 'info');
				return;
			}
			
			showLoading(`מקשר ${matchesToExecute.length} תשלומים...`);
			
			try {
				let totalLinks = 0;
				
				// Execute all matches
				for (const match of matchesToExecute) {
					const links = await executeMatch(match);
					totalLinks += links.length;
				}
				
				// Save to localStorage
				saveToLocalStorage();
				
				// Save to cloud
				if (access_token && SPREADSHEET_ID) {
					console.log('💾 Saving links to cloud...');
					await savePaymentVisitLinksBatch(paymentVisitLinks);
					await saveVisitsBatch(visits);
				}
				
				hideLoading();
				
				showToast(`✅ הושלם בהצלחה!
				
		🔗 ${totalLinks} קישורים נוצרו
		💰 ${matchesToExecute.length} תשלומים קושרו
		📋 טיפולים עודכנו`, 'success', 5000);
				
				// Refresh displays
				if (typeof applyPaymentFilters === 'function') {
					applyPaymentFilters();
				}
				if (typeof applyVisitFilters === 'function') {
					applyVisitFilters();
				}
				if (typeof displayDebts === 'function') {
					displayDebts();
				}
				
				// Close modal
				closeAnyModal();
				
			} catch (error) {
				hideLoading();
				console.error('Error executing matches:', error);
				showToast('שגיאה בביצוע קישורים', 'error');
			}
		}

		// Approve all high confidence matches
		async function approveAllHighConfidence() {
			const highConfidenceMatches = window.currentMatches.filter(m => m.overall_confidence === 3);
			
			if (highConfidenceMatches.length === 0) {
				showToast('אין התאמות בביטחון גבוה', 'info');
				return;
			}
			
			const confirmMsg = `לאשר ${highConfidenceMatches.length} התאמות בביטחון גבוה?
			
		זה יקשר אוטומטית תשלומים לטיפולים.`;
			
			if (confirm(confirmMsg)) {
				await executeMatches(highConfidenceMatches);
			}
		}

		// Approve single match
		async function approveMatch(matchId) {
			const [type, index] = matchId.split('-');
			const matchIndex = parseInt(index);
			
			let match;
			if (type === 'medium-low') {
				const mediumLow = window.currentMatches.filter(m => m.overall_confidence <= 2);
				match = mediumLow[matchIndex];
			}
			
			if (!match) {
				showToast('התאמה לא נמצאה', 'error');
				return;
			}
			
			// Hide the match card
			const matchElement = document.getElementById(`match-${matchId}`);
			if (matchElement) {
				matchElement.style.opacity = '0.5';
				matchElement.style.pointerEvents = 'none';
			}
			
			await executeMatches([match]);
		}

		// Skip single match
		function skipMatch(matchId) {
			const matchElement = document.getElementById(`match-${matchId}`);
			if (matchElement) {
				matchElement.style.display = 'none';
			}
			
			showToast('התאמה דולגה', 'info', 1500);
		}

		// Review matches one by one (simple version)
		function reviewMatchesOneByOne() {
			showToast('גלול למטה לסקור כל התאמה ולאשר/לדלג', 'info', 3000);
			
			// Scroll to first match
			const firstMatch = document.querySelector('[id^="match-medium-low-"]');
			if (firstMatch) {
				firstMatch.scrollIntoView({ behavior: 'smooth', block: 'start' });
			}
		}


		// Main function: Auto-link payments to visits
		async function autoLinkPaymentsToVisits() {
			console.log('🚀 Starting auto-link process...');
			
			// Check connection - warn but allow to continue
			if (!access_token || !SPREADSHEET_ID) {
				const continueOffline = confirm(
					'⚠️ אין חיבור לענן!\n\n' +
					'הקישורים יישמרו מקומית בלבד.\n' +
					'תצטרך לשמור לענן ידנית אחר כך.\n\n' +
					'להמשיך בכל זאת?'
				);
				
				if (!continueOffline) {
					return;
				}
			}
			
			// Show loading
			showLoading('מחפש התאמות בין תשלומים לטיפולים...');
			
			try {
				// Find all matches
				const matches = findAllMatches();
				
				hideLoading();
				
				if (matches.length === 0) {
					showToast('לא נמצאו התאמות אפשריות', 'info');
					return;
				}
				
				// Show matches modal
				showMatchesModal(matches);
				
			} catch (error) {
				hideLoading();
				console.error('Error in auto-link process:', error);
				showToast('שגיאה בתהליך הקישור האוטומטי', 'error');
			}
		}





////<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<


		// פונקציה חדשה לסימון חובות כשולמים
		async function markAllDebtsPaid(locationId) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// מצא כל הביקורים הלא שולמים של הלקוח
			const unpaidVisits = visits.filter(visit => {
				if (visit.location_id !== locationId || !visit.amount || visit.amount <= 0) {
					return false;
				}
				
				const paidAmount = getVisitPaidAmount(visit.ID);
				const debt = parseFloat(visit.amount) - paidAmount;
				return debt > 0;
			});
			
			if (unpaidVisits.length === 0) {
				showToast('אין חובות פתוחים ללקוח זה', 'info');
				return;
			}
			
			const totalDebt = unpaidVisits.reduce((sum, visit) => {
				const paidAmount = getVisitPaidAmount(visit.ID);
				return sum + (parseFloat(visit.amount) - paidAmount);
			}, 0);
			
			if (confirm(`לסמן את כל החובות של ${location.name} כמסולקים?\n\nסה"כ: ₪${totalDebt.toLocaleString()}\nמספר טיפולים: ${unpaidVisits.length}`)) {
				
				try {
					showLoading('יוצר תשלום ומעדכן מערכת...');
					
					// צור תשלום אחד עבור כל החובות
					const payment = {
						ID: generateID(),
						date: getLocalDateString(),
						time: new Date().toTimeString().substr(0, 5),
						amount: totalDebt,
						payment_method: 'cash',
						source_type: 'debt_settlement',
						client_id: locationId,
						notes: `סילוק חובות - ${unpaidVisits.length} טיפולים`,
						status: 'completed',
						created_at: new Date().toISOString()
					};
					
					// הוסף תשלום למערכת
					payments.push(payment);
					
					// צור קישורים לכל הביקורים
					for (const visit of unpaidVisits) {
						const paidAmount = getVisitPaidAmount(visit.ID);
						const debtAmount = parseFloat(visit.amount) - paidAmount;
						
						if (debtAmount > 0) {
							const link = {
								ID: generateID(),
								payment_id: payment.ID,
								visit_id: visit.ID,
								amount_allocated: debtAmount,
								link_type: 'debt_settlement',
								created_at: new Date().toISOString()
							};
							
							paymentVisitLinks.push(link);
						}
					}
					
					// שמירה מקומית
					saveToLocalStorage();
					
					// שמירה בענן
					if (access_token && SPREADSHEET_ID) {
						await saveAllToSheetsOptimized();
						
						// שמור את כל הקישורים
						for (const link of paymentVisitLinks.filter(l => l.payment_id === payment.ID)) {
							await saveAllToSheetsOptimized();
						}
					}
					
					hideLoading();
					
					// רענון התצוגה
					displayDebts();
					
					showToast(`החובות של ${location.name} סומנו כמסולקים!
		💰 ₪${totalDebt.toLocaleString()} סולקו
		📋 ${unpaidVisits.length} טיפולים עודכנו`, 'success', 5000);
					
				} catch (error) {
					hideLoading();
					console.error('שגיאה בעדכון תשלומים:', error);
					showToast('שגיאה בעדכון התשלומים', 'error');
				}
			}
		}


		// פונקציות לחיפוש לקוחות היברידי
		let clientDropdownOpen = false;

		function handleClientSearch(searchTerm) {
			if (searchTerm.length === 0) {
				showAllClients();
				return;
			}
			
			// שימוש בפונקציית החיפוש החכמה החדשה
			const filteredClients = searchClientsAdvanced(searchTerm);
			populateClientDropdown(filteredClients);
			showClientDropdown();
		}

		function showAllClients() {
			const allClients = locations
				.filter(location => location.active === "1")
				.slice(0, 10);
			populateClientDropdown(allClients);
		}

		function showClientDropdown() {
			document.getElementById('clientDropdown').style.display = 'block';
			clientDropdownOpen = true;
		}

		function hideClientDropdown() {
			setTimeout(() => {
				document.getElementById('clientDropdown').style.display = 'none';
				clientDropdownOpen = false;
			}, 200);
		}

		function toggleClientDropdown() {
			if (clientDropdownOpen) {
				hideClientDropdown();
			} else {
				showAllClients();
				showClientDropdown();
			}
		}

		function populateClientDropdown(clients) {
			const dropdown = document.getElementById('clientDropdown');
			if (!dropdown) return;
			
			if (clients.length === 0) {
				dropdown.innerHTML = '<div style="padding: 10px; color: #666; text-align: center;">לא נמצאו לקוחות</div>';
				return;
			}
			
			const html = clients.map(client => `
				<div class="client-option" onclick="selectClientFromDropdown('${client.ID}')" 
					 style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;">
					<div style="font-weight: bold;">${client.name}</div>
					<div style="font-size: 12px; color: #666;">${client.full_address}</div>
				</div>
			`).join('');
			
			dropdown.innerHTML = html;
		}

		function selectClientFromDropdown(clientId) {
			const client = locations.find(c => c.ID === clientId);
			if (!client) return;
			
			document.getElementById('clientSearchInput').value = `${client.name} - ${client.full_address}`;
			document.getElementById('selectedClientId').value = clientId;
			
			hideClientDropdown();
		}

		function openAddClientModal() {
			showAddLocationForm();
		}

		// הגדרת השעה הנוכחית
		// Update the existing setCurrentTime function to handle edit form
		function setCurrentTime(timeInputId) {
			const now = new Date();
			const hours = String(now.getHours()).padStart(2, '0');
			const minutes = String(now.getMinutes()).padStart(2, '0');
			const currentTime = `${hours}:${minutes}`;
			
			document.getElementById(timeInputId).value = currentTime;
			
			// חישוב משך וסכום אוטומטי
			calculateVisitFormDuration();
			calculateVisitFormCost();
			
			showToast(`שעה נוכחית: ${currentTime}`, 'info');
		}

		/* function calculateModalDuration() {
			const startTime = document.getElementById('modalStartTime').value;
			const endTime = document.getElementById('modalEndTime').value;
			
			if (startTime && endTime) {
				const start = new Date(`2000-01-01T${startTime}`);
				const end = new Date(`2000-01-01T${endTime}`);
				
				let diffMinutes = (end - start) / (1000 * 60);
				
				// אם הסיום לפני ההתחלה, זה כנראה למחרת
				if (diffMinutes < 0) {
					diffMinutes += 24 * 60;
				}
				
				const hours = Math.floor(diffMinutes / 60);
				const minutes = diffMinutes % 60;
				
				// עדכון התצוגה
				const displayDiv = document.getElementById('modalDurationDisplay');
				if (displayDiv) {
					displayDiv.innerHTML = `משך: <strong>${diffMinutes}</strong> דקות (<strong>${(diffMinutes / 60).toFixed(1)}</strong> שעות)`;
				}
				
				// עדכון השדות המוסתרים
				document.getElementById('modalManualDurationMinutes').value = diffMinutes;
				document.getElementById('modalCalculatedHours').value = (diffMinutes / 60).toFixed(2);
				
				// חישוב עלות
				calculateModalTreatmentCost();
			}
		} */

		function updateModalManualDuration() {
			const hours = parseInt(document.getElementById('modalDurationHours').value) || 0;
			const minutes = parseInt(document.getElementById('modalDurationMinutes').value) || 0;
			const totalMinutes = hours * 60 + minutes;
			const decimalHours = (totalMinutes / 60).toFixed(1);
			
			document.getElementById('modalManualDurationMinutes').value = totalMinutes;
			document.getElementById('modalCalculatedHours').value = decimalHours;
			
			calculateModalTreatmentCost();
		}

		function updateModalFromTotalMinutes() {
			const totalMinutes = parseInt(document.getElementById('modalManualDurationMinutes').value) || 0;
			const hours = Math.floor(totalMinutes / 60);
			const minutes = totalMinutes % 60;
			const decimalHours = (totalMinutes / 60).toFixed(1);
			
			document.getElementById('modalDurationHours').value = hours;
			document.getElementById('modalDurationMinutes').value = minutes;
			document.getElementById('modalCalculatedHours').value = decimalHours;
			
			calculateModalTreatmentCost();
		}


		// קביעת טיפול לשבוע/שבועיים
		function setNextAllowedDay(clientId, allowedDay, weeksAhead = 1) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// מיפוי ימים לאינדקס השבוע (0=ראשון, 1=שני...)
			const dayToNumber = {
				'א': 0,
				'ב': 1,
				'ג': 2,
				'ד': 3,
				'ה': 4,
				'ו': 5,
				'ש': 6,
				'כל יום': 0 // ברירת מחדל
			};
			
			const targetDayOfWeek = dayToNumber[allowedDay] || 0;
			const today = new Date();
			
			// חישוב התאריך הנכון - יום מועדף בעוד X שבועות
			const daysUntilTargetDay = (targetDayOfWeek - today.getDay() + 7) % 7;
			const targetDate = new Date(today);
			
			// אם היום המועדף הוא היום - הוסף שבוע נוסף
			if (daysUntilTargetDay === 0) {
				targetDate.setDate(today.getDate() + (weeksAhead * 7));
			} else {
				// אחרת - קח היום המועדף + שבועות נוספים
				targetDate.setDate(today.getDate() + daysUntilTargetDay + ((weeksAhead - 1) * 7));
			}
			
			const year = targetDate.getFullYear();
			const month = String(targetDate.getMonth() + 1).padStart(2, '0');
			const day = String(targetDate.getDate()).padStart(2, '0');
			const dateString = `${year}-${month}-${day}`;
			
			// עדכון התאריך
			updateClientNextVisit(clientId, dateString);
			
			const weekText = weeksAhead === 1 ? 'שבוע' : 'שבועיים';
			showToast(`נקבע ${allowedDay} בעוד ${weekText} (${formatDate(dateString)})`, 'success');
		}

		// קביעת תאריך הטיפול הבא ליום המועדף הכי קרוב (כולל היום)
		function setNextAllowedDayThisWeek(clientId, allowedDay) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			const dayIndexMap = {'א': 0, 'ב': 1, 'ג': 2, 'ד': 3, 'ה': 4, 'ו': 5, 'ש': 6};
			const targetDayIndex = dayIndexMap[allowedDay] ?? 0;
			
			const today = new Date();
			const todayIndex = today.getDay();
			
			// חישוב ההפרש
			let daysDiff = targetDayIndex - todayIndex;
			if (daysDiff < 0) {
				daysDiff += 7;
			}
			
			const nextDate = new Date(today);
			nextDate.setDate(today.getDate() + daysDiff);
			
			// פורמט תאריך מקומי (לא UTC)
			const year = nextDate.getFullYear();
			const month = String(nextDate.getMonth() + 1).padStart(2, '0');
			const day = String(nextDate.getDate()).padStart(2, '0');
			const nextDateStr = `${year}-${month}-${day}`;
			
			client.next_visit = nextDateStr;
			saveToLocalStorage();
			
			showToast(`✅ ${client.name} - ${formatDate(nextDateStr)}`, 'success');
			
			// רענון התצוגה
			loadPlanningClientsAdvanced();
			renderPlanningCards();
			
			// שמירה לענן
			if (access_token && SPREADSHEET_ID) {
				saveLocationsBatch(locations).catch(err => console.error('Error saving:', err));
			}
		}


		function loadLocationsForSelect() {
			const select = document.getElementById('locationSelect');
			if (!select) return; // הוסף בדיקה
			
			select.innerHTML = '<option value="">בחר לקוח...</option>';
			
			locations.filter(location => location.active === "1").forEach(location => {
				const option = document.createElement('option');
				option.value = location.ID;
				option.textContent = `${location.name} - ${location.full_address}`;
				select.appendChild(option);
			});
		}

		// הגדרת תאריך היום לכל שדות התאריך
		function setTodayAsDefault() {
			const today = getLocalDateString();
			document.querySelectorAll('.planning-date-input').forEach(input => {
				if (!input.value) {
					input.value = today;
				}
			});
		}

		// סינון טבלת לקוחות
		function filterLocationsTable() {
			loadLocationsTable(); // טען מחדש עם סינון
		}

		// קבלת רשימה מסוננת של לקוחות
		function getFilteredLocations() {
			let filteredData = [...locations];
			
			// סינון לפי שם
			const nameFilter = document.getElementById('filterClientName')?.value.toLowerCase();
			if (nameFilter) {
				filteredData = filteredData.filter(location => 
					location.name.toLowerCase().includes(nameFilter) ||
					location.full_address.toLowerCase().includes(nameFilter)
				);
			}
			
			// סינון לפי יום
			const dayFilter = document.getElementById('filterDay')?.value;
			if (dayFilter) {
				filteredData = filteredData.filter(location => location.allowed_day === dayFilter);
			}
			
			// סינון לפי מרווח
			const intervalFilter = document.getElementById('filterInterval')?.value;
			if (intervalFilter) {
				filteredData = filteredData.filter(location => location.interval_weeks == intervalFilter);
			}
			
			// סינון לפי סטטוס
			const activeFilter = document.getElementById('filterActive')?.value;
			if (activeFilter !== "") {
				filteredData = filteredData.filter(location => location.active === activeFilter);
			}
			
			// מיון לפי שם
			filteredData.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'he'));

			return filteredData;
		}

		// ניקוי סינונים
		function clearLocationFilters() {
			const nameFilter = document.getElementById('filterClientName');
			const dayFilter = document.getElementById('filterDay');
			const intervalFilter = document.getElementById('filterInterval');
			const activeFilter = document.getElementById('filterActive');
			
			if (nameFilter) nameFilter.value = '';
			if (dayFilter) dayFilter.value = '';
			if (intervalFilter) intervalFilter.value = '';
			if (activeFilter) activeFilter.value = '';
			
			loadLocationsTable();
		}


		function startTreatment(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// 🔥 סגור את המודל הנוכחי (פרופיל) לפני פתיחת טופס הטיפול
			closeAnyModal();
			
			// המתן רגע קצר כדי לוודא שהמודל נסגר
			setTimeout(() => {
				// בדיקה האם יש כבר טיפול היום ללקוח
				const today = getLocalDateString();
				const existingTodayVisit = visits.find(visit => 
					visit.location_id === clientId && 
					visit.date === today
				);
				
				if (existingTodayVisit) {
					// יש כבר טיפול היום - פתח עריכה
					showToast(`נמצא טיפול קיים היום עבור ${client.name} - פותח לעריכה`, 'info');
					showVisitForm(existingTodayVisit.ID);
				} else {
					// אין טיפול היום - צור חדש
					showToast(`פותח טיפול חדש עבור ${client.name}`, 'success');
					
					// פתח טופס טיפול חדש עם הלקוח נבחר מראש
					showVisitForm(null, clientId);
				}
			}, 100);
		}



		// Receipt filtering functions
		function loadReceiptFilterOptions() {
			// Load book numbers
			const bookSelect = document.getElementById('filterReceiptBook');
			if (bookSelect) {
				const uniqueBooks = [...new Set(receipts.map(r => r.book_number).filter(b => b))];
				bookSelect.innerHTML = '<option value="">כל הפנקסים</option>';
				uniqueBooks.sort().forEach(book => {
					bookSelect.innerHTML += `<option value="${book}">${book}</option>`;
				});
			}
		}

		// Update applyReceiptFilters function - add this at the beginning:
		function applyReceiptFilters() {
			// Check if smart search is active
			const smartSearch = document.getElementById('receiptSmartSearch')?.value;
			if (smartSearch && smartSearch.trim()) {
				handleReceiptSmartSearch(smartSearch);
				return;
			}
			
			let filteredReceipts = [...receipts];
			
			// Apply filters with null safety
			const bookFilter = document.getElementById('filterReceiptBook')?.value || '';
			const paymentFilter = document.getElementById('filterPaymentType')?.value || '';
			const dateFrom = document.getElementById('filterReceiptDateFrom')?.value || '';
			const dateTo = document.getElementById('filterReceiptDateTo')?.value || '';
			const sortBy = document.getElementById('receiptSortBy')?.value || 'date_desc';
			
			if (bookFilter) {
				filteredReceipts = filteredReceipts.filter(r => r.book_number === bookFilter);
			}
			
			if (paymentFilter) {
				filteredReceipts = filteredReceipts.filter(r => r.payment_type === paymentFilter);
			}
			
			if (dateFrom) {
				filteredReceipts = filteredReceipts.filter(r => r.date >= dateFrom);
			}
			
			if (dateTo) {
				filteredReceipts = filteredReceipts.filter(r => r.date <= dateTo);
			}
			
			// Sort results
			filteredReceipts.sort((a, b) => {
				switch(sortBy) {
					case 'date_asc': return a.date.localeCompare(b.date);
					case 'date_desc': return b.date.localeCompare(a.date);
					case 'amount_asc': return (a.amount || 0) - (b.amount || 0);
					case 'amount_desc': return (b.amount || 0) - (a.amount || 0);
					case 'book_asc': return (a.book_number || '').localeCompare(b.book_number || '');
					default: return b.date.localeCompare(a.date);
				}
			});
			
			displayFilteredReceipts(filteredReceipts);
			updateReceiptsStats(filteredReceipts);
		}

		function sortReceiptResults(receipts, sortBy) {
			switch(sortBy) {
				case 'date_desc':
					receipts.sort((a, b) => new Date(b.date) - new Date(a.date));
					break;
				case 'date_asc':
					receipts.sort((a, b) => new Date(a.date) - new Date(b.date));
					break;
				case 'amount_desc':
					receipts.sort((a, b) => (b.amount || 0) - (a.amount || 0));
					break;
				case 'amount_asc':
					receipts.sort((a, b) => (a.amount || 0) - (b.amount || 0));
					break;
				case 'book_asc':
					receipts.sort((a, b) => (a.book_number || '').localeCompare(b.book_number || ''));
					break;
			}
		}

		function clearReceiptFilters() {
			const bookFilter = document.getElementById('filterReceiptBook');
			const paymentType = document.getElementById('filterPaymentType');
			const dateFrom = document.getElementById('filterReceiptDateFrom');
			const dateTo = document.getElementById('filterReceiptDateTo');
			const sortBy = document.getElementById('receiptSortBy');
			const smartSearch = document.getElementById('receiptSmartSearch');
			
			if (bookFilter) bookFilter.value = '';
			if (paymentType) paymentType.value = '';
			if (dateFrom) dateFrom.value = '';
			if (dateTo) dateTo.value = '';
			if (sortBy) sortBy.value = 'date_desc';
			if (smartSearch) smartSearch.value = '';
			
			displayFilteredReceipts(receipts);
		}

		function displayFilteredReceipts(filteredReceipts) {
			const tbody = document.getElementById('receiptsTableBody');
			tbody.innerHTML = '';
			
			if (filteredReceipts.length === 0) {
				tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #666;">אין קבלות מתאימות לסינון</td></tr>';
				updateReceiptsStats([]);
				return;
			}

			filteredReceipts.forEach(receipt => {
				// Main row - visible always
				const mainRow = document.createElement('tr');
				mainRow.className = 'main-row';
				mainRow.innerHTML = `
					<td><strong>${formatDate(receipt.date)}</strong></td>
					<td>${receipt.location_name || '-'}</td>
					<td style="color: #27ae60; font-weight: bold;">₪${receipt.amount || 0}</td>
					<td>
						<button class="action-btn edit-btn" onclick="event.stopPropagation(); editReceipt('${receipt.ID}')">✏️</button>
						<button class="action-btn delete-btn" onclick="event.stopPropagation(); deleteReceipt('${receipt.ID}')">🗑️</button>
					</td>
				`;
				tbody.appendChild(mainRow);
				
				// Details row - hidden by default
				const detailsRow = document.createElement('tr');
				detailsRow.className = 'details-row';
				detailsRow.innerHTML = `
					<td colspan="4">
						<div class="details-content">
							<div class="detail-item">
								<span class="detail-label">פנקס:</span>
								<span class="detail-value">${receipt.book_number || '-'}</span>
							</div>
							<div class="detail-item">
								<span class="detail-label">מספר:</span>
								<span class="detail-value">${receipt.receipt_number || '-'}</span>
							</div>
							<div class="detail-item">
								<span class="detail-label">אופן:</span>
								<span class="detail-value">${receipt.payment_type || '-'}</span>
							</div>
							<div class="detail-item">
								<span class="detail-label">קוד:</span>
								<span class="detail-value">${receipt.codeX || '-'}</span>
							</div>
							${receipt.notes && receipt.notes.trim() ? `
							<div class="detail-item" style="grid-column: 1 / -1;">
								<span class="detail-label">הערות:</span>
								<span class="detail-value">${receipt.notes}</span>
							</div>
							` : ''}
						</div>
					</td>
				`;
				tbody.appendChild(detailsRow);
			});
			
			updateReceiptsStats(filteredReceipts);
			
			// Initialize expandable rows
			setTimeout(() => {
				initExpandableTable('receiptsTable');
			}, 100);
		}

		// Update stats functions for all tabs

		function updateReceiptsStats(filteredReceipts) {
			const count = filteredReceipts.length;
			const total = filteredReceipts.reduce((sum, receipt) => {
				const amount = parseFloat(receipt.amount) || 0;
				return sum + amount;
			}, 0);
			const average = count > 0 ? Math.round(total / count) : 0;
			
			document.getElementById('receiptsCount').textContent = count;
			document.getElementById('receiptsTotal').textContent = `${Math.round(total)} ₪`; // העבר את ₪ לסוף
			document.getElementById('receiptsAverage').textContent = `${average} ₪`;
		}


		function updateDebtsStats(debtsArray) {
			const totalDebt = debtsArray.reduce((sum, debt) => sum + debt.totalDebt, 0);
			const debtorsCount = debtsArray.length;
			const averageDebt = debtorsCount > 0 ? totalDebt / debtorsCount : 0;
			
			// Update stats display
			const debtsCountElement = document.getElementById('debtsCount');
			const debtsTotalElement = document.getElementById('debtsTotal');
			const debtsAverageElement = document.getElementById('debtsAverage');
			
			if (debtsCountElement) debtsCountElement.textContent = debtorsCount;
			if (debtsTotalElement) debtsTotalElement.textContent = `₪${Math.round(totalDebt).toLocaleString()}`;
			if (debtsAverageElement) debtsAverageElement.textContent = `₪${Math.round(averageDebt).toLocaleString()}`;
		}

		function updateTreatmentsStats(filteredTreatments) {
			const count = filteredTreatments.length;
			const total = filteredTreatments.reduce((sum, treatment) => {
				const amount = parseFloat(treatment.amount) || 0;
				return sum + amount;
			}, 0);
			const paidCount = filteredTreatments.filter(t => getVisitPaymentStatus(t.ID) === '1').length;
			const unpaidCount = filteredTreatments.filter(t => getVisitPaymentStatus(t.ID) === '0').length;
			
			// חישוב חובות פתוחים
			const openDebts = filteredTreatments
				.filter(t => getVisitPaymentStatus(t.ID) === '0')
				.reduce((sum, treatment) => {
					const amount = parseFloat(treatment.amount) || 0;
					const paidAmount = getVisitPaidAmount(treatment.ID);
					return sum + (amount - paidAmount);
				}, 0);
			
			document.getElementById('treatmentsCount').textContent = count;
			document.getElementById('treatmentsTotal').textContent = `${Math.round(total)} ₪`;
			document.getElementById('treatmentsPaid').textContent = paidCount;
			document.getElementById('treatmentsUnpaid').textContent = unpaidCount;
			
			// הוסף חוב לסטטיסטיקות
			const debtsElement = document.getElementById('treatmentsDebts');
			if (debtsElement) {
				debtsElement.textContent = `${Math.round(openDebts)} ₪`;
			}
		}


		// פונקציה לסינון מהיר לפי תאריכים
		function setQuickDateFilter(period) {
			const today = new Date();
			const dateFromInput = document.getElementById('filterDateFrom');
			const dateToInput = document.getElementById('filterDateTo');
			
			// הסרת active מכל הכפתורים
			document.querySelectorAll('.filter-quick-btn').forEach(btn => btn.classList.remove('active'));
			
			let fromDate;
			
			switch(period) {
				case 'today':
					fromDate = new Date(today);
					break;
				case 'week':
					fromDate = new Date(today);
					fromDate.setDate(today.getDate() - 7);
					break;
				case 'month':
					fromDate = new Date(today);
					fromDate.setMonth(today.getMonth() - 1);
					break;
			}
			
			dateFromInput.value = fromDate.toISOString().split('T')[0];
			dateToInput.value = today.toISOString().split('T')[0];
			
			// סימון הכפתור כפעיל
			event.target.classList.add('active');
			
			// הפעלת הסינון
			applyVisitFilters();
		}


		function clearVisitFilters() {
			const locationFilter = document.getElementById('filterLocation');
			const paymentFilter = document.getElementById('filterPayment');
			const dateFrom = document.getElementById('filterDateFrom');
			const dateTo = document.getElementById('filterDateTo');
			const maxResults = document.getElementById('maxResults');
			const activeFilter = document.getElementById('filterActiveClients');
			const smartSearch = document.getElementById('visitSmartSearch');
			
			if (locationFilter) locationFilter.value = '';
			if (paymentFilter) paymentFilter.value = '';
			if (dateFrom) dateFrom.value = '';
			if (dateTo) dateTo.value = '';
			if (maxResults) maxResults.value = '200';
			if (activeFilter) activeFilter.value = '1';
			if (smartSearch) smartSearch.value = '';
			
			// Clear quick filter buttons
			document.querySelectorAll('.filter-quick-btn').forEach(btn => 
				btn.classList.remove('active')
			);
			
			displayFilteredVisits(visits);
			updateTreatmentsStats(visits);
		}

		
		
		// ========================================
		// 🆕 UNIFIED VISIT FORM - יצירה ועריכה
		// ========================================

		function showVisitForm(visitId = null, preSelectedClientId = null) {
			const isEdit = visitId !== null;
			let visitData = null;
			let locationName = '';
			
			// אם זה עריכה - טען את הנתונים
			if (isEdit) {
				visitData = visits.find(v => v.ID === visitId);
				if (!visitData) {
					showToast('טיפול לא נמצא', 'error');
					return;
				}
				
				const location = locations.find(loc => loc.ID === visitData.location_id);
				locationName = location ? location.name : 'לקוח לא נמצא';
			}
			
			// Get location ID for warning (edit mode or pre-selected)
			let locationId = null;
			if (isEdit && visitData) {
				locationId = visitData.location_id;
			} else if (preSelectedClientId) {
				locationId = preSelectedClientId;
			}
			
			// כותרת דינמית
			const title = isEdit ? `✏️ עריכת טיפול - ${locationName}` : '🔧 טיפול חדש';
			const titleColor = isEdit ? '#e67e22' : '#3498db';
			const buttonText = isEdit ? '💾 שמור שינויים' : '💾 שמור טיפול';
			const buttonColor = isEdit ? '#e67e22' : '#27ae60';
			
			// בניית HTML
			const modalHTML = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 650px; width: 90vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.15); position: relative;">
					<!-- Close X Button -->
					<button onclick="closeAnyModal()" 
							style="position: absolute; top: 15px; left: 15px; background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px; font-weight: bold; line-height: 1; display: flex; align-items: center; justify-content: center; z-index: 10;">
						×
					</button>
					
					<h3 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 22px; border-bottom: 2px solid ${titleColor}; padding-bottom: 10px;">${title}</h3>
					${locationId ? showOpenDebtsWarning(locationId) : ''}
		
					<form id="visitForm" onsubmit="handleVisitFormSubmit(event, ${isEdit ? `'${visitId}'` : 'null'})" style="display: flex; flex-direction: column; gap: 18px;">
						
						<!-- תאריך ${isEdit ? '' : 'ולקוח'} -->
						<div style="display: grid; grid-template-columns: ${isEdit ? '1fr' : '1fr 2fr'}; gap: 15px;">
							<div class="form-group" style="margin: 0;">
								<label for="visitFormDate" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">תאריך:</label>
								<input type="date" id="visitFormDate" value="${isEdit ? visitData.date : ''}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
							</div>
							
							${!isEdit ? `
							<div class="form-group" style="margin: 0; position: relative;">
								<label for="visitFormClientSearch" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">לקוח:</label>
								<input type="text" id="visitFormClientSearch" placeholder="🔍 חיפוש לקוח..." onkeyup="filterClientOptions('visitFormClientSearch', 'visitFormClientOptions')" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
								<div id="visitFormClientOptions" class="client-options" style="display: none;"></div>
								<input type="hidden" id="visitFormClientId">
							</div>
							` : ''}
						</div>
						
						<!-- סוג טיפול -->
						<div class="form-group" style="margin: 0;">
							<label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">סוג טיפול:</label>
							<div style="display: flex; gap: 15px;">
								<label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 8px 15px; border: 2px solid #ddd; border-radius: 6px; transition: all 0.2s;">
									<input type="radio" name="visitFormType" value="מלא" ${!isEdit || visitData.visit_type === 'מלא' ? 'checked' : ''} onchange="document.getElementById('visitFormTypeHidden').value=this.value" style="margin: 0;">
									<span style="font-size: 14px;">מלא</span>
								</label>
								<label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 8px 15px; border: 2px solid #ddd; border-radius: 6px; transition: all 0.2s;">
									<input type="radio" name="visitFormType" value="חלקי" ${isEdit && visitData.visit_type === 'חלקי' ? 'checked' : ''} onchange="document.getElementById('visitFormTypeHidden').value=this.value" style="margin: 0;">
									<span style="font-size: 14px;">חלקי</span>
								</label>
								<label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 8px 15px; border: 2px solid #ddd; border-radius: 6px; transition: all 0.2s;">
									<input type="radio" name="visitFormType" value="ביקורת" ${isEdit && visitData.visit_type === 'ביקורת' ? 'checked' : ''} onchange="document.getElementById('visitFormTypeHidden').value=this.value" style="margin: 0;">
									<span style="font-size: 14px;">ביקורת</span>
								</label>
								<input type="hidden" id="visitFormTypeHidden" value="${isEdit ? (visitData.visit_type || 'מלא') : 'מלא'}">
							</div>
						</div>
						
						<!-- עבודה שבוצעה -->
						<div class="form-group" style="margin: 0;">
							<label for="visitFormWorkDone" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">עבודה שבוצעה:</label>
							<textarea id="visitFormWorkDone" rows="2" placeholder="תיאור העבודה..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;">${isEdit ? (visitData.work_done || '') : ''}</textarea>
						</div>
						
						<!-- משך טיפול -->
						<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">
							<label style="display: block; margin-bottom: 10px; font-weight: 600; color: #555;">⏱️ משך הטיפול:</label>
							<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
								<div>
									<label for="visitFormStartTime" style="display: block; margin-bottom: 5px; font-size: 13px; color: #666;">שעת התחלה:</label>
									<div style="display: flex; gap: 6px;">
										<input type="time" id="visitFormStartTime" value="${isEdit ? (visitData.start_time || '') : ''}" onchange="calculateVisitFormDuration(); calculateVisitFormCost();" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
										<button type="button" onclick="setCurrentTime('visitFormStartTime')" title="שעה נוכחית" style="padding: 8px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 18px; line-height: 1; min-width: 40px; flex-shrink: 0;">🕐</button>								
									</div>
								</div>
								<div>
									<label for="visitFormEndTime" style="display: block; margin-bottom: 5px; font-size: 13px; color: #666;">שעת סיום:</label>
									<div style="display: flex; gap: 6px;">
										<input type="time" id="visitFormEndTime" value="${isEdit ? (visitData.end_time || '') : ''}" onchange="calculateVisitFormDuration(); calculateVisitFormCost();" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
										<button type="button" onclick="setCurrentTime('visitFormEndTime')" title="שעה נוכחית" style="padding: 8px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 18px; line-height: 1; min-width: 40px; flex-shrink: 0;">🕐</button>
									</div>
								</div>
							</div>
							<div id="visitFormDurationDisplay" style="text-align: center; padding: 8px; background: white; border-radius: 6px; font-weight: 600; color: ${titleColor}; font-size: 15px;">
								${isEdit ? `משך: <strong>${visitData.duration_minutes || 0}</strong> דקות (<strong>${((visitData.duration_minutes || 0) / 60).toFixed(1)}</strong> שעות)` : 'משך: -- דקות (-- שעות)'}
							</div>
							<input type="hidden" id="visitFormDurationMinutes" value="${isEdit ? (visitData.duration_minutes || 0) : 0}">
							<input type="hidden" id="visitFormCalculatedHours" value="${isEdit ? (((visitData.duration_minutes || 0) / 60).toFixed(2)) : 0}">
						</div>
						
						<!-- עלות ועובדים -->
						<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
							<div class="form-group" style="margin: 0;">
								<label for="visitFormAmount" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">💰 סכום:</label>
								<input type="number" id="visitFormAmount" step="0.01" min="0" value="${isEdit ? (visitData.amount || 0) : ''}" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
								<div id="visitFormCalculatedAmount" style="font-size: 14px; color: #27ae60; font-weight: bold; margin-top: 5px;"></div>
							</div>
							
							<div class="form-group" style="margin: 0;">
								<label for="visitFormNumWorkers" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">👷 עובדים:</label>
								<input type="number" id="visitFormNumWorkers" min="1" value="${isEdit ? (visitData.num_workers || 1) : 1}" onchange="calculateVisitFormCost()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
							</div>
							
							<div class="form-group" style="margin: 0;">
								<label for="visitFormExpense" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">💸 הוצאה:</label>
								<input type="number" id="visitFormExpense" step="0.01" min="0" value="${isEdit ? (visitData.expense || 0) : 0}" placeholder="0" onchange="calculateVisitFormCost()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
							</div>
						</div>
						
						<!-- הערות -->
						<div class="form-group" style="margin: 0;">
							<label for="visitFormNotes" style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">📝 הערות:</label>
							<textarea id="visitFormNotes" rows="2" placeholder="הערות נוספות..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;">${isEdit ? (visitData.notes || '') : ''}</textarea>
						</div>

						${isEdit ? `
						<!-- סטטוס תשלום -->
						<div style="background: ${visitData.paid === '0' ? '#fff3cd' : visitData.paid === '2' ? '#e8f5e9' : '#d4edda'}; padding: 15px; border-radius: 8px; border: 2px solid ${visitData.paid === '0' ? '#ffc107' : visitData.paid === '2' ? '#4caf50' : '#27ae60'};">
							<div style="display: flex; justify-content: space-between; align-items: center;">
								<div>
									<span style="font-weight: 600; color: #555;">💳 סטטוס תשלום:</span>
									<span style="font-weight: bold; margin-right: 10px; color: ${visitData.paid === '0' ? '#856404' : '#155724'};">
										${visitData.paid === '0' ? '❌ לא שולם' : visitData.paid === '2' ? '🚫 ללא תשלום' : visitData.paid === '3' ? '½ שולם חלקית' : '✅ שולם'}
									</span>
								</div>
								${visitData.paid !== '0' && visitData.paid !== '2' ? `
									<button type="button" onclick="cancelVisitPaidStatus('${visitId}')" style="background: #e74c3c; color: white; padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
										🔓 בטל סימון שולם
									</button>
								` : ''}
							</div>
						</div>
						` : ''}
						
						<!-- כפתורי פעולה -->
						<div style="display: flex; gap: 12px; justify-content: center; margin-top: 10px; padding-top: 15px; border-top: 1px solid #e9ecef;">
							<button type="submit" style="background: ${buttonColor}; color: white; padding: 12px 35px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 8px rgba(39,174,96,0.3);">${buttonText}</button>
							<button type="button" onclick="closeAnyModal()" style="background: #95a5a6; color: white; padding: 12px 35px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s;">✖ ביטול</button>
						</div>
					</form>
				</div>
				
				<style>
					label:has(input[type="radio"]:checked) {
						border-color: ${titleColor} !important;
						background: ${isEdit ? '#fff3e0' : '#e3f2fd'} !important;
					}
				</style>
			`;
			
			// הצגת המודאל
			showModal(modalHTML);
			
			// אתחול
			setTimeout(() => {
				if (!isEdit) {
					// מצב יצירה - הגדר תאריך היום
					document.getElementById('visitFormDate').value = getLocalDateString();
					loadVisitFormClientOptions();
					
					// אם יש לקוח נבחר מראש - מלא אותו
					if (preSelectedClientId) {
						const client = locations.find(loc => loc.ID === preSelectedClientId);
						if (client) {
							const searchInput = document.getElementById('visitFormClientSearch');
							const clientIdInput = document.getElementById('visitFormClientId');
							if (searchInput && clientIdInput) {
								searchInput.value = `${client.name} - ${client.full_address}`;
								clientIdInput.value = preSelectedClientId;
								
								// חישוב עלות אוטומטי
								calculateVisitFormCost();
							}
						}
					}
				} else {
					// מצב עריכה - חישוב ערכים
					calculateVisitFormDuration();
					calculateVisitFormCost();
				}
			}, 100);
		}
		
		
		// פונקציות עזר לטופס המאוחד

		function loadVisitFormClientOptions() {
			const searchInput = document.getElementById('visitFormClientSearch');
			if (!searchInput) return;
			
			// טען את כל הלקוחות הפעילים
			const activeLocations = locations.filter(loc => 
				loc.active === "1" || loc.active === true || loc.active === "כן"
			);
			
			console.log(`📋 ${activeLocations.length} לקוחות פעילים זמינים לבחירה`);
		}

		function selectVisitFormClient(clientId, clientName) {
			document.getElementById('visitFormClientSearch').value = clientName;
			document.getElementById('visitFormClientId').value = clientId;
			document.getElementById('visitFormClientOptions').style.display = 'none';
		}

		function calculateVisitFormDuration() {
			const startTime = document.getElementById('visitFormStartTime')?.value;
			const endTime = document.getElementById('visitFormEndTime')?.value;
			const durationDisplay = document.getElementById('visitFormDurationDisplay');
			const durationMinutesInput = document.getElementById('visitFormDurationMinutes');
			
			if (!startTime || !endTime || !durationDisplay) return;
			
			const start = new Date(`2000-01-01 ${startTime}`);
			const end = new Date(`2000-01-01 ${endTime}`);
			const diffMs = end - start;
			
			if (diffMs > 0) {
				const minutes = Math.round(diffMs / (1000 * 60));
				const hours = (minutes / 60).toFixed(1);
				
				durationDisplay.innerHTML = `משך: <strong>${minutes}</strong> דקות (<strong>${hours}</strong> שעות)`;
				
				if (durationMinutesInput) {
					durationMinutesInput.value = minutes;
				}
			} else {
				durationDisplay.innerHTML = 'משך: -- דקות (-- שעות)';
				if (durationMinutesInput) {
					durationMinutesInput.value = 0;
				}
			}
		}

		function calculateVisitFormCost() {
			// קריאת משך זמן
			let totalMinutes = 0;
			const manualField = document.getElementById('visitFormDurationMinutes');
			
			if (manualField && manualField.value) {
				totalMinutes = parseInt(manualField.value) || 0;
			}
			
			const numWorkers = parseInt(document.getElementById('visitFormNumWorkers')?.value) || 1;
			const expense = parseFloat(document.getElementById('visitFormExpense')?.value) || 0;
			
			if (totalMinutes > 0 && costSettings && costSettings.hourlyRate) {
				const hours = totalMinutes / 60;
				const baseCost = costSettings.hourlyRate * hours;
				const workersCost = (numWorkers - 1) * costSettings.workerCost * hours;
				const laborCost = baseCost + workersCost;
				const totalCost = laborCost + expense;
				const calculatedDiv = document.getElementById('visitFormCalculatedAmount');
				if (calculatedDiv) {
					calculatedDiv.textContent = `מחושב: ${Math.round(totalCost)}₪`;
				}
				
				console.log(`💰 עלות מחושבת: ${Math.round(totalCost)}₪ (${hours.toFixed(2)} שעות × ${numWorkers} עובדים + ${expense}₪ הוצאות)`);
			} else {
				// אם אין משך זמן - נקה את התצוגה
				const calculatedDiv = document.getElementById('visitFormCalculatedAmount');
				if (calculatedDiv) {
					calculatedDiv.textContent = '';
				}
			}
		}
		

		// פונקציית שמירה מאוחדת

		async function handleVisitFormSubmit(event, visitId = null) {
			event.preventDefault();
			
			const isEdit = visitId !== null;
			
			// הגנה מפני לחיצות כפולות
			if (isSubmittingVisit) {
				console.log('⚠️ Already submitting, ignoring duplicate click');
				return;
			}
			
			isSubmittingVisit = true;
			
			try {
				showLoading('שומר שינויים...');
				
				// איסוף נתונים מהטופס
				const visitDate = document.getElementById('visitFormDate').value;
				const visitType = document.getElementById('visitFormTypeHidden').value;
				const workDone = document.getElementById('visitFormWorkDone').value;
				const startTime = document.getElementById('visitFormStartTime').value;
				const endTime = document.getElementById('visitFormEndTime').value;
				const durationMinutes = parseInt(document.getElementById('visitFormDurationMinutes').value) || 0;
				const numWorkers = parseInt(document.getElementById('visitFormNumWorkers').value) || 1;
				const amount = parseFloat(document.getElementById('visitFormAmount').value) || 0;
				const expense = parseFloat(document.getElementById('visitFormExpense').value) || 0;
				const notes = document.getElementById('visitFormNotes').value;
				
				let locationId, locationName;
				
				if (isEdit) {
					// מצב עריכה - קח מהטיפול הקיים
					const visit = visits.find(v => v.ID === visitId);
					if (!visit) {
						showToast('❌ טיפול לא נמצא', 'error');
						return;
					}
					locationId = visit.location_id;
					locationName = visit.location_name;
				} else {
					// מצב יצירה - קח מהשדה
					locationId = document.getElementById('visitFormClientId').value;
					if (!locationId) {
						showToast('❌ אנא בחר לקוח', 'error');
						isSubmittingVisit = false;
						return;
					}
					
					const location = locations.find(loc => loc.ID === locationId);
					locationName = location ? location.name : 'לקוח לא ידוע';
				}
				
				// בדיקות בסיסיות
				if (!visitDate) {
					showToast('❌ נדרש תאריך טיפול', 'error');
					isSubmittingVisit = false;
					return;
				}
				
				if (!visitType) {
					showToast('❌ נדרש סוג טיפול', 'error');
					isSubmittingVisit = false;
					return;
				}
				
				if (isEdit) {
					// ===== מצב עריכה =====
					const visitIndex = visits.findIndex(v => v.ID === visitId);
					if (visitIndex === -1) {
						showToast('❌ טיפול לא נמצא', 'error');
						return;
					}
					
					// עדכון הטיפול
					visits[visitIndex] = {
						ID: visitId,
						date: visitDate,
						location_id: locationId,
						location_name: locationName,
						visit_type: visitType,
						work_done: workDone,
						duration_minutes: durationMinutes,
						num_workers: numWorkers,
						start_time: startTime || '',
						end_time: endTime || '',
						amount: amount,
						paid: visits[visitIndex].paid || '0',
						expense: expense,
						notes: notes
					};
					
					// שמירה מקומית
					saveToLocalStorage();
					
					// עדכון בענן
					if (access_token && SPREADSHEET_ID) {
						try {
							await updateSingleVisitInSheets(visits[visitIndex]);
							console.log('✅ Visit updated in cloud');
						} catch (error) {
							console.error('⚠️ Error updating visit in cloud:', error);
						}
					}
					
					// עדכון תאריכי טיפול
					await updateSingleLocationTreatmentDates(locationId);
					
					showToast('✅ הטיפול עודכן בהצלחה', 'success');
					
				} else {
					// ===== מצב יצירה =====
					
					// בדיקת כפילויות
					const duplicateVisit = checkDuplicateVisit(locationId, visitDate);
					if (duplicateVisit) {
						const confirmMessage = `כבר קיים טיפול ללקוח "${locationName}" ביום (${formatDate(visitDate)}).\n\nהאם להוסיף טיפול נוסף בכל זאת?`;
						if (!confirm(confirmMessage)) {
							isSubmittingVisit = false;
							return;
						}
					}
					
					// יצירת טיפול חדש
					const newVisit = {
						ID: generateID(),
						date: visitDate,
						location_id: locationId,
						location_name: locationName,
						visit_type: visitType,
						work_done: workDone,
						duration_minutes: durationMinutes,
						num_workers: numWorkers,
						start_time: startTime || '',
						end_time: endTime || '',
						amount: amount,
						paid: '0',
						expense: expense,
						notes: notes
					};
					
					// הוספה למערך
					visits.push(newVisit);
					
					// שמירה מקומית
					saveToLocalStorage();
					
					// שמירה בענן
					let cloudSaved = false;
					if (access_token && SPREADSHEET_ID) {
						try {
							cloudSaved = await saveVisitsBatch([newVisit]);
						} catch (error) {
							console.error('Cloud save failed:', error);
						}
					}
					
					// עדכון תאריכי טיפול
					await updateSingleLocationTreatmentDates(locationId);
					
					// הודעת הצלחה
					if (access_token && SPREADSHEET_ID) {
						if (cloudSaved) {
							showToast('✅ הטיפול נשמר בהצלחה במערכת ובענן!', 'success');
						} else {
							showToast('⚠️ הטיפול נשמר מקומית בלבד - בעיה בחיבור לענן', 'warning');
						}
					} else {
						showToast('💾 הטיפול נשמר מקומית - התחבר לענן לשמירה מלאה', 'info');
					}
				}
				
				// סגירת המודאל
				closeAnyModal();
				
				// רענון תצוגות
				loadPlanningData();
				loadTodayTreatments();
				if (typeof applyVisitFilters === 'function') {
					applyVisitFilters();
				}
				
			} catch (error) {
				console.error('Error saving visit:', error);
				showToast('❌ שגיאה בשמירת הטיפול', 'error');
			} finally {
				isSubmittingVisit = false;
				hideLoading();
			}
		}


		
		////<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
		
		
		
		// פונקציה לעדכון הערות חוב
		async function updateDebtNotes(locationId, notes) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// עדכון מקומי
			location.debt_notes = notes;
			saveToLocalStorage();
			
			// עדכון בענן (אם מחובר)
			if (access_token && SPREADSHEET_ID) {
				try {
					await updateLocationInCloud(location);
					console.log('הערות חוב עודכנו בענן');
				} catch (error) {
					console.log('הערות עודכנו מקומית בלבד');
				}
			}
		}

		// פונקציה לעדכון סטטוס פעילות לקוח
		async function updateLocationActive(locationId, activeStatus) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// עדכון מקומי
			location.active = activeStatus;
			saveToLocalStorage();
			
			// עדכון בענן (אם מחובר)
			if (access_token && SPREADSHEET_ID) {
				try {
					await updateLocationInCloud(location);
					console.log('סטטוס פעילות עודכן בענן');
				} catch (error) {
					console.log('סטטוס עודכן מקומית בלבד');
				}
			}
			
			// רענון טבלאות רלוונטיות
			loadLocationsForSelect(); // עדכון רשימות נפתחות
			updateLocationsStats(getFilteredLocations()); // עדכון סטטיסטיקות
		}

		// מעבר לטאב טיפולים מסונן לפי לקוח
		function showClientTreatments(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// Jump to treatments tab
			showSection('history');
			
			// Wait for tab to load, then apply client filter
			setTimeout(() => {
				// Clear existing filters
				if (typeof clearVisitFilters === 'function') {
					clearVisitFilters();
				}
				
				// Set smart search to client name
				const smartSearchInput = document.getElementById('visitSmartSearch');
				if (smartSearchInput) {
					smartSearchInput.value = client.name;
					// Trigger the search
					if (typeof handleVisitSmartSearch === 'function') {
						handleVisitSmartSearch(client.name);
					}
				}
				
				showToast(`מציג טיפולים עבור ${client.name}`, 'success', 2000);
			}, 200);
		}

		function showClientReceipts(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// Jump to receipts tab
			showSection('receipts');
			
			// Wait for tab to load, then apply client filter
			setTimeout(() => {
				// Clear existing filters
				if (typeof clearReceiptFilters === 'function') {
					clearReceiptFilters();
				}
				
				// Set client filter if dropdown exists
				const clientFilter = document.getElementById('filterReceiptClient');
				if (clientFilter) {
					clientFilter.value = clientId;
					// Apply filters
					if (typeof applyReceiptFilters === 'function') {
						applyReceiptFilters();
					}
				}
				
				showToast(`מציג קבלות עבור ${client.name}`, 'info', 2000);
			}, 200);
		}


		// טעינת לקוחות לבחירה במודל
		function loadClientsForModal() {
			const clientSearchInput = document.getElementById('modalClientSearchInput');
			const clientOptions = document.getElementById('modalClientOptions');
			
			if (!clientSearchInput || !clientOptions) return;
			
			// הגדרת מאזין לקלט
			clientSearchInput.addEventListener('input', function() {
				filterClientOptions('modalClientSearchInput', 'modalClientOptions');
			});
		}

		// טיפול בשליחת הטופס מהמודל
		// משתנה גלובלי למניעת לחיצות כפולות
		let isSubmittingVisit = false;


		function filterClientOptions(inputId, optionsId) {
			const searchInput = document.getElementById(inputId);
			const optionsDiv = document.getElementById(optionsId);
			const searchTerm = searchInput.value.toLowerCase();
			
			if (searchTerm.length < 1) {
				optionsDiv.style.display = 'none';
				return;
			}
			
			const activeLocations = locations.filter(loc => 
				(loc.active === "1" || loc.active === true || loc.active === "כן") &&
				loc.name.toLowerCase().includes(searchTerm)
			);
			
			if (activeLocations.length === 0) {
				optionsDiv.innerHTML = '<div style="padding: 10px; color: #666;">אין לקוחות תואמים</div>';
				optionsDiv.style.display = 'block';
				return;
			}
			
			// זיהוי איזה טופס קורא (לפי ה-ID)
			let selectFunction = 'selectModalClient'; // ברירת מחדל - טופס ישן
			
			if (inputId === 'visitFormClientSearch') {
				selectFunction = 'selectVisitFormClient'; // טופס חדש מאוחד
			}
			
			let optionsHTML = '';
			activeLocations.slice(0, 10).forEach(location => {
				const safeName = (location.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
				const safeAddress = (location.full_address || 'ללא כתובת').replace(/'/g, "\\'").replace(/"/g, '&quot;');
				
				optionsHTML += `
					<div class="client-option" onclick="${selectFunction}('${location.ID}', '${safeName}')">
						<strong>${safeName}</strong>
						<div style="font-size: 12px; color: #666;">${safeAddress}</div>
					</div>
				`;
			});

			optionsDiv.innerHTML = optionsHTML;
			optionsDiv.style.display = 'block';
		}


		///>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

		
	///   פונקציות תשלומים   //////////
	
		// טעינת אפשרויות סינון תשלומים
		function loadPaymentFilterOptions() {
			const clientSelect = document.getElementById('filterPaymentClient');
			
			if (clientSelect) {
				clientSelect.innerHTML = '<option value="">כל הלקוחות</option>';
				
				// Create unique client list from payments
				const uniqueClients = [...new Set(payments.map(p => p.client_name).filter(name => name))];
				uniqueClients.sort().forEach(clientName => {
					clientSelect.innerHTML += `<option value="${clientName}">${clientName}</option>`;
				});
			}
		}

		// סינון תשלומים
		function applyPaymentFilters() {
			// Check if smart search is active
			const smartSearch = document.getElementById('paymentSmartSearch')?.value;
			if (smartSearch && smartSearch.trim()) {
				handlePaymentSmartSearch(smartSearch);
				return;
			}
			
			// Get filter values with null safety
			const clientFilter = document.getElementById('filterPaymentClient')?.value || '';
			const dateFromFilter = document.getElementById('filterPaymentDateFrom')?.value || '';
			const dateToFilter = document.getElementById('filterPaymentDateTo')?.value || '';
			const linkStatusFilter = document.getElementById('filterPaymentLinkStatus')?.value || '';
			
			let filteredPayments = [...payments];
			
			// Filter by client
			if (clientFilter) {
				filteredPayments = filteredPayments.filter(p => p.client_name === clientFilter);
			}
			
			// Filter by date range
			if (dateFromFilter) {
				filteredPayments = filteredPayments.filter(p => p.date >= dateFromFilter);
			}
			if (dateToFilter) {
				filteredPayments = filteredPayments.filter(p => p.date <= dateToFilter);
			}
			
			// ✅ NEW: Filter by link status
			if (linkStatusFilter) {
				filteredPayments = filteredPayments.filter(payment => {
					const linkStatus = getPaymentLinkStatus(payment.ID);
					return linkStatus.status === linkStatusFilter;
				});
			}
			
			// Sort by date - newest first
			filteredPayments.sort((a, b) => new Date(b.date) - new Date(a.date));

			displayPayments(filteredPayments);
			updatePaymentsStats(filteredPayments);
		}

		// ✅ Calculate payment link status
		function getPaymentLinkStatus(paymentId) {
			const payment = payments.find(p => p.ID === paymentId);
			if (!payment) return { status: 'unknown', allocated: 0, available: 0, percentage: 0 };
			
			const paymentAmount = parseFloat(payment.amount) || 0;
			const links = paymentVisitLinks.filter(link => link.payment_id === paymentId);
			const allocatedAmount = links.reduce((sum, link) => sum + (parseFloat(link.amount_allocated) || 0), 0);
			const availableAmount = paymentAmount - allocatedAmount;
			const percentage = paymentAmount > 0 ? (allocatedAmount / paymentAmount) * 100 : 0;
			
			let status = 'unlinked';
			if (allocatedAmount >= paymentAmount - 0.01) {
				status = 'fully_linked';
			} else if (allocatedAmount > 0) {
				status = 'partially_linked';
			}
			
			return {
				status: status,
				allocated: allocatedAmount,
				available: availableAmount,
				percentage: percentage,
				linksCount: links.length
			};
		}
		
		// ✅ Get status display
		function getPaymentStatusDisplay(status) {
			switch(status) {
				case 'fully_linked':
					return { icon: '🟢', text: 'מקושר מלא', color: '#e8f5e9', textColor: '#2e7d32' };
				case 'partially_linked':
					return { icon: '🟡', text: 'מקושר חלקית', color: '#fff9c4', textColor: '#f57c00' };
				case 'unlinked':
					return { icon: '🔴', text: 'ממתין לקישור', color: '#ffebee', textColor: '#c62828' };
				default:
					return { icon: '⚪', text: 'לא ידוע', color: '#f5f5f5', textColor: '#666' };
			}
		}


		// הצגת תשלומים בטבלה
		function displayPayments(paymentsToShow = payments) {
			const tbody = document.querySelector('#paymentsTable tbody');
			if (!tbody) return;
			
			tbody.innerHTML = '';
			
			if (paymentsToShow.length === 0) {
				tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #666;">אין תשלומים להצגה</td></tr>';
				updatePaymentsStats([]);
				return;
			}
			
			paymentsToShow.forEach(payment => {
				// פירוט אמצעי תשלום משופר
				let paymentMethodText = '';
				switch(payment.payment_method) {
					case 'cash': paymentMethodText = 'מזומן'; break;
					case 'check': paymentMethodText = 'צ\'ק'; break;
					case 'transfer': paymentMethodText = 'העברה'; break;
					case 'app': paymentMethodText = 'אפליקציה'; break;
					default: paymentMethodText = payment.payment_method || 'לא צוין';
				}
				
				// הוספת אסמכתא אם קיימת
				if (payment.reference) {
					paymentMethodText += ` (${payment.reference})`;
				}
				
				// ✅ Get payment link status
				const linkStatus = getPaymentLinkStatus(payment.ID);
				const statusDisplay = getPaymentStatusDisplay(linkStatus.status);
				
				// Main row
				const mainRow = document.createElement('tr');
				mainRow.className = 'main-row';
				
				mainRow.innerHTML = `
					<td><strong>${formatDate(payment.date)}</strong></td>
					<td>${payment.client_name || 'לא ידוע'}</td>
					<td style="color: #27ae60; font-weight: bold;">₪${payment.amount.toLocaleString()}</td>
					<td>
						<div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; background: white; border-radius: 6px; border-right: 3px solid ${statusDisplay.textColor};">
							<span style="font-size: 14px;">${statusDisplay.icon}</span>
							<div style="text-align: right;">
								<div style="font-size: 11px; font-weight: 600; color: ${statusDisplay.textColor};">${statusDisplay.text}</div>
								${linkStatus.linksCount > 0 ? 
									`<div style="font-size: 9px; color: #666;">${linkStatus.linksCount} טיפולים</div>` 
									: ''}
							</div>
						</div>
					</td>
					<td>
						<button onclick="showPaymentDetails('${payment.ID}')" class="action-btn" style="background: #3498db; color: white;" title="פירוט מלא">🔍</button>
						${payment.receipt_id 
							? '<span style="color: #27ae60; font-size: 12px; margin-right: 5px;">🧾</span>' 
							: `<button onclick="createReceiptFromPayment('${payment.ID}')" style="padding: 4px 8px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 5px;">🧾</button>`
						}
					</td>
				`;
				
				// ✅ Add background color to row
				mainRow.style.background = statusDisplay.color;
				tbody.appendChild(mainRow);
				
				// Details row - ✅ ENHANCED with linked visits
				const detailsRow = document.createElement('tr');
				detailsRow.className = 'details-row';
				
				// Get linked visits
				const links = paymentVisitLinks.filter(link => link.payment_id === payment.ID);
				const linkedVisitsHTML = links.length > 0 ? `
					<div class="detail-item" style="grid-column: 1 / -1; margin-top: 10px;">
						<span class="detail-label">🔗 מקושר לטיפולים:</span>
						<div style="margin-top: 8px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
							${links.map(link => {
								const visit = visits.find(v => v.ID === link.visit_id);
								if (!visit) return '';
								
								const isPartial = parseFloat(link.amount_allocated) < parseFloat(visit.amount);
								
								return `
									<div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #e9ecef;">
										<div style="flex: 1;">
											<span style="font-size: 11px; color: #666;">${formatDate(visit.date)}</span>
											<span style="font-size: 12px; color: #333; margin-right: 10px;">${visit.work_done || 'ללא תיאור'}</span>
										</div>
										<div style="text-align: left;">
											<span style="font-size: 13px; font-weight: 600; color: #27ae60;">${parseFloat(link.amount_allocated).toFixed(0)} ₪</span>
											${isPartial ? '<span style="font-size: 10px; color: #f39c12; margin-right: 5px;">(חלקי)</span>' : ''}
										</div>
									</div>
								`;
							}).join('')}
							<div style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #dee2e6; display: flex; justify-content: space-between; font-weight: 600;">
								<span>סה"כ מקושר:</span>
								<span style="color: #27ae60;">${linkStatus.allocated.toFixed(0)} ₪</span>
							</div>
							${linkStatus.available > 0.01 ? `
								<div style="display: flex; justify-content: space-between; color: #f39c12; margin-top: 5px;">
									<span>זמין לקישור:</span>
									<span style="font-weight: 600;">${linkStatus.available.toFixed(0)} ₪</span>
								</div>
							` : ''}
						</div>
					</div>
				` : '';
				
				detailsRow.innerHTML = `
					<td colspan="5">
						<div class="details-content">
							<div class="detail-item">
								<span class="detail-label">אופן:</span>
								<span class="detail-value">${paymentMethodText}</span>
							</div>
							${payment.notes && payment.notes.trim() ? `
							<div class="detail-item" style="grid-column: 1 / -1;">
								<span class="detail-label">הערות:</span>
								<span class="detail-value">${payment.notes}</span>
							</div>
							` : ''}
							${linkedVisitsHTML}
							${linkStatus.available > 0.01 && payment.client_id ? `
							<div class="detail-item" style="grid-column: 1 / -1; margin-top: 10px;">
								<button onclick="showLinkPaymentModalFromPayments('${payment.ID}')" class="btn" style="background: #9b59b6; color: white; width: 100%;">
									💳 קשר עוד טיפולים (${linkStatus.available.toFixed(0)} ₪ זמין)
								</button>
							</div>
							` : ''}
						</div>
					</td>
				`;
				tbody.appendChild(detailsRow);
			});
			
			updatePaymentsStats(paymentsToShow);
			
			// Initialize expandable rows
			setTimeout(() => {
				initExpandableTable('paymentsTable');
			}, 100);
		}

		// עדכון סטטיסטיקות תשלומים
		function updatePaymentsStats(filteredPayments) {
			const count = filteredPayments.length;
			const total = filteredPayments.reduce((sum, payment) => sum + (parseFloat(payment.amount) || 0), 0);
			const average = count > 0 ? Math.round(total / count) : 0;
			
			document.getElementById('paymentsCount').textContent = count;
			document.getElementById('paymentsTotal').textContent = `₪${Math.round(total).toLocaleString()}`;
			document.getElementById('paymentsAverage').textContent = `₪${average.toLocaleString()}`;
		}

		// ניקוי סינונים
		function clearPaymentFilters() {
			document.getElementById('filterPaymentClient').value = '';
			document.getElementById('filterPaymentDateFrom').value = '';
			document.getElementById('filterPaymentDateTo').value = '';
			
			// ניקוי החיפוש החכם
			if (document.getElementById('paymentSmartSearch')) {
				document.getElementById('paymentSmartSearch').value = '';
			}
			
			applyPaymentFilters();
		}


		// הצגת פירוט תשלום
		function showPaymentDetails(paymentId) {
			const payment = payments.find(p => p.ID === paymentId);
			if (!payment) {
				showToast('תשלום לא נמצא', 'error');
				console.log('❌ Payment not found. paymentId:', paymentId);
				console.log('Total payments in array:', payments.length);
				console.log('Sample payment IDs:', payments.slice(0, 3).map(p => p.ID));
				return;
			}
			
			// מצא טיפולים קשורים לתשלום
			const relatedLinks = paymentVisitLinks.filter(link => link.payment_id === paymentId);
			const relatedVisits = relatedLinks.map(link => {
				const visit = visits.find(visit => visit.ID === link.visit_id);
				if (visit) {
					return {
						...visit,
						allocated_amount: link.amount_allocated || 0
					};
				}
				return null;
			}).filter(visit => visit);
			
			// חישוב סכום מקושר
			const totalAllocated = relatedLinks.reduce((sum, link) => sum + (link.amount_allocated || 0), 0);
			const unallocated = payment.amount - totalAllocated;
			
			// טקסט אמצעי תשלום
			let methodText = '';
			switch(payment.payment_method) {
				case 'cash': methodText = 'מזומן'; break;
				case 'check': methodText = 'צ\'ק'; break;
				case 'transfer': methodText = 'העברה בנקאית'; break;
				case 'app': methodText = 'אפליקציה (ביט/פייבוקס)'; break;
				default: methodText = payment.payment_method || 'לא צויין';
			}
			
			const modalContent = `
				<div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto; direction: rtl;">
					<div style="position: relative;">
						<button onclick="closeAnyModal()" style="position: absolute; top: 0; left: 0; background: #e74c3c; border: none; color: white; font-size: 20px; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">×</button>
						<h3 style="margin-bottom: 25px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
							💳 פרטי תשלום
						</h3>
					</div>
					
					<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px; color: white;">
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
							<span style="font-size: 14px; opacity: 0.9;">סכום התשלום:</span>
							<span style="font-size: 28px; font-weight: bold;">₪${Math.round(payment.amount).toLocaleString()}</span>
						</div>
						<div style="font-size: 13px; opacity: 0.8;">
							📅 ${formatDate(payment.date)}
						</div>
					</div>
					
					<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
						<div style="margin-bottom: 15px;">
							<strong style="color: #666; font-size: 12px; display: block; margin-bottom: 5px;">👤 לקוח:</strong>
							<div style="font-size: 16px; color: #2c3e50;">${payment.client_name || 'לא ידוע'}</div>
						</div>
						
						<div style="margin-bottom: 15px;">
							<strong style="color: #666; font-size: 12px; display: block; margin-bottom: 5px;">💳 אמצעי תשלום:</strong>
							<div style="font-size: 16px; color: #2c3e50;">${methodText}</div>
						</div>
						
						${payment.reference ? `
							<div style="margin-bottom: 15px;">
								<strong style="color: #666; font-size: 12px; display: block; margin-bottom: 5px;">🔢 אסמכתא:</strong>
								<div style="font-size: 16px; color: #2c3e50;">${payment.reference}</div>
							</div>
						` : ''}
						
						${payment.check_date ? `
							<div style="margin-bottom: 15px;">
								<strong style="color: #666; font-size: 12px; display: block; margin-bottom: 5px;">📆 תאריך פירעון צ'ק:</strong>
								<div style="font-size: 16px; color: #2c3e50;">${formatDate(payment.check_date)}</div>
							</div>
						` : ''}
						
						${payment.notes ? `
							<div>
								<strong style="color: #666; font-size: 12px; display: block; margin-bottom: 5px;">📝 הערות:</strong>
								<div style="font-size: 14px; color: #555; line-height: 1.6;">${payment.notes}</div>
							</div>
						` : ''}
					</div>
					
					<div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #27ae60;">
						<h4 style="margin: 0 0 15px 0; color: #27ae60; font-size: 16px;">🔗 טיפולים מקושרים:</h4>
						
						${relatedVisits.length > 0 ? 
							relatedVisits.map(visit => {
								const link = relatedLinks.find(l => l.visit_id === visit.ID);
								return `
								<div style="padding: 12px; background: white; border-radius: 6px; margin-bottom: 10px; border-right: 4px solid #27ae60; position: relative;">
									<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
										<strong style="color: #2c3e50;">${formatDate(visit.date)}</strong>
										<div style="display: flex; align-items: center; gap: 8px;">
											<span style="background: #27ae60; color: white; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: bold;">
												₪${visit.allocated_amount.toFixed(0)}
											</span>
											<button onclick="unlinkPaymentFromVisit('${link.ID}', '${payment.ID}')" style="background: #e74c3c; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;" title="נתק קישור">
												❌ נתק
											</button>
										</div>
									</div>
									<div style="font-size: 13px; color: #666;">
										${visit.work_done || 'ללא תיאור'}
									</div>
									${visit.allocated_amount < visit.amount ? `
										<div style="font-size: 11px; color: #f39c12; margin-top: 5px;">
											⚠️ תשלום חלקי - חוב נותר: ₪${(visit.amount - visit.allocated_amount).toFixed(0)}
										</div>
									` : ''}
								</div>
							`;
							}).join('') 
							: '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">אין טיפולים מקושרים לתשלום זה</div>'
						}
						
						${relatedVisits.length > 0 ? `
							<div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #27ae60; display: flex; justify-content: space-between; font-size: 14px;">
								<span><strong>סכום מקושר:</strong></span>
								<span style="color: #27ae60; font-weight: bold;">₪${totalAllocated.toFixed(2)}</span>
							</div>
							${unallocated > 0.01 ? `
								<div style="display: flex; justify-content: space-between; font-size: 14px; margin-top: 5px;">
									<span><strong>סכום לא מקושר:</strong></span>
									<span style="color: #f39c12; font-weight: bold;">₪${unallocated.toFixed(2)}</span>
								</div>
							` : ''}
						` : ''}
					</div>
					
					<!-- Action Buttons -->
					<div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
						${payment.client_id ? `
							<button onclick="closeAnyModal(); showLinkPaymentModalFromPayments('${payment.ID}')" style="flex: 1; min-width: 200px; background: #9b59b6; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
								💳 ${relatedVisits.length > 0 ? 'קשר עוד טיפולים' : 'קשר לטיפולים'}
							</button>
						` : ''}
						<button onclick="editPaymentDetails('${payment.ID}')" style="flex: 1; min-width: 150px; background: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
							✏️ ערוך תשלום
						</button>
						<button onclick="deletePayment('${payment.ID}')" style="flex: 1; min-width: 150px; background: ${relatedVisits.length > 0 ? '#95a5a6' : '#e74c3c'}; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;" ${relatedVisits.length > 0 ? 'disabled title="לא ניתן למחוק תשלום מקושר"' : ''}>
							🗑️ מחק תשלום
						</button>
					</div>
					
					<div style="text-align: center; margin-top: 15px;">
						<button onclick="closeAnyModal()" style="background: #95a5a6; color: white; border: none; padding: 10px 30px; border-radius: 6px; cursor: pointer; font-size: 14px;">
							סגור
						</button>
					</div>
				</div>
			`;
			
			showModal(modalContent);
		}

		// ✅ Edit payment details
		function editPaymentDetails(paymentId) {
			const payment = payments.find(p => p.ID === paymentId);
			if (!payment) {
				showToast('❌ תשלום לא נמצא', 'error');
				return;
			}
			
			// Close current modal
			closeAnyModal();
			
			// Show edit modal
			const modalContent = `
				<div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90vw; direction: rtl;">
					<h3 style="margin-bottom: 25px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
						✏️ עריכת תשלום
					</h3>
					
					<div style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">תאריך:</label>
						<input type="date" id="editPaymentDate" value="${payment.date}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
					</div>
					
					<div style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">סכום (₪):</label>
						<input type="number" id="editPaymentAmount" value="${payment.amount}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
					</div>
					
					<div style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">אמצעי תשלום:</label>
						<select id="editPaymentMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
							<option value="cash" ${payment.payment_method === 'cash' || payment.payment_method === 'מזומן' ? 'selected' : ''}>מזומן</option>
							<option value="check" ${payment.payment_method === 'check' || payment.payment_method === 'צ\'ק' ? 'selected' : ''}>צ'ק</option>
							<option value="transfer" ${payment.payment_method === 'transfer' || payment.payment_method === 'העברה' ? 'selected' : ''}>העברה בנקאית</option>
							<option value="app" ${payment.payment_method === 'app' || payment.payment_method === 'אפליקציה' ? 'selected' : ''}>אפליקציה (ביט/פייבוקס)</option>
						</select>
					</div>
					
					<div style="margin-bottom: 20px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">אסמכתא (אופציונלי):</label>
						<input type="text" id="editPaymentReference" value="${payment.reference || ''}" placeholder="מספר צ'ק / העברה" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
					</div>
					
					<div style="margin-bottom: 25px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">הערות (אופציונלי):</label>
						<textarea id="editPaymentNotes" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;">${payment.notes || ''}</textarea>
					</div>
					
					<div style="display: flex; gap: 10px; justify-content: flex-end;">
						<button onclick="closeAnyModal()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
							ביטול
						</button>
						<button onclick="saveEditedPayment('${payment.ID}')" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
							💾 שמור שינויים
						</button>
					</div>
				</div>
			`;
			
			showModal(modalContent);
		}
		
		// ✅ Save edited payment
		async function saveEditedPayment(paymentId) {
			const payment = payments.find(p => p.ID === paymentId);
			if (!payment) {
				showToast('❌ תשלום לא נמצא', 'error');
				return;
			}
			
			// Get values
			const date = document.getElementById('editPaymentDate').value;
			const amount = parseFloat(document.getElementById('editPaymentAmount').value);
			const paymentMethod = document.getElementById('editPaymentMethod').value;
			const reference = document.getElementById('editPaymentReference').value;
			const notes = document.getElementById('editPaymentNotes').value;
			
			// Validate
			if (!date || !amount || amount <= 0) {
				showToast('⚠️ נא למלא תאריך וסכום תקינים', 'warning');
				return;
			}
			
			// Check if reducing amount below allocated
			const links = paymentVisitLinks.filter(link => link.payment_id === paymentId);
			const totalAllocated = links.reduce((sum, link) => sum + (parseFloat(link.amount_allocated) || 0), 0);
			
			if (amount < totalAllocated) {
				showToast(`⚠️ לא ניתן להקטין סכום מתחת ל-${totalAllocated.toFixed(0)} ₪ (סכום מקושר)`, 'warning');
				return;
			}
			
			try {
				showLoading('שומר שינויים...');
				
				// Update payment in array
				payment.date = date;
				payment.amount = amount;
				payment.payment_method = translatePaymentMethod(paymentMethod);
				payment.reference = reference;
				payment.notes = notes;
				
				// Save locally
				saveToLocalStorage();
				
				// ✅ FIXED: Use updateSinglePaymentInSheets instead of savePaymentsBatch
				if (access_token && SPREADSHEET_ID) {
					await updateSinglePaymentInSheets(payment);
				}
				
				hideLoading();
				showToast('✅ תשלום עודכן בהצלחה', 'success');
				
				closeAnyModal();
				
				// Refresh displays
				if (typeof displayPayments === 'function') displayPayments();
				if (typeof displayDebts === 'function') displayDebts();
				
			} catch (error) {
				console.error('Error saving payment:', error);
				showToast('❌ שגיאה בשמירת תשלום', 'error');
				hideLoading();
			}
		}

		// ✅ Unlink payment from visit
		async function unlinkPaymentFromVisit(linkId, paymentId) {
			const link = paymentVisitLinks.find(l => l.ID === linkId);
			if (!link) {
				showToast('❌ קישור לא נמצא', 'error');
				return;
			}
			
			const visit = visits.find(v => v.ID === link.visit_id);
			const visitName = visit ? (visit.work_done || formatDate(visit.date)) : 'טיפול';
			
			if (!confirm(`האם לנתק את הקישור לטיפול:\n${visitName}\n(${link.amount_allocated} ₪)?`)) {
				return;
			}
			
			try {
				showLoading('מנתק קישור...');
				
				// Remove link
				const linkIndex = paymentVisitLinks.findIndex(l => l.ID === linkId);
				if (linkIndex > -1) {
					paymentVisitLinks.splice(linkIndex, 1);
				}
				
				// Update visit paid status
				if (visit) {
					const totalPaid = getVisitPaidAmount(visit.ID);
					const visitAmount = parseFloat(visit.amount);
					
					if (totalPaid <= 0) {
						// No payment at all
						visit.paid = 'no';
					} else if (totalPaid >= visitAmount - 0.01) {
						// Still fully paid (from other payments)
						const otherLinks = paymentVisitLinks.filter(l => l.visit_id === visit.ID);
						if (otherLinks.length > 0) {
							const lastLink = otherLinks[otherLinks.length - 1];
							const lastPayment = payments.find(p => p.ID === lastLink.payment_id);
							visit.paid = `paid:${lastPayment ? lastPayment.date : ''}`;
						} else {
							visit.paid = 'no';
						}
					} else {
						// Partial payment
						visit.paid = `partial:${totalPaid.toFixed(2)}`;
					}
				}
				
				// Save
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					try {
						await savePaymentVisitLinksBatch(paymentVisitLinks);
						if (visit) {
							await updateMultipleVisitsInSheets([visit]);
						}
					} catch (error) {
						console.error('Error saving to cloud:', error);
					}
				}
				
				hideLoading();
				showToast('✅ קישור נותק בהצלחה', 'success');
				
				// Close and reopen modal with updated data
				closeAnyModal();
				setTimeout(() => showPaymentDetails(paymentId), 300);
				
				// Refresh
				if (typeof displayPayments === 'function') displayPayments();
				if (typeof displayDebts === 'function') displayDebts();
				if (typeof displayVisits === 'function') displayVisits();
				
			} catch (error) {
				console.error('Error unlinking payment:', error);
				showToast('❌ שגיאה בניתוק קישור', 'error');
				hideLoading();
			}
		}
		
		// ✅ Delete payment
		async function deletePayment(paymentId) {
			const payment = payments.find(p => p.ID === paymentId);
			if (!payment) {
				showToast('❌ תשלום לא נמצא', 'error');
				return;
			}
			
			// Check if linked
			const links = paymentVisitLinks.filter(link => link.payment_id === paymentId);
			if (links.length > 0) {
				showToast('⚠️ לא ניתן למחוק תשלום מקושר. נתק תחילה את כל הקישורים.', 'warning');
				return;
			}
			
			const clientName = payment.client_name || 'לא ידוע';
			const confirmMsg = `האם למחוק את התשלום?\n\nלקוח: ${clientName}\nסכום: ${payment.amount} ₪\nתאריך: ${formatDate(payment.date)}\n\n⚠️ פעולה זו בלתי הפיכה!`;
			
			if (!confirm(confirmMsg)) {
				return;
			}
			
			try {
				showLoading('מוחק תשלום...');
				
				// Remove payment
				const paymentIndex = payments.findIndex(p => p.ID === paymentId);
				if (paymentIndex > -1) {
					payments.splice(paymentIndex, 1);
				}
				
				// Save
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					await savePaymentsBatch(payments);
				}
				
				hideLoading();
				showToast('✅ תשלום נמחק בהצלחה', 'success');
				
				closeAnyModal();
				
				// Refresh
				if (typeof displayPayments === 'function') displayPayments();
				if (typeof displayDebts === 'function') displayDebts();
				
			} catch (error) {
				console.error('Error deleting payment:', error);
				showToast('❌ שגיאה במחיקת תשלום', 'error');
				hideLoading();
			}
		}


		// טעינת טאב תשלומים
		function loadPayments() {
			loadPaymentFilterOptions();
			applyPaymentFilters();
		}

		// פונקציה לחישוב תשלום אחרון של לקוח
		function getLastPaymentDate(locationId) {
			const clientPayments = payments.filter(p => p.client_id === locationId);
			
			if (clientPayments.length === 0) {
				return null;
			}
			
			// מיון לפי תאריך - האחרון ראשון
			clientPayments.sort((a, b) => new Date(b.date) - new Date(a.date));
			
			return clientPayments[0].date;
		}

		// פונקציה לפורמט תצוגת תשלום אחרון
		function formatLastPayment(locationId) {
			const lastPaymentDate = getLastPaymentDate(locationId);
			
			if (!lastPaymentDate) {
				return '<span style="color: #999; font-size: 12px;">אין תשלומים</span>';
			}
			
			const daysSince = Math.floor((new Date() - new Date(lastPaymentDate)) / (1000 * 60 * 60 * 24));
			const color = daysSince > 90 ? '#e74c3c' : daysSince > 30 ? '#f39c12' : '#27ae60';
			
			return `
				<div style="text-align: center;">
					<div style="font-size: 12px;">${formatDate(lastPaymentDate)}</div>
					<div style="color: ${color}; font-size: 11px; font-weight: bold;">
						${daysSince === 0 ? 'היום' : daysSince === 1 ? 'אתמול' : `לפני ${daysSince} ימים`}
					</div>
				</div>
			`;
		}


		
		// פונקציה לקבלת שם לקוח לפי ID
		function getClientNameById(clientId) {
			const location = locations.find(loc => loc.ID === clientId);
			return location ? location.name : null;
		}


		// שמירת הכנסות בקבוצה
		async function saveIncomesBatch(incomesArray) {
			if (!incomesArray.length || !access_token || !SPREADSHEET_ID) {
				return false;
			}
			
			try {
				const values = incomesArray.map(income => [
					income.ID,
					income.date,
					income.time || '',
					income.client_address,
					income.client_id || '',
					income.amount,
					income.payment_method,
					income.notes || '',
					income.raw_text || '',
					income.imported_from || 'manual',
					income.import_date || getLocalDateString(),
					income.matched_to_visit || false
				]);
				
				await gapi.client.sheets.spreadsheets.values.append({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Incomes!A:L',
					valueInputOption: 'USER_ENTERED',
					resource: { values }
				});
				
				console.log(`✅ נשמרו ${incomesArray.length} הכנסות בענן`);
				return true;
				
			} catch (error) {
				console.error('שגיאה בשמירת הכנסות בקבוצה:', error);
				return false;
			}
		}		


		// חיפוש חכם לקוחות - החלפת הפונקציה הקיימת
		function searchClientsAdvanced(searchTerm) {
			if (!searchTerm || searchTerm.trim() === '') {
				return locations.filter(location => location.active === "1").slice(0, 10);
			}
			
			const term = searchTerm.toLowerCase().trim();
			
			return locations
				.filter(location => location.active === "1")
				.filter(location => {
					const name = (location.name || '').toLowerCase();
					const address = (location.full_address || '').toLowerCase();
					const city = (location.city || '').toLowerCase();
					const neighborhood = (location.neighborhood || '').toLowerCase();
					const contact = (location.contact_person || '').toLowerCase();
					
					// חיפוש חלקי בכל השדות הרלוונטיים
					return name.includes(term) || 
						   address.includes(term) || 
						   city.includes(term) ||
						   neighborhood.includes(term) ||
						   contact.includes(term);
				})
				.slice(0, 15); // הגדלת מספר התוצאות ל-15
		}



		// עדכון טיפולים נבחרים וחישוב סכום
		function updateSelectedVisits() {
			const checkboxes = document.querySelectorAll('.visit-checkbox:checked');
			selectedVisitIds = Array.from(checkboxes).map(cb => cb.value);
			
			let totalAmount = 0;
			selectedVisitIds.forEach(visitId => {
				const visit = visits.find(v => v.ID === visitId);
				if (visit) {
					totalAmount += parseFloat(visit.amount) || 0;
				}
			});
			
			document.getElementById('selectedAmount').textContent = totalAmount.toLocaleString();
			document.getElementById('selectedCount').textContent = selectedVisitIds.length;
			
			// הצגת פרטי התשלום אם יש טיפולים נבחרים
			if (selectedVisitIds.length > 0) {
				document.getElementById('paymentDetailsSection').style.display = 'block';
				document.getElementById('savePaymentBtn').disabled = false;
				
				// עדכון הערות אוטומטי
				const selectedDates = selectedVisitIds.map(visitId => {
					const visit = visits.find(v => v.ID === visitId);
					return visit ? formatDate(visit.date) : '';
				}).filter(date => date);
				
				document.getElementById('paymentNotes').value = 
					`תשלום עבור ${selectedVisitIds.length} טיפולים: ${selectedDates.join(', ')}`;
			} else {
				document.getElementById('paymentDetailsSection').style.display = 'none';
				document.getElementById('savePaymentBtn').disabled = true;
			}
		}



		// מחיקת תשלומים הקשורים לטיפול
		function removePaymentsForVisit(visitId) {
			const linksToRemove = paymentVisitLinks.filter(link => link.visit_id === visitId);
			
			linksToRemove.forEach(link => {
				// הסר את הקישור
				const linkIndex = paymentVisitLinks.findIndex(l => l.ID === link.ID);
				if (linkIndex > -1) {
					paymentVisitLinks.splice(linkIndex, 1);
				}
				
				// בדוק אם התשלום קשור לטיפולים נוספים
				const otherLinks = paymentVisitLinks.filter(l => l.payment_id === link.payment_id);
				
				// אם אין קישורים נוספים, מחק את התשלום
				if (otherLinks.length === 0) {
					const paymentIndex = payments.findIndex(p => p.ID === link.payment_id);
					if (paymentIndex > -1) {
						payments.splice(paymentIndex, 1);
					}
				}
			});
		}


		// פונקציית עזר לתרגום אמצעי תשלום
		function getPaymentMethodText(method) {
			const methods = {
				'cash': 'מזומן',
				'check': 'צ\'ק',
				'transfer': 'העברה בנקאית',
				'app': 'אפליקציה'
			};
			return methods[method] || method;
		}

		// פונקציית עזר להצגת מודאל כללי
		function showModal(content) {
			// הסר מודל קיים אם יש
			const existingModal = document.getElementById('telegramModal');
			if (existingModal) {
				existingModal.remove();
			}
			
			// צור מודל
			const modal = document.createElement('div');
			modal.id = 'telegramModal';
			modal.style.cssText = `
				position: fixed !important;
				top: 0 !important;
				left: 0 !important;
				width: 100% !important;
				height: 100% !important;
				background: rgba(0,0,0,0.7) !important;
				display: flex !important;
				justify-content: center !important;
				align-items: center !important;
				z-index: 10001 !important;
			`;
			
			modal.innerHTML = content;
			document.body.appendChild(modal);
			
			// סגירה בלחיצה על הרקע
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					closeAnyModal();
				}
			});
		}

		// חיפוש חכם בטיפולים
		function handleVisitSmartSearch(searchTerm) {
			if (!searchTerm.trim()) {
				// אם אין מונח חיפוש, הצג הכל
				applyVisitFilters();
				return;
			}
			
			// מציאת לקוחות מתאימים
			const matchingClients = searchClientsAdvanced(searchTerm);
			const clientIds = matchingClients.map(client => client.ID);
			
			if (clientIds.length === 0) {
				displayFilteredVisits([]);
				updateTreatmentsStats([]);
				return;
			}
			
			// סינון הטיפולים לפי הלקוחות שנמצאו
			let filteredVisits = visits.filter(visit => clientIds.includes(visit.location_id));
			
			// החלת הסינונים הרגילים (תאריכים, תשלומים) על התוצאות
			filteredVisits = applyAdditionalFiltersToVisits(filteredVisits);
			
			displayFilteredVisits(filteredVisits);
			updateTreatmentsStats(filteredVisits);
		}

		// ניקוי חיפוש חכם
		function clearVisitSmartSearch() {
			const searchInput = document.getElementById('visitSmartSearch');
			if (searchInput) {
				searchInput.value = '';
			}
			applyVisitFilters();
		}

		// פונקציה לhחלת הסינונים הרגילים על קבוצה מסוימת של ביקורים
		function applyAdditionalFiltersToVisits(visitsArray) {
			let filtered = [...visitsArray];
			
			// סינון לפי תשלום
			const paymentFilter = document.getElementById('filterPayment')?.value;
			if (paymentFilter) {
				filtered = filtered.filter(visit => {
					const paymentStatus = getVisitPaymentStatus(visit.ID);
					switch(paymentFilter) {
						case 'כן': return paymentStatus === 'paid';
						case 'לא': return paymentStatus === 'unpaid';
						case 'ללא': return paymentStatus === 'no_payment';
						default: return true;
					}
				});
			}
			
			// סינון לפי תאריך
			const dateFrom = document.getElementById('filterDateFrom')?.value;
			const dateTo = document.getElementById('filterDateTo')?.value;
			
			if (dateFrom) {
				filtered = filtered.filter(visit => visit.date >= dateFrom);
			}
			if (dateTo) {
				filtered = filtered.filter(visit => visit.date <= dateTo);
			}
			
			return filtered;
		}

		
		// חיפוש חכם בתשלומים
		function handlePaymentSmartSearch(searchTerm) {
			if (!searchTerm.trim()) {
				applyPaymentFilters();
				return;
			}
			
			// מציאת לקוחות מתאימים
			const matchingClients = searchClientsAdvanced(searchTerm);
			const clientNames = matchingClients.map(client => client.name);
			
			if (clientNames.length === 0) {
				displayPayments([]);
				updatePaymentsStats([]);
				return;
			}
			
			// סינון התשלומים לפי הלקוחות שנמצאו
			let filteredPayments = payments.filter(payment => 
				clientNames.some(name => 
					payment.client_name && payment.client_name.includes(name)
				)
			);
			
			// החלת הסינונים הרגילים
			filteredPayments = applyAdditionalPaymentFilters(filteredPayments);
			
			displayPayments(filteredPayments);
			updatePaymentsStats(filteredPayments);
		}

		// ניקוי חיפוש חכם בתשלומים
		function clearPaymentSmartSearch() {
			const searchInput = document.getElementById('paymentSmartSearch');
			if (searchInput) {
				searchInput.value = '';
			}
			applyPaymentFilters();
		}

		// פונקציה להחלת סינונים נוספים על תשלומים
		function applyAdditionalPaymentFilters(paymentsArray) {
			let filtered = [...paymentsArray];
			
			// סינון לפי תאריך
			const dateFrom = document.getElementById('filterPaymentDateFrom')?.value;
			const dateTo = document.getElementById('filterPaymentDateTo')?.value;
			
			if (dateFrom) {
				filtered = filtered.filter(p => p.date >= dateFrom);
			}
			if (dateTo) {
				filtered = filtered.filter(p => p.date <= dateTo);
			}
			
			return filtered;
		}

		// Add new function for clearing debt filters:
		function clearDebtFilters() {
			const sortBy = document.getElementById('debtSortBy');
			const minAmount = document.getElementById('minDebtAmount');
			const dayFilter = document.getElementById('debtDayFilter');
			const clientSearch = document.getElementById('debtClientSearch');
			
			if (sortBy) sortBy.value = 'amount_desc';
			if (minAmount) minAmount.value = '';
			if (dayFilter) dayFilter.value = '';
			if (clientSearch) {
				clientSearch.value = '';
				clientSearch.removeAttribute('data-selected-id');
			}
			
			displayDebts();
		}

		// Smart search for receipts
		function handleReceiptSmartSearch(searchTerm) {
			if (!searchTerm.trim()) {
				applyReceiptFilters();
				return;
			}
			
			// Find matching clients
			const matchingClients = searchClientsAdvanced(searchTerm);
			const clientNames = matchingClients.map(client => client.name);
			
			if (clientNames.length === 0) {
				displayFilteredReceipts([]);
				updateReceiptsStats([]);
				return;
			}
			
			// Filter receipts by found clients
			let filteredReceipts = receipts.filter(receipt => 
				clientNames.some(name => 
					receipt.location_name && receipt.location_name.includes(name)
				)
			);
			
			// Apply additional filters
			filteredReceipts = applyAdditionalReceiptFilters(filteredReceipts);
			
			displayFilteredReceipts(filteredReceipts);
			updateReceiptsStats(filteredReceipts);
		}

		// Clear smart search for receipts
		function clearReceiptSmartSearch() {
			document.getElementById('receiptSmartSearch').value = '';
			applyReceiptFilters();
		}

		// Apply additional receipt filters
		function applyAdditionalReceiptFilters(receiptsArray) {
			let filtered = [...receiptsArray];
			
			// Filter by book
			const bookFilter = document.getElementById('filterReceiptBook')?.value;
			if (bookFilter) {
				filtered = filtered.filter(r => r.book_number === bookFilter);
			}
			
			// Filter by payment type
			const paymentFilter = document.getElementById('filterPaymentType')?.value;
			if (paymentFilter) {
				filtered = filtered.filter(r => r.payment_type === paymentFilter);
			}
			
			// Filter by date range
			const dateFrom = document.getElementById('filterReceiptDateFrom')?.value;
			const dateTo = document.getElementById('filterReceiptDateTo')?.value;
			
			if (dateFrom) {
				filtered = filtered.filter(r => r.date >= dateFrom);
			}
			if (dateTo) {
				filtered = filtered.filter(r => r.date <= dateTo);
			}
			
			return filtered;
		}


		// Add this helper function at the top of your script:
		function safeSetHTML(elementId, html) {
			const element = document.getElementById(elementId);
			if (element) {
				element.innerHTML = html;
				return true;
			}
			return false;
		}

		function safeSetValue(elementId, value) {
			const element = document.getElementById(elementId);
			if (element) {
				element.value = value;
				return true;
			}
			return false;
		} 


		document.addEventListener('DOMContentLoaded', function() {
			console.log('App starting...');
			
			// Initialize Google APIs first
			initializeGoogleAPIs();
			
			// Restore filter panel states
			restoreFilterStates();
			
			// Initialize data from local storage
			loadFromLocalStorage();
			
			// Set default section
			showSection('planning');
			
			// Initialize cost settings if they exist
			if (costSettings.hourlyRate) {
				const hourlyRateEl = document.getElementById('hourlyRate');
				if (hourlyRateEl) hourlyRateEl.value = costSettings.hourlyRate;
			}
			
			// ניסיון שחזור Token מ-localStorage
			setTimeout(() => {
				tryRestoreToken();
			}, 1000);
			
			console.log('App initialization complete');
			
			// עדכון סטטוס גיבוי
			setTimeout(updateBackupStatus, 1000);
			
			// תזכורת למאחרים מאתמול - מופעל 3 שניות אחרי טעינה
			setTimeout(() => {
				showYesterdayMissedReminder();
			}, 3000);

		});

	
		
		async function validateToken() {
			if (!access_token || !gapi.client) {
				updateCloudStatus('🔐 לא מחובר לענן', 'נותק');
				return false;
			}

			try {
				// בדיקה פשוטה - נסה לקרוא מהטבלה
				await gapi.client.sheets.spreadsheets.get({
					spreadsheetId: SPREADSHEET_ID || 'test'
				});
				return true;
			} catch (error) {
				if (error.status === 401) {
					console.log('🔴 Google token expired - attempting auto-reconnect');
					
					// מניעת לולאה - בדיקה אם כבר ניסינו להתחבר לאחרונה
					const lastReconnectAttempt = window.lastReconnectAttempt || 0;
					const now = Date.now();
					
					if (now - lastReconnectAttempt < 30000) { // 30 שניות בין ניסיונות
						console.log('⏳ ממתין לפני ניסיון חיבור נוסף...');
						updateCloudStatus('🔑 נדרש חיבור ידני', 'נותק');
						showToast('⚠️ החיבור פג - לחץ על "התחבר לגוגל"', 'warning');
						return false;
					}
					
					window.lastReconnectAttempt = now;
					access_token = null;
					localStorage.removeItem('google_token');
					
					// ניסיון חיבור מחדש אוטומטי
					updateCloudStatus('🔄 מתחבר מחדש...', 'מתחבר');
					showToast('החיבור פג - מנסה להתחבר מחדש...', 'info');
					
					try {
						// חיבור שקט מחדש
						await connectToGoogleSheets();
						return true;
					} catch (reconnectError) {
						console.error('❌ Failed to auto-reconnect:', reconnectError);
						updateCloudStatus('🔑 נדרש חיבור ידני', 'נותק');
						document.getElementById('statusText').classList.remove('connected');
						document.getElementById('saveBtn').disabled = true;
						document.getElementById('loadBtn').disabled = true;
						showToast('⚠️ החיבור פג - לחץ על "התחבר לגוגל"', 'warning');
						return false;
					}
				}
				updateCloudStatus('⚠️ בעיית חיבור לענן', 'שגיאה');
				return false;
			}
		}
		
		
		function updateCloudStatus(status, lastAction) {
			const statusElement = document.getElementById('statusText');
			const lastSavedElement = document.getElementById('lastSaved');
			
			if (statusElement) {
				statusElement.textContent = status;
				
				// הסרת כל ה-classes
				statusElement.classList.remove('connected', 'connecting', 'disconnected', 'warning');
				statusElement.style.background = '';
				statusElement.style.color = '';
				
				// הוספת class מתאים
				if (status.includes('מחובר') || status.includes('מסונכרן')) {
					statusElement.classList.add('connected');
				} else if (status.includes('מתחבר') || status.includes('מרענן')) {
					statusElement.classList.add('connecting');
				} else if (status.includes('שגיאה') || status.includes('נותק')) {
					statusElement.classList.add('disconnected');
				} else if (status.includes('נדרש') || status.includes('פג')) {
					statusElement.classList.add('warning');
				}
			}
			
			// עדכון זמן פעולה אחרונה
			if (lastSavedElement && lastAction) {
				lastSavedElement.textContent = `${lastAction}: ${new Date().toLocaleTimeString('he-IL')}`;
			}
		}
		
		
		// Add this function for the "proceed to payment details" button
		function proceedToPaymentDetails() {
			// בדיקה שנבחרו טיפולים
			if (selectedVisitIds.length === 0) {
				showToast('יש לבחור לפחות טיפול אחד', 'error');
				return;
			}
			
			// מעבר לשלב הבא
			document.getElementById('visitsSelectionSection').style.display = 'none';
			document.getElementById('paymentDetailsSection').style.display = 'block';
			
			// אפשר את כפתור השמירה
			document.getElementById('savePaymentBtn').disabled = false;
			
			// עדכון הכותרת
			const totalAmount = selectedVisitIds.reduce((sum, visitId) => {
				const visit = visits.find(v => v.ID === visitId);
				return sum + (parseFloat(visit?.amount) || 0);
			}, 0);
			
			document.getElementById('paymentModalTitle').textContent = 
				`💰 תשלום ${totalAmount}₪ עבור: ${selectedClient.name}`;
		}


		// Add event listeners to checkboxes when creating visit items
		function loadClientVisitsForPayment(clientId) {
			const clientVisits = visits.filter(visit => 
				visit.location_id === clientId && 
				getVisitPaymentStatus(visit.ID) !== 'paid'
			);
			
			if (clientVisits.length === 0) {
				document.getElementById('visitsList').innerHTML = 
					'<div style="text-align: center; padding: 20px; color: #666;">אין טיפולים פתוחים ללקוח זה</div>';
				return;
			}
			
			const visitsHtml = clientVisits.map(visit => {
				const isPreSelected = selectedVisitIds.includes(visit.ID);
				return `
					<div class="visit-item">
						<input type="checkbox" 
							   class="visit-checkbox" 
							   id="visit_${visit.ID}" 
							   value="${visit.ID}"
							   ${isPreSelected ? 'checked' : ''}
							   onchange="updateSelectedVisitsCount()">
						<div class="visit-details">
							<div style="font-weight: bold;">${formatDate(visit.date)}</div>
							<div style="font-size: 12px; color: #666;">${visit.work_done || 'ללא תיאור'}</div>
						</div>
						<div class="visit-amount">${visit.amount || 0}₪</div>
					</div>
				`;
			}).join('');
			
			document.getElementById('visitsList').innerHTML = visitsHtml;
			
			// עדכון ספירה ראשונית
			updateSelectedVisitsCount();
		}


		// Add this debug function to test if the dates update system works
		function testTreatmentDatesUpdate() {
			console.log('🧪 Testing treatment dates update system...');
			
			// בדוק כמה לקוחות יש
			console.log(`Total locations: ${locations.length}`);
			console.log(`Total visits: ${visits.length}`);
			
			// מצא לקוח עם ביקורים
			const locationsWithVisits = locations.filter(loc => {
				const hasVisits = visits.some(visit => visit.location_id === loc.ID);
				return hasVisits;
			});
			
			console.log(`Locations with visits: ${locationsWithVisits.length}`);
			
			// הצג דוגמאות
			locationsWithVisits.slice(0, 3).forEach(location => {
				const clientVisits = visits.filter(v => v.location_id === location.ID);
				const latestVisit = clientVisits.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
				
				console.log(`👤 ${location.name}:`);
				console.log(`   Last visit in system: ${location.last_visit}`);
				console.log(`   Next visit in system: ${location.next_visit}`);
				console.log(`   Latest actual visit: ${latestVisit ? latestVisit.date : 'none'}`);
				console.log(`   Interval weeks: ${location.interval_weeks || 4}`);
			});
			
			console.log('🧪 Test complete - check console output above');
		}


		// Load and display today's treatments in the work day section
		function loadTodayTreatments() {
			const today = getLocalDateString();
			const todayVisits = visits.filter(visit => visit.date === today)
				.sort((a, b) => {
					const timeA = a.start_time || '23:59';
					const timeB = b.start_time || '23:59';
					return timeA.localeCompare(timeB);
				});
			
			const container = document.getElementById('todayTreatmentsContainer');
			const statusElement = document.getElementById('todayWorkStatus');
			
			// Get today's tasks
			const todayTasks = (typeof tasks !== 'undefined' ? tasks : []).filter(task => 
				task.due_date === today && 
				task.status !== 'completed' && 
				task.status !== 'cancelled'
			);
			
			if (todayVisits.length === 0 && todayTasks.length === 0) {
				container.innerHTML = `
					<div style="text-align: center; padding: 30px; color: #666;">
						<div style="font-size: 48px; margin-bottom: 15px;">🌅</div>
						<div style="font-style: italic; margin-bottom: 20px;">אין טיפולים או משימות מתוכננים להיום</div>
						<button onclick="showScheduleClientModal()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
							📅 זמן לקוח
						</button>
					</div>
				`;
				statusElement.textContent = '';
				return;
			}
			
			// Separate in-progress from completed
			const inProgressVisits = todayVisits.filter(v => v.start_time && !v.end_time);
			const completedVisits = todayVisits.filter(v => v.end_time);
			const notStartedVisits = todayVisits.filter(v => !v.start_time);
			
			// Update status summary
			const totalIncome = todayVisits.reduce((sum, v) => sum + parseFloat(v.amount || 0), 0);
			const taskCount = todayTasks.length > 0 ? ` • ${todayTasks.length} משימות` : '';
			statusElement.textContent = `(${completedVisits.length}/${todayVisits.length} הסתיימו • ₪${totalIncome} סה"כ${taskCount})`;
			
			// Generate treatments HTML
			let html = '';
			
			// Show in-progress treatments first
			if (inProgressVisits.length > 0) {
				html += `<div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
					<h4 style="margin: 0 0 10px 0; color: #856404;">🔄 בתהליך עכשיו</h4>`;
				
				html += inProgressVisits.map(visit => {
					const client = locations.find(loc => loc.ID === visit.location_id);
					const clientName = visit.location_name || client?.name || 'לקוח לא מזוהה';
					const startTime = visit.start_time || '--:--';
					const workDone = visit.work_done || 'ללא תיאור';
					
					return `
						<div style="background: white; padding: 10px; border-radius: 5px; margin-bottom: 8px; border-left: 4px solid #ffc107;">
							<div style="display: flex; justify-content: space-between; align-items: center;">
								<div style="flex: 1;">
									<div style="font-weight: bold; color: #2c3e50;">${clientName}</div>
									<div style="font-size: 12px; color: #666;">${workDone}</div>
									<div style="font-size: 11px; color: #856404; margin-top: 3px;">⏱️ התחלה: ${startTime}</div>
								</div>
								<button onclick="showVisitForm('${visit.ID}')"
										style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">
									✅ סיים טיפול
								</button>
							</div>
						</div>
					`;
				}).join('');
				
				html += `</div>`;
			}
			
			// Show completed treatments
			if (completedVisits.length > 0) {
				html += `<div style="margin-bottom: 10px;">
					<h4 style="margin: 0 0 10px 0; color: #27ae60;">✅ הושלמו היום</h4>`;
				
				html += completedVisits.map(visit => {
					const client = locations.find(loc => loc.ID === visit.location_id);
					const clientName = visit.location_name || client?.name || 'לקוח לא מזוהה';
					const startTime = visit.start_time || '--:--';
					const endTime = visit.end_time || '--:--';
					const amount = visit.amount || 0;
					const workDone = visit.work_done || 'ללא תיאור';
					
					// Check payment status
					const paidAmount = getVisitPaidAmount(visit.ID);
					const isPaid = paidAmount >= amount && amount > 0;
					const isPartialPaid = paidAmount > 0 && paidAmount < amount;
					
					// Payment button or status indicator
					let paymentHtml = '';
					if (isPaid) {
						paymentHtml = `<span style="color: #27ae60; font-size: 14px;" title="שולם">✅</span>`;
					} else if (isPartialPaid) {
						paymentHtml = `<button onclick="showAddPaymentModal(null, '${visit.ID}')"
								style="padding: 6px 10px; background: #f39c12; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;"
								title="שולם חלקית: ${paidAmount}₪">½💰</button>`;
					} else if (amount > 0) {
						paymentHtml = `<button onclick="showAddPaymentModal(null, '${visit.ID}')"
								style="padding: 6px 10px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;"
								title="תשלום">💰</button>`;
					}
					
					return `
						<div style="background: ${isPaid ? '#e8f5e9' : '#f8f9fa'}; padding: 10px; border-radius: 5px; margin-bottom: 8px;">
							<div style="display: flex; justify-content: space-between; align-items: center;">
								<div style="flex: 1;">
									<div style="font-weight: bold; color: #2c3e50;">${clientName}</div>
									<div style="font-size: 12px; color: #666;">${workDone}</div>
									<div style="font-size: 11px; color: #666; margin-top: 3px;">
										${startTime} → ${endTime}
									</div>
								</div>
								<div style="display: flex; align-items: center; gap: 8px;">
									<span style="color: #27ae60; font-weight: bold; font-size: 14px;">${amount}₪</span>
									<button onclick="showVisitForm('${visit.ID}')" 
											style="padding: 6px 10px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;"
											title="עריכת טיפול">✏️</button>
									${paymentHtml}
								</div>
							</div>
						</div>
					`;
				}).join('');
				
				html += `</div>`;
			}
			
			// Show not started treatments
			if (notStartedVisits.length > 0) {
				html += `<div style="margin-bottom: 10px;">
					<h4 style="margin: 0 0 10px 0; color: #666;">📋 מתוכננים</h4>`;
				
				html += notStartedVisits.map(visit => {
					const client = locations.find(loc => loc.ID === visit.location_id);
					const clientName = visit.location_name || client?.name || 'לקוח לא מזוהה';
					
					return `
						<div style="background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 8px;">
							<div style="font-weight: bold; color: #495057;">${clientName}</div>
							<button onclick="editVisit('${visit.ID}')" 
									style="margin-top: 5px; padding: 6px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
								▶️ התחל טיפול
							</button>
						</div>
					`;
				}).join('');
				
				html += `</div>`;
			}
			
			// Show today's tasks
			if (todayTasks.length > 0) {
				html += `<div style="background: #f3e5f5; border: 2px solid #9b59b6; border-radius: 8px; padding: 10px; margin-top: 10px;">
					<h4 style="margin: 0 0 10px 0; color: #9b59b6;">📋 משימות להיום (${todayTasks.length})</h4>`;
				
				html += todayTasks.map(task => {
					const typeInfo = typeof TASK_TYPES !== 'undefined' && TASK_TYPES[task.type] ? TASK_TYPES[task.type] : { icon: '📦', label: task.type || 'אחר' };
					const statusInfo = typeof TASK_STATUSES !== 'undefined' && TASK_STATUSES[task.status] ? TASK_STATUSES[task.status] : { icon: '⏳', label: 'ממתין' };
					
					return `
						<div style="background: white; padding: 10px; border-radius: 5px; margin-bottom: 8px; border-left: 4px solid #9b59b6;">
							<div style="display: flex; justify-content: space-between; align-items: center;">
								<div style="flex: 1;">
									<div style="font-weight: bold; color: #2c3e50;">
										${typeInfo.icon} ${task.client_name || 'ללא לקוח'}
									</div>
									<div style="font-size: 12px; color: #666;">${task.description || ''}</div>
									<div style="font-size: 11px; color: #9b59b6; margin-top: 3px;">
										${statusInfo.icon} ${statusInfo.label}
										${task.estimated_cost ? ' • ₪' + task.estimated_cost : ''}
									</div>
								</div>
								<div style="display: flex; gap: 5px;">
									${task.status === 'pending' ? `
										<button onclick="updateTaskStatus('${task.ID}', 'in_progress')" 
												style="padding: 6px 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
											▶️ התחל
										</button>
									` : ''}
									${task.status === 'in_progress' ? `
										<button onclick="completeTask('${task.ID}')" 
												style="padding: 6px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
											✅ סיים
										</button>
									` : ''}
									<button onclick="showEditTaskModal('${task.ID}')" 
											style="padding: 6px 10px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
										✏️
									</button>
								</div>
							</div>
						</div>
					`;
				}).join('');
				
				html += `</div>`;
			}
			
			container.innerHTML = html;
		}

		// Refresh today's treatments - called by refresh button
		function refreshTodayTreatments() {
			loadTodayTreatments();
			showToast('הטיפולים של היום עודכנו', 'success', 1500);
		}
		
		
		function updateLocationNotes(locationId, newNotes) {
			const location = locations.find(loc => loc.ID === locationId);
			if (location) {
				location.notes = newNotes;
				saveToLocalStorage();
				
				if (access_token && SPREADSHEET_ID) {
					updateLocationInCloud(location);
				}
			}
		}

		// Load client options for debts filter
		function loadDebtClientOptions() {
			const datalist = document.getElementById('debtClientOptions');
			if (!datalist) return;
			
			// Get clients with debts
			const clientsWithDebts = new Set();
			visits.forEach(visit => {
				if (visit.amount > 0) {
					const visitAmount = parseFloat(visit.amount) || 0;
					const paidAmount = getVisitPaidAmount(visit.ID);
					const debt = visitAmount - paidAmount;
					if (debt > 0) {
						clientsWithDebts.add(visit.location_id);
					}
				}
			});
			
			// Populate datalist
			datalist.innerHTML = '';
			locations
				.filter(loc => clientsWithDebts.has(loc.ID))
				.sort((a, b) => a.name.localeCompare(b.name, 'he'))
				.forEach(client => {
					const option = document.createElement('option');
					option.value = client.name;
					option.setAttribute('data-client-id', client.ID);
					datalist.appendChild(option);
				});
		}

		// Handle client selection
		function handleDebtClientSelection(clientName) {
			const option = document.querySelector(`#debtClientOptions option[value="${clientName}"]`);
			const clientId = option ? option.getAttribute('data-client-id') : '';
			
			// Store selected client ID for filtering
			document.getElementById('debtClientSearch').setAttribute('data-selected-id', clientId);
			
			// Apply filter
			displayDebts();
		}

		// Clear client search
		function clearDebtClientSearch() {
			const searchInput = document.getElementById('debtClientSearch');
			searchInput.value = '';
			searchInput.removeAttribute('data-selected-id');
			displayDebts();
		}

		// Filter client options as user types (optional enhancement)
		function filterDebtClientOptions(searchTerm) {
			// This function can be enhanced later if needed
			// For now, the datalist handles filtering automatically
		}


		
		// Global client lock system
		let isClientLocked = false;
		let lockedClientId = null;
		let lockedClientName = '';

		function toggleClientLock() {
			const lockBtn = document.getElementById('lockBtn');
			const clientSelector = document.getElementById('lockClientSelector');
			
			if (isClientLocked) {
				// Unlock - release all tabs and hide client selector
				isClientLocked = false;
				lockedClientId = null;
				lockedClientName = '';
				
				lockBtn.textContent = '🔓';
				lockBtn.classList.remove('locked');
				lockBtn.title = 'נעילת סינכרון לקוחות';
				
				// Hide client selector
				clientSelector.style.display = 'none';
				clientSelector.value = '';
				
				// ✅ Clear all filters in all tabs
				clearAllTabFilters();
				
				showToast('נעילה שוחררה - כל הסינונים נוקו', 'success', 2000);
			} else {
				// Lock - show client selector
				isClientLocked = true;
				
				lockBtn.textContent = '🔒';
				lockBtn.classList.add('locked');
				lockBtn.title = 'משחרר נעילה';
				
				// Show and populate client selector
				clientSelector.style.display = 'inline-block';
				clientSelector.innerHTML = `
					<option value="">בחר לקוח...</option>
					${locations.filter(loc => loc.active === '1').sort((a, b) => a.name.localeCompare(b.name, 'he')).map(client => 
						`<option value="${client.ID}">${client.name}</option>`
					).join('')}
				`;
				
				showToast('נעילה פעילה - בחר לקוח מהרשימה', 'info', 3000);
			}
		}

		function selectClientForLock(clientId) {
			if (!clientId || !isClientLocked) return;
			
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) return;
			
			lockedClientId = clientId;
			lockedClientName = client.name;
			
			// Apply client to all tabs
			syncAllTabsToClient(clientId, client.name);
			
			showToast(`כל הטאבים מסונכרנים ל: ${client.name}`, 'success', 3000);
		}

		function syncAllTabsToClient(clientId, clientName) {
			// Sync visits/history tab
			const visitSearch = document.getElementById('visitSmartSearch');
			if (visitSearch) {
				visitSearch.value = clientName;
				if (typeof handleVisitSmartSearch === 'function') {
					handleVisitSmartSearch(clientName);
				}
			}
			
			// Sync debts tab
			const debtSearch = document.getElementById('debtClientSearch');
			if (debtSearch) {
				debtSearch.value = clientName;
				debtSearch.setAttribute('data-selected-id', clientId);
				if (typeof displayDebts === 'function') {
					displayDebts();
				}
			}
			
			// Sync payments tab
			const paymentSearch = document.getElementById('paymentSmartSearch');
			if (paymentSearch) {
				paymentSearch.value = clientName;
				if (typeof handlePaymentSmartSearch === 'function') {
					handlePaymentSmartSearch(clientName);
				}
			}
			
			// Fix receipts tab - use the smart search
			const receiptSearch = document.getElementById('receiptSmartSearch');
			if (receiptSearch) {
				receiptSearch.value = clientName;
				if (typeof handleReceiptSmartSearch === 'function') {
					handleReceiptSmartSearch(clientName);
				}
			}
			
			// For locations tab - filter the table directly
			if (typeof filterLocationsTable === 'function') {
				const nameFilter = document.getElementById('filterClientName');
				if (nameFilter) {
					nameFilter.value = clientName;
					filterLocationsTable();
				}
			}
		}


		function closeAnyModal() {
			// List of all possible modal IDs
			const modalIds = ['editModal', 'telegramModal', 'clientModal', 'addTreatmentModal', 'linkPaymentModal', 'modalContainer'];
			
			// Try to close by ID
			for (const id of modalIds) {
				const modal = document.getElementById(id);
				if (modal) {
					if (id === 'modalContainer') {
						// Special handling for modalContainer
						modal.style.display = 'none';
						modal.innerHTML = '';
					} else {
						modal.remove();
					}
					console.log(`✅ Closed modal: ${id}`);
					return true;
				}
			}
			
			// Fallback: find and remove any modal-like element
			const modalElements = document.querySelectorAll('[style*="position: fixed"][style*="background"]');
			if (modalElements.length > 0) {
				modalElements.forEach(el => el.remove());
				console.log(`✅ Closed ${modalElements.length} modal(s) by style`);
				return true;
			}
			
			console.warn('⚠️ No modal found to close');
			return false;
		}

		// Toggle filter panel collapse/expand
		function toggleFilterPanel(panelId) {
			const panel = document.getElementById(panelId);
			const button = document.querySelector(`[onclick="toggleFilterPanel('${panelId}')"]`);
			
			if (!panel || !button) return;
			
			panel.classList.toggle('collapsed');
			
			// Update button text
			if (panel.classList.contains('collapsed')) {
				button.textContent = '🔽 הרחב';
			} else {
				button.textContent = '🔼 כווץ';
			}
			
			// Save state to localStorage
			const isCollapsed = panel.classList.contains('collapsed');
			localStorage.setItem(`filter_${panelId}_collapsed`, isCollapsed);
		}

		// Restore filter panel states on page load
		function restoreFilterStates() {
			const filterPanels = [
				'visitsFilterContent',
				'locationsFilterContent', 
				'debtsFilterContent',
				'receiptsFilterContent',
				'paymentsFilterContent'
			];
			
			filterPanels.forEach(panelId => {
				const isCollapsed = localStorage.getItem(`filter_${panelId}_collapsed`) === 'true';
				const panel = document.getElementById(panelId);
				const button = document.querySelector(`[onclick="toggleFilterPanel('${panelId}')"]`);
				
				if (panel && isCollapsed) {
					panel.classList.add('collapsed');
					if (button) button.textContent = '🔽 הרחב';
				}
			});
		}


		// Toggle expandable table row
		function toggleTableRow(rowElement) {
			const mainRow = rowElement.closest('.main-row');
			const detailsRow = mainRow.nextElementSibling;
			
			if (detailsRow && detailsRow.classList.contains('details-row')) {
				mainRow.classList.toggle('expanded');
				detailsRow.classList.toggle('expanded');
			}
		}

		// Add click handlers to expandable table rows
		function initExpandableTable(tableId) {
			const table = document.getElementById(tableId);
			if (!table) return;
			
			table.classList.add('mobile-optimized');
			
			// Add click handler to all main rows
			const mainRows = table.querySelectorAll('.main-row');
			mainRows.forEach(row => {
				row.addEventListener('click', function(e) {
					// Don't expand if clicking on buttons or links
					if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.closest('button') || e.target.closest('a')) {
						return;
					}
					toggleTableRow(this);
				});
			});
		}

		function getPaymentStatusIcon(visitId) {
			const status = getVisitPaymentStatus(visitId);
			
			switch(status) {
				case '1': return '✅'; // שולם מלא
				case '3': return '½'; // חלקי
				case '2': return '🚫'; // ללא תשלום
				default: return '❌'; // לא שולם
			}
		}


		// Show open debts warning for a client
		function showOpenDebtsWarning(locationId) {
			const location = locations.find(loc => loc.ID === locationId);
			if (!location) return '';
			
			// Calculate total debt for this client
			const clientVisits = visits.filter(v => v.location_id === locationId);
			
			let totalDebt = 0;
			let unpaidVisitsCount = 0;
			
			for (const visit of clientVisits) {
				const paidAmount = getVisitPaidAmount(visit.ID);
				const debt = parseFloat(visit.amount || 0) - paidAmount;
				
				if (debt > 0.01) {
					totalDebt += debt;
					unpaidVisitsCount++;
				}
			}
			
			// No debt - no warning
			if (totalDebt <= 0.01) {
				return '';
			}
			
			// Determine severity
			let severity = 'low';
			let severityColor = '#f39c12';
			let severityIcon = '⚠️';
			
			if (totalDebt > 1000) {
				severity = 'high';
				severityColor = '#e74c3c';
				severityIcon = '🚨';
			} else if (totalDebt > 500) {
				severity = 'medium';
				severityColor = '#e67e22';
				severityIcon = '⚠️';
			}
			
			// Create warning HTML
			const warningHTML = `
				<div style="background: ${severityColor}; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
					<div style="display: flex; align-items: center; gap: 12px;">
						<span style="font-size: 24px;">${severityIcon}</span>
						<div style="flex: 1;">
							<div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">
								חובות פתוחים ללקוח
							</div>
							<div style="font-size: 14px; opacity: 0.95;">
								${unpaidVisitsCount} טיפולים לא משולמים | סה"כ חוב: ₪${Math.round(totalDebt).toLocaleString()}
							</div>
						</div>
						<button onclick="goToDebtsTab('${locationId}')" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px;">
							📋 צפה בחובות
						</button>
					</div>
				</div>
			`;
			
			return warningHTML;
		}

		// Navigate to debts tab and filter by client
		function goToDebtsTab(locationId) {
			// Switch to debts tab
			showSection('debts');
			
			// Filter by client
			const location = locations.find(loc => loc.ID === locationId);
			if (location) {
				// Set the client search filter
				const debtClientSearch = document.getElementById('debtClientSearch');
				if (debtClientSearch) {
					debtClientSearch.value = location.name;
					handleDebtClientSelection(location.name);
				}
			}
			
			// Close modal if open
			closeAnyModal();
		}


		// ✅ Auto-calculate prices for zero-amount visits based on duration
		async function autoCalculatePricesByDuration() {
			console.log('⚡ Starting auto price calculation...');
			
			const zeroAmountVisits = visits.filter(visit => {
				const paidInfo = parsePaidField(visit.paid);
				if (paidInfo.status === '2') return false;
				
				const amount = parseFloat(visit.amount) || 0;
				const duration = parseFloat(visit.duration_minutes) || 0;
				
				return amount === 0 && duration > 0;
			});
			
			if (zeroAmountVisits.length === 0) {
				showToast('ℹ️ לא נמצאו טיפולים עם מחיר 0 ומשך זמן מוזן', 'info');
				return;
			}
			
			const hourlyRate = prompt(
				`נמצאו ${zeroAmountVisits.length} טיפולים ללא מחיר עם זמן מוזן.\n\n` +
				`הזן תעריף לשעה (₪):`,
				'150'
			);
			
			if (!hourlyRate || hourlyRate.trim() === '') return;
			
			const rate = parseFloat(hourlyRate);
			if (isNaN(rate) || rate <= 0) {
				showToast('⚠️ תעריף לא תקין', 'warning');
				return;
			}
			
			const totalHours = zeroAmountVisits.reduce((sum, v) => sum + (parseFloat(v.duration_minutes) / 60), 0);
			const estimatedTotal = totalHours * rate;
			
			const confirmed = confirm(
				`⚡ חישוב אוטומטי של מחירים:\n\n` +
				`📋 טיפולים: ${zeroAmountVisits.length}\n` +
				`⏱️ סה"כ זמן: ${totalHours.toFixed(1)} שעות\n` +
				`💰 תעריף: ${rate}₪ לשעה\n` +
				`💵 סה"כ משוער: ${estimatedTotal.toFixed(0)}₪\n\n` +
				`האם להמשיך?`
			);
			
			if (!confirmed) return;
			
			try {
				showLoading('מחשב מחירים...');
				
				let updatedCount = 0;
				const updates = [];
				
				// Calculate prices
				for (const visit of zeroAmountVisits) {
					const duration = parseFloat(visit.duration_minutes);
					const hours = duration / 60;
					const calculatedPrice = Math.round(hours * rate);
					
					visit.amount = calculatedPrice;
					updatedCount++;
					
					updates.push({
						visitId: visit.ID,
						date: visit.date,
						client: visit.location_name,
						duration: duration,
						calculatedPrice: calculatedPrice
					});
				}
				
				// Save locally
				saveToLocalStorage();
				
				hideLoading();
				
				// Show results immediately
				showCalculationResults(updates, rate);
				
				// Refresh displays
				if (typeof displayDebts === 'function') displayDebts();
				if (typeof displayVisits === 'function') displayVisits();
				
				showToast(`✅ עודכנו ${updatedCount} טיפולים מקומית!`, 'success', 3000);
				
				// Save to cloud in background (if connected)
				if (access_token && SPREADSHEET_ID && updatedCount > 0) {
					if (updatedCount > 20) {
						const shouldSaveToCloud = confirm(
							`נשמר מקומית בהצלחה!\n\n` +
							`האם לשמור גם לענן?\n` +
							`(${updatedCount} טיפולים - עשוי לקחת זמן)`
						);
						
						if (!shouldSaveToCloud) return;
					}
					
					showToast('💾 שומר לענן ברקע...', 'info', 2000);
					
					// Non-blocking cloud save
					updateMultipleVisitsInSheets(zeroAmountVisits)
						.then(() => {
							showToast('✅ נשמר גם לענן!', 'success', 3000);
						})
						.catch(error => {
							console.error('Error saving to cloud:', error);
							showToast('⚠️ שגיאה בשמירה לענן (נשמר מקומית)', 'warning', 4000);
						});
				}
				
			} catch (error) {
				hideLoading();
				console.error('Error in auto price calculation:', error);
				showToast('⌫ שגיאה בחישוב מחירים', 'error');
			}
		}

		// ✅ Show detailed calculation results
		function showCalculationResults(updates, hourlyRate) {
			const totalAmount = updates.reduce((sum, u) => sum + u.calculatedPrice, 0);
			const totalHours = updates.reduce((sum, u) => sum + (u.duration / 60), 0);
			
			// ✅ Limit display to first 50 for performance
			const displayUpdates = updates.slice(0, 50);
			const hasMore = updates.length > 50;
			
			const modalHTML = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; direction: rtl;">
					<h3 style="margin: 0 0 20px 0; color: #2c3e50; border-bottom: 3px solid #f39c12; padding-bottom: 15px;">
						⚡ תוצאות חישוב מחירים
					</h3>
					
					<!-- Summary -->
					<div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
						<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
							<div>
								<div style="font-size: 28px; font-weight: bold;">${updates.length}</div>
								<div style="font-size: 13px; opacity: 0.9;">טיפולים עודכנו</div>
							</div>
							<div>
								<div style="font-size: 28px; font-weight: bold;">${totalHours.toFixed(1)}</div>
								<div style="font-size: 13px; opacity: 0.9;">שעות סה"כ</div>
							</div>
							<div>
								<div style="font-size: 28px; font-weight: bold;">₪${totalAmount.toLocaleString()}</div>
								<div style="font-size: 13px; opacity: 0.9;">סה"כ חושב</div>
							</div>
						</div>
						<div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 14px;">
							💰 תעריף שעתי: <strong>${hourlyRate}₪</strong>
						</div>
					</div>
					
					<!-- Details -->
					<div style="margin-bottom: 20px;">
						<div style="font-weight: 600; margin-bottom: 10px; color: #555;">
							📋 פירוט ${hasMore ? `(מציג ${displayUpdates.length} ראשונים מתוך ${updates.length})` : 'טיפולים:'}
						</div>
						<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
							${displayUpdates.map((u, index) => `
								<div style="padding: 12px; border-bottom: 1px solid #eee; ${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
									<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
										<span style="font-weight: 600; color: #2c3e50;">${u.client}</span>
										<span style="font-weight: bold; color: #27ae60; font-size: 16px;">₪${u.calculatedPrice}</span>
									</div>
									<div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
										<span>📅 ${formatDate(u.date)}</span>
										<span>⏱️ ${u.duration} דק (${(u.duration / 60).toFixed(1)} שע)</span>
									</div>
								</div>
							`).join('')}
						</div>
					</div>
					
					<div style="text-align: center;">
						<button onclick="closeAnyModal()" class="btn" style="background: #27ae60; color: white; padding: 12px 40px; font-size: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
							✓ סגור
						</button>
					</div>
				</div>
			`;
			
			const modalContainer = document.getElementById('modalContainer');
			modalContainer.innerHTML = modalHTML;
			modalContainer.style.display = 'flex';
			window.scrollTo({ top: 0, behavior: 'smooth' });
		}


		// ✅ Disconnect from cloud
		function disconnectFromCloud() {
			if (!access_token) {
				showToast('ℹ️ כבר לא מחובר לענן', 'info');
				return;
			}
			
			if (confirm('האם להתנתק מהענן?\n\n✓ הנתונים נשארים שמורים מקומית\n✓ תוכל להתחבר שוב בכל עת\n✓ שינויים חדשים לא יישמרו אוטומטית לענן')) {
				// Clear tokens
				access_token = null;
				SPREADSHEET_ID = null;
				
				// Clear from localStorage
				localStorage.removeItem('google_token');
				localStorage.removeItem('google_spreadsheet_id');
				
				// Stop auto-refresh
				if (window.tokenRefreshInterval) {
					clearInterval(window.tokenRefreshInterval);
					window.tokenRefreshInterval = null;
				}
				
				// Update UI
				updateCloudStatus('⚪ לא מחובר', 'התנתק');
				
				showToast('🔌 התנתקת מהענן בהצלחה', 'success');
				
				console.log('✅ Disconnected from cloud');
			}
		}



		// ✅ Cancel "paid" status for a visit - allow re-linking
		async function cancelVisitPaidStatus(visitId) {
			const visit = visits.find(v => v.ID === visitId);
			if (!visit) {
				showToast('⚠️ טיפול לא נמצא', 'warning');
				return;
			}
			
			const paidInfo = parsePaidField(visit.paid);
			
			if (paidInfo.status === '0') {
				showToast('ℹ️ הטיפול כבר מסומן כ"לא שולם"', 'info');
				return;
			}
			
			// Check if visit has linked payments
			const linkedPayments = paymentVisitLinks.filter(link => link.visit_id === visitId);
			
			let confirmMessage = `האם לבטל את סימון "שולם" לטיפול?\n\n`;
			confirmMessage += `📅 תאריך: ${formatDate(visit.date)}\n`;
			confirmMessage += `💰 סכום: ₪${visit.amount}\n`;
			
			if (linkedPayments.length > 0) {
				confirmMessage += `\n⚠️ שים לב: יש ${linkedPayments.length} קישורי תשלום לטיפול זה.\n`;
				confirmMessage += `הקישורים יישארו, רק הסטטוס ישתנה.`;
			}
			
			if (!confirm(confirmMessage)) {
				return;
			}
			
			try {
				// Update status to "not paid"
				visit.paid = '0';
				
				// Save locally
				saveToLocalStorage();
				
				// Save to cloud if connected
				if (access_token && SPREADSHEET_ID) {
					try {
						await updateMultipleVisitsInSheets([visit]);
					} catch (error) {
						console.error('Error saving to cloud:', error);
						showToast('⚠️ נשמר מקומית, שגיאה בשמירה לענן', 'warning');
					}
				}
				
				showToast('✅ סטטוס התשלום בוטל - הטיפול זמין לקישור מחדש', 'success');
				
				// Refresh displays
				if (typeof displayVisits === 'function') displayVisits();
				if (typeof displayDebts === 'function') displayDebts();
				
			} catch (error) {
				console.error('Error canceling paid status:', error);
				showToast('⌫ שגיאה בביטול סטטוס', 'error');
			}
		}

		// ✅ Clear all filters when unlocking
		function clearAllTabFilters() {
			// Clear visits/history tab
			const visitSearch = document.getElementById('visitSmartSearch');
			if (visitSearch) {
				visitSearch.value = '';
				if (typeof handleVisitSmartSearch === 'function') {
					handleVisitSmartSearch('');
				}
			}
			
			// Clear debts tab
			const debtSearch = document.getElementById('debtClientSearch');
			if (debtSearch) {
				debtSearch.value = '';
				debtSearch.removeAttribute('data-selected-id');
				if (typeof displayDebts === 'function') {
					displayDebts();
				}
			}
			
			// Clear payments tab
			const paymentSearch = document.getElementById('paymentSmartSearch');
			if (paymentSearch) {
				paymentSearch.value = '';
				if (typeof handlePaymentSmartSearch === 'function') {
					handlePaymentSmartSearch('');
				}
			}
			
			// Clear receipts tab
			const receiptSearch = document.getElementById('receiptSmartSearch');
			if (receiptSearch) {
				receiptSearch.value = '';
				if (typeof handleReceiptSmartSearch === 'function') {
					handleReceiptSmartSearch('');
				}
			}
			
			// Clear locations tab
			const nameFilter = document.getElementById('filterClientName');
			if (nameFilter) {
				nameFilter.value = '';
				if (typeof filterLocationsTable === 'function') {
					filterLocationsTable();
				}
			}
			
			console.log('✅ All tab filters cleared');
		}


		// Toggle visit details row
		function toggleVisitDetails(rowId) {
			const row = document.getElementById(rowId);
			if (row) {
				row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
			}
		}



		// ==================== TASKS MANAGEMENT ====================

		// Task type definitions
		const TASK_TYPES = {
			'pest_control': { icon: '🪲', label: 'הדברה', color: '#e74c3c' },
			'planting': { icon: '🌱', label: 'שתילה', color: '#27ae60' },
			'tree_trimming': { icon: '✂️', label: 'גיזום עצים', color: '#f39c12' },
			'upgrade': { icon: '🏡', label: 'שדרוג גינה', color: '#9b59b6' },
			'repair': { icon: '🔧', label: 'תיקון', color: '#3498db' },
			'irrigation': { icon: '💧', label: 'השקייה', color: '#00bcd4' },
			'other': { icon: '📦', label: 'אחר', color: '#95a5a6' }
		};

		// Task status definitions
		const TASK_STATUSES = {
			'pending': { icon: '⏳', label: 'ממתין', color: '#ffc107', bg: '#fff3cd' },
			'in_progress': { icon: '🔄', label: 'בתהליך', color: '#007bff', bg: '#cce5ff' },
			'completed': { icon: '✅', label: 'הושלם', color: '#28a745', bg: '#d4edda' },
			'cancelled': { icon: '❌', label: 'בוטל', color: '#dc3545', bg: '#f8d7da' }
		};

		// סוגי הוצאות (רמה עליונה)
		const EXPENSE_TYPES = {
			'general': { name: 'כללי', icon: '📦' },
			'client': { name: 'לקוח', icon: '👤' },
			'vehicle': { name: 'רכב', icon: '🚗' },
			'worker': { name: 'עובדים', icon: '👷' }
		};

		// קטגוריות לפי סוג
		const EXPENSE_CATEGORIES = {
			'general': {
				'fuel': { name: 'דלק ושמנים', icon: '⛽' },
				'equipment': { name: 'ציוד וחומרים', icon: '🔧' },
				'tools': { name: 'כלי עבודה', icon: '🔨' },
				'other': { name: 'אחר', icon: '📦' }
			},
			'client': {
				'materials': { name: 'חומרים', icon: '🧪' },
				'parts': { name: 'חלקים', icon: '⚙️' },
				'nursery': { name: 'משתלה', icon: '🌱' },
				'other': { name: 'אחר', icon: '📦' }
			},
			'vehicle': {
				'garage': { name: 'מוסך', icon: '🔧' },
				'insurance': { name: 'ביטוחים', icon: '📋' },
				'fuel': { name: 'דלק', icon: '⛽' },
				'other': { name: 'אחר', icon: '📦' }
			},
			'worker': {
				'payment': { name: 'תשלום', icon: '💵' },
				'food': { name: 'מזון', icon: '🍔' },
				'other': { name: 'אחר', icon: '📦' }
			}
		};

		// סוגי ספקים
		const VENDOR_TYPES = {
			'store': { name: 'חנות', icon: '🏪' },
			'garage': { name: 'מוסך', icon: '🔧' },
			'gas_station': { name: 'תחנת דלק', icon: '⛽' },
			'online': { name: 'רכישה מקוונת', icon: '💻' },
			'nursery': { name: 'משתלה', icon: '🌱' },
			'person': { name: 'אדם', icon: '👤' },
			'other': { name: 'אחר', icon: '📍' }
		};

		// אמצעי תשלום
		const PAYMENT_METHODS = {
			'cash': { name: 'מזומן', icon: '💵' },
			'credit': { name: 'אשראי', icon: '💳' },
			'transfer': { name: 'העברה', icon: '🏦' },
			'bit': { name: 'ביט', icon: '📱' },
			'check': { name: 'צ׳ק', icon: '📝' }
		};


		// Display tasks in table
		function displayTasks() {
			const tbody = document.getElementById('tasksTableBody');
			if (!tbody) return;
			
			// Get filter values
			const statusFilter = document.getElementById('filterTaskStatus')?.value || '';
			const scopeFilter = document.getElementById('filterTaskScope')?.value || '';
			const typeFilter = document.getElementById('filterTaskType')?.value || '';
			const clientFilter = document.getElementById('filterTaskClient')?.value?.toLowerCase() || '';
			const dateFromFilter = document.getElementById('filterTaskDateFrom')?.value || '';
			const dateToFilter = document.getElementById('filterTaskDateTo')?.value || '';
			
			// Filter tasks
			let filteredTasks = tasks.filter(task => {
				if (statusFilter && task.status !== statusFilter) return false;
				if (scopeFilter && task.scope !== scopeFilter) return false;
				if (typeFilter && task.type !== typeFilter) return false;
				if (clientFilter && !task.client_name?.toLowerCase().includes(clientFilter)) return false;
				if (dateFromFilter && task.due_date < dateFromFilter) return false;
				if (dateToFilter && task.due_date > dateToFilter) return false;
				return true;
			});
			
			// Sort by due date (closest first), then by status
			filteredTasks.sort((a, b) => {
				const statusOrder = { 'in_progress': 0, 'pending': 1, 'completed': 2, 'cancelled': 3 };
				if (statusOrder[a.status] !== statusOrder[b.status]) {
					return statusOrder[a.status] - statusOrder[b.status];
				}
				return new Date(a.due_date) - new Date(b.due_date);
			});
			
			// Update stats
			updateTasksStats();

			// עדכון מספר משימות מוצגות
			const tasksCountEl = document.getElementById('tasksCount');
			if (tasksCountEl) tasksCountEl.textContent = filteredTasks.length;

			// Render table
			if (filteredTasks.length === 0) {
				tbody.innerHTML = `
					<tr>
						<td colspan="7" style="text-align: center; padding: 40px; color: #666;">
							<div style="font-size: 48px; margin-bottom: 10px;">📋</div>
							<div>אין משימות להצגה</div>
							<button onclick="showAddTaskModal()" style="margin-top: 15px; padding: 10px 20px; background: #9b59b6; color: white; border: none; border-radius: 6px; cursor: pointer;">
								➕ הוסף משימה ראשונה
							</button>
						</td>
					</tr>
				`;
				return;
			}
			
			tbody.innerHTML = filteredTasks.map(task => {
				const typeInfo = TASK_TYPES[task.type] || TASK_TYPES['other'];
				const statusInfo = TASK_STATUSES[task.status] || TASK_STATUSES['pending'];
				
				// Scope display
				const scopeLabels = {
					'client': '👤 ללקוח',
					'all': '👥 גורפת',
					'personal': '🔧 עצמית'
				};
				const scopeLabel = scopeLabels[task.scope] || scopeLabels['client'];
				
				// Check if overdue
				const isOverdue = task.status !== 'completed' && task.status !== 'cancelled' && 
								  new Date(task.due_date) < new Date(new Date().toDateString());
				
				return `
					<tr style="border-bottom: 1px solid #eee; ${isOverdue ? 'background: #fff5f5;' : ''}">
						<td style="padding: 12px;">
							<span style="background: ${statusInfo.bg}; color: ${statusInfo.color}; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 600;">
								${statusInfo.icon} ${statusInfo.label}
							</span>
						</td>
						<td style="padding: 12px; font-size: 12px;">
							${scopeLabel}
						</td>
						<td style="padding: 12px;">
							<span style="color: ${typeInfo.color}; font-weight: 600;">
								${typeInfo.icon} ${typeInfo.label}
							</span>
						</td>
						<td style="padding: 12px; font-weight: 600;">${task.client_name || '-'}</td>
						<td style="padding: 12px; max-width: 200px;">
							<div style="font-size: 13px; color: #333;">${task.description || '-'}</div>
							${task.notes ? `<div style="font-size: 11px; color: #666; margin-top: 3px;">💬 ${task.notes}</div>` : ''}
						</td>
						<td style="padding: 12px; ${isOverdue ? 'color: #dc3545; font-weight: bold;' : ''}">
							${isOverdue ? '⚠️ ' : ''}${formatDate(task.due_date)}
						</td>
						<td style="padding: 12px; font-weight: 600; color: #27ae60;">
							${task.estimated_cost ? '₪' + task.estimated_cost : '-'}
						</td>
						<td style="padding: 12px; text-align: center;">
							<div style="display: flex; gap: 5px; justify-content: center;">
								${task.status === 'pending' ? `
									<button onclick="updateTaskStatus('${task.ID}', 'in_progress')" 
											style="padding: 5px 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" 
											title="התחל">▶️</button>
								` : ''}
								${task.status === 'in_progress' ? `
									<button onclick="completeTask('${task.ID}')" 
											style="padding: 5px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" 
											title="סיים">✅</button>
								` : ''}
								<button onclick="showEditTaskModal('${task.ID}')" 
										style="padding: 5px 8px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" 
										title="עריכה">✏️</button>
								<button onclick="deleteTask('${task.ID}')" 
										style="padding: 5px 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" 
										title="מחק">🗑️</button>
							</div>
						</td>
					</tr>
				`;
			}).join('');
		}

		// Update tasks statistics
		function updateTasksStats() {
			const pending = tasks.filter(t => t.status === 'pending').length;
			const inProgress = tasks.filter(t => t.status === 'in_progress').length;
			const completed = tasks.filter(t => t.status === 'completed').length;
			
			const statsPending = document.getElementById('statsPending');
			const statsInProgress = document.getElementById('statsInProgress');
			const statsCompleted = document.getElementById('statsCompleted');
			
			if (statsPending) statsPending.textContent = pending;
			if (statsInProgress) statsInProgress.textContent = inProgress;
			if (statsCompleted) statsCompleted.textContent = completed;
		}

		function clearTaskFilters() {
			document.getElementById('filterTaskStatus').value = '';
			document.getElementById('filterTaskScope').value = '';
			document.getElementById('filterTaskType').value = '';
			document.getElementById('filterTaskClient').value = '';
			document.getElementById('filterTaskDateFrom').value = '';
			document.getElementById('filterTaskDateTo').value = '';
			displayTasks();
		}

		// Show add task modal
		function showAddTaskModal(preSelectedClientId = null) {
			const now = new Date();
			const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
			
			const modalHTML = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 550px; width: 90vw; max-height: 90vh; overflow-y: auto; position: relative;">
					<button onclick="closeAnyModal()" style="position: absolute; top: 15px; left: 15px; background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px;">×</button>
					
					<h3 style="margin: 0 0 20px 0; color: #9b59b6; border-bottom: 2px solid #9b59b6; padding-bottom: 10px;">
						📋 משימה חדשה
					</h3>
					
					<form id="taskForm" onsubmit="saveTask(event)" style="display: flex; flex-direction: column; gap: 15px;">
						<!-- Scope Selection -->
						<div>
							<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">היקף:</label>
							<select id="taskScope" required onchange="toggleTaskClientField()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
								<option value="client">👤 ללקוח ספציפי</option>
								<option value="all">👥 גורפת - לכל הלקוחות</option>
								<option value="personal">🔧 עצמית - לא קשורה ללקוחות</option>
							</select>
						</div>

						<!-- Client Selection -->
						<div id="taskClientSection">
							<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">לקוח:</label>
							<div style="position: relative;">
								<input type="text" id="taskClientSearch" placeholder="🔍 חיפוש לקוח..." 
									   onkeyup="filterTaskClientOptions()" 
									   autocomplete="off"
									   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
								<div id="taskClientOptions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ddd; border-radius: 0 0 6px 6px; z-index: 100;"></div>
								<input type="hidden" id="taskClientId">
							</div>
						</div>
						
						<!-- Task Type -->
						<div>
							<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">סוג משימה:</label>
							<select id="taskType" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
								<option value="">בחר סוג...</option>
								<option value="pest_control">🪲 הדברה</option>
								<option value="planting">🌱 שתילה</option>
								<option value="tree_trimming">✂️ גיזום עצים</option>
								<option value="upgrade">🏡 שדרוג גינה</option>
								<option value="repair">🔧 תיקון</option>
								<option value="irrigation">💧 השקייה</option>
								<option value="other">📦 אחר</option>
							</select>
						</div>
						
						<!-- Description -->
						<div>
							<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">תיאור המשימה:</label>
							<textarea id="taskDescription" rows="2" required placeholder="מה צריך לעשות?"
									  style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
						</div>
						
						<!-- Due Date & Priority -->
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">תאריך יעד:</label>
								<input type="date" id="taskDueDate" value="${today}" required
									   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
							</div>
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">עדיפות:</label>
								<select id="taskPriority" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
									<option value="normal">רגילה</option>
									<option value="high">גבוהה 🔴</option>
									<option value="low">נמוכה</option>
								</select>
							</div>
						</div>
						
						<!-- Estimated Cost & Equipment -->
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">עלות משוערת (₪):</label>
								<input type="number" id="taskEstimatedCost" min="0" placeholder="0"
									   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
							</div>
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ציוד נדרש:</label>
								<input type="text" id="taskEquipment" placeholder="רשום ציוד..."
									   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
							</div>
						</div>
						
						<!-- Notes -->
						<div>
							<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">הערות / דגשים:</label>
							<textarea id="taskNotes" rows="2" placeholder="הערות נוספות, דגשים חשובים..."
									  style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
						</div>
						
						<!-- Recurring -->
						<div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
							<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
								<input type="checkbox" id="taskRecurring" onchange="toggleRecurringOptions()">
								<span style="font-weight: 600; color: #555;">🔄 משימה חוזרת</span>
							</label>
							<div id="recurringOptions" style="display: none; margin-top: 10px;">
								<select id="taskRecurringInterval" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
									<option value="weekly">כל שבוע</option>
									<option value="biweekly">כל שבועיים</option>
									<option value="monthly">כל חודש</option>
									<option value="quarterly" selected>כל רבעון (3 חודשים)</option>
									<option value="biannual">כל חצי שנה</option>
									<option value="yearly">כל שנה</option>
								</select>
							</div>
						</div>
						
						<!-- Submit Buttons -->
						<div style="display: flex; gap: 10px; margin-top: 10px;">
							<button type="submit" style="flex: 1; padding: 12px; background: #9b59b6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
								💾 שמור משימה
							</button>
							<button type="button" onclick="closeAnyModal()" style="padding: 12px 20px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer;">
								ביטול
							</button>
						</div>
					</form>
				</div>
			`;
			
			showEditModal(modalHTML);
			
			// Pre-select client if provided
			if (preSelectedClientId) {
				const client = locations.find(loc => loc.ID === preSelectedClientId);
				if (client) {
					document.getElementById('taskClientSearch').value = client.name;
					document.getElementById('taskClientId').value = preSelectedClientId;
				}
			}
		}
		
		
		// Toggle client field based on scope selection
		function toggleTaskClientField() {
			const scope = document.getElementById('taskScope').value;
			const clientSection = document.getElementById('taskClientSection');
			const clientIdInput = document.getElementById('taskClientId');
			const clientSearchInput = document.getElementById('taskClientSearch');
			
			if (scope === 'client') {
				clientSection.style.display = 'block';
				clientIdInput.required = true;
			} else {
				clientSection.style.display = 'none';
				clientIdInput.required = false;
				clientIdInput.value = '';
				clientSearchInput.value = '';
			}
		}


		// Toggle recurring options visibility
		function toggleRecurringOptions() {
			const checkbox = document.getElementById('taskRecurring');
			const options = document.getElementById('recurringOptions');
			if (options) {
				options.style.display = checkbox.checked ? 'block' : 'none';
			}
		}

		// Filter client options for task
		function filterTaskClientOptions() {
			const searchInput = document.getElementById('taskClientSearch');
			const optionsDiv = document.getElementById('taskClientOptions');
			const searchTerm = searchInput.value.toLowerCase();
			
			if (searchTerm.length < 1) {
				optionsDiv.style.display = 'none';
				return;
			}
			
			const matchingClients = locations.filter(loc => 
				loc.active === '1' && 
				(loc.name?.toLowerCase().includes(searchTerm) || 
				 loc.full_address?.toLowerCase().includes(searchTerm))
			).slice(0, 10);
			
			if (matchingClients.length === 0) {
				optionsDiv.style.display = 'none';
				return;
			}
			
			optionsDiv.innerHTML = matchingClients.map(client => `
				<div onclick="selectTaskClient('${client.ID}', '${client.name}')" 
					 style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; hover: background #f0f0f0;">
					<div style="font-weight: 600;">${client.name}</div>
					<div style="font-size: 12px; color: #666;">${client.full_address || ''}</div>
				</div>
			`).join('');
			
			optionsDiv.style.display = 'block';
		}

		// Select client for task
		function selectTaskClient(clientId, clientName) {
			document.getElementById('taskClientSearch').value = clientName;
			document.getElementById('taskClientId').value = clientId;
			document.getElementById('taskClientOptions').style.display = 'none';
		}

		// Save task
		async function saveTask(event, taskId = null) {
			event.preventDefault();
			
			const clientId = document.getElementById('taskClientId').value;
			const client = locations.find(loc => loc.ID === clientId);
			
			if (!clientId || !client) {
				showToast('❌ נא לבחור לקוח', 'error');
				return;
			}
			
			const taskData = {
				ID: taskId || 'TASK_' + Date.now(),
				scope: document.getElementById('taskScope').value,
				client_id: clientId,
				client_name: client ? client.name : '',
				type: document.getElementById('taskType').value,
				description: document.getElementById('taskDescription').value,
				due_date: document.getElementById('taskDueDate').value,
				priority: document.getElementById('taskPriority').value,
				estimated_cost: parseFloat(document.getElementById('taskEstimatedCost').value) || 0,
				equipment: document.getElementById('taskEquipment').value,
				notes: document.getElementById('taskNotes').value,
				recurring: document.getElementById('taskRecurring').checked,
				recurring_interval: document.getElementById('taskRecurringInterval')?.value || '',
				status: taskId ? (tasks.find(t => t.ID === taskId)?.status || 'pending') : 'pending',
				created_date: taskId ? (tasks.find(t => t.ID === taskId)?.created_date || getLocalDateString()) : getLocalDateString(),
				completed_date: ''
			};
			
			if (taskId) {
				// Update existing
				const index = tasks.findIndex(t => t.ID === taskId);
				if (index !== -1) {
					tasks[index] = taskData;
				}
				showToast('✅ משימה עודכנה', 'success');
			} else {
				// Add new
				tasks.push(taskData);
				showToast('✅ משימה נוספה', 'success');
			}
			
			saveToLocalStorage();
			closeAnyModal();
			displayTasks();
			
			// Save to cloud if connected
			if (access_token && SPREADSHEET_ID) {
				try {
					await saveTasksToSheets();
				} catch (error) {
					console.error('Error saving tasks to cloud:', error);
				}
			}
		}

		// Show edit task modal
		function showEditTaskModal(taskId) {
			const task = tasks.find(t => t.ID === taskId);
			if (!task) {
				showToast('❌ משימה לא נמצאה', 'error');
				return;
			}
			
			showAddTaskModal();
			
			// Fill form with task data
			setTimeout(() => {
				document.getElementById('taskScope').value = task.scope || 'client';
				toggleTaskClientField();
				document.getElementById('taskClientSearch').value = task.client_name || '';
				document.getElementById('taskClientId').value = task.client_id || '';
				document.getElementById('taskType').value = task.type || '';
				document.getElementById('taskDescription').value = task.description || '';
				document.getElementById('taskDueDate').value = task.due_date || '';
				document.getElementById('taskPriority').value = task.priority || 'normal';
				document.getElementById('taskEstimatedCost').value = task.estimated_cost || '';
				document.getElementById('taskEquipment').value = task.equipment || '';
				document.getElementById('taskNotes').value = task.notes || '';
				document.getElementById('taskRecurring').checked = task.recurring || false;
				if (task.recurring) {
					toggleRecurringOptions();
					document.getElementById('taskRecurringInterval').value = task.recurring_interval || 'quarterly';
				}
				
				// Update form to edit mode
				const form = document.getElementById('taskForm');
				form.onsubmit = (e) => saveTask(e, taskId);
				
				// Update title
				const title = form.parentElement.querySelector('h3');
				if (title) title.innerHTML = '✏️ עריכת משימה';
			}, 100);
		}

		// Update task status
		async function updateTaskStatus(taskId, newStatus) {
			const task = tasks.find(t => t.ID === taskId);
			if (!task) return;
			
			task.status = newStatus;
			
			if (newStatus === 'completed') {
				task.completed_date = getLocalDateString();
			}
			
			saveToLocalStorage();
			displayTasks();
			
			const statusLabel = TASK_STATUSES[newStatus]?.label || newStatus;
			showToast(`✅ סטטוס עודכן ל: ${statusLabel}`, 'success');
			
			// Save to cloud if connected
			if (access_token && SPREADSHEET_ID) {
				try {
					await saveTasksToSheets();
				} catch (error) {
					console.error('Error saving tasks to cloud:', error);
				}
			}
		}

		// Complete task - with option to create visit
		async function completeTask(taskId) {
			const task = tasks.find(t => t.ID === taskId);
			if (!task) return;
			
			const createVisit = confirm(
				`✅ לסמן את המשימה כהושלמה?\n\n` +
				`${task.description}\n\n` +
				`האם ליצור גם רשומת טיפול?`
			);
			
			task.status = 'completed';
			task.completed_date = getLocalDateString();
			
			saveToLocalStorage();
			displayTasks();
			showToast('✅ משימה הושלמה', 'success');
			
			// Create visit if requested
			if (createVisit && task.client_id) {
				closeAnyModal();
				setTimeout(() => {
					showVisitForm(null, task.client_id);
					// Pre-fill work done
					setTimeout(() => {
						const workDoneField = document.getElementById('visitFormWorkDone');
						if (workDoneField) {
							const typeLabel = TASK_TYPES[task.type]?.label || task.type;
							workDoneField.value = `${typeLabel}: ${task.description}`;
						}
						const amountField = document.getElementById('visitFormAmount');
						if (amountField && task.estimated_cost) {
							amountField.value = task.estimated_cost;
						}
					}, 200);
				}, 100);
			}
			
			// Handle recurring tasks
			if (task.recurring && task.recurring_interval) {
				createNextRecurringTask(task);
			}
			
			// Save to cloud if connected
			if (access_token && SPREADSHEET_ID) {
				try {
					await saveTasksToSheets();
				} catch (error) {
					console.error('Error saving tasks to cloud:', error);
				}
			}
		}

		// Create next recurring task
		function createNextRecurringTask(originalTask) {
			const intervalDays = {
				'weekly': 7,
				'biweekly': 14,
				'monthly': 30,
				'quarterly': 90,
				'biannual': 180,
				'yearly': 365
			};
			
			const days = intervalDays[originalTask.recurring_interval] || 90;
			const nextDate = new Date(originalTask.due_date);
			nextDate.setDate(nextDate.getDate() + days);
			
			const newTask = {
				...originalTask,
				ID: 'TASK_' + Date.now(),
				status: 'pending',
				due_date: getLocalDateString(nextDate),
				created_date: getLocalDateString(),
				completed_date: ''
			};
			
			tasks.push(newTask);
			saveToLocalStorage();
			
			showToast(`🔄 נוצרה משימה חוזרת ל-${formatDate(newTask.due_date)}`, 'info');
		}

		// Delete task
		async function deleteTask(taskId) {
			const task = tasks.find(t => t.ID === taskId);
			if (!task) return;
			
			if (!confirm(`האם למחוק את המשימה?\n\n${task.description}`)) {
				return;
			}
			
			tasks = tasks.filter(t => t.ID !== taskId);
			saveToLocalStorage();
			displayTasks();
			showToast('🗑️ משימה נמחקה', 'success');
			
			// Save to cloud if connected
			if (access_token && SPREADSHEET_ID) {
				try {
					await saveTasksToSheets();
				} catch (error) {
					console.error('Error saving tasks to cloud:', error);
				}
			}
		}

		// Save tasks to Google Sheets
		async function saveTasksToSheets() {
			if (!access_token || !SPREADSHEET_ID) return;
			
			try {
			// Check if Tasks sheet exists, create if not
			const spreadsheet = await gapi.client.sheets.spreadsheets.get({
				spreadsheetId: SPREADSHEET_ID
			});
			
			const tasksSheet = spreadsheet.result.sheets.find(s => s.properties.title === 'Tasks');
			
			if (!tasksSheet) {
				// Create Tasks sheet
				await gapi.client.sheets.spreadsheets.batchUpdate({
					spreadsheetId: SPREADSHEET_ID,
					resource: {
						requests: [{
							addSheet: {
								properties: { title: 'Tasks' }
							}
						}]
					}
				});
				
				// Add headers
				await gapi.client.sheets.spreadsheets.values.update({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Tasks!A1:P1',
					valueInputOption: 'RAW',
					resource: {
						values: [['ID', 'scope', 'client_id', 'client_name', 'type', 'description', 'due_date', 'priority', 'estimated_cost', 'equipment', 'notes', 'recurring', 'recurring_interval', 'status', 'created_date', 'completed_date']]
					}
				});
			}
			
			// Clear existing data (except header)
				await gapi.client.sheets.spreadsheets.values.clear({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Tasks!A2:P1000'
				});
				
				// Write tasks
				if (tasks.length > 0) {
					const rows = tasks.map(t => [
						t.ID,
						t.scope || 'client',
						t.client_id,
						t.client_name,
						t.type,
						t.description,
						t.due_date,
						t.priority,
						t.estimated_cost,
						t.equipment,
						t.notes,
						t.recurring ? '1' : '0',
						t.recurring_interval,
						t.status,
						t.created_date,
						t.completed_date
					]);
					
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: 'Tasks!A2',
						valueInputOption: 'RAW',
						resource: { values: rows }
					});
				}
				
				console.log('✅ Tasks saved to cloud');
			} catch (error) {
				console.error('Error saving tasks:', error);
				throw error;
			}
		}

		// Load tasks from Google Sheets
		async function loadTasksFromSheets() {
			if (!access_token || !SPREADSHEET_ID) return;
			
			try {
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Tasks!A2:P1000'
				});
				
				const rows = response.result.values || [];
				
				tasks = rows.map(row => ({
					ID: row[0] || '',
					scope: row[1] || 'client',
					client_id: row[2] || '',
					client_name: row[3] || '',
					type: row[4] || 'other',
					description: row[5] || '',
					due_date: row[6] || '',
					priority: row[7] || 'normal',
					estimated_cost: parseFloat(row[8]) || 0,
					equipment: row[9] || '',
					notes: row[10] || '',
					recurring: row[11] === '1',
					recurring_interval: row[12] || '',
					status: row[13] || 'pending',
					created_date: row[14] || '',
					completed_date: row[15] || ''
				}));
				
				console.log(`✅ Loaded ${tasks.length} tasks from cloud`);
				displayTasks();
			} catch (error) {
				if (error.status === 400 && error.result?.error?.message?.includes('Unable to parse range')) {
					// Tasks sheet doesn't exist yet - that's ok
					console.log('Tasks sheet not found - will be created on first save');
				} else {
					console.error('Error loading tasks:', error);
				}
			}
		}

		// ==================== SCHEDULE CLIENT ====================

		// Show schedule client modal
		function showScheduleClientModal() {
			const today = getLocalDateString();
			const tomorrow = getLocalDateString(new Date(Date.now() + 86400000));
			
			const modalHTML = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 90vw; max-height: 90vh; overflow-y: auto; position: relative;">
					<button onclick="closeAnyModal()" style="position: absolute; top: 15px; left: 15px; background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px;">×</button>
					
					<h3 style="margin: 0 0 20px 0; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
						📅 זמן לקוח
					</h3>
					
					<!-- Client Search -->
					<div style="margin-bottom: 15px;">
						<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">לקוח:</label>
						<div style="position: relative;">
							<input type="text" id="scheduleClientSearch" placeholder="🔍 הקלד שם לקוח..." 
								   onkeyup="filterScheduleClients()" 
								   autocomplete="off"
								   style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px;">
							<div id="scheduleClientOptions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: white; border: 2px solid #667eea; border-top: none; border-radius: 0 0 8px 8px; z-index: 100;"></div>
						</div>
						<input type="hidden" id="scheduleClientId">
					</div>
					
					<!-- Date Selection -->
					<div style="margin-bottom: 15px;">
						<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">תאריך:</label>
						<div style="display: flex; gap: 8px; margin-bottom: 8px;">
							<button type="button" onclick="setScheduleDate('${today}')" style="flex: 1; padding: 8px; background: #e8f5e9; border: 2px solid #27ae60; border-radius: 6px; cursor: pointer; font-weight: 600; color: #27ae60;">
								היום
							</button>
							<button type="button" onclick="setScheduleDate('${tomorrow}')" style="flex: 1; padding: 8px; background: #e3f2fd; border: 2px solid #2196f3; border-radius: 6px; cursor: pointer; font-weight: 600; color: #2196f3;">
								מחר
							</button>
						</div>
						<input type="date" id="scheduleDate" value="${today}" 
							   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
					</div>
					
					<!-- Type Selection -->
					<div style="margin-bottom: 15px;">
						<label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">סוג:</label>
						<div style="display: flex; gap: 10px;">
							<label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;" onclick="toggleScheduleType('treatment')">
								<input type="radio" name="scheduleType" value="treatment" checked style="width: 18px; height: 18px;">
								<span style="font-weight: 600;">🌿 טיפול רגיל</span>
							</label>
							<label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;" onclick="toggleScheduleType('task')">
								<input type="radio" name="scheduleType" value="task" style="width: 18px; height: 18px;">
								<span style="font-weight: 600;">📋 משימה</span>
							</label>
						</div>
					</div>
					
					<!-- Task Details (hidden by default) -->
					<div id="scheduleTaskDetails" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
						<div style="margin-bottom: 10px;">
							<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">סוג משימה:</label>
							<select id="scheduleTaskType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
								<option value="pest_control">🪲 הדברה</option>
								<option value="planting">🌱 שתילה</option>
								<option value="tree_trimming">✂️ גיזום עצים</option>
								<option value="upgrade">🏡 שדרוג גינה</option>
								<option value="repair">🔧 תיקון</option>
								<option value="irrigation">💧 השקייה</option>
								<option value="other">📦 אחר</option>
							</select>
						</div>
						<div>
							<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">תיאור:</label>
							<input type="text" id="scheduleTaskDescription" placeholder="מה צריך לעשות?" 
								   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
						</div>
					</div>
					
					<!-- Submit -->
					<div style="display: flex; gap: 10px;">
						<button onclick="saveScheduleClient()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
							💾 שמור
						</button>
						<button onclick="closeAnyModal()" style="padding: 12px 20px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer;">
							ביטול
						</button>
					</div>
				</div>
			`;
			
			showEditModal(modalHTML);
		}

		// Set schedule date from quick buttons
		function setScheduleDate(date) {
			document.getElementById('scheduleDate').value = date;
		}

		// Toggle schedule type (show/hide task details)
		function toggleScheduleType(type) {
			const taskDetails = document.getElementById('scheduleTaskDetails');
			if (type === 'task') {
				taskDetails.style.display = 'block';
			} else {
				taskDetails.style.display = 'none';
			}
		}

		// Filter clients for schedule modal
		function filterScheduleClients() {
			const searchInput = document.getElementById('scheduleClientSearch');
			const optionsDiv = document.getElementById('scheduleClientOptions');
			const searchTerm = searchInput.value.toLowerCase();
			
			if (searchTerm.length < 1) {
				optionsDiv.style.display = 'none';
				return;
			}
			
			const matchingClients = locations.filter(loc => 
				loc.active === '1' && 
				(loc.name?.toLowerCase().includes(searchTerm) || 
				 loc.full_address?.toLowerCase().includes(searchTerm) ||
				 loc.contact_person?.toLowerCase().includes(searchTerm))
			).slice(0, 10);
			
			if (matchingClients.length === 0) {
				optionsDiv.innerHTML = '<div style="padding: 15px; color: #666; text-align: center;">לא נמצאו לקוחות</div>';
				optionsDiv.style.display = 'block';
				return;
			}
			
			optionsDiv.innerHTML = matchingClients.map(client => `
				<div onclick="selectScheduleClient('${client.ID}', '${client.name.replace(/'/g, "\\'")}')" 
					 style="padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;"
					 onmouseover="this.style.background='#f0f0ff'" onmouseout="this.style.background='white'">
					<div style="font-weight: 600; color: #333;">${client.name}</div>
					<div style="font-size: 12px; color: #666;">${client.full_address || ''}</div>
				</div>
			`).join('');
			
			optionsDiv.style.display = 'block';
		}

		// Select client for scheduling
		function selectScheduleClient(clientId, clientName) {
			document.getElementById('scheduleClientSearch').value = clientName;
			document.getElementById('scheduleClientId').value = clientId;
			document.getElementById('scheduleClientOptions').style.display = 'none';
		}

		// Save scheduled client
		async function saveScheduleClient() {
			const clientId = document.getElementById('scheduleClientId').value;
			const scheduleDate = document.getElementById('scheduleDate').value;
			const scheduleType = document.querySelector('input[name="scheduleType"]:checked')?.value;
			
			if (!clientId) {
				showToast('❌ נא לבחור לקוח', 'error');
				return;
			}
			
			if (!scheduleDate) {
				showToast('❌ נא לבחור תאריך', 'error');
				return;
			}
			
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('❌ לקוח לא נמצא', 'error');
				return;
			}
			
			if (scheduleType === 'treatment') {
				// Update client's next_visit date
				client.next_visit = scheduleDate;
				saveToLocalStorage();
				
				closeAnyModal();
				loadPlanningData();
				loadTodayTreatments();
				
				showToast(`✅ ${client.name} תוזמן ל-${formatDate(scheduleDate)}`, 'success');
				
				// Save to cloud if connected
				if (access_token && SPREADSHEET_ID) {
					try {
						await saveLocationToSheets(client);
					} catch (error) {
						console.error('Error saving to cloud:', error);
					}
				}
				
			} else if (scheduleType === 'task') {
				// Create new task
				const taskType = document.getElementById('scheduleTaskType').value;
				const taskDescription = document.getElementById('scheduleTaskDescription').value;
				
				if (!taskDescription) {
					showToast('❌ נא להזין תיאור למשימה', 'error');
					return;
				}
				
				const newTask = {
					ID: 'TASK_' + Date.now(),
					client_id: clientId,
					client_name: client.name,
					type: taskType,
					description: taskDescription,
					due_date: scheduleDate,
					priority: 'normal',
					estimated_cost: 0,
					equipment: '',
					notes: '',
					recurring: false,
					recurring_interval: '',
					status: 'pending',
					created_date: getLocalDateString(),
					completed_date: ''
				};
				
				tasks.push(newTask);
				saveToLocalStorage();
				
				closeAnyModal();
				loadTodayTreatments();
				displayTasks();
				
				showToast(`✅ משימה נוצרה ל-${client.name} בתאריך ${formatDate(scheduleDate)}`, 'success');
				
				// Save to cloud if connected
				if (access_token && SPREADSHEET_ID) {
					try {
						await saveTasksToSheets();
					} catch (error) {
						console.error('Error saving to cloud:', error);
					}
				}
			}
		}

		// ==================== CLIENT BALANCE REPORT ====================

		// Show modal to select date range for balance report
		function showBalanceReportModal(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			// Get client's first visit date for default range
			const clientVisits = visits.filter(v => v.location_id === clientId).sort((a, b) => a.date.localeCompare(b.date));
			const firstVisitDate = clientVisits.length > 0 ? clientVisits[0].date : getLocalDateString();
			const today = getLocalDateString();
			
			const modalHTML = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 400px; width: 90vw; position: relative;">
					<button onclick="closeAnyModal()" 
							style="position: absolute; top: 15px; left: 15px; background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px;">×</button>
					
					<h3 style="margin: 0 0 20px 0; color: #9b59b6; border-bottom: 2px solid #9b59b6; padding-bottom: 10px;">
						📄 הפקת דוח מאזן
					</h3>
					
					<div style="margin-bottom: 15px;">
						<div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px;">
							👤 ${client.name}
						</div>
					</div>
					
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
						<div>
							<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">מתאריך:</label>
							<input type="date" id="reportDateFrom" value="${firstVisitDate}"
								   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
						</div>
						<div>
							<label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">עד תאריך:</label>
							<input type="date" id="reportDateTo" value="${today}"
								   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
						</div>
					</div>
					
					<div style="display: flex; gap: 10px;">
						<button onclick="generateClientBalanceReport('${clientId}')" 
								style="flex: 1; padding: 12px; background: #9b59b6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
							📄 הפק דוח
						</button>
						<button onclick="closeAnyModal()" 
								style="padding: 12px 20px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer;">
							ביטול
						</button>
					</div>
				</div>
			`;
			
			const container = document.getElementById('modalContainer');
			container.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999; display: block;';
			container.innerHTML = `
				<div onclick="closeAnyModal()" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 99999;">
					<div onclick="event.stopPropagation()">
						${modalHTML}
					</div>
				</div>
			`;
		}



		// Generate balance report for client - displays in modal with copy option
		/*
		function generateClientBalanceReport(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			const dateFrom = document.getElementById('reportDateFrom').value;
			const dateTo = document.getElementById('reportDateTo').value;
			
			if (!dateFrom || !dateTo) {
				showToast('יש לבחור טווח תאריכים', 'warning');
				return;
			}
			
			// Get visits in date range
			const clientVisits = visits
				.filter(v => v.location_id === clientId && v.date >= dateFrom && v.date <= dateTo)
				.sort((a, b) => a.date.localeCompare(b.date));
			
			// Get payments in date range
			const clientPayments = payments
				.filter(p => p.client_id === clientId && p.date >= dateFrom && p.date <= dateTo)
				.sort((a, b) => a.date.localeCompare(b.date));
			
			// Calculate totals
			const totalTreatments = clientVisits.reduce((sum, v) => sum + (parseFloat(v.amount) || 0), 0);
			const totalPayments = clientPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
			const balance = totalTreatments - totalPayments;
			
			// Payment method labels
			const paymentMethods = {
				'cash': 'מזומן',
				'check': 'צק',
				'transfer': 'העברה',
				'app': 'אפליקציה',
				'credit': 'אשראי'
			};
			
			// Build treatments table
			let treatmentsHTML = '';
			let treatmentsText = '';
			
			if (clientVisits.length === 0) {
				treatmentsHTML = '<tr><td colspan="4" style="text-align: center; padding: 10px; color: #666;">אין טיפולים בתקופה זו</td></tr>';
				treatmentsText = 'אין טיפולים בתקופה זו\n';
			} else {
				clientVisits.forEach(visit => {
					let duration = '-';
					if (visit.start_time && visit.end_time) {
						const start = visit.start_time.split(':');
						const end = visit.end_time.split(':');
						const startMins = parseInt(start[0]) * 60 + parseInt(start[1]);
						const endMins = parseInt(end[0]) * 60 + parseInt(end[1]);
						const diffMins = endMins - startMins;
						if (diffMins > 0) {
							const hours = Math.floor(diffMins / 60);
							const mins = diffMins % 60;
							duration = `${hours}:${mins.toString().padStart(2, '0')}`;
						}
					}
					
					const workDone = visit.work_done || 'טיפול';
					const amount = parseFloat(visit.amount) || 0;
					
					treatmentsHTML += `
						<tr style="border-bottom: 1px solid #eee;">
							<td style="padding: 8px;">${formatDate(visit.date)}</td>
							<td style="padding: 8px;">${workDone}</td>
							<td style="padding: 8px;">${duration}</td>
							<td style="padding: 8px;">₪${amount.toFixed(0)}</td>
						</tr>
					`;
					treatmentsText += `${formatDate(visit.date)}\t${workDone}\t${duration}\t₪${amount.toFixed(0)}\n`;
				});
			}
			
			// Build payments table
			let paymentsHTML = '';
			let paymentsText = '';
			
			if (clientPayments.length === 0) {
				paymentsHTML = '<tr><td colspan="3" style="text-align: center; padding: 10px; color: #666;">אין תשלומים בתקופה זו</td></tr>';
				paymentsText = 'אין תשלומים בתקופה זו\n';
			} else {
				clientPayments.forEach(payment => {
					const method = paymentMethods[payment.method] || payment.method || '-';
					const amount = parseFloat(payment.amount) || 0;
					
					paymentsHTML += `
						<tr style="border-bottom: 1px solid #eee;">
							<td style="padding: 8px;">${formatDate(payment.date)}</td>
							<td style="padding: 8px;">${method}</td>
							<td style="padding: 8px;">₪${amount.toFixed(0)}</td>
						</tr>
					`;
					paymentsText += `${formatDate(payment.date)}\t${method}\t₪${amount.toFixed(0)}\n`;
				});
			}
			
			// Balance text
			const balanceText = balance > 0 ? `יתרה לתשלום: ₪${balance.toFixed(0)}` : 
								balance < 0 ? `יתרה לזכות: ₪${Math.abs(balance).toFixed(0)}` : 
								'מאוזן - אין יתרה';
			
			// Plain text version for copying
			const plainText = `
		דוח מאזן לקוח
		═══════════════════════════════
		${client.name}
		${client.full_address || ''}
		תקופה: ${formatDate(dateFrom)} - ${formatDate(dateTo)}
		═══════════════════════════════

		טיפולים שבוצעו (${clientVisits.length})
		───────────────────────────────
		תאריך	תיאור	משך	סכום
		${treatmentsText}סה"כ טיפולים: ₪${totalTreatments.toFixed(0)}

		תשלומים שהתקבלו (${clientPayments.length})
		───────────────────────────────
		תאריך	אמצעי תשלום	סכום
		${paymentsText}סה"כ תשלומים: ₪${totalPayments.toFixed(0)}

		═══════════════════════════════
		סיכום
		───────────────────────────────
		סה"כ טיפולים:  ₪${totalTreatments.toFixed(0)}
		סה"כ תשלומים:  ₪${totalPayments.toFixed(0)}
		${balanceText}
		═══════════════════════════════
		הופק בתאריך: ${new Date().toLocaleDateString('he-IL')}
		`.trim();

			// Build modal HTML
			const reportHTML = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 700px; width: 95vw; max-height: 85vh; overflow-y: auto; position: relative;">
					<button onclick="closeAnyModal()" 
							style="position: absolute; top: 15px; left: 15px; background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px;">×</button>
					
					<!-- Header -->
					<div style="text-align: center; background: linear-gradient(135deg, #9b59b6, #667eea); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
						<h2 style="margin: 0 0 5px 0;">דוח מאזן לקוח</h2>
						<div style="font-size: 18px; font-weight: bold;">${client.name}</div>
						<div style="font-size: 13px; opacity: 0.9;">${client.full_address || ''}</div>
						<div style="font-size: 12px; margin-top: 10px; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 15px; display: inline-block;">
							תקופה: ${formatDate(dateFrom)} - ${formatDate(dateTo)}
						</div>
					</div>
					
					<!-- Treatments Section -->
					<div style="margin-bottom: 20px;">
						<h3 style="color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 8px; margin-bottom: 10px;">
							🔧 טיפולים שבוצעו (${clientVisits.length})
						</h3>
						<table style="width: 100%; border-collapse: collapse; font-size: 14px;">
							<thead>
								<tr style="background: #f5f5f5;">
									<th style="padding: 10px; text-align: right;">תאריך</th>
									<th style="padding: 10px; text-align: right;">תיאור</th>
									<th style="padding: 10px; text-align: right;">משך</th>
									<th style="padding: 10px; text-align: right;">סכום</th>
								</tr>
							</thead>
							<tbody>
								${treatmentsHTML}
							</tbody>
							<tfoot>
								<tr style="background: #3498db; color: white; font-weight: bold;">
									<td colspan="3" style="padding: 10px; text-align: right;">סה"כ טיפולים:</td>
									<td style="padding: 10px;">₪${totalTreatments.toFixed(0)}</td>
								</tr>
							</tfoot>
						</table>
					</div>
					
					<!-- Payments Section -->
					<div style="margin-bottom: 20px;">
						<h3 style="color: #27ae60; border-bottom: 2px solid #27ae60; padding-bottom: 8px; margin-bottom: 10px;">
							💰 תשלומים שהתקבלו (${clientPayments.length})
						</h3>
						<table style="width: 100%; border-collapse: collapse; font-size: 14px;">
							<thead>
								<tr style="background: #f5f5f5;">
									<th style="padding: 10px; text-align: right;">תאריך</th>
									<th style="padding: 10px; text-align: right;">אמצעי תשלום</th>
									<th style="padding: 10px; text-align: right;">סכום</th>
								</tr>
							</thead>
							<tbody>
								${paymentsHTML}
							</tbody>
							<tfoot>
								<tr style="background: #27ae60; color: white; font-weight: bold;">
									<td colspan="2" style="padding: 10px; text-align: right;">סה"כ תשלומים:</td>
									<td style="padding: 10px;">₪${totalPayments.toFixed(0)}</td>
								</tr>
							</tfoot>
						</table>
					</div>
					
					<!-- Summary Section -->
					<div style="background: ${balance > 0 ? '#ffebee' : '#e8f5e9'}; border: 2px solid ${balance > 0 ? '#e74c3c' : '#27ae60'}; border-radius: 10px; padding: 20px; text-align: center;">
						<h3 style="margin: 0 0 15px 0; color: ${balance > 0 ? '#c0392b' : '#27ae60'};">סיכום</h3>
						<div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-bottom: 15px;">
							<div>
								<div style="font-size: 12px; color: #666;">סה"כ טיפולים</div>
								<div style="font-size: 20px; font-weight: bold; color: #3498db;">₪${totalTreatments.toFixed(0)}</div>
							</div>
							<div>
								<div style="font-size: 12px; color: #666;">סה"כ תשלומים</div>
								<div style="font-size: 20px; font-weight: bold; color: #27ae60;">₪${totalPayments.toFixed(0)}</div>
							</div>
						</div>
						<div style="font-size: 24px; font-weight: bold; color: ${balance > 0 ? '#e74c3c' : '#27ae60'};">
							${balanceText}
						</div>
					</div>
					
					<!-- Action Buttons -->
					<div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
						<button onclick="copyBalanceReport()" 
								style="padding: 12px 25px; background: #9b59b6; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">
							📋 העתק לזיכרון
						</button>
						<button onclick="closeAnyModal()" 
								style="padding: 12px 25px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer;">
							סגור
						</button>
					</div>
					
					<!-- Hidden text for copying -->
					<textarea id="balanceReportText" style="position: absolute; left: -9999px;">${plainText}</textarea>
				</div>
			`;
			
			// Show modal
			const container = document.getElementById('modalContainer');
			container.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999; display: block;';
			container.innerHTML = `
				<div onclick="closeAnyModal()" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 99999;">
					<div onclick="event.stopPropagation()">
						${reportHTML}
					</div>
				</div>
			`;
		}
		*/

		// Generate balance report for client - displays in modal with copy as HTML table
		function generateClientBalanceReport(clientId) {
			const client = locations.find(loc => loc.ID === clientId);
			if (!client) {
				showToast('לקוח לא נמצא', 'error');
				return;
			}
			
			const dateFrom = document.getElementById('reportDateFrom').value;
			const dateTo = document.getElementById('reportDateTo').value;
			
			if (!dateFrom || !dateTo) {
				showToast('יש לבחור טווח תאריכים', 'warning');
				return;
			}
			
			// Get visits in date range
			const clientVisits = visits
				.filter(v => v.location_id === clientId && v.date >= dateFrom && v.date <= dateTo)
				.sort((a, b) => a.date.localeCompare(b.date));
			
			// Get payments in date range
			const clientPayments = payments
				.filter(p => p.client_id === clientId && p.date >= dateFrom && p.date <= dateTo)
				.sort((a, b) => a.date.localeCompare(b.date));
			
			// Calculate totals
			const totalTreatments = clientVisits.reduce((sum, v) => sum + (parseFloat(v.amount) || 0), 0);
			const totalPayments = clientPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
			const balance = totalTreatments - totalPayments;
			
			// Payment method labels
			const paymentMethods = {
				'cash': 'מזומן',
				'check': 'צק',
				'transfer': 'העברה',
				'app': 'אפליקציה',
				'credit': 'אשראי'
			};
			
			// Build treatments rows
			let treatmentsHTML = '';
			let treatmentsTableHTML = '';
			
			if (clientVisits.length === 0) {
				treatmentsHTML = '<tr><td colspan="4" style="text-align: center; padding: 10px; color: #666;">אין טיפולים בתקופה זו</td></tr>';
				treatmentsTableHTML = '<tr><td colspan="4" style="text-align: center;">אין טיפולים בתקופה זו</td></tr>';
			} else {
				clientVisits.forEach(visit => {
					let duration = '-';
					if (visit.start_time && visit.end_time) {
						const start = visit.start_time.split(':');
						const end = visit.end_time.split(':');
						const startMins = parseInt(start[0]) * 60 + parseInt(start[1]);
						const endMins = parseInt(end[0]) * 60 + parseInt(end[1]);
						const diffMins = endMins - startMins;
						if (diffMins > 0) {
							const hours = Math.floor(diffMins / 60);
							const mins = diffMins % 60;
							duration = `${hours}:${mins.toString().padStart(2, '0')}`;
						}
					}
					
					const workDone = visit.work_done || 'טיפול';
					const amount = parseFloat(visit.amount) || 0;
					
					treatmentsHTML += `
						<tr style="border-bottom: 1px solid #eee;">
							<td style="padding: 8px;">${formatDate(visit.date)}</td>
							<td style="padding: 8px;">${workDone}</td>
							<td style="padding: 8px;">${duration}</td>
							<td style="padding: 8px;">₪${amount.toFixed(0)}</td>
						</tr>
					`;
					treatmentsTableHTML += `<tr><td>${formatDate(visit.date)}</td><td>${workDone}</td><td>${duration}</td><td>₪${amount.toFixed(0)}</td></tr>`;
				});
			}
			
			// Build payments rows
			let paymentsHTML = '';
			let paymentsTableHTML = '';
			
			if (clientPayments.length === 0) {
				paymentsHTML = '<tr><td colspan="3" style="text-align: center; padding: 10px; color: #666;">אין תשלומים בתקופה זו</td></tr>';
				paymentsTableHTML = '<tr><td colspan="3" style="text-align: center;">אין תשלומים בתקופה זו</td></tr>';
			} else {
				clientPayments.forEach(payment => {
					const method = paymentMethods[payment.method] || payment.method || '-';
					const amount = parseFloat(payment.amount) || 0;
					
					paymentsHTML += `
						<tr style="border-bottom: 1px solid #eee;">
							<td style="padding: 8px;">${formatDate(payment.date)}</td>
							<td style="padding: 8px;">${method}</td>
							<td style="padding: 8px;">₪${amount.toFixed(0)}</td>
						</tr>
					`;
					paymentsTableHTML += `<tr><td>${formatDate(payment.date)}</td><td>${method}</td><td>₪${amount.toFixed(0)}</td></tr>`;
				});
			}
			
			// Balance text
			const balanceText = balance > 0 ? `יתרה לתשלום: ₪${balance.toFixed(0)}` : 
								balance < 0 ? `יתרה לזכות: ₪${Math.abs(balance).toFixed(0)}` : 
								'מאוזן - אין יתרה';
			
			// HTML table version for copying (will paste as formatted table in Google Docs)
			const copyHTML = `
		<div dir="rtl" style="font-family: Arial, sans-serif;">
		<h2 style="text-align: center;">דוח מאזן לקוח</h2>
		<h3 style="text-align: center;">${client.name}</h3>
		<p style="text-align: center;">${client.full_address || ''}</p>
		<p style="text-align: center;">תקופה: ${formatDate(dateFrom)} - ${formatDate(dateTo)}</p>

		<h3>טיפולים שבוצעו (${clientVisits.length})</h3>
		<table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%;">
		<tr style="background-color: #3498db; color: white;">
		<th>תאריך</th><th>תיאור</th><th>משך</th><th>סכום</th>
		</tr>
		${treatmentsTableHTML}
		<tr style="background-color: #3498db; color: white; font-weight: bold;">
		<td colspan="3">סה"כ טיפולים:</td><td>₪${totalTreatments.toFixed(0)}</td>
		</tr>
		</table>

		<h3>תשלומים שהתקבלו (${clientPayments.length})</h3>
		<table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%;">
		<tr style="background-color: #27ae60; color: white;">
		<th>תאריך</th><th>אמצעי תשלום</th><th>סכום</th>
		</tr>
		${paymentsTableHTML}
		<tr style="background-color: #27ae60; color: white; font-weight: bold;">
		<td colspan="2">סה"כ תשלומים:</td><td>₪${totalPayments.toFixed(0)}</td>
		</tr>
		</table>

		<h3 style="text-align: center; margin-top: 20px;">סיכום</h3>
		<table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 50%; margin: 0 auto;">
		<tr><td>סה"כ טיפולים:</td><td>₪${totalTreatments.toFixed(0)}</td></tr>
		<tr><td>סה"כ תשלומים:</td><td>₪${totalPayments.toFixed(0)}</td></tr>
		<tr style="background-color: ${balance > 0 ? '#ffebee' : '#e8f5e9'}; font-weight: bold;">
		<td colspan="2" style="text-align: center;">${balanceText}</td>
		</tr>
		</table>

		<p style="text-align: center; color: #666; margin-top: 20px;">הופק בתאריך: ${new Date().toLocaleDateString('he-IL')}</p>
		</div>
		`;

			// Build modal HTML
			const reportHTML = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 700px; width: 95vw; max-height: 85vh; overflow-y: auto; position: relative;">
					<button onclick="closeAnyModal()" 
							style="position: absolute; top: 15px; left: 15px; background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px;">×</button>
					
					<!-- Header -->
					<div style="text-align: center; background: linear-gradient(135deg, #9b59b6, #667eea); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
						<h2 style="margin: 0 0 5px 0;">דוח מאזן לקוח</h2>
						<div style="font-size: 18px; font-weight: bold;">${client.name}</div>
						<div style="font-size: 13px; opacity: 0.9;">${client.full_address || ''}</div>
						<div style="font-size: 12px; margin-top: 10px; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 15px; display: inline-block;">
							תקופה: ${formatDate(dateFrom)} - ${formatDate(dateTo)}
						</div>
					</div>
					
					<!-- Treatments Section -->
					<div style="margin-bottom: 20px;">
						<h3 style="color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 8px; margin-bottom: 10px;">
							🔧 טיפולים שבוצעו (${clientVisits.length})
						</h3>
						<table style="width: 100%; border-collapse: collapse; font-size: 14px;">
							<thead>
								<tr style="background: #f5f5f5;">
									<th style="padding: 10px; text-align: right;">תאריך</th>
									<th style="padding: 10px; text-align: right;">תיאור</th>
									<th style="padding: 10px; text-align: right;">משך</th>
									<th style="padding: 10px; text-align: right;">סכום</th>
								</tr>
							</thead>
							<tbody>
								${treatmentsHTML}
							</tbody>
							<tfoot>
								<tr style="background: #3498db; color: white; font-weight: bold;">
									<td colspan="3" style="padding: 10px; text-align: right;">סה"כ טיפולים:</td>
									<td style="padding: 10px;">₪${totalTreatments.toFixed(0)}</td>
								</tr>
							</tfoot>
						</table>
					</div>
					
					<!-- Payments Section -->
					<div style="margin-bottom: 20px;">
						<h3 style="color: #27ae60; border-bottom: 2px solid #27ae60; padding-bottom: 8px; margin-bottom: 10px;">
							💰 תשלומים שהתקבלו (${clientPayments.length})
						</h3>
						<table style="width: 100%; border-collapse: collapse; font-size: 14px;">
							<thead>
								<tr style="background: #f5f5f5;">
									<th style="padding: 10px; text-align: right;">תאריך</th>
									<th style="padding: 10px; text-align: right;">אמצעי תשלום</th>
									<th style="padding: 10px; text-align: right;">סכום</th>
								</tr>
							</thead>
							<tbody>
								${paymentsHTML}
							</tbody>
							<tfoot>
								<tr style="background: #27ae60; color: white; font-weight: bold;">
									<td colspan="2" style="padding: 10px; text-align: right;">סה"כ תשלומים:</td>
									<td style="padding: 10px;">₪${totalPayments.toFixed(0)}</td>
								</tr>
							</tfoot>
						</table>
					</div>
					
					<!-- Summary Section -->
					<div style="background: ${balance > 0 ? '#ffebee' : '#e8f5e9'}; border: 2px solid ${balance > 0 ? '#e74c3c' : '#27ae60'}; border-radius: 10px; padding: 20px; text-align: center;">
						<h3 style="margin: 0 0 15px 0; color: ${balance > 0 ? '#c0392b' : '#27ae60'};">סיכום</h3>
						<div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-bottom: 15px;">
							<div>
								<div style="font-size: 12px; color: #666;">סה"כ טיפולים</div>
								<div style="font-size: 20px; font-weight: bold; color: #3498db;">₪${totalTreatments.toFixed(0)}</div>
							</div>
							<div>
								<div style="font-size: 12px; color: #666;">סה"כ תשלומים</div>
								<div style="font-size: 20px; font-weight: bold; color: #27ae60;">₪${totalPayments.toFixed(0)}</div>
							</div>
						</div>
						<div style="font-size: 24px; font-weight: bold; color: ${balance > 0 ? '#e74c3c' : '#27ae60'};">
							${balanceText}
						</div>
					</div>
					
					<!-- Action Buttons -->
					<div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
						<button onclick="copyBalanceReportHTML()" 
								style="padding: 12px 25px; background: #9b59b6; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">
							📋 העתק כטבלה
						</button>
						<button onclick="closeAnyModal()" 
								style="padding: 12px 25px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer;">
							סגור
						</button>
					</div>
					
					<!-- Hidden div for copying HTML -->
					<div id="balanceReportHTML" style="position: absolute; left: -9999px;">${copyHTML}</div>
				</div>
			`;
			
			// Show modal
			const container = document.getElementById('modalContainer');
			container.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999; display: block;';
			container.innerHTML = `
				<div onclick="closeAnyModal()" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 99999;">
					<div onclick="event.stopPropagation()">
						${reportHTML}
					</div>
				</div>
			`;
		}

		// Copy balance report as HTML (pastes as formatted table)
		function copyBalanceReportHTML() {
			const htmlContent = document.getElementById('balanceReportHTML');
			if (!htmlContent) {
				showToast('שגיאה בהעתקה', 'error');
				return;
			}
			
			// Create a blob with HTML content
			const blob = new Blob([htmlContent.innerHTML], { type: 'text/html' });
			
			// Use clipboard API to copy HTML
			navigator.clipboard.write([
				new ClipboardItem({
					'text/html': blob,
					'text/plain': new Blob([htmlContent.innerText], { type: 'text/plain' })
				})
			]).then(() => {
				showToast('📋 הדוח הועתק! הדבק ב-Google Docs', 'success');
			}).catch(err => {
				console.error('Copy failed:', err);
				// Fallback - select and copy
				const range = document.createRange();
				range.selectNode(htmlContent);
				window.getSelection().removeAllRanges();
				window.getSelection().addRange(range);
				document.execCommand('copy');
				window.getSelection().removeAllRanges();
				showToast('📋 הדוח הועתק!', 'success');
			});
		}


////==============================================================================


		// Copy balance report to clipboard
		function copyBalanceReport() {
			const textArea = document.getElementById('balanceReportText');
			if (textArea) {
				textArea.select();
				document.execCommand('copy');
				showToast('📋 הדוח הועתק לזיכרון!', 'success');
			} else {
				showToast('שגיאה בהעתקה', 'error');
			}
		}


		// בדיקת לקוחות שהיו מתוכננים לאתמול ולא טופלו
		function checkYesterdayMissed() {
			const today = new Date();
			today.setHours(0, 0, 0, 0);
			
			const yesterday = new Date(today);
			yesterday.setDate(yesterday.getDate() - 1);
			const yesterdayStr = getLocalDateString(yesterday);
			
			// מצא לקוחות שתאריך הטיפול הבא שלהם היה אתמול
			const missedYesterday = locations.filter(loc => {
				// רק פעילים
				if (loc.active !== 'כן' && loc.active !== true && loc.active !== '1') return false;
				
				// תאריך הבא היה אתמול
				if (!loc.next_visit) return false;
				if (loc.next_visit !== yesterdayStr) return false;
				
				// בדיקה שלא היה טיפול אתמול
				const hadVisitYesterday = visits.some(v => 
					v.location_id === loc.ID && v.date === yesterdayStr
				);
				
				return !hadVisitYesterday;
			});
			
			return missedYesterday;
		}

		// הצגת תזכורת למאחרים מאתמול
		function showYesterdayMissedReminder() {
			const missed = checkYesterdayMissed();
			
			if (missed.length === 0) return;
			
			// בדיקה אם כבר הצגנו היום
			const lastShown = localStorage.getItem('yesterdayMissedShown');
			const todayStr = getLocalDateString();
			if (lastShown === todayStr) return;
			
			// שמירה שהצגנו היום
			localStorage.setItem('yesterdayMissedShown', todayStr);
			
			const modalHTML = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 95vw; max-height: 80vh; overflow-y: auto; position: relative;">
					<button onclick="closeAnyModal()" 
							style="position: absolute; top: 15px; left: 15px; background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px;">×</button>
					
					<div style="text-align: center; margin-bottom: 20px;">
						<div style="font-size: 48px;">⚠️</div>
						<h3 style="margin: 10px 0; color: #e74c3c;">${missed.length} לקוחות לא טופלו אתמול</h3>
						<p style="color: #666; font-size: 14px;">עדכן להם תאריך טיפול חדש</p>
					</div>
					
					<div style="max-height: 300px; overflow-y: auto;">
						${missed.map(loc => `
							<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background: #fff5f5; border-radius: 8px; border-right: 4px solid #e74c3c;">
								<div>
									<div style="font-weight: 600; color: #333;">👤 ${loc.name}</div>
									<div style="font-size: 12px; color: #666;">מרווח: ${loc.interval_weeks || 4} שבועות</div>
								</div>
								<div style="display: flex; gap: 5px;">
									<button onclick="setNextAllowedDay('${loc.ID}', '${loc.allowed_day || 'א'}', 1); this.parentElement.parentElement.remove();" 
											style="padding: 5px 10px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
										+1W
									</button>
									<button onclick="setNextAllowedDay('${loc.ID}', '${loc.allowed_day || 'א'}', 2); this.parentElement.parentElement.remove();" 
											style="padding: 5px 10px; background: #9b59b6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
										+2W
									</button>
								</div>
							</div>
						`).join('')}
					</div>
					
					<div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
						<button onclick="closeAnyModal()" 
								style="padding: 12px 25px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer;">
							אטפל בזה אחר כך
						</button>
					</div>
				</div>
			`;
			
			const container = document.getElementById('modalContainer');
			container.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999; display: block;';
			container.innerHTML = `
				<div onclick="closeAnyModal()" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 99999;">
					<div onclick="event.stopPropagation()">
						${modalHTML}
					</div>
				</div>
			`;
		}

		// הצגת שאלה להפקת קבלה אחרי תשלום
		function showReceiptPrompt(payment) {
			const modalHTML = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 400px; width: 90vw; text-align: center;">
					<div style="font-size: 48px; margin-bottom: 15px;">🧾</div>
					<h3 style="margin: 0 0 10px 0; color: #2c3e50;">להפיק קבלה?</h3>
					<p style="color: #666; margin-bottom: 20px;">
						תשלום ${payment.amount} ₪ מ${payment.client_name}
					</p>
					<div style="display: flex; gap: 10px; justify-content: center;">
						<button onclick="createReceiptFromPayment('${payment.ID}'); closeAnyModal();" 
								style="padding: 12px 25px; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
							✓ כן, הפק קבלה
						</button>
						<button onclick="closeAnyModal();" 
								style="padding: 12px 25px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
							לא עכשיו
						</button>
					</div>
				</div>
			`;
			
			const container = document.getElementById('modalContainer');
			container.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5);';
			container.innerHTML = `<div onclick="event.stopPropagation()">${modalHTML}</div>`;
			container.onclick = closeAnyModal;
		}


		// יצירת קבלה מתשלום קיים
		function createReceiptFromPayment(paymentId) {
			const payment = payments.find(p => p.ID === paymentId);
			if (!payment) {
				showToast('תשלום לא נמצא', 'error');
				return;
			}
			
			// בדיקה אם כבר יש קבלה לתשלום זה
			if (payment.receipt_id) {
				showToast('כבר קיימת קבלה לתשלום זה', 'warning');
				return;
			}
			
			// חישוב מספר קבלה הבא
			const maxReceiptNum = receipts.length > 0 
				? Math.max(...receipts.map(r => parseInt(r.receipt_number) || 0))
				: 0;
			const nextReceiptNum = maxReceiptNum + 1;
			
			// חישוב מספר פנקס (כל 50 קבלות)
			const bookNumber = Math.floor((nextReceiptNum - 1) / 50) + 1;
			
			// תרגום אמצעי תשלום
			const methodTranslation = {
				'cash': 'מזומן',
				'transfer': 'העברה',
				'check': 'צ׳ק',
				'credit': 'אשראי',
				'bit': 'ביט'
			};
			const paymentType = methodTranslation[payment.method] || payment.method || 'מזומן';
			
			// יצירת קבלה חדשה
			const newReceipt = {
				ID: 'R' + Date.now(),
				book_number: bookNumber.toString(),
				receipt_number: nextReceiptNum.toString(),
				date: payment.date,
				location_id: payment.client_id || payment.location_id,
				location_name: payment.client_name || payment.location_name,
				amount: payment.amount,
				payment_type: paymentType,
				notes: `קבלה עבור תשלום ${payment.ID}`,
				payment_id: payment.ID
			};
			
			// הוספה למערך
			receipts.push(newReceipt);
			
			// עדכון התשלום עם מזהה הקבלה
			payment.receipt_id = newReceipt.ID;
			
			// שמירה
			saveToLocalStorage();
			
			// שמירה לענן
			if (access_token && SPREADSHEET_ID) {
				saveReceiptsBatch(receipts).catch(err => console.error('Error saving receipt:', err));
				savePaymentsBatch(payments).catch(err => console.error('Error saving payment:', err));
			}
			
			showToast(`✅ קבלה ${nextReceiptNum} נוצרה בהצלחה`, 'success');
			
			// רענון תצוגה אם בטאב קבלות
			if (typeof displayReceipts === 'function') {
				displayReceipts();
			}
		}


		// יצירת גיבוי של כל הנתונים
		async function createBackup() {
			if (!access_token || !SPREADSHEET_ID) {
				showToast('נדרש חיבור לענן ליצירת גיבוי', 'error');
				return false;
			}
			
			showToast('💾 יוצר גיבוי...', 'info');
			
			try {
				const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
				
				// רשימת הגיליונות לגיבוי
				const sheetsToBackup = ['Locations', 'Visits', 'Receipts', 'Payments', 'PaymentVisitLinks', 'Tasks', 'Incomes', 'Expenses'];
				
				for (const sheetName of sheetsToBackup) {
					const backupSheetName = `${sheetName}_Backup`;
					
					// קריאת הנתונים מהגיליון המקורי
					try {
						const response = await gapi.client.sheets.spreadsheets.values.get({
							spreadsheetId: SPREADSHEET_ID,
							range: `${sheetName}!A:ZZ`
						});
						
						const values = response.result.values || [];
						
						if (values.length === 0) {
							console.log(`⏭️ ${sheetName} ריק - מדלג`);
							continue;
						}
						
						// בדיקה אם גיליון הגיבוי קיים, אם לא - יצירה
						await ensureBackupSheetExists(backupSheetName);
						
						// ניקוי גיליון הגיבוי
						await gapi.client.sheets.spreadsheets.values.clear({
							spreadsheetId: SPREADSHEET_ID,
							range: `${backupSheetName}!A:ZZ`
						});
						
						// כתיבת הנתונים לגיליון הגיבוי
						await gapi.client.sheets.spreadsheets.values.update({
							spreadsheetId: SPREADSHEET_ID,
							range: `${backupSheetName}!A1`,
							valueInputOption: 'RAW',
							resource: { values: values }
						});
						
						console.log(`✅ ${sheetName} גובה בהצלחה (${values.length} שורות)`);
						
					} catch (err) {
						console.log(`⚠️ ${sheetName} לא קיים או שגיאה:`, err.message);
					}
				}
				
				// שמירת זמן הגיבוי
				localStorage.setItem('lastBackupTime', new Date().toISOString());
				updateBackupStatus();
				
				showToast('✅ גיבוי נוצר בהצלחה!', 'success');
				return true;
				
			} catch (error) {
				console.error('❌ שגיאה ביצירת גיבוי:', error);
				showToast('❌ שגיאה ביצירת גיבוי', 'error');
				return false;
			}
		}

		// וידוא שגיליון גיבוי קיים
		async function ensureBackupSheetExists(sheetName) {
			try {
				// ניסיון לקרוא מהגיליון
				await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: `${sheetName}!A1`
				});
			} catch (error) {
				// הגיליון לא קיים - יצירה
				console.log(`📝 יוצר גיליון גיבוי: ${sheetName}`);
				await gapi.client.sheets.spreadsheets.batchUpdate({
					spreadsheetId: SPREADSHEET_ID,
					resource: {
						requests: [{
							addSheet: {
								properties: { title: sheetName }
							}
						}]
					}
				});
			}
		}


		// הצגת אישור לפני שחזור
		function showRestoreConfirm() {
			const lastBackup = localStorage.getItem('lastBackupTime');
			const lastBackupText = lastBackup 
				? `גיבוי אחרון: ${new Date(lastBackup).toLocaleString('he-IL')}`
				: 'לא נמצא מידע על גיבוי אחרון';
			
			const modalHTML = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 450px; width: 90vw; text-align: center;">
					<div style="font-size: 48px; margin-bottom: 15px;">⚠️</div>
					<h3 style="margin: 0 0 10px 0; color: #dc3545;">שחזור מגיבוי</h3>
					<p style="color: #666; margin-bottom: 10px;">
						פעולה זו תחליף את כל הנתונים הנוכחיים בנתונים מהגיבוי.
					</p>
					<p style="color: #856404; background: #fff3cd; padding: 10px; border-radius: 6px; margin-bottom: 20px; font-size: 13px;">
						${lastBackupText}
					</p>
					<div style="display: flex; gap: 10px; justify-content: center;">
						<button onclick="restoreFromBackup(); closeAnyModal();" 
								style="padding: 12px 25px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
							🔄 כן, שחזר
						</button>
						<button onclick="closeAnyModal();" 
								style="padding: 12px 25px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
							ביטול
						</button>
					</div>
				</div>
			`;
			
			const container = document.getElementById('modalContainer');
			container.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5);';
			container.innerHTML = `<div onclick="event.stopPropagation()">${modalHTML}</div>`;
			container.onclick = closeAnyModal;
		}

		// שחזור מגיבוי
		async function restoreFromBackup() {
			if (!access_token || !SPREADSHEET_ID) {
				showToast('נדרש חיבור לענן לשחזור', 'error');
				return false;
			}
			
			showToast('🔄 משחזר מגיבוי...', 'info');
			
			try {
				const sheetsToRestore = ['Locations', 'Visits', 'Receipts', 'Payments', 'PaymentVisitLinks', 'Tasks', 'Incomes', 'Expenses'];
				let restoredCount = 0;
				
				for (const sheetName of sheetsToRestore) {
					const backupSheetName = `${sheetName}_Backup`;
					
					try {
						// קריאת הנתונים מגיליון הגיבוי
						const response = await gapi.client.sheets.spreadsheets.values.get({
							spreadsheetId: SPREADSHEET_ID,
							range: `${backupSheetName}!A:ZZ`
						});
						
						const values = response.result.values || [];
						
						if (values.length === 0) {
							console.log(`⏭️ ${backupSheetName} ריק - מדלג`);
							continue;
						}
						
						// ניקוי הגיליון המקורי
						await gapi.client.sheets.spreadsheets.values.clear({
							spreadsheetId: SPREADSHEET_ID,
							range: `${sheetName}!A:ZZ`
						});
						
						// כתיבת הנתונים מהגיבוי לגיליון המקורי
						await gapi.client.sheets.spreadsheets.values.update({
							spreadsheetId: SPREADSHEET_ID,
							range: `${sheetName}!A1`,
							valueInputOption: 'RAW',
							resource: { values: values }
						});
						
						console.log(`✅ ${sheetName} שוחזר בהצלחה (${values.length} שורות)`);
						restoredCount++;
						
					} catch (err) {
						console.log(`⚠️ ${backupSheetName} לא קיים או שגיאה:`, err.message);
					}
				}
				
				if (restoredCount > 0) {
					// טעינה מחדש של הנתונים
					await loadAllFromSheets();
					saveToLocalStorage();
					
					showToast(`✅ שוחזרו ${restoredCount} טבלאות בהצלחה!`, 'success');
					
					// רענון התצוגה
					if (typeof loadPlanningClientsAdvanced === 'function') {
						loadPlanningClientsAdvanced();
						renderPlanningCards();
					}
				} else {
					showToast('⚠️ לא נמצאו גיבויים לשחזור', 'warning');
				}
				
				return true;
				
			} catch (error) {
				console.error('❌ שגיאה בשחזור:', error);
				showToast('❌ שגיאה בשחזור מגיבוי', 'error');
				return false;
			}
		}

		// עדכון סטטוס גיבוי
		function updateBackupStatus() {
			const statusDiv = document.getElementById('backupStatus');
			if (!statusDiv) return;
			
			const lastBackup = localStorage.getItem('lastBackupTime');
			if (lastBackup) {
				const date = new Date(lastBackup);
				statusDiv.innerHTML = `✅ גיבוי אחרון: ${date.toLocaleString('he-IL')}`;
			} else {
				statusDiv.innerHTML = '⚠️ טרם בוצע גיבוי';
			}
		}


		// טעינת הוצאות מהענן
		async function loadExpensesFromSheets() {
			try {
				// וודא שהגיליון קיים עם כותרות
				await addHeadersToSheet('Expenses');
				
				const response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: SPREADSHEET_ID,
					range: 'Expenses!A:N'
				});
				
				if (response.result.values && response.result.values.length > 1) {
					expenses = response.result.values.slice(1).map(row => ({
						ID: row[0] || '',
						date: row[1] || '',
						amount: parseFloat(row[2]) || 0,
						description: row[3] || '',
						category: row[4] || 'other',
						expense_type: row[5] || 'general',
						client_id: row[6] || '',
						client_name: row[7] || '',
						visit_id: row[8] || '',
						vendor_name: row[9] || '',
						vendor_type: row[10] || 'other',
						payment_method: row[11] || 'cash',
						receipt_number: row[12] || '',
						notes: row[13] || ''
					}));
					console.log(`✅ Loaded ${expenses.length} expenses`);
				} else {
					expenses = [];
					console.log('ℹ️ No expenses found');
				}
			} catch (err) {
				console.error('⚠️ Error loading expenses:', err.message);
				expenses = [];
			}
		}


		// הצגת הוצאות
		function displayExpenses() {
			const container = document.getElementById('expensesContainer');
			if (!container) return;
			
			// Get filters
			const searchText = document.getElementById('expenseSearchText')?.value?.toLowerCase() || '';
			const searchVendor = document.getElementById('expenseSearchVendor')?.value?.toLowerCase() || '';
			const typeFilter = document.getElementById('expenseTypeFilter')?.value || '';
			const categoryFilter = document.getElementById('expenseCategoryFilter')?.value || '';
			const monthFilter = document.getElementById('expenseMonthFilter')?.value || '';
			
			// Filter expenses
			let filtered = [...expenses];
			
			if (searchText) {
				filtered = filtered.filter(exp => (exp.description || '').toLowerCase().includes(searchText));
			}
			
			if (searchVendor) {
				filtered = filtered.filter(exp => (exp.vendor_name || '').toLowerCase().includes(searchVendor));
			}
			
			if (typeFilter) {
				filtered = filtered.filter(exp => exp.expense_type === typeFilter);
			}
			
			if (categoryFilter) {
				filtered = filtered.filter(exp => exp.category === categoryFilter);
			}
			
			// סינון לפי תקופה
			if (window.expensePeriodFilter) {
				const today = new Date();
				today.setHours(0, 0, 0, 0);
				
				filtered = filtered.filter(exp => {
					if (!exp.date) return false;
					const expDate = new Date(exp.date);
					expDate.setHours(0, 0, 0, 0);
					
					switch (window.expensePeriodFilter) {
						case 'today':
							return expDate.getTime() === today.getTime();
						case 'week':
							const weekAgo = new Date(today);
							weekAgo.setDate(today.getDate() - 7);
							return expDate >= weekAgo && expDate <= today;
						case 'month':
							return expDate.getMonth() === today.getMonth() && expDate.getFullYear() === today.getFullYear();
						case 'year':
							return expDate.getFullYear() === today.getFullYear();
						default:
							return true;
					}
				});
			} else if (monthFilter) {
				filtered = filtered.filter(exp => exp.date && exp.date.startsWith(monthFilter));
			}
			
			// Sort by date (newest first)
			filtered.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
			
			// Update stats
			updateExpenseStats(filtered);
			
			// Display
			if (filtered.length === 0) {
				container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">אין הוצאות להצגה</div>';
				return;
			}
			
			const html = filtered.map(exp => {
				const expType = EXPENSE_TYPES[exp.expense_type] || EXPENSE_TYPES['general'];
				const categories = EXPENSE_CATEGORIES[exp.expense_type] || EXPENSE_CATEGORIES['general'];
				const category = categories[exp.category] || { name: exp.category, icon: '📦' };
				const payment = PAYMENT_METHODS[exp.payment_method] || PAYMENT_METHODS['cash'];
				
				const typeColors = {
					'general': '#27ae60',
					'client': '#f39c12',
					'vehicle': '#3498db',
					'worker': '#9b59b6'
				};
				const borderColor = typeColors[exp.expense_type] || '#999';
				
				return `
					<div style="background: white; border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 10px; border-right: 4px solid ${borderColor};">
						<div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">
							<div style="flex: 1; min-width: 200px;">
								<div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 5px;">
									${category.icon} ${exp.description}
								</div>
								<div style="font-size: 13px; color: #666;">
									📅 ${formatDate(exp.date)}
									<span style="background: ${borderColor}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-right: 8px;">${expType.icon} ${expType.name}</span>
								</div>
								${exp.vendor_name ? `
									<div style="font-size: 12px; color: #888; margin-top: 5px;">
										🏪 ${exp.vendor_name}
									</div>
								` : ''}
								${exp.expense_type === 'client' && exp.client_name ? `
									<div style="font-size: 12px; color: #f39c12; margin-top: 5px;">
										👤 ${exp.client_name}
									</div>
								` : ''}
								${exp.notes ? `
									<div style="font-size: 12px; color: #888; margin-top: 5px;">
										💬 ${exp.notes}
									</div>
								` : ''}
							</div>
							<div style="text-align: left;">
								<div style="font-size: 20px; font-weight: bold; color: #e74c3c;">
									${exp.amount} ₪
								</div>
								<div style="font-size: 11px; color: #666;">
									${payment.icon} ${payment.name}
								</div>
								<div style="margin-top: 8px; display: flex; gap: 5px;">
									<button onclick="showEditExpenseModal('${exp.ID}')" 
											style="padding: 4px 8px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
										✏️
									</button>
									<button onclick="deleteExpense('${exp.ID}')" 
											style="padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
										🗑️
									</button>
								</div>
							</div>
						</div>
					</div>
				`;
			}).join('');
			
			container.innerHTML = html;
		}


		// סינון הוצאות לפי תקופה
		function setExpenseDateFilter(period) {
			const monthFilter = document.getElementById('expenseMonthFilter');
			const today = new Date();
			const year = today.getFullYear();
			const month = String(today.getMonth() + 1).padStart(2, '0');
			
			switch (period) {
				case 'today':
				case 'week':
				case 'month':
					monthFilter.value = `${year}-${month}`;
					break;
				case 'year':
					monthFilter.value = '';
					break;
			}
			
			// שמירת התקופה לסינון מדויק יותר
			window.expensePeriodFilter = period;
			displayExpenses();
		}

		// ניקוי כל הפילטרים
		function clearExpenseFilters() {
			document.getElementById('expenseSearchText').value = '';
			document.getElementById('expenseSearchVendor').value = '';
			document.getElementById('expenseTypeFilter').value = '';
			document.getElementById('expenseCategoryFilter').value = '';
			document.getElementById('expenseMonthFilter').value = '';
			window.expensePeriodFilter = null;
			
			updateExpenseCategoryFilter();
			displayExpenses();
		}


		// עדכון סטטיסטיקות הוצאות
		function updateExpenseStats(filteredExpenses) {
			const total = filteredExpenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
			const worker = filteredExpenses.filter(exp => exp.expense_type === 'worker').reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
			const vehicle = filteredExpenses.filter(exp => exp.expense_type === 'vehicle').reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
			const general = filteredExpenses.filter(exp => exp.expense_type === 'general').reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
			const client = filteredExpenses.filter(exp => exp.expense_type === 'client').reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
			
			const totalEl = document.getElementById('totalExpensesAmount');
			const workerEl = document.getElementById('workerExpensesAmount');
			const vehicleEl = document.getElementById('vehicleExpensesAmount');
			const generalEl = document.getElementById('generalExpensesAmount');
			const clientEl = document.getElementById('clientExpensesAmount');
			const countEl = document.getElementById('expensesCount');
			
			if (totalEl) totalEl.textContent = `${total.toFixed(0)} ₪`;
			if (workerEl) workerEl.textContent = `${worker.toFixed(0)} ₪`;
			if (vehicleEl) vehicleEl.textContent = `${vehicle.toFixed(0)} ₪`;
			if (generalEl) generalEl.textContent = `${general.toFixed(0)} ₪`;
			if (clientEl) clientEl.textContent = `${client.toFixed(0)} ₪`;
			if (countEl) countEl.textContent = filteredExpenses.length;
		}



		// הצגת מודל הוספת הוצאה
		function showAddExpenseModal(clientId = '', clientName = '') {
			const today = getLocalDateString();
			const defaultType = clientId ? 'client' : 'general';
			
			// בניית רשימת לקוחות
			const clientOptions = locations
				.filter(loc => loc.active === 'כן' || loc.active === true || loc.active === '1')
				.map(loc => `<option value="${loc.ID}" ${loc.ID === clientId ? 'selected' : ''}>${loc.name}</option>`)
				.join('');
			
			const modalHTML = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 95vw; max-height: 90vh; overflow-y: auto;">
					<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
						<h3 style="margin: 0; color: #e74c3c;">💰 הוספת הוצאה</h3>
						<button onclick="closeAnyModal()" style="background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px;">×</button>
					</div>
					
					<form id="addExpenseForm" onsubmit="saveNewExpense(event)">
						<!-- תאריך וסכום -->
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600;">תאריך *</label>
								<input type="date" id="expenseDate" value="${today}" required 
									   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
							</div>
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600;">סכום *</label>
								<input type="number" id="expenseAmount" required min="0" step="0.01"
									   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
							</div>
						</div>
						
						<!-- תיאור -->
						<div style="margin-bottom: 15px;">
							<label style="display: block; margin-bottom: 5px; font-weight: 600;">תיאור *</label>
							<input type="text" id="expenseDescription" required placeholder="מה נרכש/שולם"
								   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
						</div>
						
						<!-- סוג וקטגוריה -->
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600;">סוג</label>
								<select id="expenseType" onchange="updateExpenseCategoryOptions(); toggleClientSelectInForm()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
									<option value="general" ${defaultType === 'general' ? 'selected' : ''}>📦 כללי</option>
									<option value="client" ${defaultType === 'client' ? 'selected' : ''}>👤 לקוח</option>
									<option value="vehicle">🚗 רכב</option>
									<option value="worker">👷 עובדים</option>
								</select>
							</div>
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600;">קטגוריה</label>
								<select id="expenseCategory" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
									<!-- יתמלא על ידי updateExpenseCategoryOptions -->
								</select>
							</div>
						</div>
						
						<!-- בחירת לקוח (מוסתר בהתחלה) -->
						<div id="clientSelectContainer" style="margin-bottom: 15px; display: ${clientId ? 'block' : 'none'};">
							<label style="display: block; margin-bottom: 5px; font-weight: 600;">לקוח</label>
							<select id="expenseClientId" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
								<option value="">בחר לקוח...</option>
								${clientOptions}
							</select>
						</div>
						
						<!-- שם / בית עסק -->
						<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 15px;">
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600;">שם / בית עסק</label>
								<input type="text" id="expenseVendorName" placeholder="שם העסק או העובד"
									   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
							</div>
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600;">סוג</label>
								<select id="expenseVendorType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
									<option value="store">🏪 חנות</option>
									<option value="garage">🔧 מוסך</option>
									<option value="gas_station">⛽ תחנת דלק</option>
									<option value="online">💻 מקוון</option>
									<option value="nursery">🌱 משתלה</option>
									<option value="person">👤 אדם</option>
									<option value="other">📍 אחר</option>
								</select>
							</div>
						</div>
						
						<!-- אמצעי תשלום ומספר קבלה -->
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600;">אמצעי תשלום</label>
								<select id="expensePaymentMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
									<option value="cash">💵 מזומן</option>
									<option value="credit">💳 אשראי</option>
									<option value="transfer">🏦 העברה</option>
									<option value="bit">📱 ביט</option>
									<option value="check">📝 צ׳ק</option>
								</select>
							</div>
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600;">מספר חשבונית</label>
								<input type="text" id="expenseReceiptNumber" placeholder="אופציונלי"
									   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
							</div>
						</div>
						
						<!-- הערות -->
						<div style="margin-bottom: 20px;">
							<label style="display: block; margin-bottom: 5px; font-weight: 600;">הערות</label>
							<textarea id="expenseNotes" rows="2" placeholder="הערות נוספות..."
									  style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; resize: vertical;"></textarea>
						</div>
						
						<!-- כפתורים -->
						<div style="display: flex; gap: 10px; justify-content: center;">
							<button type="submit" style="padding: 12px 30px; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">
								✓ שמור הוצאה
							</button>
							<button type="button" onclick="closeAnyModal()" style="padding: 12px 30px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
								ביטול
							</button>
						</div>
					</form>
				</div>
			`;
			
			const container = document.getElementById('modalContainer');
			container.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5);';
			container.innerHTML = `<div onclick="event.stopPropagation()">${modalHTML}</div>`;
			container.onclick = closeAnyModal;
			
			// עדכון קטגוריות לפי סוג ברירת מחדל
			updateExpenseCategoryOptions();
		}

		// עדכון קטגוריות בטופס לפי הסוג שנבחר
		function updateExpenseCategoryOptions() {
			const expenseType = document.getElementById('expenseType')?.value || 'general';
			const categorySelect = document.getElementById('expenseCategory');
			
			if (!categorySelect) return;
			
			const categories = EXPENSE_CATEGORIES[expenseType] || EXPENSE_CATEGORIES['general'];
			
			categorySelect.innerHTML = '';
			for (const [key, value] of Object.entries(categories)) {
				categorySelect.innerHTML += `<option value="${key}">${value.icon} ${value.name}</option>`;
			}
		}

		// הצגה/הסתרה של בחירת לקוח בטופס
		function toggleClientSelectInForm() {
			const expenseType = document.getElementById('expenseType')?.value;
			const clientContainer = document.getElementById('clientSelectContainer');
			if (clientContainer) {
				clientContainer.style.display = expenseType === 'client' ? 'block' : 'none';
			}
		}

		// הצגה/הסתרה של בחירת לקוח
		function toggleClientSelect() {
			const expenseType = document.getElementById('expenseType').value;
			const clientContainer = document.getElementById('clientSelectContainer');
			if (clientContainer) {
				clientContainer.style.display = expenseType === 'client' ? 'block' : 'none';
			}
		}


		// שמירת הוצאה חדשה
		function saveNewExpense(event) {
			event.preventDefault();
			
			const expenseType = document.getElementById('expenseType').value;
			const clientId = document.getElementById('expenseClientId')?.value || '';
			const client = clientId ? locations.find(loc => loc.ID === clientId) : null;
			
			const newExpense = {
				ID: 'EXP' + Date.now(),
				date: document.getElementById('expenseDate').value,
				amount: parseFloat(document.getElementById('expenseAmount').value) || 0,
				description: document.getElementById('expenseDescription').value,
				category: document.getElementById('expenseCategory').value,
				expense_type: expenseType,
				client_id: expenseType === 'client' ? clientId : '',
				client_name: expenseType === 'client' && client ? client.name : '',
				visit_id: '',
				vendor_name: document.getElementById('expenseVendorName').value,
				vendor_type: document.getElementById('expenseVendorType').value,
				payment_method: document.getElementById('expensePaymentMethod').value,
				receipt_number: document.getElementById('expenseReceiptNumber').value,
				notes: document.getElementById('expenseNotes').value
			};
			
			expenses.push(newExpense);
			saveToLocalStorage();
			
			// שמירה לענן
			if (access_token && SPREADSHEET_ID) {
				saveExpensesBatch(expenses).catch(err => console.error('Error saving expense:', err));
			}
			
			showToast('✅ הוצאה נשמרה בהצלחה', 'success');
			closeAnyModal();
			displayExpenses();
		}


		// הצגת מודל עריכת הוצאה
		function showEditExpenseModal(expenseId) {
			const expense = expenses.find(exp => exp.ID === expenseId);
			if (!expense) {
				showToast('הוצאה לא נמצאה', 'error');
				return;
			}
			
			const isClientExpense = expense.expense_type === 'client';
			
			// בניית רשימת לקוחות
			const clientOptions = locations
				.filter(loc => loc.active === 'כן' || loc.active === true || loc.active === '1')
				.map(loc => `<option value="${loc.ID}" ${loc.ID === expense.client_id ? 'selected' : ''}>${loc.name}</option>`)
				.join('');
			
			// בניית קטגוריות לפי הסוג
			const categories = EXPENSE_CATEGORIES[expense.expense_type] || EXPENSE_CATEGORIES['general'];
			const categoryOptions = Object.entries(categories)
				.map(([key, value]) => `<option value="${key}" ${expense.category === key ? 'selected' : ''}>${value.icon} ${value.name}</option>`)
				.join('');
			
			const modalHTML = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 95vw; max-height: 90vh; overflow-y: auto;">
					<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
						<h3 style="margin: 0; color: #e74c3c;">✏️ עריכת הוצאה</h3>
						<button onclick="closeAnyModal()" style="background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px;">×</button>
					</div>
					
					<form id="editExpenseForm" onsubmit="updateExpense(event, '${expenseId}')">
						<!-- תאריך וסכום -->
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600;">תאריך *</label>
								<input type="date" id="editExpenseDate" value="${expense.date}" required 
									   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
							</div>
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600;">סכום *</label>
								<input type="number" id="editExpenseAmount" value="${expense.amount}" required min="0" step="0.01"
									   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
							</div>
						</div>
						
						<!-- תיאור -->
						<div style="margin-bottom: 15px;">
							<label style="display: block; margin-bottom: 5px; font-weight: 600;">תיאור *</label>
							<input type="text" id="editExpenseDescription" value="${expense.description}" required
								   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
						</div>
						
						<!-- סוג וקטגוריה -->
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600;">סוג</label>
								<select id="editExpenseType" onchange="updateEditExpenseCategoryOptions(); toggleEditClientSelectInForm()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
									<option value="general" ${expense.expense_type === 'general' ? 'selected' : ''}>📦 כללי</option>
									<option value="client" ${expense.expense_type === 'client' ? 'selected' : ''}>👤 לקוח</option>
									<option value="vehicle" ${expense.expense_type === 'vehicle' ? 'selected' : ''}>🚗 רכב</option>
									<option value="worker" ${expense.expense_type === 'worker' ? 'selected' : ''}>👷 עובדים</option>
								</select>
							</div>
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600;">קטגוריה</label>
								<select id="editExpenseCategory" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
									${categoryOptions}
								</select>
							</div>
						</div>
						
						<!-- בחירת לקוח -->
						<div id="editClientSelectContainer" style="margin-bottom: 15px; display: ${isClientExpense ? 'block' : 'none'};">
							<label style="display: block; margin-bottom: 5px; font-weight: 600;">לקוח</label>
							<select id="editExpenseClientId" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
								<option value="">בחר לקוח...</option>
								${clientOptions}
							</select>
						</div>
						
						<!-- שם / בית עסק -->
						<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 15px;">
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600;">שם / בית עסק</label>
								<input type="text" id="editExpenseVendorName" value="${expense.vendor_name || ''}"
									   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
							</div>
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600;">סוג</label>
								<select id="editExpenseVendorType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
									<option value="store" ${expense.vendor_type === 'store' ? 'selected' : ''}>🏪 חנות</option>
									<option value="garage" ${expense.vendor_type === 'garage' ? 'selected' : ''}>🔧 מוסך</option>
									<option value="gas_station" ${expense.vendor_type === 'gas_station' ? 'selected' : ''}>⛽ תחנת דלק</option>
									<option value="online" ${expense.vendor_type === 'online' ? 'selected' : ''}>💻 מקוון</option>
									<option value="nursery" ${expense.vendor_type === 'nursery' ? 'selected' : ''}>🌱 משתלה</option>
									<option value="person" ${expense.vendor_type === 'person' ? 'selected' : ''}>👤 אדם</option>
									<option value="other" ${expense.vendor_type === 'other' ? 'selected' : ''}>📍 אחר</option>
								</select>
							</div>
						</div>
						
						<!-- אמצעי תשלום ומספר קבלה -->
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600;">אמצעי תשלום</label>
								<select id="editExpensePaymentMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
									<option value="cash" ${expense.payment_method === 'cash' ? 'selected' : ''}>💵 מזומן</option>
									<option value="credit" ${expense.payment_method === 'credit' ? 'selected' : ''}>💳 אשראי</option>
									<option value="transfer" ${expense.payment_method === 'transfer' ? 'selected' : ''}>🏦 העברה</option>
									<option value="bit" ${expense.payment_method === 'bit' ? 'selected' : ''}>📱 ביט</option>
									<option value="check" ${expense.payment_method === 'check' ? 'selected' : ''}>📝 צ׳ק</option>
								</select>
							</div>
							<div>
								<label style="display: block; margin-bottom: 5px; font-weight: 600;">מספר חשבונית</label>
								<input type="text" id="editExpenseReceiptNumber" value="${expense.receipt_number || ''}"
									   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
							</div>
						</div>
						
						<!-- הערות -->
						<div style="margin-bottom: 20px;">
							<label style="display: block; margin-bottom: 5px; font-weight: 600;">הערות</label>
							<textarea id="editExpenseNotes" rows="2"
									  style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; resize: vertical;">${expense.notes || ''}</textarea>
						</div>
						
						<!-- כפתורים -->
						<div style="display: flex; gap: 10px; justify-content: center;">
							<button type="submit" style="padding: 12px 30px; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">
								✓ עדכן
							</button>
							<button type="button" onclick="closeAnyModal()" style="padding: 12px 30px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
								ביטול
							</button>
						</div>
					</form>
				</div>
			`;
			
			const container = document.getElementById('modalContainer');
			container.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5);';
			container.innerHTML = `<div onclick="event.stopPropagation()">${modalHTML}</div>`;
			container.onclick = closeAnyModal;
		}

		// עדכון קטגוריות בטופס עריכה
		function updateEditExpenseCategoryOptions() {
			const expenseType = document.getElementById('editExpenseType')?.value || 'general';
			const categorySelect = document.getElementById('editExpenseCategory');
			
			if (!categorySelect) return;
			
			const categories = EXPENSE_CATEGORIES[expenseType] || EXPENSE_CATEGORIES['general'];
			
			categorySelect.innerHTML = '';
			for (const [key, value] of Object.entries(categories)) {
				categorySelect.innerHTML += `<option value="${key}">${value.icon} ${value.name}</option>`;
			}
		}

		// הצגה/הסתרה של בחירת לקוח בטופס עריכה
		function toggleEditClientSelectInForm() {
			const expenseType = document.getElementById('editExpenseType')?.value;
			const clientContainer = document.getElementById('editClientSelectContainer');
			if (clientContainer) {
				clientContainer.style.display = expenseType === 'client' ? 'block' : 'none';
			}
		}

		// הצגה/הסתרה של בחירת לקוח בעריכה
		function toggleEditClientSelect() {
			const expenseType = document.getElementById('editExpenseType').value;
			const clientContainer = document.getElementById('editClientSelectContainer');
			if (clientContainer) {
				clientContainer.style.display = expenseType === 'client' ? 'block' : 'none';
			}
		}

		// עדכון הוצאה
		function updateExpense(event, expenseId) {
			event.preventDefault();
			
			const expense = expenses.find(exp => exp.ID === expenseId);
			if (!expense) {
				showToast('הוצאה לא נמצאה', 'error');
				return;
			}
			
			const expenseType = document.getElementById('editExpenseType').value;
			const clientId = document.getElementById('editExpenseClientId')?.value || '';
			const client = clientId ? locations.find(loc => loc.ID === clientId) : null;
			
			expense.date = document.getElementById('editExpenseDate').value;
			expense.amount = parseFloat(document.getElementById('editExpenseAmount').value) || 0;
			expense.description = document.getElementById('editExpenseDescription').value;
			expense.category = document.getElementById('editExpenseCategory').value;
			expense.expense_type = expenseType;
			expense.client_id = expenseType === 'client' ? clientId : '';
			expense.client_name = expenseType === 'client' && client ? client.name : '';
			expense.vendor_name = document.getElementById('editExpenseVendorName').value;
			expense.vendor_type = document.getElementById('editExpenseVendorType').value;
			expense.payment_method = document.getElementById('editExpensePaymentMethod').value;
			expense.receipt_number = document.getElementById('editExpenseReceiptNumber').value;
			expense.notes = document.getElementById('editExpenseNotes').value;
			
			saveToLocalStorage();
			
			// שמירה לענן
			if (access_token && SPREADSHEET_ID) {
				saveExpensesBatch(expenses).catch(err => console.error('Error saving expense:', err));
			}
			
			showToast('✅ הוצאה עודכנה בהצלחה', 'success');
			closeAnyModal();
			displayExpenses();
		}


		// מחיקת הוצאה
		function deleteExpense(expenseId) {
			if (!confirm('האם למחוק את ההוצאה?')) return;
			
			const index = expenses.findIndex(exp => exp.ID === expenseId);
			if (index === -1) {
				showToast('הוצאה לא נמצאה', 'error');
				return;
			}
			
			expenses.splice(index, 1);
			saveToLocalStorage();
			
			// שמירה לענן
			if (access_token && SPREADSHEET_ID) {
				saveExpensesBatch(expenses).catch(err => console.error('Error saving expenses:', err));
			}
			
			showToast('✅ הוצאה נמחקה', 'success');
			displayExpenses();
		}


		// קביעת טווח תאריכים לייצוא
		function setExportDateRange(range) {
			const fromInput = document.getElementById('exportFromDate');
			const toInput = document.getElementById('exportToDate');
			
			const today = new Date();
			const currentYear = today.getFullYear();
			
			switch (range) {
				case 'year':
					fromInput.value = `${currentYear}-01-01`;
					toInput.value = getLocalDateString(today);
					break;
				case 'lastYear':
					fromInput.value = `${currentYear - 1}-01-01`;
					toInput.value = `${currentYear - 1}-12-31`;
					break;
				case 'all':
					fromInput.value = '';
					toInput.value = '';
					break;
			}
		}

		// ייצוא טיפולים במבנה קלאסי
		async function exportVisitsClassic() {
			if (!access_token || !SPREADSHEET_ID) {
				showToast('נדרש חיבור לענן לייצוא', 'error');
				return;
			}
			
			const fromDate = document.getElementById('exportFromDate')?.value || '';
			const toDate = document.getElementById('exportToDate')?.value || '';
			const statusDiv = document.getElementById('exportStatus');
			
			// סינון טיפולים לפי טווח תאריכים
			let filteredVisits = [...visits];
			
			if (fromDate) {
				filteredVisits = filteredVisits.filter(v => v.date >= fromDate);
			}
			if (toDate) {
				filteredVisits = filteredVisits.filter(v => v.date <= toDate);
			}
			
			// מיון לפי תאריך
			filteredVisits.sort((a, b) => (a.date || '').localeCompare(b.date || ''));
			
			if (filteredVisits.length === 0) {
				showToast('אין טיפולים בטווח התאריכים שנבחר', 'warning');
				return;
			}
			
			if (statusDiv) {
				statusDiv.innerHTML = `⏳ מייצא ${filteredVisits.length} טיפולים...`;
			}
			
			showToast(`📤 מייצא ${filteredVisits.length} טיפולים...`, 'info');
			
			try {
				// וודא שהגיליון קיים
				await addHeadersToSheet('ExportVisitsClassic');
				
				// המרת סטטוס תשלום
				const paidStatusMap = {
					'0': 'לא',
					'1': 'כן',
					'2': 'ללא תשלום',
					'3': 'חלקי'
				};
				
				// תאריך הייצוא
				const exportDate = getLocalDateString();
				
				// בניית הנתונים לייצוא
				const exportData = filteredVisits.map(visit => {
					const visitDate = new Date(visit.date);
					const year = visitDate.getFullYear();
					const month = visitDate.getMonth() + 1;
					const day = visitDate.getDate();
					
					// מציאת פרטי הלקוח
					const client = locations.find(loc => loc.ID === visit.location_id) || {};
					
					// המרת משך זמן לשעות
					const durationHours = visit.duration_minutes 
						? (parseFloat(visit.duration_minutes) / 60).toFixed(2)
						: '';
					
					// המרת סטטוס תשלום
					const paidStatus = paidStatusMap[visit.paid] || visit.paid || '';
					
					return [
						year,
						month,
						day,
						visit.location_name || '',
						client.full_address || visit.location_name || '',
						client.contact_person || '',
						visit.visit_type || '',
						visit.date || '',
						visit.work_done || '',
						durationHours,
						visit.amount || '',
						paidStatus,
						visit.expense || '',
						visit.notes || '',
						exportDate
					];
				});
				
				// מחיקת נתונים קיימים (שורה 2 ואילך)
				await gapi.client.sheets.spreadsheets.values.clear({
					spreadsheetId: SPREADSHEET_ID,
					range: 'ExportVisitsClassic!A2:O'
				});
				
				// כתיבת הנתונים החדשים
				if (exportData.length > 0) {
					await gapi.client.sheets.spreadsheets.values.update({
						spreadsheetId: SPREADSHEET_ID,
						range: 'ExportVisitsClassic!A2',
						valueInputOption: 'RAW',
						resource: { values: exportData }
					});
				}
				
				// שמירת זמן הייצוא
				localStorage.setItem('lastExportTime', new Date().toISOString());
				
				if (statusDiv) {
					const rangeText = fromDate || toDate 
						? `(${fromDate || 'התחלה'} עד ${toDate || 'היום'})`
						: '(כל הטיפולים)';
					statusDiv.innerHTML = `✅ יוצאו ${filteredVisits.length} טיפולים ${rangeText} - ${new Date().toLocaleString('he-IL')}`;
				}
				
				showToast(`✅ יוצאו ${filteredVisits.length} טיפולים בהצלחה!`, 'success');
				
			} catch (error) {
				console.error('❌ שגיאה בייצוא:', error);
				if (statusDiv) {
					statusDiv.innerHTML = `❌ שגיאה בייצוא: ${error.message}`;
				}
				showToast('❌ שגיאה בייצוא', 'error');
			}
		}


		// דוח סיכום הכנסות שנתי
		function showYearlyIncomeReport() {
			// מציאת טווח השנים בנתונים
			const years = [...new Set(visits.map(v => {
				if (!v.date) return null;
				return new Date(v.date).getFullYear();
			}).filter(y => y !== null))].sort((a, b) => b - a);
			
			if (years.length === 0) {
				showToast('אין נתונים להצגה', 'warning');
				return;
			}
			
			const currentYear = new Date().getFullYear();
			const defaultYear = years.includes(currentYear) ? currentYear : years[0];
			
			// בניית אפשרויות שנים
			const yearOptions = years.map(y => 
				`<option value="${y}" ${y === defaultYear ? 'selected' : ''}>${y}</option>`
			).join('');
			
			const modalHTML = `
				<div style="background: white; padding: 25px; border-radius: 12px; max-width: 800px; width: 95vw; max-height: 90vh; overflow-y: auto;">
					<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
						<h3 style="margin: 0; color: #9c27b0;">📈 סיכום הכנסות שנתי</h3>
						<button onclick="closeAnyModal()" style="background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px;">×</button>
					</div>
					
					<!-- בחירת שנה -->
					<div style="margin-bottom: 20px; text-align: center;">
						<label style="font-size: 14px; margin-left: 10px;">בחר שנה:</label>
						<select id="reportYear" onchange="updateYearlyIncomeReport()" style="padding: 10px 20px; font-size: 16px; border-radius: 8px; border: 2px solid #9c27b0;">
							${yearOptions}
						</select>
					</div>
					
					<!-- תוכן הדוח -->
					<div id="yearlyReportContent">
						<!-- יתמלא על ידי updateYearlyIncomeReport -->
					</div>
				</div>
			`;
			
			const container = document.getElementById('modalContainer');
			container.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5);';
			container.innerHTML = `<div onclick="event.stopPropagation()">${modalHTML}</div>`;
			container.onclick = closeAnyModal;
			
			// הצגת הדוח לשנה הנבחרת
			updateYearlyIncomeReport();
		}

		// עדכון תוכן דוח הכנסות שנתי
		function updateYearlyIncomeReport() {
			const year = parseInt(document.getElementById('reportYear').value);
			const contentDiv = document.getElementById('yearlyReportContent');
			
			if (!contentDiv) return;
			
			// סינון טיפולים לשנה הנבחרת
			const yearVisits = visits.filter(v => {
				if (!v.date) return false;
				return new Date(v.date).getFullYear() === year;
			});
			
			// סינון הוצאות לשנה הנבחרת
			const yearExpenses = expenses.filter(exp => {
				if (!exp.date) return false;
				return new Date(exp.date).getFullYear() === year;
			});
			
			// חישוב נתונים לכל חודש
			const monthlyData = [];
			const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
			
			for (let month = 0; month < 12; month++) {
				// טיפולים בחודש
				const monthVisits = yearVisits.filter(v => new Date(v.date).getMonth() === month);
				
				// הוצאות בחודש
				const monthExpenses = yearExpenses.filter(exp => new Date(exp.date).getMonth() === month);
				
				// חישובים
				const visitsCount = monthVisits.length;
				const totalMinutes = monthVisits.reduce((sum, v) => sum + (parseFloat(v.duration_minutes) || 0), 0);
				const totalHours = totalMinutes / 60;
				const totalIncome = monthVisits.reduce((sum, v) => sum + (parseFloat(v.amount) || 0), 0);
				const visitExpenses = monthVisits.reduce((sum, v) => sum + (parseFloat(v.expense) || 0), 0);
				
				// הוצאות פועל מטבלת Expenses
				const workerExpenses = monthExpenses
					.filter(exp => exp.category === 'worker')
					.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
				
				// הוצאות אחרות מטבלת Expenses (לא פועל)
				const otherExpenses = monthExpenses
					.filter(exp => exp.category !== 'worker')
					.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
				
				// סה"כ הוצאות = הוצאות מטיפולים + הוצאות אחרות (לא כולל פועל)
				const totalOtherExpenses = visitExpenses + otherExpenses;
				
				// נטו = הכנסה - פועל - הוצאות אחרות
				const netIncome = totalIncome - workerExpenses - totalOtherExpenses;
				
				// ממוצע לטיפול
				const avgPerVisit = visitsCount > 0 ? totalIncome / visitsCount : 0;
				
				monthlyData.push({
					month: month + 1,
					monthName: monthNames[month],
					visitsCount,
					totalHours,
					totalIncome,
					workerExpenses,
					otherExpenses: totalOtherExpenses,
					netIncome,
					avgPerVisit
				});
			}
			
			// חישוב סיכומים שנתיים
			const yearlyTotals = {
				visitsCount: monthlyData.reduce((sum, m) => sum + m.visitsCount, 0),
				totalHours: monthlyData.reduce((sum, m) => sum + m.totalHours, 0),
				totalIncome: monthlyData.reduce((sum, m) => sum + m.totalIncome, 0),
				workerExpenses: monthlyData.reduce((sum, m) => sum + m.workerExpenses, 0),
				otherExpenses: monthlyData.reduce((sum, m) => sum + m.otherExpenses, 0),
				netIncome: monthlyData.reduce((sum, m) => sum + m.netIncome, 0)
			};
			yearlyTotals.avgPerVisit = yearlyTotals.visitsCount > 0 ? yearlyTotals.totalIncome / yearlyTotals.visitsCount : 0;
			
			// חישוב ממוצעים חודשיים (רק חודשים עם פעילות)
			const activeMonths = monthlyData.filter(m => m.visitsCount > 0).length;
			const monthlyAvg = activeMonths > 0 ? yearlyTotals.netIncome / activeMonths : 0;
			
			// בניית HTML
			let html = `
				<!-- סיכום שנתי -->
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px;">
					<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
						<div style="font-size: 24px; font-weight: bold;">${yearlyTotals.visitsCount}</div>
						<div style="font-size: 11px; opacity: 0.9;">טיפולים</div>
					</div>
					<div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
						<div style="font-size: 24px; font-weight: bold;">${yearlyTotals.totalHours.toFixed(0)}</div>
						<div style="font-size: 11px; opacity: 0.9;">שעות</div>
					</div>
					<div style="background: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
						<div style="font-size: 24px; font-weight: bold;">${yearlyTotals.totalIncome.toLocaleString()}</div>
						<div style="font-size: 11px; opacity: 0.9;">הכנסה ₪</div>
					</div>
					<div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
						<div style="font-size: 24px; font-weight: bold;">${yearlyTotals.workerExpenses.toLocaleString()}</div>
						<div style="font-size: 11px; opacity: 0.9;">עלות פועל ₪</div>
					</div>
					<div style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #333; padding: 15px; border-radius: 10px; text-align: center;">
						<div style="font-size: 24px; font-weight: bold;">${yearlyTotals.otherExpenses.toLocaleString()}</div>
						<div style="font-size: 11px;">הוצאות אחרות ₪</div>
					</div>
					<div style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
						<div style="font-size: 24px; font-weight: bold;">${yearlyTotals.netIncome.toLocaleString()}</div>
						<div style="font-size: 11px; opacity: 0.9;">נטו ₪</div>
					</div>
				</div>
				
				<!-- ממוצעים -->
				<div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px;">
					<div style="text-align: center;">
						<div style="font-size: 20px; font-weight: bold; color: #9c27b0;">${yearlyTotals.avgPerVisit.toFixed(0)} ₪</div>
						<div style="font-size: 12px; color: #666;">ממוצע לטיפול</div>
					</div>
					<div style="text-align: center;">
						<div style="font-size: 20px; font-weight: bold; color: #9c27b0;">${monthlyAvg.toFixed(0)} ₪</div>
						<div style="font-size: 12px; color: #666;">ממוצע נטו לחודש</div>
					</div>
					<div style="text-align: center;">
						<div style="font-size: 20px; font-weight: bold; color: #9c27b0;">${activeMonths}</div>
						<div style="font-size: 12px; color: #666;">חודשים פעילים</div>
					</div>
				</div>
				
				<!-- טבלה חודשית -->
				<div style="overflow-x: auto;">
					<table style="width: 100%; border-collapse: collapse; font-size: 13px;">
						<thead>
							<tr style="background: #9c27b0; color: white;">
								<th style="padding: 10px; text-align: right;">חודש</th>
								<th style="padding: 10px; text-align: center;">טיפולים</th>
								<th style="padding: 10px; text-align: center;">שעות</th>
								<th style="padding: 10px; text-align: center;">הכנסה</th>
								<th style="padding: 10px; text-align: center;">פועל</th>
								<th style="padding: 10px; text-align: center;">הוצאות</th>
								<th style="padding: 10px; text-align: center;">נטו</th>
								<th style="padding: 10px; text-align: center;">ממוצע/טיפול</th>
							</tr>
						</thead>
						<tbody>
			`;
			
			// שורות החודשים (מ-12 ל-1)
			for (let i = 11; i >= 0; i--) {
				const m = monthlyData[i];
				const rowBg = m.visitsCount === 0 ? '#f5f5f5' : (i % 2 === 0 ? '#fff' : '#fafafa');
				const textColor = m.visitsCount === 0 ? '#999' : '#333';
				
				html += `
					<tr style="background: ${rowBg}; color: ${textColor};">
						<td style="padding: 8px; font-weight: 600;">${m.monthName}</td>
						<td style="padding: 8px; text-align: center;">${m.visitsCount || '-'}</td>
						<td style="padding: 8px; text-align: center;">${m.totalHours > 0 ? m.totalHours.toFixed(1) : '-'}</td>
						<td style="padding: 8px; text-align: center; color: #2196F3; font-weight: 600;">${m.totalIncome > 0 ? m.totalIncome.toLocaleString() : '-'}</td>
						<td style="padding: 8px; text-align: center; color: #e91e63;">${m.workerExpenses > 0 ? m.workerExpenses.toLocaleString() : '-'}</td>
						<td style="padding: 8px; text-align: center; color: #ff5722;">${m.otherExpenses > 0 ? m.otherExpenses.toLocaleString() : '-'}</td>
						<td style="padding: 8px; text-align: center; color: #4caf50; font-weight: 600;">${m.netIncome !== 0 ? m.netIncome.toLocaleString() : '-'}</td>
						<td style="padding: 8px; text-align: center;">${m.avgPerVisit > 0 ? m.avgPerVisit.toFixed(0) : '-'}</td>
					</tr>
				`;
			}
			
			// שורת סיכום
			html += `
						</tbody>
						<tfoot>
							<tr style="background: #9c27b0; color: white; font-weight: bold;">
								<td style="padding: 10px;">סה"כ ${year}</td>
								<td style="padding: 10px; text-align: center;">${yearlyTotals.visitsCount}</td>
								<td style="padding: 10px; text-align: center;">${yearlyTotals.totalHours.toFixed(1)}</td>
								<td style="padding: 10px; text-align: center;">${yearlyTotals.totalIncome.toLocaleString()}</td>
								<td style="padding: 10px; text-align: center;">${yearlyTotals.workerExpenses.toLocaleString()}</td>
								<td style="padding: 10px; text-align: center;">${yearlyTotals.otherExpenses.toLocaleString()}</td>
								<td style="padding: 10px; text-align: center;">${yearlyTotals.netIncome.toLocaleString()}</td>
								<td style="padding: 10px; text-align: center;">${yearlyTotals.avgPerVisit.toFixed(0)}</td>
							</tr>
						</tfoot>
					</table>
				</div>
			`;
			
			contentDiv.innerHTML = html;
		}

		// עדכון רשימת קטגוריות בפילטר לפי הסוג שנבחר
		function updateExpenseCategoryFilter() {
			const typeFilter = document.getElementById('expenseTypeFilter')?.value || '';
			const categorySelect = document.getElementById('expenseCategoryFilter');
			
			if (!categorySelect) return;
			
			// איפוס הקטגוריות
			categorySelect.innerHTML = '<option value="">כל הקטגוריות</option>';
			
			if (typeFilter && EXPENSE_CATEGORIES[typeFilter]) {
				const categories = EXPENSE_CATEGORIES[typeFilter];
				for (const [key, value] of Object.entries(categories)) {
					categorySelect.innerHTML += `<option value="${key}">${value.icon} ${value.name}</option>`;
				}
			} else {
				// אם לא נבחר סוג - הצג את כל הקטגוריות
				for (const [type, categories] of Object.entries(EXPENSE_CATEGORIES)) {
					for (const [key, value] of Object.entries(categories)) {
						categorySelect.innerHTML += `<option value="${key}">${value.icon} ${value.name}</option>`;
					}
				}
			}
		}


   </script>
</body>
</html>
